<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>æ¨¡æ‹Ÿæ‰‹æœº</title>
<style>
/* reset + å…¨å±€ */
*{margin:0;padding:0;box-sizing:border-box}
body{background:#e5e5e5;font-family:-apple-system,BlinkMacSystemFont;display:flex;justify-content:center;padding:30px 0}
.phone{
  width:390px;height:780px;background:#000;border-radius:42px;padding:6px;position:relative;
  overflow:visible; /* å…è®¸æ¡Œå® è¶…å‡ºå¯è§ï¼Œé˜²æ­¢è¢«è£åˆ‡ */
}

/* æ¡Œå® å®¹å™¨ï¼ˆå±å¹•å¤–ä¸Šæ–¹ï¼‰ */
.pet-container{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:-24px;
  width:72px;
  height:72px;
  z-index:999;
  pointer-events:none;
}
.pet-box{width:100%;height:100%;overflow:visible;display:flex;align-items:center;justify-content:center;background:transparent}
.pet-box img{width:100%;height:100%;object-fit:contain;display:block}

/* å±å¹• */
.screen{
  width:100%;
  height:100%;
  border-radius:36px;
  overflow:hidden;
  position:relative;
  background: #fff; /* é»˜è®¤èƒŒæ™¯è‰² */
}

/* ä¸»å± - ä¿®æ”¹å£çº¸å®¹å™¨ */
.home{
  width:100%;
  height:100%;
  position:relative;
  overflow:hidden;
}

/* å£çº¸å±‚ - ç‹¬ç«‹å®¹å™¨ï¼Œè¦†ç›–æ•´ä¸ªå±å¹• */
.wallpaper-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: 1;
}

/* åº”ç”¨ç½‘æ ¼å®¹å™¨ - åœ¨å£çº¸ä¹‹ä¸Š */
.apps-container {
  position: relative;
  z-index: 2;
  width:100%;
  height:100%;
  padding:60px 20px 80px;
  display:flex;
  flex-direction:column;
}

.apps{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
.app-item{text-align:center;font-size:12px;cursor:pointer}
.app-name{color:#fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5);} /* ç™½è‰²æ–‡å­—ï¼Œæ·»åŠ é˜´å½±æé«˜å¯è¯»æ€§ */
.app{width:64px;height:64px;border-radius:14px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.app img{width:100%;height:100%;object-fit:cover}
.wechat-app{background:#07c160;color:#fff;font-size:28px}

/* åˆ˜æµ· */
.notch{position:absolute;top:6px;left:50%;transform:translateX(-50%);width:130px;height:34px;background:#000;border-radius:18px;z-index:20}

/* çŠ¶æ€æ  */
.status-bar{height:44px;padding:0 14px;display:flex;align-items:center;justify-content:space-between;font-size:16px;font-weight:600;position:absolute;top:0;left:0;right:0;z-index:10}
.status-time{margin-left:18px}.status-right{display:flex;gap:6px}.status-right img{height:14px}

/* é¡µé¢ */
.page{
  width:100%;
  height:100%;
  display:none;
  flex-direction:column;
  background:#fff; /* æ‰€æœ‰é¡µé¢é»˜è®¤ç™½è‰²èƒŒæ™¯ */
  padding-top:44px
}

/* Header */
.header{height:44px;background:#ededed;display:flex;align-items:center;justify-content:center;position:relative;font-size:17px;font-weight:600;padding-top:env(safe-area-inset-top,8px)}
.header-left,.header-right{position:absolute;top:0;height:44px;display:flex;align-items:center;padding:0 14px;font-size:22px;cursor:pointer}
.header-left{left:0}.header-right{right:0}
/* OK æ–‡å­—æŒ‰é’®ï¼ˆæ— èƒŒæ™¯ï¼‰ */
.header-right.ok-btn{font-size:15px;color:#007aff;background:transparent;padding:0 12px;border-radius:6px}

/* æœç´¢ */
.wechat-search{padding:8px 12px;background:transparent}
.wechat-search-box{height:36px;background:#e0e0e0;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#888}

/* åˆ—è¡¨ */
.list{flex:1;overflow:auto;padding-bottom:80px}
.list-card{background:#fff;border-radius:10px;margin:8px 12px;overflow:hidden}
.chat-item{display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid #f0f0f0;cursor:pointer}
.chat-avatar{width:48px;height:48px;border-radius:8px;background:#ccc;flex:0 0 48px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.chat-avatar img{width:100%;height:100%;object-fit:cover}
.chat-main{flex:1;margin-left:12px;display:flex;flex-direction:column;justify-content:center}
.chat-name{font-size:15px;font-weight:600;color:#111}
.chat-preview{font-size:13px;color:#888;margin-top:4px}
.chat-time{flex:0 0 54px;text-align:right;color:#999;font-size:12px}

/* Tabs */
.tabs{height:60px;display:flex;border-top:1px solid #ddd;background:#fff;position:relative;z-index:3}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;color:#333;cursor:pointer}
.tab-icon{font-size:22px;margin-bottom:2px}
.tab.active{color:#07c160}

/* æˆ‘ï¼šæ–°çš„æ ·å¼åŒºåŸŸ */
.me-wrap{padding:8px 12px}
.profile{background:#fff;padding:16px;border-radius:10px;margin-bottom:10px;display:flex;align-items:center}
.avatar{width:60px;height:60px;border-radius:8px;background:#ccc;overflow:hidden;margin-right:14px}
.avatar img{width:100%;height:100%;object-fit:cover}
.name{font-size:18px}
.wxid{font-size:12px;color:#888;margin-top:4px}

/* æˆ‘é¡µé¢çš„ä¸‰é¡¹ï¼šæŒ‰å›¾ç‰‡æ ·å¼ */
.me-options{background:#fff;border-radius:10px;margin:8px 12px;overflow:hidden}
.me-item{display:flex;align-items:center;justify-content:space-between;padding:18px 16px;border-bottom:1px solid #f0f0f0;cursor:pointer}
.me-item:last-child{border-bottom:none}
.me-item .left{display:flex;align-items:center;gap:12px}
.me-item .label{font-size:18px;color:#111}
.me-item .chev{font-size:18px;color:#999}

/* æˆ‘é¡µé¢æ•´ä½“ä¸è¦å¤ªå¤§ï¼Œä¿ç•™ç•™ç™½ */
.me-container{flex:1;overflow:auto;padding-bottom:16px}

/* è®¾ç½®é¡¹ï¼ˆé€šç”¨ï¼‰ */
.setting-item{background:#fff;padding:14px;border-bottom:1px solid #eee}
.setting-item input{margin-top:10px;width:100%}

/* home settings */
.home-settings-list{padding:10px;overflow:auto}
.home-settings-row{background:#fff;padding:14px;margin-bottom:8px;border-radius:8px;display:flex;align-items:center;justify-content:space-between}
.home-settings-row label{font-size:14px;color:#222}
.home-settings-row input[type="file"]{font-size:12px}

/* API card */
.api-card{background:#fff;padding:12px;border-radius:8px;margin-bottom:8px}
.api-row{display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-top:1px solid #f0f0f0}
.api-row:first-child{border-top:none}
.api-row label{flex:0 0 110px;color:#222}
.api-row .field{flex:1;display:flex;align-items:center;gap:8px}

/* plus popup */
.plus-mask{position:absolute;inset:0;background:transparent;display:none;pointer-events:none;z-index:50}
.plus-mask.show{display:block;pointer-events:auto}
.plus-panel{position:absolute;top:56px;right:12px;width:180px;background:#4a4a4a;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
.plus-item{padding:14px;color:#fff;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer}
.plus-item:last-child{border-bottom:none}

/* èŠå¤©çª—å£æ ·å¼ */
.chat-window{
  display:none;
  flex-direction:column;
  height:100%;
  position:relative;
  background:#f5f5f5; /* èŠå¤©çª—å£æœ‰ç‹¬ç«‹èƒŒæ™¯è‰² */
}
.chat-header{height:56px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #eee;position:relative;padding-top:env(safe-area-inset-top,10px);background:linear-gradient(transparent,#fff)}
.chat-header .left{position:absolute;left:10px;top:0;bottom:0;display:flex;align-items:center;cursor:pointer}
.chat-header .right{position:absolute;right:10px;top:0;bottom:0;display:flex;align-items:center;cursor:pointer}
.chat-header .title{font-size:17px;font-weight:600}

/* èŠå¤©åŒºåŸŸ */
.chat-body{flex:1;background:#f5f5f5;padding:12px;overflow:auto}
.msg-row{display:flex;margin-bottom:8px}
.msg-bubble{max-width:70%;padding:8px 12px;border-radius:12px;font-size:14px;line-height:1.3}
.msg-left{justify-content:flex-start}
.msg-left .msg-bubble{background:#fff;border:1px solid #eee;border-top-left-radius:6px}
.msg-right{justify-content:flex-end}
.msg-right .msg-bubble{background:#cfe8ff}

/* åº•éƒ¨è¾“å…¥åŒº */
.chat-input-bar{height:64px;padding:10px;display:flex;align-items:center;gap:8px;border-top:1px solid #eee;background:#fafafa;padding-bottom:calc(env(safe-area-inset-bottom,10px));position:relative}
.btn-circle{width:40px;height:40px;border-radius:20px;display:flex;align-items:center;justify-content:center;background:#fff;border:1px solid #eee;cursor:pointer}
.btn-circle img{width:20px;height:20px;display:block}
.input-box{flex:1;height:40px;border-radius:20px;background:#fff;border:1px solid #eee;display:flex;align-items:center;padding:0 12px}
.input-box input{border:0;outline:none;width:100%;font-size:15px}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:rgba(0,0,0,0.75);color:#fff;padding:8px 12px;border-radius:6px;z-index:2000;display:none}
.toast.show{display:block}

/* æ–°æ’å…¥èŠå¤©æ¡ç›®æ·¡å…¥ */
@keyframes fadeIn { from { opacity:0; transform: translateY(-6px);} to { opacity:1; transform: translateY(0);} }
.fade-in{animation:fadeIn 0.3s ease forwards}
</style>
</head>
<body>
<div class="phone">

  <!-- æ¡Œå®  -->
  <div class="pet-container" id="petContainer" aria-hidden="true">
    <div class="pet-box" id="petBox"></div>
  </div>

  <div class="screen" id="screen">
    <div class="notch"></div>

    <div class="status-bar">
      <div id="time" class="status-time">00:00</div>
      <div class="status-right">
        <img src="https://img.heliar.top/file/1768515766612_IMG_3349.png" alt="net">
        <img src="https://img.heliar.top/file/1768516105836_IMG_3350.png" alt="bat">
      </div>
    </div>

    <!-- ä¸»å± - å£çº¸ä»…åœ¨è¿™é‡Œæ˜¾ç¤º -->
    <div class="home page" id="home">
      <!-- å£çº¸å±‚ -->
      <div class="wallpaper-layer" id="wallpaperLayer"></div>
      
      <!-- åº”ç”¨ç½‘æ ¼å®¹å™¨ -->
      <div class="apps-container">
        <div class="apps">
          <div class="app-item" onclick="openWeChat()">
            <div class="app wechat-app" id="wechatIcon"><img src="" alt="" style="width:100%;height:100%;object-fit:cover;display:block"></div>
            <div class="app-name">Wechat</div>
          </div>

          <div class="app-item" onclick="openHomeSettings()">
            <div class="app" id="homeSettingsIcon" style="background:#f0f0f0">âš™ï¸</div>
            <div class="app-name">è®¾ç½®</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Wechat ä¸»é¡µé¢ï¼ˆèŠå¤©åˆ—è¡¨ï¼‰ -->
    <div class="page" id="wechat">
      <div class="header">
        <div class="header-left" onclick="backHome()">âœ©</div>
        Wechat
        <div class="header-right" id="plusBtn" onclick="openPlus()">ï¼‹</div>
      </div>

      <div class="wechat-search" id="wechatSearch">
        <div class="wechat-search-box">ğŸ” æœç´¢</div>
      </div>

      <div class="list" id="wechatContent"></div>

      <div class="tabs" id="wechatTabs">
        <div class="tab active" data-tab="chat" onclick="switchTab('chat', this)"><div class="tab-icon">ğŸ’¬</div><div>å¾®ä¿¡</div></div>
        <div class="tab" data-tab="contact" onclick="switchTab('contact', this)"><div class="tab-icon">ğŸ‘¥</div><div>é€šè®¯å½•</div></div>
        <div class="tab" data-tab="find" onclick="switchTab('find', this)"><div class="tab-icon">ğŸ§­</div><div>å‘ç°</div></div>
        <div class="tab" data-tab="me" onclick="switchTab('me', this)"><div class="tab-icon">ğŸ‘¤</div><div>æˆ‘</div></div>
      </div>
    </div>

    <!-- èŠå¤©çª—å£ï¼ˆæ–°ï¼‰ -->
    <div class="page chat-window" id="chatWindow">
      <div class="chat-header">
        <div class="left" onclick="closeChat()">â€¹</div>
        <div class="title" id="chatTitle">å¯¹è¯</div>
        <div class="right">â‹¯</div>
      </div>

      <div class="chat-body" id="chatBody"></div>

      <div class="chat-input-bar">
        <!-- ä½¿ç”¨ä½ æä¾›çš„ä¸‰ä¸ªå›¾åºŠ -->
        <div class="btn-circle" id="micBtn"><img id="micImg" src="https://img.heliar.top/file/1768546088581_IMG_3422.png" alt="mic"></div>
        <div class="input-box"><input id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€" onkeydown="if(event.key==='Enter'){ sendChatMessage(); }"></div>
        <div class="btn-circle" id="emojiBtn"><img id="emojiImg" src="https://img.heliar.top/file/1768546261329_IMG_3423.png" alt="emoji"></div>
        <div class="btn-circle" id="plusChatBtn"><img id="plusChatImg" src="https://img.heliar.top/file/1768546259205_IMG_3424.png" alt="plus"></div>
      </div>
    </div>

    <!-- ä¸»å±è®¾ç½®åº”ç”¨ï¼ˆåŒ…å« API å—ï¼‰ -->
    <div class="page" id="homeSettings">
      <div class="header">
        <div class="header-left" onclick="backHome()">â€¹</div>
        è®¾ç½®
        <div class="header-right ok-btn" onclick="saveApiSettings()">OK</div>
      </div>

      <div class="list home-settings-list" id="homeSettingsList">
        <div class="home-settings-row">
          <label>ä¿®æ”¹ä¸»å±å¹•å£çº¸</label>
          <input type="file" accept="image/*" onchange="setWallpaper(this)">
        </div>

        <div class="home-settings-row">
          <label>ä¿®æ”¹ Wechat å›¾æ ‡</label>
          <input type="file" accept="image/*" onchange="setWeChatIcon(this)">
        </div>

        <div class="home-settings-row">
          <label>ä¿®æ”¹ è®¾ç½® å›¾æ ‡</label>
          <input type="file" accept="image/*" onchange="setHomeSettingsIcon(this)">
        </div>

        <div class="home-settings-row">
          <label>ä¿®æ”¹æ‰‹æœºæ¡Œå® </label>
          <input type="file" accept="image/*" onchange="setPetImage(this)">
        </div>

        <div class="api-card" id="apiCard">
          <div style="font-size:15px;color:#222;margin-bottom:6px">API è®¾ç½®</div>

          <div class="api-row">
            <label>åä»£åœ°å€</label>
            <div class="field"><input id="apiProxy" type="text" placeholder="https://your-proxy.example" style="width:100%;padding:6px;border-radius:6px;border:1px solid #ddd"></div>
          </div>

          <div class="api-row">
            <label>API Key</label>
            <div class="field"><input id="apiKey" type="password" placeholder="Bearer key" style="width:100%;padding:6px;border-radius:6px;border:1px solid #ddd"></div>
          </div>

          <div class="api-row">
            <label>æ¨¡å‹</label>
            <div class="field api-select">
              <select id="apiModel"><option value="">ï¼ˆç©ºï¼‰</option></select>
              <button onclick="pullModels()" style="padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fafafa;cursor:pointer">æ‹‰å–</button>
            </div>
          </div>

          <div class="api-row">
            <label>æ¸©åº¦</label>
            <div class="field" style="align-items:center">
              <input id="apiTemp" type="range" min="0" max="2" step="0.01" value="0.8" style="flex:1">
              <div class="temp-value" id="apiTempVal">0.80</div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- æˆ‘ -> è®¾ç½® -->
    <div class="page" id="setting">
      <div class="header">
        <div class="header-left" onclick="backMe()">â€¹</div>
        è®¾ç½®
        <div class="header-right ok-btn" onclick="saveApiSettings()">OK</div>
      </div>
      <div class="list" id="settingList">
        <div class="setting-item">ä¿®æ”¹å¾®ä¿¡æ˜µç§°<input type="text" id="nickInput" oninput="setNickname(this.value)"></div>
        <div class="setting-item">ä¿®æ”¹å¾®ä¿¡å·<input type="text" id="wxidInput" oninput="setWxId(this.value)"></div>
        <div class="setting-item">ä¿®æ”¹å¤´åƒ<input type="file" accept="image/*" onchange="setAvatar(this)"></div>
      </div>
    </div>

    <!-- plus mask -->
    <div class="plus-mask" id="plusMask" onclick="closePlus()">
      <div class="plus-panel" onclick="event.stopPropagation()">
        <div class="plus-item" onclick="startGroup()">ğŸ’¬ å‘èµ·ç¾¤èŠ</div>
        <div class="plus-item" onclick="addFriend()">ğŸ‘¤ æ·»åŠ æœ‹å‹</div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ---------- é»˜è®¤èµ„æº ---------- */
const DEFAULT_WALLPAPER = 'https://img.heliar.top/file/1768536593797_IMG_3117.jpeg';
const DEFAULT_WECHAT_ICON = 'https://img.heliar.top/file/1768536596905_IMG_2757.jpeg';
const DEFAULT_NICKNAME = 'user';

/* ä¸‰ä¸ªå›¾åºŠï¼ˆä½ è¦æ±‚ä½¿ç”¨çš„ï¼‰ */
const ICON_MIC = 'https://img.heliar.top/file/1768546088581_IMG_3422.png';
const ICON_EMOJI = 'https://img.heliar.top/file/1768546261329_IMG_3423.png';
const ICON_PLUSCHAT = 'https://img.heliar.top/file/1768546259205_IMG_3424.png';

/* ---------- åŸºç¡€ä¸å¼•ç”¨ ---------- */
function updateTime(){ const n=new Date(); time.innerText = String(n.getHours()).padStart(2,'0') + ':' + String(n.getMinutes()).padStart(2,'0'); }
updateTime(); setInterval(updateTime,1000);

const screen = document.getElementById('screen');
const home = document.getElementById('home');
const wechat = document.getElementById('wechat');
const chatWindow = document.getElementById('chatWindow');
const content = document.getElementById('wechatContent');
const wechatTabs = document.getElementById('wechatTabs');
const plusMask = document.getElementById('plusMask');
const toastEl = document.getElementById('toast');
const petBox = document.getElementById('petBox');
const wechatIconEl = document.getElementById('wechatIcon');
const homeSettingsIconEl = document.getElementById('homeSettingsIcon');
const wallpaperLayer = document.getElementById('wallpaperLayer'); // æ–°å¢ï¼šå£çº¸å±‚

/* API æ§ä»¶ */
const apiProxyInput = document.getElementById('apiProxy');
const apiKeyInput = document.getElementById('apiKey');
const apiModelSelect = document.getElementById('apiModel');
const apiTempRange = document.getElementById('apiTemp');
const apiTempVal = document.getElementById('apiTempVal');

/* èŠå¤©ç›¸å…³ DOM */
const chatTitle = document.getElementById('chatTitle');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const micImg = document.getElementById('micImg');
const emojiImg = document.getElementById('emojiImg');
const plusChatImg = document.getElementById('plusChatImg');

/* æœ¬åœ°å­˜å‚¨æ•°æ®ç»“æ„ */
let nickname = localStorage.getItem('nickname') || DEFAULT_NICKNAME;
let wxId = localStorage.getItem('wxid') || 'Bubu120vO';
let avatar = localStorage.getItem('avatar') || '';

let contacts = JSON.parse(localStorage.getItem('contacts') || '[]'); // {id,name,avatar,note,info}
let chats = JSON.parse(localStorage.getItem('chats') || '[]'); // {id,contactId,nameDisplay,avatar,preview,timeLabel,ts}
let messages = JSON.parse(localStorage.getItem('messages') || '{}'); // { chatId: [{from,text,ts}] }

/* åˆå§‹åŒ–ç”»é¢èµ„æº */
// ä¿®æ”¹ï¼šå£çº¸ä»…è®¾ç½®åˆ°wallpaperLayerå±‚
if(localStorage.getItem('wallpaper')) {
  wallpaperLayer.style.backgroundImage = `url(${localStorage.getItem('wallpaper')})`;
} else {
  wallpaperLayer.style.backgroundImage = `url(${DEFAULT_WALLPAPER})`;
}

if(localStorage.getItem('wechatIcon')) wechatIconEl.innerHTML = `<img src="${localStorage.getItem('wechatIcon')}" alt="icon">`; else wechatIconEl.innerHTML = `<img src="${DEFAULT_WECHAT_ICON}" alt="icon">`;
if(localStorage.getItem('homeSettingsIcon')) homeSettingsIconEl.innerHTML = `<img src="${localStorage.getItem('homeSettingsIcon')}" alt="home-settings">`;
if(localStorage.getItem('petImage')) petBox.innerHTML = `<img src="${localStorage.getItem('petImage')}" alt="pet">`;

/* åº”ç”¨èŠå¤©å·¥å…·æ å›¾æ ‡ï¼ˆä½ çš„ä¸‰å¼ å›¾åºŠï¼‰ */
function applyChatIcons(){
  if(micImg) micImg.src = ICON_MIC;
  if(emojiImg) emojiImg.src = ICON_EMOJI;
  if(plusChatImg) plusChatImg.src = ICON_PLUSCHAT;
}
applyChatIcons();

/* ---------- é¡µé¢æ˜¾ç¤ºæ§åˆ¶ï¼ˆä¿ç•™ä½ åŸé€»è¾‘ï¼‰ ---------- */
function hideAllPages(){ document.querySelectorAll('.page').forEach(p=>p.style.display='none'); home.style.display='none'; chatWindow.style.display='none'; }
function openWeChat(){ hideAllPages(); wechat.style.display='flex'; switchTab('chat', wechatTabs.querySelector('[data-tab="chat"]')); }
function backHome(){ hideAllPages(); home.style.display='block'; }
function openHomeSettings(){ hideAllPages(); document.getElementById('homeSettings').style.display='flex'; loadApiSettingsToUI(); }
function openSetting(){ hideAllPages(); document.getElementById('setting').style.display='flex'; document.getElementById('nickInput').value = nickname; document.getElementById('wxidInput').value = wxId; }
function backMe(){ hideAllPages(); wechat.style.display='flex'; switchTab('me', wechatTabs.querySelector('[data-tab="me"]')); }

/* plus popup */
function openPlus(){ plusMask.classList.add('show'); }
function closePlus(){ plusMask.classList.remove('show'); }

/* startGroup left as-is */
function startGroup(){ closePlus(); toast('å‘èµ·ç¾¤èŠï¼ˆç¤ºä¾‹ï¼‰'); }

/* æ·»åŠ å¥½å‹åŠŸèƒ½ï¼ˆä¿æŒå·²æœ‰å®ç°ï¼‰ */
function addFriend(){
  closePlus();

  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed;inset:0;
    background:rgba(0,0,0,.25);
    display:flex;align-items:center;justify-content:center;
    z-index:999;
  `;

  modal.innerHTML = `
    <div style="width:300px;background:#fff;border-radius:16px;padding:16px;position:relative">
      <!-- å³ä¸Šè§’å…³é—­æŒ‰é’®ï¼ˆåœ†å½¢ï¼Œå†…ä¸ºé»‘è‰²å‰ï¼‰ -->
      <button id="afCloseBtn" title="å…³é—­" style="
        position:absolute; right:10px; top:10px;
        width:28px; height:28px; border-radius:14px;
        display:flex; align-items:center; justify-content:center;
        background:#fff; border:none; cursor:pointer;
        box-shadow:0 1px 3px rgba(0,0,0,0.12);
        color:#000; font-size:18px;
      ">&times;</button>

      <div style="text-align:center;font-size:16px;font-weight:600;margin-bottom:10px">
        æ·»åŠ å¥½å‹
      </div>

      <div style="text-align:center;margin-bottom:10px">
        <label style="
          display:inline-flex;
          width:80px;height:80px;
          border:2px dashed #f2b6c6;
          border-radius:12px;
          align-items:center;justify-content:center;
          cursor:pointer;
          font-size:22px;color:#f2b6c6;
        ">
          +
          <input type="file" hidden id="afAvatar">
        </label>
      </div>

      <input id="afName" placeholder="å¥½å‹å§“å"
        style="width:70%;display:block;margin:8px auto;
        padding:6px;border-radius:10px;border:1px solid #f2b6c6">

      <input id="afNote" placeholder="å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰"
        style="width:70%;display:block;margin:8px auto;
        padding:6px;border-radius:10px;border:1px solid #f2b6c6">

      <textarea id="afInfo" placeholder="ä¿¡æ¯"
        style="width:90%;display:block;margin:8px auto;
        padding:6px;border-radius:10px;border:1px solid #f2b6c6;height:60px"></textarea>

      <button id="afOk"
        style="margin:12px auto 0;display:block;
        padding:8px 24px;border-radius:10px;
        background:#f6c1d0;border:none;color:#000">
        OK
      </button>
    </div>
  `;

  document.body.appendChild(modal);

  // å…³é—­æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰äº‹ä»¶
  const closeBtn = modal.querySelector('#afCloseBtn');
  closeBtn.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    modal.remove();
  });

  let avatarData = '';

  modal.querySelector('#afAvatar').onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ev => avatarData = ev.target.result;
    r.readAsDataURL(file);
  };

  modal.querySelector('#afOk').onclick = ()=>{
    const name = modal.querySelector('#afName').value.trim();
    const note = modal.querySelector('#afNote').value.trim();
    const info = modal.querySelector('#afInfo').value.trim();

    if(!name){
      alert('è¯·è¾“å…¥å¥½å‹å§“å');
      return;
    }

    const contactId = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2);

    const contact = {
      id: contactId,
      name,
      note,
      info,
      avatar: avatarData
    };

    contacts.push(contact);
    localStorage.setItem('contacts', JSON.stringify(contacts));

    /* insert as chat and save messages */
    insertNewChat(contact);

    modal.remove();
  };
}

/* toast */
function toast(msg, ms=1400){ toastEl.innerText = msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); }

/* ---------- æ¸²æŸ“èŠå¤©åˆ—è¡¨ï¼ˆèŠå¤©é¡µï¼‰ ---------- */
function renderChatList(){
  // ensure chats sorted by ts desc
  chats.sort((a,b)=> (b.ts||0) - (a.ts||0));
  if(!chats || chats.length===0){
    content.innerHTML = `<div style="padding:18px;color:#888;text-align:center">ç›®å‰æ— èŠå¤©</div>`;
    return;
  }
  const wrapper = document.createElement('div');
  wrapper.className = 'list-card';
  chats.forEach(c=>{
    const el = document.createElement('div');
    el.className = 'chat-item';
    el.dataset.chatId = c.id;

    const avatarDiv = document.createElement('div'); avatarDiv.className = 'chat-avatar';
    if(c.avatar) { const img = document.createElement('img'); img.src = c.avatar; avatarDiv.appendChild(img); }
    else avatarDiv.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#666">${(c.nameDisplay||'U').charAt(0)}</div>`;

    const main = document.createElement('div'); main.className = 'chat-main';
    const nameDiv = document.createElement('div'); nameDiv.className = 'chat-name'; nameDiv.innerText = c.nameDisplay || 'æ— å';
    const previewDiv = document.createElement('div'); previewDiv.className = 'chat-preview'; previewDiv.innerText = c.preview || '';
    main.appendChild(nameDiv); main.appendChild(previewDiv);

    const timeDiv = document.createElement('div'); timeDiv.className = 'chat-time'; timeDiv.innerText = c.timeLabel || '';

    el.appendChild(avatarDiv); el.appendChild(main); el.appendChild(timeDiv);

    // ç‚¹å‡»æ¡ç›®æ‰“å¼€èŠå¤©çª—å£ï¼ˆè¦æ±‚ï¼‰
    el.addEventListener('click', ()=> openChat(c.id) );

    wrapper.appendChild(el);
  });
  content.innerHTML = '';
  content.appendChild(wrapper);
}

/* ---------- æ‰“å¼€èŠå¤©çª—å£ï¼Œæ¸²æŸ“æ¶ˆæ¯ ---------- */
function openChat(chatId){
  const chat = chats.find(x=>x.id===chatId);
  if(!chat){ toast('èŠå¤©æœªæ‰¾åˆ°'); return; }
  hideAllPages();
  chatWindow.style.display = 'flex';
  chatWindow.dataset.openChatId = chatId;
  chatTitle.innerText = chat.nameDisplay || 'å¯¹è¯';
  renderMessages(chatId);
  // scroll bottom
  setTimeout(()=> chatBody.scrollTop = chatBody.scrollHeight, 50);
}

/* å…³é—­èŠå¤©çª—å£ */
function closeChat(){
  chatWindow.style.display = 'none';
  hideAllPages();
  wechat.style.display = 'flex';
  switchTab('chat', wechatTabs.querySelector('[data-tab="chat"]'));
}

/* æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ */
function renderMessages(chatId){
  chatBody.innerHTML = '';
  const list = messages[chatId] || [];
  list.forEach(m=>{
    const row = document.createElement('div');
    row.className = 'msg-row ' + (m.from === 'me' ? 'msg-right' : 'msg-left');
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    bubble.innerText = m.text;
    row.appendChild(bubble);
    chatBody.appendChild(row);
  });
}

/* å‘é€æ¶ˆæ¯å¹¶ä¿å­˜ï¼ˆæœ¬åœ°ï¼‰ */
function sendChatMessage(){
  const text = chatInput.value.trim();
  if(!text) return;
  const chatId = chatWindow.dataset.openChatId;
  if(!chatId) return;
  messages[chatId] = messages[chatId] || [];
  const msg = { from:'me', text, ts: Date.now() };
  messages[chatId].push(msg);
  localStorage.setItem('messages', JSON.stringify(messages));

  // æ›´æ–°èŠå¤© preview/time & move to top
  const idx = chats.findIndex(c=>c.id===chatId);
  if(idx !== -1){
    chats[idx].preview = text;
    chats[idx].timeLabel = 'åˆšåˆš';
    chats[idx].ts = Date.now();
    const chatObj = chats.splice(idx,1)[0];
    chats.unshift(chatObj);
    localStorage.setItem('chats', JSON.stringify(chats));
  }

  // append to UI
  const row = document.createElement('div'); row.className = 'msg-row msg-right';
  const bubble = document.createElement('div'); bubble.className = 'msg-bubble'; bubble.innerText = text;
  row.appendChild(bubble);
  chatBody.appendChild(row);
  chatBody.scrollTop = chatBody.scrollHeight;
  chatInput.value = '';

  // if viewing chat list, re-render to reflect preview order
  if(document.querySelector('.tab.active')?.getAttribute('data-tab') === 'chat') renderChatList();
}

/* ---------- æ–°å¢èŠå¤©æ¡ç›®çš„æ’å…¥ï¼ˆä¾‹å¦‚å¤–éƒ¨æ·»åŠ å¥½å‹æ—¶ä½¿ç”¨ï¼‰ ----------
   - ç”Ÿæˆ chat object, push åˆ° chats, å­˜ localStorage, å¹¶æ·¡å…¥æ˜¾ç¤ºåœ¨é¡¶éƒ¨
*/
function insertNewChat(contact){
  // contact: {id,name,avatar,note}
  const displayName = contact.note || contact.name;
  const chatObj = {
    id: 'c'+Date.now().toString(),
    contactId: contact.id,
    nameDisplay: displayName,
    avatar: contact.avatar || null,
    preview: 'æ·»åŠ å¥½å‹æˆåŠŸ',
    timeLabel: 'åˆšåˆš',
    ts: Date.now()
  };
  chats.unshift(chatObj);
  localStorage.setItem('chats', JSON.stringify(chats));
  messages[chatObj.id] = messages[chatObj.id] || [];
  messages[chatObj.id].push({from:'them', text:'æ·»åŠ å¥½å‹æˆåŠŸ', ts: Date.now()});
  localStorage.setItem('messages', JSON.stringify(messages));
  // render and highlight first item
  renderChatList();
  const first = document.querySelector('.chat-item');
  if(first){
    first.classList.add('fade-in');
    setTimeout(()=> first.classList.remove('fade-in'), 350);
  }
}

/* ---------- tabs åˆ‡æ¢ï¼ˆä¿ç•™ä½ ç°æœ‰é€»è¾‘ï¼‰ ---------- */
function switchTab(name, el){
  wechatTabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');

  if(name === 'chat'){
    document.getElementById('wechatSearch').style.display = 'block';
    renderChatList();
  } else {
    document.getElementById('wechatSearch').style.display = 'none';
    if(name === 'contact'){
      // render contacts simple
      const cList = contacts.length ? contacts.map(c=>`<div class="chat-item"><div class="chat-avatar">${c.avatar?`<img src="${c.avatar}">` : ''}</div><div class="chat-main"><div class="chat-name">${escapeHtml(c.name)}</div><div class="chat-preview">${escapeHtml(c.info||'')}</div></div></div>`).join('') : `<div style="padding:18px;color:#888;text-align:center">æš‚æ— è”ç³»äºº</div>`;
      content.innerHTML = `<div class="list-card">${cList}</div>`;
    } else if(name === 'find'){
      content.innerHTML = `<div class="list-card"><div class="item">å‘ç° - åŠŸèƒ½å…¥å£1<span>â€º</span></div><div class="item">å‘ç° - åŠŸèƒ½å…¥å£2<span>â€º</span></div></div>`;
    } else if(name === 'me'){
      renderMe();
    } else {
      content.innerHTML = `<div class="item">${name} é¡µé¢</div>`;
    }
  }
}

/* render "me" page â€” æŒ‰ä½ è¦æ±‚çš„æ ·å¼è°ƒæ•´ï¼ˆæœ‹å‹åœˆ/è¡¨æƒ…/è®¾ç½®ï¼‰ */
function renderMe(){
  content.innerHTML = `
    <div class="me-container">
      <div class="profile">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="avatar">`:''}</div>
        <div>
          <div class="name">${escapeHtml(nickname)}</div>
          <div class="wxid">å¾®ä¿¡å·ï¼š${escapeHtml(wxId)}</div>
        </div>
      </div>

      <div class="me-options" role="list">
        <div class="me-item" role="listitem" onclick="openFriends()">
          <div class="left"><div class="label">æœ‹å‹åœˆ</div></div>
          <div class="chev">â€º</div>
        </div>

        <div class="me-item" role="listitem" onclick="openEmoticons()">
          <div class="left"><div class="label">è¡¨æƒ…</div></div>
          <div class="chev">â€º</div>
        </div>

        <div class="me-item" role="listitem" onclick="openSetting()">
          <div class="left"><div class="label">è®¾ç½®</div></div>
          <div class="chev">â€º</div>
        </div>
      </div>
    </div>
  `;
}

/* æ–°å¢çš„"æœ‹å‹åœˆ/è¡¨æƒ…"å ä½å‡½æ•°ï¼ˆä¿æŒä¸æ”¹å…¶å®ƒåŠŸèƒ½ï¼‰ */
function openFriends(){
  // è¿™é‡Œä»…ä¸ºç¤ºä¾‹ï¼šæ‰“å¼€"æœ‹å‹åœˆ"å¯ä»¥å®ç°ä½ æƒ³è¦çš„äº¤äº’
  toast('æœ‹å‹åœˆï¼ˆç¤ºä¾‹ï¼‰');
}
function openEmoticons(){
  toast('è¡¨æƒ…ï¼ˆç¤ºä¾‹ï¼‰');
}

/* ---------- è®¾ç½®ä¸å›¾ç‰‡ç›¸å…³ï¼Œä¿æŒä½ åŸé€»è¾‘ ---------- */
function setNickname(v){ nickname = v; localStorage.setItem('nickname', v); renderMe(); }
function setWxId(v){ wxId = v; localStorage.setItem('wxid', v); renderMe(); }
function setAvatar(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { avatar = e.target.result; localStorage.setItem('avatar', avatar); renderMe(); };
  r.readAsDataURL(input.files[0]);
}
// ä¿®æ”¹ï¼šå£çº¸ä»…è®¾ç½®åˆ°wallpaperLayerå±‚
function setWallpaper(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { 
    wallpaperLayer.style.backgroundImage = `url(${e.target.result})`; 
    localStorage.setItem('wallpaper', e.target.result); 
  };
  r.readAsDataURL(input.files[0]);
}
function setWeChatIcon(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { wechatIconEl.innerHTML = `<img src="${e.target.result}" alt="icon">`; localStorage.setItem('wechatIcon', e.target.result); };
  r.readAsDataURL(input.files[0]);
}
function setHomeSettingsIcon(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { homeSettingsIconEl.innerHTML = `<img src="${e.target.result}" alt="home-settings">`; localStorage.setItem('homeSettingsIcon', e.target.result); };
  r.readAsDataURL(input.files[0]);
}
function setPetImage(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { petBox.innerHTML = `<img src="${e.target.result}" alt="pet">`; localStorage.setItem('petImage', e.target.result); };
  r.readAsDataURL(input.files[0]);
}

/* ---------- API è®¾ç½®ç›¸å…³ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰ ---------- */
function loadApiSettingsToUI(){
  const proxy = localStorage.getItem('api_proxy') || '';
  const key = localStorage.getItem('api_key') || '';
  const model = localStorage.getItem('api_model') || '';
  const temp = localStorage.getItem('api_temperature');
  if(apiProxyInput) apiProxyInput.value = proxy;
  if(apiKeyInput) apiKeyInput.value = key;
  if(temp !== null && apiTempRange) apiTempRange.value = Number(temp);
  if(apiTempVal) apiTempVal.innerText = apiTempRange ? Number(apiTempRange.value).toFixed(2) : '0.80';
  if(model && apiModelSelect){ apiModelSelect.innerHTML = `<option value="${model}">${model}</option>`; apiModelSelect.value = model; }
}
loadApiSettingsToUI();
if(apiTempRange){
  apiTempRange.addEventListener('input', ()=>{ apiTempVal.innerText = Number(apiTempRange.value).toFixed(2); });
}

async function pullModels(){
  const proxy = apiProxyInput.value.trim();
  const key = apiKeyInput.value.trim();
  if(!proxy){ toast('è¯·å¡«å†™åä»£åœ°å€'); return; }
  const url = (proxy.endsWith('/')?proxy.slice(0,-1):proxy) + '/models';
  try{
    const btn = event?.target;
    if(btn){ btn.disabled=true; btn.innerText='æ‹‰å–ä¸­...'; }
    const res = await fetch(url, { method:'GET', headers: { 'Authorization': `Bearer ${key}` }});
    if(!res.ok) throw new Error(`è¯·æ±‚å¤±è´¥ ${res.status}`);
    const data = await res.json();
    let models = [];
    if(Array.isArray(data)) models = data;
    else if(Array.isArray(data.models)) models = data.models;
    else if(Array.isArray(data.data)) models = data.data;
    const opts = [];
    models.forEach(m=>{ if(typeof m==='string') opts.push(m); else if(m && (m.id || m.name)) opts.push(m.id||m.name); });
    if(opts.length===0) throw new Error('æœªè§£æåˆ°æ¨¡å‹');
    apiModelSelect.innerHTML = '';
    opts.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.innerText=o; apiModelSelect.appendChild(op); });
    toast('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°');
  }catch(err){
    console.error(err);
    toast('æ‹‰å–å¤±è´¥ï¼š'+err.message,2500);
  }finally{ if(event?.target){ event.target.disabled=false; event.target.innerText='æ‹‰å–'; } }
}

function saveApiSettings(){
  const proxy = apiProxyInput.value.trim();
  const key = apiKeyInput.value.trim();
  const model = apiModelSelect.value || '';
  const temp = apiTempRange ? Number(apiTempRange.value) : 0.8;
  if(proxy) localStorage.setItem('api_proxy', proxy); else localStorage.removeItem('api_proxy');
  if(key) localStorage.setItem('api_key', key); else localStorage.removeItem('api_key');
  if(model) localStorage.setItem('api_model', model); else localStorage.removeItem('api_model');
  localStorage.setItem('api_temperature', String(temp));
  toast('API é…ç½®å·²ä¿å­˜');
}

/* ---------- å®ç”¨å‡½æ•° ---------- */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- é¡µé¢åˆå§‹ ---------- */
hideAllPages();
home.style.display='block';

/* render chat list on first load if any */
if(chats.length>0) renderChatList();

/* Make clickable tabs still work even if transparent layers existed before */
document.addEventListener('click', ()=>{}); // keep click propagation normal

</script>
</body>
</html>