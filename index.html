<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iOS Home Screen</title>
    <style>
        /* --- 全局重置与基础样式 --- */
        :root {
             --theme-pink-bg-light: #FFF0F5;
             --theme-pink-bg-med: rgba(229, 138, 171, 0.15);
             --theme-pink-bg-soft: #FFF8FA;
            --theme-pink-text: #E58AAB;
            --theme-pink-title: #f5b3c9;
            --theme-pink-btn: #F5B3C9; 
            --wb-plus-btn: #FDCEDF;
             --chat-bg-color: #FFF8FA;
             --success-green: #4CAF50;
            --error-red: #F44336;
            --wallet-gradient: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%);
            --wallet-card-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
            --link-blue: #5865F2;
            --moments-nickname-color: #8687B4; /* 朋友圈昵称颜色 */
            --menu-pink: #fdcee0;
        }
        * {
             box-sizing: border-box;
             margin: 0;
             padding: 0;
             user-select: none;
             -webkit-tap-highlight-color: transparent;
             font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
         }
        body {
     width: 100vw;
     height: 100vh;
     overflow: hidden;
     background: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80') center/cover no-repeat;
     position: relative;
     transition: background-image 0.3s ease-in-out;
    z-index: -2;
}
        #home-screen {
             width: 100%;
             height: 100%;
             display: flex;
             flex-direction: column;
             padding: 0 0 env(safe-area-inset-bottom, 20px) 0;
             transition: opacity 0.3s ease, transform 0.3s ease;
         }
        body.settings-active #home-screen,
        body.chat-active #home-screen,
        body.wallet-active #home-screen,
        body.worldbook-active #home-screen {
             opacity: 0;
             transform: scale(0.95);
             pointer-events: none;
         }

        /* --- 时间区域 --- */
        #time-section {
             height: 25%;
             display: flex;
             justify-content: center;
             align-items: center;
             padding-top: 20px;
             flex-shrink: 0;
             transition: padding-top 0.3s ease;
         }
        #time-container {
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            background-size: cover;
            background-position: center;
            border-radius: 25px;
         }
        #time-container:active {
            transform: scale(0.98);
        }
        #clock-time {
             font-size: 5.2rem;
             font-weight: 300;
             color: white;
             text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.1;
        }
        #clock-date {
            font-size: 0.95rem;
             color: white;
            font-weight: 500;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- 网格区域 --- */
        #grid-area {
             flex: 1;
             display: grid;
             grid-template-columns: 1fr 1fr;
             grid-template-rows: 1fr 1fr;
             padding: 0 15px 10px 15px;
             gap: 15px;
             width: 100%;
             max-width: 600px;
             margin: 0 auto;
         }
        .grid-quadrant {
             width: 100%;
             height: 100%;
             display: flex;
             justify-content: center;
             align-items: center;
             position: relative;
         }
        
        /* --- 优化的聊天小组件样式 (Quadrant 1) --- */
        #chat-dual-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px; 
            padding: 5px;
        }
        .chat-row { display: flex; align-items: center; width: 100%; }
        .chat-row.left { justify-content: flex-start; }
        .chat-row.right { flex-direction: row-reverse; }

        .avatar-container {
            position: relative; flex-shrink: 0; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin: 0 8px; 
        }
        .avatar-container:active { transform: scale(0.9); }
        .avatar-ring {
            width: 48px; height: 48px; border-radius: 50%; padding: 2px;
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%, #a18cd1 100%);
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.3);
        }
        .avatar-img-circle {
            width: 100%; height: 100%; border-radius: 50%;
            background-color: #fff; background-size: cover; background-position: center;
            border: 2px solid #fff; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        .chat-bubble-input {
            height: 36px; border-radius: 18px; padding: 0 14px; font-size: 13px; outline: none;
            transition: all 0.3s ease; min-width: 60px; max-width: 140px; width: 80px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); color: #444;
        }
        .chat-bubble-input.left-bubble { border-bottom-left-radius: 4px; }
        .chat-bubble-input.right-bubble { border-bottom-right-radius: 4px; text-align: right; }
        .chat-bubble-input:focus { box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: rgba(255, 255, 255, 0.9); max-width: 150px; }

        /* --- 图片小组件 (Quadrant 4) --- */
        .photo-widget-container {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 26px; 
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            position: relative; overflow: hidden; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; justify-content: center; align-items: center;
        }
        .photo-widget-container:active { transform: scale(0.96); }
        .photo-widget-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-widget-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.1); pointer-events: none;
        }
        .photo-widget-icon { font-size: 36px; margin-bottom: 5px; opacity: 0.8; }
        .photo-widget-text { font-size: 13px; font-weight: 500; opacity: 0.9; }

        /* --- App Group Styles --- */
        .app-group-2x2 {
             display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
             gap: 12px; width: 100%; aspect-ratio: 1/1;
         }
        .app-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .app-icon {
             width: 60px; height: 60px; border-radius: 16px; margin-bottom: 5px;
             display: flex; justify-content: center; align-items: center; font-size: 28px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative;
             transition: transform 0.1s, filter 0.1s;
             background-size: cover; background-position: center; background-color: rgba(255, 255, 255, 0.2);
        }
        .app-name { font-size: 11px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.4); white-space: nowrap; }
                
        /* 底栏样式 */
        #dock-area {
             height: 95px; width: 100%; display: flex; justify-content: center; align-items: center;
             padding: 0 15px 10px 15px; flex-shrink: 0;
         }
        .dock-container {
             width: 100%; max-width: 350px; height: 100%;
             background: rgba(255, 255, 255, 0.2);
             backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
             border-radius: 30px; display: flex; justify-content: space-evenly; align-items: center;
             box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.15);
         }
        .dock-icon { width: 60px; height: 60px; font-size: 28px; margin: 0; }
        #dock-area .app-item .app-icon { margin-bottom: 0; }

        /* --- Chat App 首页样式 --- */
        #chat-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--chat-bg-color); z-index: 500;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.chat-active #chat-app-page { transform: translateY(0); }
        
        .chat-app-header {
            padding: 35px 20px 15px;
            background: #fff;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: none;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 20px rgba(229, 138, 171, 0.15);
            flex-shrink: 0; /* height is now auto */ z-index: 10; 
            transition: padding-top 0.3s ease, background-color 0.3s, box-shadow 0.3s;
        }
        
        .chat-app-header.hidden { display: none; }
        .chat-header-title { font-size: 18px; font-weight: 600; color: #333; transition: color 0.3s ease; }
        .back-icon-img { width: 30px; height: 30px; object-fit: contain; cursor: pointer; opacity: 1; pointer-events: auto; }
        .back-icon-img.hidden { opacity: 0; pointer-events: none; }
        .header-right-icon { width: 26px; height: 26px; object-fit: contain; cursor: pointer; transition: opacity 0.3s ease; }
        
        .chat-app-content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 100px; scroll-behavior: smooth; background-color: var(--chat-bg-color); }
        .me-mode { padding-top: 0; background-color: var(--chat-bg-color); overflow-y: hidden; display: flex; flex-direction: column; justify-content: flex-end; height: 100vh; }
        .chat-tab-content { display: none; min-height: 100%; }
        .chat-tab-content.active { display: block; }

        /* --- 角色聊天页面 (Chat Conversation View) - 仿微信布局 --- */
        #chat-conversation-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F8F8F8; 
            z-index: 600;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
            background-size: cover; background-position: center;
        }
        #chat-conversation-view.active { transform: translateX(0); }

        /* 1. 顶部导航栏 (角色聊天) */
        .chat-conv-header {
            padding: 25px 15px 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            border-radius: 0 0 35px 35px;
            box-shadow: 0 5px 25px rgba(229, 138, 171, 0.15);
            flex-shrink: 0; z-index: 20; height: 80px;
            transition: padding-top 0.3s ease, height 0.3s ease;
        }
        /* iOS模式 聊天顶栏调整：下移更多 */
        body.ios-mode-active .chat-conv-back-btn,
        body.ios-mode-active .chat-conv-right-icon {
            transform: translateY(-20px); /* 向上移动 */
        }
        body.ios-mode-active .chat-conv-header { 
            padding-top: calc(env(safe-area-inset-top, 20px) + 25px); /* 减少padding-top */
            height: 120px; /* 增加高度适应 */
        }
        body.ios-mode-active .chat-conv-title-container { margin-top: -30px; /* 向上移动 */ }

        .chat-conv-back-btn { width: 32px; height: 32px; object-fit: contain; cursor: pointer; }
        
        .chat-conv-title-container {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; padding: 0 10px; transition: margin-top 0.3s ease;
        }
        .chat-conv-title {
            font-size: 17px; font-weight: 600; color: var(--theme-pink-text); 
            text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        /* 对方正在输入中... 闪烁动画类 */
        @keyframes blinkColor {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        .typing-anim {
            color: #FDCEDF !important;
            animation: blinkColor 1.5s infinite ease-in-out;
        }

        .chat-conv-signature {
            font-size: 11px; color: var(--theme-pink-text); opacity: 0.8;
            margin-top: 2px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .chat-conv-right-icon { 
            width: 28px; height: 28px; cursor: pointer; object-fit: contain; 
        }

        /* 聊天内容区 */
        .chat-conv-messages {
            flex: 1; overflow-y: auto; padding: 20px 15px;
            display: flex; flex-direction: column; gap: 18px;
        }
        
        /* Time Stamp Style */
        .chat-time-stamp {
            align-self: center;
            font-size: 12px;
            color: #b0b0b0;
            margin: 10px 0;
            font-weight: 400;
        }
        
        .msg-bubble-row { display: flex; align-items: flex-end; width: 100%; gap: 8px; transition: transform 0.3s; position: relative; }
        .msg-bubble-row.me { justify-content: flex-end; }
        
        /* Recalled Tip */
        .msg-recalled-tip {
            align-self: center;
            font-size: 12px;
            color: #b0b0b0;
            background: rgba(0,0,0,0.05);
            padding: 4px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        .msg-bubble-avatar {
            width: 38px; height: 38px; border-radius: 8px; object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        
        .msg-bubble-content {
            max-width: 70%; padding: 12px 16px; font-size: 15px; line-height: 1.5;
            position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            word-wrap: break-word; user-select: text; /* Allow text selection */
        }
        .msg-bubble-row.them .msg-bubble-content {
            background: #FFFFFF; color: #333;
            border-radius: 18px 18px 18px 4px;
        }
        .msg-bubble-row.me .msg-bubble-content {
            background: var(--theme-pink-text); color: white;
            border-radius: 18px 18px 4px 18px;
        }

        /* Bubble Context Menu (Popup) */
        .bubble-context-menu {
            position: absolute;
            background-color: var(--menu-pink);
            border-radius: 12px;
            padding: 5px;
            display: flex;
            gap: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            margin-top: -10px;
            display: none;
        }
        .bubble-context-menu.active { display: flex; }
        .bubble-menu-item {
            padding: 8px 12px;
            font-size: 14px;
            color: white; /* Contrast with light pink bg? Maybe darker text */
            color: #555;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
        }
        .bubble-menu-item:active { background-color: rgba(255,255,255,0.4); }
        .bubble-context-menu::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid;
            border-color: var(--menu-pink) transparent transparent transparent;
        }

        /* Multi-select Mode Styles */
        .chat-conv-messages.multi-select-active .msg-bubble-row {
            padding-left: 30px; /* Space for checkbox */
        }
        .chat-checkbox {
            position: absolute; left: -30px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd;
            display: none; justify-content: center; align-items: center;
            background: white; transition: all 0.2s;
        }
        .chat-conv-messages.multi-select-active .chat-checkbox { display: flex; left: 0; }
        .chat-checkbox.checked { background: var(--theme-pink-btn); border-color: var(--theme-pink-btn); }
        .chat-checkbox.checked::after { content: '✓'; color: white; font-size: 12px; font-weight: bold; }
        
        .chat-multiselect-footer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; border-top: 1px solid #eee; z-index: 25;
            display: none; justify-content: center; align-items: center;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .chat-multiselect-footer.active { display: flex; }
        .chat-multiselect-delete-btn {
            background: #ffebee; color: #F44336; padding: 10px 30px; border-radius: 20px;
            border: none; font-weight: 600; font-size: 14px; cursor: pointer;
        }


        /* 2. 底部输入栏 (角色聊天) */
        .chat-conv-footer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px)) 12px;
            display: flex; align-items: center; gap: 10px;
            border-radius: 35px 35px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.04);
            flex-shrink: 0; z-index: 20;
        }
        
        .chat-conv-btn {
            width: 42px; height: 42px; border-radius: 50%;
            background-color: var(--theme-pink-btn);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; border: none; outline: none;
            box-shadow: 0 3px 8px rgba(229, 138, 171, 0.3);
            transition: transform 0.1s; flex-shrink: 0;
        }
        .chat-conv-btn:active { transform: scale(0.92); }
        .chat-conv-btn img {
            filter: brightness(0) invert(1); 
            pointer-events: none;
        }
        /* AI触发按钮专属样式，可根据需要微调 */
        .chat-conv-btn.ai-trigger {
            background-color: var(--theme-pink-btn);
        }

        .chat-conv-input-wrapper { flex: 1; height: 42px; position: relative; }
        .chat-conv-input {
            width: 100%; height: 100%;
            border-radius: 25px;
            background-color: #F5F5F7; border: none; outline: none;
            padding: 0 20px; font-size: 16px; color: #333;
            transition: background-color 0.2s;
        }
        .chat-conv-input:focus { background-color: #F5F5F7; border: 1px solid rgba(229, 138, 171, 0.3); }

        /* --- 角色设置页面 (Role Settings Page) --- */
        #role-settings-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--theme-pink-bg-light);
            z-index: 700;
            display: flex; flex-direction: column; align-items: center;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1), padding-top 0.3s ease;
            overflow-y: auto; padding: 40px 20px 40px;
        }
        #role-settings-page.active { transform: translateX(0); }
        
        .role-setting-close-area { width: 100%; display: flex; justify-content: flex-start; margin-bottom: 10px; flex-shrink: 0; }
        .role-setting-back-btn { width: 30px; height: 30px; cursor: pointer; object-fit: contain; }
        
        .settings-section-card {
            width: 100%; max-width: 500px;
            background: white; border-radius: 20px;
            padding: 20px; box-shadow: 0 4px 15px rgba(245, 179, 201, 0.2);
            margin-bottom: 20px; display: flex; flex-direction: column; align-items: center;
        }

        .settings-card-title {
            font-size: 15px; font-weight: 600; color: var(--theme-pink-text);
            width: 100%; text-align: left; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;
        }

        .role-avatar-edit-wrapper { 
            position: relative; width: 70px; height: 70px; margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(229, 138, 171, 0.2); border-radius: 50%;
        }
        .role-avatar-edit { 
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover; 
            border: 3px solid white; cursor: pointer;
        }
        .avatar-edit-hint {
            position: absolute; bottom: -2px; right: -2px; background: var(--theme-pink-btn); color: white;
            width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 12px; border: 2px solid white; pointer-events: none;
        }

        .role-alias-edit {
            font-size: 18px; font-weight: 600; color: #333; border: none; background: transparent;
            text-align: center; margin-bottom: 5px; border-bottom: 2px solid transparent;
            padding: 5px; outline: none; width: 80%; transition: border-color 0.2s;
        }
        .role-alias-edit:focus { border-bottom-color: var(--theme-pink-btn); }

        .role-signature-edit {
             font-size: 13px; color: var(--theme-pink-text); border: none; background: transparent;
             text-align: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0;
             padding: 4px; outline: none; width: 90%;
        }
        .role-signature-edit:focus { border-bottom-color: var(--theme-pink-btn); }
        
        .role-persona-input, .role-css-input {
            width: 100%; height: 80px;
            border: 1px solid #eee; border-radius: 12px;
            padding: 10px; font-size: 14px; line-height: 1.4; outline: none; resize: none;
            background-color: #FAFAFA; color: #444; font-family: inherit; margin-bottom: 10px;
        }
        .role-persona-input:focus, .role-css-input:focus { background-color: white; border-color: var(--theme-pink-btn); }
        
        .role-css-input { height: 120px; font-family: monospace; font-size: 12px; }

        .role-bg-upload-area {
            width: 100%; margin-top: 15px; display: flex; align-items: center; justify-content: space-between;
            padding: 10px; background: #f9f9f9; border-radius: 10px;
        }
        .role-bg-preview {
            width: 40px; height: 60px; border-radius: 6px; background-color: #eee;
            background-size: cover; background-position: center; border: 1px solid #ddd;
        }
        .role-bg-btn {
            font-size: 13px; padding: 6px 12px; border-radius: 15px; border: none;
            background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); cursor: pointer;
        }

        .user-avatar-row { display: flex; align-items: center; width: 100%; margin-bottom: 15px; gap: 15px; }
        .user-avatar-edit-wrapper { 
            position: relative; width: 60px; height: 60px; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 50%; cursor: pointer;
        }
        .user-name-input {
            flex: 1; border: 1px solid #eee; border-radius: 10px; padding: 10px;
            font-size: 15px; outline: none; background: #FAFAFA;
        }
        .user-name-input:focus { background: white; border-color: var(--theme-pink-btn); }

        .role-save-btn {
            width: 100%; max-width: 300px; padding: 15px;
            background-color: var(--theme-pink-btn);
            color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: 600;
            cursor: pointer; box-shadow: 0 5px 15px rgba(245, 179, 201, 0.4);
            transition: transform 0.1s; margin-top: 10px;
        }
        .role-save-btn:active { transform: scale(0.96); }

        .role-delete-btn {
            font-size: 14px; color: #F44336; margin-top: 20px; background: transparent; border: none;
            text-decoration: underline; cursor: pointer; padding: 10px; font-weight: 500;
        }

        .role-wb-binding-area {
            width: 100%; display: flex; align-items: center; justify-content: space-between;
            background: #f9f9f9; border-radius: 10px; padding: 10px 15px; margin-top: 10px;
        }
        #role-wb-display {
            flex: 1; font-size: 14px; color: #555; font-weight: 500;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #role-wb-display.unbound { color: #aaa; font-style: italic; }
        .role-wb-binding-area .actions { display: flex; gap: 8px; margin-left: 10px; }
        .role-wb-binding-area button {
            font-size: 13px; padding: 6px 12px; border-radius: 15px; border: none; cursor: pointer;
            background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text);
        }
        .role-wb-binding-area button#role-wb-clear-btn { background-color: #eee; color: #999; }

        /* --- Chat List & Contact List Styles --- */
        .chat-list-container { width: 100%; }
        .chat-list-item { display: flex; align-items: center; padding: 12px 20px; background-color: white; border-bottom: 1px solid rgba(0,0,0,0.03); cursor: pointer; transition: background-color 0.2s; }
        .chat-list-item:active { background-color: #f0f0f0; }
        .chat-list-avatar { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; margin-right: 15px; background-color: #eee; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-list-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .chat-list-name { font-size: 16px; color: #111; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-msg { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .contact-list-container { width: 100%; padding-bottom: 80px; padding-right: 25px; }
        .contact-section-title {
            padding: 8px 20px; font-size: 13px; font-weight: 600; color: #999;
            background-color: #f7f7f7; position: sticky; top: 0; z-index: 5; scroll-margin-top: 70px;
        }
        .contact-item {
            display: flex; align-items: center; padding: 10px 20px; background: white;
            border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: background 0.2s;
        }
        .contact-item:active { background-color: #f0f0f0; }
        .contact-avatar { width: 42px; height: 42px; border-radius: 10px; margin-right: 15px; object-fit: cover; background: #eee; }
        .contact-name { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 0; }
        .contact-signature { font-size: 12px; color: #E58AAB; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 100%; margin-top: 2px; }
        .contact-signature:empty { display: none; margin-top: 0; }
        .pinned-tag { display: none; margin-left: auto; font-size: 12px; color: orange; }
        .contact-item.pinned .pinned-tag { display: block; }
        
        .alpha-index-bar {
            position: fixed; right: 5px; top: 120px; bottom: 100px;
            width: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; color: #aaa; font-size: 10px; font-weight: 600;
        }
        .alpha-index-item { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; transition: color 0.2s; }
        .alpha-index-item:active { color: var(--theme-pink-text); background-color: rgba(0,0,0,0.03); }
        
        .chat-placeholder-text { color: #E58AAB; text-align: center; padding-top: 50%; font-size: 16px; font-weight: 500; width: 100%; }

        /* --- NEW/MODIFIED: 朋友圈 (Moments) Styles --- */
        #chat-tab-2 {
            background-color: #ffffff; /* 确保朋友圈 Tab 背景纯白 */
            min-height: 100vh;
        }
        #moments-page-wrapper {
            background-color: #ffffff; /* 强制白色背景 */
            padding-bottom: 100px; /* Space for nav bar */
            min-height: 100%;
        }
        .moments-header {
            position: relative;
            width: 100%;
            padding-bottom: 40px; /* Space for content below cover */
        }
        .moments-cover-img {
            width: 100%;
            height: 300px;
            background-color: #ddd;
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
        }
        
        .moments-user-info {
            position: absolute;
            top: 265px; /* Cover height (300) - half avatar (35) */
            right: 20px;
            display: flex;
            align-items: flex-start; /* Align top, so text sits above boundary */
            gap: 15px;
            z-index: 2;
        }
        
        .moments-user-nickname {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            margin-top: 15px; /* Adjust to align visually with the "upper part" of the avatar */
        }
        
        .moments-user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            flex-shrink: 0;
        }

        #moments-list {
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* 强制白色背景 */
            padding-top: 30px; /* Space for the overlapping avatar */
        }
        .moment-item {
            display: flex;
            gap: 15px;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .moment-item-avatar {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .moment-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .moment-item-nickname {
            font-size: 16px;
            font-weight: 600;
            color: var(--moments-nickname-color); /* 修改颜色为 #8687B4 */
        }
        .moment-item-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* Nine Grid Image Layout */
        .moments-img-grid {
            display: grid;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
            max-width: 300px;
        }
        .moments-img-grid.single-img {
            grid-template-columns: 1fr;
        }
        .moments-img-grid.grid-2, .moments-img-grid.grid-4 {
            grid-template-columns: repeat(2, 1fr);
            width: 200px; /* Limit width for 2x2 */
        }
        .moments-img-grid.grid-3, .moments-img-grid.grid-5, .moments-img-grid.grid-6, 
        .moments-img-grid.grid-7, .moments-img-grid.grid-8, .moments-img-grid.grid-9 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .moment-grid-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .moments-img-grid.single-img .moment-grid-img {
            max-width: 200px;
            max-height: 200px;
            aspect-ratio: auto;
            width: auto;
            height: auto;
        }

        .moment-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #999;
        }
        .moment-item-meta-left {
            display: flex;
            align-items: center;
            gap: 1em; /* '两个字的距离' */
            font-size: 13px;
        }
        .moment-delete-btn {
            width: 14px;
            height: 14px;
            object-fit: contain;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .moment-delete-btn:hover { opacity: 1; }

        .moment-actions-btn {
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 0px 6px;
            font-weight: bold;
            font-size: 18px; /* Slightly larger for ".." */
            color: #8687B4; /* 修改为指定颜色 */
            cursor: pointer;
            position: relative;
            line-height: 14px;
            height: 16px;
            display: flex;
            align-items: center;
            letter-spacing: -2px; /* Make dots closer */
        }
        .moment-actions-popup {
            position: absolute;
            right: 100%;
            bottom: -8px; /* Slight adjustment */
            margin-right: 10px;
            background-color: #4C4C4C;
            color: white;
            border-radius: 6px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transform: scale(0);
            transform-origin: right center;
            transition: transform 0.15s ease-out;
            white-space: nowrap;
        }
        .moment-actions-popup.active {
            transform: scale(1);
        }
        .moment-popup-btn {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        .moment-popup-btn img {
            width: 16px; height: 16px; object-fit: contain;
        }
        .moment-popup-btn:not(:last-child) {
            border-right: 1px solid #666;
        }
        .moment-popup-btn:active {
            background-color: #333;
        }
        .moment-feedback {
            margin-top: 10px;
            background-color: #F7F7F7;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
        }
        .moment-likes {
            color: var(--moments-nickname-color);
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .moment-likes:empty {
            display: none;
        }
        .moment-likes:last-child { /* if no comments, remove border */
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .moment-comments-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .moment-comment-item .user {
            color: var(--moments-nickname-color); /* 修改颜色为 #8687B4 */
            font-weight: 500;
        }
        .moment-comment-item .text {
            color: #333;
        }
        #add-moment-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f7f7f7;
            z-index: 650; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        #add-moment-modal.active {
            transform: translateY(0);
        }
        .add-moment-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 35px 20px 15px; background: #f7f7f7; flex-shrink: 0;
        }
        .add-moment-header button {
            border: none; background: none; font-size: 16px; cursor: pointer; padding: 5px 10px;
        }
        .add-moment-cancel { color: #333; }
        
        /* Updated Post Button Style */
        .add-moment-post {
            background-color: #F8C8DC; /* Pale Pink */
            color: black; 
            border-radius: 4px; /* Rectangular-ish */
            padding: 6px 15px !important; 
            font-weight: 500;
        }
        
        .add-moment-content { padding: 0 20px; flex: 1; display: flex; flex-direction: column; }
        #add-moment-text {
            width: 100%;
            height: 150px;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            resize: none;
            padding: 10px 0;
        }
        
        /* Add Moment Image Grid */
        .add-moment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .add-moment-image-upload { 
            width: 100%; 
            aspect-ratio: 1/1; 
            background-color: #eaeaea; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 30px; color: #aaa; 
            border-radius: 8px; 
            position: relative; overflow: hidden; 
        }
        .add-moment-img-cell {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .add-moment-img-cell img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .add-moment-remove-img {
            position: absolute; top: 2px; right: 2px;
            background: rgba(0,0,0,0.5); color: white;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; cursor: pointer;
        }
        
        .moments-empty-placeholder {
            text-align: center;
            padding: 80px 20px;
            color: #bbb;
            background-color: #fff;
        }

        /* --- NEW: Moments Comment MODAL (Updated) --- */
        #moments-comment-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1900;
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #moments-comment-overlay.active {
            display: block;
            opacity: 1;
        }
        #moments-comment-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #F7F7F7; /* Input area background - Light Gray */
            padding: 10px 15px calc(10px + env(safe-area-inset-bottom, 0px));
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #moments-comment-modal.active {
            transform: translateY(0);
        }
        #moments-comment-input {
            flex: 1;
            height: 40px;
            padding: 0 15px;
            border-radius: 20px; /* Rounded rectangle */
            border: 1px solid #EAEAEA; /* Faint border */
            background-color: #FCFCFC; /* Near white/Very light gray */
            font-size: 15px;
            outline: none;
            color: #333;
            margin-bottom: 0;
        }
        #moments-comment-input::placeholder {
            color: #999;
        }
        #moments-comment-input:focus {
            background-color: #FFFFFF;
        }
        .moments-emoji-btn {
            width: 30px;
            height: 30px;
            object-fit: contain;
            cursor: pointer;
            flex-shrink: 0;
        }
        #moments-comment-submit-btn {
            border: none;
            background: none;
            color: var(--theme-pink-text);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            padding: 5px;
            white-space: nowrap;
        }


        /* --- Me Page 重构样式 --- */
        .me-page-container { width: 100%; display: flex; flex-direction: column; height: auto; max-height: 100vh; }
        .me-cover-area { width: 100%; height: 20vh; min-height: 260px; background-color: #ddd; background-size: cover; background-position: center; position: relative; cursor: pointer; transition: background-image 0.3s ease; }
        .me-cover-area::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(0,0,0,0.15)); pointer-events: none; }
        .me-like-wrapper { position: absolute; bottom: 5px; right: 20px; display: flex; flex-direction: column; align-items: center; gap: 4px; z-index: 5; }
        .me-setting-wrapper { position: absolute; top: 33px; right: 20px; z-index: 5; }
        .me-setting-icon { width: 24px; height: 24px; object-fit: contain; cursor: pointer; transition: transform 0.2s; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
        .me-setting-icon:active { transform: scale(0.9); }
        .me-like-icon { width: 24px; height: 24px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); cursor: pointer; transition: transform 0.2s; }
        .me-like-icon:active { transform: scale(1.2) rotate(-10deg); }
        .me-like-count { color: white; font-size: 13px; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.6); cursor: pointer; text-align: center; }
        .me-content-area { flex: 1; background-color: var(--chat-bg-color); position: relative; padding-top: 60px; }
        .me-floating-header { position: absolute; top: 0; left: 25px; width: calc(100% - 50px); transform: translateY(-50%); display: flex; align-items: center; z-index: 10; }
        .me-avatar-box { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; overflow: hidden; flex-shrink: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.15); background: #fff; transition: all 0.3s ease; }
        .me-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .me-text-col { margin-left: 15px; display: flex; flex-direction: column; justify-content: center; }
        .me-nickname { font-size: 20px; font-weight: 700; color: #FFFFFF; margin-bottom: 6px; cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .me-qq-id { font-size: 13px; color: #555; cursor: pointer; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
        .me-info-list { margin: 10px 20px; background: white; border-radius: 16px; padding: 5px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; }
        .me-list-item { display: flex; align-items: center; padding: 15px 20px; background: white; cursor: pointer; transition: background-color 0.2s; }
        .me-list-item:active { background-color: #f9f9f9; }
        .me-list-item:not(:last-child) { border-bottom: 1px solid #f5f5f5; }
        .me-list-icon { width: 24px; height: 24px; object-fit: contain; margin-right: 15px; transition: all 0.3s ease; }
        .me-list-text { flex: 1; font-size: 15px; color: #333; font-weight: 500; display: flex; align-items: center; overflow: hidden; }
        .me-list-arrow { color: #ccc; font-size: 14px; font-weight: bold; font-family: monospace; margin-left: 10px; }
        .me-member-icons-row { display: flex; align-items: center; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; }
        .me-member-icons-row::-webkit-scrollbar { display: none; }
        .me-member-icon-slot { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; flex-shrink: 0; }

        /* --- Me Page Settings Modal --- */
        #me-settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--theme-pink-bg-light); z-index: 700; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: transform 0.3s ease, opacity 0.3s ease; transform: translateY(100%); }
        #me-settings-modal.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .me-settings-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 35px 20px 15px; background: white; box-shadow: 0 1px 5px rgba(0,0,0,0.05); flex-shrink: 0; transition: padding-top 0.3s ease; }
        .me-settings-header-title { font-size: 18px; font-weight: 600; color: #333; }
        .me-settings-close-btn { font-size: 16px; color: #666; cursor: pointer; background: none; border: none; }
        .me-settings-save-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 6px 16px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .me-settings-scroll-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .me-settings-group { background-color: white; border-radius: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); }
        .me-settings-group h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .me-settings-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .me-settings-label { width: 50px; font-size: 13px; color: #555; font-weight: 500; flex-shrink: 0; }
        .me-settings-preview-wrapper { flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .me-settings-preview { background-color: #f9f9f9; border: 1px solid #eee; background-size: cover; background-position: center; object-fit: contain; }
        .me-settings-preview.avatar { width: 40px; height: 40px; border-radius: 50%; }
        .me-settings-preview.cover { width: 60px; height: 40px; border-radius: 6px; object-fit: cover; }
        .me-settings-preview.icon { width: 30px; height: 30px; border-radius: 6px; }
        .me-settings-input { flex: 1; padding: 10px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; font-size: 13px; outline: none; transition: border-color 0.2s; color: #555; min-width: 0; }
        .me-settings-input:focus { border-color: var(--theme-pink-text); background-color: #fff; }

        /* --- Wallet App Style --- */
        #wallet-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #FDF6F9; z-index: 550;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.wallet-active #wallet-app-page { transform: translateY(0); }
        
        .wallet-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background-color: transparent; flex-shrink: 0;
            transition: padding-top 0.3s ease;
        }
        .wallet-user-area { display: flex; align-items: center; }
        .wallet-avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            margin-right: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid white; cursor: pointer;
        }
        .wallet-nickname { font-size: 16px; font-weight: 600; color: #333; cursor: pointer; }
        .wallet-close-btn {
            font-size: 14px; font-weight: 600; color: #999;
            background: rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; backdrop-filter: blur(5px);
        }
        .wallet-content {
            flex: 1; padding: 10px 20px 30px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
        }
        .wallet-balance-card {
            background: var(--wallet-gradient); border-radius: 24px; padding: 30px 25px;
            color: white; box-shadow: var(--wallet-card-shadow); position: relative;
            overflow: hidden; flex-shrink: 0; display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 180px;
        }
        .wallet-balance-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%); pointer-events: none;
        }
        .wallet-balance-label { font-size: 14px; opacity: 0.9; margin-bottom: 10px; font-weight: 500; }
        .wallet-balance-amount { font-size: 42px; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .wallet-stats-row { display: flex; gap: 15px; }
        .wallet-stat-box {
            flex: 1; background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column;
        }
        .wallet-stat-label { font-size: 13px; color: #888; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .wallet-stat-label.in::before { content: '↓'; color: var(--success-green); font-weight: bold; }
        .wallet-stat-label.out::before { content: '↑'; color: var(--error-red); font-weight: bold; }
        .wallet-stat-val { font-size: 18px; font-weight: 600; color: #333; }
        .wallet-actions { display: flex; gap: 15px; }
        .wallet-btn {
            flex: 1; padding: 15px; border-radius: 18px; border: none;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.1s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .wallet-btn:active { transform: scale(0.98); }
        .wallet-btn.income { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .wallet-btn.expense { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        .wallet-list-container {
            flex: 1; background: white; border-radius: 24px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02); min-height: 200px; display: flex; flex-direction: column;
        }
        .wallet-list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f9f9f9;
        }
        .wallet-list-title { font-size: 16px; font-weight: 600; color: #333; }
        .wallet-month-badge { background: #f0f0f0; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #666; }
        .wallet-items-scroll { flex: 1; overflow-y: auto; }
        .wallet-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }
        .wallet-item:last-child { border-bottom: none; }
        .wallet-item-icon {
            width: 40px; height: 40px; border-radius: 12px; background: #FDF6F9;
            display: flex; justify-content: center; align-items: center; font-size: 20px; margin-right: 12px;
        }
        .wallet-item-info { flex: 1; }
        .wallet-item-cat { font-size: 15px; color: #333; font-weight: 500; margin-bottom: 4px; }
        .wallet-item-date { font-size: 12px; color: #999; }
        .wallet-item-amount { font-size: 16px; font-weight: 600; }
        .wallet-item-amount.in { color: var(--success-green); }
        .wallet-item-amount.out { color: var(--error-red); }
        .wallet-empty { text-align: center; color: #ccc; margin-top: 40px; font-size: 14px; }

        /* 记账弹窗 */
        #wallet-add-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 600;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        #wallet-add-modal.active { opacity: 1; pointer-events: auto; }
        .wallet-add-card {
            background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #wallet-add-modal.active .wallet-add-card { transform: scale(1); }
        .wallet-modal-title { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 20px; color: #333; }
        .wallet-input-group { margin-bottom: 15px; }
        .wallet-input { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee; background: #f9f9f9; font-size: 16px; outline: none; }
        .wallet-input:focus { background: white; border-color: var(--theme-pink-text); }
        .wallet-type-select { display: flex; gap: 10px; margin-bottom: 20px; }
        .wallet-type-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #eee; background: #fff; color: #666; font-size: 14px; cursor: pointer; transition: all 0.2s;
        }
        .wallet-type-btn.active.in { background: rgba(76, 175, 80, 0.1); border-color: var(--success-green); color: var(--success-green); font-weight: 600; }
        .wallet-type-btn.active.out { background: rgba(244, 67, 54, 0.1); border-color: var(--error-red); color: var(--error-red); font-weight: 600; }
        .wallet-confirm-btn { width: 100%; padding: 14px; background: var(--theme-pink-text); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .wallet-cancel-btn { width: 100%; padding: 10px; background: transparent; color: #999; border: none; margin-top: 10px; cursor: pointer; font-size: 14px; }

        /* --- 添加好友弹窗样式 --- */
        #add-friend-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        #add-friend-modal.active { opacity: 1; pointer-events: auto; }
        .add-friend-card { width: 80%; max-width: 320px; background: white; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; align-items: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; }
        #add-friend-modal.active .add-friend-card { transform: scale(1); }
        .add-friend-close { position: absolute; top: 15px; left: 15px; font-size: 24px; color: #999; cursor: pointer; line-height: 1; }
        .add-friend-save { position: absolute; top: 15px; right: 15px; width: 24px; height: 24px; cursor: pointer; transition: transform 0.2s; }
        .add-friend-save:active { transform: scale(0.9); }
        .add-friend-avatar-upload { width: 100px; height: 100px; border-radius: 50%; background-color: #f0f0f0; margin-top: 15px; margin-bottom: 10px; cursor: pointer; overflow: hidden; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; color: #ccc; font-size: 40px; }
        .add-friend-avatar-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        .add-friend-url-input { width: 100%; padding: 8px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; margin-bottom: 15px; font-size: 12px; outline: none; color: #666; text-align: center; }
        .add-friend-url-input::placeholder { color: #aaa; }
        .add-friend-input { width: 100%; padding: 12px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 12px; margin-bottom: 12px; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .add-friend-input:focus { border-color: var(--theme-pink-text); background-color: white; }

        /* --- 删除确认弹窗 (通用) --- */
        .delete-confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 800; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .delete-confirm-modal.active { opacity: 1; pointer-events: auto; }
        .delete-card { background: white; width: 80%; max-width: 280px; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transform: scale(0.9); transition: transform 0.2s; }
        .delete-confirm-modal.active .delete-card { transform: scale(1); }
        .delete-card-title { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 25px; }
        .delete-card-actions { display: flex; justify-content: space-around; gap: 10px; }
        .delete-card-btn { flex: 1; padding: 10px 0; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-confirm-delete { background: #ffebee; color: #F44336; }


        /* --- 纯平面长椭圆底栏 (Chat App) --- */
        .chat-bottom-bar-container { position: fixed; bottom: calc(env(safe-area-inset-bottom, 20px) + 15px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; height: 64px; background-color: #FFFFFF; border-radius: 32px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.03); display: flex; justify-content: space-evenly; align-items: center; 
        z-index: 501; }
        .chat-nav-item { flex: 1; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0.5; transition: opacity 0.2s ease; }
        .chat-nav-item.active { opacity: 1; }
        .chat-nav-icon { width: 28px; height: 28px; object-fit: contain; pointer-events: none; }

        /* --- 全屏设置页面 --- */
        #settings-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--theme-pink-bg-light); z-index: 100; display: flex; flex-direction: column; padding: 20px 15px env(safe-area-inset-bottom, 20px) 15px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), padding-top 0.3s ease; overflow-x: hidden; }
        body.settings-active #settings-page { transform: translateY(0); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .settings-header .back-btn-container { display: flex; align-items: center; }
        .settings-header .title { font-size: 18px; font-weight: 600; color: #333; }
        #save-settings-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 8px 20px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .settings-content { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .settings-module { background-color: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); width: 100%; }
        .settings-module h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .settings-row { display: flex; flex-direction: column; align-items: stretch; margin-bottom: 15px; }
        .settings-row label { width: 100%; font-size: 14px; color: #555; margin-bottom: 6px; font-weight: 500; }
        .settings-row input, .settings-row button, .settings-row select { width: 100%; border: 1px solid #ddd; background-color: #f9f9f9; border-radius: 8px; padding: 10px; font-size: 14px; color: #333; outline: none; -webkit-appearance: none; min-width: 0; }
        .input-with-preview { display: flex; align-items: center; gap: 10px; width: 100%; }
        .input-with-preview input { flex: 1; min-width: 0; }
        .url-preview { width: 45px; height: 45px; border-radius: 8px; flex-shrink: 0; background-size: cover; background-position: center; border: 1px solid #eee; background-color: #f0f0f0; }
        .api-control-wrapper { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .api-control-row { display: flex; align-items: center; justify-content: space-between; }
        .api-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; }
        .api-status.connected { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .api-status.disconnected { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        .api-control-buttons { display: flex; gap: 10px; }
        .api-control-buttons button { flex: 1; white-space: nowrap; }
        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after { content: '▾'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }
        .settings-row select { padding-right: 30px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .temp-slider-container { display: flex; align-items: center; width: 100%; gap: 10px; }
        #temp-slider { flex: 1; padding: 0; height: 20px; }
        #temp-value-display { font-size: 14px; color: #555; min-width: 30px; text-align: right; }
        .app-icon-item { display: flex; align-items: center; margin-bottom: 12px; padding: 10px; border-radius: 12px; background-color: #f9f9f9; }
        .app-icon-preview { width: 40px; height: 40px; border-radius: 10px; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; background-size: cover; background-position: center; background-color: rgba(229, 138, 171, 0.1); }
        .app-icon-info { flex: 1; min-width: 0; }
        .app-icon-name { font-weight: 500; margin-bottom: 6px; color: #333; font-size: 13px; }
        .app-icon-input { display: flex; gap: 8px; }
        .app-icon-input input { flex: 1; min-width: 0; padding: 6px 8px; font-size: 12px; }
        .app-icon-input button { padding: 6px 12px; width: auto; font-size: 12px; background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; }
        
        /* --- iOS Mode Switch Styles (Generic row with switch) --- */
        .settings-row-with-switch {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0; /* Adjusted padding */
            margin-bottom: 5px;
        }
        .settings-row-with-switch > label {
            margin-bottom: 0;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
            flex-shrink: 0;
        }
        .ios-switch input { opacity: 0; width: 0; height: 0; }
        .ios-switch .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s;
        }
        .ios-switch .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s;
        }
        .ios-switch input:checked + .slider { background-color: #FFC0CB; }
        .ios-switch input:focus + .slider { box-shadow: 0 0 1px #FFC0CB; }
        .ios-switch input:checked + .slider:before { transform: translateX(20px); }
        .ios-switch .slider.round { border-radius: 34px; }
        .ios-switch .slider.round:before { border-radius: 50%; }
        
        /* --- MODIFIED: iOS Mode Active Global Styles --- */
        body.ios-mode-active #time-section { padding-top: env(safe-area-inset-top, 20px); }
        body.ios-mode-active .chat-app-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); } 
        /* 修改：下移聊天顶栏 */
        body.ios-mode-active .chat-conv-header { 
            padding-top: calc(env(safe-area-inset-top, 20px) + 25px); /* 减少padding-top */
            height: 120px; /* 增加高度适应 */
        }
        body.ios-mode-active .chat-conv-back-btn,
        body.ios-mode-active .chat-conv-right-icon {
            transform: translateY(-20px); /* 向上移动 */
        }
        body.ios-mode-active .chat-conv-title-container { margin-top: -30px; /* 向上移动 */ }
        
        body.ios-mode-active #role-settings-page { padding-top: calc(env(safe-area-inset-top, 20px) + 20px); }
        body.ios-mode-active .me-settings-header-bar { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .wallet-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active #settings-page { padding-top: env(safe-area-inset-top, 20px); }
        body.ios-mode-active .wb-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .wb-detail-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .wb-color-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .add-moment-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }

        #toast-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background-color: rgba(255, 230, 240, 0.98); color: #E58AAB; padding: 15px 25px; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; text-align: center; max-width: 80%; }
        #toast-notification.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .file-input-hidden { display: none; }

        /* AI Chat UI */
        #ai-chat-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #ai-chat-modal.active { opacity: 1; pointer-events: all; }
        #ai-chat-container { width: 90%; max-width: 500px; height: 80%; background-color: white; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #ai-chat-modal.active #ai-chat-container { transform: translateY(0); }
        .chat-header { padding: 15px 20px; background-color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .chat-header .model-name { font-weight: 600; color: #333; font-size: 16px; }
        .chat-header .close-btn { background: #f0f0f0; border: none; width: 28px; height: 28px; border-radius: 14px; font-size: 18px; cursor: pointer; color: #999; display: flex; align-items: center; justify-content: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background-color: #fcfcfc; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 14px; word-wrap: break-word; }
        .message.user { background-color: var(--theme-pink-text); color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background-color: #f0f0f0; color: #333; margin-right: auto; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 12px 15px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); border-top: 1px solid #f0f0f0; display: flex; gap: 10px; background-color: white; }
        .chat-input-area input { flex: 1; padding: 10px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 20px; font-size: 14px; outline: none; }
        .chat-input-area button { padding: 0 18px; background-color: var(--theme-pink-text); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; }

        /* --- World Book App Styles --- */
        #worldbook-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--theme-pink-bg-soft);
            z-index: 550;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.worldbook-active #worldbook-app-page { transform: translateY(0); }
        
        .wb-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border-radius: 0 0 25px 25px; z-index: 10;
            transition: padding-top 0.3s ease;
        }
        .wb-back-btn-img {
            width: 30px; height: 30px; object-fit: contain; cursor: pointer;
        }
        .wb-title { font-size: 18px; font-weight: 600; color: var(--theme-pink-title); letter-spacing: 0.5px; }
        .wb-header-actions { display: flex; align-items: center; gap: 15px; }
        .wb-action-icon { width: 24px; height: 24px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .wb-action-icon:hover { opacity: 1; }
        .wb-add-btn { font-size: 28px; color: var(--wb-plus-btn); cursor: pointer; line-height: 1; font-weight: 300; }
        
        .wb-content {
            flex: 1; padding: 20px; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px; align-content: start;
        }
        .wb-book-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .wb-book-item:active { transform: scale(0.95); }
        
        .wb-book-cover {
            width: 90px; height: 120px;
            background: linear-gradient(135deg, #f5f5f5 0%, #EAEAEA 100%);
            border-radius: 4px 8px 8px 4px;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.1), inset 4px 0 10px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center; padding: 10px;
            position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.08);
            transition: background 0.3s;
        }
        .wb-book-cover::before {
            content: ''; position: absolute; left: 4px; top: 0; width: 2px; height: 100%;
            background: rgba(0,0,0,0.05); box-shadow: 2px 0 0 rgba(0,0,0,0.05);
        }
        .wb-book-name { font-size: 13px; font-weight: 600; color: #555; text-align: center; word-break: break-all; line-height: 1.4; }

        #worldbook-add-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 600; backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #worldbook-add-modal.active { opacity: 1; pointer-events: auto; }
        .wb-modal-card {
            background: var(--theme-pink-bg-soft);
            width: 90%; max-width: 380px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 8px 30px rgba(229, 138, 171, 0.25);
            max-height: 85vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #worldbook-add-modal.active .wb-modal-card { transform: scale(1); }
        .wb-modal-header { font-size: 17px; font-weight: 600; color: var(--theme-pink-text); text-align: center; margin-bottom: 20px; flex-shrink: 0; }
        
        .wb-modal-scroll-area { flex: 1; overflow-y: auto; margin: -10px -10px 15px; padding: 10px 10px 0; }
        
        .wb-input-label { font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 600; padding-left: 5px; }
        .wb-main-input { width: 100%; padding: 12px; border: 1px solid #FADBE6; background: #fff; border-radius: 12px; outline: none; font-size: 15px; margin-bottom: 15px; }
        .wb-main-input:focus { border-color: var(--theme-pink-btn); box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3); }

        .wb-entry-row {
            display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding: 15px;
            background-color: #ffffff; border-radius: 12px; border: 1px solid #FADBE6;
        }
        .wb-entry-input {
            width: 100%; border: none; background: #f9f9f9;
            border-radius: 8px; padding: 10px; font-size: 14px;
            outline: none; transition: all 0.2s;
        }
        .wb-entry-input.val { min-height: 120px; resize: vertical; line-height: 1.5; }
        .wb-entry-input:focus { background: white; border-color: var(--theme-pink-btn); box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3); }
        
        .wb-plus-row-btn {
            width: 100%; padding: 10px; margin-top: 15px; border: 2px dashed #FDCEDF; background: transparent;
            color: var(--theme-pink-btn); border-radius: 12px; cursor: pointer; font-size: 22px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        .wb-plus-row-btn:active { background: rgba(253, 206, 223, 0.3); }
        
        .wb-modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; flex-shrink: 0; }
        .wb-action-btn { padding: 10px 25px; border-radius: 20px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; }
        .wb-btn-cancel { background: transparent; color: #aaa; }
        .wb-btn-ok { background: var(--theme-pink-btn); color: white; box-shadow: 0 4px 10px rgba(245, 179, 201, 0.4); }

        #worldbook-detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--theme-pink-bg-soft); z-index: 650;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #worldbook-detail-modal.active { transform: translateX(0); }
        .wb-detail-header {
             padding: 35px 20px 15px;
             display: flex; align-items: center; gap: 15px; background: white;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-shrink: 0;
             transition: padding-top 0.3s ease;
        }
        .wb-detail-back { font-size: 24px; color: #333; cursor: pointer; }
        .wb-detail-title { flex: 1; font-size: 18px; font-weight: 600; color: var(--theme-pink-text); }
        .wb-delete-book-btn {
            background-color: var(--theme-pink-btn); color: white;
            padding: 6px 16px; border-radius: 15px; border: none; font-size: 14px;
            font-weight: 500; cursor: pointer; transition: opacity 0.2s; white-space: nowrap;
        }
        .wb-delete-book-btn:active { opacity: 0.8; }
        
        .wb-detail-content { flex: 1; padding: 20px; overflow-y: auto; }
        .wb-detail-item {
            margin-bottom: 15px; background: white; border-radius: 12px;
            padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }
        .wb-detail-item-content { flex: 1; }
        .wb-detail-key { font-size: 13px; color: #999; font-weight: 500; margin-bottom: 6px; }
        .wb-detail-val { font-size: 16px; color: #333; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }

        .wb-detail-item-actions { display: flex; gap: 10px; align-self: flex-end; margin-top: 15px; }
        .wb-detail-item-actions button {
            background: #f0f0f0; border: none; border-radius: 8px; padding: 5px 12px;
            font-size: 12px; color: #666; cursor: pointer;
        }
        .wb-detail-item-actions button.save { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); }
        .wb-detail-item .edit-form textarea { min-height: 80px; }


        #worldbook-color-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--theme-pink-bg-light); z-index: 700;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #worldbook-color-page.active { transform: translateY(0); }
        .wb-color-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: padding-top 0.3s ease;
        }
        .wb-color-title { font-size: 18px; font-weight: 600; color: var(--theme-pink-text); }
        .wb-color-save-btn {
            background-color: var(--theme-pink-btn); color: white; border: none; border-radius: 15px;
            padding: 8px 20px; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .wb-color-content { flex: 1; overflow-y: auto; padding: 20px; }
        .wb-color-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .wb-color-item-name { font-size: 15px; color: #333; flex: 1; }
        .wb-color-input {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 40px; height: 40px; background: none; border: none;
            cursor: pointer; padding: 0; border-radius: 8px;
        }
        .wb-color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .wb-color-input::-webkit-color-swatch { border: 1px solid #ddd; border-radius: 8px; }
        .wb-color-input::-moz-color-swatch { border: 1px solid #ddd; border-radius: 8px; }

        #worldbook-bind-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 800; backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #worldbook-bind-modal.active { opacity: 1; pointer-events: auto; }
        .wb-bind-modal-card {
            background: white;
            width: 85%; max-width: 340px; border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            max-height: 70vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #worldbook-bind-modal.active .wb-bind-modal-card { transform: scale(1); }
        .wb-bind-modal-header {
            padding: 15px 20px;
            font-size: 16px; font-weight: 600; color: var(--theme-pink-text);
            text-align: center; border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .wb-bind-modal-header .close-btn {
            font-size: 20px; color: #aaa; cursor: pointer;
        }
        .wb-bind-modal-list {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .wb-bind-list-item {
            padding: 15px;
            font-size: 15px; color: #333;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wb-bind-list-item:last-child {
            border-bottom: none;
        }
        .wb-bind-list-item:hover {
            background-color: #f9f9f9;
        }
        .wb-bind-list-item:active {
            background-color: #f0f0f0;
        }
        .wb-bind-list-empty {
            text-align: center; color: #ccc;
            padding: 40px 20px; font-size: 14px;
        }
        
        /* --- NEW: Moments Action Sheet (Popup) --- */
        #moments-action-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            backdrop-filter: blur(2px);
        }
        #moments-action-sheet-overlay.active { opacity: 1; pointer-events: auto; }
        
        #moments-action-sheet {
            background-color: var(--theme-pink-bg-soft);
            width: 95%; max-width: 400px;
            margin: 0 auto 15px; /* Bottom margin */
            border-radius: 20px;
            overflow: hidden;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        #moments-action-sheet-overlay.active #moments-action-sheet { transform: translateY(0); }
        
        .action-sheet-option {
            background: white;
            padding: 18px;
            text-align: center;
            font-size: 16px;
            color: #333;
            font-weight: 500;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .action-sheet-option:active { background-color: #f9f9f9; }
        .action-title { font-size: 16px; color: #333; }
        .action-subtitle { font-size: 12px; color: #999; margin-top: 2px; }
        
        .action-sheet-cancel {
            background: white;
            padding: 18px;
            text-align: center;
            font-size: 16px;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px; /* Visual separation */
            border-radius: 20px;
        }
        .action-sheet-cancel:active { background-color: #f9f9f9; }
        
    </style>
</head>
<body>

<div id="home-screen">
    <div id="time-section">
        <div id="time-container" onclick="handleTimeBgClick(event)">
            <div id="clock-time">12:00</div>
            <div id="clock-date" onclick="handleDateEdit(event)">2026年02月06日 星期五</div>
        </div>
    </div>
    <div id="grid-area">
        <div class="grid-quadrant" id="avatar-quadrant-1">
            <div id="chat-dual-container">
                <div class="chat-row left">
                    <div class="avatar-container" onclick="editChatAvatarUrl('chat-avatar-1')">
                        <div class="avatar-ring">
                            <div class="avatar-img-circle" id="chat-avatar-1" style="background-image: url('https://img.heliar.top/file/1770068438490_添加人群_people-plus.png');"></div>
                        </div>
                    </div>
                    <input type="text" class="chat-bubble-input left-bubble" value="Say Hi~" oninput="adjustInputWidth(this)">
                </div>
                <div class="chat-row right">
                    <div class="avatar-container" onclick="editChatAvatarUrl('chat-avatar-2')">
                        <div class="avatar-ring">
                            <div class="avatar-img-circle" id="chat-avatar-2" style="background-image: url('https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png');"></div>
                        </div>
                    </div>
                    <input type="text" class="chat-bubble-input right-bubble" value="Hello!" oninput="adjustInputWidth(this)">
                </div>
            </div>
        </div>

        <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item" onclick="openChatApp()">
                    <div class="app-icon" id="icon-app1">☁️</div>
                    <span class="app-name" data-app-name="Chat">Chat</span>
                </div>
                <div class="app-item" onclick="openWorldBookApp()"><div class="app-icon" id="icon-app2">🎵</div><span class="app-name" data-app-name="世界书">世界书</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app3">💬</div><span class="app-name" data-app-name="提醒">提醒</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app4">📸</div><span class="app-name" data-app-name="相册">相册</span></div>
            </div>
        </div>
        <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item"><div class="app-icon" id="icon-app5">🧭</div><span class="app-name" data-app-name="HUshhh">HUshhh</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app6">🎮</div><span class="app-name" data-app-name="pxx">pxx</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app7">📅</div><span class="app-name" data-app-name="日历">日历</span></div>
                <div class="app-item" onclick="openWalletApp()"><div class="app-icon" id="icon-app8">💰</div><span class="app-name" data-app-name="Wallet">Wallet</span></div>
            </div>
        </div>

        <div class="grid-quadrant" id="photo-widget-quadrant">
            <div class="photo-widget-container" onclick="triggerPhotoWidgetUpload()">
                <div id="photo-widget-placeholder" class="photo-widget-placeholder">
                    <div class="photo-widget-icon">📷</div>
                    <div class="photo-widget-text">Add Photo</div>
                </div>
                <img id="photo-widget-img" class="photo-widget-img" src="">
            </div>
        </div>
    </div>
    <div id="dock-area">
        <div class="dock-container">
            <div class="app-item" onclick="showSettingsPage()"><div class="app-icon dock-icon" id="icon-dock-settings">⚙️</div></div>
            <div class="app-item" onclick="openAIChat()"><div class="app-icon dock-icon" id="icon-dock-ai">🤖</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-safari">🧭</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-messages">✉️</div></div>
        </div>
    </div>
</div>

<!-- Chat App 页面 -->
<div id="chat-app-page">
    <div class="chat-app-header" id="chat-app-header-el">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-icon-img" id="chat-back-btn" onclick="closeChatApp()">
        <div class="chat-header-title" id="chat-page-title">Chat</div>
        <!-- 右上角图标容器 -->
        <div id="chat-header-right-icons" style="display: flex; gap: 15px;">
            <img id="chat-header-add-friend-icon" src="https://img.heliar.top/file/1770068438490_添加人群_people-plus.png" class="header-right-icon" onclick="openAddFriendModal()">
            <img id="chat-header-add-moment-icon" src="https://img.heliar.top/file/1770345149331_相机_camera.png" class="header-right-icon" onclick="openMomentsActionSheet()" style="display: none;">
        </div>
    </div>
    
    <div class="chat-app-content" id="chat-content-area">
        <div id="chat-tab-0" class="chat-tab-content active">
            <div class="chat-list-container" id="chat-list-container">
                <!-- Chat list dynamically generated -->
            </div>
        </div>
        <div id="chat-tab-1" class="chat-tab-content">
            <div class="contact-list-container" id="contact-list-container">
                 <!-- Contacts dynamically generated -->
            </div>
            <div class="alpha-index-bar" id="alpha-index-bar"></div>
        </div>
        <div id="chat-tab-2" class="chat-tab-content">
            <!-- NEW: Moments page will be rendered here -->
            <div id="moments-page-wrapper"></div>
        </div>
        
        <div id="chat-tab-3" class="chat-tab-content">
            <div class="me-page-container">
                <div class="me-cover-area" id="profile-cover">
                    <div class="me-like-wrapper">
                        <img src="https://img.heliar.top/file/1770079217317_赞_thumbs-up_2.png" class="me-like-icon" onclick="incrementLikeCount(event)">
                        <div class="me-like-count" id="profile-like-count">8888</div>
                    </div>
                    <div class="me-setting-wrapper">
                        <img src="https://img.heliar.top/file/1770083061419_设置_setting-two.png" class="me-setting-icon" onclick="openMeSettings()">
                    </div>
                </div>
                <div class="me-content-area">
                    <div class="me-floating-header">
                        <div class="me-avatar-box">
                            <img id="profile-avatar" class="me-avatar-img" src="" onerror="this.src='https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'">
                        </div>
                        <div class="me-text-col">
                            <div class="me-nickname" id="profile-nickname" onclick="editNickname(event)">User Name</div>
                            <div class="me-qq-id" id="profile-qq-id" onclick="editQQID(event)">QQ: 20261314520</div>
                        </div>
                    </div>
                    <div class="me-info-list">
                        <div class="me-list-item" onclick="editSignature()">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081937488_人员_people.png">
                            <div class="me-list-text" id="profile-signature-text">这个人很懒，什么都没留下~</div>
                            <div class="me-list-arrow">＞</div>
                        </div>
                        <div class="me-list-item">
                            <img id="me-member-icon-main" class="me-list-icon" src="https://img.heliar.top/file/1770081928967_vip_vip-one.png">
                            <div class="me-list-text">
                                <div id="me-member-icon-container" class="me-member-icons-row"></div>
                            </div>
                            <div class="me-list-arrow">＞</div>
                        </div>
                        <div class="me-list-item">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081938581_星星_star-one.png">
                            <div class="me-list-text">QQ空间</div>
                            <div class="me-list-arrow">＞</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="chat-bottom-bar-container">
        <div class="chat-nav-item active" onclick="switchChatTab(0, 'Chat')">
            <img src="https://img.heliar.top/file/1770068139630_信息_message_3.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(1, '通讯录')">
            <img src="https://img.heliar.top/file/1770068141129_通讯录_address-book_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(2, '朋友圈')">
            <img src="https://img.heliar.top/file/1770068142240_朋友圈_friends-circle_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(3, '我')">
            <img src="https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png" class="chat-nav-icon">
        </div>
    </div>

    <!-- 角色聊天专属页面 -->
    <div id="chat-conversation-view">
        <div class="chat-conv-header">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="chat-conv-back-btn" onclick="closeChatConversation()">
            <div class="chat-conv-title-container">
                <div class="chat-conv-title" id="chat-conv-title">角色名称</div>
                <div class="chat-conv-signature" id="chat-conv-signature"></div>
            </div>
            <img class="chat-conv-right-icon" src="https://img.heliar.top/file/1770241189848_更多_more.png" onclick="openRoleSettings()">
        </div>
        <div class="chat-conv-messages" id="chat-conv-messages"></div>
        <div class="chat-conv-footer">
            <button class="chat-conv-btn"><img src="https://img.heliar.top/file/1770239041392_开关_power.png" style="width: 24px; height: 24px; object-fit: contain;"></button>
            <div class="chat-conv-input-wrapper">
                <input type="text" class="chat-conv-input" id="chat-conv-input" placeholder="输入消息..." onkeydown="handleChatInputKey(event)">
            </div>
            <button class="chat-conv-btn" style="margin-right: 0;"><img src="https://img.heliar.top/file/1770239038945_喜欢_like.png" style="width: 24px; height: 24px; object-fit: contain;"></button>
            <!-- 仅保留AI触发功能 -->
            <button class="chat-conv-btn send ai-trigger" onclick="triggerAIAutoReply()"><img src="https://img.heliar.top/file/1770239044304_发送_send.png" style="width: 20px; height: 20px; object-fit: contain;"></button>
        </div>
        <!-- Multiselect Footer -->
        <div class="chat-multiselect-footer" id="chat-multiselect-footer">
             <button class="chat-multiselect-delete-btn" onclick="executeBatchDelete()">删除</button>
        </div>
    </div>
</div>

<!-- 角色设置页面 -->
<div id="role-settings-page">
    <div class="role-setting-close-area">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="role-setting-back-btn" onclick="closeRoleSettings()">
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">角色设置 (Role)</div>
        <div class="role-avatar-edit-wrapper" onclick="triggerRoleAvatarEdit()">
            <img id="role-setting-avatar" class="role-avatar-edit" src="">
            <div class="avatar-edit-hint">✎</div>
        </div>
        <input type="text" id="role-setting-alias" class="role-alias-edit" placeholder="备注名">
        <input type="text" id="role-setting-signature" class="role-signature-edit" placeholder="角色签名...">
        <textarea id="role-setting-persona" class="role-persona-input" placeholder="输入角色人设 (Persona)..."></textarea>
        
        <!-- NEW: Time Perception Switch -->
        <div class="settings-row-with-switch" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px;">
            <label for="role-time-perception-switch">时间感知</label>
            <label class="ios-switch">
                <input type="checkbox" id="role-time-perception-switch">
                <span class="slider round"></span>
            </label>
        </div>

        <!-- NEW: Memory Depth Input -->
        <div class="settings-row" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px; display: flex; align-items: center; justify-content: space-between;">
            <label for="role-memory-depth" style="font-size:14px; color:#555; font-weight:500;">记忆条数 (Memory)</label>
            <input type="number" id="role-memory-depth" placeholder="10" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
        </div>

        <div class="role-bg-upload-area" style="display: flex; flex-direction: column; gap: 10px; padding: 15px; margin-top: 15px;">
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <span style="font-size:13px; color:#555;">聊天背景</span>
                <div id="role-bg-preview" class="role-bg-preview"></div>
            </div>
            <input type="text" id="role-bg-url-input" placeholder="输入背景图片URL" style="width: 100%; padding: 10px; border: 1px solid #FADBE6; border-radius: 8px; font-size: 14px;">
            <div style="display: flex; gap: 10px;">
                <button class="role-bg-btn" onclick="triggerRoleBgUpload()">上传图片</button>
                <button class="role-bg-btn" onclick="setRoleBgByUrl()">应用URL</button>
            </div>
        </div>
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">角色世界书</div>
        <div class="role-wb-binding-area">
            <div id="role-wb-display" class="unbound">未绑定</div>
            <div class="actions">
                <button id="role-wb-clear-btn" onclick="clearWorldBookBinding()" style="display: none;">清除</button>
                <button onclick="openWorldBookBindModal()">选择</button>
            </div>
        </div>
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">用户设置 (User)</div>
        <div class="user-avatar-row">
            <div class="user-avatar-edit-wrapper" onclick="triggerRoleUserAvatarEdit()">
                <img id="role-user-avatar" class="role-avatar-edit" src="https://img.heliar.top/file/1770068438490_添加人群_people-plus.png">
                <div class="avatar-edit-hint">✎</div>
            </div>
            <input type="text" id="role-user-name" class="user-name-input" placeholder="您的名字">
        </div>
        <textarea id="role-user-persona" class="role-persona-input" placeholder="输入您的人设 (User Persona)..."></textarea>
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">自定义样式 (CSS)</div>
        <textarea id="role-setting-css" class="role-css-input" placeholder="/* 在这里输入CSS代码修改气泡样式 */..."></textarea>
    </div>
    <button class="role-save-btn" onclick="saveRoleSettings()">保存设置</button>
    <button class="role-delete-btn" onclick="confirmDeleteFriend()">删除好友</button>
</div>

<!-- NEW: Add Moment Modal -->
<div id="add-moment-modal">
    <div class="add-moment-header">
        <button class="add-moment-cancel" onclick="closeAddMomentModal()">取消</button>
        <button class="add-moment-post" onclick="saveNewMoment()">发表</button>
    </div>
    <div class="add-moment-content">
        <textarea id="add-moment-text" placeholder="这一刻的想法..."></textarea>
        <div class="add-moment-grid" id="add-moment-grid">
            <div class="add-moment-image-upload" onclick="triggerMomentImageUpload()">
                 <span id="moment-upload-icon">+</span>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Moments Comment MODAL (Updated Layout) -->
<div id="moments-comment-overlay" onclick="closeCommentInput()"></div>
<div id="moments-comment-modal">
    <input type="text" id="moments-comment-input" placeholder="发表评论:" onkeypress="handleCommentKey(event)">
    <img src="https://img.heliar.top/file/1770357295773_笑脸_smiling-face_2.png" class="moments-emoji-btn">
    <button id="moments-comment-submit-btn" onclick="submitComment()">发送</button>
</div>


<!-- Wallet App 页面 -->
<div id="wallet-app-page">
    <div class="wallet-header">
        <div class="wallet-close-btn" onclick="closeWalletApp()">✕</div>
        <div class="wallet-user-area">
            <img id="wallet-avatar" class="wallet-avatar" onclick="triggerProfileAvatarUpload(event)">
            <span id="wallet-nickname" class="wallet-nickname" onclick="editNickname(event)">User</span>
        </div>
    </div>
    <div class="wallet-content">
        <div class="wallet-balance-card">
            <div class="wallet-balance-label">总余额 (CNY)</div>
            <div class="wallet-balance-amount" id="wallet-total-balance">0.00</div>
        </div>
        <div class="wallet-stats-row">
            <div class="wallet-stat-box">
                <div class="wallet-stat-label in">本月收入</div>
                <div class="wallet-stat-val" id="wallet-month-income">0.00</div>
            </div>
            <div class="wallet-stat-box">
                <div class="wallet-stat-label out">本月支出</div>
                <div class="wallet-stat-val" id="wallet-month-expense">0.00</div>
            </div>
        </div>
        <div class="wallet-actions">
            <button class="wallet-btn income" onclick="openWalletModal('income')"><span>+</span> 记收入</button>
            <button class="wallet-btn expense" onclick="openWalletModal('expense')"><span>-</span> 记支出</button>
        </div>
        <div class="wallet-list-container">
            <div class="wallet-list-header">
                <div class="wallet-list-title">本月明细</div>
                <div class="wallet-month-badge" id="wallet-current-month">2月</div>
            </div>
            <div class="wallet-items-scroll" id="wallet-transaction-list"></div>
        </div>
    </div>
</div>

<!-- World Book App Page -->
<div id="worldbook-app-page">
    <div class="wb-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="wb-back-btn-img" onclick="closeWorldBookApp()">
        <div class="wb-title">世界书>៸៸៸< </div>
        <div class="wb-header-actions">
             <img src="https://img.heliar.top/file/1770251413162_颜色滤镜_color-filter.png" class="wb-action-icon" onclick="openWorldBookColorSettings()">
            <div class="wb-add-btn" onclick="openWorldBookAddModal()">+</div>
        </div>
    </div>
    <div class="wb-content" id="worldbook-list"></div>
</div>

<!-- World Book Add Modal -->
<div id="worldbook-add-modal">
    <div class="wb-modal-card">
        <div class="wb-modal-header">添加世界书</div>
        <div class="wb-modal-scroll-area">
            <div class="wb-input-label">世界书名</div>
            <input type="text" id="wb-title-input" class="wb-main-input" placeholder="输入世界书名称...">
            <div id="wb-dynamic-entries">
                <div class="wb-entry-row wb-dynamic-row">
                    <input type="text" class="wb-entry-input key" placeholder="名称（可选）">
                    <textarea class="wb-entry-input val" placeholder="世界书内容"></textarea>
                </div>
            </div>
            <button class="wb-plus-row-btn" onclick="addWorldBookEntryRow()">+</button>
        </div>
        <div class="wb-modal-actions">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeWorldBookAddModal()">取消</button>
            <button class="wb-action-btn wb-btn-ok" onclick="saveWorldBook()">OK</button>
        </div>
    </div>
</div>

<!-- World Book Detail Modal -->
<div id="worldbook-detail-modal">
    <div class="wb-detail-header">
        <div class="wb-detail-back" onclick="closeWorldBookDetail()">＜</div>
        <div class="wb-detail-title" id="wb-detail-title-text">Title</div>
        <button class="wb-delete-book-btn" onclick="deleteCurrentWorldBook()">删除</button>
    </div>
    <div class="wb-detail-content" id="wb-detail-content-area"></div>
</div>

<!-- World Book Color Settings Page -->
<div id="worldbook-color-page">
    <div class="wb-color-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="wb-back-btn-img" onclick="closeWorldBookColorSettings()">
        <div class="wb-color-title">设置封面颜色</div>
        <button class="wb-color-save-btn" onclick="saveWorldBookColors()">OK</button>
    </div>
    <div class="wb-color-content" id="wb-color-list"></div>
</div>


<!-- Wallet 记账弹窗 -->
<div id="wallet-add-modal">
    <div class="wallet-add-card">
        <div class="wallet-modal-title">记一笔</div>
        <div class="wallet-type-select">
            <button class="wallet-type-btn active in" id="w-btn-in" onclick="setWalletType('income')">收入</button>
            <button class="wallet-type-btn" id="w-btn-out" onclick="setWalletType('expense')">支出</button>
        </div>
        <div class="wallet-input-group">
            <input type="number" id="wallet-amount-input" class="wallet-input" placeholder="0.00" step="0.01">
        </div>
        <div class="wallet-input-group">
            <input type="text" id="wallet-desc-input" class="wallet-input" placeholder="备注 (如: 餐饮, 工资)">
        </div>
        <button class="wallet-confirm-btn" onclick="saveTransaction()">确认</button>
        <button class="wallet-cancel-btn" onclick="closeWalletModal()">取消</button>
    </div>
</div>

<!-- 添加好友弹窗 -->
<div id="add-friend-modal">
    <div class="add-friend-card">
        <div class="add-friend-close" onclick="closeAddFriendModal()">✕</div>
        <img src="https://img.heliar.top/file/1770069003752_保存_save.png" class="add-friend-save" onclick="saveNewFriend()">
        <div class="add-friend-avatar-upload" onclick="triggerAvatarUpload()">
            <span id="avatar-placeholder-icon">+</span>
            <img id="new-friend-avatar-preview" class="add-friend-avatar-preview">
        </div>
        <input type="text" class="add-friend-url-input" id="new-friend-avatar-url" placeholder="或粘贴图片链接" oninput="handleAvatarUrlInput(this)">
        <input type="text" class="add-friend-input" id="new-friend-name" placeholder="姓名">
        <input type="text" class="add-friend-input" id="new-friend-alias" placeholder="备注 (可选)">
    </div>
</div>

<!-- 删除好友确认弹窗 -->
<div id="delete-friend-confirm-modal" class="delete-confirm-modal">
    <div class="delete-card">
        <div class="delete-card-title">确定删除该好友吗π_π</div>
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeDeleteModal('delete-friend-confirm-modal')">取消</button>
            <button class="delete-card-btn btn-confirm-delete" onclick="executeDeleteFriend()">删除</button>
        </div>
    </div>
</div>

<!-- NEW: 删除朋友圈确认弹窗 -->
<div id="delete-moment-confirm-modal" class="delete-confirm-modal">
    <div class="delete-card">
        <div class="delete-card-title">删除该朋友圈？</div>
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeDeleteModal('delete-moment-confirm-modal')">取消</button>
            <button class="delete-card-btn btn-confirm-delete" onclick="executeDeleteMoment()">删除</button>
        </div>
    </div>
</div>

<!-- World Book Binding Modal -->
<div id="worldbook-bind-modal">
    <div class="wb-bind-modal-card">
        <div class="wb-bind-modal-header">
            <span>选择绑定的世界书</span>
            <span class="close-btn" onclick="closeWorldBookBindModal()">✕</span>
        </div>
        <div class="wb-bind-modal-list" id="worldbook-bind-list"></div>
    </div>
</div>

<!-- NEW: Moments Action Sheet (Popup) -->
<div id="moments-action-sheet-overlay" onclick="closeMomentsActionSheet()">
   <div id="moments-action-sheet" onclick="event.stopPropagation()">
       <div class="action-sheet-option" onclick="handleMomentAction('shoot')">
            <div class="action-title">拍摄</div>
            <div class="action-subtitle">照片或视频</div>
       </div>
       <div class="action-sheet-option" onclick="handleMomentAction('album')">从手机相册选择</div>
       <div class="action-sheet-cancel" onclick="closeMomentsActionSheet()">取消</div>
   </div>
</div>

<div id="settings-page">
    <div class="settings-header">
        <div class="back-btn-container" onclick="hideSettingsPage()">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-icon-img">
        </div>
        <span class="title">设置</span>
        <button id="save-settings-btn">OK</button>
    </div>
    <div class="settings-content">
        <div class="settings-module">
            <h3>通用</h3>
            <div class="settings-row-with-switch">
                <label for="ios-mode-switch">iOS 模式 (刘海屏适配)</label>
                <label class="ios-switch">
                    <input type="checkbox" id="ios-mode-switch">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        <div class="settings-module">
            <h3>AI API 设置</h3>
            <div class="settings-row">
                <label for="api-url-input">API 地址</label>
                <input type="text" id="api-url-input" placeholder="例如: https://api.openai.com/v1">
            </div>
            <div class="settings-row">
                <label for="api-key-input">API Key</label>
                <input type="password" id="api-key-input" placeholder="输入您的 API Key">
            </div>
            <div class="settings-row">
                <label>模型设置</label>
                <div class="api-control-wrapper">
                    <div class="api-control-row">
                        <span id="api-status" class="api-status disconnected">未连接</span>
                    </div>
                    <div class="api-control-buttons">
                        <button id="test-api-btn">测试连接</button>
                        <button id="fetch-models-btn">获取模型列表</button>
                    </div>
                    <div class="select-wrapper" id="model-select-wrapper" style="display: none; margin-top: 10px;">
                        <select id="model-select"></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="settings-module">
            <h3>AI 参数设置</h3>
            <div class="settings-row">
                <label>回答温度 (Temperature)</label>
                <div class="temp-slider-container">
                    <input type="range" id="temp-slider" min="0" max="2" step="0.1" value="0.8">
                    <span id="temp-value-display">0.8</span>
                </div>
            </div>
            <div class="settings-row">
                <label for="max-tokens-input">最大生成令牌 (Tokens)</label>
                <input type="number" id="max-tokens-input" placeholder="例如: 1000" value="1000">
            </div>
        </div>
        <div class="settings-module">
            <h3>界面美化</h3>
            <div class="settings-row">
                <label for="wallpaper-url">壁纸 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="wallpaper-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="wallpaper-preview"></div>
                </div>
            </div>
        </div>
        <div class="settings-module">
            <h3>组件图片</h3>
            <div class="settings-row">
                <label for="widget-square-url">左下组件 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="widget-square-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="widget-square-preview"></div>
                </div>
            </div>
            <div class="settings-row">
                <label for="custom-image-url">右上组件 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="custom-image-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="custom-image-preview"></div>
                </div>
            </div>
        </div>
        <div class="settings-module">
            <h3>图标自定义</h3>
            <div class="settings-app-list" id="settings-app-list-container"></div>
        </div>
    </div>
</div>

<div id="ai-chat-modal">
    <div id="ai-chat-container">
        <div class="chat-header">
            <span class="model-name" id="current-model-name">未选择模型</span>
            <button class="close-btn" onclick="closeAIChat()">×</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai">你好！我是 AI 助手。请点击底栏第一个图标进入设置配置 API，然后我们就可以聊天了。</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="说点什么..." onkeypress="handleChatKeyPress(event)">
            <button id="send-chat-btn" onclick="sendChatMessage()">发送</button>
        </div>
    </div>
</div>

<div id="toast-notification"></div>

<div id="me-settings-modal">
    <div class="me-settings-header-bar">
        <button class="me-settings-close-btn" onclick="closeMeSettings()">关闭</button>
        <span class="me-settings-header-title">个人主页设置</span>
        <button class="me-settings-save-btn" onclick="saveMeSettings()">保存</button>
    </div>
    <div class="me-settings-scroll-content">
        <div class="me-settings-group">
            <h3>基础信息</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">头像</div>
                <div class="me-settings-preview-wrapper"><img id="me-settings-avatar-preview" class="me-settings-preview avatar"></div>
                <input type="text" id="me-settings-avatar-url" class="me-settings-input" placeholder="头像 URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">背景</div>
                <div class="me-settings-preview-wrapper"><img id="me-settings-cover-preview" class="me-settings-preview cover"></div>
                <input type="text" id="me-settings-cover-url" class="me-settings-input" placeholder="背景图 URL">
            </div>
        </div>
        <div class="me-settings-group">
            <h3>会员图标列表 (8个)</h3>
            <div id="me-settings-member-icons-list">
                <!-- Dynamically generated -->
            </div>
        </div>
    </div>
</div>

<input type="file" id="input-wallpaper" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
<input type="file" id="input-app-icon" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event)">
<input type="file" id="input-time-bg" class="file-input-hidden" accept="image/*" onchange="handleTimeBgUpload(event)">
<input type="file" id="input-friend-avatar" class="file-input-hidden" accept="image/*" onchange="handleFriendAvatarUpload(event)">
<input type="file" id="input-profile-avatar" class="file-input-hidden" accept="image/*" onchange="handleProfileAvatarUpload(event)">
<input type="file" id="input-photo-widget" class="file-input-hidden" accept="image/*" onchange="handlePhotoWidgetUpload(event)">
<input type="file" id="input-role-user-avatar" class="file-input-hidden" accept="image/*" onchange="handleRoleUserAvatarUpload(event)">
<input type="file" id="input-role-chat-bg" class="file-input-hidden" accept="image/*" onchange="handleRoleChatBgUpload(event)">
<input type="file" id="input-moment-image" class="file-input-hidden" multiple accept="image/*" onchange="handleMomentImageUpload(event)">

<script>
    'use strict';
    // --- DOM & Keys ---
    const body = document.body;
    const toast = document.getElementById('toast-notification');
    
    // --- LocalStorage Keys ---
    const ALL_SETTINGS_KEY = 'appSettings_v15';
    const CHAT_DATA_KEY = 'chatData_v2_contacts';
    const USER_PROFILE_KEY = 'userProfile_v4'; 
    const WALLET_DATA_KEY = 'walletData_v1';
    const WORLDBOOK_DATA_KEY = 'worldbookData_v2'; 
    const IOS_MODE_KEY = 'iosModeEnabled_v1';
    const MOMENTS_DATA_KEY = 'momentsData_v2'; // Bump version for image array
    const MOMENTS_PROFILE_KEY = 'momentsProfile_v1';

    let customDateText = ""; 
    let tempAvatarUrl = ""; 
    let currentWalletType = 'income';
    let currentChatContactId = null; 
    let tempRoleBgUrl = ""; 
    let currentWorldBookId = null; 
    let tempSelectedWorldBookId = null;
    let tempMomentImages = []; // Stores array of base64 images
    let currentCommentMomentId = null; 
    let currentDeleteMomentId = null; 
    let activeMsgIdForMenu = null; // Store msg id for active context menu
    let isMultiSelectMode = false;
    let selectedMsgIds = new Set();

    // --- Utility Functions ---
    const showToast = (message, duration = 2000) => { toast.innerHTML = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), duration); };
    function escapeHtml(text) { if(typeof text !== 'string') return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    function compressImage(file, maxSize, callback) {
        if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); let width = img.width; let height = img.height; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); callback(canvas.toDataURL('image/jpeg', 0.7)); }; img.src = e.target.result; }; reader.readAsDataURL(file);
    }
    
    // --- iOS Mode Function ---
    function applyIOSMode(enabled) {
      if (enabled) {
        document.body.classList.add('ios-mode-active');
      } else {
        document.body.classList.remove('ios-mode-active');
      }
      localStorage.setItem(IOS_MODE_KEY, enabled);
    }

    // --- Chat App Logic ---
    window.openChatApp = () => { body.classList.add('chat-active'); switchChatTab(0, 'Chat'); renderChatList(); };
    window.closeChatApp = () => { body.classList.remove('chat-active'); closeChatConversation(); };
    window.switchChatTab = (index, title) => {
        const titleEl = document.getElementById('chat-page-title');
        const addFriendIcon = document.getElementById('chat-header-add-friend-icon');
        const addMomentIcon = document.getElementById('chat-header-add-moment-icon');
        const headerEl = document.getElementById('chat-app-header-el');
        const backBtn = document.getElementById('chat-back-btn');
        const contentArea = document.getElementById('chat-content-area');
        
        document.querySelectorAll('.chat-tab-content').forEach((el, i) => el.classList.toggle('active', i === index));
        document.querySelectorAll('.chat-nav-item').forEach((el, i) => el.classList.toggle('active', i === index));
        
        headerEl.classList.remove('hidden');
        headerEl.style.backgroundColor = ''; 
        headerEl.style.boxShadow = ''; 
        
        backBtn.classList.remove('hidden');
        contentArea.classList.remove('me-mode');
        titleEl.innerText = title;
        titleEl.style.color = (index === 0 || index === 1 || index === 2) ? "#f5b3c9" : "#333";

        addFriendIcon.style.display = 'none';
        addMomentIcon.style.display = 'none';
        
        // Hide comment input if switching tabs
        closeCommentInput();

        if (index === 0) { // Chat
            addFriendIcon.style.display = 'block';
        } else if (index === 1) { // Contacts
            backBtn.classList.add('hidden');
            renderContactList(); 
        } else if (index === 2) { // Moments
            addMomentIcon.style.display = 'block';
            backBtn.classList.add('hidden');
            renderMomentsPage();
        } else if (index === 3) { // Me
            headerEl.classList.add('hidden'); 
            contentArea.classList.add('me-mode');
            loadUserProfile();
         }
    };
    
    // --- Moments (朋友圈) Functions ---
    function getMomentsProfile() {
        try {
            const p = localStorage.getItem(MOMENTS_PROFILE_KEY);
            const profile = p ? JSON.parse(p) : {};
            return {
                cover: profile.cover || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1000&q=80',
                avatar: profile.avatar || 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png'
            };
        } catch (e) {
            return {
                cover: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1000&q=80',
                avatar: 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png'
            };
        }
    }

    function saveMomentsProfile(profileData) {
        try {
            localStorage.setItem(MOMENTS_PROFILE_KEY, JSON.stringify(profileData));
        } catch (e) {
            showToast("保存朋友圈信息失败 (LocalStorage可能已满)");
        }
    }
    
    function getMomentsData() {
        try { return JSON.parse(localStorage.getItem(MOMENTS_DATA_KEY) || '[]'); } catch (e) { return []; }
    }

    function saveMomentsData(data) {
        localStorage.setItem(MOMENTS_DATA_KEY, JSON.stringify(data));
    }
    
    function formatTimestamp(ts) {
        const now = new Date();
        const postDate = new Date(ts);
        const diff = now - postDate;
        const diffMinutes = Math.floor(diff / 60000);
        const diffHours = Math.floor(diff / 3600000);
        const diffDays = Math.floor(diff / 86400000);

        if (diffMinutes < 1) return '刚刚';
        if (diffMinutes < 60) return `${diffMinutes}分钟前`;
        if (diffHours < 24 && now.getDate() === postDate.getDate()) return `${diffHours}小时前`;
        if (diffDays === 1 || (diffHours < 48 && now.getDate() - 1 === postDate.getDate())) return '昨天';
        return `${postDate.getMonth() + 1}月${postDate.getDate()}日`;
    }

    function renderMomentsPage() {
        const wrapper = document.getElementById('moments-page-wrapper');
        const userProfile = getUserProfile(); 
        const momentsProfile = getMomentsProfile(); 
        let moments = getMomentsData();
        
        let listHtml = '';
        if (moments.length > 0) {
            moments.sort((a,b) => b.timestamp - a.timestamp); 
            moments.forEach(moment => {
                const userHasLiked = moment.likes.includes(userProfile.qqId);
                const likeBtnText = userHasLiked ? '取消' : '赞';
                const likeIconUrl = userHasLiked ? "https://img.heliar.top/file/1770356886806_喜欢_like_3.png" : "https://img.heliar.top/file/1770353311894_喜欢_like_2.png";

                let likesHtml = '';
                if (moment.likes.length > 0) {
                    likesHtml = `<div class="moment-likes"><img src="https://img.heliar.top/file/1770356881218_喜欢_like_4.png" style="width:14px;height:14px;object-fit:contain;"> ${moment.likes.length}</div>`;
                }

                let commentsHtml = '';
                if (moment.comments.length > 0) {
                    commentsHtml = `<div class="moment-comments-list">` +
                        moment.comments.map(c => 
                            `<div class="moment-comment-item"><span class="user">${escapeHtml(c.user)}:</span> <span class="text">${escapeHtml(c.text)}</span></div>`
                        ).join('') +
                    `</div>`;
                }
                
                // NEW: Image Grid Render Logic
                let imageGridHtml = '';
                let images = moment.images || (moment.imageUrl ? [moment.imageUrl] : []); // Compatibility
                
                if (images.length > 0) {
                    let gridClass = 'single-img';
                    if (images.length === 1) gridClass = 'single-img';
                    else if (images.length === 2 || images.length === 4) gridClass = `grid-${images.length}`; // 2 col
                    else gridClass = `grid-${images.length}`; // 3 col default logic handled in CSS usually, but here distinct classes help
                    
                    imageGridHtml = `<div class="moments-img-grid ${gridClass}">` + 
                        images.map(url => `<img src="${url}" class="moment-grid-img" onclick="event.stopPropagation()">`).join('') +
                    `</div>`;
                }
                
                // Delete icon added here
                const deleteIconHtml = `<img src="https://img.heliar.top/file/1770357709135_删除_delete.png" class="moment-delete-btn" onclick="confirmDeleteMoment(${moment.id})">`;

                listHtml += `
                    <div class="moment-item" id="moment-${moment.id}">
                        <img src="${userProfile.avatar}" class="moment-item-avatar" alt="avatar">
                        <div class="moment-item-content">
                            <div class="moment-item-nickname">${escapeHtml(userProfile.nickname)}</div>
                            ${moment.text ? `<div class="moment-item-text">${escapeHtml(moment.text)}</div>` : ''}
                            ${imageGridHtml}
                            <div class="moment-item-meta">
                                <div class="moment-item-meta-left">
                                    <span class="moment-timestamp">${formatTimestamp(moment.timestamp)}</span>
                                    ${deleteIconHtml}
                                </div>
                                <div class="moment-actions-btn" onclick="toggleActionsPopup(${moment.id}, event)">
                                    ··
                                    <div class="moment-actions-popup">
                                        <div class="moment-popup-btn" onclick="toggleLike(${moment.id})"><img src="${likeIconUrl}"> ${likeBtnText}</div>
                                        <div class="moment-popup-btn" onclick="openCommentInput(${moment.id})"><img src="https://img.heliar.top/file/1770353307524_评论_comment.png"> 评论</div>
                                    </div>
                                </div>
                            </div>
                            ${(likesHtml || commentsHtml) ? `<div class="moment-feedback">${likesHtml}${commentsHtml}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            listHtml = '<div class="moments-empty-placeholder">还没有动态，点击右上角相机发布第一条吧！</div>';
        }
        
        wrapper.innerHTML = `
            <div class="moments-header">
                <div class="moments-cover-img" style="background-image: url(${momentsProfile.cover})" onclick="editMomentsCover()"></div>
                <div class="moments-user-info">
                    <span class="moments-user-nickname">${escapeHtml(userProfile.nickname)}</span>
                    <img src="${momentsProfile.avatar}" class="moments-user-avatar" alt="avatar" onclick="editMomentsAvatar()">
                </div>
            </div>
            <div id="moments-list">
                ${listHtml}
            </div>
        `;
    }
    
    // NEW: Moment Deletion Logic
    window.confirmDeleteMoment = (momentId) => {
        currentDeleteMomentId = momentId;
        document.getElementById('delete-moment-confirm-modal').classList.add('active');
    };
    
    window.executeDeleteMoment = () => {
        if (!currentDeleteMomentId) return;
        let moments = getMomentsData();
        const updatedMoments = moments.filter(m => m.id !== currentDeleteMomentId);
        saveMomentsData(updatedMoments);
        closeDeleteModal('delete-moment-confirm-modal');
        renderMomentsPage();
        showToast("动态已删除");
        currentDeleteMomentId = null;
    };


    window.editMomentsAvatar = () => {
        const p = getMomentsProfile();
        const newUrl = prompt("请输入朋友圈头像图片链接:", p.avatar);
        if (newUrl && newUrl.trim() !== '') {
            p.avatar = newUrl.trim();
            saveMomentsProfile(p);
            renderMomentsPage(); 
            showToast("朋友圈头像已更新");
        }
    };
    
    window.editMomentsCover = () => {
        const p = getMomentsProfile();
        const newUrl = prompt("请输入朋友圈背景图片链接:", p.cover);
        if (newUrl && newUrl.trim() !== '') {
            p.cover = newUrl.trim();
            saveMomentsProfile(p);
            renderMomentsPage();
            showToast("朋友圈背景已更新");
        }
    };

    window.toggleActionsPopup = (momentId, event) => {
        event.stopPropagation();
        const allPopups = document.querySelectorAll('.moment-actions-popup');
        allPopups.forEach(p => p.classList.remove('active'));
        const popup = document.querySelector(`#moment-${momentId} .moment-actions-popup`);
        if (popup) {
            popup.classList.toggle('active');
        }
    };
    document.addEventListener('click', (e) => { 
        // Close popup if clicking elsewhere
        document.querySelectorAll('.moment-actions-popup').forEach(p => p.classList.remove('active'));
        
        // Close bubble menu if clicking elsewhere
        const bubbleMenu = document.querySelector('.bubble-context-menu');
        if (bubbleMenu && activeMsgIdForMenu && !e.target.closest('.bubble-context-menu')) {
            bubbleMenu.remove();
            activeMsgIdForMenu = null;
        }
    });

    // NEW: Action Sheet Logic
    window.openMomentsActionSheet = () => {
        document.getElementById('moments-action-sheet-overlay').classList.add('active');
    };
    
    window.closeMomentsActionSheet = () => {
        document.getElementById('moments-action-sheet-overlay').classList.remove('active');
    };
    
    window.handleMomentAction = (action) => {
        closeMomentsActionSheet();
        if (action === 'shoot' || action === 'album') {
            setTimeout(() => {
                openAddMomentModal();
            }, 300);
        }
    };

    window.openAddMomentModal = () => {
        document.getElementById('add-moment-text').value = '';
        tempMomentImages = [];
        renderAddMomentGrid();
        document.getElementById('add-moment-modal').classList.add('active');
    };
    window.closeAddMomentModal = () => {
        document.getElementById('add-moment-modal').classList.remove('active');
    };

    window.triggerMomentImageUpload = () => {
        document.getElementById('input-moment-image').click();
    };

    window.handleMomentImageUpload = (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        // Process multiple files
        let processedCount = 0;
        files.forEach(file => {
            if (tempMomentImages.length >= 9) return;
            compressImage(file, 600, (base64) => {
                tempMomentImages.push(base64);
                processedCount++;
                if (processedCount === files.length || tempMomentImages.length === 9) {
                     renderAddMomentGrid();
                }
            });
        });
        // Reset input
        event.target.value = '';
    };
    
    function renderAddMomentGrid() {
        const grid = document.getElementById('add-moment-grid');
        // Clear existing preview images but keep upload button
        const uploadBtn = grid.querySelector('.add-moment-image-upload');
        grid.innerHTML = '';
        
        tempMomentImages.forEach((src, index) => {
            const cell = document.createElement('div');
            cell.className = 'add-moment-img-cell';
            cell.innerHTML = `
                <img src="${src}">
                <div class="add-moment-remove-img" onclick="removeMomentImage(${index})">✕</div>
            `;
            grid.appendChild(cell);
        });
        
        if (tempMomentImages.length < 9) {
            grid.appendChild(uploadBtn);
        }
    }
    
    window.removeMomentImage = (index) => {
        tempMomentImages.splice(index, 1);
        renderAddMomentGrid();
    };

    window.saveNewMoment = () => {
        const text = document.getElementById('add-moment-text').value.trim();
        const images = [...tempMomentImages]; // Copy array
        if (!text && images.length === 0) {
            showToast("内容不能为空");
            return;
        }
        const profile = getUserProfile();
        const newMoment = {
            id: Date.now(),
            authorId: profile.qqId,
            timestamp: Date.now(),
            text: text,
            imageUrl: null, // Legacy field
            images: images, // New field
            likes: [],
            comments: []
        };
        let moments = getMomentsData();
        moments.unshift(newMoment);
        saveMomentsData(moments);
        showToast("发布成功");
        renderMomentsPage();
        closeAddMomentModal();
    };
    
    window.toggleLike = (momentId) => {
        let moments = getMomentsData();
        const momentIndex = moments.findIndex(m => m.id === momentId);
        if (momentIndex === -1) return;
        
        const profile = getUserProfile();
        const myId = profile.qqId;
        const likeIndex = moments[momentIndex].likes.indexOf(myId);

        if (likeIndex > -1) {
            moments[momentIndex].likes.splice(likeIndex, 1);
        } else {
            moments[momentIndex].likes.push(myId);
        }
        
        saveMomentsData(moments);
        renderMomentsPage();
    };

    // --- NEW Comment Logic (Modal) ---
    window.openCommentInput = (momentId) => {
        currentCommentMomentId = momentId;
        const modal = document.getElementById('moments-comment-modal');
        const overlay = document.getElementById('moments-comment-overlay');
        const inputField = document.getElementById('moments-comment-input');
        
        inputField.value = ''; // Clear previous text
        modal.classList.add('active');
        overlay.classList.add('active');
        
        // Use timeout to ensure the element is visible before focusing
        setTimeout(() => {
            inputField.focus();
        }, 100);
    };

    window.closeCommentInput = () => {
        document.getElementById('moments-comment-modal').classList.remove('active');
        document.getElementById('moments-comment-overlay').classList.remove('active');
        document.getElementById('moments-comment-input').blur();
        currentCommentMomentId = null;
    };

    window.handleCommentKey = (event) => {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent form submission if any
            submitComment();
        }
    };

    window.submitComment = () => {
        if (!currentCommentMomentId) return;
        
        const inputField = document.getElementById('moments-comment-input');
        const commentText = inputField.value.trim();
        if (!commentText) return;

        let moments = getMomentsData();
        const momentIndex = moments.findIndex(m => m.id === currentCommentMomentId);
        if (momentIndex === -1) return;

        const profile = getUserProfile();
        const newComment = {
            user: profile.nickname,
            userId: profile.qqId,
            text: commentText
        };
        
        moments[momentIndex].comments.push(newComment);
        saveMomentsData(moments);
        
        closeCommentInput();
        renderMomentsPage();
    };


    // --- World Book App Logic ---
    window.openWorldBookApp = () => { body.classList.add('worldbook-active'); renderWorldBooks(); };
    window.closeWorldBookApp = () => { body.classList.remove('worldbook-active'); closeWorldBookDetail(); closeWorldBookColorSettings(); };
    window.openWorldBookAddModal = () => { document.getElementById('wb-title-input').value = ""; document.getElementById('wb-dynamic-entries').innerHTML = ''; addWorldBookEntryRow(); document.getElementById('worldbook-add-modal').classList.add('active'); };
    window.closeWorldBookAddModal = () => { document.getElementById('worldbook-add-modal').classList.remove('active'); };
    window.addWorldBookEntryRow = () => { const container = document.getElementById('wb-dynamic-entries'); const row = document.createElement('div'); row.className = 'wb-entry-row wb-dynamic-row'; row.innerHTML = `<input type="text" class="wb-entry-input key" placeholder="名称（可选）"><textarea class="wb-entry-input val" placeholder="世界书内容"></textarea>`; container.appendChild(row); };
    window.saveWorldBook = () => { const title = document.getElementById('wb-title-input').value.trim(); if(!title) { showToast("请输入世界书名"); return; } const rows = document.querySelectorAll('.wb-dynamic-row'); const entries = []; let hasContent = false; rows.forEach(row => { const key = row.querySelector('.key').value.trim(); const val = row.querySelector('.val').value.trim(); if(val) { entries.push({ key: key, content: val }); hasContent = true; } }); if (!hasContent) { showToast("请至少输入一条世界书内容"); return; } const newBook = { id: Date.now(), title: title, entries: entries, coverColor: '#EAEAEA' }; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) {} books.push(newBook); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("世界书已保存"); closeWorldBookAddModal(); renderWorldBooks(); };
    window.renderWorldBooks = () => { const container = document.getElementById('worldbook-list'); container.innerHTML = ''; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) { books = []; } books.sort((a,b) => b.id - a.id).forEach(book => { const item = document.createElement('div'); item.className = 'wb-book-item'; item.onclick = () => viewWorldBook(book.id); item.innerHTML = `<div class="wb-book-cover"><div class="wb-book-name">${escapeHtml(book.title)}</div></div>`; const coverEl = item.querySelector('.wb-book-cover'); if (book.coverColor) { coverEl.style.background = book.coverColor; } container.appendChild(item); }); };
    window.viewWorldBook = (id) => { currentWorldBookId = id; renderWorldBookDetailView(); document.getElementById('worldbook-detail-modal').classList.add('active'); };
    function renderWorldBookDetailView() { if (!currentWorldBookId) return; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) {} const book = books.find(b => b.id === currentWorldBookId); if(!book) { closeWorldBookDetail(); return; } document.getElementById('wb-detail-title-text').innerText = book.title; const contentArea = document.getElementById('wb-detail-content-area'); contentArea.innerHTML = ''; book.entries.forEach((entry, index) => { const div = document.createElement('div'); div.className = 'wb-detail-item'; div.id = `wb-entry-item-${index}`; div.innerHTML = `<div class="wb-detail-item-content">${entry.key ? `<div class="wb-detail-key">${escapeHtml(entry.key)}</div>` : ''}<div class="wb-detail-val">${escapeHtml(entry.content)}</div></div><div class="wb-detail-item-actions"><button onclick="editWorldBookEntry(${index})">修改</button><button onclick="deleteWorldBookEntry(${index})">删除</button></div>`; contentArea.appendChild(div); }); }
    window.editWorldBookEntry = (index) => { const itemEl = document.getElementById(`wb-entry-item-${index}`); if (!itemEl) return; const books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const book = books.find(b => b.id === currentWorldBookId); if (!book || !book.entries[index]) return; const entry = book.entries[index]; itemEl.innerHTML = `<div class="edit-form"><input type="text" class="wb-entry-input key" placeholder="名称（可选）" value="${escapeHtml(entry.key)}"><textarea class="wb-entry-input val" placeholder="世界书内容">${escapeHtml(entry.content)}</textarea></div><div class="wb-detail-item-actions"><button class="save" onclick="saveWorldBookEntry(${index})">保存</button><button onclick="renderWorldBookDetailView()">取消</button></div>`; };
    window.saveWorldBookEntry = (index) => { const itemEl = document.getElementById(`wb-entry-item-${index}`); const newKey = itemEl.querySelector('.key').value.trim(); const newVal = itemEl.querySelector('.val').value.trim(); if (!newVal) { showToast("内容不能为空"); return; } let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const bookIndex = books.findIndex(b => b.id === currentWorldBookId); if (bookIndex !== -1 && books[bookIndex].entries[index]) { books[bookIndex].entries[index] = { key: newKey, content: newVal }; localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("已保存"); renderWorldBookDetailView(); } };
    window.deleteWorldBookEntry = (index) => { if (!confirm("确定要删除这个条目吗？")) return; let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const bookIndex = books.findIndex(b => b.id === currentWorldBookId); if (bookIndex !== -1 && books[bookIndex].entries[index]) { books[bookIndex].entries.splice(index, 1); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("已删除"); renderWorldBookDetailView(); } };
    window.closeWorldBookDetail = () => { document.getElementById('worldbook-detail-modal').classList.remove('active'); currentWorldBookId = null; };
    window.deleteCurrentWorldBook = () => { if(!currentWorldBookId) return; if(confirm("确定要删除这本世界书吗？此操作不可撤销。")) { let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); books = books.filter(b => b.id !== currentWorldBookId); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); closeWorldBookDetail(); renderWorldBooks(); showToast("世界书已删除"); } };
    window.openWorldBookColorSettings = () => { const page = document.getElementById('worldbook-color-page'); const container = document.getElementById('wb-color-list'); container.innerHTML = ''; let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); if (books.length === 0) { container.innerHTML = '<p style="text-align:center; color:#999;">还没有创建世界书哦</p>'; } else { books.forEach(book => { const item = document.createElement('div'); item.className = 'wb-color-item'; item.innerHTML = `<span class="wb-color-item-name">${escapeHtml(book.title)}</span><input type="color" class="wb-color-input" data-book-id="${book.id}" value="${book.coverColor || '#EAEAEA'}">`; container.appendChild(item); }); } page.classList.add('active'); };
    window.closeWorldBookColorSettings = () => { document.getElementById('worldbook-color-page').classList.remove('active'); };
    window.saveWorldBookColors = () => { let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const colorInputs = document.querySelectorAll('.wb-color-input'); colorInputs.forEach(input => { const bookId = parseInt(input.dataset.bookId); const newColor = input.value; const bookIndex = books.findIndex(b => b.id === bookId); if (bookIndex !== -1) { books[bookIndex].coverColor = newColor; } }); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("封面颜色已保存"); closeWorldBookColorSettings(); renderWorldBooks(); };


    // --- Wallet App Logic ---
    window.openWalletApp = () => { body.classList.add('wallet-active'); loadWalletUI(); };
    window.closeWalletApp = () => { body.classList.remove('wallet-active'); };
    function getWalletData() { try { const data = localStorage.getItem(WALLET_DATA_KEY); return data ? JSON.parse(data) : { balance: 0.00, transactions: [] }; } catch (e) { return { balance: 0.00, transactions: [] }; } }
    function saveWalletData(data) { localStorage.setItem(WALLET_DATA_KEY, JSON.stringify(data)); }
    function loadWalletUI() { const profile = getUserProfile(); document.getElementById('wallet-avatar').src = profile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; document.getElementById('wallet-nickname').innerText = profile.nickname || 'User'; const data = getWalletData(); document.getElementById('wallet-total-balance').innerText = parseFloat(data.balance).toFixed(2); const now = new Date(); const currentMonthStr = `${now.getFullYear()}-${now.getMonth() + 1}`; document.getElementById('wallet-current-month').innerText = `${now.getMonth() + 1}月`; let monthIncome = 0; let monthExpense = 0; let monthTransactions = []; data.transactions.forEach(t => { const tDate = new Date(t.timestamp); const tMonthStr = `${tDate.getFullYear()}-${tDate.getMonth() + 1}`; if (tMonthStr === currentMonthStr) { monthTransactions.push(t); if (t.type === 'income') monthIncome += parseFloat(t.amount); else monthExpense += parseFloat(t.amount); } }); document.getElementById('wallet-month-income').innerText = monthIncome.toFixed(2); document.getElementById('wallet-month-expense').innerText = monthExpense.toFixed(2); const listContainer = document.getElementById('wallet-transaction-list'); listContainer.innerHTML = ''; if (monthTransactions.length === 0) { listContainer.innerHTML = '<div class="wallet-empty">本月暂无收支记录</div>'; } else { monthTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(t => { const item = document.createElement('div'); item.className = 'wallet-item'; const dateObj = new Date(t.timestamp); const dateStr = `${dateObj.getMonth()+1}-${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`; let icon = t.type === 'income' ? '🧧' : '💰'; if (t.desc.includes('餐饮') || t.desc.includes('吃')) icon = '🍔'; else if (t.desc.includes('交通') || t.desc.includes('车')) icon = '🚗'; else if (t.desc.includes('购物') || t.desc.includes('买')) icon = '🛍️'; item.innerHTML = `<div class="wallet-item-icon">${icon}</div><div class="wallet-item-info"><div class="wallet-item-cat">${escapeHtml(t.desc || (t.type === 'income' ? '收入' : '支出'))}</div><div class="wallet-item-date">${dateStr}</div></div><div class="wallet-item-amount ${t.type === 'income' ? 'in' : 'out'}">${t.type === 'income' ? '+' : '-'}${parseFloat(t.amount).toFixed(2)}</div>`; listContainer.appendChild(item); }); } }
    window.openWalletModal = (type) => { currentWalletType = type; setWalletType(type); document.getElementById('wallet-amount-input').value = ''; document.getElementById('wallet-desc-input').value = ''; document.getElementById('wallet-add-modal').classList.add('active'); };
    window.closeWalletModal = () => { document.getElementById('wallet-add-modal').classList.remove('active'); };
    window.setWalletType = (type) => { currentWalletType = type; const btnIn = document.getElementById('w-btn-in'); const btnOut = document.getElementById('w-btn-out'); if (type === 'income') { btnIn.classList.add('active', 'in'); btnOut.className = 'wallet-type-btn'; } else { btnOut.classList.add('active', 'out'); btnIn.className = 'wallet-type-btn'; } };
    window.saveTransaction = () => { const amountStr = document.getElementById('wallet-amount-input').value; const desc = document.getElementById('wallet-desc-input').value.trim(); const amount = parseFloat(amountStr); if (isNaN(amount) || amount <= 0) { showToast('请输入有效金额'); return; } const data = getWalletData(); const transaction = { id: Date.now(), type: currentWalletType, amount: amount, desc: desc, timestamp: Date.now() }; data.transactions.push(transaction); if (currentWalletType === 'income') data.balance = parseFloat(data.balance) + amount; else data.balance = parseFloat(data.balance) - amount; saveWalletData(data); closeWalletModal(); loadWalletUI(); showToast('记账成功'); };

    // --- Friend Adding & Chat List Logic ---
    window.openAddFriendModal = () => { tempAvatarUrl = ""; document.getElementById('new-friend-name').value = ""; document.getElementById('new-friend-alias').value = ""; document.getElementById('new-friend-avatar-url').value = ""; const preview = document.getElementById('new-friend-avatar-preview'); preview.style.display = 'none'; preview.src = ""; document.getElementById('avatar-placeholder-icon').style.display = 'block'; document.getElementById('add-friend-modal').classList.add('active'); };
    window.closeAddFriendModal = () => { document.getElementById('add-friend-modal').classList.remove('active'); };
    window.triggerAvatarUpload = () => { document.getElementById('input-friend-avatar').click(); };
    window.handleAvatarUrlInput = (input) => { const url = input.value.trim(); const imgEl = document.getElementById('new-friend-avatar-preview'); if (url) { tempAvatarUrl = url; imgEl.src = url; imgEl.style.display = 'block'; document.getElementById('avatar-placeholder-icon').style.display = 'none'; } else { tempAvatarUrl = ""; imgEl.style.display = 'none'; document.getElementById('avatar-placeholder-icon').style.display = 'block'; } };
    window.handleFriendAvatarUpload = (event) => { compressImage(event.target.files[0], 200, (base64) => { tempAvatarUrl = base64; document.getElementById('new-friend-avatar-url').value = ""; const imgEl = document.getElementById('new-friend-avatar-preview'); imgEl.src = tempAvatarUrl; imgEl.style.display = 'block'; document.getElementById('avatar-placeholder-icon').style.display = 'none'; }); };
    window.saveNewFriend = () => { const name = document.getElementById('new-friend-name').value.trim(); const alias = document.getElementById('new-friend-alias').value.trim(); if (!name) { showToast("请输入姓名"); return; } if (!tempAvatarUrl) { showToast("请上传头像或输入URL"); return; } let contacts = []; try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } if (contacts.find(c => c.name === name || (alias && c.alias === alias))) { showToast("该好友已存在"); return; } const newContact = { id: Date.now(), name: name, alias: alias, avatar: tempAvatarUrl, lastMsg: "点击开始聊天", timestamp: Date.now(), signature: "", backgroundImage: "", isPinned: false, worldbookId: null, timePerceptionEnabled: false }; contacts.unshift(newContact); try { localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); showToast("添加成功！"); closeAddFriendModal(); renderChatList(); renderContactList(); } catch (e) { console.error("Error saving contact:", e); showToast("保存失败，图片可能过大"); } };

    window.renderChatList = () => { const container = document.getElementById('chat-list-container'); let contacts = []; try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } if (contacts.length === 0) { container.innerHTML = '<div class="chat-placeholder-text">没有新信息</div>'; return; } container.innerHTML = ''; contacts.sort((a, b) => b.timestamp - a.timestamp).forEach(contact => { const displayName = contact.alias || contact.name; const item = document.createElement('div'); item.className = 'chat-list-item'; item.onclick = (e) => { e.stopPropagation(); openChatWindow(contact.id); }; item.innerHTML = `<img src="${contact.avatar}" class="chat-list-avatar" alt="avatar" onerror="this.src='https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'"><div class="chat-list-info"><div class="chat-list-name">${escapeHtml(displayName)}</div><div class="chat-list-msg">${escapeHtml(contact.lastMsg || '点击开始聊天')}</div></div>`; container.appendChild(item); }); };
    
    function getSortLetter(str) { if (!str) return '#'; const firstChar = str.charAt(0); if (/[a-zA-Z]/.test(firstChar)) return firstChar.toUpperCase(); const pinyin = "ABCDEFGHJKLMNOPQRSTWXYZ"; const zh = "阿芭擦搭蛾发噶哈击喀垃妈拿哦啪期然撒塌挖昔压匝"; if (firstChar.localeCompare('阿', 'zh-CN') < 0) return '#'; if (firstChar.localeCompare('匝', 'zh-CN') >= 0) return 'Z'; for (let i = 0; i < zh.length; i++) { if (firstChar.localeCompare(zh[i], 'zh-CN') >= 0 && firstChar.localeCompare(zh[i+1], 'zh-CN') < 0) return pinyin[i]; } return '#'; }
    window.renderContactList = () => { const container = document.getElementById('contact-list-container'); const indexBar = document.getElementById('alpha-index-bar'); let contacts = []; try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch(e) { contacts = []; } if (contacts.length === 0) { container.innerHTML = '<div class="chat-placeholder-text">通讯录为空</div>'; indexBar.innerHTML = ''; return; } container.innerHTML = ''; indexBar.innerHTML = ''; const groups = { '🔝': [], ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('').reduce((acc, l) => ({...acc, [l]: []}), {}) }; contacts.forEach(c => { if (c.isPinned) { groups['🔝'].push(c); } else { const letter = getSortLetter(c.alias || c.name); (groups[letter] || groups['#']).push(c); } }); const activeLetters = []; const renderGroup = (key, title) => { const groupContacts = groups[key]; if (groupContacts.length > 0) { groupContacts.sort((a, b) => (a.alias||a.name).localeCompare(b.alias||b.name, 'zh-CN')); const titleDiv = document.createElement('div'); titleDiv.className = 'contact-section-title'; titleDiv.id = `group-${key}`; titleDiv.innerText = title; container.appendChild(titleDiv); activeLetters.push({ key: key, id: `group-${key}` }); groupContacts.forEach(contact => container.appendChild(createContactItem(contact))); } }; renderGroup('🔝', '🔝'); 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('').forEach(key => renderGroup(key, key)); 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => { const exists = activeLetters.find(x => x.key === letter); const item = document.createElement('div'); item.className = 'alpha-index-item'; item.innerText = letter; if (exists) { item.onclick = (e) => { e.stopPropagation(); document.getElementById(exists.id).scrollIntoView({ behavior: 'smooth' }); }; item.style.color = '#555'; } else { item.style.color = '#eee'; item.onclick = (e) => e.stopPropagation(); } indexBar.appendChild(item); }); };
    function createContactItem(contact) { const item = document.createElement('div'); item.className = 'contact-item'; if(contact.isPinned) item.classList.add('pinned'); const displayName = contact.alias || contact.name; const signature = contact.signature ? escapeHtml(contact.signature) : ''; item.innerHTML = `<img src="${contact.avatar}" class="contact-avatar"><div class="chat-list-info"><div class="contact-name">${escapeHtml(displayName)}</div><div class="contact-signature">${signature}</div></div><div class="pinned-tag">★</div>`; item.onclick = () => { currentChatContactId = contact.id; openRoleSettings(); }; let pressTimer; item.addEventListener('touchstart', (e) => { pressTimer = setTimeout(() => { toggleContactPin(contact.id); }, 600); }); item.addEventListener('touchend', () => clearTimeout(pressTimer)); item.addEventListener('touchmove', () => clearTimeout(pressTimer)); return item; }
    window.toggleContactPin = (id) => { let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const idx = contacts.findIndex(c => c.id === id); if (idx !== -1) { contacts[idx].isPinned = !contacts[idx].isPinned; localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); renderContactList(); showToast(contacts[idx].isPinned ? "已置顶" : "已取消置顶"); } };

    // --- Role Chat Conversation Logic (Updated) ---
    window.openChatWindow = (contactId) => { 
        currentChatContactId = contactId; 
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contact = contacts.find(c => c.id === contactId); 
        if (!contact) return; 
        document.getElementById('chat-conv-title').innerText = contact.alias || contact.name; 
        document.getElementById('chat-conv-signature').innerText = contact.signature || ''; 
        const view = document.getElementById('chat-conversation-view'); 
        view.style.backgroundImage = contact.backgroundImage ? `url(${contact.backgroundImage})` : ''; 
        let styleTag = document.getElementById('custom-chat-style'); 
        if (!styleTag) { styleTag = document.createElement('style'); styleTag.id = 'custom-chat-style'; document.head.appendChild(styleTag); } 
        styleTag.innerHTML = contact.customCss || ''; 
        
        // Reset Multiselect
        isMultiSelectMode = false;
        selectedMsgIds.clear();
        document.getElementById('chat-multiselect-footer').classList.remove('active');
        document.getElementById('chat-conv-messages').classList.remove('multi-select-active');
        
        view.classList.add('active'); 
        renderConversationMessages(); 
    };
    
    window.closeChatConversation = () => { document.getElementById('chat-conversation-view').classList.remove('active'); currentChatContactId = null; const styleTag = document.getElementById('custom-chat-style'); if (styleTag) styleTag.innerHTML = ''; renderChatList(); };
    function getMessagesKey(contactId) { return `chat_msgs_${contactId}`; }
    
    // Time Formatter
    function formatChatTime(ts) {
        const now = new Date();
        const date = new Date(ts);
        const diff = now - date;
        const diffHours = diff / 3600000;
        
        const pad = n => n.toString().padStart(2, '0');
        const timeStr = `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        const dateStr = `${date.getMonth() + 1}月${date.getDate()}日`;
        
        // Same day
        if (now.toDateString() === date.toDateString()) {
            return timeStr;
        }
        
        // Yesterday check (Simple 24-48h logic based on prompt, but usually calendar day is preferred)
        // Prompt says: "Over 24h up to 48h displays Yesterday HH:MM"
        if (diffHours >= 24 && diffHours < 48) {
             return `昨天 ${timeStr}`;
        }
        
        // Over 1 month (approx 30 days)
        const oneMonth = 30 * 24 * 60 * 60 * 1000;
        if (diff >= oneMonth) {
            const weeks = ['日', '一', '二', '三', '四', '五', '六'];
            return `${dateStr} 星期${weeks[date.getDay()]}`;
        }
        
        // Gap (48h to 1 month): Fallback standard M月D日 HH:MM
        return `${dateStr} ${timeStr}`;
    }

    window.renderConversationMessages = () => { 
        if (!currentChatContactId) return; 
        const container = document.getElementById('chat-conv-messages'); 
        const key = getMessagesKey(currentChatContactId); 
        let messages = []; try { messages = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) {} 
        container.innerHTML = ''; 
        
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contact = contacts.find(c => c.id === currentChatContactId); 
        const themAvatar = contact ? contact.avatar : ''; 
        const globalProfile = getUserProfile(); 
        const meAvatar = (contact && contact.userAvatar) ? contact.userAvatar : (globalProfile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'); 

        let lastMsgTime = 0;

        messages.forEach(msg => { 
            // 1. Time Stamp Logic
            if (msg.timestamp - lastMsgTime > 5 * 60 * 1000) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'chat-time-stamp';
                timeDiv.innerText = formatChatTime(msg.timestamp);
                container.appendChild(timeDiv);
                lastMsgTime = msg.timestamp;
            }

            // 2. Recall Logic
            if (msg.type === 'recalled') {
                 const tipDiv = document.createElement('div');
                 tipDiv.className = 'msg-recalled-tip';
                 tipDiv.innerText = '你撤回了一条消息';
                 container.appendChild(tipDiv);
                 return; 
            }

            // 3. Render Message Bubble
            const row = document.createElement('div'); 
            row.className = `msg-bubble-row ${msg.type === 'sent' ? 'me' : 'them'}`; 
            
            // Multiselect Checkbox
            const checkbox = document.createElement('div');
            checkbox.className = `chat-checkbox ${selectedMsgIds.has(msg.id) ? 'checked' : ''}`;
            checkbox.onclick = (e) => { e.stopPropagation(); toggleMsgSelection(msg.id); };
            
            const avatarHtml = `<img src="${msg.type === 'sent' ? meAvatar : themAvatar}" class="msg-bubble-avatar">`; 
            const contentHtml = `<div class="msg-bubble-content">${escapeHtml(msg.text)}</div>`; 
            
            if (isMultiSelectMode) {
                // In select mode, clicking row selects it
                row.onclick = (e) => { e.stopPropagation(); toggleMsgSelection(msg.id); };
            } else {
                // Normal mode, double click menu
                row.ondblclick = (e) => { showBubbleMenu(e, msg.id, msg.text); };
            }

            row.innerHTML = msg.type === 'sent' ? contentHtml + avatarHtml : avatarHtml + contentHtml; 
            row.prepend(checkbox);
            container.appendChild(row); 
        }); 
        
        // Toggle multiselect class on container
        if (isMultiSelectMode) container.classList.add('multi-select-active');
        else container.classList.remove('multi-select-active');
        
        if (!isMultiSelectMode) container.scrollTop = container.scrollHeight; 
    };
    
    // Bubble Context Menu Logic
    window.showBubbleMenu = (event, msgId, text) => {
        event.stopPropagation();
        // Remove existing menu
        const existing = document.querySelector('.bubble-context-menu');
        if (existing) existing.remove();
        
        activeMsgIdForMenu = msgId;
        
        const menu = document.createElement('div');
        menu.className = 'bubble-context-menu active';
        menu.innerHTML = `
            <div class="bubble-menu-item" onclick="handleEditMsg('${msgId}', '${escapeHtml(text)}')">编辑</div>
            <div class="bubble-menu-item" onclick="handleDeleteMsg('${msgId}')">删除</div>
            <div class="bubble-menu-item" onclick="handleRecallMsg('${msgId}')">撤回</div>
            <div class="bubble-menu-item" onclick="handleMultiSelectMode()">多选</div>
        `;
        
        // Position menu above bubble content
        const bubbleContent = event.currentTarget.querySelector('.msg-bubble-content');
        const rect = bubbleContent.getBoundingClientRect();
        
        menu.style.top = `${rect.top + window.scrollY}px`;
        menu.style.left = `${rect.left + rect.width / 2}px`;
        
        document.body.appendChild(menu);
    };

    window.handleEditMsg = (msgId, oldText) => {
        const newText = prompt("修改消息:", oldText); // In a real app, prefer modal, simplified here
        if (newText !== null && newText.trim() !== "") {
            updateMessageInStorage(msgId, (msg) => { msg.text = newText.trim(); });
            renderConversationMessages();
        }
        closeBubbleMenu();
    };

    window.handleDeleteMsg = (msgId) => {
        deleteMessageFromStorage(msgId);
        renderConversationMessages();
        closeBubbleMenu();
    };

    window.handleRecallMsg = (msgId) => {
        updateMessageInStorage(msgId, (msg) => { msg.type = 'recalled'; });
        renderConversationMessages();
        closeBubbleMenu();
    };

    window.closeBubbleMenu = () => {
        const menu = document.querySelector('.bubble-context-menu');
        if (menu) menu.remove();
        activeMsgIdForMenu = null;
    };
    
    // Storage Helpers
    function updateMessageInStorage(msgId, updateFn) {
        if (!currentChatContactId) return;
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const idx = messages.findIndex(m => m.id === msgId || m.id === parseFloat(msgId)); // ID might be string/number mix
        if (idx !== -1) {
            updateFn(messages[idx]);
            localStorage.setItem(key, JSON.stringify(messages));
        }
    }

    function deleteMessageFromStorage(msgId) {
        if (!currentChatContactId) return;
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        messages = messages.filter(m => m.id !== msgId && m.id !== parseFloat(msgId));
        localStorage.setItem(key, JSON.stringify(messages));
    }

    // Multiselect Logic
    window.handleMultiSelectMode = () => {
        isMultiSelectMode = true;
        selectedMsgIds.clear();
        document.getElementById('chat-multiselect-footer').classList.add('active');
        closeBubbleMenu();
        renderConversationMessages();
    };
    
    window.toggleMsgSelection = (msgId) => {
        if (!isMultiSelectMode) return;
        if (selectedMsgIds.has(msgId)) selectedMsgIds.delete(msgId);
        else selectedMsgIds.add(msgId);
        renderConversationMessages(); // Re-render to update checkboxes state
    };
    
    window.executeBatchDelete = () => {
        if (selectedMsgIds.size === 0) {
            // Exit mode if nothing selected
            isMultiSelectMode = false;
            document.getElementById('chat-multiselect-footer').classList.remove('active');
            renderConversationMessages();
            return;
        }
        
        if (!confirm(`确定删除选中的 ${selectedMsgIds.size} 条消息吗？`)) return;
        
        if (!currentChatContactId) return;
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        messages = messages.filter(m => !selectedMsgIds.has(m.id));
        localStorage.setItem(key, JSON.stringify(messages));
        
        isMultiSelectMode = false;
        selectedMsgIds.clear();
        document.getElementById('chat-multiselect-footer').classList.remove('active');
        renderConversationMessages();
        showToast("已批量删除");
    };

    // Handle Enter Key for sending messages
    window.handleChatInputKey = (event) => {
        if (event.key === 'Enter') {
            sendConversationMessage();
        }
    };

    // MODIFIED: Only sends user message, does NOT trigger AI automatically
    window.sendConversationMessage = () => { 
        if (!currentChatContactId) return; 
        const input = document.getElementById('chat-conv-input'); 
        const text = input.value.trim(); 
        if (!text) return; 
        
        const key = getMessagesKey(currentChatContactId); 
        let messages = JSON.parse(localStorage.getItem(key) || '[]'); 
        messages.push({ id: Date.now(), text: text, type: 'sent', timestamp: Date.now() }); 
        localStorage.setItem(key, JSON.stringify(messages)); 
        
        let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contactIndex = contacts.findIndex(c => c.id === currentChatContactId); 
        if (contactIndex !== -1) { 
            contacts[contactIndex].lastMsg = text; 
            contacts[contactIndex].timestamp = Date.now(); 
            localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); 
        } 
        
        input.value = ''; 
        renderConversationMessages(); 
    };

    // NEW: AI Auto Reply Trigger Logic (with Time Perception & Memory Depth)
    window.triggerAIAutoReply = async () => {
        if (!currentChatContactId) return;
        
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings || !settings.api || !settings.api.url || !settings.api.key) {
            showToast('请先在设置中配置 API');
            return;
        }

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        if (!contact) return;

        const titleEl = document.getElementById('chat-conv-title');
        const originalTitle = titleEl.innerText;
        titleEl.innerText = "正在输入中...";
        titleEl.classList.add('typing-anim');

        // Time Perception Logic
        let timeContext = "";
        if (contact.timePerceptionEnabled) {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 9) timeContext = "现在是早上。";
            else if (hour >= 9 && hour < 12) timeContext = "现在是上午。";
            else if (hour >= 12 && hour < 14) timeContext = "现在是中午。";
            else if (hour >= 14 && hour < 18) timeContext = "现在是下午。";
            else if (hour >= 18 && hour < 23) timeContext = "现在是晚上。";
            else timeContext = "现在是深夜或凌晨。";
        }

        // Build Context
        const rolePersona = contact.persona || "Default Role";
        const userPersona = contact.userPersona || "User"; 
        
        let worldBookContext = "No specific world book bound.";
        if (contact.worldbookId) {
            const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const wb = worldbooks.find(b => b.id === contact.worldbookId);
            if (wb) {
                worldBookContext = `World Book Title: ${wb.title}\nEntries:\n`;
                wb.entries.forEach(entry => {
                    worldBookContext += `${entry.key ? entry.key + ': ' : ''}${entry.content}\n`;
                });
            }
        }

        const msgKey = getMessagesKey(currentChatContactId);
        let history = JSON.parse(localStorage.getItem(msgKey) || '[]');
        
        // NEW: Apply Memory Depth
        const memoryLimit = contact.memoryDepth || 10;
        // Filter out recalled messages from AI context
        const validHistory = history.filter(m => m.type !== 'recalled');
        const recentHistory = validHistory.slice(-memoryLimit).map(m => `${m.type === 'sent' ? 'User' : 'Role'}: ${m.text}`).join('\n');

        // Construct Prompt with Time context
        const systemPrompt = `
${timeContext ? `Time Context: ${timeContext}\n` : ''}
You are roleplaying. 
Role Name: ${contact.alias || contact.name}
Role Persona: ${rolePersona}
User Persona: ${userPersona}
World Setting (World Book): ${worldBookContext}

Instructions:
1. Reply to the User based on the conversation history (last ${memoryLimit} messages provided).
2. Incorporate World Book elements naturally if relevant.
3. Your reply MUST be formatted as natural text.
4. **IMPORTANT**: Output your response as 5 to 10 separate short sentences/paragraphs.
   If the Persona specifically requests a different number of messages, prioritize the Persona's instructions.
5. Do not output 'Role:' or 'User:', just the reply text.
`;

        try {
            const response = await fetch(`${settings.api.url.endsWith('/v1') ? settings.api.url : settings.api.url+'/v1'}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.api.key}` },
                body: JSON.stringify({
                    model: settings.api.model || 'gpt-3.5-turbo',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: `Conversation History:\n${recentHistory}\n\n(Reply now)` }
                    ],
                    temperature: parseFloat(settings.api.temp || 0.7),
                    max_tokens: parseInt(settings.api.tokens || 1000)
                })
            });

            if (!response.ok) throw new Error(`API Request Failed: ${response.statusText}`);
            
            const data = await response.json();
            const aiText = data.choices[0].message.content.trim();

            const rawSegments = aiText.split(/([，,。.\n])/);
            let combinedSegments = [];
            let currentBuffer = "";
            const punctuationRegex = /[，,。.\n]/;

            for (let i = 0; i < rawSegments.length; i++) {
                const part = rawSegments[i];
                if (punctuationRegex.test(part)) {
                    if (currentBuffer.trim() !== "") {
                         currentBuffer += part;
                         combinedSegments.push(currentBuffer);
                         currentBuffer = "";
                    }
                } else {
                    currentBuffer += part;
                }
            }
            if (currentBuffer.trim() !== "") combinedSegments.push(currentBuffer);
            if (combinedSegments.length === 0 && aiText) combinedSegments.push(aiText);

            let currentMessages = JSON.parse(localStorage.getItem(msgKey) || '[]');
            combinedSegments.forEach(segment => {
                if (segment.trim()) {
                    currentMessages.push({ id: Date.now() + Math.random(), text: segment.trim(), type: 'received', timestamp: Date.now() });
                }
            });
            localStorage.setItem(msgKey, JSON.stringify(currentMessages));
            
            let contactsList = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
            const contactIdx = contactsList.findIndex(c => c.id === currentChatContactId); 
            if (contactIdx !== -1) { 
                contactsList[contactIdx].lastMsg = combinedSegments[combinedSegments.length-1] || "Image/Text"; 
                contactsList[contactIdx].timestamp = Date.now(); 
                localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contactsList)); 
            } 

            renderConversationMessages();
            renderChatList();

        } catch (error) {
            console.error(error);
            showToast('AI 回复失败: ' + error.message);
        } finally {
            titleEl.innerText = originalTitle;
            titleEl.classList.remove('typing-anim');
        }
    };

    // --- Role Settings Logic (with Time Perception & Memory Depth) ---
    window.openRoleSettings = () => { if (!currentChatContactId) return; const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const contact = contacts.find(c => c.id === currentChatContactId); if (!contact) return; tempSelectedWorldBookId = contact.worldbookId || null; document.getElementById('role-setting-avatar').src = contact.avatar || ''; document.getElementById('role-setting-alias').value = contact.alias || contact.name; document.getElementById('role-setting-signature').value = contact.signature || ''; document.getElementById('role-setting-persona').value = contact.persona || ''; document.getElementById('role-time-perception-switch').checked = contact.timePerceptionEnabled || false; document.getElementById('role-memory-depth').value = contact.memoryDepth || 10; document.getElementById('role-setting-css').value = contact.customCss || `/* Example */\n.msg-bubble-row.them .msg-bubble-content {\n  border-radius: 20px 20px 20px 0;\n  background: #fff;\n}`; tempRoleBgUrl = contact.backgroundImage || ''; document.getElementById('role-bg-preview').style.backgroundImage = tempRoleBgUrl ? `url(${tempRoleBgUrl})` : ''; const globalProfile = getUserProfile(); document.getElementById('role-user-avatar').src = contact.userAvatar || globalProfile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; document.getElementById('role-user-name').value = contact.userName || globalProfile.nickname || ''; document.getElementById('role-user-persona').value = contact.userPersona || ''; updateRoleWbDisplay(contact.worldbookId); document.getElementById('role-settings-page').classList.add('active'); };
    window.closeRoleSettings = () => { document.getElementById('role-settings-page').classList.remove('active'); };
    window.triggerRoleAvatarEdit = () => { const currentUrl = document.getElementById('role-setting-avatar').src; const newUrl = prompt("输入新头像的图片链接:", currentUrl); if (newUrl && newUrl.trim()) { document.getElementById('role-setting-avatar').src = newUrl.trim(); } };
    window.triggerRoleBgUpload = () => { document.getElementById('input-role-chat-bg').click(); };
    window.handleRoleChatBgUpload = (event) => { const file = event.target.files[0]; if (!file) return; compressImage(file, 600, (base64) => { tempRoleBgUrl = base64; document.getElementById('role-bg-preview').style.backgroundImage = `url(${base64})`; }); };
    window.setRoleBgByUrl = () => { const urlInput = document.getElementById('role-bg-url-input'); const bgUrl = urlInput.value.trim(); if (!bgUrl) { showToast("请输入有效的图片URL"); return; } document.getElementById('role-bg-preview').style.backgroundImage = `url(${bgUrl})`; tempRoleBgUrl = bgUrl; showToast("背景URL已预览"); };
    window.triggerRoleUserAvatarEdit = () => { document.getElementById('input-role-user-avatar').click(); };
    window.handleRoleUserAvatarUpload = (event) => { const file = event.target.files[0]; if (!file) return; compressImage(file, 200, (base64) => { document.getElementById('role-user-avatar').src = base64; }); };
    window.saveRoleSettings = () => { if (!currentChatContactId) return; const newAlias = document.getElementById('role-setting-alias').value.trim(); if (!newAlias) { showToast("备注名不能为空"); return; } let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const idx = contacts.findIndex(c => c.id === currentChatContactId); if (idx !== -1) { contacts[idx].alias = newAlias; contacts[idx].signature = document.getElementById('role-setting-signature').value.trim(); contacts[idx].avatar = document.getElementById('role-setting-avatar').src; contacts[idx].persona = document.getElementById('role-setting-persona').value.trim(); contacts[idx].timePerceptionEnabled = document.getElementById('role-time-perception-switch').checked; contacts[idx].memoryDepth = parseInt(document.getElementById('role-memory-depth').value) || 10; contacts[idx].backgroundImage = tempRoleBgUrl || contacts[idx].backgroundImage; contacts[idx].userAvatar = document.getElementById('role-user-avatar').src; contacts[idx].userName = document.getElementById('role-user-name').value.trim(); contacts[idx].userPersona = document.getElementById('role-user-persona').value.trim(); contacts[idx].customCss = document.getElementById('role-setting-css').value; contacts[idx].worldbookId = tempSelectedWorldBookId; localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); document.getElementById('chat-conv-title').innerText = newAlias; document.getElementById('chat-conv-signature').innerText = contacts[idx].signature; document.getElementById('chat-conversation-view').style.backgroundImage = tempRoleBgUrl ? `url(${tempRoleBgUrl})` : 'none'; const styleTag = document.getElementById('custom-chat-style'); if(styleTag) styleTag.innerHTML = contacts[idx].customCss; renderChatList(); renderContactList(); renderConversationMessages(); showToast("设置已保存"); closeRoleSettings(); } };

    // --- World Book Binding Functions ---
    function getWorldBookTitleById(bookId) { if (!bookId) return null; try { const books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const book = books.find(b => b.id === bookId); return book ? book.title : null; } catch (e) { return null; } }
    function updateRoleWbDisplay(bookId) { const displayEl = document.getElementById('role-wb-display'); const clearBtn = document.getElementById('role-wb-clear-btn'); const bookTitle = getWorldBookTitleById(bookId); if (bookTitle) { displayEl.textContent = bookTitle; displayEl.classList.remove('unbound'); clearBtn.style.display = 'inline-block'; } else { displayEl.textContent = '未绑定'; displayEl.classList.add('unbound'); clearBtn.style.display = 'none'; } }
    window.openWorldBookBindModal = () => { const modal = document.getElementById('worldbook-bind-modal'); const listEl = document.getElementById('worldbook-bind-list'); listEl.innerHTML = ''; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) {} if (books.length > 0) { books.forEach(book => { const item = document.createElement('div'); item.className = 'wb-bind-list-item'; item.textContent = book.title; item.onclick = () => bindWorldBook(book.id, book.title); listEl.appendChild(item); }); } else { listEl.innerHTML = `<div class="wb-bind-list-empty">还没有创建任何世界书哦，先去世界书App创建一个吧~</div>`; } modal.classList.add('active'); };
    window.closeWorldBookBindModal = () => { document.getElementById('worldbook-bind-modal').classList.remove('active'); };
    window.bindWorldBook = (bookId, bookTitle) => { tempSelectedWorldBookId = bookId; updateRoleWbDisplay(bookId); closeWorldBookBindModal(); };
    window.clearWorldBookBinding = () => { tempSelectedWorldBookId = null; updateRoleWbDisplay(null); };

    // --- Delete Friend Logic ---
    window.confirmDeleteFriend = () => { document.getElementById('delete-friend-confirm-modal').classList.add('active'); };
    window.closeDeleteModal = (modalId) => { document.getElementById(modalId).classList.remove('active'); };
    window.executeDeleteFriend = () => { if (!currentChatContactId) return; let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const newContacts = contacts.filter(c => c.id !== currentChatContactId); localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(newContacts)); localStorage.removeItem(getMessagesKey(currentChatContactId)); showToast("好友已删除"); closeDeleteModal('delete-friend-confirm-modal'); closeRoleSettings(); closeChatConversation(); switchChatTab(0, 'Chat'); renderChatList(); renderContactList(); };

    // --- Core Functions ---
    const updateClock = () => { const clockTimeEl = document.getElementById('clock-time'); const clockDateEl = document.getElementById('clock-date'); const now = new Date(); clockTimeEl.innerText = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; if (!customDateText) { const days = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六']; clockDateEl.innerText = `${now.getFullYear()}年${String(now.getMonth() + 1).padStart(2, '0')}月${String(now.getDate()).padStart(2, '0')}日 ${days[now.getDay()]}`; } else { clockDateEl.innerText = customDateText; } };
    window.handleDateEdit = (event) => { event.stopPropagation(); const newText = prompt("请输入自定义日期文字（留空恢复实时日期）：", document.getElementById('clock-date').innerText); if (newText !== null) { customDateText = newText.trim(); updateClock(); saveAllSettings(); } };
    window.handleTimeBgClick = (event) => { document.getElementById('input-time-bg').click(); };
    window.handleTimeBgUpload = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { document.getElementById('time-container').style.backgroundImage = `url(${e.target.result})`; saveAllSettings(); showToast('时间背景已更新 ^ω^'); }; reader.readAsDataURL(file); };
    const showSettingsPage = () => { populateSettingsList(); body.classList.add('settings-active'); };
    const hideSettingsPage = () => body.classList.remove('settings-active');
    function handleUrlInput(inputEl, previewEl, callback) { const url = inputEl.value.trim(); if (url) { const img = new Image(); img.onload = () => { previewEl.style.backgroundImage = `url(${url})`; if (callback) callback(url); }; img.onerror = () => { previewEl.style.backgroundImage = ''; }; img.src = url; } else { previewEl.style.backgroundImage = ''; } }
    function handleImgSrcInput(inputEl, imgEl) { const url = inputEl.value.trim(); if (url) { imgEl.src = url; imgEl.onerror = () => { imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; }; } else { imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; } }
    const applyIconToUI = (appId, url) => { const el = document.getElementById(appId); if (!el) return; if (url && (url.startsWith('http') || url.startsWith('data:'))) { el.innerHTML = ''; el.style.backgroundImage = `url(${url})`; } else { el.style.backgroundImage = ''; const defaults = { 'icon-app1': '☁️', 'icon-app2': '🎵', 'icon-app3': '💬', 'icon-app4': '📸', 'icon-app5': '🧭', 'icon-app6': '🎮', 'icon-app7': '📅', 'icon-app8': '💰', 'icon-dock-settings': '⚙️', 'icon-dock-ai': '🤖', 'icon-dock-safari': '🧭', 'icon-dock-messages': '✉️' }; if (defaults[appId]) el.innerHTML = defaults[appId]; } };
    const populateSettingsList = () => { const container = document.getElementById('settings-app-list-container'); container.innerHTML = ''; const appIcons = [ { id: 'icon-app1', name: 'Chat', default: '☁️' }, { id: 'icon-app2', name: '世界书', default: '🎵' }, { id: 'icon-app3', name: '提醒', default: '💬' }, { id: 'icon-app4', name: '相册', default: '📸' }, { id: 'icon-app5', name: 'HUshhh', default: '🧭' }, { id: 'icon-app6', name: 'pxx', default: '🎮' }, { id: 'icon-app7', name: '日历', default: '📅' }, { id: 'icon-app8', name: 'Wallet', default: '💰' } ]; appIcons.forEach(app => { const item = document.createElement('div'); item.className = 'app-icon-item'; const cur = document.getElementById(app.id); const bg = cur.style.backgroundImage; item.innerHTML = `<div class="app-icon-preview" id="preview-${app.id}" style="${bg ? `background-image:${bg}` : ''}">${!bg ? app.default : ''}</div><div class="app-icon-info"><div class="app-icon-name">${app.name}</div><div class="app-icon-input"><input type="text" id="url-${app.id}" placeholder="图片 URL" value="${bg ? bg.slice(5, -2).replace(/['"]/g, '') : ''}"><button onclick="triggerIconUpload('${app.id}')">上传</button></div></div>`; container.appendChild(item); const inp = document.getElementById(`url-${app.id}`); inp.addEventListener('input', () => { if (inp.value.trim()) handleUrlInput(inp, document.getElementById(`preview-${app.id}`), (u) => applyIconToUI(app.id, u)); else { applyIconToUI(app.id, ''); document.getElementById(`preview-${app.id}`).style.backgroundImage = ''; document.getElementById(`preview-${app.id}`).innerHTML = app.default; } }); }); };
    window.triggerIconUpload = (id) => { const i = document.getElementById('input-app-icon'); i.dataset.target = id; i.click(); };
    window.handleIconUpload = (e) => { const f = e.target.files[0]; const id = e.target.dataset.target; if (!f || !id) return; const r = new FileReader(); r.onload = (ev) => { const d = ev.target.result; applyIconToUI(id, d); document.getElementById(`preview-${id}`).style.backgroundImage = `url(${d})`; document.getElementById(`preview-${id}`).innerHTML = ''; document.getElementById(`url-${id}`).value = d; }; r.readAsDataURL(f); };
    window.handleWallpaperUpload = (e) => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = (ev) => { const d = ev.target.result; body.style.backgroundImage = `url(${d})`; document.getElementById('wallpaper-url').value = d; document.getElementById('wallpaper-preview').style.backgroundImage = `url(${d})`; }; r.readAsDataURL(f); };
    window.editChatAvatarUrl = (id) => { const currentUrl = document.getElementById(id).style.backgroundImage.slice(5, -2).replace(/['"]/g, ''); const newUrl = prompt("请输入图片链接 (URL):", currentUrl); if(newUrl !== null && newUrl.trim() !== '') { document.getElementById(id).style.backgroundImage = `url('${newUrl.trim()}')`; saveAllSettings(); showToast("头像已更新!"); } };
    window.adjustInputWidth = (el) => { const len = el.value.length; const newWidth = Math.min(150, Math.max(60, (len * 10) + 30)); el.style.width = newWidth + 'px'; };
    window.triggerPhotoWidgetUpload = () => { document.getElementById('input-photo-widget').click(); };
    window.handlePhotoWidgetUpload = (e) => { const file = e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload = (ev) => { const d = ev.target.result; const img = document.getElementById('photo-widget-img'); const ph = document.getElementById('photo-widget-placeholder'); img.src = d; img.style.display = 'block'; ph.style.display = 'none'; saveAllSettings(); showToast("小组件图片已更新!"); }; r.readAsDataURL(file); };

    // --- Profile (Me) Page Functions ---
    function getUserProfile() { try { const p = localStorage.getItem(USER_PROFILE_KEY); const profile = p ? JSON.parse(p) : {}; return { cover: profile.cover || '', avatar: profile.avatar || '', nickname: profile.nickname || 'Antigravity', qqId: profile.qqId || Date.now(), likes: profile.likes === undefined ? 8888 : profile.likes, signature: profile.signature || '这个人很懒，什么都没留下~', memberIconUrl: profile.memberIconUrl || 'https://img.heliar.top/file/1770081928967_vip_vip-one.png', memberUrls: profile.memberUrls || new Array(8).fill('') }; } catch(e) { return { cover: '', avatar: '', nickname: 'Antigravity', qqId: Date.now(), likes: 8888, signature: '这个人很懒，什么都没留下~', memberIconUrl: 'https://img.heliar.top/file/1770081928967_vip_vip-one.png', memberUrls: new Array(8).fill('') }; } }
    function saveUserProfile(profileData) { try { localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profileData)); if (document.body.classList.contains('wallet-active')) { loadWalletUI(); } } catch (e) { showToast("保存失败 (LocalStorage满)"); } }
    function loadUserProfile() { const p = getUserProfile(); document.getElementById('profile-cover').style.backgroundImage = p.cover ? `url(${p.cover})` : 'linear-gradient(to bottom, #7A88FF, #7AFFAF)'; document.getElementById('profile-avatar').src = p.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; document.getElementById('profile-nickname').innerText = p.nickname; document.getElementById('profile-qq-id').innerText = `QQ: ${p.qqId}`; document.getElementById('profile-like-count').innerText = p.likes; document.getElementById('profile-signature-text').innerText = p.signature || '这个人很懒，什么都没留下~'; document.getElementById('me-member-icon-main').src = p.memberIconUrl || 'https://img.heliar.top/file/1770081928967_vip_vip-one.png'; const memberIconContainer = document.getElementById('me-member-icon-container'); memberIconContainer.innerHTML = ''; p.memberUrls.forEach((url) => { if(url && url.trim() !== '') { const img = document.createElement('img'); img.className = 'me-member-icon-slot'; img.src = url; memberIconContainer.appendChild(img); } }); }
    window.editSignature = () => { const p = getUserProfile(); const newSignature = prompt("请输入你的个性签名：", p.signature); if (newSignature !== null) { p.signature = newSignature.trim() || '这个人很懒，什么都没留下~'; saveUserProfile(p); loadUserProfile(); } };
    window.triggerProfileAvatarUpload = (e) => { if(e) e.stopPropagation(); document.getElementById('input-profile-avatar').click(); };
    window.handleProfileAvatarUpload = (event) => { const file = event.target.files[0]; if (!file) return; compressImage(file, 200, (base64) => { const p = getUserProfile(); p.avatar = base64; saveUserProfile(p); loadUserProfile(); showToast("头像已更新"); }); };
    window.editNickname = (e) => { if(e) e.stopPropagation(); const p = getUserProfile(); const newName = prompt("请输入新昵称:", p.nickname); if (newName && newName.trim()) { p.nickname = newName.trim(); saveUserProfile(p); loadUserProfile(); } };
    window.editQQID = (e) => { if(e) e.stopPropagation(); const p = getUserProfile(); const newID = prompt("请输入QQ号:", p.qqId); if (newID && newID.trim()) { p.qqId = newID.trim(); saveUserProfile(p); loadUserProfile(); } };
    window.incrementLikeCount = (e) => { if(e) e.stopPropagation(); const p = getUserProfile(); p.likes = parseInt(p.likes) + 1; saveUserProfile(p); loadUserProfile(); const icon = document.querySelector('.me-like-icon'); icon.style.transform = "scale(1.2) rotate(-10deg)"; setTimeout(() => icon.style.transform = "scale(1) rotate(0deg)", 150); };
    window.openMeSettings = () => { const p = getUserProfile(); document.getElementById('me-settings-avatar-url').value = p.avatar || ''; document.getElementById('me-settings-cover-url').value = p.cover || ''; document.getElementById('me-settings-avatar-preview').src = p.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; document.getElementById('me-settings-cover-preview').src = p.cover || ''; const container = document.getElementById('me-settings-member-icons-list'); container.innerHTML = ''; for (let i = 0; i < 8; i++) { const url = p.memberUrls[i] || ''; container.innerHTML += `<div class="me-settings-row"><div class="me-settings-label">会员${i+1}</div><div class="me-settings-preview-wrapper"><img id="me-preview-m${i+1}" class="me-settings-preview icon" src="${url || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}"></div><input type="text" id="me-input-m${i+1}" class="me-settings-input" placeholder="图片 URL" value="${url}"></div>`; } for (let i = 0; i < 8; i++) { const input = document.getElementById(`me-input-m${i+1}`); const preview = document.getElementById(`me-preview-m${i+1}`); input.oninput = () => { handleImgSrcInput(input, preview); }; } document.getElementById('me-settings-modal').classList.add('active'); };
    window.closeMeSettings = () => { document.getElementById('me-settings-modal').classList.remove('active'); };
    window.saveMeSettings = () => { const p = getUserProfile(); p.avatar = document.getElementById('me-settings-avatar-url').value.trim(); p.cover = document.getElementById('me-settings-cover-url').value.trim(); for (let i = 0; i < 8; i++) { p.memberUrls[i] = document.getElementById(`me-input-m${i+1}`).value.trim(); } saveUserProfile(p); loadUserProfile(); showToast('个人主页设置已保存'); closeMeSettings(); };

    // --- API & Chat ---
    const testApiBtn = document.getElementById('test-api-btn'); const fetchModelsBtn = document.getElementById('fetch-models-btn'); const modelSelect = document.getElementById('model-select'); const apiStatus = document.getElementById('api-status'); const apiUrlInput = document.getElementById('api-url-input'); const apiKeyInput = document.getElementById('api-key-input');
    testApiBtn.onclick = async () => { const url = apiUrlInput.value.trim(); const key = apiKeyInput.value.trim(); if (!url || !key) { showToast('请填写 API 地址和 Key'); return; } testApiBtn.disabled = true; apiStatus.innerText = "测试中..."; try { const res = await fetch(`${url.endsWith('/v1') ? url : url+'/v1'}/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (res.ok) { apiStatus.innerText = "已连接"; apiStatus.className = "api-status connected"; showToast("连接成功！"); } else throw new Error(); } catch(e) { apiStatus.innerText = "连接失败"; apiStatus.className = "api-status disconnected"; showToast("连接失败"); } finally { testApiBtn.disabled = false; } };
    fetchModelsBtn.onclick = async () => { const url = apiUrlInput.value.trim(); const key = apiKeyInput.value.trim(); if (!url || !key) return; fetchModelsBtn.disabled = true; try { const res = await fetch(`${url.endsWith('/v1') ? url : url+'/v1'}/models`, { headers: { 'Authorization': `Bearer ${key}` } }); const data = await res.json(); modelSelect.innerHTML = data.data.map(m => `<option value="${m.id}">${m.id}</option>`).join(''); document.getElementById('model-select-wrapper').style.display = 'block'; } catch(e) { showToast("获取模型失败"); } finally { fetchModelsBtn.disabled = false; } };
    window.openAIChat = () => { const s = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY)); if (!s || !s.api || !s.api.model) { showToast('请先在设置中配置 API'); return; } document.getElementById('current-model-name').innerText = s.api.model; document.getElementById('ai-chat-modal').classList.add('active'); };
    window.closeAIChat = () => document.getElementById('ai-chat-modal').classList.remove('active');

    function saveAllSettings() {
        const icons = {}; document.querySelectorAll('.app-icon-input input').forEach(i => { const id = i.id.replace('url-', ''); if (i.value.trim()) icons[id] = i.value.trim(); });
        const getBgUrl = (el) => { const bg = el.style.backgroundImage; return bg ? bg.slice(5, -2).replace(/['"]/g, '') : ''; };
        const settings = {
            api: { url: apiUrlInput.value, key: apiKeyInput.value, model: modelSelect.value, temp: document.getElementById('temp-slider').value, tokens: document.getElementById('max-tokens-input').value },
            visual: { wallpaper: document.getElementById('wallpaper-url').value, widget: document.getElementById('widget-square-url').value, customImg: document.getElementById('custom-image-url').value, icons: icons, timeBg: document.getElementById('time-container').style.backgroundImage, customDate: customDateText, chatAvatar1: getBgUrl(document.getElementById('chat-avatar-1')), chatAvatar2: getBgUrl(document.getElementById('chat-avatar-2')), photoWidgetUrl: document.getElementById('photo-widget-img').src, chatText1: document.querySelector('.chat-bubble-input.left-bubble')?.value || "Say Hi~", chatText2: document.querySelector('.chat-bubble-input.right-bubble')?.value || "Hello!" }
        };
        localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings)); if (event && event.type === 'click') showToast('设置已保存 ⩌⩊⩌'); applyVisual(settings.visual);
    }
    function applyVisual(v) {
        if (v.wallpaper) body.style.backgroundImage = `url(${v.wallpaper})`;
        if (v.timeBg) document.getElementById('time-container').style.backgroundImage = v.timeBg;
        customDateText = v.customDate || ""; updateClock();
        if(v.chatAvatar1) document.getElementById('chat-avatar-1').style.backgroundImage = `url(${v.chatAvatar1})`;
        if(v.chatAvatar2) document.getElementById('chat-avatar-2').style.backgroundImage = `url(${v.chatAvatar2})`;
        const i1 = document.querySelector('.chat-bubble-input.left-bubble'); const i2 = document.querySelector('.chat-bubble-input.right-bubble');
        if(i1 && v.chatText1) { i1.value = v.chatText1; adjustInputWidth(i1); }
        if(i2 && v.chatText2) { i2.value = v.chatText2; adjustInputWidth(i2); }
        const pImg = document.getElementById('photo-widget-img'); const pPh = document.getElementById('photo-widget-placeholder');
        if (v.photoWidgetUrl && v.photoWidgetUrl.length > 20 && !v.photoWidgetUrl.includes('null')) { pImg.src = v.photoWidgetUrl; pImg.style.display = 'block'; pPh.style.display = 'none'; } else { pImg.style.display = 'none'; pPh.style.display = 'flex'; }
        if (v.icons) Object.keys(v.icons).forEach(id => applyIconToUI(id,            v.icons[id]));
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
            if (!settings) return;
            
            if (settings.api) {
                apiUrlInput.value = settings.api.url || '';
                apiKeyInput.value = settings.api.key || '';
                if(settings.api.model) {
                     modelSelect.innerHTML = `<option value="${settings.api.model}">${settings.api.model}</option>`;
                }
                document.getElementById('temp-slider').value = settings.api.temp || 0.8;
                document.getElementById('temp-value-display').innerText = settings.api.temp || 0.8;
                document.getElementById('max-tokens-input').value = settings.api.tokens || 1000;
            }
            if (settings.visual) {
                document.getElementById('wallpaper-url').value = settings.visual.wallpaper || '';
                document.getElementById('widget-square-url').value = settings.visual.widget || '';
                document.getElementById('custom-image-url').value = settings.visual.customImg || '';
                applyVisual(settings.visual);
                // Pre-fill icon inputs in settings page
                if (settings.visual.icons) {
                   // Slight delay to ensure elements exist if populateSettingsList hasn't run yet
                   setTimeout(() => {
                       Object.keys(settings.visual.icons).forEach(id => {
                           const inp = document.getElementById(`url-${id}`);
                           if(inp) inp.value = settings.visual.icons[id];
                       });
                   }, 100);
                }
            }
            
            // iOS Mode Load
            const iosMode = localStorage.getItem(IOS_MODE_KEY) === 'true';
            document.getElementById('ios-mode-switch').checked = iosMode;
            applyIOSMode(iosMode);
        }

        document.getElementById('save-settings-btn').onclick = () => {
             saveAllSettings();
             hideSettingsPage();
             
             // Save iOS Mode
             const iosEnabled = document.getElementById('ios-mode-switch').checked;
             applyIOSMode(iosEnabled);
        };
        
        document.getElementById('temp-slider').oninput = (e) => {
            document.getElementById('temp-value-display').innerText = e.target.value;
        };

        // --- AI Chat Logic (Standalone) ---
        window.handleChatKeyPress = (e) => { if (e.key === 'Enter') sendChatMessage(); };
        window.sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            const msgsDiv = document.getElementById('chat-messages');
            msgsDiv.innerHTML += `<div class="message user">${escapeHtml(text)}</div>`;
            input.value = '';
            msgsDiv.scrollTop = msgsDiv.scrollHeight;

            const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
            if (!settings || !settings.api) {
                 msgsDiv.innerHTML += `<div class="message ai">请先配置 API。</div>`;
                 return;
            }

            try {
                const res = await fetch(`${settings.api.url.endsWith('/v1') ? settings.api.url : settings.api.url+'/v1'}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.api.key}` },
                    body: JSON.stringify({
                        model: settings.api.model || 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: text }],
                        temperature: parseFloat(settings.api.temp || 0.7)
                    })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;
                msgsDiv.innerHTML += `<div class="message ai">${escapeHtml(reply)}</div>`;
                msgsDiv.scrollTop = msgsDiv.scrollHeight;
            } catch (e) {
                msgsDiv.innerHTML += `<div class="message ai">Error: ${e.message}</div>`;
            }
        };

        // --- Initialization ---
        window.onload = () => {
            updateClock();
            setInterval(updateClock, 1000); 
            populateSettingsList(); // Init settings UI
            loadSettings(); // Load saved data
            renderChatList();
            loadUserProfile(); // Me page init
        };
    </script>
</body>
</html>