<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iOS Home Screen</title>
    <style>
        /* --- 全局重置与基础样式 --- */
        :root {
             --theme-pink-bg-light: #FFF0F5;
             --theme-pink-bg-med: rgba(229, 138, 171, 0.15);
             --theme-pink-bg-soft: #FFF8FA;
            --theme-pink-text: #E58AAB;
            --theme-pink-title: #f5b3c9;
            --theme-pink-btn: #F5B3C9; 
            --wb-plus-btn: #FDCEDF;
             --chat-bg-color: #FFF8FA;
             --success-green: #4CAF50;
            --error-red: #F44336;
            --wallet-gradient: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%);
            --wallet-card-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
            --link-blue: #5865F2;
            --moments-nickname-color: #8687B4; /* 朋友圈昵称颜色 */
            --menu-pink: #fdcee0;
            --header-text-custom: #FDCEDF; /* 新增：顶栏自定义颜色 */
            --phone-case-color: #ffffff; /* 新增：手机壳颜色变量 */
            --cat-ear-color: #ffffff; /* 新增：猫耳朵颜色变量 */
            --status-bar-height: 44px; /* 新增：状态栏高度变量 */
        }
        * {
             box-sizing: border-box;
             margin: 0;
             padding: 0;
             user-select: none;
             -webkit-tap-highlight-color: transparent;
             font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
         }
        body {
             width: 100vw;
             height: 100vh;
             overflow: hidden;
             background: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib-rb-1.2.1&auto=format&fit=crop&w=1000&q=80') center/cover no-repeat;
             position: relative;
             transition: background-image 0.3s ease-in-out;
            z-index: -2;
        }
        #home-screen {
             width: 100%;
             height: 100%;
             display: flex;
             flex-direction: column;
             padding: 0 0 env(safe-area-inset-bottom, 20px) 0;
             transition: opacity 0.3s ease, transform 0.3s ease;
         }
        body.settings-active #home-screen,
        body.chat-active #home-screen,
        body.wallet-active #home-screen,
        body.worldbook-active #home-screen,
        body.forum-active #home-screen,
        body.mall-active #home-screen {
             opacity: 0;
             transform: scale(0.95);
             pointer-events: none;
         }

        /* --- 时间区域 --- */
        #time-section {
             height: 25%;
             display: flex;
             justify-content: center;
             align-items: center;
             padding-top: 20px;
             flex-shrink: 0;
             transition: padding-top 0.3s ease;
         }
        #time-container {
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            background-size: cover;
            background-position: center;
            border-radius: 25px;
         }
        #time-container:active {
            transform: scale(0.98);
        }
        #clock-time {
             font-size: 5.2rem;
             font-weight: 300;
             color: white;
             text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.1;
        }
        #clock-date {
            font-size: 0.95rem;
             color: white;
            font-weight: 500;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- 网格区域 --- */
        #grid-area {
             flex: 1;
             display: grid;
             grid-template-columns: 1fr 1fr;
             grid-template-rows: 1fr 1fr;
             padding: 0 15px 10px 15px;
             gap: 15px;
             width: 100%;
             max-width: 600px;
             margin: 0 auto;
         }
        .grid-quadrant {
             width: 100%;
             height: 100%;
             display: flex;
             justify-content: center;
             align-items: center;
             position: relative;
         }
        
        /* --- 优化的聊天小组件样式 (Quadrant 1) --- */
        #chat-dual-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px; 
            padding: 5px;
        }
        .chat-row { display: flex; align-items: center; width: 100%; }
        .chat-row.left { justify-content: flex-start; }
        .chat-row.right { flex-direction: row-reverse; }

        .avatar-container {
            position: relative; flex-shrink: 0; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin: 0 8px; 
        }
        .avatar-container:active { transform: scale(0.9); }
        .avatar-ring {
            width: 48px; height: 48px; border-radius: 50%; padding: 2px;
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%, #a18cd1 100%);
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.3);
        }
        .avatar-img-circle {
            width: 100%; height: 100%; border-radius: 50%;
            background-color: #fff; background-size: cover; background-position: center;
            border: 2px solid #fff; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        .chat-bubble-input {
            height: 36px; border-radius: 18px; padding: 0 14px; font-size: 13px; outline: none;
            transition: all 0.3s ease; min-width: 60px; max-width: 140px; width: 80px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); color: #444;
        }
        .chat-bubble-input.left-bubble { border-bottom-left-radius: 4px; }
        .chat-bubble-input.right-bubble { border-bottom-right-radius: 4px; text-align: right; }
        .chat-bubble-input:focus { box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: rgba(255, 255, 255, 0.9); max-width: 150px; }

        /* --- 图片小组件 (Quadrant 4) --- */
        .photo-widget-container {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 26px; 
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            position: relative; overflow: hidden; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; justify-content: center; align-items: center;
        }
        .photo-widget-container:active { transform: scale(0.96); }
        .photo-widget-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-widget-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.1); pointer-events: none;
        }
        .photo-widget-icon { font-size: 36px; margin-bottom: 5px; opacity: 0.8; }
        .photo-widget-text { font-size: 13px; font-weight: 500; opacity: 0.9; }

        /* --- App Group Styles --- */
        .app-group-2x2 {
             display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
             gap: 12px; width: 100%; aspect-ratio: 1/1;
         }
        .app-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .app-icon {
             width: 60px; height: 60px; border-radius: 16px; margin-bottom: 5px;
             display: flex; justify-content: center; align-items: center; font-size: 28px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative;
             transition: transform 0.1s, filter 0.1s;
             background-size: cover; background-position: center; background-color: rgba(255, 255, 255, 0.2);
        }
        .app-name { font-size: 11px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.4); white-space: nowrap; }
                
        /* 底栏样式 */
        #dock-area {
             height: 95px; width: 100%; display: flex; justify-content: center; align-items: center;
             padding: 0 15px 10px 15px; flex-shrink: 0;
         }
        .dock-container {
             width: 100%; max-width: 350px; height: 100%;
             background: rgba(255, 255, 255, 0.2);
             backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
             border-radius: 30px; display: flex; justify-content: space-evenly; align-items: center;
             box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.15);
         }
        .dock-icon { width: 60px; height: 60px; font-size: 28px; margin: 0; }
        #dock-area .app-item .app-icon { margin-bottom: 0; }

        /* --- Chat App 首页样式 --- */
        #chat-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--chat-bg-color); z-index: 500;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.chat-active #chat-app-page { transform: translateY(0); }
        
        .chat-app-header {
            padding: 35px 20px 15px;
            background: #fff;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: none;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 20px rgba(229, 138, 171, 0.15);
            flex-shrink: 0; /* height is now auto */ z-index: 10; 
            transition: padding-top 0.3s ease, background-color 0.3s, box-shadow 0.3s;
            position: relative; /* MODIFIED: For title centering */
        }
        
        .chat-app-header.hidden { display: none; }
        /* MODIFIED: Title is now absolutely centered */
        .chat-header-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--header-text-custom); 
            transition: color 0.3s ease;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .back-icon-img { width: 30px; height: 30px; object-fit: contain; cursor: pointer; opacity: 1; pointer-events: auto; }
        .back-icon-img.hidden { opacity: 0; pointer-events: none; }
        .header-right-icon { width: 26px; height: 26px; object-fit: contain; cursor: pointer; transition: opacity 0.3s ease; }
        
        .chat-app-content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 100px; scroll-behavior: smooth; background-color: var(--chat-bg-color); transition: background-color 0.3s ease; }
        .me-mode { padding-top: 0; background-color: var(--chat-bg-color); overflow-y: hidden; display: flex; flex-direction: column; justify-content: flex-end; height: 100vh; }
        .chat-tab-content { display: none; min-height: 100%; }
        .chat-tab-content.active { display: block; }

        /* --- 角色聊天页面 (Chat Conversation View) - 仿微信布局 --- */
        #chat-conversation-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F8F8F8; 
            z-index: 600;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
            background-size: cover; background-position: center;
        }
        #chat-conversation-view.active { transform: translateX(0); }

        /* 1. 顶部导航栏 (角色聊天) */
        .chat-conv-header {
            padding: 25px 15px 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            border-radius: 0 0 35px 35px;
            box-shadow: 0 5px 25px rgba(229, 138, 171, 0.15);
            flex-shrink: 0; z-index: 20; height: 80px;
            transition: padding-top 0.3s ease, height 0.3s ease;
        }
        
        body.ios-mode-active .chat-conv-header { 
            padding-top: calc(env(safe-area-inset-top, 20px) + 25px);
            height: 120px; 
        }
        body.ios-mode-active .chat-conv-back-btn,
        body.ios-mode-active .chat-conv-right-icon {
            transform: translateY(-20px);
        }
        body.ios-mode-active .chat-conv-title-container { margin-top: -30px; }
        
        /* 1. 手机框模式下，聊天页备注上移 */
        body.phone-frame-active .chat-conv-title-container {
            margin-top: -10px;
        }


        .chat-conv-back-btn { width: 32px; height: 32px; object-fit: contain; cursor: pointer; }
        
        .chat-conv-title-container {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; padding: 0 10px; transition: margin-top 0.3s ease;
        }
        .chat-conv-title {
            font-size: 17px; font-weight: 600; color: var(--theme-pink-text); 
            text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        /* 对方正在输入中... 闪烁动画类 */
        @keyframes blinkColor {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        .typing-anim {
            color: #FDCEDF !important;
            animation: blinkColor 1.5s infinite ease-in-out;
        }

        .chat-conv-signature {
            font-size: 11px; color: var(--theme-pink-text); opacity: 0.8;
            margin-top: 2px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .chat-conv-right-icon { 
            width: 28px; height: 28px; cursor: pointer; object-fit: contain; 
        }

        /* 聊天内容区 */
        .chat-conv-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* MODIFIED: Anchors messages to the bottom */
            gap: 18px;
        }
        
        /* Time Stamp Style */
        .chat-time-stamp {
            align-self: center;
            font-size: 12px;
            color: #b0b0b0;
            margin: 10px 0;
            font-weight: 400;
        }
        
        .msg-bubble-row { display: flex; align-items: flex-end; width: 100%; gap: 8px; transition: transform 0.3s; position: relative; }
        .msg-bubble-row.me { justify-content: flex-end; }
        
        /* Recalled Tip */
        .msg-recalled-tip {
            align-self: center;
            font-size: 12px;
            color: #b0b0b0;
            background: rgba(0,0,0,0.05);
            padding: 4px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        .msg-bubble-avatar {
            width: 38px; height: 38px; border-radius: 8px; object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        
        /* 文字排列样式 */
        .msg-bubble-content {
            max-width: 70%; padding: 12px 16px; font-size: 15px; line-height: 1.6;
            position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            word-wrap: break-word; word-break: break-all; user-select: text;
            white-space: pre-wrap; text-align: left; display: block;
        }
        .msg-bubble-row.them .msg-bubble-content {
            background: #FFFFFF; color: #333;
            border-radius: 18px 18px 18px 4px;
        }
        .msg-bubble-row.me .msg-bubble-content {
            background: var(--theme-pink-text); color: white;
            border-radius: 18px 18px 4px 18px;
        }

        /* --- [MODIFIED] Transfer Bubble Style in Chat --- */
        .transfer-message-card {
            width: 230px; 
            background-color: #fd9806; /* 默认橙色背景 */
            color: white;
            border-radius: 12px;
            padding: 0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: default; /* No longer clickable by default */
            transition: background-color 0.3s ease;
        }

        .transfer-main {
            display: flex;
            align-items: center;
            padding: 15px;
        }
        .transfer-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .transfer-details {
            flex: 1;
            overflow: hidden;
        }
        .transfer-amount {
            font-size: 22px;
            font-weight: 500;
            white-space: nowrap;
        }
        .transfer-status {
            font-size: 13px;
            margin-top: 4px;
            opacity: 0.9;
        }
        .transfer-footer-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            background: transparent;
            padding: 6px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Bubble Context Menu (Popup) z-index 修复 */
                /* --- 美化后的气泡菜单 (粉白圆滑风格) --- */
        .bubble-context-menu {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.95); /* 半透明白色背景 */
            backdrop-filter: blur(10px); /* 毛玻璃效果 */
            border-radius: 16px; /* 更圆润的边角 */
            padding: 6px;
            display: flex;
            gap: 6px;
            box-shadow: 0 8px 25px rgba(229, 138, 171, 0.25); /* 粉色系柔和阴影 */
            z-index: 10020;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            margin-top: -12px;
            display: none;
            border: 1px solid rgba(255, 240, 245, 0.6); /* 极淡的粉色边框 */
            animation: popMenu 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popMenu { from { opacity: 0; transform: translate(-50%, -90%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -100%) scale(1); } }
        
        .bubble-context-menu.active { display: flex; }
        
        .bubble-menu-item {
            padding: 8px 16px;
            font-size: 14px;
            color: #555;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px; /* 按钮也圆润 */
            transition: all 0.2s;
        }
        .bubble-menu-item:active, .bubble-menu-item:hover { 
            background-color: #FFF0F5; /* 薰衣草/浅粉背景 */
            color: #E58AAB; /* 粉色文字 */
        }
        
        /* 菜单下方的小箭头 */
        .bubble-context-menu::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -7px;
            border-width: 7px; border-style: solid;
            border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
            filter: drop-shadow(0 2px 2px rgba(229, 138, 171, 0.1));
        }
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid;
            border-color: var(--menu-pink) transparent transparent transparent;
        }

        /* Multi-select Mode Styles */
        .chat-conv-messages.multi-select-active .msg-bubble-row {
            padding-left: 30px; /* Space for checkbox */
        }
        .chat-checkbox {
            position: absolute; left: -30px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd;
            display: none; justify-content: center; align-items: center;
            background: white; transition: all 0.2s;
        }
        .chat-conv-messages.multi-select-active .chat-checkbox { display: flex; left: 0; }
        .chat-checkbox.checked { background: var(--theme-pink-btn); border-color: var(--theme-pink-btn); }
        .chat-checkbox.checked::after { content: '✓'; color: white; font-size: 12px; font-weight: bold; }
        
        .chat-multiselect-footer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; border-top: 1px solid #eee; z-index: 25;
            display: none; justify-content: center; align-items: center;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .chat-multiselect-footer.active { display: flex; }
        .chat-multiselect-delete-btn {
            background: #ffebee; color: #F44336; padding: 10px 30px; border-radius: 20px;
            border: none; font-weight: 600; font-size: 14px; cursor: pointer;
        }


        /* 2. 底部输入栏 (角色聊天) */
        .chat-conv-footer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px)) 12px;
            display: flex; align-items: center; gap: 10px;
            border-radius: 35px 35px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.04);
            flex-shrink: 0; z-index: 20;
        }
        
        .chat-conv-btn {
            width: 42px; height: 42px; border-radius: 50%;
            background-color: var(--theme-pink-btn);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; border: none; outline: none;
            box-shadow: 0 3px 8px rgba(229, 138, 171, 0.3);
            transition: transform 0.1s; flex-shrink: 0;
        }
        .chat-conv-btn:active { transform: scale(0.92); }
        .chat-conv-btn img {
            filter: brightness(0) invert(1); 
            pointer-events: none;
        }
        /* AI触发按钮专属样式，可根据需要微调 */
        .chat-conv-btn.ai-trigger {
            background-color: var(--theme-pink-btn);
        }

        .chat-conv-input-wrapper { flex: 1; height: 42px; position: relative; }
        .chat-conv-input {
            width: 100%; height: 100%;
            border-radius: 25px;
            background-color: #F5F5F7; border: none; outline: none;
            padding: 0 20px; font-size: 16px; color: #333;
            transition: background-color 0.2s;
        }
        .chat-conv-input:focus { background-color: #F5F5F7; border: 1px solid rgba(229, 138, 171, 0.3); }

        /* Chat Extra Menu (功能集弹窗) */
        #chat-extra-menu {
            position: absolute;
            bottom: 75px;
            left: 10px;
            width: 300px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 15px;
            display: none;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            z-index: 50;
            transition: opacity 0.2s ease, transform 0.2s ease;
            opacity: 0;
            transform: translateY(10px);
        }
        #chat-extra-menu.active {
            display: grid;
            opacity: 1;
            transform: translateY(0);
        }
        .chat-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
        }
        .chat-menu-item:active { opacity: 0.7; }
        .chat-menu-icon {
            width: 36px;
            height: 36px;
            object-fit: contain;
            border-radius: 10px;
        }
        .chat-menu-text {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        /* --- 角色设置页面 (Role Settings Page) --- */
        #role-settings-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--theme-pink-bg-light);
            z-index: 700;
            display: flex; flex-direction: column; align-items: center;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1), padding-top 0.3s ease;
            overflow-y: auto; padding: 40px 20px 40px;
        }
        #role-settings-page.active { transform: translateX(0); }
        
        .role-setting-close-area { width: 100%; display: flex; justify-content: flex-start; margin-bottom: 10px; flex-shrink: 0; }
        .role-setting-back-btn { width: 30px; height: 30px; cursor: pointer; object-fit: contain; }
        
        .settings-section-card {
            width: 100%; max-width: 500px;
            background: white; border-radius: 20px;
            padding: 20px; box-shadow: 0 4px 15px rgba(245, 179, 201, 0.2);
            margin-bottom: 20px; display: flex; flex-direction: column; align-items: center;
        }

        .settings-card-title {
            font-size: 15px; font-weight: 600; color: var(--theme-pink-text);
            width: 100%; text-align: left; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;
        }

        .role-avatar-edit-wrapper { 
            position: relative; width: 70px; height: 70px; margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(229, 138, 171, 0.2); border-radius: 50%;
        }
        .role-avatar-edit { 
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover; 
            border: 3px solid white; cursor: pointer;
        }
        .avatar-edit-hint {
            position: absolute; bottom: -2px; right: -2px; background: var(--theme-pink-btn); color: white;
            width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 12px; border: 2px solid white; pointer-events: none;
        }

        .role-alias-edit {
            font-size: 18px; font-weight: 600; color: #333; border: none; background: transparent;
            text-align: center; margin-bottom: 5px; border-bottom: 2px solid transparent;
            padding: 5px; outline: none; width: 80%; transition: border-color 0.2s;
        }
        .role-alias-edit:focus { border-bottom-color: var(--theme-pink-btn); }

        .role-signature-edit {
             font-size: 13px; color: var(--theme-pink-text); border: none; background: transparent;
             text-align: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0;
             padding: 4px; outline: none; width: 90%;
        }
        .role-signature-edit:focus { border-bottom-color: var(--theme-pink-btn); }
        
        .role-persona-input, .role-css-input {
            width: 100%; height: 80px;
            border: 1px solid #eee; border-radius: 12px;
            padding: 10px; font-size: 14px; line-height: 1.4; outline: none; resize: none;
            background-color: #FAFAFA; color: #444; font-family: inherit; margin-bottom: 10px;
        }
        .role-persona-input:focus, .role-css-input:focus { background-color: white; border-color: var(--theme-pink-btn); }
        
        .role-css-input { height: 120px; font-family: monospace; font-size: 12px; }

        .role-bg-upload-area {
            width: 100%; margin-top: 15px; display: flex; flex-direction: column; gap: 10px;
            padding: 10px; background: #f9f9f9; border-radius: 10px;
        }
        .role-bg-preview {
            width: 40px; height: 60px; border-radius: 6px; background-color: #eee;
            background-size: cover; background-position: center; border: 1px solid #ddd;
        }
        .role-bg-btn {
            font-size: 13px; padding: 6px 12px; border-radius: 15px; border: none;
            background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); cursor: pointer;
        }

        .user-avatar-row { display: flex; align-items: center; width: 100%; margin-bottom: 15px; gap: 15px; }
        .user-avatar-edit-wrapper { 
            position: relative; width: 60px; height: 60px; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 50%; cursor: pointer;
        }
        .user-name-input {
            flex: 1; border: 1px solid #eee; border-radius: 10px; padding: 10px;
            font-size: 15px; outline: none; background: #FAFAFA;
        }
        .user-name-input:focus { background: white; border-color: var(--theme-pink-btn); }

        .role-save-btn {
            width: 100%; max-width: 300px; padding: 15px;
            background-color: var(--theme-pink-btn);
            color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: 600;
            cursor: pointer; box-shadow: 0 5px 15px rgba(245, 179, 201, 0.4);
            transition: transform 0.1s; margin-top: 10px;
        }
        .role-save-btn:active { transform: scale(0.96); }

        .role-delete-btn {
            font-size: 14px; color: #F44336; margin-top: 20px; background: transparent; border: none;
            text-decoration: underline; cursor: pointer; padding: 10px; font-weight: 500;
        }

        .role-wb-binding-area {
            width: 100%; display: flex; align-items: center; justify-content: space-between;
            background: #f9f9f9; border-radius: 10px; padding: 10px 15px; margin-top: 10px;
        }
        #role-wb-display {
            flex: 1; font-size: 14px; color: #555; font-weight: 500;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #role-wb-display.unbound { color: #aaa; font-style: italic; }
        .role-wb-binding-area .actions { display: flex; gap: 8px; margin-left: 10px; }
        .role-wb-binding-area button {
            font-size: 13px; padding: 6px 12px; border-radius: 15px; border: none; cursor: pointer;
            background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text);
        }
        .role-wb-binding-area button#role-wb-clear-btn { background-color: #eee; color: #999; }
        
        /* --- Chat List & Contact List Styles --- */
        .chat-list-container { width: 100%; }
        .chat-list-item { display: flex; align-items: center; padding: 12px 20px; background-color: white; border-bottom: 1px solid rgba(0,0,0,0.03); cursor: pointer; transition: background-color 0.2s; }
        .chat-list-item:active { background-color: #f0f0f0; }
        .chat-list-avatar { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; margin-right: 15px; background-color: #eee; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-list-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .chat-list-name { font-size: 16px; color: #111; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-msg { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .contact-list-container { width: 100%; padding-bottom: 80px; padding-right: 25px; }
        .contact-section-title {
            padding: 8px 20px; font-size: 13px; font-weight: 600; color: #999;
            background-color: #f7f7f7; position: sticky; top: 0; z-index: 5; scroll-margin-top: 70px;
        }
        .contact-item {
            display: flex; align-items: center; padding: 10px 20px; background: white;
            border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: background 0.2s;
        }
        .contact-item:active { background-color: #f0f0f0; }
        .contact-avatar { width: 42px; height: 42px; border-radius: 10px; margin-right: 15px; object-fit: cover; background: #eee; }
        .contact-name { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 0; }
        .contact-signature { font-size: 12px; color: #E58AAB; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 100%; margin-top: 2px; }
        .contact-signature:empty { display: none; margin-top: 0; }
        .pinned-tag { display: none; margin-left: auto; font-size: 12px; color: orange; }
        .contact-item.pinned .pinned-tag { display: block; }
        
        .alpha-index-bar {
            position: fixed; right: 5px; top: 120px; bottom: 100px;
            width: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; color: #aaa; font-size: 10px; font-weight: 600;
        }
        .alpha-index-item { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; transition: color 0.2s; }
        .alpha-index-item:active { color: var(--theme-pink-text); background-color: rgba(0,0,0,0.03); }
        
        .chat-placeholder-text { color: #E58AAB; text-align: center; padding-top: 50%; font-size: 16px; font-weight: 500; width: 100%; }

        /* --- NEW/MODIFIED: 朋友圈 (Moments) Styles --- */
        #chat-tab-2 {
            background-color: #ffffff; /* 确保朋友圈 Tab 背景纯白 */
            min-height: 100vh;
        }
        #moments-page-wrapper {
            background-color: #ffffff; /* 强制白色背景 */
            padding-bottom: 100px; /* Space for nav bar */
            min-height: 100%;
        }
        .moments-header {
            position: relative;
            width: 100%;
            padding-bottom: 40px; /* Space for content below cover */
        }
        .moments-cover-img {
            width: 100%;
            height: 300px;
            background-color: #ddd;
            background-size: cover;
            background-position: center;
            position: relative;
            cursor: pointer;
        }
        
        .moments-user-info {
            position: absolute;
            top: 265px; /* Cover height (300) - half avatar (35) */
            right: 20px;
            display: flex;
            align-items: flex-start; /* Align top, so text sits above boundary */
            gap: 15px;
            z-index: 2;
        }
        
        .moments-user-nickname {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            margin-top: 15px; /* Adjust to align visually with the "upper part" of the avatar */
        }
        
        .moments-user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            flex-shrink: 0;
        }

        #moments-list {
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* 强制白色背景 */
            padding-top: 30px; /* Space for the overlapping avatar */
        }
        .moment-item {
            display: flex;
            gap: 15px;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .moment-item-avatar {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .moment-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .moment-item-nickname {
            font-size: 16px;
            font-weight: 600;
            color: var(--moments-nickname-color); /* 修改颜色为 #8687B4 */
        }
        .moment-item-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* Nine Grid Image Layout */
        .moments-img-grid {
            display: grid;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
            max-width: 300px;
        }
        .moments-img-grid.single-img {
            grid-template-columns: 1fr;
        }
        .moments-img-grid.grid-2, .moments-img-grid.grid-4 {
            grid-template-columns: repeat(2, 1fr);
            width: 200px; /* Limit width for 2x2 */
        }
        .moments-img-grid.grid-3, .moments-img-grid.grid-5, .moments-img-grid.grid-6, 
        .moments-img-grid.grid-7, .moments-img-grid.grid-8, .moments-img-grid.grid-9 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .moment-grid-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .moments-img-grid.single-img .moment-grid-img {
            max-width: 200px;
            max-height: 200px;
            aspect-ratio: auto;
            width: auto;
            height: auto;
        }

        .moment-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #999;
        }
        .moment-item-meta-left {
            display: flex;
            align-items: center;
            gap: 8px; /* '两个字的距离' reduced for better spacing with new tag*/
            font-size: 13px;
        }
        .moment-delete-btn {
            width: 14px;
            height: 14px;
            object-fit: contain;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .moment-delete-btn:hover { opacity: 1; }

        .moment-actions-btn {
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 0px 6px;
            font-weight: bold;
            font-size: 18px; /* Slightly larger for ".." */
            color: #8687B4; /* 修改为指定颜色 */
            cursor: pointer;
            position: relative;
            line-height: 14px;
            height: 16px;
            display: flex;
            align-items: center;
            letter-spacing: -2px; /* Make dots closer */
        }
        .moment-actions-popup {
            position: absolute;
            right: 100%;
            bottom: -8px; /* Slight adjustment */
            margin-right: 10px;
            background-color: #4C4C4C;
            color: white;
            border-radius: 6px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transform: scale(0);
            transform-origin: right center;
            transition: transform 0.15s ease-out;
            white-space: nowrap;
            z-index: 10; /* Ensure it's above other elements */
        }
        .moment-actions-popup.active {
            transform: scale(1);
        }
        .moment-popup-btn {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        .moment-popup-btn img {
            width: 16px; height: 16px; object-fit: contain;
        }
        .moment-popup-btn:not(:last-child) {
            border-right: 1px solid #666;
        }
        .moment-popup-btn:active {
            background-color: #333;
        }
        .moment-feedback {
            margin-top: 10px;
            background-color: #F7F7F7;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
        }
        .moment-likes {
            color: var(--moments-nickname-color);
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .moment-likes:empty {
            display: none;
        }
        .moment-likes:last-child { /* if no comments, remove border */
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .moment-comments-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .moment-comment-item .user {
            color: var(--moments-nickname-color); /* 修改颜色为 #8687B4 */
            font-weight: 500;
        }
        .moment-comment-item .text {
            color: #333;
        }
        #add-moment-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f7f7f7;
            z-index: 650; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        #add-moment-modal.active {
            transform: translateY(0);
        }
        .add-moment-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 35px 20px 15px; background: #f7f7f7; flex-shrink: 0;
        }
        .add-moment-header button {
            border: none; background: none; font-size: 16px; cursor: pointer; padding: 5px 10px;
        }
        .add-moment-cancel { color: #333; }
        
        /* Updated Post Button Style */
        .add-moment-post {
            background-color: #F8C8DC; /* Pale Pink */
            color: black; 
            border-radius: 4px; /* Rectangular-ish */
            padding: 6px 15px !important; 
            font-weight: 500;
        }
        
        .add-moment-content { padding: 0 20px; flex: 1; display: flex; flex-direction: column; }
        #add-moment-text {
            width: 100%;
            height: 150px;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            resize: none;
            padding: 10px 0;
        }
        
        /* Add Moment Image Grid */
        .add-moment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .add-moment-image-upload { 
            width: 100%; 
            aspect-ratio: 1/1; 
            background-color: #eaeaea; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 30px; color: #aaa; 
            border-radius: 8px; 
            position: relative; overflow: hidden; 
        }
        .add-moment-img-cell {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .add-moment-img-cell img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .add-moment-remove-img {
            position: absolute; top: 2px; right: 2px;
            background: rgba(0,0,0,0.5); color: white;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; cursor: pointer;
        }
        
        .moments-empty-placeholder {
            text-align: center;
            padding: 80px 20px;
            color: #bbb;
            background-color: #fff;
        }

        /* --- NEW: Moments Comment MODAL (Updated) --- */
        #moments-comment-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1900;
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #moments-comment-overlay.active {
            display: block;
            opacity: 1;
        }
        #moments-comment-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #F7F7F7; /* Input area background - Light Gray */
            padding: 10px 15px calc(10px + env(safe-area-inset-bottom, 0px));
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #moments-comment-modal.active {
            transform: translateY(0);
        }
        #moments-comment-input {
            flex: 1;
            height: 40px;
            padding: 0 15px;
            border-radius: 20px; /* Rounded rectangle */
            border: 1px solid #EAEAEA; /* Faint border */
            background-color: #FCFCFC; /* Near white/Very light gray */
            font-size: 15px;
            outline: none;
            color: #333;
            margin-bottom: 0;
        }
        #moments-comment-input::placeholder {
            color: #999;
        }
        #moments-comment-input:focus {
            background-color: #FFFFFF;
        }
        .moments-emoji-btn {
            width: 30px;
            height: 30px;
            object-fit: contain;
            cursor: pointer;
            flex-shrink: 0;
        }
        #moments-comment-submit-btn {
            border: none;
            background: none;
            color: var(--theme-pink-text);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            padding: 5px;
            white-space: nowrap;
        }


        /* --- Me Page 重构样式 --- */
        .me-page-container { width: 100%; display: flex; flex-direction: column; height: auto; max-height: 100vh; }
        .me-cover-area { width: 100%; height: 20vh; min-height: 260px; background-color: #ddd; background-size: cover; background-position: center; position: relative; cursor: pointer; transition: background-image 0.3s ease; }
        .me-cover-area::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(0,0,0,0.15)); pointer-events: none; }
        .me-like-wrapper { position: absolute; bottom: 5px; right: 20px; display: flex; flex-direction: column; align-items: center; gap: 4px; z-index: 5; }
        .me-setting-wrapper { position: absolute; top: 33px; right: 20px; z-index: 5; transition: top 0.3s ease; }
        .me-setting-icon { width: 24px; height: 24px; object-fit: contain; cursor: pointer; transition: transform 0.2s; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
        .me-setting-icon:active { transform: scale(0.9); }
        .me-like-icon { width: 24px; height: 24px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); cursor: pointer; transition: transform 0.2s; }
        .me-like-icon:active { transform: scale(1.2) rotate(-10deg); }
        .me-like-count { color: white; font-size: 13px; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.6); cursor: pointer; text-align: center; }
        .me-content-area { flex: 1; background-color: var(--chat-bg-color); position: relative; padding-top: 60px; }
        .me-floating-header { position: absolute; top: 0; left: 25px; width: calc(100% - 50px); transform: translateY(-50%); display: flex; align-items: center; z-index: 10; }
        .me-avatar-box { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; overflow: hidden; flex-shrink: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.15); background: #fff; transition: all 0.3s ease; }
        .me-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .me-text-col { margin-left: 15px; display: flex; flex-direction: column; justify-content: center; }
        .me-nickname { font-size: 20px; font-weight: 700; color: #FFFFFF; margin-bottom: 6px; cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .me-qq-id { font-size: 13px; color: #555; cursor: pointer; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
        .me-info-list { margin: 10px 20px; background: white; border-radius: 16px; padding: 5px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; }
        .me-list-item { display: flex; align-items: center; padding: 15px 20px; background: white; cursor: pointer; transition: background-color 0.2s; }
        .me-list-item:active { background-color: #f9f9f9; }
        .me-list-item:not(:last-child) { border-bottom: 1px solid #f5f5f5; }
        .me-list-icon { width: 24px; height: 24px; object-fit: contain; margin-right: 15px; transition: all 0.3s ease; }
        .me-list-text { flex: 1; font-size: 15px; color: #333; font-weight: 500; display: flex; align-items: center; overflow: hidden; }
        
        /* MODIFIED: CSS for arrow image */
        .me-list-arrow {
            width: 16px;
            height: 16px;
            margin-left: 10px;
        }

        .me-member-icons-row { display: flex; align-items: center; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; }
        .me-member-icons-row::-webkit-scrollbar { display: none; }
        .me-member-icon-slot { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; flex-shrink: 0; }

        /* --- Me Page Settings Modal --- */
        #me-settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--theme-pink-bg-light); z-index: 700; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: transform 0.3s ease, opacity 0.3s ease; transform: translateY(100%); }
        #me-settings-modal.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .me-settings-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 35px 20px 15px; background: white; box-shadow: 0 1px 5px rgba(0,0,0,0.05); flex-shrink: 0; transition: padding-top 0.3s ease; }
        .me-settings-header-title { font-size: 18px; font-weight: 600; color: #333; }
        .me-settings-close-btn { font-size: 16px; color: #666; cursor: pointer; background: none; border: none; }
        .me-settings-save-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 6px 16px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .me-settings-scroll-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .me-settings-group { background-color: white; border-radius: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); }
        .me-settings-group h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .me-settings-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .me-settings-label { width: 50px; font-size: 13px; color: #555; font-weight: 500; flex-shrink: 0; }
        .me-settings-preview-wrapper { flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .me-settings-preview { background-color: #f9f9f9; border: 1px solid #eee; background-size: cover; background-position: center; object-fit: contain; }
        .me-settings-preview.avatar { width: 40px; height: 40px; border-radius: 50%; }
        .me-settings-preview.cover { width: 60px; height: 40px; border-radius: 6px; object-fit: cover; }
        .me-settings-preview.icon { width: 30px; height: 30px; border-radius: 6px; }
        .me-settings-input { flex: 1; padding: 10px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; font-size: 13px; outline: none; transition: border-color 0.2s; color: #555; min-width: 0; }
        .me-settings-input:focus { border-color: var(--theme-pink-text); background-color: #fff; }

        /* --- Wallet App Style --- */
        #wallet-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #FDF6F9; z-index: 550;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.wallet-active #wallet-app-page { transform: translateY(0); }
        
        .wallet-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background-color: transparent; flex-shrink: 0;
            transition: padding-top 0.3s ease;
        }
        .wallet-user-area { display: flex; align-items: center; }
        .wallet-avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            margin-right: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid white; cursor: pointer;
        }
        .wallet-nickname { font-size: 16px; font-weight: 600; color: #333; cursor: pointer; }
        .wallet-close-btn {
            font-size: 14px; font-weight: 600; color: #999;
            background: rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; backdrop-filter: blur(5px);
        }
        .wallet-content {
            flex: 1; padding: 10px 20px 30px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
        }
        .wallet-balance-card {
            background: var(--wallet-gradient); border-radius: 24px; padding: 30px 25px;
            color: white; box-shadow: var(--wallet-card-shadow); position: relative;
            overflow: hidden; flex-shrink: 0; display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 180px;
        }
        .wallet-balance-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%); pointer-events: none;
        }
        .wallet-balance-label { font-size: 14px; opacity: 0.9; margin-bottom: 10px; font-weight: 500; }
        .wallet-balance-amount { font-size: 42px; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .wallet-stats-row { display: flex; gap: 15px; }
        .wallet-stat-box {
            flex: 1; background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column;
        }
        .wallet-stat-label { font-size: 13px; color: #888; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .wallet-stat-label.in::before { content: '↓'; color: var(--success-green); font-weight: bold; }
        .wallet-stat-label.out::before { content: '↑'; color: var(--error-red); font-weight: bold; }
        .wallet-stat-val { font-size: 18px; font-weight: 600; color: #333; }
        .wallet-actions { display: flex; gap: 15px; }
        .wallet-btn {
            flex: 1; padding: 15px; border-radius: 18px; border: none;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.1s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .wallet-btn:active { transform: scale(0.98); }
        .wallet-btn.income { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .wallet-btn.expense { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        .wallet-list-container {
            flex: 1; background: white; border-radius: 24px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02); min-height: 200px; display: flex; flex-direction: column;
        }
        .wallet-list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;
        }
        .wallet-list-title { font-size: 16px; font-weight: 600; color: #333; }
        .wallet-month-badge { background: #f0f0f0; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #666; }
        .wallet-items-scroll { flex: 1; overflow-y: auto; }
        .wallet-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }
        .wallet-item:last-child { border-bottom: none; }
        .wallet-item-icon {
            width: 40px; height: 40px; border-radius: 12px; background: #FDF6F9;
            display: flex; justify-content: center; align-items: center; font-size: 20px; margin-right: 12px;
        }
        .wallet-item-info { flex: 1; }
        .wallet-item-cat { font-size: 15px; color: #333; font-weight: 500; margin-bottom: 4px; }
        .wallet-item-date { font-size: 12px; color: #999; }
        .wallet-item-amount { font-size: 16px; font-weight: 600; }
        .wallet-item-amount.in { color: var(--success-green); }
        .wallet-item-amount.out { color: var(--error-red); }
        .wallet-empty { text-align: center; color: #ccc; margin-top: 40px; font-size: 14px; }

        /* 记账弹窗 */
        #wallet-add-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 600;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        #wallet-add-modal.active { opacity: 1; pointer-events: auto; }
        .wallet-add-card {
            background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #wallet-add-modal.active .wallet-add-card { transform: scale(1); }
        .wallet-modal-title { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 20px; color: #333; }
        .wallet-input-group { margin-bottom: 15px; }
        .wallet-input { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee; background: #f9f9f9; font-size: 16px; outline: none; }
        .wallet-input:focus { background: white; border-color: var(--theme-pink-text); }
        .wallet-type-select { display: flex; gap: 10px; margin-bottom: 20px; }
        .wallet-type-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #eee; background: #fff; color: #666; font-size: 14px; cursor: pointer; transition: all 0.2s;
        }
        .wallet-type-btn.active.in { background: rgba(76, 175, 80, 0.1); border-color: var(--success-green); color: var(--success-green); font-weight: 600; }
        .wallet-type-btn.active.out { background: rgba(244, 67, 54, 0.1); border-color: var(--error-red); color: var(--error-red); font-weight: 600; }
        .wallet-confirm-btn { width: 100%; padding: 14px; background: var(--theme-pink-text); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .wallet-cancel-btn { width: 100%; padding: 10px; background: transparent; color: #999; border: none; margin-top: 10px; cursor: pointer; font-size: 14px; }

        /* --- 添加好友弹窗样式 --- */
        #add-friend-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        #add-friend-modal.active { opacity: 1; pointer-events: auto; }
        .add-friend-card { width: 80%; max-width: 320px; background: white; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; align-items: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; }
        #add-friend-modal.active .add-friend-card { transform: scale(1); }
        .add-friend-close { position: absolute; top: 15px; left: 15px; font-size: 24px; color: #999; cursor: pointer; line-height: 1; }
        .add-friend-save { position: absolute; top: 15px; right: 15px; width: 24px; height: 24px; cursor: pointer; transition: transform 0.2s; }
        .add-friend-save:active { transform: scale(0.9); }
        .add-friend-avatar-upload { width: 100px; height: 100px; border-radius: 50%; background-color: #f0f0f0; margin-top: 15px; margin-bottom: 10px; cursor: pointer; overflow: hidden; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; color: #ccc; font-size: 40px; }
        .add-friend-avatar-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        .add-friend-url-input { width: 100%; padding: 8px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; margin-bottom: 15px; font-size: 12px; outline: none; color: #666; text-align: center; }
        .add-friend-url-input::placeholder { color: #aaa; }
        .add-friend-input { width: 100%; padding: 12px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 12px; margin-bottom: 12px; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .add-friend-input:focus { border-color: var(--theme-pink-text); background-color: white; }

        /* --- 删除确认弹窗 (通用) --- */
        .delete-confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 800; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .delete-confirm-modal.active { opacity: 1; pointer-events: auto; }
        .delete-card { background: white; width: 80%; max-width: 280px; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transform: scale(0.9); transition: transform 0.2s; }
        .delete-confirm-modal.active .delete-card { transform: scale(1); }
        .delete-card-title { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 25px; }
        .delete-card-actions { display: flex; justify-content: space-around; gap: 10px; }
        .delete-card-btn { flex: 1; padding: 10px 0; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-confirm-delete { background: #ffebee; color: #F44336; }


        /* --- 纯平面长椭圆底栏 (Chat App) --- */
        .chat-bottom-bar-container { position: fixed; bottom: calc(env(safe-area-inset-bottom, 20px) + 15px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; height: 64px; background-color: #FFFFFF; border-radius: 32px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.03); display: flex; justify-content: space-evenly; align-items: center; 
        z-index: 501; }
        .chat-nav-item { flex: 1; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0.5; transition: opacity 0.2s ease; }
        .chat-nav-item.active { opacity: 1; }
        .chat-nav-icon { width: 28px; height: 28px; object-fit: contain; pointer-events: none; }

        /* --- 全屏设置页面 --- */
        #settings-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--theme-pink-bg-light); z-index: 100; display: flex; flex-direction: column; padding: 20px 15px env(safe-area-inset-bottom, 20px) 15px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), padding-top 0.3s ease; overflow-x: hidden; }
        body.settings-active #settings-page { transform: translateY(0); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .settings-header .back-btn-container { display: flex; align-items: center; }
        .settings-header .title { font-size: 18px; font-weight: 600; color: #333; }
        #save-settings-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 8px 20px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .settings-content { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .settings-module { background-color: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); width: 100%; }
        .settings-module h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .settings-row { display: flex; flex-direction: column; align-items: stretch; margin-bottom: 15px; }
        .settings-row label { width: 100%; font-size: 14px; color: #555; margin-bottom: 6px; font-weight: 500; }
        .settings-row input, .settings-row button, .settings-row select { width: 100%; border: 1px solid #ddd; background-color: #f9f9f9; border-radius: 8px; padding: 10px; font-size: 14px; color: #333; outline: none; -webkit-appearance: none; min-width: 0; }
        .input-with-preview { display: flex; align-items: center; gap: 10px; width: 100%; }
        .input-with-preview input { flex: 1; min-width: 0; }
        .url-preview { width: 45px; height: 45px; border-radius: 8px; flex-shrink: 0; background-size: cover; background-position: center; border: 1px solid #eee; background-color: #f0f0f0; }
        .api-control-wrapper { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .api-control-row { display: flex; align-items: center; justify-content: space-between; }
        .api-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; }
        .api-status.connected { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .api-status.disconnected { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        .api-control-buttons { display: flex; gap: 10px; }
        .api-control-buttons button { flex: 1; white-space: nowrap; }
        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after { content: '▾'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }
        .settings-row select { padding-right: 30px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .temp-slider-container { display: flex; align-items: center; width: 100%; gap: 10px; }
        #temp-slider { flex: 1; padding: 0; height: 20px; }
        #temp-value-display { font-size: 14px; color: #555; min-width: 30px; text-align: right; }
        .app-icon-item { display: flex; align-items: center; margin-bottom: 12px; padding: 10px; border-radius: 12px; background-color: #f9f9f9; }
        .app-icon-preview { width: 40px; height: 40px; border-radius: 10px; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; background-size: cover; background-position: center; background-color: rgba(229, 138, 171, 0.1); }
        .app-icon-info { flex: 1; min-width: 0; }
        .app-icon-name { font-weight: 500; margin-bottom: 6px; color: #333; font-size: 13px; }
        .app-icon-input { display: flex; gap: 8px; }
        .app-icon-input input { flex: 1; min-width: 0; padding: 6px 8px; font-size: 12px; }
        .app-icon-input button { padding: 6px 12px; width: auto; font-size: 12px; background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; }
        
        /* --- iOS Mode Switch Styles (Generic row with switch) --- */
        .settings-row-with-switch {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0; /* Adjusted padding */
            margin-bottom: 5px;
        }
        .settings-row-with-switch > label {
            margin-bottom: 0;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
            flex-shrink: 0;
        }
        .ios-switch input { opacity: 0; width: 0; height: 0; }
        .ios-switch .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s;
        }
        .ios-switch .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s;
        }
        .ios-switch input:checked + .slider { background-color: #FFC0CB; }
        .ios-switch input:focus + .slider { box-shadow: 0 0 1px #FFC0CB; }
        .ios-switch input:checked + .slider:before { transform: translateX(20px); }
        .ios-switch .slider.round { border-radius: 34px; }
        .ios-switch .slider.round:before { border-radius: 50%; }
        
        /* --- MODIFIED: iOS Mode Active Global Styles --- */
        body.ios-mode-active #time-section { padding-top: env(safe-area-inset-top, 20px); }
        body.ios-mode-active .chat-app-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); } 
        body.ios-mode-active #role-settings-page { padding-top: calc(env(safe-area-inset-top, 20px) + 20px); }
        body.ios-mode-active .me-settings-header-bar { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .me-setting-wrapper { top: calc(env(safe-area-inset-top, 20px) + 20px); } /* MODIFIED: Move down setting icon on Me page */
        body.ios-mode-active .wallet-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active #settings-page { padding-top: env(safe-area-inset-top, 20px); }
        body.ios-mode-active .wb-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .wb-detail-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .wb-color-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .add-moment-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .forum-header-home, 
        body.ios-mode-active #forum-detail-header,
        body.ios-mode-active .forum-post-top-bar { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active #mall-app-page .mall-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        
                /* --- 修复：转账页返回按钮位置更靠上 --- */
        .transfer-back-btn {
            position: absolute;
            /* 原来是 calc(env(...) + 20px)，现在直接改为 10px，让它贴近边缘 */
            top: 13px; 
            left: 20px;
            width: 30px; height: 30px;
            object-fit: contain; cursor: pointer;
            z-index: 900; /* 提高层级，防止被遮挡 */
        }

        #toast-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background-color: rgba(255, 230, 240, 0.98); color: #E58AAB; padding: 15px 25px; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; text-align: center; max-width: 80%; }
        #toast-notification.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .file-input-hidden { display: none; }

        /* AI Chat UI */
        #ai-chat-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #ai-chat-modal.active { opacity: 1; pointer-events: all; }
        #ai-chat-container { width: 90%; max-width: 500px; height: 80%; background-color: white; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #ai-chat-modal.active #ai-chat-container { transform: translateY(0); }
        .chat-header { padding: 15px 20px; background-color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .chat-header .model-name { font-weight: 600; color: #333; font-size: 16px; }
        .chat-header .close-btn { background: #f0f0f0; border: none; width: 28px; height: 28px; border-radius: 14px; font-size: 18px; cursor: pointer; color: #999; display: flex; align-items: center; justify-content: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background-color: #fcfcfc; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 14px; word-wrap: break-word; }
        .message.user { background-color: var(--theme-pink-text); color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background-color: #f0f0f0; color: #333; margin-right: auto; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 12px 15px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); border-top: 1px solid #f0f0f0; display: flex; gap: 10px; background-color: white; }
        .chat-input-area input { flex: 1; padding: 10px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 20px; font-size: 14px; outline: none; }
        .chat-input-area button { padding: 0 18px; background-color: var(--theme-pink-text); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; }

        /* --- World Book App Styles --- */
        #worldbook-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--theme-pink-bg-soft);
            z-index: 550;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.worldbook-active #worldbook-app-page { transform: translateY(0); }
        
        .wb-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border-radius: 0 0 25px 25px; z-index: 10;
            transition: padding-top 0.3s ease;
        }
        .wb-back-btn-img {
            width: 30px; height: 30px; object-fit: contain; cursor: pointer;
        }
        .wb-title { font-size: 18px; font-weight: 600; color: var(--theme-pink-title); letter-spacing: 0.5px; }
        .wb-header-actions { display: flex; align-items: center; gap: 15px; }
        .wb-action-icon { width: 24px; height: 24px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .wb-action-icon:hover { opacity: 1; }
        .wb-add-btn { font-size: 28px; color: var(--wb-plus-btn); cursor: pointer; line-height: 1; font-weight: 300; }
        
        .wb-content {
            flex: 1; padding: 20px; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px; align-content: start;
        }
        .wb-book-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .wb-book-item:active { transform: scale(0.95); }
        
        .wb-book-cover {
            width: 90px; height: 120px;
            background: linear-gradient(135deg, #f5f5f5 0%, #EAEAEA 100%);
            border-radius: 4px 8px 8px 4px;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.1), inset 4px 0 10px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center; padding: 10px;
            position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.08);
            transition: background 0.3s;
            background-size: cover;
            background-position: center;
        }
        .wb-book-cover::before {
            content: ''; position: absolute; left: 4px; top: 0; width: 2px; height: 100%;
            background: rgba(0,0,0,0.05); box-shadow: 2px 0 0 rgba(0,0,0,0.05);
        }
        .wb-book-name { font-size: 13px; font-weight: 600; color: #555; text-align: center; word-break: break-all; line-height: 1.4; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }

        #worldbook-add-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 600; backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #worldbook-add-modal.active { opacity: 1; pointer-events: auto; }
        .wb-modal-card {
            background: var(--theme-pink-bg-soft);
            width: 90%; max-width: 380px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 8px 30px rgba(229, 138, 171, 0.25);
            max-height: 85vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #worldbook-add-modal.active .wb-modal-card { transform: scale(1); }
        .wb-modal-header { font-size: 17px; font-weight: 600; color: var(--theme-pink-text); text-align: center; margin-bottom: 20px; flex-shrink: 0; }
        
        .wb-modal-scroll-area { flex: 1; overflow-y: auto; margin: -10px -10px 15px; padding: 10px 10px 0; }
        
        .wb-input-label { font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 600; padding-left: 5px; }
        .wb-main-input { width: 100%; padding: 12px; border: 1px solid #FADBE6; background: #fff; border-radius: 12px; outline: none; font-size: 15px; margin-bottom: 15px; }
        .wb-main-input:focus { border-color: var(--theme-pink-btn); box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3); }

        .wb-entry-row {
            display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding: 15px;
            background-color: #ffffff; border-radius: 12px; border: 1px solid #FADBE6;
        }
        .wb-entry-input {
            width: 100%; border: none; background: #f9f9f9;
            border-radius: 8px; padding: 10px; font-size: 14px;
            outline: none; transition: all 0.2s;
        }
        .wb-entry-input.val { min-height: 120px; resize: vertical; line-height: 1.5; }
        .wb-entry-input:focus { background: white; border-color: var(--theme-pink-btn); box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3); }
        
        .wb-plus-row-btn {
            width: 100%; padding: 10px; margin-top: 15px; border: 2px dashed #FDCEDF; background: transparent;
            color: var(--theme-pink-btn); border-radius: 12px; cursor: pointer; font-size: 22px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        .wb-plus-row-btn:active { background: rgba(253, 206, 223, 0.3); }
        
        .wb-modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; flex-shrink: 0; }
        .wb-action-btn { padding: 10px 25px; border-radius: 20px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; }
        .wb-btn-cancel { background: transparent; color: #aaa; }
        .wb-btn-ok { background: var(--theme-pink-btn); color: white; box-shadow: 0 4px 10px rgba(245, 179, 201, 0.4); }

        #worldbook-detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--theme-pink-bg-soft); z-index: 650;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #worldbook-detail-modal.active { transform: translateX(0); }
        .wb-detail-header {
             padding: 35px 20px 15px;
             display: flex; align-items: center; gap: 15px; background: white;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-shrink: 0;
             transition: padding-top 0.3s ease;
        }
        .wb-detail-back { font-size: 24px; color: #333; cursor: pointer; }
        .wb-detail-title { flex: 1; font-size: 18px; font-weight: 600; color: var(--theme-pink-text); }
        .wb-delete-book-btn {
            background-color: var(--theme-pink-btn); color: white;
            padding: 6px 16px; border-radius: 15px; border: none; font-size: 14px;
            font-weight: 500; cursor: pointer; transition: opacity 0.2s; white-space: nowrap;
        }
        .wb-delete-book-btn:active { opacity: 0.8; }
        
        .wb-detail-content { flex: 1; padding: 20px; overflow-y: auto; }
        .wb-detail-item {
            margin-bottom: 15px; background: white; border-radius: 12px;
            padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }
        .wb-detail-item-content { flex: 1; }
        .wb-detail-key { font-size: 13px; color: #999; font-weight: 500; margin-bottom: 6px; }
        .wb-detail-val { font-size: 16px; color: #333; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }

        .wb-detail-item-actions { display: flex; gap: 10px; align-self: flex-end; margin-top: 15px; }
        .wb-detail-item-actions button {
            background: #f0f0f0; border: none; border-radius: 8px; padding: 5px 12px;
            font-size: 12px; color: #666; cursor: pointer;
        }
        .wb-detail-item-actions button.save { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); }
        .wb-detail-item .edit-form textarea { min-height: 80px; }


        #worldbook-color-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--theme-pink-bg-light); z-index: 700;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #worldbook-color-page.active { transform: translateY(0); }
        .wb-color-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: padding-top 0.3s ease;
        }
        .wb-color-title { font-size: 18px; font-weight: 600; color: var(--theme-pink-text); }
        .wb-color-save-btn {
            background-color: var(--theme-pink-btn); color: white; border: none; border-radius: 15px;
            padding: 8px 20px; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .wb-color-content { flex: 1; overflow-y: auto; padding: 20px; }
        .wb-color-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .wb-color-item-name { font-size: 15px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .wb-color-input {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 40px; height: 40px; background: none; border: none;
            cursor: pointer; padding: 0; border-radius: 8px;
        }
        .wb-color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .wb-color-input::-webkit-color-swatch { border: 1px solid #ddd; border-radius: 8px; }
        .wb-color-input::-moz-color-swatch { border: 1px solid #ddd; border-radius: 8px; }
        .wb-cover-upload-btn {
            padding: 6px 12px; background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text);
            border-radius: 8px; font-size: 12px; border: none; cursor: pointer;
        }


        #worldbook-bind-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 900; /* MODIFIED: Increased z-index */ backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #worldbook-bind-modal.active { opacity: 1; pointer-events: auto; }
        .wb-bind-modal-card {
            background: white;
            width: 85%; max-width: 340px; border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            max-height: 70vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #worldbook-bind-modal.active .wb-bind-modal-card { transform: scale(1); }
        .wb-bind-modal-header {
            padding: 15px 20px;
            font-size: 16px; font-weight: 600; color: var(--theme-pink-text);
            text-align: center; border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .wb-bind-modal-header .close-btn {
            font-size: 20px; color: #aaa; cursor: pointer;
        }
        .wb-bind-modal-list {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .wb-bind-list-item {
            padding: 15px;
            font-size: 15px; color: #333;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wb-bind-list-item:last-child {
            border-bottom: none;
        }
        .wb-bind-list-item:hover {
            background-color: #f9f9f9;
        }
        .wb-bind-list-item:active {
            background-color: #f0f0f0;
        }
        .wb-bind-list-empty {
            text-align: center; color: #ccc;
            padding: 40px 20px; font-size: 14px;
        }
        .wb-bind-modal-actions {
            display: none; /* Hide by default */
            padding: 10px 20px;
            border-top: 1px solid #f0f0f0;
            justify-content: flex-end;
        }
        .wb-bind-modal-card.multi-select-mode .wb-bind-modal-actions {
            display: flex; /* Show in multi-select mode */
        }
        .wb-bind-list-item.multi {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .wb-bind-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ddd;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            transition: all 0.2s ease;
        }
        .wb-bind-checkbox.checked {
            background: var(--theme-pink-btn);
            border-color: var(--theme-pink-btn);
        }
        .wb-bind-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* --- NEW: Moments Action Sheet (Popup) --- */
        #moments-action-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            backdrop-filter: blur(2px);
        }
        #moments-action-sheet-overlay.active { opacity: 1; pointer-events: auto; }
        
        #moments-action-sheet {
            background-color: var(--theme-pink-bg-soft);
            width: 95%; max-width: 400px;
            margin: 0 auto 15px; /* Bottom margin */
            border-radius: 20px;
            overflow: hidden;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        #moments-action-sheet-overlay.active #moments-action-sheet { transform: translateY(0); }
        
        .action-sheet-option {
            background: white;
            padding: 18px;
            text-align: center;
            font-size: 16px;
            color: #333;
            font-weight: 500;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .action-sheet-option:active { background-color: #f9f9f9; }
        .action-title { font-size: 16px; color: #333; }
        .action-subtitle { font-size: 12px; color: #999; margin-top: 2px; }
        
        .action-sheet-cancel {
            background: white;
            padding: 18px;
            text-align: center;
            font-size: 16px;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px; /* Visual separation */
            border-radius: 20px;
        }
        .action-sheet-cancel:active { background-color: #f9f9f9; }

        /* --- NEW/MODIFIED: Forum App Styles --- */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        #forum-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #FFF5F7; /* 极浅粉背景 */
            z-index: 560;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.forum-active #forum-app-page {
            transform: translateY(0);
        }

        #forum-content-wrapper {
            flex: 1;
            overflow-y: hidden; /* Prevent scrolling on the main wrapper */
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .forum-page {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            overflow-y: auto; /* Allow individual pages to scroll */
            padding-bottom: 100px;
        }
        .forum-page.active {
            display: flex;
        }
        
        /* 论坛首页专属顶部栏 */
        .forum-header-home {
            padding: 15px 15px 10px 15px;
            background-color: #fff;
            border-radius: 0 0 24px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 15;
            box-shadow: 0 4px 15px rgba(200, 150, 160, 0.08);
            flex-shrink: 0;
        }
        
        .forum-header-back-btn,
        .forum-header-create-btn,
        .forum-header-refresh-btn {
            width: 30px; height: 30px;
            object-fit: contain; cursor: pointer; flex-shrink: 0;
        }

        .forum-header-title {
            font-size: 18px; font-weight: 600; color: #f5b3c9;
        }

        /* 论坛列表 (4xN Grid) */
        #forum-list-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px 15px;
            flex-shrink: 0;
        }
        
        .forum-list-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .forum-list-item:active {
            transform: scale(0.95);
        }
        .forum-list-avatar {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 18px;
            object-fit: cover;
            background-color: #f0f0f0;
            box-shadow: 0 4px 10px rgba(229, 138, 171, 0.2);
        }
        .forum-list-name {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 帖子区 */
        #forum-posts-area, #forum-detail-posts-area {
            padding: 0 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* MODIFIED: Added padding-top */
        #forum-detail-posts-area {
            padding-top: 15px;
        }
        .forum-post-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }
        .forum-post-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
        }
        .forum-post-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .forum-post-user-info { display: flex; flex-direction: column; }
        .forum-post-user { font-size: 14px; font-weight: 600; color: #333; }
        .forum-post-level {
            background-color: #F8C8DC; color: white;
            font-size: 10px; font-weight: bold;
            padding: 2px 6px; border-radius: 4px;
            margin-left: 6px;
            display: inline-block;
        }
        .forum-post-time { font-size: 12px; color: #999; margin-left: auto; }
        
        /* MODIFIED for preview content and tags */
        .forum-post-content {
            font-size: 15px; 
            line-height: 1.5; 
            color: #444; 
            white-space: pre-wrap; 
            word-break: break-word;
        }
        .forum-post-content.truncated {
            max-height: 100px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        .forum-post-content.truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: linear-gradient(to bottom, transparent, white);
            pointer-events: none;
        }
        .forum-post-tags {
            margin-top: 8px;
            font-size: 13px;
            color: var(--link-blue);
            word-break: break-all;
        }
        
        .forum-post-actions {
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid #f5f5f5;
        }
        .forum-post-action-btn {
            display: flex; align-items: center; gap: 5px;
            color: #888; font-size: 13px; cursor: pointer;
        }
        .forum-post-action-btn img {
            width: 20px; height: 20px; object-fit: contain;
        }

        /* NEW: Styles for generated post feedback */
        .forum-post-feedback {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f5f5f5;
        }
        .forum-post-feedback.hidden {
            display: none;
        }
        .forum-post-comments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .forum-post-comment-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px; /* Square with rounded corners */
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }
        .comment-body {
            flex: 1;
            min-width: 0;
        }
        .comment-nickname {
            font-size: 13px;
            font-weight: 600;
            color: var(--moments-nickname-color);
            margin-bottom: 2px;
        }
        .comment-text {
            font-size: 14px;
            line-height: 1.4;
            color: #444;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .comment-reply-tag {
            color: var(--link-blue);
            font-weight: 500;
        }

        /* Forum Detail Page Styles */
        #forum-detail-header {
            padding: 15px; background-color: #fff;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 15;
            box-shadow: 0 4px 15px rgba(200, 150, 160, 0.08);
            border-radius: 0 0 24px 24px;
            flex-shrink: 0;
            gap: 10px; /* MODIFIED: Added gap for spacing */
        }
        /* Forum Square Avatar */
        .forum-detail-header-avatar {
             width: 32px; height: 32px;
             border-radius: 6px; 
             object-fit: cover; 
             margin-right: 10px; margin-left: 5px;
             background-color: #eee;
             flex-shrink: 0;
        }
        #forum-detail-header-name {
            font-size: 18px; 
            font-weight: 600; 
            color: #555;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            flex-shrink: 1; /* MODIFIED: Allow name to shrink */
        }
        #forum-detail-signin-btn {
            padding: 6px 12px; border: 1px solid var(--theme-pink-btn);
            color: var(--theme-pink-btn); background-color: transparent;
            border-radius: 15px; font-size: 13px; font-weight: 600;
            cursor: pointer; white-space: nowrap;
        }
        #forum-detail-signin-btn:disabled {
            border-color: #ccc; color: #ccc; cursor: not-allowed;
        }
        #forum-detail-header .actions { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-left: auto; /* MODIFIED: Pushes to the right */
        }
        
        /* NEW: Level and XP Bar Styles */
        #forum-detail-level-display { display: flex; align-items: center; gap: 8px; }
        .forum-exp-bar-wrapper { 
            position: relative; 
            width: 70px; 
            height: 8px; 
            background-color: #f0f0f0; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        .forum-exp-bar-progress { 
            height: 100%; 
            background-color: var(--theme-pink-btn); 
            border-radius: 4px;
            width: 0%; /* JS will set this */
            transition: width 0.3s ease;
        }


        /* New Forum Post Interface Styles */
        #forum-page-post { background-color: #FFF5F7; }
        .forum-post-top-bar {
            padding: 15px 20px 10px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: #FFF5F7; flex-shrink: 0; position: sticky; top: 0; z-index: 10;
        }
        .forum-post-cancel { border: none; background: none; font-size: 16px; color: #888; cursor: pointer; }
        .forum-post-title { font-size: 17px; font-weight: 600; color: #333; }
        .forum-post-submit { 
            background-color: #F8C8DC; color: #333; border: none; 
            padding: 6px 15px; border-radius: 20px; font-weight: 600; font-size: 14px; cursor: pointer;
        }
        .forum-post-editor {
            flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .forum-selector-wrapper {
            background: white; padding: 10px 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .forum-selector-label { font-size: 14px; color: #666; font-weight: 500; }
        .forum-selector-select {
            border: none; background: transparent; font-size: 14px; color: #E58AAB; font-weight: 600; outline: none; text-align: right;
        }
        .forum-post-textarea {
            width: 100%; min-height: 150px; background: transparent; border: none; outline: none;
            font-size: 16px; line-height: 1.5; color: #333; resize: none;
        }
        .forum-post-image-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .forum-post-add-img {
            aspect-ratio: 1/1; background-color: rgba(253, 206, 223, 0.3); border-radius: 12px;
            display: flex; justify-content: center; align-items: center; color: #FDCEDF; font-size: 32px; cursor: pointer;
        }
        .forum-post-img-preview {
            aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; position: relative;
        }
        .forum-post-img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .forum-post-img-remove {
            position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
            background: rgba(0,0,0,0.5); border-radius: 50%; color: white;
            display: flex; justify-content: center; align-items: center; font-size: 12px; cursor: pointer;
        }


        /* 悬浮胶囊底栏 */
        #forum-bottom-nav {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 20px) + 15px);
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 360px;
            height: 65px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 999px; /* Capsule shape */
            box-shadow: 0 8px 25px rgba(200, 150, 160, 0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 20;
        }
        .forum-nav-item {
            flex: 1;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .forum-nav-item:active {
            transform: scale(0.9);
        }
        .forum-nav-icon {
            width: 28px;
            height: 28px;
            object-fit: contain;
            opacity: 0.4;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .forum-nav-item.active .forum-nav-icon {
            opacity: 1;
            transform: scale(1.1);
        }

        /* --- 创建论坛弹窗 --- */
        #create-forum-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 850;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #create-forum-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #create-forum-modal-card {
            background: #FFF8FA;
            width: 90%; max-width: 350px;
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            gap: 15px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #create-forum-modal-overlay.active #create-forum-modal-card {
            transform: scale(1);
        }
        .create-forum-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--theme-pink-text);
            text-align: center;
            margin-bottom: 5px;
        }
        .create-forum-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .create-forum-avatar-upload {
            width: 90px;
            height: 90px;
            border-radius: 16px; /* square with rounded corners */
            border: 2px dashed #FDCEDF;
            background-color: rgba(253, 206, 223, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            color: #FDCEDF;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        #new-forum-avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            position: absolute;
            top: 0; left: 0;
        }
        .create-forum-input, .create-forum-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #FADBE6;
            background: #fff;
            border-radius: 12px;
            outline: none;
            font-size: 15px;
            color: #333;
        }
        .create-forum-input:focus, .create-forum-textarea:focus {
            border-color: var(--theme-pink-btn);
            box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3);
        }
        .create-forum-textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }
        .create-forum-wb-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background-color: var(--theme-pink-bg-med);
            color: var(--theme-pink-text);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        #new-forum-wb-selection-display, #new-forum-role-selection-display {
            width: 100%;
            padding: 10px;
            font-size: 13px;
            color: #999;
            background-color: #f9f9f9;
            border-radius: 8px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .create-forum-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .create-forum-btn {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .create-forum-btn.cancel {
            background: #eee;
            color: #888;
        }
        .create-forum-btn.confirm {
            background: var(--theme-pink-btn);
            color: white;
        }

        /* Forum Me Page New Styles */
        #forum-me-nickname {
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            margin-bottom: 5px;
            /* Removed contenteditable styles */
        }
        .forum-me-menu-list {
            margin: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .forum-me-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f9f9f9;
            cursor: pointer;
        }
        .forum-me-menu-item:last-child { border-bottom: none; }
        .forum-me-menu-item .menu-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 15px; color: #333; font-weight: 500;
        }

        /* MODIFIED: CSS for arrow image */
        .forum-me-menu-item .arrow {
            width: 16px;
            height: 16px;
        }

        .bound-chars-row {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .bound-chars-row img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Styles for Forum Me Settings Modal */
        #forum-me-settings-modal {
            background-color: rgba(0,0,0,0.4);
            z-index: 950; /* High z-index */
        }
        #forum-bind-character-list .character-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        #forum-bind-character-list .character-item:hover { background-color: #f0f0f0; }
        #forum-bind-character-list .character-item input[type=checkbox] { 
            width: 18px; height: 18px; margin-right: 12px; accent-color: var(--theme-pink-text); 
        }
        #forum-bind-character-list .character-item img { 
            width: 32px; height: 32px; border-radius: 6px; margin-right: 10px; object-fit: cover; 
        }
        #forum-bind-character-list .character-item span {
            font-size: 14px;
            color: #333;
        }

        /* --- Mall App Styles (MODIFIED) --- */
        #mall-app-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #ffffff; /* 白色背景 */
            z-index: 555;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.mall-active #mall-app-page {
            transform: translateY(0);
        }

        .mall-header {
            padding: 35px 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff; /* 纯白色背景 */
            flex-shrink: 0;
            border-bottom: 1px solid var(--text-light-gray, #f0f0f0);
            transition: padding-top 0.3s ease;
            position: relative; /* For title centering */
            z-index: 10;
        }
        .mall-header .back-btn {
            width: 30px;
            height: 30px;
            object-fit: contain;
            cursor: pointer;
        }
        .mall-header-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--theme-pink-title); /* 浅粉色 #f5b3c9 */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .mall-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .mall-header-actions .refresh-btn {
            width: 24px;
            height: 24px;
            object-fit: contain;
            cursor: pointer;
        }
        .mall-add-btn {
            width: 32px;
            height: 32px;
            background-color: var(--theme-pink-btn); /* 粉色背景 #F5B3C9 */
            border: none;
            border-radius: 50%;
            color: white; /* 白色图标 */
            font-size: 22px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            line-height: 1;
            padding-bottom: 2px; /* Visual centering for '+' */
        }

        .mall-category-nav {
            display: flex;
            overflow-x: auto;
            background-color: #fff;
            padding: 0 15px;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0; /* 浅灰色分割线 */
        }
        /* Hide scrollbar */
        .mall-category-nav::-webkit-scrollbar { display: none; }
        .mall-category-nav { scrollbar-width: none; }

        .mall-category-item {
            padding: 12px 10px;
            font-size: 15px;
            font-weight: 500;
            color: var(--theme-pink-text); /* 未选中：浅粉色文字 #E58AAB */
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            flex-shrink: 0;
            margin: 0 5px;
        }
        
        .mall-content {
            flex: 1;
            overflow-y: auto;
            background-color: var(--theme-pink-bg-soft); /* 柔和粉色系背景 */
            padding: 20px;
            color: #333; /* 深灰色常规文字 */
            padding-bottom: 80px; /* MODIFIED: Space for bottom nav */
        }
        .mall-content h1 { color: #333; }
        .mall-content p { color: #888; } /* 浅灰色次要文字 */
        
        /* NEW: Mall Bottom Nav Bar */
        .mall-bottom-nav {
            background-color: #ffffff;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-around;
            padding: 5px 0 calc(5px + env(safe-area-inset-bottom, 0));
            flex-shrink: 0;
        }
        .mall-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex: 1;
            padding: 5px 0;
        }
        .mall-nav-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        .mall-nav-text {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        .mall-nav-item.active .mall-nav-text {
            color: var(--theme-pink-text);
        }
        
        /* --- [REFACTORED] Transfer Page Styles --- */
        #transfer-page {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #ffabce; /* Top part's color is the new page background */
            z-index: 800;
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
            padding: 0;
        }
        #transfer-page.active {
            transform: translateX(0);
        }
        .transfer-page-top {
            height: 15vh; /* [FIXED] Reduced height */
            min-height: 130px; /* [FIXED] Reduced min-height */
            background-color: #ffabce;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 0 20px 20px;
            position: relative;
            flex-shrink: 0;
        }
        .transfer-page-bottom {
            flex: 1;
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 30px 20px calc(20px + env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
        }
        .transfer-title-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #transfer-target-name-container {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }
        .transfer-target-avatar {
            width: 60px; height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .transfer-amount-title {
            font-size: 15px;
            color: #000;
            margin-bottom: 20px;
            margin-top: 15px;
        }
        .transfer-amount-input-area {
            display: flex;
            align-items: baseline;
            border-bottom: 1px solid #f0d8e2;
            padding-bottom: 15px;
        }
        .transfer-currency-symbol {
            font-size: 2.5rem;
            font-weight: bold;
            color: #000;
        }
        .transfer-amount-input {
            flex: 1;
            width: auto;
            border: none;
            background: transparent;
            outline: none;
            font-size: 3.5rem;
            font-weight: bold;
            color: #000;
            margin-left: 10px;
            padding: 0;
            -moz-appearance: textfield;
        }
        .transfer-amount-input::-webkit-outer-spin-button,
        .transfer-amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* --- [REFACTORED] Transfer Confirmation Popup Styles --- */
        #transfer-confirm-overlay {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 850;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #transfer-confirm-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #transfer-confirm-popup {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #transfer-confirm-overlay.active #transfer-confirm-popup {
            transform: translateY(0);
        }
        .confirm-popup-header {
            padding: 15px;
            text-align: center;
            position: relative;
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .confirm-popup-close {
            position: absolute;
            left: 15px; top: 50%;
            transform: translateY(-50%);
            width: 24px; height: 24px;
            cursor: pointer;
        }
        .confirm-popup-content {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        #confirm-transfer-target {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
        }
        #confirm-transfer-amount {
            font-size: 36px;
            font-weight: bold;
            color: #000;
            margin-bottom: 20px;
        }
        .confirm-payment-method {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            padding-top: 15px;
        }
        .confirm-payment-method > span {
            font-size: 15px; color: #888;
        }
        .payment-method-details {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #fffaf3; /* 浅米黄色 */
            padding: 8px 12px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        .payment-icon { width: 20px; height: 20px; }
        .payment-method-details > span { font-size: 15px; color: #333; }
        .payment-check { width: 16px; height: 16px; margin-left: 5px; }

        .password-input-section {
            padding: 20px;
            text-align: center;
            background: #ffffff;
        }
        .password-input-section p {
            font-size: 15px;
            color: #333;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .password-boxes {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .password-box {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 12px; 
            background: #f6f2f4; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        .password-box.filled::after {
            content: '●';
            color: #333;
        }
        .password-error-tip {
            color: var(--error-red);
            height: 1.2em;
            font-size: 13px !important;
            margin-bottom: 0 !important;
        }

        .numeric-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background-color: #f6f2f4;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .keypad-btn {
            padding: 15px 0;
            font-size: 24px;
            border: none;
            background-color: #fff;
            cursor: pointer;
            margin: 0.5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            color: #000;
        }
        .keypad-btn:active {
            background-color: #d1d5db;
        }
        .keypad-btn.blank, .keypad-btn.delete {
            background-color: transparent;
            box-shadow: none;
        }
        .keypad-btn.delete img {
            width: 28px; height: 28px;
            pointer-events: none;
        }

                /* --- 3. 手机框模式下：支付密码弹窗的强力修复 --- */
        
        /* 缩小整个弹窗的头部内边距 */
        body.phone-frame-active .confirm-popup-header {
            padding: 10px 10px 5px 10px;
            font-size: 15px;
        }

        /* 缩小内容区域（转账对象和金额）的间距 */
        body.phone-frame-active .confirm-popup-content {
            padding: 10px 15px;
        }
        
        /* 缩小显示的金额字体 */
        body.phone-frame-active #confirm-transfer-amount {
            font-size: 26px !important;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* 调整“付款方式”那一行的高度 */
        body.phone-frame-active .confirm-payment-method {
            padding-top: 5px;
            gap: 4px;
        }
        body.phone-frame-active .payment-method-details {
            padding: 5px 8px;
        }

        /* 压缩密码输入区域的上下间距 */
        body.phone-frame-active .password-input-section {
            padding: 10px 0 5px 0;
            margin-bottom: 0;
        }
        body.phone-frame-active .password-input-section p {
            margin-bottom: 8px;
            font-size: 13px;
        }

        /* 缩小 6 个密码框的尺寸 */
        body.phone-frame-active .password-box {
            width: 32px !important;
            height: 32px !important;
            font-size: 14px;
            border-radius: 6px;
            margin: 0 2px;
        }

        /* 强制去除键盘底部的安全距离（因为手机框里不需要） */
        body.phone-frame-active .numeric-keypad {
            padding-bottom: 0 !important;
            background-color: #f6f2f4;
        }

        /* 压扁数字键盘的按钮高度 */
        body.phone-frame-active .keypad-btn {
            padding: 8px 0 !important; /* 减少内边距 */
            height: 42px !important;   /* 强制固定高度 */
            font-size: 18px !important;
            line-height: 42px; /* 让文字垂直居中 */
        }

        /* 缩小删除按钮的图标 */
        body.phone-frame-active .keypad-btn.delete img {
            width: 20px; 
            height: 20px;
            vertical-align: middle;
        }
        
        /* 确保弹窗在手机框内绝对定位到底部 */
        body.phone-frame-active #transfer-confirm-popup {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            transform: translateY(100%); /* 默认隐藏 */
        }
        /* 激活状态 */
        body.phone-frame-active #transfer-confirm-overlay.active #transfer-confirm-popup {
            transform: translateY(0);
        }
        
       /* --- 手机外框 - 新增与修改 --- */
        #app-wrapper {
          width: 100%;
          height: 100%;
          position: relative;
          background-size: cover;
          background-position: center;
        }
        
        body.phone-frame-active #home-screen {
            padding-top: var(--status-bar-height);
        }
        body.phone-frame-active .chat-app-header,
        body.phone-frame-active .wallet-header,
        body.phone-frame-active .wb-header,
        body.phone-frame-active .mall-header,
        body.phone-frame-active .forum-header-home,
        body.phone-frame-active #forum-detail-header,
        body.phone-frame-active .forum-post-top-bar,
        body.phone-frame-active #settings-page > .settings-header,
        body.phone-frame-active #me-settings-modal > .me-settings-header-bar,
        body.phone-frame-active #worldbook-detail-modal > .wb-detail-header,
        body.phone-frame-active #worldbook-color-page > .wb-color-header,
        body.phone-frame-active #add-moment-modal > .add-moment-header,
        body.phone-frame-active #role-settings-page > .role-setting-close-area,
        body.phone-frame-active #chat-conversation-view > .chat-conv-header {
            padding-top: calc(15px + var(--status-bar-height));
        }
        
        body.phone-frame-active #app-wrapper > div[id*="-page"],
        body.phone-frame-active #app-wrapper > div[id*="-modal"],
        body.phone-frame-active #app-wrapper > div[id*="-overlay"],
        body.phone-frame-active #app-wrapper > .delete-confirm-modal {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .phone-container {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: none;
          justify-content: center;
          align-items: center;
          background: #f0f0f0;
          z-index: 9999;
        }
        
        body.phone-frame-active .phone-container {
          display: flex;
        }
        
        .phone{
          width: 390px;
          height: 780px;
          background: #050505;
          background-clip: padding-box; 
          border-radius: 48px;
          padding: 6px;
          position: relative;
          box-shadow: 0 0 40px rgba(0,0,0,0.5);
          border: 6px solid var(--phone-case-color);
          transition: border-color 0.3s;
        }
        
        body.cat-ears-active .phone::before,
        body.cat-ears-active .phone::after {
            content: '';
            position: absolute;
            top: -20px;
            width: 50px;
            height: 50px;
            background-color: var(--cat-ear-color);
            z-index: -1;
            transition: background-color 0.3s;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        body.cat-ears-active .phone::before {
            left: 30px;
            transform: rotate(-45deg);
        }

        body.cat-ears-active .phone::after {
            right: 30px;
            transform: rotate(45deg);
        }

        .screen{
          width: 100%;
          height: 100%;
          border-radius: 36px;
          overflow: hidden;
          position: relative;
          background: transparent;
          background-size: cover;
          background-position: center;
        }
        
        .notch{
          position: absolute;
          top: 10px;
          left: 50%;
          transform: translateX(-50%);
          width: 130px;
          height: 34px;
          background: #000;
          border-radius: 18px;
          z-index: 10010;
          pointer-events: none;
        }
        
        .status-bar{
          height: var(--status-bar-height);
          padding: 0 14px;
          display: flex;
          align-items: flex-start;
          font-size: 16px;
          font-weight: 600;
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          z-index: 10009;
          color: #fff;
          pointer-events: none;
        }
        
        .status-time{
          margin-left: 18px;
          color: #000;
          padding-top: 14px;
        }
        
        .status-right{
          position: absolute;
          top: 14px;
          right: 20px;
          display: flex;
          gap: 8px;
          align-items: center;
        }
        .status-right img{
          height: 14px;
        }
        
                         /* --- 新增：收款弹窗样式 (已应用新布局和颜色) --- */
        #receive-transfer-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: white; 
            z-index: 2000; 
            display: flex;
            flex-direction: column;
            /* 1. 修改：整体布局，内容上移，按钮下沉 */
            justify-content: space-between; 
            padding-top: 100px; /* 让顶部内容块从导航栏下方开始 */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #receive-transfer-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .receive-back-btn {
            position: absolute;
            top: 13px; 
            left: 20px;
            width: 30px; height: 30px;
            object-fit: contain; cursor: pointer;
            z-index: 2001;
            transition: top 0.3s ease;
        }
        body.phone-frame-active .receive-back-btn {
            top: calc(15px + var(--status-bar-height));
        }
        body.ios-mode-active .receive-back-btn {
            top: calc(env(safe-area-inset-top, 20px) + 15px);
        }
        
        .receive-card {
            /* 1. 修改：移除 flex:1 和 justify-content, 让它自然地待在顶部 */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 0 30px;
            background: transparent;
            transform: none !important;
            box-shadow: none;
        }
        
        .receive-icon { width: 60px; height: 60px; margin-bottom: 10px; }
        .receive-status { font-size: 18px; color: #333; font-weight: 500; }
        /* 2. 修改：金额字体缩小 */
        .receive-amount { font-size: 48px; font-weight: bold; color: #000; margin: 10px 0 30px 0; }
        
        .receive-info-section {
            width: 100%;
            padding: 20px 0;
            border-top: 1px solid #ddd;
            /* 3. 修改：移除底部横线 */
            border-bottom: none; 
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            color: #666;
        }
        .receive-info-value { color: #333; }
        
        .receive-actions-footer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 30px);
        }
        
        .receive-confirm-btn {
            /* 4. 修改：收款按钮长度缩短一半 */
            width: 40%;
            max-width: 300px;
            padding: 14px;
            background: #06C755;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .receive-reject-btn {
            background: none;
            border: none;
            color: #667588;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
        }
        /* --- NEW: Styles for Urge Post Modal --- */
        .urge-post-char-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 5px;
            transition: all 0.2s;
        }
        .urge-post-char-item.selected {
            border-color: var(--theme-pink-btn);
            background-color: var(--theme-pink-bg-med);
        }
        .urge-post-char-item img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 5px;
        }
        .urge-post-char-item span {
            font-size: 12px;
            color: #666;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
<div id="app-wrapper">
<div id="home-screen">
    <div id="time-section">
        <div id="time-container" onclick="handleTimeBgClick(event)">
            <div id="clock-time">12:00</div>
            <div id="clock-date" onclick="handleDateEdit(event)">2026年02月10日 星期二</div>
        </div>
    </div>
    <div id="grid-area">
        <div class="grid-quadrant" id="avatar-quadrant-1">
            <div id="chat-dual-container">
                <div class="chat-row left">
                    <div class="avatar-container" onclick="editChatAvatarUrl('chat-avatar-1')">
                        <div class="avatar-ring">
                            <div class="avatar-img-circle" id="chat-avatar-1" style="background-image: url('https://img.heliar.top/file/1770068438490_添加人群_people-plus.png');"></div>
                        </div>
                    </div>
                    <input type="text" class="chat-bubble-input left-bubble" value="Say Hi~" oninput="adjustInputWidth(this)">
                </div>
                <div class="chat-row right">
                    <div class="avatar-container" onclick="editChatAvatarUrl('chat-avatar-2')">
                        <div class="avatar-ring">
                            <div class="avatar-img-circle" id="chat-avatar-2" style="background-image: url('https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png');"></div>
                        </div>
                    </div>
                    <input type="text" class="chat-bubble-input right-bubble" value="Hello!" oninput="adjustInputWidth(this)">
                </div>
            </div>
        </div>

                <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item" onclick="openChatApp()">
                    <div class="app-icon" id="icon-app1">☁️</div>
                    <span class="app-name" data-app-name="Chat">Chat</span>
                </div>
                <div class="app-item" onclick="openWorldBookApp()"><div class="app-icon" id="icon-app2">🎵</div><span class="app-name" data-app-name="世界书">世界书</span></div>
                <div class="app-item" onclick="openForumApp()"><div class="app-icon" id="icon-app3">💬</div><span class="app-name" data-app-name="论坛">论坛</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app4">📸</div><span class="app-name" data-app-name="相册">相册</span></div>
            </div>
        </div>
        <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item"><div class="app-icon" id="icon-app5">🧭</div><span class="app-name" data-app-name="HUshhh">HUshhh</span></div>
                <div class="app-item" onclick="openMallApp()"><div class="app-icon" id="icon-app6">🎮</div><span class="app-name" data-app-name="商城">商城</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app7">📅</div><span class="app-name" data-app-name="日历">日历</span></div>
                <div class="app-item" onclick="openWalletApp()"><div class="app-icon" id="icon-app8">💰</div><span class="app-name" data-app-name="Wallet">Wallet</span></div>
            </div>
        </div>

        <div class="grid-quadrant" id="photo-widget-quadrant">
            <div class="photo-widget-container" onclick="triggerPhotoWidgetUpload()">
                <div id="photo-widget-placeholder" class="photo-widget-placeholder">
                    <div class="photo-widget-icon">📷</div>
                    <div class="photo-widget-text">Add Photo</div>
                </div>
                <img id="photo-widget-img" class="photo-widget-img" src="">
            </div>
        </div>
    </div>
    <div id="dock-area">
        <div class="dock-container">
            <div class="app-item" onclick="showSettingsPage()"><div class="app-icon dock-icon" id="icon-dock-settings">⚙️</div></div>
            <div class="app-item" onclick="openAIChat()"><div class="app-icon dock-icon" id="icon-dock-ai">🤖</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-safari">🧭</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-messages">✉️</div></div>
        </div>
    </div>
</div>

<!-- Chat App 页面 -->
<div id="chat-app-page">
    <div class="chat-app-header" id="chat-app-header-el">
        <!-- MODIFIED: Container for left icons -->
        <div id="chat-header-left-icons" style="display: flex; gap: 15px; z-index: 2;">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-icon-img" id="chat-back-btn" onclick="closeChatApp()">
            <img id="urge-post-icon" src="https://img.heliar.top/file/1770904788245_喜欢_like_5.png" class="back-icon-img" onclick="openUrgeToPostModal()" style="display: none;">
        </div>
        <div class="chat-header-title" id="chat-page-title">Chat</div>
        <!-- 右上角图标容器 -->
        <div id="chat-header-right-icons" style="display: flex; gap: 15px; z-index: 2;">
            <img id="chat-header-add-friend-icon" src="https://img.heliar.top/file/1770068438490_添加人群_people-plus.png" class="header-right-icon" onclick="openAddFriendModal()">
            <img id="chat-header-add-moment-icon" src="https://img.heliar.top/file/1770345149331_相机_camera.png" class="header-right-icon" onclick="openMomentsActionSheet()" style="display: none;">
        </div>
    </div>
    
    <div class="chat-app-content" id="chat-content-area">
        <div id="chat-tab-0" class="chat-tab-content active">
            <div class="chat-list-container" id="chat-list-container">
                <!-- Chat list dynamically generated -->
            </div>
        </div>
        <div id="chat-tab-1" class="chat-tab-content">
            <div class="contact-list-container" id="contact-list-container">
                 <!-- Contacts dynamically generated -->
            </div>
            <div class="alpha-index-bar" id="alpha-index-bar"></div>
        </div>
        <div id="chat-tab-2" class="chat-tab-content">
            <!-- NEW: Moments page will be rendered here -->
            <div id="moments-page-wrapper"></div>
        </div>
        
        <div id="chat-tab-3" class="chat-tab-content">
            <div class="me-page-container">
                <div class="me-cover-area" id="profile-cover">
                    <div class="me-like-wrapper">
                        <img src="https://img.heliar.top/file/1770079217317_赞_thumbs-up_2.png" class="me-like-icon" onclick="incrementLikeCount(event)">
                        <div class="me-like-count" id="profile-like-count" onclick="incrementLikeCount(event)">8888</div>
                    </div>
                    <div class="me-setting-wrapper">
                        <img src="https://img.heliar.top/file/1770083061419_设置_setting-two.png" class="me-setting-icon" onclick="openMeSettings()">
                    </div>
                </div>
                <div class="me-content-area">
                    <div class="me-floating-header">
                        <div class="me-avatar-box">
                            <img id="profile-avatar" class="me-avatar-img" src="" onerror="this.src='https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'">
                        </div>
                        <div class="me-text-col">
                            <div class="me-nickname" id="profile-nickname" onclick="editNickname(event)">User Name</div>
                            <div class="me-qq-id" id="profile-qq-id" onclick="editQQID(event)">QQ: 20261314520</div>
                        </div>
                    </div>
                    <div class="me-info-list">
                        <div class="me-list-item" onclick="editSignature()">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081937488_人员_people.png">
                            <div class="me-list-text" id="profile-signature-text">这个人很懒，什么都没留下~</div>
                            <img class="me-list-arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                        </div>
                        <div class="me-list-item">
                            <img id="me-member-icon-main" class="me-list-icon" src="https://img.heliar.top/file/1770081928967_vip_vip-one.png">
                            <div class="me-list-text">
                                <div id="me-member-icon-container" class="me-member-icons-row"></div>
                            </div>
                            <img class="me-list-arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                        </div>
                        <div class="me-list-item">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081938581_星星_star-one.png">
                            <div class="me-list-text">QQ空间</div>
                            <img class="me-list-arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="chat-bottom-bar-container">
        <div class="chat-nav-item active" onclick="switchChatTab(0, 'Chat')">
            <img src="https://img.heliar.top/file/1770068139630_信息_message_3.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(1, '通讯录')">
            <img src="https://img.heliar.top/file/1770068141129_通讯录_address-book_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(2, '朋友圈')">
            <img src="https://img.heliar.top/file/1770068142240_朋友圈_friends-circle_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(3, '我')">
            <img src="https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png" class="chat-nav-icon">
        </div>
    </div>

    <!-- 角色聊天专属页面 -->
    <div id="chat-conversation-view">
        <div id="chat-extra-menu">
            <div class="chat-menu-item">
                <img src="https://img.heliar.top/file/1770713133852_红包_red-envelopes.png" class="chat-menu-icon">
                <span class="chat-menu-text">红包</span>
            </div>
            <div class="chat-menu-item" onclick="openTransferPage()">
                <img src="https://img.heliar.top/file/1770713126016_支出_expenses-one.png" class="chat-menu-icon">
                <span class="chat-menu-text">转账</span>
            </div>
            <div class="chat-menu-item">
                <img src="https://img.heliar.top/file/1770713131222_淘宝_taobao_2.png" class="chat-menu-icon">
                <span class="chat-menu-text">淘宝</span>
            </div>
            <div class="chat-menu-item" onclick="openWalletApp()">
                <img src="https://img.heliar.top/file/1770721898565_支付宝_alipay.png" class="chat-menu-icon">
                <span class="chat-menu-text">钱包</span>
            </div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
        </div>
        <div class="chat-conv-header">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="chat-conv-back-btn" onclick="closeChatConversation()">
            <div class="chat-conv-title-container">
                <div class="chat-conv-title" id="chat-conv-title">角色名称</div>
                <div class="chat-conv-signature" id="chat-conv-signature"></div>
            </div>
            <img class="chat-conv-right-icon" src="https://img.heliar.top/file/1770241189848_更多_more.png" onclick="openRoleSettings()">
        </div>
        <div class="chat-conv-messages" id="chat-conv-messages"></div>
        <div class="chat-conv-footer">
            <button class="chat-conv-btn" onclick="toggleChatExtraMenu()"><img src="https://img.heliar.top/file/1770239041392_开关_power.png" style="width: 24px; height: 24px; object-fit: contain;"></button>
            <div class="chat-conv-input-wrapper">
                <input type="text" class="chat-conv-input" id="chat-conv-input" placeholder="输入消息..." onkeydown="handleChatInputKey(event)">
            </div>
            <button class="chat-conv-btn" style="margin-right: 0;"><img src="https://img.heliar.top/file/1770239038945_喜欢_like.png" style="width: 24px; height: 24px; object-fit: contain;"></button>
            <!-- 仅保留AI触发功能 -->
            <button class="chat-conv-btn send ai-trigger" onclick="triggerAIAutoReply()"><img src="https://img.heliar.top/file/1770239044304_发送_send.png" style="width: 20px; height: 20px; object-fit: contain;"></button>
        </div>
        <!-- Multiselect Footer -->
        <div class="chat-multiselect-footer" id="chat-multiselect-footer">
             <button class="chat-multiselect-delete-btn" onclick="executeBatchDelete()">删除</button>
        </div>
    </div>
</div>

<!-- 角色设置页面 -->
<div id="role-settings-page">
    <div class="role-setting-close-area">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="role-setting-back-btn" onclick="closeRoleSettings()">
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">角色设置 (Role)</div>
        <div class="role-avatar-edit-wrapper" onclick="triggerRoleAvatarEdit()">
            <img id="role-setting-avatar" class="role-avatar-edit" src="">
            <div class="avatar-edit-hint">✎</div>
        </div>
        <input type="text" id="role-setting-alias" class="role-alias-edit" placeholder="备注名">
        <input type="text" id="role-setting-signature" class="role-signature-edit" placeholder="角色签名...">
        <textarea id="role-setting-persona" class="role-persona-input" placeholder="输入角色人设 (Persona)..."></textarea>
        
        <!-- NEW: Time Perception Switch -->
        <div class="settings-row-with-switch" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px;">
            <label for="role-time-perception-switch">时间感知</label>
            <label class="ios-switch">
                <input type="checkbox" id="role-time-perception-switch">
                <span class="slider round"></span>
            </label>
        </div>

        <!-- NEW: Memory Depth Input -->
        <div class="settings-row" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px; display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
            <label for="role-memory-depth" style="margin-bottom:0;">记忆条数 (Memory)</label>
            <input type="number" id="role-memory-depth" placeholder="10" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
        </div>

        <div class="role-bg-upload-area" style="display: flex; flex-direction: column; gap: 10px; padding: 15px; margin-top: 15px;">
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <span style="font-size:13px; color:#555;">聊天背景</span>
                <div id="role-bg-preview" class="role-bg-preview"></div>
            </div>
            <input type="text" id="role-bg-url-input" placeholder="输入背景图片URL" style="width: 100%; padding: 10px; border: 1px solid #FADBE6; border-radius: 8px; font-size: 14px;">
            <div style="display: flex; gap: 10px;">
                <button class="role-bg-btn" onclick="triggerRoleBgUpload()">上传图片</button>
                <button class="role-bg-btn" onclick="setRoleBgByUrl()">应用URL</button>
            </div>
        </div>
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">角色世界书</div>
        <div class="role-wb-binding-area">
            <div id="role-wb-display" class="unbound">未绑定</div>
            <div class="actions">
                <button id="role-wb-clear-btn" onclick="clearWorldBookBinding()" style="display: none;">清除</button>
                <button onclick="openRoleWorldBookBindModal()">选择</button>
            </div>
        </div>
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">用户设置 (User)</div>
        <div class="user-avatar-row">
            <div class="user-avatar-edit-wrapper" onclick="triggerRoleUserAvatarEdit()">
                <img id="role-user-avatar" class="role-avatar-edit" src="https://img.heliar.top/file/1770068438490_添加人群_people-plus.png">
                <div class="avatar-edit-hint">✎</div>
            </div>
            <input type="text" id="role-user-name" class="user-name-input" placeholder="您的名字">
        </div>
        <textarea id="role-user-persona" class="role-persona-input" placeholder="输入您的人设 (User Persona)..."></textarea>
    </div>

    <!-- MODIFIED: Active Post Moment Section -->
    <div class="settings-section-card">
        <div class="settings-card-title">主动发动态</div>
        <div class="settings-row-with-switch" style="width:100%; padding: 10px 5px;">
            <label for="role-auto-post-switch">开启自动发动态</label>
            <label class="ios-switch">
                <input type="checkbox" id="role-auto-post-switch">
                <span class="slider round"></span>
            </label>
        </div>
        <div class="settings-row" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px; display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
            <label for="role-auto-post-interval" style="margin-bottom:0;">间隔时间 (分钟)</label>
            <input type="number" id="role-auto-post-interval" placeholder="10" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
        </div>
    </div>
    
    <!-- MODIFIED: CSS Preset Section -->
    <div class="settings-section-card">
         <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 15px;">
            <div class="settings-card-title" style="margin-bottom: 0; border-bottom: none;">自定义样式 (CSS)</div>
            <button class="role-bg-btn" onclick="openSaveCssPresetModal()">保存</button>
        </div>
        <textarea id="role-setting-css" class="role-css-input" placeholder="/* 在这里输入CSS代码修改气泡样式 */..."></textarea>
        
        <div style="width:100%; margin-top: 20px;">
            <div class="settings-card-title" style="margin-bottom: 10px;">预设样式列表</div>
             <div class="select-wrapper">
                <select id="css-preset-select" style="width:100%; padding: 10px; border:1px solid #eee; border-radius:8px;" onchange="handlePresetSelection(this)">
                    <!-- Options will be added here -->
                </select>
            </div>
            <div id="css-preset-actions" style="display: none; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                 <button class="role-bg-btn" onclick="applySelectedCssPreset()">应用</button>
                 <button class="role-bg-btn" style="background-color: #eee; color: #999;" onclick="deleteSelectedCssPreset()">删除</button>
            </div>
        </div>
    </div>

    <button class="role-save-btn" onclick="saveRoleSettings()">保存设置</button>
    <button class="role-delete-btn" onclick="confirmDeleteFriend()">删除好友</button>
</div>

<!-- NEW: Add Moment Modal -->
<div id="add-moment-modal">
    <div class="add-moment-header">
        <button class="add-moment-cancel" onclick="closeAddMomentModal()">取消</button>
        <button class="add-moment-post" onclick="saveNewMoment()">发表</button>
    </div>
    <div class="add-moment-content">
        <textarea id="add-moment-text" placeholder="这一刻的想法..."></textarea>
        <div class="add-moment-grid" id="add-moment-grid">
            <div class="add-moment-image-upload" onclick="triggerMomentImageUpload()">
                 <span id="moment-upload-icon">+</span>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Moments Comment MODAL (Updated Layout) -->
<div id="moments-comment-overlay" onclick="closeCommentInput()"></div>
<div id="moments-comment-modal">
    <input type="text" id="moments-comment-input" placeholder="发表评论:" onkeypress="handleCommentKey(event)">
    <img src="https://img.heliar.top/file/1770357295773_笑脸_smiling-face_2.png" class="moments-emoji-btn">
    <button id="moments-comment-submit-btn" onclick="submitComment()">发送</button>
</div>


<!-- Wallet App 页面 -->
<div id="wallet-app-page">
    <div class="wallet-header">
        <div class="wallet-close-btn" onclick="closeWalletApp()">✕</div>
        <div class="wallet-user-area">
            <img id="wallet-avatar" class="wallet-avatar" onclick="triggerProfileAvatarUpload(event)">
            <span id="wallet-nickname" class="wallet-nickname" onclick="editNickname(event)">User</span>
        </div>
    </div>
    <div class="wallet-content">
        <div class="wallet-balance-card">
            <div class="wallet-balance-label">总余额 (CNY)</div>
            <div class="wallet-balance-amount" id="wallet-total-balance">0.00</div>
        </div>
        <div class="wallet-stats-row">
            <div class="wallet-stat-box">
                <div class="wallet-stat-label in">本月收入</div>
                <div class="wallet-stat-val" id="wallet-month-income">0.00</div>
            </div>
            <div class="wallet-stat-box">
                <div class="wallet-stat-label out">本月支出</div>
                <div class="wallet-stat-val" id="wallet-month-expense">0.00</div>
            </div>
        </div>
        <!-- MODIFIED: Wallet Actions -->
        <div class="wallet-actions">
            <button class="wallet-btn income" onclick="openWalletModal('recharge')"><span>+</span> 充值</button>
        </div>
        <div class="wallet-list-container">
            <div class="wallet-list-header">
                <div class="wallet-list-title">本月明细</div>
                <div class="wallet-month-badge" id="wallet-current-month">2月</div>
            </div>
            <div class="wallet-items-scroll" id="wallet-transaction-list"></div>
        </div>
    </div>
</div>

<!-- World Book App Page -->
<div id="worldbook-app-page">
    <div class="wb-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="wb-back-btn-img" onclick="closeWorldBookApp()">
        <div class="wb-title">世界书>៸៸៸< </div>
        <div class="wb-header-actions">
             <img src="https://img.heliar.top/file/1770251413162_颜色滤镜_color-filter.png" class="wb-action-icon" onclick="openWorldBookColorSettings()">
            <div class="wb-add-btn" onclick="openWorldBookAddModal()">+</div>
        </div>
    </div>
    <div class="wb-content" id="worldbook-list"></div>
</div>

<!-- World Book Add Modal -->
<div id="worldbook-add-modal">
    <div class="wb-modal-card">
        <div class="wb-modal-header">添加世界书</div>
        <div class="wb-modal-scroll-area">
            <div class="wb-input-label">世界书名</div>
            <input type="text" id="wb-title-input" class="wb-main-input" placeholder="输入世界书名称...">
            <div id="wb-dynamic-entries">
                <div class="wb-entry-row wb-dynamic-row">
                    <input type="text" class="wb-entry-input key" placeholder="名称（可选）">
                    <textarea class="wb-entry-input val" placeholder="世界书内容"></textarea>
                </div>
            </div>
            <button class="wb-plus-row-btn" onclick="addWorldBookEntryRow()">+</button>
        </div>
        <div class="wb-modal-actions">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeWorldBookAddModal()">取消</button>
            <button class="wb-action-btn wb-btn-ok" onclick="saveWorldBook()">OK</button>
        </div>
    </div>
</div>

<!-- World Book Detail Modal -->
<div id="worldbook-detail-modal">
    <div class="wb-detail-header">
        <div class="wb-detail-back" onclick="closeWorldBookDetail()">＜</div>
        <div class="wb-detail-title" id="wb-detail-title-text">Title</div>
        <button class="wb-delete-book-btn" onclick="deleteCurrentWorldBook()">删除</button>
    </div>
    <div class="wb-detail-content" id="wb-detail-content-area"></div>
</div>

<!-- World Book Color Settings Page -->
<div id="worldbook-color-page">
    <div class="wb-color-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="wb-back-btn-img" onclick="closeWorldBookColorSettings()">
        <div class="wb-color-title">世界书设置</div>
        <button class="wb-color-save-btn" onclick="saveWorldBookColors()">OK</button>
    </div>
    <div class="wb-color-content" id="wb-color-list"></div>
</div>


<!-- MODIFIED: Wallet Recharge Modal -->
<div id="wallet-add-modal">
    <div class="wallet-add-card">
        <div class="wallet-modal-title">充值</div>
        <div class="wallet-input-group">
            <input type="number" id="wallet-amount-input" class="wallet-input" placeholder="0.00" step="0.01">
        </div>
        <button class="wallet-confirm-btn" onclick="saveRecharge()">确认充值</button>
        <button class="wallet-cancel-btn" onclick="closeWalletModal()">取消</button>
    </div>
</div>


<!-- 添加好友弹窗 -->
<div id="add-friend-modal">
    <div class="add-friend-card">
        <div class="add-friend-close" onclick="closeAddFriendModal()">✕</div>
        <img src="https://img.heliar.top/file/1770069003752_保存_save.png" class="add-friend-save" onclick="saveNewFriend()">
        <div class="add-friend-avatar-upload" onclick="triggerAvatarUpload()">
            <span id="avatar-placeholder-icon">+</span>
            <img id="new-friend-avatar-preview" class="add-friend-avatar-preview">
        </div>
        <input type="text" class="add-friend-url-input" id="new-friend-avatar-url" placeholder="或粘贴图片链接" oninput="handleAvatarUrlInput(this)">
        <input type="text" class="add-friend-input" id="new-friend-name" placeholder="姓名">
        <input type="text" class="add-friend-input" id="new-friend-alias" placeholder="备注 (可选)">
    </div>
</div>

<!-- 删除好友确认弹窗 -->
<div id="delete-friend-confirm-modal" class="delete-confirm-modal">
    <div class="delete-card">
        <div class="delete-card-title">确定删除该好友吗π_π</div>
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeDeleteModal('delete-friend-confirm-modal')">取消</button>
            <button class="delete-card-btn btn-confirm-delete" onclick="executeDeleteFriend()">删除</button>
        </div>
    </div>
</div>

<!-- NEW: 删除朋友圈确认弹窗 -->
<div id="delete-moment-confirm-modal" class="delete-confirm-modal">
    <div class="delete-card">
        <div class="delete-card-title">删除该朋友圈？</div>
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeDeleteModal('delete-moment-confirm-modal')">取消</button>
            <button class="delete-card-btn btn-confirm-delete" onclick="executeDeleteMoment()">删除</button>
        </div>
    </div>
</div>

<!-- World Book Binding Modal -->
<div id="worldbook-bind-modal">
    <div class="wb-bind-modal-card">
        <div class="wb-bind-modal-header">
            <span id="wb-bind-modal-title">选择绑定的世界书</span>
            <span class="close-btn" onclick="closeWorldBookBindModal()">✕</span>
        </div>
        <div class="wb-bind-modal-list" id="worldbook-bind-list"></div>
        <div class="wb-bind-modal-actions">
            <button class="wb-action-btn wb-btn-ok" onclick="confirmWbBinding()">确定</button>
        </div>
    </div>
</div>

<!-- NEW: Urge to Post Modal -->
<div id="urge-post-overlay" class="delete-confirm-modal" style="display: none;">
    <div id="urge-post-card" class="wb-modal-card" style="max-height: 70vh; background: white; width: 90%; max-width: 380px;" onclick="event.stopPropagation()">
        <div class="wb-modal-header" style="color: #facee4; font-size: 18px;">催ta发动态</div>
        <div id="urge-post-char-list" class="wb-modal-scroll-area" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px;">
            <!-- Characters will be dynamically added here -->
        </div>
        <div class="wb-modal-actions">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeUrgeToPostModal()">取消</button>
            <button class="wb-action-btn wb-btn-ok" onclick="confirmUrgeToPost()">确定</button>
        </div>
    </div>
</div>

<!-- NEW: Save CSS Preset Modal -->
<div id="save-preset-modal" class="delete-confirm-modal" style="display: none;">
    <div class="delete-card" onclick="event.stopPropagation()" style="text-align: left; padding: 20px;">
        <div class="delete-card-title" style="text-align: center; margin-bottom: 15px;">保存预设样式</div>
        <input type="text" id="preset-name-input" class="add-friend-input" placeholder="输入预设名称..." style="margin-bottom: 20px;">
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeSaveCssPresetModal()">取消</button>
            <button class="delete-card-btn wb-btn-ok" style="background:var(--theme-pink-btn); color:white;" onclick="saveCurrentCssPreset()">保存</button>
        </div>
    </div>
</div>


<!-- NEW: Moments Action Sheet (Popup) -->
<div id="moments-action-sheet-overlay" onclick="closeMomentsActionSheet()">
   <div id="moments-action-sheet" onclick="event.stopPropagation()">
       <div class="action-sheet-option" onclick="handleMomentAction('shoot')">
            <div class="action-title">拍摄</div>
            <div class="action-subtitle">照片或视频</div>
       </div>
       <div class="action-sheet-option" onclick="handleMomentAction('album')">从手机相册选择</div>
       <div class="action-sheet-cancel" onclick="closeMomentsActionSheet()">取消</div>
   </div>
</div>

<div id="settings-page">
    <div class="settings-header">
        <div class="back-btn-container" onclick="hideSettingsPage()">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-icon-img">
        </div>
        <span class="title">设置</span>
                <button id="save-settings-btn">OK</button>
    </div>
                
    <div class="settings-content">
        <div class="settings-module">
            <h3>通用</h3>
            <div class="settings-row-with-switch">
                <label for="ios-mode-switch">iOS 模式 (刘海屏适配)</label>
                <label class="ios-switch">
                    <input type="checkbox" id="ios-mode-switch">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="settings-row-with-switch" style="margin-top: 10px;">
                <label for="phone-frame-switch">手机框</label>
                <label class="ios-switch">
                    <input type="checkbox" id="phone-frame-switch">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        
        <!-- 新增手机壳与猫耳朵设置 -->
        <div class="settings-module" id="phone-frame-settings-module" style="display: none;">
            <h3>手机框设置</h3>
            <div class="settings-row-with-switch">
                <label for="cat-ears-switch">手机壳猫耳朵</label>
                <label class="ios-switch">
                    <input type="checkbox" id="cat-ears-switch">
                    <span class="slider round"></span>
                </label>
            </div>
             <div class="settings-row-with-switch" style="margin-top:10px;">
                <label for="phone-case-color-input">手机壳颜色</label>
                <input type="color" id="phone-case-color-input" value="#ffffff" style="width: 50px; height: 30px; border: 1px solid #ddd; padding: 2px; border-radius: 6px; cursor: pointer; background-color: transparent;">
            </div>
            <div class="settings-row-with-switch" style="margin-top:10px;">
                <label for="cat-ear-color-input">猫耳朵颜色</label>
                <input type="color" id="cat-ear-color-input" value="#ffffff" style="width: 50px; height: 30px; border: 1px solid #ddd; padding: 2px; border-radius: 6px; cursor: pointer; background-color: transparent;">
            </div>
        </div>
        
        <div class="settings-module">
            <h3>AI API 设置</h3>
            <div class="settings-row">
                <label for="api-url-input">API 地址</label>
                <input type="text" id="api-url-input" placeholder="例如: https://api.openai.com/v1">
            </div>
            <div class="settings-row">
                <label for="api-key-input">API Key</label>
                <input type="password" id="api-key-input" placeholder="输入您的 API Key">
            </div>
            <div class="settings-row">
                <label>模型设置</label>
                <div class="api-control-wrapper">
                    <div class="api-control-row">
                        <span id="api-status" class="api-status disconnected">未连接</span>
                    </div>
                    <div class="api-control-buttons">
                        <button id="test-api-btn">测试连接</button>
                        <button id="fetch-models-btn">获取模型列表</button>
                    </div>
                    <div class="select-wrapper" id="model-select-wrapper" style="display: none; margin-top: 10px;">
                        <select id="model-select"></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="settings-module">
            <h3>AI 参数设置</h3>
            <div class="settings-row">
                <label>回答温度 (Temperature)</label>
                <div class="temp-slider-container">
                    <input type="range" id="temp-slider" min="0" max="2" step="0.1" value="0.8">
                    <span id="temp-value-display">0.8</span>
                </div>
            </div>
        </div>
        <div class="settings-module">
            <h3>界面美化</h3>
            <div class="settings-row">
                <label for="wallpaper-url">主屏幕壁纸 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="wallpaper-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="wallpaper-preview"></div>
                </div>
            </div>
        </div>
        <div class="settings-module">
            <h3>组件图片</h3>
            <div class="settings-row">
                <label for="widget-square-url">左下组件 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="widget-square-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="widget-square-preview"></div>
                </div>
            </div>
            <div class="settings-row">
                <label for="custom-image-url">右上组件 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="custom-image-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="custom-image-preview"></div>
                </div>
            </div>
        </div>
        <div class="settings-module">
            <h3>自定义主屏幕App图标</h3>
            <div class="settings-app-list" id="settings-app-list-container"></div>
        </div>
                    <div class="settings-module">
            <h3>备份与恢复</h3>
            <p style="font-size: 12px; color: #999; margin-bottom: 15px;">导出的备份文件包含您的所有角色、聊天记录、设置和美化数据。请妥善保管。</p>
            <div class="api-control-buttons">
                <button onclick="exportBackup()">导出备份</button>
                <button onclick="document.getElementById('import-backup-input').click()">导入备份</button>
            </div>
        </div>
    </div>
</div>

<div id="ai-chat-modal">
    <div id="ai-chat-container">
        <div class="chat-header">
            <span class="model-name" id="current-model-name">未选择模型</span>
            <button class="close-btn" onclick="closeAIChat()">×</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai">你好！我是 AI 助手。请点击底栏第一个图标进入设置配置 API，然后我们就可以聊天了。</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="说点什么..." onkeypress="handleChatKeyPress(event)">
            <button id="send-chat-btn" onclick="sendChatMessage()">发送</button>
        </div>
    </div>
</div>

<div id="toast-notification"></div>

<div id="me-settings-modal">
    <div class="me-settings-header-bar">
        <button class="me-settings-close-btn" onclick="closeMeSettings()">关闭</button>
        <span class="me-settings-header-title">个人主页设置</span>
        <button class="me-settings-save-btn" onclick="saveMeSettings()">保存</button>
    </div>
    <div class="me-settings-scroll-content">
        <!-- 核心修复3：整合 昵称 QQ 点赞数 等功能到此 -->
        <div class="me-settings-group">
            <h3>个人资料</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">昵称</div>
                <input type="text" id="me-settings-nickname" class="me-settings-input" placeholder="输入昵称">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">QQ号</div>
                <input type="text" id="me-settings-qq-id" class="me-settings-input" placeholder="输入QQ号">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">点赞数</div>
                <input type="number" id="me-settings-likes" class="me-settings-input" placeholder="输入点赞数值">
            </div>
        </div>

                <div class="me-settings-group">
            <h3>界面信息</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">头像</div>
                <div class="me-settings-preview-wrapper" onclick="triggerProfileAvatarUpload()"><img id="me-settings-avatar-preview" class="me-settings-preview avatar" style="cursor:pointer;"></div>
                <input type="text" id="me-settings-avatar-url" class="me-settings-input" placeholder="头像 URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">背景</div>
                <div class="me-settings-preview-wrapper"><img id="me-settings-cover-preview" class="me-settings-preview cover"></div>
                <input type="text" id="me-settings-cover-url" class="me-settings-input" placeholder="背景图 URL">
            </div>
        </div>

        <!-- 👇👇👇 这是新添加的模块 👇👇👇 -->
        <div class="me-settings-group">
            <h3>安全设置</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">支付密码</div>
                <input type="text" id="me-settings-payment-password" class="me-settings-input" placeholder="设置6位数字密码" maxlength="6" inputmode="numeric" pattern="[0-9]*">
            </div>
        </div>
        <!-- 👆👆👆 新添加模块结束 👆👆👆 -->

        <div class="me-settings-group">
            <h3>会员图标列表 (8个)</h3>
            <div id="me-settings-member-icons-list">
                <!-- Dynamically generated -->
            </div>
        </div>
    </div>
</div>

<!-- Forum App 页面 -->
<div id="forum-app-page">
    <!-- 中间内容区 -->
    <div id="forum-content-wrapper">
        <!-- 首页 -->
        <div id="forum-page-home" class="forum-page active">
            <div class="forum-header-home">
                 <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="forum-header-back-btn" onclick="closeForumApp()">
                <h1 class="forum-header-title">论坛</h1>
                <img src="https://img.heliar.top/file/1770413434847_添加_add-one.png" class="forum-header-create-btn" onclick="openCreateForumModal()">
            </div>
            
            <div id="forum-list-container">
                <!-- Forum items will be injected here by JS -->
            </div>
            
            <div id="forum-posts-area">
                <!-- Forum posts feed placeholder -->
            </div>
        </div>

        <!-- NEW: 论坛详情页 -->
        <div id="forum-page-detail" class="forum-page">
            <div id="forum-detail-header">
                <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="forum-header-back-btn" onclick="closeForumDetail()">
                <img id="forum-detail-header-avatar" class="forum-detail-header-avatar" src="">
                <span id="forum-detail-header-name"></span>
                <div class="actions">
                    <div id="forum-detail-level-display">
<span id="forum-detail-level" style="font-weight: bold; color: var(--theme-pink-text); font-size: 13px;"></span>
                        <div class="forum-exp-bar-wrapper">
                            <div id="forum-detail-exp-bar" class="forum-exp-bar-progress"></div>
                        </div>
                    </div>
                     <span id="forum-detail-exp-text" style="font-size: 11px; color: #aaa; white-space: nowrap;"></span>
                    <button id="forum-detail-signin-btn">签到</button>
                    <img src="https://img.heliar.top/file/1770580892666_刷新_refresh.png" class="forum-header-refresh-btn" id="forum-detail-refresh-btn">
                </div>
            </div>
            <div id="forum-detail-posts-area">
                 <!-- Posts for the specific forum will be rendered here -->
            </div>
        </div>
        
        <!-- 发帖 -->
        <div id="forum-page-post" class="forum-page">
             <div class="forum-post-top-bar">
                 <button class="forum-post-cancel" onclick="switchForumTab(0)">取消</button>
                 <div class="forum-post-title">发帖</div>
                 <button class="forum-post-submit" onclick="submitForumPost()">发布</button>
             </div>
             <div class="forum-post-editor">
                 <div class="forum-selector-wrapper">
                     <span class="forum-selector-label">发布到</span>
                     <select id="forum-post-target-select" class="forum-selector-select">
                         <option value="">请选择吧群...</option>
                     </select>
                 </div>
                 <textarea id="forum-post-textarea" class="forum-post-textarea" placeholder="分享你的新鲜事..."></textarea>
                 <div class="forum-post-image-grid" id="forum-post-image-grid">
                     <div class="forum-post-add-img" onclick="triggerForumPostImageUpload()">+</div>
                 </div>
             </div>
        </div>
        <!-- 我 -->
        <div id="forum-page-me" class="forum-page">
            <div id="forum-me-profile-container" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1;">
                <div id="forum-me-bg" style="width: 100%; height: 260px; background-color: #e0e0e0; background-image: url('https://images.unsplash.com/photo-1501854140801-50d01698950b?auto=format&fit=crop&w=1000&q=80'); background-size: cover; background-position: center; cursor: pointer; flex-shrink: 0; position: relative;">
                    <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: linear-gradient(to top, rgba(0,0,0,0.4), transparent); pointer-events: none;"></div>
                </div>
                <div id="forum-me-header" style="padding: 0 20px; display: flex; flex-direction: column; margin-top: -60px; position: relative; z-index: 2; flex-shrink: 0;">
                    <div style="display: flex; align-items: flex-end; justify-content: space-between;">
                         <div style="display: flex; align-items: flex-end; gap: 15px;">
                            <img id="forum-me-avatar" src="https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                            <div style="padding-bottom: 5px;">
                                <div id="forum-me-nickname">User</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="forum-me-stats" style="display: flex; gap: 25px; margin-top: 15px; padding: 0 10px;">
                        <div style="text-align: center;"><span style="font-weight: 700; font-size: 16px; color: #333;">12</span><div style="font-size: 12px; color: #999;">帖子</div></div>
                        <div style="text-align: center;"><span style="font-weight: 700; font-size: 16px; color: #333;">482</span><div style="font-size: 12px; color: #999;">关注</div></div>
                        <div style="text-align: center;"><span style="font-weight: 700; font-size: 16px; color: #333;">9.8k</span><div style="font-size: 12px; color: #999;">粉丝</div></div>
                    </div>
                </div>

                <div class="forum-me-menu-list">
                     <div class="forum-me-menu-item">
                        <span class="menu-item-left">我的帖子</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                    <div class="forum-me-menu-item">
                        <span class="menu-item-left">收藏列表</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                    <div class="forum-me-menu-item">
                        <span class="menu-item-left">关注的人</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                     <div class="forum-me-menu-item" onclick="openForumMeSettings()">
                        <span class="menu-item-left">设置</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 悬浮胶囊底栏 -->
    <div id="forum-bottom-nav">
        <div class="forum-nav-item active" onclick="switchForumTab(0)">
            <img src="https://img.heliar.top/file/1770411000514_首页_home.png" class="forum-nav-icon">
        </div>
        <div class="forum-nav-item" onclick="switchForumTab(1)">
            <img src="https://img.heliar.top/file/1770411008165_添加_add.png" class="forum-nav-icon">
        </div>
        <div class="forum-nav-item" onclick="switchForumTab(2)">
            <img src="https://img.heliar.top/file/1770411008745_用户_user.png" class="forum-nav-icon">
        </div>
    </div>
</div>

<!-- 创建论坛弹窗 -->
<div id="create-forum-modal-overlay">
    <div id="create-forum-modal-card">
        <h2 class="create-forum-title">创建新论坛</h2>
        <div class="create-forum-content">
            <div class="create-forum-avatar-upload" onclick="triggerForumAvatarUpload()">
                <span id="forum-avatar-placeholder">+</span>
                <img id="new-forum-avatar-preview" src="">
            </div>
            <input type="text" id="new-forum-name-input" class="create-forum-input" placeholder="论坛名称">
            <textarea id="new-forum-worldview-input" class="create-forum-textarea" placeholder="论坛世界观... (可选)"></textarea>
            <div id="new-forum-wb-selection-display">未绑定世界书</div>
            <button class="create-forum-wb-btn" onclick="openForumWbBindModal()">绑定世界书 (可选)</button>
            <!-- NEW: Bind Roles Feature -->
            <div id="new-forum-role-selection-display">未绑定角色</div>
                        <button class="create-forum-wb-btn" onclick="openForumCreateRoleBindModal()">绑定角色 (可选)</button>
        </div>
        <div class="create-forum-actions">
            <button class="create-forum-btn cancel" onclick="closeCreateForumModal()">取消</button>
            <button class="create-forum-btn confirm" onclick="saveNewForum()">确认创建</button>
        </div>
    </div>
</div>

<!-- NEW: Forum Me Settings Modal -->
<div id="forum-me-settings-modal" class="delete-confirm-modal" style="display: none;">
    <div class="wb-modal-card" onclick="event.stopPropagation()" style="background: var(--theme-pink-bg-soft);">
        <div class="wb-modal-header" style="background: transparent; border: none; padding-bottom: 0;">论坛个人设置</div>
        <div class="wb-modal-scroll-area">
            <h3 class="settings-module-title" style="font-size:15px;color:#555;margin-bottom:10px; padding-left: 5px;">个人资料</h3>
            <div class="me-settings-group" style="padding:15px;">
                <div class="me-settings-row">
                    <div class="me-settings-label">头像</div>
                    <div class="me-settings-preview-wrapper" onclick="triggerForumMeAvatarUpload()">
                        <img id="forum-me-settings-avatar-preview" class="me-settings-preview avatar" style="cursor:pointer;">
                    </div>
                    <input type="text" id="forum-me-settings-avatar-url" class="me-settings-input" placeholder="头像 URL">
                </div>
                 <div class="me-settings-row" style="margin-top: 15px;">
                    <div class="me-settings-label">背景</div>
                    <div class="me-settings-preview-wrapper" onclick="triggerForumMeBgUpload()">
                        <img id="forum-me-settings-bg-preview" class="me-settings-preview cover" style="cursor:pointer;">
                    </div>
                    <input type="text" id="forum-me-settings-bg-url" class="me-settings-input" placeholder="背景 URL">
                </div>
                <div class="me-settings-row" style="margin-top: 15px;">
                    <div class="me-settings-label">昵称</div>
                    <input type="text" id="forum-me-settings-nickname" class="me-settings-input" placeholder="论坛专属昵称">
                </div>
            </div>
        </div>
        <div class="wb-modal-actions" style="border:none; padding-top: 0;">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeForumMeSettings()">取消</button>
                        <button class="wb-action-btn wb-btn-ok" onclick="saveForumMeSettings()">保存</button>
        </div>
    </div>
</div>

<!-- Mall App Page (MODIFIED) -->
<div id="mall-app-page">
    <div class="mall-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-btn" onclick="closeMallApp()">
        <div class="mall-header-title">商城</div>
        <div class="mall-header-actions">
            <img src="https://img.heliar.top/file/1770580892666_刷新_refresh.png" class="refresh-btn">
            <button class="mall-add-btn">+</button>
        </div>
    </div>
    <div class="mall-category-nav" id="mall-category-nav">
        <div class="mall-category-item active" onclick="switchMallCategory(this, '推荐')">推荐</div>
        <div class="mall-category-item" onclick="switchMallCategory(this, '男装')">男装</div>
        <div class="mall-category-item" onclick="switchMallCategory(this, '零食')">零食</div>
        <div class="mall-category-item" onclick="switchMallCategory(this, '医药')">医药</div>
    </div>
    <div class="mall-content" id="mall-content">
        <!-- Content will be injected by JS -->
    </div>
    <!-- NEW: Mall Bottom Nav Bar -->
    <div class="mall-bottom-nav">
        <div class="mall-nav-item active">
            <img src="https://img.heliar.top/file/1770921774009_首页_home_3.png" class="mall-nav-icon">
            <span class="mall-nav-text">首页</span>
        </div>
        <div class="mall-nav-item">
            <img src="https://img.heliar.top/file/1770921767590_购物车_shopping_2.png" class="mall-nav-icon">
            <span class="mall-nav-text">购物车</span>
        </div>
        <div class="mall-nav-item">
            <img src="https://img.heliar.top/file/1770921771134_无嘴脸_face-without-mouth.png" class="mall-nav-icon">
            <span class="mall-nav-text">我</span>
        </div>
    </div>
</div>

<!-- [REFACTORED] Transfer Page -->
<div id="transfer-page">
    <img src="https://img.heliar.top/file/1770721895553_左_left.png" class="transfer-back-btn" onclick="closeTransferPage()">
    <div class="transfer-page-top">
        <div class="transfer-title-info">
             <img id="transfer-target-avatar" class="transfer-target-avatar" src="">
             <span id="transfer-target-name-container">转账给...</span>
        </div>
    </div>
    <div class="transfer-page-bottom">
        <p class="transfer-amount-title">转账金额</p>
        <div class="transfer-amount-input-area">
            <span class="transfer-currency-symbol">¥</span>
            <input type="number" id="transfer-amount-input" class="transfer-amount-input" placeholder="0.00" oninput="checkTransferAmount(this)" onkeydown="handleTransferInputKey(event)">
        </div>
    </div>
</div>


<!-- MODIFIED: Transfer Confirmation & Password Popup -->
<div id="transfer-confirm-overlay">
    <div id="transfer-confirm-popup">
        <div class="confirm-popup-header">
            <img src="https://img.heliar.top/file/1770767041294_关闭_close-one_2.png" class="confirm-popup-close" onclick="closeTransferConfirmPopup()">
            <span id="confirm-popup-title">确认付款</span>
        </div>
        <div id="payment-details-section">
            <div class="confirm-popup-content">
                <div id="confirm-transfer-target">向 ... 转账</div>
                <div id="confirm-transfer-amount">¥100.00</div>
                <div class="confirm-payment-method">
                    <span>付款方式</span>
                    <div class="payment-method-details">
                        <img src="https://img.heliar.top/file/1770715803688_金融_finance.png" class="payment-icon">
                        <span>零钱</span>
                        <img src="https://img.heliar.top/file/1770715921438_校验-小_check-small.png" class="payment-check">
                    </div>
                </div>
            </div>
        </div>
        <div class="password-input-section" id="password-input-section">
            <p>请输入支付密码</p>
            <div class="password-boxes" id="password-boxes">
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
            </div>
            <p class="password-error-tip" id="password-error-tip"></p>
        </div>
        <div class="numeric-keypad" id="numeric-keypad">
            <!-- JS will generate buttons -->
        </div>
    </div>
</div>

<!-- 新增：角色主动转账收款弹窗 (已修改为全屏版) -->
<div id="receive-transfer-overlay">
    <!-- 新增返回按钮 -->
    <img src="https://img.heliar.top/file/1770913074122_左_left_2.png" class="receive-back-btn" onclick="closeReceiveTransferModal()">
    
    <!-- 中间内容区域 (不包含按钮) -->
    <div class="receive-card" onclick="event.stopPropagation()">
        <img src="https://img.heliar.top/file/1770903475517_时间_time.png" class="receive-icon">
        <span class="receive-status">待你收款</span>
        <span class="receive-amount" id="receive-transfer-amount">¥0.00</span>
        <div class="receive-info-section">
            <span class="receive-info-label">转账时间</span>
            <span class="receive-info-value" id="receive-transfer-time"></span>
        </div>
    </div>

    <!-- 新增：底部按钮容器 -->
    <div class="receive-actions-footer">
        <button class="receive-confirm-btn" onclick="confirmReceiveTransfer()">收款</button>
        <button class="receive-reject-btn" onclick="rejectReceiveTransfer()">退还</button>
    </div>
</div>


<!-- Forum Post Image Input (Hidden) -->
<input type="file" id="input-forum-post-image" class="file-input-hidden" multiple accept="image/*" onchange="handleForumPostImageUpload(event)">

<input type="file" id="input-wallpaper" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
<input type="file" id="input-app-icon" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event)">
<input type="file" id="input-time-bg" class="file-input-hidden" accept="image/*" onchange="handleTimeBgUpload(event)">
<input type="file" id="input-friend-avatar" class="file-input-hidden" accept="image/*" onchange="handleFriendAvatarUpload(event)">
<input type="file" id="input-profile-avatar" class="file-input-hidden" accept="image/*" onchange="handleProfileAvatarUpload(event)">
<input type="file" id="input-photo-widget" class="file-input-hidden" accept="image/*" onchange="handlePhotoWidgetUpload(event)">
<input type="file" id="input-role-user-avatar" class="file-input-hidden" accept="image/*" onchange="handleRoleUserAvatarUpload(event)">
<input type="file" id="input-role-chat-bg" class="file-input-hidden" accept="image/*" onchange="handleRoleChatBgUpload(event)">
<input type="file" id="input-moment-image" class="file-input-hidden" multiple accept="image/*" onchange="handleMomentImageUpload(event)">
<input type="file" id="input-forum-avatar" class="file-input-hidden" accept="image/*" onchange="handleForumAvatarUpload(event)">
<input type="file" id="input-wb-cover" class="file-input-hidden" accept="image/*" onchange="handleWbCoverUpload(event)">
<input type="file" id="input-forum-me-avatar" class="file-input-hidden" accept="image/*" onchange="handleForumMeAvatarUpload(event)">
<input type="file" id="input-forum-me-bg" class="file-input-hidden" accept="image/*" onchange="handleForumMeBgUpload(event)">
</div> <!-- 闭合 app-wrapper -->
<input type="file" id="import-backup-input" class="file-input-hidden" accept=".json" onchange="importBackup(event)">

<!-- 手机外框结构 -->
<div class="phone-container" id="phone-container">
  <div class="phone" id="phone-frame">
    <div class="screen" id="phone-screen-content">
      <!-- App 内容会被 JS 移动到这里 -->
    </div>
    <!-- 刘海 -->
    <div class="notch"></div>
    <!-- 状态栏 -->
    <div class="status-bar">
      <div id="phone-status-time" class="status-time">00:00</div>
      <div class="status-right">
        <img src="https://img.heliar.top/file/1770883433951_IMG_4263.png" alt="new-icon">
        <img src="https://img.heliar.top/file/1768515766612_IMG_3349.png" alt="net">
        <img src="https://img.heliar.top/file/1768516105836_IMG_3350.png" alt="bat">
      </div>
    </div>
  </div>
</div>

<script>
    'use strict';
    // --- DOM & Keys ---
    const body = document.body;
    const toast = document.getElementById('toast-notification');
    
    // --- LocalStorage Keys ---
    const ALL_SETTINGS_KEY = 'appSettings_v15';
    const CHAT_DATA_KEY = 'chatData_v5_final'; // Bumped version for new fields
    const USER_PROFILE_KEY = 'userProfile_v4'; 
    const WALLET_DATA_KEY = 'walletData_v3'; 
    const WORLDBOOK_DATA_KEY = 'worldbookData_v3_covers';
    const IOS_MODE_KEY = 'iosModeEnabled_v1';
    const PHONE_FRAME_KEY = 'phoneFrameEnabled_v2'; 
    const PHONE_CASE_COLOR_KEY = 'phoneCaseColor_v1';
    const CAT_EARS_KEY = 'catEarsEnabled_v1';
    const CAT_EAR_COLOR_KEY = 'catEarColor_v1';
    const MOMENTS_DATA_KEY = 'momentsData_v4_private'; // Bumped version for private flag
    const MOMENTS_PROFILE_KEY = 'momentsProfile_v1';
    const FORUMS_DATA_KEY = 'forumsData_v2';
    const FORUM_POSTS_DATA_KEY = 'forumPosts_v2';
    const FORUM_USER_DATA_KEY = 'forumUserData_v4';
    const CSS_PRESETS_KEY = 'cssPresets_v2_new';

    let customDateText = ""; 
    let tempAvatarUrl = ""; 
    let currentWalletType = 'recharge'; 
    let currentChatContactId = null; 
    let tempRoleBgUrl = ""; 
    let currentWorldBookId = null; 
    let tempSelectedWorldBookIds = []; 
    let tempMomentImages = []; 
    let currentCommentMomentId = null; 
    let currentDeleteMomentId = null; 
    let activeMsgIdForMenu = null;
    let isMultiSelectMode = false;
    let selectedMsgIds = new Set();
    
    // Transfer state
    let currentPasswordInput = '';
    let currentReceivingTransferId = null;
    
    // Forum Temp State
    let tempForumAvatarUrl = '';
    let tempForumWbIds = [];
    let tempForumBoundRoleIds = []; 
    let tempForumPostImages = [];
    let currentForumDetailId = null;
    let tempForumMeAvatarUrl = '';
    let tempForumMeBgUrl = ''; 

    // Worldbook Temp State
    let currentWbCoverUploadId = null;
    let wbBindCallback = null;
    let wbBindMultiSelect = false;

    // --- NEW: Urge To Post State ---
    let selectedUrgeCharIds = new Set();
    
    // --- NEW: Auto Post Timers ---
    let autoPostTimers = {}; // { contactId: timerId }

    // --- Utility Functions ---
    const showToast = (message, duration = 2000) => { toast.innerHTML = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), duration); };
    function escapeHtml(text) { if(typeof text !== 'string') return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    function compressImage(file, maxSize, callback) {
        if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); let width = img.width; let height = img.height; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); callback(canvas.toDataURL('image/jpeg', 0.7)); }; img.src = e.target.result; }; reader.readAsDataURL(file);
    }
    
    // --- 手机框与猫耳朵功能 (核心修复：应用消失问题) ---
    function applyPhoneFrame(enabled) {
      const appWrapper = document.getElementById('app-wrapper');
      const phoneScreen = document.getElementById('phone-screen-content');
      const bodyEl = document.body;
      const phoneContainer = document.getElementById('phone-container');
      const frameSettingsModule = document.getElementById('phone-frame-settings-module');
      
      const wasActive = bodyEl.classList.contains('phone-frame-active');
      
      if (enabled) {
        if (!wasActive) {
            bodyEl.classList.add('phone-frame-active');
            // 将整个APP内容移入手机屏幕
            if (appWrapper && phoneScreen && !phoneScreen.contains(appWrapper)) {
                phoneScreen.appendChild(appWrapper);
            }
        }
        // 手机框模式下，壁纸应用在屏幕内
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        const wp = settings.visual && settings.visual.wallpaper ? settings.visual.wallpaper : 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib-rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
        phoneScreen.style.backgroundImage = `url(${wp})`;
        bodyEl.style.backgroundImage = 'none';
        
        if (frameSettingsModule) frameSettingsModule.style.display = 'block';

      } else {
        if (wasActive) {
            bodyEl.classList.remove('phone-frame-active');
            // 修复：关闭手机框时，将appWrapper移回body，且必须在phoneContainer之前
            if (appWrapper && bodyEl && phoneContainer && !bodyEl.contains(appWrapper)) {
                bodyEl.insertBefore(appWrapper, phoneContainer);
            }
        }
        // 普通模式下，壁纸应用在body
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        const wp = settings.visual && settings.visual.wallpaper ? settings.visual.wallpaper : 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib-rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
        bodyEl.style.backgroundImage = `url(${wp})`;
        phoneScreen.style.backgroundImage = 'none';
        
        if (frameSettingsModule) frameSettingsModule.style.display = 'none';
        applyCatEars(false); 
      }
      localStorage.setItem(PHONE_FRAME_KEY, enabled);
    }
    
    function applyCatEars(enabled) {
        const isPhoneFrameActive = document.body.classList.contains('phone-frame-active');
        if (enabled && isPhoneFrameActive) {
            document.body.classList.add('cat-ears-active');
        } else {
            document.body.classList.remove('cat-ears-active');
        }
        localStorage.setItem(CAT_EARS_KEY, enabled);
    }
    
    function setPhoneCaseColor(color) {
        document.documentElement.style.setProperty('--phone-case-color', color);
        localStorage.setItem(PHONE_CASE_COLOR_KEY, color);
    }
    
    function setCatEarColor(color) {
        document.documentElement.style.setProperty('--cat-ear-color', color);
        localStorage.setItem(CAT_EAR_COLOR_KEY, color);
    }

    function updatePhoneTime(){
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const timeEl = document.getElementById('phone-status-time');
      if (timeEl) {
        timeEl.innerText = h + ':' + m;
      }
    }
    
    function applyIOSMode(enabled) {
      if (enabled) {
        document.body.classList.add('ios-mode-active');
      } else {
        document.body.classList.remove('ios-mode-active');
      }
      localStorage.setItem(IOS_MODE_KEY, enabled);
    }
    
    // --- Mall App Logic (MODIFIED) ---
    window.openMallApp = () => {
        body.classList.add('mall-active');
        switchMallCategory(document.querySelector('#mall-category-nav .mall-category-item'), '推荐');
    };

    window.closeMallApp = () => {
        body.classList.remove('mall-active');
    };

    window.switchMallCategory = (element, categoryName) => {
        // No visual change for selected item, just update content
        const contentArea = document.getElementById('mall-content');
        contentArea.innerHTML = `<h1>${escapeHtml(categoryName)} 内容区</h1><p>这里将显示 ${escapeHtml(categoryName)} 分类的商品列表。</p>`;
    };
    
    // --- Forum App Logic ---
    window.openForumApp = () => {
        body.classList.add('forum-active');
        switchForumPage('home'); 
        renderForumList();
        renderAllForumPosts();
    };

    window.closeForumApp = () => {
        body.classList.remove('forum-active');
    };
    
    function switchForumPage(pageName) {
        document.querySelectorAll('#forum-content-wrapper > .forum-page').forEach(p => {
            p.classList.remove('active');
        });
        const pageToShow = document.getElementById(`forum-page-${pageName}`);
        if(pageToShow) {
            pageToShow.classList.add('active');
        }
    }
    
    window.switchForumTab = (index) => {
        const pageNames = ['home', 'post', 'me'];
        switchForumPage(pageNames[index]);
        
        document.querySelectorAll('.forum-nav-item').forEach((el, i) => {
            el.classList.toggle('active', i === index);
        });
        
        if (index === 0) { 
            renderAllForumPosts();
        } else if (index === 1) { 
            prepareForumPostPage();
        } else if (index === 2) { 
            renderForumMePage();
        }
    };
    
    function renderForumMePage() {
        const forumProfile = getForumUserData();
        const mainProfile = getUserProfile();

        const avatar = forumProfile.avatar || mainProfile.avatar || 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png';
        const nickname = forumProfile.nickname || mainProfile.nickname;
        const background = forumProfile.backgroundUrl || 'https://images.unsplash.com/photo-1501854140801-50d01698950b?auto=format&fit=crop&w=1000&q=80';

        document.getElementById('forum-me-avatar').src = avatar;
        document.getElementById('forum-me-nickname').textContent = nickname;
        document.getElementById('forum-me-bg').style.backgroundImage = `url('${background}')`;
        document.getElementById('forum-me-bg').onclick = triggerForumMeBgUpload;
    }


    window.openCreateForumModal = () => {
        tempForumAvatarUrl = '';
        tempForumWbIds = [];
        tempForumBoundRoleIds = []; 
        document.getElementById('new-forum-avatar-preview').src = '';
        document.getElementById('new-forum-avatar-preview').style.display = 'none';
        document.getElementById('forum-avatar-placeholder').style.display = 'flex';

        document.getElementById('new-forum-name-input').value = '';
        document.getElementById('new-forum-worldview-input').value = '';
        document.getElementById('new-forum-wb-selection-display').textContent = '未绑定世界书';
        document.getElementById('new-forum-role-selection-display').textContent = '未绑定角色'; 
       document.getElementById('create-forum-modal-overlay').classList.add('active');
    };

    window.closeCreateForumModal = () => {
                document.getElementById('create-forum-modal-overlay').classList.remove('active');
    };

    window.triggerForumAvatarUpload = () => {
        document.getElementById('input-forum-avatar').click();
    };

    window.handleForumAvatarUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        compressImage(file, 300, (base64) => {
            tempForumAvatarUrl = base64;
            const preview = document.getElementById('new-forum-avatar-preview');
            preview.src = base64;
            preview.style.display = 'block';
            document.getElementById('forum-avatar-placeholder').style.display = 'none';
        });
    };

    window.openForumWbBindModal = () => {
        wbBindMultiSelect = true;
        document.getElementById('wb-bind-modal-title').textContent = '选择绑定的世界书';
        wbBindCallback = (selectedIds) => {
            tempForumWbIds = selectedIds;
            const displayEl = document.getElementById('new-forum-wb-selection-display');
            if (selectedIds.length > 0) {
                const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
                const names = selectedIds.map(id => {
                    const book = worldbooks.find(b => b.id === id);
                    return book ? book.title : '未知';
                });
                displayEl.textContent = `已绑定: ${names.join(', ')}`;
            } else {
                displayEl.textContent = '未绑定世界书';
            }
        };
        openWorldBookBindModal('worldbook');
    };
    window.openForumCreateRoleBindModal = () => {
        wbBindMultiSelect = true;
        document.getElementById('wb-bind-modal-title').textContent = '选择绑定的角色';
        wbBindCallback = (selectedIds) => {
            tempForumBoundRoleIds = selectedIds;
            const displayEl = document.getElementById('new-forum-role-selection-display');
            if (selectedIds.length > 0) {
                const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
                const names = selectedIds.map(id => {
                    const contact = contacts.find(c => c.id === id);
                    return contact ? (contact.alias || contact.name) : '未知';
                }).join(', ');
                displayEl.textContent = `已绑定: ${names}`;
            } else {
                displayEl.textContent = '未绑定角色';
            }
        };
        openWorldBookBindModal('roles');
    };

    window.saveNewForum = () => {
        const name = document.getElementById('new-forum-name-input').value.trim();
        const worldview = document.getElementById('new-forum-worldview-input').value.trim();
        if (!name || !tempForumAvatarUrl) {
            showToast(!name ? "论坛名称不能为空" : "请上传论坛头像");
            return;
        }
        
        let forums = [];
        try { forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]'); } catch(e) {}
        forums.unshift({
            id: Date.now(),
            name: name,
            avatar: tempForumAvatarUrl,
            worldview: worldview,
            worldbookIds: tempForumWbIds,
            boundRoleIds: tempForumBoundRoleIds, 
        });
        localStorage.setItem(FORUMS_DATA_KEY, JSON.stringify(forums));
        showToast("论坛创建成功!");
        closeCreateForumModal();
        renderForumList();
    };

    window.renderForumList = () => {
        const container = document.getElementById('forum-list-container');
        container.innerHTML = '';
        let forums = [];
        try { forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]'); } catch(e) {}
        
        if (forums.length === 0) {
            container.innerHTML = `<p style="color: #999; width: 100%; text-align: center; font-size:13px; padding:10px; grid-column: span 4;">点击右上角 + 创建第一个论坛</p>`;
            return;
        }
        forums.forEach(forum => {
            const item = document.createElement('div');
            item.className = 'forum-list-item';
            item.onclick = () => openForumDetail(forum.id);
            item.innerHTML = `
                <img src="${forum.avatar}" class="forum-list-avatar">
                <span class="forum-list-name">${escapeHtml(forum.name)}</span>
            `;
            container.appendChild(item);
        });
    };
    
    // --- Forum Post & Detail Page Logic ---
    const XP_PER_LEVEL = 30; 

    function getForumUserData() {
        try { 
            const data = localStorage.getItem(FORUM_USER_DATA_KEY);
            return data ? JSON.parse(data) : { nickname: '', avatar: '', signIns: {}, backgroundUrl: '' };
        } catch(e) { 
            return { nickname: '', avatar: '', signIns: {}, backgroundUrl: '' }; 
        }
    }
    function saveForumUserData(data) {
        localStorage.setItem(FORUM_USER_DATA_KEY, JSON.stringify(data));
    }

    function calculateLevelInfo(xp) {
        const currentXP = xp || 0;
        const level = Math.floor(currentXP / XP_PER_LEVEL) + 1;
        const xpInCurrentLevel = currentXP % XP_PER_LEVEL;
        const progressPercent = (xpInCurrentLevel / XP_PER_LEVEL) * 100;
        return { level, xpInCurrentLevel, progressPercent };
    }
    
    function updateForumLevelDisplay(forumId) {
        const userData = getForumUserData();
        const userForumData = (userData.signIns && userData.signIns[forumId]) || { xp: 0 };
        const { level, xpInCurrentLevel, progressPercent } = calculateLevelInfo(userForumData.xp);

        document.getElementById('forum-detail-level').textContent = `Lv.${level}`;
        document.getElementById('forum-detail-exp-bar').style.width = `${progressPercent}%`;
        document.getElementById('forum-detail-exp-text').textContent = `${xpInCurrentLevel}/${XP_PER_LEVEL}`;
        
        document.querySelector('#forum-detail-level-display').style.display = 'flex';
    }


    window.openForumDetail = (forumId) => {
        currentForumDetailId = forumId;
        const forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]');
        const forum = forums.find(f => f.id === forumId);
        if (!forum) return;

        document.getElementById('forum-detail-header-name').textContent = forum.name;
        document.getElementById('forum-detail-header-avatar').src = forum.avatar || '';
        
        const signinBtn = document.getElementById('forum-detail-signin-btn');
        signinBtn.onclick = () => handleForumSignIn(forumId);
        
        document.getElementById('forum-detail-refresh-btn').onclick = () => handleForumRefresh(forumId);

        const userData = getForumUserData();
        const today = new Date().toDateString();
        const userForumData = (userData.signIns && userData.signIns[forumId]) || {};
        if (userForumData.lastSignIn === today) {
            signinBtn.textContent = '已签到';
            signinBtn.disabled = true;
        } else {
            signinBtn.textContent = '签到';
            signinBtn.disabled = false;
        }
        
        updateForumLevelDisplay(forumId);
        
        switchForumPage('detail');
        renderForumDetailPosts(forumId); 
    };

    window.closeForumDetail = () => {
        switchForumPage('home');
        currentForumDetailId = null;
    };
    
    window.handleForumSignIn = (forumId) => {
        const userData = getForumUserData();
        const today = new Date().toDateString();
        
        if (!userData.signIns) userData.signIns = {};
        if (!userData.signIns[forumId]) {
            userData.signIns[forumId] = { xp: 0, lastSignIn: '' };
        }
        
        if (userData.signIns[forumId].lastSignIn === today) {
            showToast("今天已经签过啦！");
            return;
        }
        
        userData.signIns[forumId].xp = (userData.signIns[forumId].xp || 0) + 10;
        userData.signIns[forumId].lastSignIn = today;
        saveForumUserData(userData);
        
        showToast(`签到成功！经验 +10`);
        const signinBtn = document.getElementById('forum-detail-signin-btn');
        signinBtn.textContent = '已签到';
        signinBtn.disabled = true;
        
        updateForumLevelDisplay(forumId);
    };

    window.prepareForumPostPage = () => {
        document.getElementById('forum-post-textarea').value = '';
        tempForumPostImages = [];
        renderForumPostImages();
        
        const select = document.getElementById('forum-post-target-select');
        select.innerHTML = '<option value="">请选择吧群...</option>';
        let forums = [];
        try { forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]'); } catch(e) {}
        
        forums.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.innerText = f.name;
            select.appendChild(opt);
        });
        if (currentForumDetailId) {
            select.value = currentForumDetailId;
        }
    };

    window.triggerForumPostImageUpload = () => {
        document.getElementById('input-forum-post-image').click();
    };

    window.handleForumPostImageUpload = (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        let processedCount = 0;
        files.forEach(file => {
            if (tempForumPostImages.length >= 9) return;
            compressImage(file, 600, (base64) => {
                tempForumPostImages.push(base64);
                processedCount++;
                if (processedCount === files.length || tempForumPostImages.length === 9) {
                     renderForumPostImages();
                }
            });
        });
        event.target.value = '';
    };

        function renderForumPostImages() {
        const grid = document.getElementById('forum-post-image-grid');
        const uploadBtn = document.createElement('div');
        uploadBtn.className = 'forum-post-add-img';
        uploadBtn.innerText = '+';
        uploadBtn.onclick = triggerForumPostImageUpload;

        grid.innerHTML = '';
        
        tempForumPostImages.forEach((src, index) => {
            const div = document.createElement('div');
            div.className = 'forum-post-img-preview';
                        div.innerHTML = `<img src="${src}"><div class="forum-post-img-remove" onclick="removeForumPostImage(${index})">✕</div>`;
            grid.appendChild(div);
        });
        
        if (tempForumPostImages.length < 9) {
            grid.appendChild(uploadBtn);
        }
    }

    window.removeForumPostImage = (index) => {
        tempForumPostImages.splice(index, 1);
        renderForumPostImages();
    };

    window.submitForumPost = () => {
        const content = document.getElementById('forum-post-textarea').value.trim();
        const forumId = document.getElementById('forum-post-target-select').value;
        
        if (!forumId || (!content && tempForumPostImages.length === 0)) {
            showToast(!forumId ? "请选择要发布的吧群" : "请输入内容或上传图片");
            return;
        }
        
        const forumProfile = getForumUserData();
        const mainProfile = getUserProfile();
        const forumSignIns = (forumProfile.signIns && forumProfile.signIns[forumId]) || {xp: 0};

        const newPost = {
            id: Date.now(),
            forumId: parseInt(forumId),
            content: content,
            images: [...tempForumPostImages],
            authorId: mainProfile.qqId, 
            authorName: forumProfile.nickname || mainProfile.nickname,
            authorAvatar: forumProfile.avatar || mainProfile.avatar,
            authorXP: forumSignIns.xp, 
            timestamp: Date.now(),
            likes: [], 
            tags: [], 
            comments: [] 
        };
        
        let posts = [];
        try { posts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]'); } catch(e) {}
        posts.unshift(newPost);
        localStorage.setItem(FORUM_POSTS_DATA_KEY, JSON.stringify(posts));
        
        showToast("发布成功！");
        openForumDetail(parseInt(forumId));
    };

    window.renderAllForumPosts = () => {
        document.getElementById('forum-posts-area').innerHTML = ''; // Keep it empty for now
    };

    const customAvatarList = [
        "https://img.heliar.top/file/1770618803521_IMG_4118.jpeg", 
        "https://img.heliar.top/file/1770618839439_IMG_4156.jpeg",
        "https://img.heliar.top/file/1770618963468_IMG_4157.jpeg",
        "https://img.heliar.top/file/1770619023973_IMG_4158.jpeg",
    ];

    const getRandomCustomAvatar = () => {
        if (customAvatarList.length === 0) return "https://img.heliar.top/file/1770068438490_添加人群_people-plus.png"; 
        return customAvatarList[Math.floor(Math.random() * customAvatarList.length)];
    };

    window.renderForumDetailPosts = (forumId) => {
        const container = document.getElementById('forum-detail-posts-area');
        container.innerHTML = '';
        
        const allPosts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]');
        const forumPosts = allPosts.filter(p => p.forumId === forumId).sort((a,b) => b.timestamp - a.timestamp);
        
        if (forumPosts.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#ccc; padding:50px 20px;">这里还空空如也，快来发布第一条帖子吧~</div>';
            return;
        }
        
        const mainProfile = getUserProfile();

        forumPosts.forEach(post => {
            let imgHtml = '';
            if (post.images && post.images.length > 0) {
                let gridClass = 'single-img';
                if (post.images.length === 2 || post.images.length === 4) gridClass = `grid-${post.images.length}`; 
                else if (post.images.length > 1) gridClass = `grid-${post.images.length > 9 ? 9 : post.images.length}`; 
                
                imgHtml = `<div class="moments-img-grid ${gridClass}" style="margin-bottom:10px;">` +
                    post.images.slice(0, 9).map(src => `<img src="${src}" class="moment-grid-img">`).join('') +
                    `</div>`;
            }
            
            const dateStr = formatTimestamp(post.timestamp);
            const { level } = calculateLevelInfo(post.authorXP);
            const userHasLiked = post.likes && post.likes.includes(mainProfile.qqId);
            const likeIcon = userHasLiked ? "https://img.heliar.top/file/1770582836150_赞_thumbs-up_4.png" : "https://img.heliar.top/file/1770582828275_赞_thumbs-up_3.png";

            const tagsHtml = (post.tags && post.tags.length > 0) 
                ? `<div class="forum-post-tags">${post.tags.map(tag => `<span>${escapeHtml(tag)}</span>`).join(' ')}</div>` 
                : '';

            const commentsHtml = (post.comments && post.comments.length > 0)
                ? post.comments.map(comment => {
                    const avatarSrc = comment.author_avatar || getRandomCustomAvatar();
                    
                    let commentText = escapeHtml(comment.text);
                    if (comment.reply_to_nickname) {
                        const replyTag = `<span class="comment-reply-tag">@${escapeHtml(comment.reply_to_nickname)}</span>`;
                        commentText = commentText.replace(`@${comment.reply_to_nickname}`, replyTag);
                    }
                    
                    return `
                        <div class="forum-post-comment-item">
                            <img src="${avatarSrc}" class="comment-avatar">
                            <div class="comment-body">
                                <div class="comment-nickname">${escapeHtml(comment.author_nickname)}</div>
                                <div class="comment-text">${commentText}</div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '';

            const card = document.createElement('div');
            card.className = 'forum-post-card';
            card.innerHTML = `
                <div class="forum-post-header">
                    <img src="${post.authorAvatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'}" class="forum-post-avatar">
                    <div class="forum-post-user-info">
                        <div class="forum-post-user">${escapeHtml(post.authorName)}</div>
                    </div>
                    <span class="forum-post-level">Lv.${level}</span>
                    <div class="forum-post-time">${dateStr}</div>
                </div>
                ${post.content ? `<div class="forum-post-content">${escapeHtml(post.content)}</div>` : ''}
                ${imgHtml}
                ${tagsHtml}
                <div class="forum-post-actions">
                    <div class="forum-post-action-btn" onclick="shareForumPost(${post.id})">
                        <img src="https://img.heliar.top/file/1770582835252_分享_share.png">
                        <span>分享</span>
                    </div>
                    <div class="forum-post-action-btn" onclick="commentOnForumPost(${post.id})">
                        <img src="https://img.heliar.top/file/1770582828238_未读消息_message-unread.png">
                        <span>${post.comments ? post.comments.length : 0}</span>
                    </div>
                    <div class="forum-post-action-btn" onclick="toggleForumPostLike(${post.id})">
                        <img src="${likeIcon}">
                        <span>${post.likes ? post.likes.length : 0}</span>
                    </div>
                </div>
                <div class="forum-post-feedback ${!commentsHtml ? 'hidden' : ''}">
                    <div class="forum-post-comments-list">
                        ${commentsHtml}
                    </div>
                </div>
            `;
                        container.appendChild(card);
        });
    };

    window.shareForumPost = (postId) => { showToast("分享功能待开发"); };
    window.commentOnForumPost = (postId) => { showToast("评论功能待开发"); };
    
    window.toggleForumPostLike = (postId) => {
        let posts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]');
        const postIndex = posts.findIndex(p => p.id === postId);
        if (postIndex === -1) return;

        const mainProfile = getUserProfile();
        const likeIndex = (posts[postIndex].likes || []).indexOf(mainProfile.qqId);

        if (!posts[postIndex].likes) posts[postIndex].likes = [];

        if (likeIndex > -1) {
            posts[postIndex].likes.splice(likeIndex, 1); 
        } else {
            posts[postIndex].likes.push(mainProfile.qqId); 
        }

        localStorage.setItem(FORUM_POSTS_DATA_KEY, JSON.stringify(posts));
        
        if(currentForumDetailId) {
            renderForumDetailPosts(currentForumDetailId);
        }
    };
    
    window.openForumMeSettings = () => {
        const modal = document.getElementById('forum-me-settings-modal');
        const profile = getForumUserData();
        const mainProfile = getUserProfile();

        tempForumMeAvatarUrl = profile.avatar || '';
        tempForumMeBgUrl = profile.backgroundUrl || '';

        document.getElementById('forum-me-settings-avatar-preview').src = profile.avatar || mainProfile.avatar || 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png';
        document.getElementById('forum-me-settings-avatar-url').value = profile.avatar || '';
        document.getElementById('forum-me-settings-bg-preview').src = profile.backgroundUrl || 'https://images.unsplash.com/photo-1501854140801-50d01698950b?auto=format&fit=crop&w=1000&q=80';
        document.getElementById('forum-me-settings-bg-url').value = profile.backgroundUrl || '';
        document.getElementById('forum-me-settings-nickname').value = profile.nickname || '';

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    };

    window.closeForumMeSettings = () => {
        const modal = document.getElementById('forum-me-settings-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 200);
    };
    
    window.triggerForumMeAvatarUpload = () => {
        document.getElementById('input-forum-me-avatar').click();
    };

    window.handleForumMeAvatarUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        compressImage(file, 200, (base64) => {
            tempForumMeAvatarUrl = base64;
            document.getElementById('forum-me-settings-avatar-preview').src = base64;
            document.getElementById('forum-me-settings-avatar-url').value = '（已上传本地图片）';
        });
    };

    window.triggerForumMeBgUpload = () => {
        document.getElementById('input-forum-me-bg').click();
    };
    
    window.handleForumMeBgUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        compressImage(file, 1000, (base64) => {
            const isSettingsModalActive = document.getElementById('forum-me-settings-modal').classList.contains('active');
            if (isSettingsModalActive) {
                tempForumMeBgUrl = base64;
                document.getElementById('forum-me-settings-bg-preview').src = base64;
                document.getElementById('forum-me-settings-bg-url').value = '（已上传本地图片）';
            } else {
                const userData = getForumUserData();
                userData.backgroundUrl = base64;
                saveForumUserData(userData);
                renderForumMePage();
                showToast("个人主页背景已更新");
            }
        });
    };

    window.saveForumMeSettings = () => {
        const profile = getForumUserData();
        
        profile.nickname = document.getElementById('forum-me-settings-nickname').value.trim();
        
        const avatarUrlFromInput = document.getElementById('forum-me-settings-avatar-url').value.trim();
        if (tempForumMeAvatarUrl) {
            profile.avatar = tempForumMeAvatarUrl;
                } else if (avatarUrlFromInput !== '（已上传本地图片）') {
            profile.avatar = avatarUrlFromInput;
        }
        
        const bgUrlFromInput = document.getElementById('forum-me-settings-bg-url').value.trim();
        if (tempForumMeBgUrl) {
            profile.backgroundUrl = tempForumMeBgUrl;
        } else if (bgUrlFromInput !== '（已上传本地图片）') {
            profile.backgroundUrl = bgUrlFromInput;
        }

        saveForumUserData(profile);
        showToast('论坛设置已保存');
        closeForumMeSettings();
        renderForumMePage();
    };

    window.expandPostContent = (element) => {
        element.classList.remove('truncated');
    };

    async function callApiForJson(prompt) {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        let url = settings.api.url;
        const key = settings.api.key;
        let model = settings.api.model || 'gemini-pro'; 
        let body;
        let headers = { 'Content-Type': 'application/json' };
        
        if (url.includes('generativelanguage')) {
            url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
            body = JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: parseFloat(settings.api.temp || 0.9),
                },
            });
        } else {
            url = `${url.endsWith('/v1') ? url : url+'/v1'}/chat/completions`;
            headers['Authorization'] = `Bearer ${key}`;
            body = JSON.stringify({
                model: model,
                messages: [{ role: 'user', content: prompt }], 
                temperature: parseFloat(settings.api.temp || 0.9),
                response_format: { "type": "json_object" }
            });
        }
        
        const response = await fetch(url, { method: 'POST', headers: headers, body: body });

        if (!response.ok) {
            const errorData = await response.json();
            const errorMessage = errorData?.error?.message || JSON.stringify(errorData);
            throw new Error(`API Error: ${response.status} - ${errorMessage}`);
        }
        
        const data = await response.json();
        let content;

        if (url.includes('generativelanguage')) { 
            if (!data.candidates || !data.candidates[0].content.parts[0].text) throw new Error('Invalid Gemini response format.');
            content = data.candidates[0].content.parts[0].text;
        } else { 
            content = data.choices[0].message.content;
        }
        
        // Looser regex to find JSON
        const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```|({[\s\S]*})/);
        if (!jsonMatch) {
            console.error("API did not return valid JSON. Raw response:", content);
            throw new Error("API did not return valid JSON.");
        }
        
        // Prefer the content inside ```json ... ``` if it exists
        const jsonString = jsonMatch[1] ? jsonMatch[1] : jsonMatch[2];
        
        try {
            return JSON.parse(jsonString);
        } catch (parseError) {
            console.error("Failed to parse JSON string:", jsonString, "Original content:", content);
            throw new Error("Failed to parse JSON from API response.");
        }
    }


    async function handleForumRefresh(forumId) {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings?.api?.url || !settings?.api?.key || !settings?.api?.model) {
            showToast('请先在设置中配置完整的 API 信息');
            return;
        }

        const forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]');
        const currentForum = forums.find(f => f.id === forumId);
        if (!currentForum) return;

        const refreshBtn = document.getElementById('forum-detail-refresh-btn');
        refreshBtn.style.animation = 'spin 1s linear infinite';
        showToast('正在生成内容，请稍候...', 4000);

        try {
            const allWorldBooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const worldBookContext = (currentForum.worldbookIds || [])
                .map(id => {
                    const book = allWorldBooks.find(b => b.id === id);
                    return book ? `[世界书: ${book.title}]\n${book.entries.map(e => `${e.key}: ${e.content}`).join('\n')}` : '';
                }).filter(Boolean).join('\n\n') || '无';

            const allContacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
            const boundRoles = (currentForum.boundRoleIds || [])
                .map(id => allContacts.find(c => c.id === id)).filter(Boolean);

            const generalPostPrompt = `You are a content creator for a fictional forum.
Forum Name: "${currentForum.name}"
Worldview: "${currentForum.worldview || 'A standard fantasy world.'}"
World Book Facts (Highest Priority):
${worldBookContext}

Generate a JSON object with a key "posts" containing an array of 5-6 original posts.
For each post, provide:
- author_nickname: A plausible, unique, non-repeating nickname suitable for the forum's atmosphere.
- content: The post text. Must be original, engaging, natural-sounding, and strictly adhere to the worldview and world book facts.
- tags: An array of 1-3 relevant string tags in "#tag" format.
- comments: An array of 5-10 unique comment objects. Each comment must have:
    - author_nickname: A unique, non-repeating passerby nickname.
    - text: The comment content, which should be a realistic reaction to the post, a question, or a reply to another comment. To reply, use the format "@[nickname] [your_reply_text]".
    - reply_to_nickname: (Optional) The nickname of the user they are replying to. If it's a top-level comment, this should be null.

Strictly adhere to the JSON format. Example:
{ "posts": [ { "author_nickname": "User1", "content": "Text", "tags": ["#Tag"], "comments": [ { "author_nickname": "User2", "text": "Comment", "reply_to_nickname": null } ] } ] }`;

            let generatedData = await callApiForJson(generalPostPrompt);
            let newPosts = generatedData.posts || [];
            
            // Generate Role Posts
            if (boundRoles.length > 0) {
                for (const role of boundRoles) {
                    if (Math.random() < 0.5) {
                        const rolePostPrompt = `Act as character "${role.alias || role.name}". Persona: "${role.persona}". Forum: "${currentForum.name}". Worldview: "${currentForum.worldview}". Facts: ${worldBookContext}. Generate JSON key "post" with fields: author_nickname (exact character name), content, tags, comments (empty array).`;
                        try {
                            const rolePostData = await callApiForJson(rolePostPrompt);
                            if (rolePostData.post) {
                                rolePostData.post.author_avatar = role.avatar;
                                newPosts.unshift(rolePostData.post);
                            }
                        } catch (e) { console.warn(`Role post failed`, e); }
                    }
                }
            }

            const processedPosts = newPosts.map((p, index) => ({
                id: Date.now() + index, 
                forumId: forumId,
                authorName: p.author_nickname,
                authorAvatar: p.author_avatar || '', 
                content: p.content,
                tags: p.tags || [],
                comments: p.comments || [],
                timestamp: Date.now(),
                likes: [],
                authorXP: Math.floor(Math.random() * 500) 
            }));

            let allStoredPosts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]');
            allStoredPosts = [...processedPosts, ...allStoredPosts];
            
            localStorage.setItem(FORUM_POSTS_DATA_KEY, JSON.stringify(allStoredPosts));

            renderForumDetailPosts(forumId);
            showToast(`刷新成功！更新了 ${processedPosts.length} 条内容`);

        } catch (error) {
            console.error('Forum refresh failed:', error);
            showToast('内容生成失败: ' + error.message, 4000);
        } finally {
            refreshBtn.style.animation = '';
        }
    }

    // --- Chat App Logic ---
    window.openChatApp = () => { body.classList.add('chat-active'); switchChatTab(0, 'Chat'); renderChatList(); };
    window.closeChatApp = () => { body.classList.remove('chat-active'); closeChatConversation(); };
    window.switchChatTab = (index, title) => {
        const titleEl = document.getElementById('chat-page-title');
        const addFriendIcon = document.getElementById('chat-header-add-friend-icon');
        const addMomentIcon = document.getElementById('chat-header-add-moment-icon');
        const urgePostIcon = document.getElementById('urge-post-icon');
        const headerEl = document.getElementById('chat-app-header-el');
        const backBtn = document.getElementById('chat-back-btn');
        const contentArea = document.getElementById('chat-content-area');
        const leftIconsContainer = document.getElementById('chat-header-left-icons');
        
        document.querySelectorAll('.chat-tab-content').forEach((el, i) => el.classList.toggle('active', i === index));
        document.querySelectorAll('.chat-nav-item').forEach((el, i) => el.classList.toggle('active', i === index));
        
        contentArea.style.backgroundColor = (index === 2) ? '#ffffff' : '';
        
        headerEl.classList.remove('hidden');
        headerEl.style.backgroundColor = ''; 
        headerEl.style.boxShadow = ''; 
        
        contentArea.classList.remove('me-mode');
        
        // Default visibility
        backBtn.style.display = 'block';
        addFriendIcon.style.display = 'none';
        addMomentIcon.style.display = 'none';
        urgePostIcon.style.display = 'none';
        titleEl.style.color = ""; // Reset color
        
        closeCommentInput();

        if (index === 0) { // Chat
            titleEl.innerText = title;
            titleEl.style.color = "#FDCEDF";
            addFriendIcon.style.display = 'block';
        } else if (index === 1) { // Contacts
            titleEl.innerText = title;
            backBtn.style.display = 'none';
            renderContactList(); 
        } else if (index === 2) { // Moments
            titleEl.innerText = title;
            titleEl.style.color = "#FDCEDF";
            addMomentIcon.style.display = 'block';
            backBtn.style.display = 'none';
            urgePostIcon.style.display = 'block';
            renderMomentsPage();
        } else if (index === 3) { // Me
            headerEl.classList.add('hidden'); 
            contentArea.classList.add('me-mode');
            loadUserProfile();
         }
    };
    
    // --- Moments (朋友圈) Functions ---
    function getMomentsProfile() {
        try {
            const p = localStorage.getItem(MOMENTS_PROFILE_KEY);
            const profile = p ? JSON.parse(p) : {};
            return {
                cover: profile.cover || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1000&q=80',
                avatar: profile.avatar || 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png'
            };
        } catch (e) {
            return {
                cover: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1000&q=80',
                avatar: 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png'
            };
        }
    }

    function saveMomentsProfile(profileData) {
        try {
            localStorage.setItem(MOMENTS_PROFILE_KEY, JSON.stringify(profileData));
        } catch (e) {
            showToast("保存朋友圈信息失败 (LocalStorage可能已满)");
        }
    }
    
    function getMomentsData() {
        try { return JSON.parse(localStorage.getItem(MOMENTS_DATA_KEY) || '[]'); } catch (e) { return []; }
    }

    function saveMomentsData(data) {
        localStorage.setItem(MOMENTS_DATA_KEY, JSON.stringify(data));
    }
    
    function formatTimestamp(ts) {
        const now = new Date();
        const postDate = new Date(ts);
        const diff = now - postDate;
        const diffMinutes = Math.floor(diff / 60000);
        const diffHours = Math.floor(diff / 3600000);
        const diffDays = Math.floor(diff / 86400000);

                if (diffMinutes < 1) return '刚刚';
        if (diffMinutes < 60) return `${diffMinutes}分钟前`;
        if (diffHours < 24 && now.getDate() === postDate.getDate()) return `${diffHours}小时前`;
        if (diffDays === 1 || (diffHours < 48 && now.getDate() - 1 === postDate.getDate())) return '昨天';
        return `${postDate.getMonth() + 1}月${postDate.getDate()}日`;
    }

    function renderMomentsPage() {
        const wrapper = document.getElementById('moments-page-wrapper');
        const userProfile = getUserProfile();
        const momentsProfile = getMomentsProfile();
        let moments = getMomentsData();
        let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');

        let listHtml = '';
        if (moments.length > 0) {
            moments.sort((a,b) => b.timestamp - a.timestamp); 
            moments.forEach(moment => {
                const isUserMoment = !moment.authorId || moment.authorId === userProfile.qqId;
                const author = isUserMoment ? userProfile : contacts.find(c => c.id === moment.authorId);
                
                // If it's a private moment from a role, skip rendering
                if (moment.isPrivate && !isUserMoment) {
                    return;
                }

                const authorNickname = author ? (isUserMoment ? author.nickname : (author.alias || author.name)) : '未知用户';
                const authorAvatar = author ? (isUserMoment ? momentsProfile.avatar : author.avatar) : 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png';
                
                const userHasLiked = moment.likes.includes(userProfile.qqId);
                const likeBtnText = userHasLiked ? '取消' : '赞';
                const likeIconUrl = userHasLiked ? "https://img.heliar.top/file/1770356886806_喜欢_like_3.png" : "https://img.heliar.top/file/1770353311894_喜欢_like_2.png";
                
                // New "Only You Can See" tag
                const privateTag = moment.isPrivate ? `<span style="color: #999; font-weight: 400;">仅你可见</span>` : '';


                let likesHtml = '';
                if (moment.likes.length > 0) {
                    likesHtml = `<div class="moment-likes"><img src="https://img.heliar.top/file/1770356881218_喜欢_like_4.png" style="width:14px;height:14px;object-fit:contain;"> ${moment.likes.length}</div>`;
                }

                let commentsHtml = '';
                if (moment.comments.length > 0) {
                    commentsHtml = `<div class="moment-comments-list">` +
                        moment.comments.map(c => 
                            `<div class="moment-comment-item"><span class="user">${escapeHtml(c.user)}:</span> <span class="text">${escapeHtml(c.text)}</span></div>`
                        ).join('') +
                    `</div>`;
                }
                
                let imageGridHtml = '';
                let images = moment.images || (moment.imageUrl ? [moment.imageUrl] : []);
                
                if (images.length > 0) {
                    let gridClass = 'single-img';
                    if (images.length === 1) gridClass = 'single-img';
                    else if (images.length === 2 || images.length === 4) gridClass = `grid-${images.length}`; 
                    else gridClass = `grid-${images.length}`; 
                    
                    imageGridHtml = `<div class="moments-img-grid ${gridClass}">` + 
                        images.map(url => `<img src="${url}" class="moment-grid-img" onclick="event.stopPropagation()">`).join('') +
                    `</div>`;
                }
                
                // For user moments, the delete button is available.
                // For role moments, a different action button is used.
                const metaActionsHtml = isUserMoment 
                    ? `<img src="https://img.heliar.top/file/1770357709135_删除_delete.png" class="moment-delete-btn" onclick="confirmDeleteMoment(${moment.id})">`
                    : '';

                listHtml += `
                    <div class="moment-item" id="moment-${moment.id}">
                        <img src="${authorAvatar}" class="moment-item-avatar" alt="avatar">
                        <div class="moment-item-content">
                            <div class="moment-item-nickname">${escapeHtml(authorNickname)}</div>
                            ${moment.text ? `<div class="moment-item-text">${escapeHtml(moment.text)}</div>` : ''}
                            ${imageGridHtml}
                            <div class="moment-item-meta">
                                <div class="moment-item-meta-left">
                                    <span class="moment-timestamp">${formatTimestamp(moment.timestamp)}</span>
                                    ${privateTag}
                                    ${metaActionsHtml}
                                </div>
                                                               <div class="moment-actions-btn" onclick="toggleActionsPopup(${momentId}, event)">
                                    ··
                                    <div class="moment-actions-popup">
                                        <div class="moment-popup-btn" onclick="toggleLike(${momentId})"><img src="${likeIconUrl}"> ${likeBtnText}</div>
                                        <div class="moment-popup-btn" onclick="openCommentInput(${momentId})"><img src="https://img.heliar.top/file/1770353307524_评论_comment.png"> 评论</div>
                                    </div>
                                </div>
                            </div>
                            ${(likesHtml || commentsHtml) ? `<div class="moment-feedback">${likesHtml}${commentsHtml}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            listHtml = '<div class="moments-empty-placeholder">还没有动态，点击右上角相机发布第一条吧！</div>';
        }
        
        wrapper.innerHTML = `
            <div class="moments-header">
                <div class="moments-cover-img" style="background-image: url(${momentsProfile.cover})" onclick="editMomentsCover()"></div>
                <div class="moments-user-info">
                    <span class="moments-user-nickname">${escapeHtml(userProfile.nickname)}</span>
                    <img src="${momentsProfile.avatar}" class="moments-user-avatar" alt="avatar" onclick="editMomentsAvatar()">
                </div>
            </div>
            <div id="moments-list">
                ${listHtml}
            </div>
        `;
    }
    
    window.confirmDeleteMoment = (momentId) => {
        currentDeleteMomentId = momentId;
        document.getElementById('delete-moment-confirm-modal').classList.add('active');
    };
    
    window.executeDeleteMoment = () => {
        if (!currentDeleteMomentId) return;
        let moments = getMomentsData();
        const updatedMoments = moments.filter(m => m.id !== currentDeleteMomentId);
        saveMomentsData(updatedMoments);
        closeDeleteModal('delete-moment-confirm-modal');
        renderMomentsPage();
        showToast("动态已删除");
        currentDeleteMomentId = null;
    };


    window.editMomentsAvatar = () => {
        const p = getMomentsProfile();
        const newUrl = prompt("请输入朋友圈头像图片链接:", p.avatar);
        if (newUrl && newUrl.trim() !== '') {
            p.avatar = newUrl.trim();
            saveMomentsProfile(p);
            renderMomentsPage(); 
            showToast("朋友圈头像已更新");
        }
    };
    
    window.editMomentsCover = () => {
        const p = getMomentsProfile();
        const newUrl = prompt("请输入朋友圈背景图片链接:", p.cover);
        if (newUrl && newUrl.trim() !== '') {
            p.cover = newUrl.trim();
            saveMomentsProfile(p);
            showToast("朋友圈背景已更新");
        }
    };

    window.toggleActionsPopup = (momentId, event) => {
        event.stopPropagation();
        // Close any other open popups first
        document.querySelectorAll('.moment-actions-popup.active').forEach(p => {
             if (!p.closest(`#moment-${momentId}`)) {
                p.classList.remove('active');
            }
        });
        const popup = document.querySelector(`#moment-${momentId} .moment-actions-popup`);
        if (popup) {
            popup.classList.toggle('active');
        }
    };

    document.addEventListener('click', (e) => { 
        // Hide moments action popups
        if (!e.target.closest('.moment-actions-btn')) {
            document.querySelectorAll('.moment-actions-popup').forEach(p => p.classList.remove('active'));
        }
        
        // Hide chat bubble context menu
        if (activeMsgIdForMenu && !e.target.closest('.bubble-context-menu')) {
            closeBubbleMenu();
        }
    });

    window.openMomentsActionSheet = () => {
        document.getElementById('moments-action-sheet-overlay').classList.add('active');
    };
    
    window.closeMomentsActionSheet = () => {
        document.getElementById('moments-action-sheet-overlay').classList.remove('active');
    };
    
    window.handleMomentAction = (action) => {
        closeMomentsActionSheet();
        if (action === 'shoot' || action === 'album') {
            setTimeout(() => {
                openAddMomentModal();
            }, 300);
        }
    };

    window.openAddMomentModal = () => {
        document.getElementById('add-moment-text').value = '';
        tempMomentImages = [];
        renderAddMomentGrid();
        document.getElementById('add-moment-modal').classList.add('active');
    };
    window.closeAddMomentModal = () => {
        document.getElementById('add-moment-modal').classList.remove('active');
    };

    window.triggerMomentImageUpload = () => {
        document.getElementById('input-moment-image').click();
    };

    window.handleMomentImageUpload = (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        let processedCount = 0;
        files.forEach(file => {
            if (tempMomentImages.length >= 9) return;
            compressImage(file, 600, (base64) => {
                tempMomentImages.push(base64);
                processedCount++;
                if (processedCount === files.length || tempMomentImages.length === 9) {
                     renderAddMomentGrid();
                }
            });
        });
        event.target.value = '';
    };
    
    function renderAddMomentGrid() {
        const grid = document.getElementById('add-moment-grid');
        const uploadBtn = document.createElement('div');
        uploadBtn.className = 'add-moment-image-upload';
        uploadBtn.innerHTML = '<span id="moment-upload-icon">+</span>';
        uploadBtn.onclick = triggerMomentImageUpload;

        grid.innerHTML = '';
        
        tempMomentImages.forEach((src, index) => {
            const cell = document.createElement('div');
            cell.className = 'add-moment-img-cell';
            cell.innerHTML = `
                <img src="${src}">
                <div class="add-moment-remove-img" onclick="removeMomentImage(${index})">✕</div>
            `;
            grid.appendChild(cell);
        });
        
        if (tempMomentImages.length < 9) {
            grid.appendChild(uploadBtn);
        }
    }
    
    window.removeMomentImage = (index) => {
        tempMomentImages.splice(index, 1);
        renderAddMomentGrid();
    };

    window.saveNewMoment = () => {
        const text = document.getElementById('add-moment-text').value.trim();
        const images = [...tempMomentImages]; 
        if (!text && images.length === 0) {
            showToast("内容不能为空");
            return;
        }
        const profile = getUserProfile();
        const newMoment = {
            id: Date.now(),
            authorId: profile.qqId, // User's own moment
            timestamp: Date.now(),
            text: text,
            images: images,
            likes: [],
            comments: [],
            isPrivate: false // User posts are never private by default
        };
        let moments = getMomentsData();
        moments.unshift(newMoment);
        saveMomentsData(moments);
        showToast("发布成功");
        renderMomentsPage();
        closeAddMomentModal();
    };
    
    window.toggleLike = (momentId) => {
        let moments = getMomentsData();
        const momentIndex = moments.findIndex(m => m.id === momentId);
        if (momentIndex === -1) return;
        
        const profile = getUserProfile();
        const myId = profile.qqId;
        const likeIndex = moments[momentIndex].likes.indexOf(myId);

        if (likeIndex > -1) {
            moments[momentIndex].likes.splice(likeIndex, 1);
        } else {
            moments[momentIndex].likes.push(myId);
        }
        
        saveMomentsData(moments);
        renderMomentsPage();
        
        // Ensure the popup closes after action
        const popup = document.querySelector(`#moment-${momentId} .moment-actions-popup`);
        if (popup) popup.classList.remove('active');
    };

    window.openCommentInput = (momentId) => {
        currentCommentMomentId = momentId;
        const modal = document.getElementById('moments-comment-modal');
        const overlay = document.getElementById('moments-comment-overlay');
        const inputField = document.getElementById('moments-comment-input');
        
        // Ensure the popup closes before opening the comment input
        const popup = document.querySelector(`#moment-${momentId} .moment-actions-popup`);
        if (popup) popup.classList.remove('active');
        
        inputField.value = '';
        modal.classList.add('active');
        overlay.classList.add('active');
        
        setTimeout(() => {
            inputField.focus();
        }, 100);
    };

    window.closeCommentInput = () => {
        document.getElementById('moments-comment-modal').classList.remove('active');
        document.getElementById('moments-comment-overlay').classList.remove('active');
        document.getElementById('moments-comment-input').blur();
        currentCommentMomentId = null;
    };

    window.handleCommentKey = (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            submitComment();
        }
    };

    window.submitComment = () => {
        if (!currentCommentMomentId) return;
        
        const inputField = document.getElementById('moments-comment-input');
        const commentText = inputField.value.trim();
        if (!commentText) return;

        let moments = getMomentsData();
        const momentIndex = moments.findIndex(m => m.id === currentCommentMomentId);
        if (momentIndex === -1) return;

        const profile = getUserProfile();
        const newComment = {
            user: profile.nickname,
            userId: profile.qqId,
            text: commentText
        };
        
        moments[momentIndex].comments.push(newComment);
        saveMomentsData(moments);
        
        closeCommentInput();
        renderMomentsPage();
    };

    // --- NEW: Urge To Post Logic ---
    window.openUrgeToPostModal = () => {
        const overlay = document.getElementById('urge-post-overlay');
        const listContainer = document.getElementById('urge-post-char-list');
        listContainer.innerHTML = '';
        selectedUrgeCharIds.clear();

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        if (contacts.length === 0) {
            listContainer.innerHTML = '<p style="color: #ccc; grid-column: span 4; text-align:center;">还没有创建角色哦~</p>';
        } else {
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'urge-post-char-item';
                item.dataset.contactId = contact.id;
                item.innerHTML = `
                    <img src="${contact.avatar}" alt="${contact.alias || contact.name}">
                    <span>${escapeHtml(contact.alias || contact.name)}</span>
                `;
                item.onclick = () => {
                    item.classList.toggle('selected');
                    const id = parseInt(item.dataset.contactId);
                    if (selectedUrgeCharIds.has(id)) {
                        selectedUrgeCharIds.delete(id);
                    } else {
                        selectedUrgeCharIds.add(id);
                    }
                };
                listContainer.appendChild(item);
            });
        }
        
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('active'), 10);
    };

    window.closeUrgeToPostModal = () => {
        const overlay = document.getElementById('urge-post-overlay');
        overlay.classList.remove('active');
        setTimeout(() => overlay.style.display = 'none', 300);
    };

    async function generateMomentForCharacter(contact) {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings?.api?.url || !settings?.api?.key || !settings?.api?.model) {
            showToast('请先配置API', 3000);
            return null;
        }

        let worldBookContext = "无特殊设定";
        if (contact.worldbookIds && contact.worldbookIds.length > 0) {
            const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const wbContents = contact.worldbookIds.map(id => {
                 const wb = worldbooks.find(b => b.id === id);
                 if (wb) return `【世界书：${wb.title}】\n` + wb.entries.map(e => `[${e.key || '设定'}]: ${e.content}`).join('\n');
                 return '';
            }).filter(Boolean).join('\n\n');
            if (wbContents) worldBookContext = wbContents;
        }
        
        // MODIFIED PROMPT
        const prompt = `你现在是角色“${contact.alias || contact.name}”，你的核心人设是：“${contact.persona}”。
        世界观背景设定如下（必须严格遵守）：
        ${worldBookContext}
        现在，请你以角色的身份，发布一条朋友圈动态。
        
        **输出要求 (必须严格遵守):**
        1. 你必须以 JSON 格式输出。
        2. JSON 必须包含两个字段: "isPrivate" (布尔值) 和 "text" (字符串)。
        3. "isPrivate": 如果动态内容是关于用户的、私密的、不好意思公开说的暗示、或悄悄话，这个值必须是 true。其他情况（如日常分享、风景、工作学习等）则为 false。
        4. "text": 这是动态的文案内容。文案要自然、口语化，符合角色人设。
        
        **示例1 (公开动态):**
        {
          "isPrivate": false,
          "text": "今天天气真好，出门散步了。"
        }
        
        **示例2 (私密动态):**
        {
          "isPrivate": true,
          "text": "又在想你了...不知道你现在在做什么。"
        }
        
        **现在，请生成你的动态JSON：**`;
        
        try {
            const res = await fetch(`${settings.api.url.endsWith('/v1') ? settings.api.url : settings.api.url + '/v1'}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.api.key}` },
                body: JSON.stringify({
                    model: settings.api.model || 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: parseFloat(settings.api.temp || 0.9),
                })
            });
            if (!res.ok) throw new Error('API request failed');
            const data = await res.json();
            const rawContent = data.choices[0].message.content.trim();
            
            // Extract JSON from the response
            const jsonMatch = rawContent.match(/{[\s\S]*}/);
            if (!jsonMatch) throw new Error("API did not return valid JSON.");
            
            const momentData = JSON.parse(jsonMatch[0]);

            if (typeof momentData.isPrivate !== 'boolean' || typeof momentData.text !== 'string') {
                throw new Error("Invalid JSON structure from API.");
            }
            
            return {
                id: Date.now() + Math.random(),
                authorId: contact.id,
                timestamp: Date.now(),
                text: momentData.text,
                isPrivate: momentData.isPrivate, // New field
                images: [],
                likes: [],
                comments: []
            };
        } catch (error) {
            console.error(`Failed to generate moment for ${contact.alias || contact.name}:`, error);
            showToast(`为“${contact.alias || contact.name}”生成动态失败`, 3000);
            return null;
        }
    }

        window.confirmUrgeToPost = async () => {
        if (selectedUrgeCharIds.size === 0) {
            showToast('请至少选择一个角色');
            return;
        }

        closeUrgeToPostModal();
        showToast('正在生成动态，请稍候...', 5000); // 延长提示时间

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        let moments = getMomentsData();

        // 创建一个包含所有生成任务的“承诺”数组
        const generationPromises = Array.from(selectedUrgeCharIds).map(contactId => {
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                // 返回生成动态的函数调用，让它在后台执行
                return generateMomentForCharacter(contact);
            }
            // 如果找不到角色，返回一个已解决的空值
            return Promise.resolve(null);
        });

        // 等待所有“承诺”完成
        const newMoments = (await Promise.all(generationPromises)).filter(Boolean); // filter(Boolean) 会过滤掉所有 null 的结果

        if (newMoments.length > 0) {
            // 将所有新生成的动态一次性添加到最前面
            moments.unshift(...newMoments);
            saveMomentsData(moments);
            renderMomentsPage();
            showToast(`成功生成 ${newMoments.length} 条动态！`);
        } else {
            showToast('未能生成任何动态，请检查API或稍后重试。');
        }
    };
    
    // --- Auto Post Moment Logic ---
    function scheduleAutoPost(contactId, intervalMinutes) {
        if (autoPostTimers[contactId]) {
            clearInterval(autoPostTimers[contactId]);
        }
        if (intervalMinutes > 0) {
            const intervalMs = intervalMinutes * 60 * 1000;
            autoPostTimers[contactId] = setInterval(async () => {
                const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
                const contact = contacts.find(c => c.id === contactId);
                if (contact && contact.autoPostEnabled) {
                    console.log(`[AutoPost] Triggering post for ${contact.alias || contact.name}`);
                    const newMoment = await generateMomentForCharacter(contact);
                    if (newMoment) {
                        let moments = getMomentsData();
                        moments.unshift(newMoment);
                        saveMomentsData(moments);
                        // If user is on moments page, refresh it
                        if (document.getElementById('chat-tab-2').classList.contains('active')) {
                            renderMomentsPage();
                        }
                        console.log(`[AutoPost] Successfully posted for ${contact.alias || contact.name}`);
                    }
                } else {
                    // Stop timer if the setting is disabled
                    clearInterval(autoPostTimers[contactId]);
                    delete autoPostTimers[contactId];
                }
            }, intervalMs);
        }
    }

    function stopAutoPost(contactId) {
        if (autoPostTimers[contactId]) {
            clearInterval(autoPostTimers[contactId]);
            delete autoPostTimers[contactId];
            console.log(`[AutoPost] Stopped timer for contact ID ${contactId}`);
        }
    }

    function initializeAllAutoPosts() {
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        contacts.forEach(contact => {
            if (contact.autoPostEnabled && contact.autoPostInterval > 0) {
                scheduleAutoPost(contact.id, contact.autoPostInterval);
            }
        });
    }

    // --- World Book App Logic ---
    window.openWorldBookApp = () => { body.classList.add('worldbook-active'); renderWorldBooks(); };
    window.closeWorldBookApp = () => { body.classList.remove('worldbook-active'); closeWorldBookDetail(); closeWorldBookColorSettings(); };
    window.openWorldBookAddModal = () => { document.getElementById('wb-title-input').value = ""; document.getElementById('wb-dynamic-entries').innerHTML = ''; addWorldBookEntryRow(); document.getElementById('worldbook-add-modal').classList.add('active'); };
    window.closeWorldBookAddModal = () => { document.getElementById('worldbook-add-modal').classList.remove('active'); };
    window.addWorldBookEntryRow = () => { const container = document.getElementById('wb-dynamic-entries'); const row = document.createElement('div'); row.className = 'wb-entry-row wb-dynamic-row'; row.innerHTML = `<input type="text" class="wb-entry-input key" placeholder="名称（可选）"><textarea class="wb-entry-input val" placeholder="世界书内容"></textarea>`; container.appendChild(row); };
    window.saveWorldBook = () => { const title = document.getElementById('wb-title-input').value.trim(); if(!title) { showToast("请输入世界书名"); return; } const rows = document.querySelectorAll('.wb-dynamic-row'); const entries = []; let hasContent = false; rows.forEach(row => { const key = row.querySelector('.key').value.trim(); const val = row.querySelector('.val').value.trim(); if(val) { entries.push({ key: key, content: val }); hasContent = true; } }); if (!hasContent) { showToast("请至少输入一条世界书内容"); return; } const newBook = { id: Date.now(), title: title, entries: entries, coverColor: '#EAEAEA', coverImage: '' }; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) {} books.push(newBook); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("世界书已保存"); closeWorldBookAddModal(); renderWorldBooks(); };
    
    window.renderWorldBooks = () => { 
        const container = document.getElementById('worldbook-list'); 
        container.innerHTML = ''; 
        let books = []; 
        try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) { books = []; } 
        books.sort((a,b) => b.id - a.id).forEach(book => { 
            const item = document.createElement('div'); 
            item.className = 'wb-book-item'; 
            item.onclick = () => viewWorldBook(book.id); 
            item.innerHTML = `<div class="wb-book-cover"><div class="wb-book-name">${escapeHtml(book.title)}</div></div>`; 
            const coverEl = item.querySelector('.wb-book-cover'); 
            
            if (book.coverImage) {
                coverEl.style.backgroundImage = `url(${book.coverImage})`;
                coverEl.style.backgroundColor = 'transparent';
                item.querySelector('.wb-book-name').style.color = "white";
                item.querySelector('.wb-book-name').style.textShadow = "0 1px 4px rgba(0,0,0,0.8)";
            } else if (book.coverColor) { 
                coverEl.style.background = book.coverColor; 
            } 
            container.appendChild(item); 
        }); 
    };
    window.viewWorldBook = (id) => { currentWorldBookId = id; renderWorldBookDetailView(); document.getElementById('worldbook-detail-modal').classList.add('active'); };
    function renderWorldBookDetailView() { if (!currentWorldBookId) return; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) {} const book = books.find(b => b.id === currentWorldBookId); if(!book) { closeWorldBookDetail(); return; } document.getElementById('wb-detail-title-text').innerText = book.title; const contentArea = document.getElementById('wb-detail-content-area'); contentArea.innerHTML = ''; book.entries.forEach((entry, index) => { const div = document.createElement('div'); div.className = 'wb-detail-item'; div.id = `wb-entry-item-${index}`; div.innerHTML = `<div class="wb-detail-item-content">${entry.key ? `<div class="wb-detail-key">${escapeHtml(entry.key)}</div>` : ''}<div class="wb-detail-val">${escapeHtml(entry.content)}</div></div><div class="wb-detail-item-actions"><button onclick="editWorldBookEntry(${index})">修改</button><button onclick="deleteWorldBookEntry(${index})">删除</button></div>`; contentArea.appendChild(div); }); }
    window.editWorldBookEntry = (index) => { const itemEl = document.getElementById(`wb-entry-item-${index}`); if (!itemEl) return; const books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const book = books.find(b => b.id === currentWorldBookId); if (!book || !book.entries[index]) return; const entry = book.entries[index]; itemEl.innerHTML = `<div class="edit-form"><input type="text" class="wb-entry-input key" placeholder="名称（可选）" value="${escapeHtml(entry.key)}"><textarea class="wb-entry-input val" placeholder="世界书内容">${escapeHtml(entry.content)}</textarea></div><div class="wb-detail-item-actions"><button class="save" onclick="saveWorldBookEntry(${index})">保存</button><button onclick="renderWorldBookDetailView()">取消</button></div>`; };
    window.saveWorldBookEntry = (index) => { const itemEl = document.getElementById(`wb-entry-item-${index}`); const newKey = itemEl.querySelector('.key').value.trim(); const newVal = itemEl.querySelector('.val').value.trim(); if (!newVal) { showToast("内容不能为空"); return; } let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const bookIndex = books.findIndex(b => b.id === currentWorldBookId); if (bookIndex !== -1 && books[bookIndex].entries[index]) { books[bookIndex].entries[index] = { key: newKey, content: newVal }; localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("已保存"); renderWorldBookDetailView(); } };
    window.deleteWorldBookEntry = (index) => { if (!confirm("确定要删除这个条目吗？")) return; let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const bookIndex = books.findIndex(b => b.id === currentWorldBookId); if (bookIndex !== -1 && books[bookIndex].entries[index]) { books[bookIndex].entries.splice(index, 1); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("已删除"); renderWorldBookDetailView(); } };
    window.closeWorldBookDetail = () => { document.getElementById('worldbook-detail-modal').classList.remove('active'); currentWorldBookId = null; };
    window.deleteCurrentWorldBook = () => { if(!currentWorldBookId) return; if(confirm("确定要删除这本世界书吗？此操作不可撤销。")) { let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); books = books.filter(b => b.id !== currentWorldBookId); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); closeWorldBookDetail(); renderWorldBooks(); showToast("世界书已删除"); } };
    
    window.openWorldBookColorSettings = () => { 
        const page = document.getElementById('worldbook-color-page'); 
        const container = document.getElementById('wb-color-list'); 
        container.innerHTML = ''; 
        let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); 
        if (books.length === 0) { 
            container.innerHTML = '<p style="text-align:center; color:#999;">还没有创建世界书哦</p>'; 
        } else { 
            books.forEach(book => { 
                const item = document.createElement('div'); 
                item.className = 'wb-color-item'; 
                item.innerHTML = `
                    <span class="wb-color-item-name">${escapeHtml(book.title)}</span>
                    <button class="wb-cover-upload-btn" onclick="triggerWbCoverUpload(${book.id})">封面图</button>
                    <input type="color" class="wb-color-input" data-book-id="${book.id}" value="${book.coverColor || '#EAEAEA'}">
                `; 
                container.appendChild(item); 
            }); 
        } 
        page.classList.add('active'); 
    };
    window.closeWorldBookColorSettings = () => { document.getElementById('worldbook-color-page').classList.remove('active'); };
    window.saveWorldBookColors = () => { 
        let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); 
        const colorInputs = document.querySelectorAll('.wb-color-input'); 
        colorInputs.forEach(input => { 
            const bookId = parseInt(input.dataset.bookId); 
            const newColor = input.value; 
            const bookIndex = books.findIndex(b => b.id === bookId); 
            if (bookIndex !== -1) { 
                books[bookIndex].coverColor = newColor; 
            } 
        }); 
        localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); 
        showToast("设置已保存"); 
        closeWorldBookColorSettings(); 
        renderWorldBooks(); 
    };
    
    window.triggerWbCoverUpload = (bookId) => {
        currentWbCoverUploadId = bookId;
        document.getElementById('input-wb-cover').click();
    };
    
    window.handleWbCoverUpload = (event) => {
        const file = event.target.files[0];
        if (!file || !currentWbCoverUploadId) return;
        
        compressImage(file, 400, (base64) => {
            let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const index = books.findIndex(b => b.id === currentWbCoverUploadId);
            if (index !== -1) {
                books[index].coverImage = base64;
                localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books));
                showToast("封面图已上传");
            }
        });
        event.target.value = ''; // Reset input
    };

    // --- Wallet App Logic ---
    window.openWalletApp = () => { body.classList.add('wallet-active'); loadWalletUI(); };
    window.closeWalletApp = () => { body.classList.remove('wallet-active'); };
    function getWalletData() { try { const data = localStorage.getItem(WALLET_DATA_KEY); return data ? JSON.parse(data) : { balance: 0.00, transactions: [] }; } catch (e) { return { balance: 0.00, transactions: [] }; } }
    function saveWalletData(data) { localStorage.setItem(WALLET_DATA_KEY, JSON.stringify(data)); }
    function loadWalletUI() { 
        const profile = getUserProfile(); 
        document.getElementById('wallet-avatar').src = profile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; 
        document.getElementById('wallet-nickname').innerText = profile.nickname || 'User'; 
        const data = getWalletData(); 
        document.getElementById('wallet-total-balance').innerText = parseFloat(data.balance).toFixed(2); 
        const now = new Date(); 
        const currentMonthStr = `${now.getFullYear()}-${now.getMonth() + 1}`; 
        document.getElementById('wallet-current-month').innerText = `${now.getMonth() + 1}月`; 
        let monthIncome = 0; 
        let monthExpense = 0; 
        let monthTransactions = []; 
        data.transactions.forEach(t => { 
            const tDate = new Date(t.timestamp); 
            const tMonthStr = `${tDate.getFullYear()}-${tDate.getMonth() + 1}`; 
            if (tMonthStr === currentMonthStr) { 
                monthTransactions.push(t); 
                if (t.type === 'recharge' || t.type === 'income' || t.type === 'transfer_received' || t.type === 'transfer_refund') {
                    monthIncome += parseFloat(t.amount);
                } else if (t.type === 'transfer_sent' || t.type === 'expense') {
                    monthExpense += parseFloat(t.amount); 
                }
            } 
        }); 
        document.getElementById('wallet-month-income').innerText = monthIncome.toFixed(2); 
        document.getElementById('wallet-month-expense').innerText = monthExpense.toFixed(2); 
        const listContainer = document.getElementById('wallet-transaction-list'); 
        listContainer.innerHTML = ''; 
        if (monthTransactions.length === 0) { 
            listContainer.innerHTML = '<div class="wallet-empty">本月暂无收支记录</div>'; 
        } else { 
            monthTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(t => { 
                const item = document.createElement('div'); 
                item.className = 'wallet-item'; 
                const dateObj = new Date(t.timestamp); 
                const dateStr = `${dateObj.getMonth()+1}-${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`; 
                
                let icon = '💰';
                let typeClass = '';
                let sign = '';
                
                switch(t.type) {
                    case 'recharge': icon = '💳'; typeClass = 'in'; sign = '+'; break;
                    case 'transfer_sent': icon = '💸'; typeClass = 'out'; sign = '-'; break;
                    case 'transfer_received': icon = '🧧'; typeClass = 'in'; sign = '+'; break;
                    case 'transfer_refund': icon = '↩️'; typeClass = 'in'; sign = '+'; break; // Refund is income
                    case 'income': icon = '🧧'; typeClass = 'in'; sign = '+'; break;
                    case 'expense': icon = '🛍️'; typeClass = 'out'; sign = '-'; break;
                }

                item.innerHTML = `<div class="wallet-item-icon">${icon}</div><div class="wallet-item-info"><div class="wallet-item-cat">${escapeHtml(t.desc || t.type)}</div><div class="wallet-item-date">${dateStr}</div></div><div class="wallet-item-amount ${typeClass}">${sign}${parseFloat(t.amount).toFixed(2)}</div>`; 
                listContainer.appendChild(item); 
            }); 
        } 
    }

    window.openWalletModal = (type) => { 
        currentWalletType = type; 
        document.getElementById('wallet-amount-input').value = ''; 
        const modal = document.getElementById('wallet-add-modal');
        modal.querySelector('.wallet-modal-title').textContent = (type === 'recharge') ? '充值' : '记一笔';
        modal.querySelector('.wallet-confirm-btn').textContent = (type === 'recharge') ? '确认充值' : '确认';
        
        modal.classList.add('active'); 
    };
    
    window.closeWalletModal = () => { document.getElementById('wallet-add-modal').classList.remove('active'); };

    window.saveRecharge = () => { 
        const amountStr = document.getElementById('wallet-amount-input').value; 
        const amount = parseFloat(amountStr); 
        if (isNaN(amount) || amount <= 0) { 
            showToast('请输入有效金额'); return; 
        } 
        const data = getWalletData(); 
        const transaction = { 
            id: Date.now(), 
            type: 'recharge', 
            amount: amount, 
            desc: '充值', 
            timestamp: Date.now() 
        }; 
        data.transactions.push(transaction); 
        data.balance = parseFloat(data.balance) + amount; 
        saveWalletData(data); 
        closeWalletModal(); 
        loadWalletUI(); 
        showToast('充值成功'); 
    };

    // --- Friend Adding & Chat List Logic ---
    window.openAddFriendModal = () => { tempAvatarUrl = ""; document.getElementById('new-friend-name').value = ""; document.getElementById('new-friend-alias').value = ""; document.getElementById('new-friend-avatar-url').value = ""; const preview = document.getElementById('new-friend-avatar-preview'); preview.style.display = 'none'; preview.src = ""; document.getElementById('avatar-placeholder-icon').style.display = 'block'; document.getElementById('add-friend-modal').classList.add('active'); };
    window.closeAddFriendModal = () => { document.getElementById('add-friend-modal').classList.remove('active'); };
    window.triggerAvatarUpload = () => { document.getElementById('input-friend-avatar').click(); };
    window.handleAvatarUrlInput = (input) => { const url = input.value.trim(); const imgEl = document.getElementById('new-friend-avatar-preview'); if (url) { tempAvatarUrl = url; imgEl.src = url; imgEl.style.display = 'block'; document.getElementById('avatar-placeholder-icon').style.display = 'none'; } else { tempAvatarUrl = ""; imgEl.style.display = 'none'; document.getElementById('avatar-placeholder-icon').style.display = 'block'; } };
    window.handleFriendAvatarUpload = (event) => { compressImage(event.target.files[0], 200, (base64) => { tempAvatarUrl = base64; document.getElementById('new-friend-avatar-url').value = ""; const imgEl = document.getElementById('new-friend-avatar-preview'); imgEl.src = tempAvatarUrl; imgEl.style.display = 'block'; document.getElementById('avatar-placeholder-icon').style.display = 'none'; }); };
    window.saveNewFriend = () => { const name = document.getElementById('new-friend-name').value.trim(); const alias = document.getElementById('new-friend-alias').value.trim(); if (!name) { showToast("请输入姓名"); return; } if (!tempAvatarUrl) { showToast("请上传头像或输入URL"); return; } let contacts = []; try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } if (contacts.find(c => c.name === name || (alias && c.alias === alias))) { showToast("该好友已存在"); return; } const newContact = { id: Date.now(), name: name, alias: alias, avatar: tempAvatarUrl, lastMsg: "点击开始聊天", timestamp: Date.now(), signature: "", backgroundImage: "", isPinned: false, worldbookIds: [], timePerceptionEnabled: false, memoryDepth: 15, autoPostEnabled: false, autoPostInterval: 60 }; contacts.unshift(newContact); try { localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); showToast("添加成功！"); closeAddFriendModal(); renderChatList(); renderContactList(); } catch (e) { console.error("Error saving contact:", e); showToast("保存失败，图片可能过大"); } };

    window.renderChatList = () => { 
        const container = document.getElementById('chat-list-container'); 
        let contacts = []; 
        try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } 
        
        if (contacts.length === 0) { 
            container.innerHTML = '<div class="chat-placeholder-text">没有新信息</div>'; 
            return; 
        } 
        
        container.innerHTML = ''; 
        contacts.sort((a, b) => b.timestamp - a.timestamp).forEach(contact => { 
            const displayName = contact.alias || contact.name; 
            const item = document.createElement('div'); 
            item.className = 'chat-list-item'; 
            item.onclick = (e) => { e.stopPropagation(); openChatWindow(contact.id); }; 
            item.innerHTML = `<img src="${contact.avatar}" class="chat-list-avatar" alt="avatar" onerror="this.src='https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'"><div class="chat-list-info"><div class="chat-list-name">${escapeHtml(displayName)}</div><div class="chat-list-msg">${escapeHtml(contact.lastMsg || '点击开始聊天')}</div></div>`; 
            container.appendChild(item); 
        }); 
    };
    
    function getSortLetter(str) { if (!str) return '#'; const firstChar = str.charAt(0); if (/[a-zA-Z]/.test(firstChar)) return firstChar.toUpperCase(); const pinyin = "ABCDEFGHJKLMNOPQRSTWXYZ"; const zh = "阿芭擦搭蛾发噶哈击喀垃妈拿哦啪期然撒塌挖昔压匝"; if (firstChar.localeCompare('阿', 'zh-CN') < 0) return '#'; if (firstChar.localeCompare('匝', 'zh-CN') >= 0) return 'Z'; for (let i = 0; i < zh.length; i++) { if (firstChar.localeCompare(zh[i], 'zh-CN') >= 0 && firstChar.localeCompare(zh[i+1], 'zh-CN') < 0) return pinyin[i]; } return '#'; }
    
    window.renderContactList = () => { 
        const container = document.getElementById('contact-list-container'); 
        const indexBar = document.getElementById('alpha-index-bar'); 
        let contacts = []; 
        try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } 
        
        if (contacts.length === 0) { 
            container.innerHTML = '<div class="chat-placeholder-text">通讯录为空</div>'; 
            indexBar.innerHTML = ''; 
            return; 
        } 
        
        container.innerHTML = ''; 
        indexBar.innerHTML = ''; 
        const groups = { '🔝': [], ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('').reduce((acc, l) => ({...acc, [l]: []}), {}) }; 
        contacts.forEach(c => { if (c.isPinned) { groups['🔝'].push(c); } else { const letter = getSortLetter(c.alias || c.name); (groups[letter] || groups['#']).push(c); } }); 
        const activeLetters = []; 
        
        const renderGroup = (key, title) => { 
            const groupContacts = groups[key]; 
            if (groupContacts.length > 0) { 
                groupContacts.sort((a, b) => (a.alias||a.name).localeCompare(b.alias||b.name, 'zh-CN')); 
                const titleDiv = document.createElement('div'); 
                titleDiv.className = 'contact-section-title'; 
                titleDiv.id = `group-${key}`; 
                titleDiv.innerText = title; 
                container.appendChild(titleDiv); 
                activeLetters.push({ key: key, id: `group-${key}` }); 
                groupContacts.forEach(contact => container.appendChild(createContactItem(contact))); 
            } 
        }; 
        
        renderGroup('🔝', '🔝'); 
        'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('').forEach(key => renderGroup(key, key)); 
        'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => { 
                  const exists = activeLetters.find(x => x.key === letter); 
            const item = document.createElement('div'); 
            item.className = 'alpha-index-item'; 
            item.innerText = letter; 
            if (exists) { 
                item.onclick = (e) => { e.stopPropagation(); document.getElementById(exists.id).scrollIntoView({ behavior: 'smooth' }); }; 
                item.style.color = '#555'; 
            } else { 
                item.style.color = '#eee'; 
                item.onclick = (e) => e.stopPropagation(); 
            } 
            indexBar.appendChild(item); 
        }); 
    };

    function createContactItem(contact) { 
        const item = document.createElement('div'); 
        item.className = 'contact-item'; 
        if(contact.isPinned) item.classList.add('pinned'); 
        const displayName = contact.alias || contact.name; 
        const signature = contact.signature ? escapeHtml(contact.signature) : ''; 
        item.innerHTML = `<img src="${contact.avatar}" class="contact-avatar"><div class="chat-list-info"><div class="contact-name">${escapeHtml(displayName)}</div><div class="contact-signature">${signature}</div></div><div class="pinned-tag">★</div>`; 
        item.onclick = () => { currentChatContactId = contact.id; openRoleSettings(); }; 
        let pressTimer; 
        item.addEventListener('touchstart', (e) => { pressTimer = setTimeout(() => { toggleContactPin(contact.id); }, 600); }); 
        item.addEventListener('touchend', () => clearTimeout(pressTimer)); 
        item.addEventListener('touchmove', () => clearTimeout(pressTimer)); 
        return item; 
    }

    window.toggleContactPin = (id) => { let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const idx = contacts.findIndex(c => c.id === id); if (idx !== -1) { contacts[idx].isPinned = !contacts[idx].isPinned; localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); renderContactList(); showToast(contacts[idx].isPinned ? "已置顶" : "已取消置顶"); } };

    // --- Role Chat Conversation & Transfer Logic ---
    window.openChatWindow = (contactId) => { 
        currentChatContactId = contactId; 
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contact = contacts.find(c => c.id === contactId); 
        if (!contact) return; 
        document.getElementById('chat-conv-title').innerText = contact.alias || contact.name; 
        document.getElementById('chat-conv-signature').innerText = contact.signature || ''; 
        const view = document.getElementById('chat-conversation-view'); 
        view.style.backgroundImage = contact.backgroundImage ? `url(${contact.backgroundImage})` : ''; 
        let styleTag = document.getElementById('custom-chat-style'); 
        if (!styleTag) { styleTag = document.createElement('style'); styleTag.id = 'custom-chat-style'; document.head.appendChild(styleTag); } 
        styleTag.innerHTML = contact.customCss || ''; 
        
        isMultiSelectMode = false;
        selectedMsgIds.clear();
        document.getElementById('chat-multiselect-footer').classList.remove('active');
        document.getElementById('chat-conv-messages').classList.remove('multi-select-active');
        
        view.classList.add('active'); 
        renderConversationMessages(); 
    };
    
    window.closeChatConversation = () => { document.getElementById('chat-conversation-view').classList.remove('active'); currentChatContactId = null; const styleTag = document.getElementById('custom-chat-style'); if (styleTag) styleTag.innerHTML = ''; renderChatList(); };
    function getMessagesKey(contactId) { return `chat_msgs_${contactId}`; }
    
    function formatChatTime(ts) {
        const now = new Date();
        const date = new Date(ts);
        const diff = now - date;
        const diffHours = diff / 3600000;
        
        const pad = n => n.toString().padStart(2, '0');
        const timeStr = `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        const dateStr = `${date.getMonth() + 1}月${date.getDate()}`;
        
        if (now.toDateString() === date.toDateString()) {
            return timeStr;
        }
        
        if (diffHours >= 24 && diffHours < 48) {
             return `昨天 ${timeStr}`;
        }
        
        const oneMonth = 30 * 24 * 60 * 60 * 1000;
        if (diff >= oneMonth) {
            const weeks = ['日', '一', '二', '三', '四', '五', '六'];
            return `${dateStr} 星期${weeks[date.getDay()]}`;
        }
        
        return `${dateStr} ${timeStr}`;
    }

    window.renderConversationMessages = () => {
        if (!currentChatContactId) return;
        const container = document.getElementById('chat-conv-messages');
        const key = getMessagesKey(currentChatContactId);
        let messages = []; try { messages = JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) { }
        container.innerHTML = '';

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        const themAvatar = contact ? contact.avatar : '';
        const globalProfile = getUserProfile();
        const meAvatar = (contact && contact.userAvatar) ? contact.userAvatar : (globalProfile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png');

        let lastMsgTime = 0;

        // Create a document fragment to build the list in memory
        const fragment = document.createDocumentFragment();

        messages.forEach(msg => {
            if (msg.timestamp - lastMsgTime > 5 * 60 * 1000) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'chat-time-stamp';
                timeDiv.innerText = formatChatTime(msg.timestamp);
                fragment.appendChild(timeDiv);
                lastMsgTime = msg.timestamp;
            }

            if (msg.type === 'recalled') {
                const tipDiv = document.createElement('div');
                tipDiv.className = 'msg-recalled-tip';
                tipDiv.innerText = msg.text;
                fragment.appendChild(tipDiv);
                return;
            }

            const row = document.createElement('div');
            row.className = `msg-bubble-row ${msg.type === 'sent' ? 'me' : 'them'}`;
            row.id = `msg-${msg.id}`; // Add ID for easier selection

            const checkbox = document.createElement('div');
            checkbox.className = `chat-checkbox ${selectedMsgIds.has(msg.id) ? 'checked' : ''}`;
            checkbox.onclick = (e) => { e.stopPropagation(); toggleMsgSelection(msg.id); };
            
            const avatar = document.createElement('img');
            avatar.src = msg.type === 'sent' ? meAvatar : themAvatar;
            avatar.className = 'msg-bubble-avatar';

            let contentHtml;
            if (msg.isTransfer) {
                contentHtml = createTransferCard(msg);
            } else {
                contentHtml = `<div class="msg-bubble-content">${escapeHtml(msg.text)}</div>`;
            }
            
            // This is the element that holds the bubble/card
            const contentElement = document.createRange().createContextualFragment(contentHtml).firstElementChild;
            contentElement.ondblclick = (e) => { 
                e.stopPropagation(); 
                showBubbleMenu(e, msg.id, msg.text, msg.type, msg.isTransfer); 
            };
            
            if (isMultiSelectMode) {
                row.onclick = (e) => { e.stopPropagation(); toggleMsgSelection(msg.id); };
            }
            
            row.appendChild(checkbox);
            if (msg.type === 'sent') {
                row.appendChild(contentElement);
                row.appendChild(avatar);
            } else {
                row.appendChild(avatar);
                row.appendChild(contentElement);
            }
            
            fragment.appendChild(row);
        });

        // Append the whole list at once
        container.appendChild(fragment);
        
        if (isMultiSelectMode) container.classList.add('multi-select-active');
        else container.classList.remove('multi-select-active');
        
        // Scroll to bottom only if not in multi-select mode
        if (!isMultiSelectMode) {
            container.scrollTop = container.scrollHeight;
        }
    };


    function createTransferCard(msg) {
        const { amount, transferStatus, id } = msg.transferData;
        const formattedAmount = parseFloat(amount).toFixed(2);
        
        let bgColor, statusText, iconUrl, clickHandler = '', mainText = '';
        
        const receiverName = msg.transferData.receiverName || '对方';
        
        if (msg.type === 'sent') { // User sent the transfer
            mainText = `转账给 ${escapeHtml(receiverName)}`;
            switch(transferStatus) {
                case 'pending':
                    bgColor = '#fd9806'; statusText = '待收款';
                    iconUrl = 'https://img.heliar.top/file/1770723126205_兑换4_exchange-four.png'; break;
                case 'accepted':
                    bgColor = '#fdddaf'; statusText = '对方已收钱';
                    iconUrl = 'https://img.heliar.top/file/1770726823712_校验_check-one.png'; break; // Original was wrong icon
                case 'rejected':
                    bgColor = '#fdddaf'; statusText = '对方已退还';
                    iconUrl = 'https://img.heliar.top/file/1770726817049_向下左角_corner-down-left.png'; break; // Use correct icon
            }
                } else { // Role sent the transfer to user
            mainText = '转账给你';
            switch(transferStatus) {
                case 'pending': // Role initiated a transfer, user needs to accept
                    bgColor = '#fd9806'; statusText = '待收款';
                    iconUrl = 'https://img.heliar.top/file/1770723126205_兑换4_exchange-four.png';
                    // 只有角色发的待收款气泡可以点击
                    clickHandler = `onclick="openReceiveTransferModal('${id}')" style="cursor: pointer;"`;
                    break;
                case 'accepted': // User accepted
                    bgColor = '#fdddaf'; statusText = '已收款';
                    iconUrl = 'https://img.heliar.top/file/1770726823712_校验_check-one.png'; break; // Original was wrong icon
                
                // --- MODIFIED: Use correct icon for rejected by user ---
                case 'rejected': // User rejected
                    bgColor = '#fdddaf'; statusText = '已退还';
                    iconUrl = 'https://img.heliar.top/file/1770726817049_向下左角_corner-down-left.png'; break;
            }
        }

        return `
            <div class="transfer-message-card" style="background-color: ${bgColor};" ${clickHandler} data-transfer-id="${id}">
                <div class="transfer-main">
                    <img src="${iconUrl}" class="transfer-icon">
                    <div class="transfer-details">
                        <div class="transfer-status">${mainText}</div>
                        <div class="transfer-amount">¥${formattedAmount}</div>
                    </div>
                </div>
                <div class="transfer-footer-text">${statusText}</div>
            </div>
        `;
    }

    // 新增：打开收款弹窗的函数
    window.openReceiveTransferModal = (transferId) => {
        if (!currentChatContactId) return;

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const msgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(transferId));

        if (msgIndex === -1 || messages[msgIndex].transferData.transferStatus !== 'pending') {
            showToast("该转账已被处理");
            return;
        }

        const msg = messages[msgIndex];
        const amount = parseFloat(msg.transferData.amount);
        const timestamp = msg.timestamp;

        currentReceivingTransferId = transferId;

        // 格式化时间
        const date = new Date(timestamp);
        const pad = n => String(n).padStart(2, '0');
        const formattedTime = `${date.getFullYear()}年${pad(date.getMonth() + 1)}月${pad(date.getDate())}日 ${pad(date.getHours())}:${pad(date.getMinutes())}`;

        // 填充弹窗内容
        document.getElementById('receive-transfer-amount').textContent = `¥${amount.toFixed(2)}`;
        document.getElementById('receive-transfer-time').textContent = formattedTime;

        // 显示弹窗
        const overlay = document.getElementById('receive-transfer-overlay');
        overlay.classList.add('active');
    };
    
    // 新增：关闭收款弹窗
    window.closeReceiveTransferModal = () => {
        const overlay = document.getElementById('receive-transfer-overlay');
        overlay.classList.remove('active');
        currentReceivingTransferId = null;
    };
    
    window.rejectReceiveTransfer = () => {
        if (!currentChatContactId || !currentReceivingTransferId) return;

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const msgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(currentReceivingTransferId));

        if (msgIndex === -1) return;

        const msg = messages[msgIndex];
        
        msg.transferData.transferStatus = 'rejected';
        localStorage.setItem(key, JSON.stringify(messages));
        
        showToast(`已退还转账`);
        closeReceiveTransferModal();
        renderConversationMessages();
    };

    window.confirmReceiveTransfer = () => {
        if (!currentChatContactId || !currentReceivingTransferId) return;

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const msgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(currentReceivingTransferId));

        if (msgIndex === -1) return;

        const msg = messages[msgIndex];
        const amount = parseFloat(msg.transferData.amount);

        // 更新消息状态为“已收款”
        msg.transferData.transferStatus = 'accepted';
        localStorage.setItem(key, JSON.stringify(messages));
        
        // 将钱款添加到用户钱包
        let walletData = getWalletData();
        walletData.balance += amount;
        walletData.transactions.push({
            id: Date.now(),
            type: 'transfer_received',
            amount: amount,
            desc: `收到来自 ${msg.transferData.senderName} 的转账`,
            timestamp: Date.now()
        });
        saveWalletData(walletData);

        showToast(`已收款 ¥${amount.toFixed(2)}`);
        closeReceiveTransferModal(); // 关闭弹窗
        renderConversationMessages(); // 重新渲染聊天记录以更新气泡状态
    };
    
    // This function is for AI to process a user's transfer.
    function handleTransferResponse(transferId, isAccepted) {
        if (!currentChatContactId) return;
        
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        
        const sentMsgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(transferId) && m.type === 'sent');

        if (sentMsgIndex === -1) return;

        const sentMsg = messages[sentMsgIndex];
        const amount = parseFloat(sentMsg.transferData.amount);
        const receiverName = sentMsg.transferData.receiverName;
        
        if (isAccepted) {
            sentMsg.transferData.transferStatus = 'accepted';

        } else { // Rejected
            sentMsg.transferData.transferStatus = 'rejected';
            
            // Refund to user's wallet
            let walletData = getWalletData();
            walletData.balance += amount;
            walletData.transactions.push({
                id: Date.now(),
                type: 'transfer_refund',
                amount: amount,
                desc: `来自 ${receiverName} 的转账退款`,
                timestamp: Date.now()
            });
            saveWalletData(walletData);
            showToast(`¥${amount.toFixed(2)} 已退回至零钱`);
        }
        
        // We only update the sender's original message status
        localStorage.setItem(key, JSON.stringify(messages));
        renderConversationMessages();
    }
    
    window.showBubbleMenu = (event, msgId, text, type, isTransfer) => {
        event.preventDefault();
        event.stopPropagation();
        closeBubbleMenu(); // Close any existing menu
        
        activeMsgIdForMenu = msgId;
        
        const menu = document.createElement('div');
        menu.className = 'bubble-context-menu';
        
        const recallOption = (type === 'sent') ? `<div class="bubble-menu-item" onclick="event.stopPropagation(); handleRecallMsg('${msgId}')">撤回</div>` : '';
        const editOption = isTransfer 
            ? `<div class="bubble-menu-item" style="color:#ccc; cursor:not-allowed;">编辑</div>`
            : `<div class="bubble-menu-item" onclick="event.stopPropagation(); handleEditMsg('${msgId}', '${escapeHtml(text)}')">编辑</div>`;

        menu.innerHTML = `
            ${editOption}
            <div class="bubble-menu-item" onclick="event.stopPropagation(); handleDeleteMsg('${msgId}')">删除</div>
            ${recallOption}
            <div class="bubble-menu-item" onclick="event.stopPropagation(); handleMultiSelectMode()">多选</div>
        `;
        
        // Find the specific message row by its unique ID
        const row = document.getElementById(`msg-${msgId}`);
        if (!row) return;

        // Find the bubble content within that row
        const bubbleContent = row.querySelector('.msg-bubble-content, .transfer-message-card');
        if (!bubbleContent) return;
        const rect = bubbleContent.getBoundingClientRect();
        
        document.body.appendChild(menu);
        
        menu.style.top = `${rect.top + window.scrollY}px`;
        menu.style.left = `${rect.left + rect.width / 2}px`;
        menu.classList.add('active'); // Add active class to show it
    };

    window.handleEditMsg = (msgId, oldText) => {
        const newText = prompt("修改消息:", oldText);
        if (newText !== null && newText.trim() !== "") {
            updateMessageInStorage(msgId, (msg) => { 
                if (msg.isTransfer) {
                    showToast("转账消息不支持编辑内容");
                } else {
                    msg.text = newText.trim(); 
                }
            });
            renderConversationMessages();
        }
        closeBubbleMenu();
    };

    window.handleDeleteMsg = (msgId) => {
        deleteMessageFromStorage(msgId);
        renderConversationMessages();
        closeBubbleMenu();
    };

    window.handleRecallMsg = (msgId) => {
        updateMessageInStorage(msgId, (msg) => { 
            msg.type = 'recalled'; 
            msg.text = '你撤回了一条消息'; // Set text for recall tip
            delete msg.isTransfer; // Remove transfer flag if it exists
            delete msg.transferData;
        });
        renderConversationMessages();
        closeBubbleMenu();
    };

    window.closeBubbleMenu = () => {
        const menu = document.querySelector('.bubble-context-menu');
        if (menu) menu.remove();
        activeMsgIdForMenu = null;
    };
    
    function updateMessageInStorage(msgId, updateFn) {
        if (!currentChatContactId) return;
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const idx = messages.findIndex(m => String(m.id) === String(msgId));
        if (idx !== -1) {
            updateFn(messages[idx]);
            localStorage.setItem(key, JSON.stringify(messages));
        }
    }

    function deleteMessageFromStorage(msgId) {
        if (!currentChatContactId) return;
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        messages = messages.filter(m => String(m.id) !== String(msgId));
        localStorage.setItem(key, JSON.stringify(messages));
    }

    window.handleMultiSelectMode = () => {
        isMultiSelectMode = true;
        selectedMsgIds.clear();
        document.getElementById('chat-multiselect-footer').classList.add('active');
        closeBubbleMenu();
        renderConversationMessages();
    };
    
    window.toggleMsgSelection = (msgId) => {
        if (!isMultiSelectMode) return;
        if (selectedMsgIds.has(msgId)) selectedMsgIds.delete(msgId);
        else selectedMsgIds.add(msgId);
        renderConversationMessages();
    };
    
    window.executeBatchDelete = () => {
        if (selectedMsgIds.size === 0) {
            isMultiSelectMode = false;
            document.getElementById('chat-multiselect-footer').classList.remove('active');
            renderConversationMessages();
            return;
        }
        
        if (!confirm(`确定删除选中的 ${selectedMsgIds.size} 条消息吗？`)) return;
        
        if (!currentChatContactId) return;
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        messages = messages.filter(m => !selectedMsgIds.has(m.id));
        localStorage.setItem(key, JSON.stringify(messages));
        
        isMultiSelectMode = false;
        selectedMsgIds.clear();
        document.getElementById('chat-multiselect-footer').classList.remove('active');
        renderConversationMessages();
        showToast("已批量删除");
    };

    window.handleChatInputKey = (event) => {
        if (event.key === 'Enter') {
            sendConversationMessage();
        }
    };

    function addMessageToChat(contactId, text, type, isTransfer = false, transferData = null) {
        if (!contactId) return;
        const key = getMessagesKey(contactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        
        const newMsg = { 
            id: Date.now() + Math.random(), // Add random to prevent ID collision
            text: text, 
            type: type, // 'sent' or 'received'
            timestamp: Date.now(), 
            isTransfer: isTransfer,
            transferData: transferData
        };
        messages.push(newMsg);
        localStorage.setItem(key, JSON.stringify(messages));

        let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contactIndex = contacts.findIndex(c => c.id === contactId); 
        if (contactIndex !== -1) { 
            contacts[contactIndex].lastMsg = isTransfer ? `[转账]` : text; 
            contacts[contactIndex].timestamp = Date.now(); 
            localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); 
        } 
        
        // If this is the current chat, re-render
        if (contactId === currentChatContactId) {
            renderConversationMessages();
        }
        renderChatList();
    }
    
    window.sendConversationMessage = (textOverride = null) => { 
        if (!currentChatContactId) return; 
        const input = document.getElementById('chat-conv-input'); 
        const text = textOverride !== null ? textOverride : input.value.trim(); 
        if (!text) return; 
        
        addMessageToChat(currentChatContactId, text, 'sent');
        
        if(textOverride === null) input.value = ''; 
    };

    window.toggleChatExtraMenu = () => {
        const menu = document.getElementById('chat-extra-menu');
        menu.classList.toggle('active');
    };
    
    // --- [REFACTORED] Transfer Functions ---
    window.openTransferPage = () => {
        if (!currentChatContactId) return;
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contact = contacts.find(c => c.id === currentChatContactId); 
        if (!contact) return;

        currentPasswordInput = '';
        
        const nameContainer = document.getElementById('transfer-target-name-container');
        const realNameLastChar = contact.name ? `(**${contact.name.slice(-1)})` : '';
        nameContainer.innerHTML = `转账给 ${escapeHtml(contact.alias || contact.name)} <span style="opacity:0.6; font-size: 14px;">${realNameLastChar}</span>`;
        
        document.getElementById('transfer-target-avatar').src = contact.avatar;
        document.getElementById('transfer-amount-input').value = '';
        
        document.getElementById('transfer-page').classList.add('active');
        toggleChatExtraMenu();
    };

    window.closeTransferPage = () => {
        document.getElementById('transfer-page').classList.remove('active');
    };
    
    window.checkTransferAmount = (input) => {
        // This function is now just for potential future validation
    };

    window.handleTransferInputKey = (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            showTransferConfirmPopup();
        }
    };
    
    window.showTransferConfirmPopup = () => {
        const amountStr = document.getElementById('transfer-amount-input').value;
        const amount = parseFloat(amountStr);

        if (isNaN(amount) || amount <= 0) {
            showToast("请输入有效的转账金额");
            return;
        }

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contact = contacts.find(c => c.id === currentChatContactId); 
        
        const targetEl = document.getElementById('confirm-transfer-target');
        const realNameLastChar = contact.name ? `(**${contact.name.slice(-1)})` : '';
        targetEl.textContent = `向 ${escapeHtml(contact.alias || contact.name)} ${realNameLastChar} 转账`;
        
        document.getElementById('confirm-transfer-amount').textContent = `¥${amount.toFixed(2)}`;
        
        resetPasswordUI();
        document.getElementById('transfer-confirm-overlay').classList.add('active');
    };

    window.closeTransferConfirmPopup = () => {
        document.getElementById('transfer-confirm-overlay').classList.remove('active');
    };
    
    function resetPasswordUI() {
        currentPasswordInput = '';
        document.querySelectorAll('.password-box').forEach(box => {
            box.classList.remove('filled');
        });
        const errorTip = document.getElementById('password-error-tip');
        errorTip.textContent = '';
        errorTip.parentElement.style.animation = '';
    }

    function generateKeypad() {
        const keypadContainer = document.getElementById('numeric-keypad');
        const keys = ['1','2','3','4','5','6','7','8','9','','0','delete'];
        keypadContainer.innerHTML = '';

        keys.forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'keypad-btn';
            
            if (key === 'delete') {
                btn.classList.add('delete');
                btn.innerHTML = `<img src="https://img.heliar.top/file/1770766708535_删除_delete-two_2.png" alt="del">`;
                btn.onclick = () => handlePasswordInput('delete');
            } else if (key === '') {
                btn.classList.add('blank');
            } else {
                btn.textContent = key;
                btn.onclick = () => handlePasswordInput(key);
            }
            keypadContainer.appendChild(btn);
        });
    }

    function handlePasswordInput(key) {
        const boxes = document.querySelectorAll('#password-boxes .password-box');
        const errorTip = document.getElementById('password-error-tip');
        errorTip.textContent = '';
        errorTip.parentElement.style.animation = '';
        
        if (key === 'delete') {
            if (currentPasswordInput.length > 0) {
                currentPasswordInput = currentPasswordInput.slice(0, -1);
            }
        } else {
            if (currentPasswordInput.length < 6) {
                currentPasswordInput += key;
            }
        }
        
        boxes.forEach((box, index) => {
            box.classList.toggle('filled', index < currentPasswordInput.length);
        });

        if (currentPasswordInput.length === 6) {
            verifyPassword();
        }
    }
    
        function verifyPassword() {
        // 👇👇👇 这是修改和新增的行 👇👇👇
        const userProfile = getUserProfile();
        const correctPassword = userProfile.paymentPassword || '000000'; // 读取自定义密码，如果没设置就用默认的
        // 👆👆👆 修改结束 👆👆👆

        const amount = parseFloat(document.getElementById('transfer-amount-input').value);
    
        if (currentPasswordInput === correctPassword) {
            // Check balance
            const walletData = getWalletData();
            if (walletData.balance < amount) {
                showToast('余额不足，转账失败');
                const errorTip = document.getElementById('password-error-tip');
                errorTip.textContent = '余额不足';
                setTimeout(() => {
                    resetPasswordUI();
                }, 1000);
                return;
            }
            
            // Deduct balance and add transaction record
            walletData.balance -= amount;
            
            const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
            const contact = contacts.find(c => c.id === currentChatContactId);
            const userProfile = getUserProfile();

            walletData.transactions.push({
                id: Date.now(),
                type: 'transfer_sent',
                amount: amount,
                desc: `转账给 ${contact.alias || contact.name}`,
                timestamp: Date.now()
            });
            
            saveWalletData(walletData);
            
            showToast('转账成功');
            
            const transferId = Date.now();
            const senderName = contact.userName || userProfile.nickname;
            const receiverName = contact.alias || contact.name;
            const transferMessageText = `[转账] ¥${amount.toFixed(2)}`;

            const sentTransferData = { id: transferId, amount: amount, transferStatus: 'pending', senderName, receiverName };
            addMessageToChat(currentChatContactId, transferMessageText, 'sent', true, sentTransferData);

            closeTransferConfirmPopup();
            closeTransferPage();
    
        } else {
            const errorTip = document.getElementById('password-error-tip');
            errorTip.textContent = '密码错误，请重新输入';
            const passwordSection = document.getElementById('password-input-section');
            passwordSection.style.animation = 'shake 0.5s';
            
            if(navigator.vibrate) {
                navigator.vibrate(200);
            }
    
            setTimeout(() => {
                resetPasswordUI();
            }, 1000);
        }
    }
    // --- AI Logic for Role-Initiated Transfer & Moment Post ---
    window.triggerAIAutoReply = async () => {
        if (!currentChatContactId) return;
        
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings?.api?.url || !settings?.api?.key) {
            showToast('请先在设置中配置 API');
            return;
        }

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        if (!contact) return;

        const titleEl = document.getElementById('chat-conv-title');
        const originalTitle = titleEl.innerText;
        titleEl.innerText = "正在输入中...";
        titleEl.classList.add('typing-anim');

        let timeContext = "";
        if (contact.timePerceptionEnabled) {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 9) timeContext = "现在是早上";
            else if (hour >= 9 && hour < 12) timeContext = "现在是上午";
            else if (hour >= 12 && hour < 14) timeContext = "现在是中午";
            else if (hour >= 14 && hour < 18) timeContext = "现在是下午";
            else if (hour >= 18 && hour < 23) timeContext = "现在是晚上";
            else timeContext = "现在是深夜";
        }

        const rolePersona = contact.persona || "你是一个友好的人";
        const userPersona = contact.userPersona || "一个普通用户"; 
        
        let worldBookContext = "无特殊设定";
        if (contact.worldbookIds && contact.worldbookIds.length > 0) {
            const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const wbContents = contact.worldbookIds.map(id => {
                 const wb = worldbooks.find(b => b.id === id);
                 if (wb) return `【世界书设定集：${wb.title}】\n` + wb.entries.map(e => `[${e.key || '设定'}]: ${e.content}`).join('\n');
                 return '';
            }).filter(Boolean).join('\n\n');
            if (wbContents) worldBookContext = wbContents;
        }

        const msgKey = getMessagesKey(currentChatContactId);
        let history = JSON.parse(localStorage.getItem(msgKey) || '[]');
        
        const memoryLimit = contact.memoryDepth || 15;
        const validHistory = history.filter(m => m.type !== 'recalled');
        
        let pendingTransfer = null;
        const recentHistory = validHistory.slice(-memoryLimit).map(m => {
            if (m.isTransfer && m.transferData) {
                const { amount, transferStatus, id } = m.transferData;
                if (m.type === 'sent' && transferStatus === 'pending') {
                    pendingTransfer = { id, amount }; 
                    return `[系统提示: 你收到一笔来自 User 的转账，金额为 ¥${amount}，正在等待你处理。]`;
                }
                if (m.type === 'sent') return `[系统提示: User 曾向你发起一笔 ¥${amount} 的转账，状态为: ${transferStatus}]`;
                if (m.type === 'received') return `[系统提示: 你处理了一笔来自 User 的转账，金额为 ¥${amount}，你的处理结果是: ${transferStatus}]`;
            }
            return `${m.type === 'sent' ? 'User' : 'Role'}: ${m.text}`;
        }).join('\n');

        const systemPrompt = `你现在必须完全沉浸地扮演角色“${contact.alias || contact.name}”。
### 角色核心设定 (必须严格遵守)
${rolePersona}
### 世界观与事实 (World Book - 最高优先级)
${worldBookContext}
### 对话对象设定
${userPersona}
### 当前环境
${timeContext ? `${timeContext}。` : ''}
### 【绝对指令】
1. **情绪先行**: 先捕捉User话语中的情绪点，做出最直观的反应（惊讶、开心、无语等），再处理逻辑。
2. **极度口语化**: 禁止书面语。使用短句、断句。
3. **决策转账**:
   - **处理用户转账**: 如果历史记录中出现 "[系统提示: 你收到一笔...转账...]"，必须对此做出反应，自主决定接受或拒绝。
     - 接受: 回复开头写 \`[ACTION:ACCEPT_TRANSFER,ID=${pendingTransfer ? pendingTransfer.id : 'null'}]\`
     - 拒绝: 回复开头写 \`[ACTION:REJECT_TRANSFER,ID=${pendingTransfer ? pendingTransfer.id : 'null'}]\`
   - **主动发起转账**: 你也可以根据上下文主动给用户转账。指令: \`[ACTION:INITIATE_TRANSFER,AMOUNT=金额]\` (例: \`[ACTION:INITIATE_TRANSFER,AMOUNT=5.20]\`)
   - 指令后必须换行，然后像真人一样对这笔钱做出反应。
---
以下是最近的聊天记录：
${recentHistory}
(请接上文，以角色的语气回复，直接输出内容)`;
        
        try {
            const url = settings.api.url;
            const key = settings.api.key;
            const model = settings.api.model;

            const res = await fetch(`${url.endsWith('/v1') ? url : url + '/v1'}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: model || 'gpt-3.5-turbo',
                    messages: [ { role: 'user', content: systemPrompt } ],
                    temperature: parseFloat(settings.api.temp || 0.85),
                })
            });

            if (!res.ok) {
                 const errorData = await res.json();
                 throw new Error(`API 请求失败: ${res.statusText} - ${errorData.error.message}`);
            }
            
            const data = await res.json();
            let aiText = data.choices[0].message.content.trim();

            const actionRegex = /\[ACTION:(\w+),(.+?)\]/;
            const match = aiText.match(actionRegex);

            if (match) {
                const action = match[1];
                const paramsStr = match[2];
                aiText = aiText.replace(actionRegex, '').trim();

                const params = paramsStr.split(',').reduce((acc, param) => {
                    const [key, value] = param.split('=');
                    acc[key.trim()] = value.trim();
                    return acc;
                }, {});

                if (action === 'ACCEPT_TRANSFER' && params.ID) {
                    handleTransferResponse(params.ID, true);
                } else if (action === 'REJECT_TRANSFER' && params.ID) {
                    handleTransferResponse(params.ID, false);
                } else if (action === 'INITIATE_TRANSFER' && params.AMOUNT) {
                    const amount = parseFloat(params.AMOUNT);
                    if (!isNaN(amount) && amount > 0) {
                        const transferId = Date.now();
                        const userProfile = getUserProfile();
                        
                        const transferData = {
                            id: transferId,
                            amount: amount,
                            transferStatus: 'pending',
                            senderName: contact.alias || contact.name,
                            receiverName: contact.userName || userProfile.nickname,
                        };
                        
                        addMessageToChat(currentChatContactId, `[转账] ¥${amount.toFixed(2)}`, 'received', true, transferData);
                    }
                }
            }

            const replies = aiText.split('\n').filter(line => line.trim() !== '');

            if (replies.length === 0 && aiText) {
                replies.push(aiText);
            }
            
            let lastMsg = "";
            for (const replyText of replies) {
                const trimmedReply = replyText.trim();
                if (trimmedReply) {
                    addMessageToChat(currentChatContactId, trimmedReply, 'received');
                    lastMsg = trimmedReply;
                }
            }

            let contactsList = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
            const contactIdx = contactsList.findIndex(c => c.id === currentChatContactId); 
            if (contactIdx !== -1 && lastMsg) { 
                contactsList[contactIdx].lastMsg = lastMsg; 
                contactsList[contactIdx].timestamp = Date.now(); 
                localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contactsList));
                renderChatList();
            } 
            
        } catch (error) {
            console.error(error);
            showToast('AI 回复失败: ' + error.message, 4000);
        } finally {
            titleEl.innerText = originalTitle;
            titleEl.classList.remove('typing-anim');
        }
    };

    window.openRoleSettings = () => { if (!currentChatContactId) return; const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const contact = contacts.find(c => c.id === currentChatContactId); if (!contact) return; tempSelectedWorldBookIds = contact.worldbookIds || []; document.getElementById('role-setting-avatar').src = contact.avatar || ''; document.getElementById('role-setting-alias').value = contact.alias || contact.name; document.getElementById('role-setting-signature').value = contact.signature || ''; document.getElementById('role-setting-persona').value = contact.persona || ''; document.getElementById('role-time-perception-switch').checked = contact.timePerceptionEnabled || false; document.getElementById('role-memory-depth').value = contact.memoryDepth === 0 ? 0 : (contact.memoryDepth || 15); document.getElementById('role-auto-post-switch').checked = contact.autoPostEnabled || false; document.getElementById('role-auto-post-interval').value = contact.autoPostInterval === 0 ? 0 : (contact.autoPostInterval || 60); document.getElementById('role-setting-css').value = contact.customCss || `/* Example */\n.msg-bubble-row.them .msg-bubble-content {\n  border-radius: 20px 20px 20px 0;\n  background: #fff;\n}`; tempRoleBgUrl = contact.backgroundImage || ''; document.getElementById('role-bg-preview').style.backgroundImage = tempRoleBgUrl ? `url(${tempRoleBgUrl})` : ''; document.getElementById('role-bg-url-input').value = ''; const globalProfile = getUserProfile(); document.getElementById('role-user-avatar').src = contact.userAvatar || globalProfile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; document.getElementById('role-user-name').value = contact.userName || globalProfile.nickname || ''; document.getElementById('role-user-persona').value = contact.userPersona || ''; updateRoleWbDisplay(contact.worldbookIds); renderCssPresets(); document.getElementById('css-preset-actions').style.display = 'none'; document.getElementById('role-settings-page').classList.add('active'); };
    window.closeRoleSettings = () => { document.getElementById('role-settings-page').classList.remove('active'); };
    window.triggerRoleAvatarEdit = () => { const currentUrl = document.getElementById('role-setting-avatar').src; const newUrl = prompt("输入新头像的图片链接:", currentUrl); if (newUrl && newUrl.trim()) { document.getElementById('role-setting-avatar').src = newUrl.trim(); } };
    window.triggerRoleBgUpload = () => { document.getElementById('input-role-chat-bg').click(); };
    window.handleRoleChatBgUpload = (event) => { const file = event.target.files[0]; if (!file) return; compressImage(file, 600, (base64) => { tempRoleBgUrl = base64; document.getElementById('role-bg-preview').style.backgroundImage = `url(${base64})`; document.getElementById('role-bg-url-input').value = ''; }); };
    window.setRoleBgByUrl = () => { const urlInput = document.getElementById('role-bg-url-input'); const bgUrl = urlInput.value.trim(); if (!bgUrl) { showToast("请输入有效的图片URL"); return; } document.getElementById('role-bg-preview').style.backgroundImage = `url(${bgUrl})`; tempRoleBgUrl = bgUrl; showToast("背景URL已预览"); };
    window.triggerRoleUserAvatarEdit = () => { document.getElementById('input-role-user-avatar').click(); };
    window.handleRoleUserAvatarUpload = (event) => { const file = event.target.files[0]; if (!file) return; compressImage(file, 200, (base64) => { document.getElementById('role-user-avatar').src = base64; }); };
    window.saveRoleSettings = () => { if (!currentChatContactId) return; const newAlias = document.getElementById('role-setting-alias').value.trim(); if (!newAlias) { showToast("备注名不能为空"); return; } let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const idx = contacts.findIndex(c => c.id === currentChatContactId); if (idx !== -1) { contacts[idx].alias = newAlias; contacts[idx].signature = document.getElementById('role-setting-signature').value.trim(); contacts[idx].avatar = document.getElementById('role-setting-avatar').src; contacts[idx].persona = document.getElementById('role-setting-persona').value.trim(); contacts[idx].timePerceptionEnabled = document.getElementById('role-time-perception-switch').checked; contacts[idx].memoryDepth = parseInt(document.getElementById('role-memory-depth').value); if (isNaN(contacts[idx].memoryDepth)) contacts[idx].memoryDepth = 15; contacts[idx].autoPostEnabled = document.getElementById('role-auto-post-switch').checked; contacts[idx].autoPostInterval = parseInt(document.getElementById('role-auto-post-interval').value); if (isNaN(contacts[idx].autoPostInterval)) contacts[idx].autoPostInterval = 60; contacts[idx].backgroundImage = tempRoleBgUrl || contacts[idx].backgroundImage; contacts[idx].userAvatar = document.getElementById('role-user-avatar').src; contacts[idx].userName = document.getElementById('role-user-name').value.trim(); contacts[idx].userPersona = document.getElementById('role-user-persona').value.trim(); contacts[idx].customCss = document.getElementById('role-setting-css').value; contacts[idx].worldbookIds = tempSelectedWorldBookIds; localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); if (contacts[idx].autoPostEnabled) { scheduleAutoPost(contacts[idx].id, contacts[idx].autoPostInterval); } else { stopAutoPost(contacts[idx].id); } document.getElementById('chat-conv-title').innerText = newAlias; document.getElementById('chat-conv-signature').innerText = contacts[idx].signature; document.getElementById('chat-conversation-view').style.backgroundImage = tempRoleBgUrl ? `url(${tempRoleBgUrl})` : 'none'; const styleTag = document.getElementById('custom-chat-style'); if(styleTag) styleTag.innerHTML = contacts[idx].customCss; renderChatList(); renderContactList(); renderConversationMessages(); showToast("设置已保存"); closeRoleSettings(); } };

    // --- MODIFIED: CSS Preset Functions ---
    window.openSaveCssPresetModal = () => {
        const cssContent = document.getElementById('role-setting-css').value;
        if (!cssContent.trim()) {
            showToast('CSS内容为空，无法保存');
            return;
        }
        document.getElementById('preset-name-input').value = '';
        document.getElementById('save-preset-modal').style.display = 'flex';
        setTimeout(() => document.getElementById('save-preset-modal').classList.add('active'), 10);
    };

    window.closeSaveCssPresetModal = () => {
        const modal = document.getElementById('save-preset-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 300);
    };
    
    window.saveCurrentCssPreset = () => {
        const presetName = document.getElementById('preset-name-input').value.trim();
        const cssContent = document.getElementById('role-setting-css').value;

        if (!presetName) {
            showToast('预设名称不能为空');
            return;
        }

        let presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '[]');
        const newPreset = { id: Date.now(), name: presetName, css: cssContent };
        presets.push(newPreset);
        localStorage.setItem(CSS_PRESETS_KEY, JSON.stringify(presets));

        showToast('预设已保存');
        closeSaveCssPresetModal();
        renderCssPresets();
    };

    window.renderCssPresets = () => {
        const select = document.getElementById('css-preset-select');
        select.innerHTML = '<option value="">选择一个预设...</option>';
        const presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '[]');

        presets.forEach(preset => {
            const option = document.createElement('option');
            option.value = preset.id;
            option.textContent = preset.name;
            select.appendChild(option);
        });
    };

    window.handlePresetSelection = (selectElement) => {
        const actions = document.getElementById('css-preset-actions');
        actions.style.display = selectElement.value ? 'flex' : 'none';
    };

    window.applySelectedCssPreset = () => {
        const select = document.getElementById('css-preset-select');
        const presetId = parseInt(select.value);
        if (!presetId) return;

        const presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '[]');
        const preset = presets.find(p => p.id === presetId);
        if (preset) {
            document.getElementById('role-setting-css').value = preset.css;
            showToast(`已应用预设 "${preset.name}"`);
        }
    };

    window.deleteSelectedCssPreset = () => {
        const select = document.getElementById('css-preset-select');
        const presetId = parseInt(select.value);
        if (!presetId) return;

        if (!confirm('确定要删除这个预设吗？')) return;

        let presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '[]');
        presets = presets.filter(p => p.id !== presetId);
        localStorage.setItem(CSS_PRESETS_KEY, JSON.stringify(presets));

        showToast('预设已删除');
        renderCssPresets(); // Re-render the dropdown
        document.getElementById('css-preset-actions').style.display = 'none'; // Hide actions
    };
    // --- End CSS Preset Functions ---

    function updateRoleWbDisplay(bookIds) {
        const displayEl = document.getElementById('role-wb-display');
        const clearBtn = document.getElementById('role-wb-clear-btn');
        
        if (bookIds && bookIds.length > 0) {
            const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const names = bookIds.map(id => {
                const book = worldbooks.find(b => b.id === id);
                return book ? book.title : '未知';
            }).join(', ');
            displayEl.textContent = names;
            displayEl.classList.remove('unbound');
            clearBtn.style.display = 'inline-block';
        } else {
            displayEl.textContent = '未绑定';
            displayEl.classList.add('unbound');
            clearBtn.style.display = 'none';
        }
    }
    
    window.openRoleWorldBookBindModal = () => {
        wbBindMultiSelect = true;
        document.getElementById('wb-bind-modal-title').textContent = '选择绑定的世界书';
        wbBindCallback = (selectedIds) => {
            tempSelectedWorldBookIds = selectedIds;
            updateRoleWbDisplay(selectedIds);
        };
        openWorldBookBindModal('worldbook');
    };

    window.openWorldBookBindModal = (type = 'worldbook') => { 
        const modal = document.getElementById('worldbook-bind-modal');
        const listEl = document.getElementById('worldbook-bind-list');
        listEl.innerHTML = '';
        const card = modal.querySelector('.wb-bind-modal-card');
        card.classList.toggle('multi-select-mode', wbBindMultiSelect);
        
        let items = [];
        let tempSelectedIds = [];

        if (type === 'roles') {
            items = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
            tempSelectedIds = tempForumBoundRoleIds;
        } else { // worldbook
            items = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            let currentContactWB = tempSelectedWorldBookIds.length > 0 ? tempSelectedWorldBookIds : [];
            let newForumWB = tempForumWbIds.length > 0 ? tempForumWbIds : [];
            tempSelectedIds = [...new Set([...currentContactWB, ...newForumWB])];
        }

        if (items.length > 0) {
            items.forEach(itemData => {
                const item = document.createElement('div');
                const displayName = (type === 'roles') ? (itemData.alias || itemData.name) : itemData.title;
                const avatar = (type === 'roles') ? itemData.avatar : null;

                if (wbBindMultiSelect) {
                    const isChecked = tempSelectedIds.includes(itemData.id);
                    item.className = 'wb-bind-list-item multi';
                    item.dataset.itemId = itemData.id;
                    item.innerHTML = `<div class="wb-bind-checkbox ${isChecked ? 'checked' : ''}"></div>
                                    ${avatar ? `<img src="${avatar}" style="width:30px; height:30px; border-radius:6px; margin-right:8px; object-fit:cover;">` : ''}
                                    <span>${escapeHtml(displayName)}</span>`;
                    item.onclick = () => { item.querySelector('.wb-bind-checkbox').classList.toggle('checked'); };
                } else {
                    item.className = 'wb-bind-list-item';
                    item.innerHTML = `<span>${escapeHtml(displayName)}</span>`;
                    item.onclick = () => { if (wbBindCallback) wbBindCallback([itemData.id]); closeWorldBookBindModal(); };
                }
                listEl.appendChild(item);
            });
        } else {
            const emptyText = (type === 'roles') ? '还没有创建任何角色哦~' : '还没有创建任何世界书哦~';
            listEl.innerHTML = `<div class="wb-bind-list-empty">${emptyText}</div>`;
        }
        modal.classList.add('active');
    };

    window.closeWorldBookBindModal = () => { document.getElementById('worldbook-bind-modal').classList.remove('active'); };
    window.clearWorldBookBinding = () => { tempSelectedWorldBookIds = []; updateRoleWbDisplay([]); };
    
    window.confirmWbBinding = () => {
        if (!wbBindMultiSelect) return;
        const listEl = document.getElementById('worldbook-bind-list');
        const selectedItems = listEl.querySelectorAll('.wb-bind-checkbox.checked');
        const selectedIds = Array.from(selectedItems).map(item => parseInt(item.closest('.wb-bind-list-item').dataset.itemId));
        if (wbBindCallback) {
            wbBindCallback(selectedIds);
        }
        closeWorldBookBindModal();
    };

    // --- Delete Friend Logic ---
    window.confirmDeleteFriend = () => { document.getElementById('delete-friend-confirm-modal').classList.add('active'); };
    window.closeDeleteModal = (modalId) => { document.getElementById(modalId).classList.remove('active'); };
    window.executeDeleteFriend = () => { if (!currentChatContactId) return; let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const newContacts = contacts.filter(c => c.id !== currentChatContactId); localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(newContacts)); localStorage.removeItem(getMessagesKey(currentChatContactId)); stopAutoPost(currentChatContactId); showToast("好友已删除"); closeDeleteModal('delete-friend-confirm-modal'); closeRoleSettings(); closeChatConversation(); switchChatTab(0, 'Chat'); renderChatList(); renderContactList(); };

    // --- Core Functions ---
    const updateClock = () => { const clockTimeEl = document.getElementById('clock-time'); const clockDateEl = document.getElementById('clock-date'); const now = new Date(); clockTimeEl.innerText = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; if (!customDateText) { const days = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六']; clockDateEl.innerText = `${now.getFullYear()}年${String(now.getMonth() + 1).padStart(2, '0')}月${String(now.getDate()).padStart(2, '0')}日 ${days[now.getDay()]}`; } else { clockDateEl.innerText = customDateText; } };
    window.handleDateEdit = (event) => { event.stopPropagation(); const newText = prompt("请输入自定义日期文字（留空恢复实时日期）：", document.getElementById('clock-date').innerText); if (newText !== null) { customDateText = newText.trim(); updateClock(); saveAllSettings(); } };
    window.handleTimeBgClick = (event) => { document.getElementById('input-time-bg').click(); };
    window.handleTimeBgUpload = (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { document.getElementById('time-container').style.backgroundImage = `url(${e.target.result})`; saveAllSettings(); showToast('时间背景已更新 ^ω^'); }; reader.readAsDataURL(file); };
    
    window.showSettingsPage = () => { populateSettingsList(); body.classList.add('settings-active'); };
    
    // --- 核心修复：退出设置页时重新应用手机框逻辑 ---
    window.hideSettingsPage = () => {
        body.classList.remove('settings-active');
        // 当从设置页退出时，重新读取并应用设置
        const phoneFrameEnabled = localStorage.getItem(PHONE_FRAME_KEY) === 'true';
        applyPhoneFrame(phoneFrameEnabled);
    };

    
    function handleUrlInput(inputEl, previewEl, callback) { const url = inputEl.value.trim(); if (url) { const img = new Image(); img.onload = () => { previewEl.style.backgroundImage = `url(${url})`; if (callback) callback(url); }; img.onerror = () => { previewEl.style.backgroundImage = ''; }; img.src = url; } else { previewEl.style.backgroundImage = ''; } }
    function handleImgSrcInput(inputEl, imgEl) { const url = inputEl.value.trim(); if (url) { imgEl.src = url; imgEl.onerror = () => {imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; }; } else { imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; } }
    const applyIconToUI = (appId, url) => { const el = document.getElementById(appId); if (!el) return; if (url && (url.startsWith('http') || url.startsWith('data:'))) { el.innerHTML = ''; el.style.backgroundImage = `url(${url})`; } else { el.style.backgroundImage = ''; const defaults = { 'icon-app1': '☁️', 'icon-app2': '🎵', 'icon-app3': '💬', 'icon-app4': '📸', 'icon-app5': '🧭', 'icon-app6': '🎮', 'icon-app7': '📅', 'icon-app8': '💰', 'icon-dock-settings': '⚙️', 'icon-dock-ai': '🤖', 'icon-dock-safari': '🧭', 'icon-dock-messages': '✉️' }; if (defaults[appId]) el.innerHTML = defaults[appId]; } };
    const populateSettingsList = () => { const container = document.getElementById('settings-app-list-container'); container.innerHTML = ''; const appIcons = [ { id: 'icon-app1', name: 'Chat', default: '☁️' }, { id: 'icon-app2', name: '世界书', default: '🎵' }, { id: 'icon-app3', name: '论坛', default: '💬' }, { id: 'icon-app4', name: '相册', default: '📸' }, { id: 'icon-app5', name: 'HUshhh', default: '🧭' }, { id: 'icon-app6', name: '商城', default: '🎮' }, { id: 'icon-app7', name: '日历', default: '📅' }, { id: 'icon-app8', name: 'Wallet', default: '💰' }, { id: 'icon-dock-settings', name: 'Dock-设置', default: '⚙️' }, { id: 'icon-dock-ai', name: 'Dock-AI', default: '🤖' }, { id: 'icon-dock-safari', name: 'Dock-指南针', default: '🧭' }, { id: 'icon-dock-messages', name: 'Dock-信息', default: '✉️' } ]; appIcons.forEach(app => { const item = document.createElement('div'); item.className = 'app-icon-item'; const cur = document.getElementById(app.id); const bg = cur.style.backgroundImage; item.innerHTML = `<div class="app-icon-preview" id="preview-${app.id}" style="${bg ? `background-image:${bg}` : ''}">${!bg ? app.default : ''}</div><div class="app-icon-info"><div class="app-icon-name">${app.name}</div><div class="app-icon-input"><input type="text" id="url-${app.id}" placeholder="图片 URL" value="${bg ? bg.slice(5, -2).replace(/['"]/g, '') : ''}"><button onclick="triggerIconUpload('${app.id}')">上传</button></div></div>`; container.appendChild(item); const inp = document.getElementById(`url-${app.id}`); inp.addEventListener('input', () => { if (inp.value.trim()) handleUrlInput(inp, document.getElementById(`preview-${app.id}`), (u) => applyIconToUI(app.id, u)); else { applyIconToUI(app.id, ''); document.getElementById(`preview-${app.id}`).style.backgroundImage = ''; document.getElementById(`preview-${app.id}`).innerHTML = app.default; } }); }); };
    window.triggerIconUpload = (id) => { const i = document.getElementById('input-app-icon'); i.dataset.target = id; i.click(); };
    window.handleIconUpload = (e) => { const f = e.target.files[0]; const id = e.target.dataset.target; if (!f || !id) return; const r = new FileReader(); r.onload = (ev) => { const d = ev.target.result; applyIconToUI(id, d); document.getElementById(`preview-${id}`).style.backgroundImage = `url(${d})`; document.getElementById(`preview-${id}`).innerHTML = ''; document.getElementById(`url-${id}`).value = d; }; r.readAsDataURL(f); };
    window.handleWallpaperUpload = (e) => { 
        const f = e.target.files[0]; 
        if (!f) return; 
        const r = new FileReader(); 
        r.onload = (ev) => { 
            const d = ev.target.result; 
            document.getElementById('wallpaper-url').value = d; 
            document.getElementById('wallpaper-preview').style.backgroundImage = `url(${d})`; 
            // 应用壁纸时，根据手机框状态决定应用到哪里
            const isPhoneFrameActive = document.body.classList.contains('phone-frame-active');
            if (isPhoneFrameActive) {
                document.getElementById('phone-screen-content').style.backgroundImage = `url(${d})`;
            } else {
                body.style.backgroundImage = `url(${d})`;
            }
        }; 
        r.readAsDataURL(f); 
    };
    window.editChatAvatarUrl = (id) => { const currentUrl = document.getElementById(id).style.backgroundImage.slice(5, -2).replace(/['"]/g, ''); const newUrl = prompt("请输入图片链接 (URL):", currentUrl); if(newUrl !== null && newUrl.trim() !== '') { document.getElementById(id).style.backgroundImage = `url('${newUrl.trim()}')`; saveAllSettings(); showToast("头像已更新!"); } };
    window.adjustInputWidth = (el) => { const len = el.value.length; const newWidth = Math.min(150, Math.max(60, (len * 10) + 30)); el.style.width = newWidth + 'px'; };
    window.triggerPhotoWidgetUpload = () => { document.getElementById('input-photo-widget').click(); };
    window.handlePhotoWidgetUpload = (e) => { const file = e.target.files[0]; if(!file) return; const r = new FileReader(); r.onload = (ev) => { const d = ev.target.result; const img = document.getElementById('photo-widget-img'); const ph = document.getElementById('photo-widget-placeholder'); img.src = d; img.style.display = 'block'; ph.style.display = 'none'; saveAllSettings(); showToast("小组件图片已更新!"); }; r.readAsDataURL(file); };

    // --- Profile (Me) Page Functions ---
        function getUserProfile() {
        try {
            const p = localStorage.getItem(USER_PROFILE_KEY);
            const profile = p ? JSON.parse(p) : {};
            // 定义一个默认的配置对象
            const defaults = {
                cover: '',
                avatar: '',
                nickname: 'Antigravity',
                qqId: Date.now(),
                likes: 8888,
                signature: '这个人很懒，什么都没留下~',
                memberIconUrl: 'https://img.heliar.top/file/1770081928967_vip_vip-one.png',
                memberUrls: new Array(8).fill(''),
                paymentPassword: '000000' // 👇👇👇 把支付密码也加入到默认配置中
            };
            // 使用展开运算符(...)，用缓存中的数据覆盖默认数据，这样就不会漏掉任何字段了
            return { ...defaults, ...profile };
        } catch (e) {
            // 如果出错，返回完整的默认对象
            return {
                cover: '',
                avatar: '',
                nickname: 'Antigravity',
                qqId: Date.now(),
                likes: 8888,
                signature: '这个人很懒，什么都没留下~',
                memberIconUrl: 'https://img.heliar.top/file/1770081928967_vip_vip-one.png',
                memberUrls: new Array(8).fill(''),
                paymentPassword: '000000'
            };
        }
    }
    function saveUserProfile(profileData) { try { localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profileData)); if (document.body.classList.contains('wallet-active')) { loadWalletUI(); } } catch (e) { showToast("保存失败 (LocalStorage满)"); } }
    function loadUserProfile() { const p = getUserProfile(); document.getElementById('profile-cover').style.backgroundImage = p.cover ? `url(${p.cover})` : 'linear-gradient(to bottom, #7A88FF, #7AFFAF)'; document.getElementById('profile-avatar').src = p.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; document.getElementById('profile-nickname').innerText = p.nickname; document.getElementById('profile-qq-id').innerText = `QQ: ${p.qqId}`; document.getElementById('profile-like-count').innerText = p.likes; document.getElementById('profile-signature-text').innerText = p.signature || '这个人很懒，什么都没留下~'; document.getElementById('me-member-icon-main').src = p.memberIconUrl || 'https://img.heliar.top/file/1770081928967_vip_vip-one.png'; const memberIconContainer = document.getElementById('me-member-icon-container'); memberIconContainer.innerHTML = ''; p.memberUrls.forEach((url) => { if(url && url.trim() !== '') { const img = document.createElement('img'); img.className = 'me-member-icon-slot'; img.src = url; memberIconContainer.appendChild(img); } }); }
    window.editSignature = () => { const p = getUserProfile(); const newSignature = prompt("请输入你的个性签名：", p.signature); if (newSignature !== null) { p.signature = newSignature.trim() || '这个人很懒，什么都没留下~'; saveUserProfile(p); loadUserProfile(); } };
    window.triggerProfileAvatarUpload = (e) => { if(e) e.stopPropagation(); document.getElementById('input-profile-avatar').click(); };
    window.handleProfileAvatarUpload = (event) => { const file = event.target.files[0]; if (!file) return; compressImage(file, 200, (base64) => { const p = getUserProfile(); p.avatar = base64; saveUserProfile(p); loadUserProfile(); showToast("头像已更新"); if (document.getElementById('me-settings-modal').classList.contains('active')) { document.getElementById('me-settings-avatar-preview').src = base64; document.getElementById('me-settings-avatar-url').value = '(已上传本地图片)'; } }); };
    window.editNickname = (e) => { if(e) e.stopPropagation(); const p = getUserProfile(); const newName = prompt("请输入新昵称:", p.nickname); if (newName && newName.trim()) { p.nickname = newName.trim(); saveUserProfile(p); loadUserProfile(); } };
    window.editQQID = (e) => { if(e) e.stopPropagation(); const p = getUserProfile(); const newID = prompt("请输入QQ号:", p.qqId); if (newID && newID.trim()) { p.qqId = newID.trim(); saveUserProfile(p); loadUserProfile(); } };
    window.incrementLikeCount = (e) => { if(e) e.stopPropagation(); const p = getUserProfile(); p.likes = parseInt(p.likes) + 1; saveUserProfile(p); loadUserProfile(); const icon = document.querySelector('.me-like-icon'); icon.style.transform = "scale(1.2) rotate(-10deg)"; setTimeout(() => icon.style.transform = "scale(1) rotate(0deg)", 150); };
    
    // 核心修复3：打开/关闭/保存 "我" 页面的设置
        window.openMeSettings = () => {
        const p = getUserProfile();
        document.getElementById('me-settings-nickname').value = p.nickname || '';
        document.getElementById('me-settings-qq-id').value = p.qqId || '';
        document.getElementById('me-settings-likes').value = p.likes || 0;
        document.getElementById('me-settings-avatar-url').value = p.avatar || '';
        document.getElementById('me-settings-cover-url').value = p.cover || '';
        document.getElementById('me-settings-avatar-preview').src = p.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png';
        document.getElementById('me-settings-cover-preview').style.backgroundImage = p.cover ? `url(${p.cover})` : '';

        // 👇👇👇 这是新添加的一行 👇👇👇
        document.getElementById('me-settings-payment-password').value = p.paymentPassword || '000000';

        const container = document.getElementById('me-settings-member-icons-list');
        container.innerHTML = '';
        for (let i = 0; i < 8; i++) {
            const url = p.memberUrls[i] || '';
            container.innerHTML += `<div class="me-settings-row"><div class="me-settings-label">会员${i+1}</div><div class="me-settings-preview-wrapper"><img id="me-preview-m${i+1}" class="me-settings-preview icon" src="${url || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'}"></div><input type="text" id="me-input-m${i+1}" class="me-settings-input" placeholder="图片 URL" value="${url}"></div>`;
        }
        for (let i = 0; i < 8; i++) {
            const input = document.getElementById(`me-input-m${i+1}`);
            const preview = document.getElementById(`me-preview-m${i+1}`);
            input.oninput = () => { handleImgSrcInput(input, preview); };
        }
        document.getElementById('me-settings-modal').classList.add('active');
    };

    window.closeMeSettings = () => {
        document.getElementById('me-settings-modal').classList.remove('active');
    };

        window.saveMeSettings = () => {
        const p = getUserProfile();
        p.nickname = document.getElementById('me-settings-nickname').value.trim();
        p.qqId = document.getElementById('me-settings-qq-id').value.trim();
        p.likes = parseInt(document.getElementById('me-settings-likes').value) || 0;
        
        // 👇👇👇 这是新添加的代码块 👇👇👇
        const paymentPassInput = document.getElementById('me-settings-payment-password').value;
        if (/^\d{6}$/.test(paymentPassInput)) {
            p.paymentPassword = paymentPassInput;
        } else if (paymentPassInput !== (p.paymentPassword || '000000') && paymentPassInput !== '') {
            // 只有在用户输入了新的、但格式不正确的内容时才提示
            showToast('支付密码必须为6位数字，本次未保存。');
        }
        // 👆👆👆 新添加代码块结束 👆👆👆

        const avatarUrlFromInput = document.getElementById('me-settings-avatar-url').value.trim();
        if (avatarUrlFromInput.startsWith('data:image')) {
            p.avatar = avatarUrlFromInput;
        } else if (avatarUrlFromInput) {
            p.avatar = avatarUrlFromInput;
        }
        
        p.cover = document.getElementById('me-settings-cover-url').value.trim();
        
        for (let i = 0; i < 8; i++) {
            p.memberUrls[i] = document.getElementById(`me-input-m${i+1}`).value.trim();
        }
        
        saveUserProfile(p);
        loadUserProfile();
        showToast('个人主页设置已保存');
        closeMeSettings();
    };


    // --- API & Chat ---
    const testApiBtn = document.getElementById('test-api-btn'); const fetchModelsBtn = document.getElementById('fetch-models-btn'); const modelSelect = document.getElementById('model-select'); const apiStatus = document.getElementById('api-status'); const apiUrlInput = document.getElementById('api-url-input'); const apiKeyInput = document.getElementById('api-key-input');
    testApiBtn.onclick = async () => { const url = apiUrlInput.value.trim(); const key = apiKeyInput.value.trim(); if (!url || !key) { showToast('请填写 API 地址和 Key'); return; } testApiBtn.disabled = true; apiStatus.innerText = "测试中..."; try { const res = await fetch(`${url.endsWith('/v1') ? url : url+'/v1'}/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (res.ok) { apiStatus.innerText = "已连接"; apiStatus.className = "api-status connected"; showToast("连接成功！"); } else throw new Error(); } catch(e) { apiStatus.innerText = "连接失败"; apiStatus.className = "api-status disconnected"; showToast("连接失败"); } finally { testApiBtn.disabled = false; } };
    fetchModelsBtn.onclick = async () => { const url = apiUrlInput.value.trim(); const key = apiKeyInput.value.trim(); if (!url || !key) return; fetchModelsBtn.disabled = true; try { const res = await fetch(`${url.endsWith('/v1') ? url : url+'/v1'}/models`, { headers: { 'Authorization': `Bearer ${key}` } }); const data = await res.json(); modelSelect.innerHTML = data.data.map(m => `<option value="${m.id}">${m.id}</option>`).join(''); document.getElementById('model-select-wrapper').style.display = 'block'; } catch(e) { showToast("获取模型失败"); } finally { fetchModelsBtn.disabled = false; } };
    window.openAIChat = () => { const s = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY)); if (!s || !s.api || !s.api.model) { showToast('请先在设置中配置 API'); return; } document.getElementById('current-model-name').innerText = s.api.model; document.getElementById('ai-chat-modal').classList.add('active'); };
    window.closeAIChat = () => document.getElementById('ai-chat-modal').classList.remove('active');

    function saveAllSettings() {
        const icons = {}; 
        document.querySelectorAll('#settings-app-list-container .app-icon-input input').forEach(i => {
             const id = i.id.replace('url-', ''); 
             if (i.value.trim()) icons[id] = i.value.trim(); 
        });
        const getBgUrl = (el) => { const bg = el.style.backgroundImage; return bg ? bg.slice(5, -2).replace(/['"]/g, '') : ''; };
        const settings = {
            api: { url: apiUrlInput.value, key: apiKeyInput.value, model: modelSelect.value, temp: document.getElementById('temp-slider').value },
            visual: { wallpaper: document.getElementById('wallpaper-url').value, widget: document.getElementById('widget-square-url').value, customImg: document.getElementById('custom-image-url').value, icons: icons, timeBg: document.getElementById('time-container').style.backgroundImage, customDate: customDateText, chatAvatar1: getBgUrl(document.getElementById('chat-avatar-1')), chatAvatar2: getBgUrl(document.getElementById('chat-avatar-2')), photoWidgetUrl: document.getElementById('photo-widget-img').src, chatText1: document.querySelector('.chat-bubble-input.left-bubble')?.value || "Say Hi~", chatText2: document.querySelector('.chat-bubble-input.right-bubble')?.value || "Hello!" }
        };
        localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings)); if (event && event.type === 'click') showToast('设置已保存 ⩌⩊⩌'); applyVisual(settings.visual);
    }
    function applyVisual(v) {
        if (v.wallpaper) {
            const isPhoneFrameActive = document.body.classList.contains('phone-frame-active');
            if (isPhoneFrameActive) {
                document.getElementById('phone-screen-content').style.backgroundImage = `url(${v.wallpaper})`;
            } else {
                body.style.backgroundImage = `url(${v.wallpaper})`;
            }
        }
        if (v.timeBg) document.getElementById('time-container').style.backgroundImage = v.timeBg;
        customDateText = v.customDate || ""; updateClock();
        if(v.chatAvatar1) document.getElementById('chat-avatar-1').style.backgroundImage = `url(${v.chatAvatar1})`;
        if(v.chatAvatar2) document.getElementById('chat-avatar-2').style.backgroundImage = `url(${v.chatAvatar2})`;
        const i1 = document.querySelector('.chat-bubble-input.left-bubble'); const i2 = document.querySelector('.chat-bubble-input.right-bubble');
        if(i1 && v.chatText1) { i1.value = v.chatText1; adjustInputWidth(i1); }
        if(i2 && v.chatText2) { i2.value = v.chatText2; adjustInputWidth(i2); }
        const pImg = document.getElementById('photo-widget-img'); const pPh = document.getElementById('photo-widget-placeholder');
        if (v.photoWidgetUrl && v.photoWidgetUrl.length > 20 && !v.photoWidgetUrl.includes('null')) { pImg.src = v.photoWidgetUrl; pImg.style.display = 'block'; pPh.style.display = 'none'; } else { pImg.style.display = 'none'; pPh.style.display = 'flex'; }
        if (v.icons) {
            Object.keys(v.icons).forEach(id => {
                applyIconToUI(id, v.icons[id]);
            });
        }
    }

    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings) return;
        
        if (settings.api) {
            apiUrlInput.value = settings.api.url || '';
            apiKeyInput.value = settings.api.key || '';
            if(settings.api.model) {
                 modelSelect.innerHTML = `<option value="${settings.api.model}">${settings.api.model}</option>`;
                 document.getElementById('model-select-wrapper').style.display = 'block';
                 modelSelect.value = settings.api.model;
            }
            document.getElementById('temp-slider').value = settings.api.temp || 0.8;
            document.getElementById('temp-value-display').innerText = settings.api.temp || 0.8;
        }
        if (settings.visual) {
            document.getElementById('wallpaper-url').value = settings.visual.wallpaper || '';
            document.getElementById('widget-square-url').value = settings.visual.widget || '';
            document.getElementById('custom-image-url').value = settings.visual.customImg || '';
            applyVisual(settings.visual);
            if (settings.visual.icons) {
               setTimeout(() => {
                   Object.keys(settings.visual.icons).forEach(id => {
                       const inp = document.getElementById(`url-${id}`);
                       if(inp) inp.value = settings.visual.icons[id];
                   });
               }, 100);
            }
        }
        
        const iosMode = localStorage.getItem(IOS_MODE_KEY) === 'true';
        document.getElementById('ios-mode-switch').checked = iosMode;
        applyIOSMode(iosMode);
        
        const phoneFrameMode = localStorage.getItem(PHONE_FRAME_KEY) === 'true';
        document.getElementById('phone-frame-switch').checked = phoneFrameMode;
        applyPhoneFrame(phoneFrameMode);
        
        const phoneCaseColor = localStorage.getItem(PHONE_CASE_COLOR_KEY) || '#ffffff';
        document.getElementById('phone-case-color-input').value = phoneCaseColor;
        setPhoneCaseColor(phoneCaseColor);
        
        const catEarsEnabled = localStorage.getItem(CAT_EARS_KEY) === 'true';
        document.getElementById('cat-ears-switch').checked = catEarsEnabled;
        applyCatEars(catEarsEnabled);

        const catEarColor = localStorage.getItem(CAT_EAR_COLOR_KEY) || '#ffffff';
        document.getElementById('cat-ear-color-input').value = catEarColor;
        setCatEarColor(catEarColor);
    }

    document.getElementById('save-settings-btn').onclick = (event) => {
         saveAllSettings(event);
         hideSettingsPage();
         
         // 核心修复：点击 OK 按钮时才应用这些设置
         applyIOSMode(document.getElementById('ios-mode-switch').checked);
         applyPhoneFrame(document.getElementById('phone-frame-switch').checked);
         applyCatEars(document.getElementById('cat-ears-switch').checked);
         setPhoneCaseColor(document.getElementById('phone-case-color-input').value);
         setCatEarColor(document.getElementById('cat-ear-color-input').value);
    };
    
    document.getElementById('temp-slider').oninput = (e) => {
        document.getElementById('temp-value-display').innerText = e.target.value;
    };
    
    // --- 修复：移除所有即时生效的监听器，只保留输入框的值同步 ---
    // 之前这里有 onchange 监听器直接调用 apply... 函数，现已移除，改为只在 save-settings-btn 点击时调用
    
    document.getElementById('phone-case-color-input').addEventListener('input', (event) => {
        // 这里的实时预览保留，提升用户体验，但如果不点OK，下次刷新会还原（逻辑上可以接受，或严格移除）
        // 如果要严格遵循“不点OK不应用”，则应移除这里的预览。
        // 但颜色选择器通常需要预览，这里保留预览效果，持久化存储在saveAllSettings中。
        document.documentElement.style.setProperty('--phone-case-color', event.target.value);
    });
    
    document.getElementById('cat-ear-color-input').addEventListener('input', (event) => {
        document.documentElement.style.setProperty('--cat-ear-color', event.target.value);
    });


    window.handleChatKeyPress = (e) => { if (e.key === 'Enter') sendChatMessage(); };
    window.sendChatMessage = async () => {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;
        
        const msgsDiv = document.getElementById('chat-messages');
        msgsDiv.innerHTML += `<div class="message user">${escapeHtml(text)}</div>`;
        input.value = '';
        msgsDiv.scrollTop = msgsDiv.scrollHeight;

        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings || !settings.api) {
             msgsDiv.innerHTML += `<div class="message ai">请先配置 API。</div>`;
             return;
        }

        try {
            const res = await fetch(`${settings.api.url.endsWith('/v1') ? settings.api.url : settings.api.url+'/v1'}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.api.key}` },
                body: JSON.stringify({
                    model: settings.api.model || 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: text }],
                    temperature: parseFloat(settings.api.temp || 0.7)
                })
            });
            const data = await res.json();
            const reply = data.choices[0].message.content;
            msgsDiv.innerHTML += `<div class="message ai">${escapeHtml(reply)}</div>`;
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
        } catch (e) {
            msgsDiv.innerHTML += `<div class="message ai">Error: ${e.message}</div>`;
        }
    };
    // --- NEW: Backup and Restore Functions ---
    function exportBackup() {
        showToast('正在准备备份文件...', 2000);

        // 定义所有需要备份的核心数据键
        const keysToBackup = [
            ALL_SETTINGS_KEY, CHAT_DATA_KEY, USER_PROFILE_KEY, WALLET_DATA_KEY,
            WORLDBOOK_DATA_KEY, IOS_MODE_KEY, PHONE_FRAME_KEY, PHONE_CASE_COLOR_KEY,
            CAT_EARS_KEY, CAT_EAR_COLOR_KEY, MOMENTS_DATA_KEY, MOMENTS_PROFILE_KEY,
            FORUMS_DATA_KEY, FORUM_POSTS_DATA_KEY, FORUM_USER_DATA_KEY, CSS_PRESETS_KEY
        ];

        const backupData = {};

        // 备份核心数据
        keysToBackup.forEach(key => {
            const data = localStorage.getItem(key);
            if (data) {
                backupData[key] = data;
            }
        });

        // 单独备份所有的聊天记录 (它们的键是动态生成的)
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('chat_msgs_')) {
                backupData[key] = localStorage.getItem(key);
            }
        }

        // 将备份数据转换为JSON字符串
        const jsonString = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        // 创建下载链接
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        a.download = `Hushhh_Backup_${dateStr}.json`;
        
        // 触发下载
        document.body.appendChild(a);
        a.click();
        
        // 清理
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
        
        showToast('备份文件已导出！', 2000);
    }

    function importBackup(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        // 警告用户，这是一个危险操作
        if (!confirm('导入备份将会覆盖您当前的所有数据，且此操作不可逆！确定要继续吗？')) {
            event.target.value = ''; // 清空文件选择，以便下次还能选择同一个文件
            return;
        }

        showToast('正在导入备份...', 3000);
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const jsonString = e.target.result;
                const backupData = JSON.parse(jsonString);

                // 清空当前所有数据
                localStorage.clear();

                // 恢复数据
                for (const key in backupData) {
                    if (Object.prototype.hasOwnProperty.call(backupData, key)) {
                        localStorage.setItem(key, backupData[key]);
                    }
                }
                
                showToast('导入成功！页面即将刷新...', 2000);

                // 2秒后刷新页面以应用所有新设置
                setTimeout(() => {
                    window.location.reload();
                }, 2000);

            } catch (error) {
                console.error("导入备份失败:", error);
                showToast('导入失败，请确保备份文件格式正确！', 3000);
            } finally {
                 event.target.value = ''; // 无论成功失败，都清空文件选择
            }
        };

        reader.readAsText(file);
    }
    
    // --- Initialization ---
    window.onload = () => {
        updateClock();
        setInterval(updateClock, 1000); 
        
        updatePhoneTime();
        setInterval(updatePhoneTime, 1000);
        
        populateSettingsList();
        loadSettings();
        renderChatList();
        loadUserProfile();
        renderForumList();
        renderForumMePage(); 
        generateKeypad();
        initializeAllAutoPosts();
    };
</script>
</body>
</html>