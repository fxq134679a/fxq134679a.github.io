<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no"/>
<title>æ¨¡æ‹Ÿæ‰‹æœº</title>
<style>
/* reset + å…¨å±€ */
*{margin:0;padding:0;box-sizing:border-box}
body{background:#e5e5e5;font-family:-apple-system,BlinkMacSystemFont;display:flex;justify-content:center;padding:30px 0}
.phone{
  width:390px;height:780px;background:#000;border-radius:42px;padding:6px;position:relative;
  overflow:visible; /* å…è®¸æ¡Œå® è¶…å‡ºå¯è§ï¼Œé˜²æ­¢è¢«è£åˆ‡ */
}

/* æ¡Œå® å®¹å™¨ï¼ˆå±å¹•å¤–ä¸Šæ–¹ï¼‰ */
.pet-container{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:-24px;
  width:72px;
  height:72px;
  z-index:999;
  pointer-events:none;
}
.pet-box{width:100%;height:100%;overflow:visible;display:flex;align-items:center;justify-content:center;background:transparent}
.pet-box img{width:100%;height:100%;object-fit:contain;display:block}

/* å±å¹• */
.screen{
  width:100%;
  height:100%;
  border-radius:36px;
  overflow:hidden;
  position:relative;
  background: #fff; /* é»˜è®¤èƒŒæ™¯è‰² */
}

/* ä¸»å± - ä¿®æ”¹å£çº¸å®¹å™¨ */
.home{
  width:100%;
  height:100%;
  position:relative;
  overflow:hidden;
}

/* å£çº¸å±‚ - ç‹¬ç«‹å®¹å™¨ï¼Œè¦†ç›–æ•´ä¸ªå±å¹• */
.wallpaper-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  z-index: 1;
}

/* åº”ç”¨ç½‘æ ¼å®¹å™¨ - åœ¨å£çº¸ä¹‹ä¸Š */
.apps-container {
  position: relative;
  z-index: 2;
  width:100%;
  height:100%;
  padding:60px 20px 80px;
  display:flex;
  flex-direction:column;
}

.apps{display:grid;grid-template-columns:repeat(4,1fr);gap:20px}
.app-item{text-align:center;font-size:12px;cursor:pointer}
.app-name{color:#fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5);} /* ç™½è‰²æ–‡å­—ï¼Œæ·»åŠ é˜´å½±æé«˜å¯è¯»æ€§ */
.app{width:64px;height:64px;border-radius:14px;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.app img{width:100%;height:100%;object-fit:cover}
.wechat-app{background:#07c160;color:#fff;font-size:28px}

/* åˆ˜æµ· */
.notch{position:absolute;top:6px;left:50%;transform:translateX(-50%);width:130px;height:34px;background:#000;border-radius:18px;z-index:20}

/* çŠ¶æ€æ  */
.status-bar{height:44px;padding:0 14px;display:flex;align-items:center;justify-content:space-between;font-size:16px;font-weight:600;position:absolute;top:0;left:0;right:0;z-index:10}
.status-time{margin-left:18px}.status-right{display:flex;gap:6px}.status-right img{height:14px}

/* é¡µé¢ */
.page{
  width:100%;
  height:100%;
  display:none;
  flex-direction:column;
  background:#fff; /* æ‰€æœ‰é¡µé¢é»˜è®¤ç™½è‰²èƒŒæ™¯ */
  padding-top:44px
}

/* Header - é€šç”¨æ ·å¼ */
.header{height:44px;display:flex;align-items:center;justify-content:center;position:relative;font-size:17px;font-weight:600;padding-top:env(safe-area-inset-top,8px)}
.header-left,.header-right{position:absolute;top:0;height:44px;display:flex;align-items:center;padding:0 14px;font-size:22px;cursor:pointer}
.header-left{left:0}.header-right{right:0}
/* è§’è‰²è®¾ç½®é¡µé¢Header - å»æ‰ç°è‰²èƒŒæ™¯ */
.role-setting-header {
  background: #fff;
  border-bottom: none;
  position: sticky;
  top: 0;
  z-index: 10;
}
/* OK æ–‡å­—æŒ‰é’®ï¼ˆç²‰è‰²æ ·å¼ï¼‰ */
.header-right.ok-btn{
  font-size:15px;
  color:#f2b6c6; /* ç²‰è‰²æ–‡å­— */
  background:transparent;
  padding:0 12px;
  border-radius:6px;
  font-weight:600;
}

/* æœç´¢ */
.wechat-search{padding:8px 12px;background:transparent}
.wechat-search-box{height:36px;background:#e0e0e0;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#888}

/* åˆ—è¡¨ */
.list{flex:1;overflow:auto;padding-bottom:80px}
.list-card{background:#fff;border-radius:10px;margin:8px 12px;overflow:hidden}
.chat-item{display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid #f0f0f0;cursor:pointer}
.chat-avatar{width:48px;height:48px;border-radius:8px;background:#ccc;flex:0 0 48px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.chat-avatar img{width:100%;height:100%;object-fit:cover}
.chat-main{flex:1;margin-left:12px;display:flex;flex-direction:column;justify-content:center;min-width:0;/* ç¡®ä¿å†…å®¹ä¸ä¼šæº¢å‡º */}
.chat-name{font-size:15px;font-weight:600;color:#111;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
/* ä¿®æ”¹ï¼šæœ€æ–°æ¶ˆæ¯é¢„è§ˆåŒºåŸŸå›ºå®šå•è¡Œæ ·å¼ */
.chat-preview{
  font-size:13px;
  color:#888;
  white-space:nowrap;/* ç¦æ­¢æ¢è¡Œ */
  overflow:hidden;/* éšè—æº¢å‡ºå†…å®¹ */
  text-overflow:clip;/* ä¸ä½¿ç”¨çœç•¥å·ï¼Œç›´æ¥è£å‰ª */
  width:100%;/* å›ºå®šå®½åº¦ */
  height:18px;/* å›ºå®šé«˜åº¦ï¼Œå¯¹åº”1è¡Œæ–‡å­— */
  line-height:18px;/* è¡Œé«˜ä¸é«˜åº¦ä¸€è‡´ */
  max-width:100%;/* æœ€å¤§å®½åº¦é™åˆ¶ */
  display:block;/* ç¡®ä¿å—çº§æ˜¾ç¤º */
}
.chat-time{flex:0 0 54px;text-align:right;color:#999;font-size:12px;white-space:nowrap}

/* Tabs */
.tabs{height:60px;display:flex;border-top:1px solid #ddd;background:#fff;position:relative;z-index:3}
.tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;color:#333;cursor:pointer}
.tab-icon{font-size:22px;margin-bottom:2px}
.tab.active{color:#07c160}

/* æˆ‘ï¼šæ–°çš„æ ·å¼åŒºåŸŸ */
.me-wrap{padding:8px 12px}
.profile{background:#fff;padding:16px;border-radius:10px;margin-bottom:10px;display:flex;align-items:center}
.avatar{width:60px;height:60px;border-radius:8px;background:#ccc;overflow:hidden;margin-right:14px}
.avatar img{width:100%;height:100%;object-fit:cover}
.name{font-size:18px}
.wxid{font-size:12px;color:#888;margin-top:4px}

/* æˆ‘é¡µé¢çš„ä¸‰é¡¹ï¼šæŒ‰å›¾ç‰‡æ ·å¼ */
.me-options{background:#fff;border-radius:10px;margin:8px 12px;overflow:hidden}
.me-item{display:flex;align-items:center;justify-content:space-between;padding:18px 16px;border-bottom:1px solid #f0f0f0;cursor:pointer}
.me-item:last-child{border-bottom:none}
.me-item .left{display:flex;align-items:center;gap:12px}
.me-item .label{font-size:18px;color:#111}
.me-item .chev{font-size:18px;color:#999}

/* æˆ‘é¡µé¢æ•´ä½“ä¸è¦å¤ªå¤§ï¼Œä¿ç•™ç•™ç™½ */
.me-container{flex:1;overflow:auto;padding-bottom:16px}

/* è®¾ç½®é¡¹ï¼ˆé€šç”¨ï¼‰ */
.setting-item{background:#fff;padding:14px;border-bottom:1px solid #eee}
.setting-item input{margin-top:10px;width:100%}

/* home settings */
.home-settings-list{padding:10px;overflow:auto}
.home-settings-row{background:#fff;padding:14px;margin-bottom:8px;border-radius:8px;display:flex;align-items:center;justify-content:space-between}
.home-settings-row label{font-size:14px;color:#222}
.home-settings-row input[type="file"]{font-size:12px}

/* API card */
.api-card{background:#fff;padding:12px;border-radius:8px;margin-bottom:8px}
.api-row{display:flex;align-items:center;justify-content:space-between;padding:8px 4px;border-top:1px solid #f0f0f0}
.api-row:first-child{border-top:none}
.api-row label{flex:0 0 110px;color:#222}
.api-row .field{flex:1;display:flex;align-items:center;gap:8px}

/* plus popup */
.plus-mask{position:absolute;inset:0;background:transparent;display:none;pointer-events:none;z-index:50}
.plus-mask.show{display:block;pointer-events:auto}
.plus-panel{position:absolute;top:56px;right:12px;width:180px;background:#4a4a4a;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
.plus-item{padding:14px;color:#fff;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,.12);cursor:pointer}
.plus-item:last-child{border-bottom:none}

/* èŠå¤©çª—å£æ ·å¼ */
.chat-window{
  display:none;
  flex-direction:column;
  height:100%;
  position:relative;
  background:#f5f5f5; /* èŠå¤©çª—å£æœ‰ç‹¬ç«‹èƒŒæ™¯è‰² */
}
.chat-header{height:56px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #eee;position:relative;padding-top:env(safe-area-inset-top,10px);background:linear-gradient(transparent,#fff)}
.chat-header .left{position:absolute;left:10px;top:0;bottom:0;display:flex;align-items:center;cursor:pointer}
.chat-header .right{position:absolute;right:10px;top:0;bottom:0;display:flex;align-items:center;cursor:pointer}
.chat-header .title{font-size:17px;font-weight:600}

/* èŠå¤©åŒºåŸŸ - æ–°å¢å¤´åƒæ ·å¼ */
.chat-body{flex:1;padding:12px;overflow:auto;/* èŠå¤©èƒŒæ™¯å¯è‡ªå®šä¹‰ */}
.msg-row{display:flex;margin-bottom:8px;align-items:flex-end;/* å¯¹é½æ°”æ³¡åº•éƒ¨ */}
/* æ¶ˆæ¯å¤´åƒæ ·å¼ï¼šæ­£æ–¹å½¢ã€æ¯”æ°”æ³¡å¤§ - ä¿®æ”¹ï¼šç¨å¾®ç¼©å°å¤´åƒ */
.msg-avatar{
  width:44px;/* ä¿®æ”¹ï¼šä»50pxç¼©å°åˆ°44px */
  height:44px;/* ä¿®æ”¹ï¼šä»50pxç¼©å°åˆ°44px */
  border-radius:8px;/* å¸¦åœ†è§’ */
  border:1px solid #eee;/* è¾¹æ¡† */
  overflow:hidden;
  flex-shrink:0;
}
.msg-avatar img{width:100%;height:100%;object-fit:cover}
/* å¯¹æ–¹æ¶ˆæ¯ï¼šå¤´åƒåœ¨å·¦ï¼Œæ°”æ³¡åœ¨å³ */
.msg-left{justify-content:flex-start}
.msg-left .msg-avatar{margin-right:8px;}
/* æˆ‘çš„æ¶ˆæ¯ï¼šå¤´åƒåœ¨å³ï¼Œæ°”æ³¡åœ¨å·¦ */
.msg-right{justify-content:flex-end}
.msg-right .msg-avatar{margin-left:8px;}
/* æ°”æ³¡åŸºç¡€æ ·å¼ */
.msg-bubble{
  max-width:70%;
  padding:8px 12px;
  border-radius:12px;
  font-size:14px;
  line-height:1.3;
  position:relative; /* ä¸ºåŒå‡»äº‹ä»¶æ·»åŠ ç›¸å¯¹å®šä½ */
  user-select:text; /* å…è®¸æ–‡æœ¬é€‰æ‹© */
  -webkit-user-select:text;
  cursor:default; /* é»˜è®¤å…‰æ ‡ */
}
/* é»˜è®¤æ°”æ³¡æ ·å¼ï¼ˆæœªè‡ªå®šä¹‰æ—¶ï¼‰ */
.msg-left .msg-bubble{background:#fff;border:1px solid #eee;border-top-left-radius:6px}
.msg-right .msg-bubble{background:#cfe8ff}

/* å·²æ’¤å›æ¶ˆæ¯æ ·å¼ */
.msg-bubble.recalled {
  background:#f8f8f8 !important;
  color:#999 !important;
  font-style:italic;
  border:1px dashed #ddd !important;
}

/* åº•éƒ¨è¾“å…¥åŒº - æ¢å¤åŸæœ¬æ ·å¼ */
.chat-input-bar{height:64px;padding:10px;display:flex;align-items:center;gap:8px;border-top:1px solid #eee;background:#fafafa;padding-bottom:calc(env(safe-area-inset-bottom,10px));position:relative}
.btn-circle{
  width:40px;
  height:40px;
  border-radius:20px;/* ä¿æŒåŸæœ‰åœ†è§’ */
  display:flex;align-items:center;justify-content:center;
  background:#fff;/* æ¢å¤åŸæœ¬ç™½è‰²èƒŒæ™¯ */
  border:1px solid #eee;/* æ¢å¤åŸæœ¬æµ…ç°è‰²è¾¹æ¡† */
  cursor:pointer;
}
.btn-circle img{width:20px;height:20px;display:block;/* å»æ‰é¢œè‰²åŠ æ·±æ»¤é•œï¼Œæ¢å¤åŸæœ¬å›¾æ ‡é¢œè‰² */}
.input-box{flex:1;height:40px;border-radius:20px;background:#fff;border:1px solid #eee;display:flex;align-items:center;padding:0 12px}
.input-box input{border:0;outline:none;width:100%;font-size:15px}

/* toast - æ·¡ç²‰è‰²ä¿å­˜æˆåŠŸå¼¹çª—ï¼ˆå›ºå®šæ ·å¼ï¼‰ */
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:40px;
  background:#ffe6ef;/* æ·¡ç²‰è‰²èƒŒæ™¯ */
  color:#333;/* æ·±è‰²æ–‡å­— */
  padding:10px 20px;
  border-radius:12px;/* åœ†è§’æ›´åœ†æ¶¦ */
  z-index:2000;
  display:none;
  box-shadow:0 2px 8px rgba(242,182,198,0.3);/* è½»å¾®ç²‰è‰²é˜´å½± */
  font-size:14px;
  animation: fadeInToast 0.2s ease-out;
}
/* å¼¹çª—æ·¡å…¥åŠ¨ç”» */
@keyframes fadeInToast {
  from { opacity:0; transform: translateX(-50%) translateY(10px); }
  to { opacity:1; transform: translateX(-50%) translateY(0); }
}
.toast.show{display:block}

/* æ–°æ’å…¥èŠå¤©æ¡ç›®æ·¡å…¥ */
@keyframes fadeIn { from { opacity:0; transform: translateY(-6px);} to { opacity:1; transform: translateY(0);} }
.fade-in{animation:fadeIn 0.3s ease forwards}

/* è§’è‰²ä¸“å±è®¾ç½®é¡µé¢æ ·å¼ - æ”¯æŒå‚ç›´æ»‘åŠ¨ */
.role-setting-page{
  padding:16px;
  background:#fff;
  flex:1;
  overflow-y:auto; /* å¼€å¯å‚ç›´æ»šåŠ¨ */
  -webkit-overflow-scrolling: touch; /* ä¼˜åŒ–ç§»åŠ¨ç«¯æ»šåŠ¨ä½“éªŒ */
  max-height: calc(100vh - 44px); /* é™åˆ¶é«˜åº¦ï¼Œé¿å…è¶…å‡ºå±å¹• */
}
.role-setting-section{
  margin-bottom:20px;
}
.role-setting-title{
  font-size:16px;
  font-weight:600;
  margin-bottom:8px;
  color:#333;
}
.role-avatar-container{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.role-avatar-preview{
  width:80px;
  height:80px;
  border-radius:8px;
  border:1px solid #f2b6c6;/* æµ…ç²‰è‰²è¾¹æ¡† */
  overflow:hidden;
}
.role-avatar-preview img{width:100%;height:100%;object-fit:cover}
.role-setting-btn{
  padding:8px 16px;
  border-radius:8px;
  border:1px solid #f2b6c6;/* æµ…ç²‰è‰²è¾¹æ¡† */
  background:#fff;
  color:#333;
  cursor:pointer;
}
.role-setting-input{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #f2b6c6;/* æµ…ç²‰è‰²è¾¹æ¡† */
  margin-bottom:8px;
  box-sizing:border-box;
}
.role-setting-textarea{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:1px solid #f2b6c6;/* æµ…ç²‰è‰²è¾¹æ¡† */
  min-height:120px;/* è°ƒæ•´ä¸ºè‡³å°‘120pxé«˜åº¦ */
  box-sizing:border-box;
  resize:none;/* ç¦æ­¢æ‹‰ä¼¸ */
}
/* æ°”æ³¡æ ·å¼è¯´æ˜æ–‡æœ¬ */
.bubble-desc{
  font-size:11px;
  color:#888;
  margin-top:4px;
  margin-bottom:8px;
}

/* æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆå±…ä¸­æ ·å¼ - æ–°å¢ï¼‰ */
.msg-time {
  text-align: center;
  margin: 10px 0;
}
.msg-time span {
  font-size: 11px;
  color: #999;
  background: #f0f0f0;
  padding: 2px 8px;
  border-radius: 4px;
  line-height: 1;
}

/* æ–°å¢ï¼šä¸‰ä¸ªè·³åŠ¨çš„åœ†ç‚¹åŠ¨ç”»æ ·å¼ */
.typing-dots {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 18px;
}

.typing-dots span {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: #666;
  margin: 0 2px;
  animation: dotBounce 1.4s infinite ease-in-out both;
}

.typing-dots span:nth-child(1) {
  animation-delay: -0.32s;
}

.typing-dots span:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes dotBounce {
  0%, 80%, 100% { 
    transform: scale(0);
    opacity: 0.5;
  } 
  40% { 
    transform: scale(1);
    opacity: 1;
  }
}

/* æ–°å¢ï¼šé¡¶éƒ¨è¾“å…¥ä¸­çŠ¶æ€æ ·å¼ */
.typing-indicator {
  color: #f2b6c6 !important; /* æ·¡ç²‰è‰² */
  font-size: 15px !important; /* ç¨å°å­—å· */
  font-weight: 500 !important; /* ç¨è½»å­—é‡ */
  transition: all 0.3s ease;
}

/* æ–°å¢ï¼šåŒå‡»æ¶ˆæ¯æ“ä½œå¼¹çª—æ ·å¼ */
.msg-action-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 1000;
  display: none;
}

.msg-action-mask.show {
  display: block;
}

.msg-action-popup {
  position: absolute;
  background: #ffe6ef;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(242,182,198,0.3);
  overflow: hidden;
  z-index: 1001;
  min-width: 140px;
  animation: popupFadeIn 0.2s ease-out;
}

@keyframes popupFadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg-action-item {
  padding: 14px 16px;
  color: #f27a9b;
  font-size: 15px;
  text-align: center;
  cursor: pointer;
  border-bottom: 1px solid rgba(242,122,155,0.2);
  transition: background 0.2s;
  white-space: nowrap;
}

.msg-action-item:last-child {
  border-bottom: none;
}

.msg-action-item:hover {
  background: rgba(242,122,155,0.1);
}

/* ç¼–è¾‘æ¶ˆæ¯å¼¹çª—æ ·å¼ */
.edit-message-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.25);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  display: none;
}

.edit-message-mask.show {
  display: flex;
}

.edit-message-popup {
  background: #ffe6ef;
  border-radius: 12px;
  padding: 20px;
  width: 320px;
  max-width: 90%;
  box-shadow: 0 2px 8px rgba(242,182,198,0.3);
  animation: popupFadeIn 0.2s ease-out;
}

.edit-message-title {
  font-size: 16px;
  color: #f27a9b;
  margin-bottom: 12px;
  text-align: center;
  font-weight: 600;
}

.edit-message-input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #f2b6c6;
  background: #fff;
  font-size: 14px;
  color: #333;
  margin-bottom: 16px;
  box-sizing: border-box;
  resize: none;
  min-height: 80px;
}

.edit-message-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
}

.edit-message-btn {
  padding: 10px 24px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.2s;
}

.edit-message-btn.ok {
  background: #f6c1d0;
  color: #fff;
}

.edit-message-btn.cancel {
  background: rgba(242,122,155,0.1);
  color: #f27a9b;
}

.edit-message-btn:hover {
  opacity: 0.9;
}

/* å¤šé€‰æ¨¡å¼æ ·å¼ */
.multi-select-mode .msg-bubble {
  cursor: pointer;
}

.multi-select-mode .msg-bubble.selected {
  outline: 2px solid #f27a9b;
  outline-offset: 2px;
}

.multi-select-toolbar {
  position: absolute;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%);
  background: #ffe6ef;
  border-radius: 12px;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 20px;
  box-shadow: 0 2px 8px rgba(242,182,198,0.3);
  z-index: 100;
  animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.multi-select-toolbar .count {
  color: #f27a9b;
  font-size: 14px;
  white-space: nowrap;
}

.multi-select-toolbar .actions {
  display: flex;
  gap: 12px;
}

.multi-select-toolbar .action-btn {
  padding: 6px 12px;
  border-radius: 6px;
  background: #f6c1d0;
  color: #fff;
  font-size: 13px;
  border: none;
  cursor: pointer;
}

.multi-select-toolbar .action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* å¤šé€‰æ¨¡å¼é€€å‡ºæŒ‰é’® */
.exit-multi-select {
  position: absolute;
  top: 10px;
  right: 50px;
  padding: 6px 12px;
  border-radius: 6px;
  background: rgba(242,122,155,0.1);
  color: #f27a9b;
  font-size: 13px;
  border: none;
  cursor: pointer;
}

/* åŒå‡»åé¦ˆæ•ˆæœ */
.msg-bubble.double-click-feedback {
  animation: doubleClickFeedback 0.3s ease;
}

@keyframes doubleClickFeedback {
  0% { transform: scale(1); }
  50% { transform: scale(0.98); }
  100% { transform: scale(1); }
}

/* æ–°å¢ï¼šä¸–ç•Œä¹¦Appé¡µé¢æ ·å¼ */
.world-book-header {
  background: #fff;
  border-bottom: 1px solid #f0f0f0;
  color: #f27a9b; /* æµ…ç²‰è‰²å­—ä½“ */
}

.world-book-add-btn {
  width: 30px;
  height: 30px;
  border-radius: 15px;
  background: #f6c1d0; /* ç²‰è‰²åœ†å½¢æŒ‰é’® */
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.world-book-add-btn:hover {
  transform: scale(1.1);
}

/* ä¸–ç•Œä¹¦æ¡ç›®æ ·å¼ */
.world-book-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.world-book-item {
  background: #fff;
  border: 1px solid #f2b6c6; /* æµ…ç²‰è‰²è¾¹æ¡† */
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.world-book-item:hover {
  box-shadow: 0 2px 8px rgba(242,182,198,0.15);
  transform: translateY(-2px);
}

.world-book-item-title {
  font-size: 16px;
  font-weight: 600;
  color: #f27a9b; /* æ·±ç²‰è‰² */
  margin-bottom: 6px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.world-book-item-preview {
  font-size: 13px;
  color: #666;
  line-height: 1.4;
  height: 36px; /* å›ºå®š2è¡Œé«˜åº¦ */
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.world-book-item-time {
  font-size: 11px;
  color: #999;
  margin-top: 8px;
  text-align: right;
}

/* ä¸–ç•Œä¹¦å¼¹çª—æ ·å¼ */
.world-book-mask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.25);
  z-index: 2000;
  display: flex;
  align-items: center;
  justify-content: center;
  display: none;
}

.world-book-mask.show {
  display: flex;
}

.world-book-popup {
  background: #ffe6ef; /* æœå†»è´¨æ„ŸèƒŒæ™¯ */
  border: 2px solid #f2b6c6; /* è¾¹æ¡†é¢œè‰² */
  border-radius: 16px; /* åœ†è§’16px */
  padding: 24px;
  width: 320px;
  max-width: 90%;
  box-shadow: 0 2px 8px rgba(242,182,198,0.3); /* è½»å¾®ç²‰è‰²é˜´å½± */
  animation: popupFadeIn 0.2s ease-out;
}

.world-book-popup-title {
  font-size: 16px;
  color: #f27a9b; /* æµ…ç²‰è‰²æ ‡é¢˜ */
  margin-bottom: 16px;
  text-align: center;
  font-weight: 600;
}

.world-book-form-group {
  margin-bottom: 16px;
}

.world-book-form-label {
  display: block;
  font-size: 14px;
  color: #f27a9b; /* æ·±ç²‰è‰²æ ‡ç­¾ */
  margin-bottom: 6px;
  font-weight: 500;
}

.world-book-form-input {
  width: 100%;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #f2b6c6; /* ç²‰è‰²è¾¹æ¡† */
  background: #fff;
  font-size: 14px;
  color: #333;
  box-sizing: border-box;
}

.world-book-form-input:focus {
  outline: none;
  border-color: #f27a9b;
}

.world-book-form-textarea {
  width: 100%;
  height: 150px; /* å›ºå®šé«˜åº¦ */
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #f2b6c6;
  background: #fff;
  font-size: 14px;
  color: #333;
  resize: none; /* ç¦æ­¢æ‹‰ä¼¸ */
  box-sizing: border-box;
  line-height: 1.4;
}

.world-book-form-textarea:focus {
  outline: none;
  border-color: #f27a9b;
}

.world-book-popup-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 20px;
}

.world-book-popup-btn {
  padding: 10px 24px;
  border-radius: 8px;
  border: none;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.world-book-popup-btn.ok {
  background: #f6c1d0; /* ç²‰è‰²æŒ‰é’® */
  color: #fff;
}

.world-book-popup-btn.cancel {
  background: rgba(242,122,155,0.1);
  color: #f27a9b;
}

.world-book-popup-btn:hover {
  opacity: 0.9;
}

/* ä¸–ç•Œä¹¦ç©ºçŠ¶æ€ */
.world-book-empty {
  text-align: center;
  padding: 60px 20px;
  color: #ccc;
}

.world-book-empty-icon {
  font-size: 48px;
  margin-bottom: 12px;
  opacity: 0.5;
}

.world-book-empty-text {
  font-size: 14px;
  color: #999;
}
</style>
</head>
<body>
<div class="phone">

  <!-- æ¡Œå®  -->
  <div class="pet-container" id="petContainer" aria-hidden="true">
    <div class="pet-box" id="petBox"></div>
  </div>

  <div class="screen" id="screen">
    <div class="notch"></div>

    <div class="status-bar">
      <div id="time" class="status-time">00:00</div>
      <div class="status-right">
        <img src="https://img.heliar.top/file/1768515766612_IMG_3349.png" alt="net">
        <img src="https://img.heliar.top/file/1768516105836_IMG_3350.png" alt="bat">
      </div>
    </div>

    <!-- ä¸»å± - å£çº¸ä»…åœ¨è¿™é‡Œæ˜¾ç¤º -->
    <div class="home page" id="home">
      <!-- å£çº¸å±‚ -->
      <div class="wallpaper-layer" id="wallpaperLayer"></div>
      
      <!-- åº”ç”¨ç½‘æ ¼å®¹å™¨ -->
      <div class="apps-container">
        <div class="apps">
          <div class="app-item" onclick="openWeChat()">
            <div class="app wechat-app" id="wechatIcon"><img src="" alt="" style="width:100%;height:100%;object-fit:cover;display:block"></div>
            <div class="app-name">Wechat</div>
          </div>

          <!-- æ–°å¢ï¼šä¸–ç•Œä¹¦å›¾æ ‡ -->
          <div class="app-item" onclick="openWorldBook()">
            <div class="app" id="worldBookIcon" style="background:#ffcc00">ğŸ“–</div>
            <div class="app-name">ä¸–ç•Œä¹¦</div>
          </div>

          <div class="app-item" onclick="openHomeSettings()">
            <div class="app" id="homeSettingsIcon" style="background:#f0f0f0">âš™ï¸</div>
            <div class="app-name">è®¾ç½®</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Wechat ä¸»é¡µé¢ï¼ˆèŠå¤©åˆ—è¡¨ï¼‰ -->
    <div class="page" id="wechat">
      <div class="header">
        <div class="header-left" onclick="backHome()">âœ©</div>
        Wechat
        <div class="header-right" id="plusBtn" onclick="openPlus()">ï¼‹</div>
      </div>

      <div class="wechat-search" id="wechatSearch">
        <div class="wechat-search-box">ğŸ” æœç´¢</div>
      </div>

      <div class="list" id="wechatContent"></div>

      <div class="tabs" id="wechatTabs">
        <div class="tab active" data-tab="chat" onclick="switchTab('chat', this)"><div class="tab-icon">ğŸ’¬</div><div>å¾®ä¿¡</div></div>
        <div class="tab" data-tab="contact" onclick="switchTab('contact', this)"><div class="tab-icon">ğŸ‘¥</div><div>é€šè®¯å½•</div></div>
        <div class="tab" data-tab="find" onclick="switchTab('find', this)"><div class="tab-icon">ğŸ§­</div><div>å‘ç°</div></div>
        <div class="tab" data-tab="me" onclick="switchTab('me', this)"><div class="tab-icon">ğŸ‘¤</div><div>æˆ‘</div></div>
      </div>
    </div>

    <!-- èŠå¤©çª—å£ï¼ˆæ–°ï¼‰ -->
    <div class="page chat-window" id="chatWindow">
      <div class="chat-header">
        <div class="left" onclick="closeChat()">â€¹</div>
        <div class="title" id="chatTitle">å¯¹è¯</div>
        <div class="right" onclick="openRoleSetting()">â‹¯</div>
      </div>

      <div class="chat-body" id="chatBody"></div>

      <div class="chat-input-bar">
        <!-- ä½¿ç”¨ä½ æä¾›çš„ä¸‰ä¸ªå›¾åºŠ -->
        <div class="btn-circle" id="micBtn" onclick="triggerAIReply()"><img id="micImg" src="https://img.heliar.top/file/1768546088581_IMG_3422.png" alt="mic"></div>
        <div class="input-box"><input id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œå›è½¦å‘é€" onkeydown="if(event.key==='Enter'){ sendChatMessage(); }"></div>
        <div class="btn-circle" id="emojiBtn"><img id="emojiImg" src="https://img.heliar.top/file/1768546261329_IMG_3423.png" alt="emoji"></div>
        <div class="btn-circle" id="plusChatBtn"><img id="plusChatImg" src="https://img.heliar.top/file/1768546259205_IMG_3424.png" alt="plus"></div>
      </div>
    </div>

    <!-- è§’è‰²ä¸“å±è®¾ç½®é¡µé¢ - è°ƒæ•´ä¸ºflexå¸ƒå±€æ”¯æŒæ»‘åŠ¨ -->
    <div class="page" id="roleSettingPage" style="display: flex; flex-direction: column;">
      <!-- ä¿®æ”¹ï¼šHeaderå›ºå®šåœ¨é¡¶éƒ¨ -->
      <div class="header role-setting-header">
        <div class="header-left" onclick="backToChat()">â€¹</div>
        <div class="title" id="roleSettingTitle">è§’è‰²è®¾ç½®</div>
        <div class="header-right ok-btn" onclick="saveRoleSetting()">OK</div>
      </div>
      <!-- å†…å®¹åŒºåŸŸæ”¯æŒæ»šåŠ¨ -->
      <div class="role-setting-page">
        <!-- è§’è‰²å¤´åƒåŒºåŸŸ -->
        <div class="role-setting-section">
          <div class="role-setting-title">è§’è‰²å¤´åƒ</div>
          <div class="role-avatar-container">
            <div class="role-avatar-preview" id="roleAvatarPreview">
              <img id="roleAvatarImg" src="" alt="è§’è‰²å¤´åƒ">
            </div>
            <input type="file" accept="image/*" id="roleAvatarInput" style="display:none" onchange="previewRoleAvatar()">
            <button class="role-setting-btn" onclick="document.getElementById('roleAvatarInput').click()">ä¸Šä¼ å¤´åƒ</button>
          </div>
        </div>

        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="role-setting-section">
          <div class="role-setting-title">åŸºæœ¬ä¿¡æ¯</div>
          <input type="text" class="role-setting-input" id="roleNameInput" placeholder="å¥½å‹å§“å">
          <input type="text" class="role-setting-input" id="roleRemarkInput" placeholder="å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰">
          <textarea class="role-setting-textarea" id="roleDescInput" placeholder="ä¿¡æ¯ï¼ˆå¡«å†™è§’è‰²ç›¸å…³è¯¦æƒ…ï¼‰"></textarea>
        </div>

        <!-- èŠå¤©é¡µå£çº¸è®¾ç½® -->
        <div class="role-setting-section">
          <div class="role-setting-title">èŠå¤©é¡µå£çº¸</div>
          <button class="role-setting-btn" onclick="document.getElementById('roleBgInput').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
          <input type="file" accept="image/*" id="roleBgInput" style="display:none" onchange="setRoleChatBg()">
        </div>

        <!-- æ°”æ³¡CSSæ ·å¼ - æ‹†åˆ†è§’è‰²å’Œç”¨æˆ·æ°”æ³¡ -->
        <div class="role-setting-section">
          <div class="role-setting-title">è§’è‰²æ°”æ³¡æ ·å¼ï¼ˆå¯¹æ–¹ï¼‰</div>
          <div class="bubble-desc">è¾“å…¥CSSä»£ç ï¼ˆä¾‹ï¼šbackground:#ffe6ef;border-radius:16px;ï¼‰</div>
          <textarea class="role-setting-textarea" id="roleBubbleCssInput" placeholder="è®¾ç½®å¯¹æ–¹èŠå¤©æ°”æ³¡æ ·å¼"></textarea>
        </div>

        <div class="role-setting-section">
          <div class="role-setting-title">ç”¨æˆ·æ°”æ³¡æ ·å¼ï¼ˆè‡ªå·±ï¼‰</div>
          <div class="bubble-desc">è¾“å…¥CSSä»£ç ï¼ˆä¾‹ï¼šbackground:#cfe8ff;border-radius:16px;ï¼‰</div>
          <textarea class="role-setting-textarea" id="userBubbleCssInput" placeholder="è®¾ç½®è‡ªå·±èŠå¤©æ°”æ³¡æ ·å¼"></textarea>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ï¼šä¸–ç•Œä¹¦Appé¡µé¢ -->
    <div class="page" id="worldBookPage">
      <div class="header world-book-header">
        <div class="header-left" onclick="backHome()">â€¹</div>
        ä¸–ç•Œä¹¦
        <div class="header-right world-book-add-btn" onclick="openWorldBookPopup()">ï¼‹</div>
      </div>

      <div class="world-book-list" id="worldBookList">
        <!-- ä¸–ç•Œä¹¦æ¡ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ä¸»å±è®¾ç½®åº”ç”¨ï¼ˆåŒ…å« API å—ï¼‰ -->
    <div class="page" id="homeSettings">
      <div class="header">
        <div class="header-left" onclick="backHome()">â€¹</div>
        <div class="title">è®¾ç½®</div>
        <div class="header-right ok-btn" onclick="saveApiSettings()">OK</div>
      </div>

      <div class="list home-settings-list" id="homeSettingsList">
        <div class="home-settings-row">
          <label>ä¿®æ”¹ä¸»å±å¹•å£çº¸</label>
          <input type="file" accept="image/*" onchange="setWallpaper(this)">
        </div>

        <div class="home-settings-row">
          <label>ä¿®æ”¹ Wechat å›¾æ ‡</label>
          <input type="file" accept="image/*" onchange="setWeChatIcon(this)">
        </div>

        <!-- æ–°å¢ï¼šä¿®æ”¹ä¸–ç•Œä¹¦å›¾æ ‡ -->
        <div class="home-settings-row">
          <label>ä¿®æ”¹ ä¸–ç•Œä¹¦ å›¾æ ‡</label>
          <input type="file" accept="image/*" onchange="setWorldBookIcon(this)">
        </div>

        <div class="home-settings-row">
          <label>ä¿®æ”¹ è®¾ç½® å›¾æ ‡</label>
          <input type="file" accept="image/*" onchange="setHomeSettingsIcon(this)">
        </div>

        <div class="home-settings-row">
          <label>ä¿®æ”¹æ‰‹æœºæ¡Œå® </label>
          <input type="file" accept="image/*" onchange="setPetImage(this)">
        </div>

        <div class="api-card" id="apiCard">
          <div style="font-size:15px;color:#222;margin-bottom:6px">API è®¾ç½®</div>

          <div class="api-row">
            <label>åä»£åœ°å€</label>
            <div class="field"><input id="apiProxy" type="text" placeholder="https://your-proxy.example" style="width:100%;padding:6px;border-radius:6px;border:1px solid #ddd"></div>
          </div>

          <div class="api-row">
            <label>API Key</label>
            <div class="field"><input id="apiKey" type="password" placeholder="Bearer key" style="width:100%;padding:6px;border-radius:6px;border:1px solid #ddd"></div>
          </div>

          <div class="api-row">
            <label>æ¨¡å‹</label>
            <div class="field api-select">
              <select id="apiModel"><option value="">ï¼ˆç©ºï¼‰</option></select>
              <button onclick="pullModels()" style="padding:6px 8px;border-radius:6px;border:1px solid #ddd;background:#fafafa;cursor:pointer">æ‹‰å–</button>
            </div>
          </div>

          <div class="api-row">
            <label>æ¸©åº¦</label>
            <div class="field" style="align-items:center">
              <input id="apiTemp" type="range" min="0" max="2" step="0.01" value="0.8" style="flex:1">
              <div class="temp-value" id="apiTempVal">0.80</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ‘ -> è®¾ç½® -->
    <div class="page" id="setting">
      <div class="header">
        <div class="header-left" onclick="backMe()">â€¹</div>
        <div class="title">è®¾ç½®</div>
        <div class="header-right ok-btn" onclick="saveApiSettings()">OK</div>
      </div>
      <div class="list" id="settingList">
        <div class="setting-item">ä¿®æ”¹å¾®ä¿¡æ˜µç§°<input type="text" id="nickInput" oninput="setNickname(this.value)"></div>
        <div class="setting-item">ä¿®æ”¹å¾®ä¿¡å·<input type="text" id="wxidInput" oninput="setWxId(this.value)"></div>
        <div class="setting-item">ä¿®æ”¹å¤´åƒ<input type="file" accept="image/*" onchange="setAvatar(this)"></div>
      </div>
    </div>

    <!-- plus mask -->
    <div class="plus-mask" id="plusMask" onclick="closePlus()">
      <div class="plus-panel" onclick="event.stopPropagation()">
        <div class="plus-item" onclick="startGroup()">ğŸ’¬ å‘èµ·ç¾¤èŠ</div>
        <div class="plus-item" onclick="addFriend()">ğŸ‘¤ æ·»åŠ æœ‹å‹</div>
      </div>
    </div>

  </div>
</div>

<!-- æ–°å¢ï¼šä¸–ç•Œä¹¦å¼¹çª— -->
<div class="world-book-mask" id="worldBookMask" onclick="closeWorldBookPopup()">
  <div class="world-book-popup" onclick="event.stopPropagation()">
    <div class="world-book-popup-title" id="worldBookPopupTitle">æ–°å»ºä¸–ç•Œä¹¦</div>
    
    <div class="world-book-form-group">
      <label class="world-book-form-label">ä¸–ç•Œä¹¦å</label>
      <input type="text" class="world-book-form-input" id="worldBookTitleInput" placeholder="è¯·è¾“å…¥ä¹¦å">
    </div>
    
    <div class="world-book-form-group">
      <label class="world-book-form-label">å†…å®¹</label>
      <textarea class="world-book-form-textarea" id="worldBookContentInput" placeholder="è¯·è¾“å…¥å†…å®¹..."></textarea>
    </div>
    
    <div class="world-book-popup-buttons">
      <button class="world-book-popup-btn cancel" onclick="closeWorldBookPopup()">å–æ¶ˆ</button>
      <button class="world-book-popup-btn ok" onclick="saveWorldBook()">OK</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- æ–°å¢ï¼šåŒå‡»æ¶ˆæ¯æ“ä½œå¼¹çª— -->
<div class="msg-action-mask" id="msgActionMask" onclick="closeMsgActionPopup()">
  <div class="msg-action-popup" id="msgActionPopup" onclick="event.stopPropagation()">
    <div class="msg-action-item" onclick="deleteMessage()">åˆ é™¤</div>
    <div class="msg-action-item" onclick="editMessage()">ç¼–è¾‘</div>
    <div class="msg-action-item" onclick="recallMessage()">æ’¤å›</div>
    <div class="msg-action-item" onclick="enterMultiSelectMode()">å¤šé€‰</div>
  </div>
</div>

<!-- æ–°å¢ï¼šç¼–è¾‘æ¶ˆæ¯å¼¹çª— -->
<div class="edit-message-mask" id="editMessageMask" onclick="closeEditMessagePopup()">
  <div class="edit-message-popup" onclick="event.stopPropagation()">
    <div class="edit-message-title">ç¼–è¾‘æ¶ˆæ¯</div>
    <textarea class="edit-message-input" id="editMessageInput" placeholder="è¾“å…¥æ–°æ¶ˆæ¯å†…å®¹"></textarea>
    <div class="edit-message-buttons">
      <button class="edit-message-btn cancel" onclick="closeEditMessagePopup()">å–æ¶ˆ</button>
      <button class="edit-message-btn ok" onclick="saveEditedMessage()">OK</button>
    </div>
  </div>
</div>

<!-- æ–°å¢ï¼šå¤šé€‰æ¨¡å¼å·¥å…·æ  -->
<div class="multi-select-toolbar" id="multiSelectToolbar" style="display:none;">
  <div class="count" id="selectedCount">å·²é€‰æ‹©0æ¡</div>
  <div class="actions">
    <button class="action-btn" onclick="deleteSelectedMessages()" id="deleteSelectedBtn" disabled>åˆ é™¤</button>
    <button class="action-btn" onclick="exitMultiSelectMode()">å®Œæˆ</button>
  </div>
</div>

<script>
/* ---------- é»˜è®¤èµ„æº ---------- */
const DEFAULT_WALLPAPER = 'https://img.heliar.top/file/1768536593797_IMG_3117.jpeg';
const DEFAULT_WECHAT_ICON = 'https://img.heliar.top/file/1768536596905_IMG_2757.jpeg';
const DEFAULT_NICKNAME = 'user';

/* ä¸‰ä¸ªå›¾åºŠï¼ˆä½ è¦æ±‚ä½¿ç”¨çš„ï¼‰ */
const ICON_MIC = 'https://img.heliar.top/file/1768546088581_IMG_3422.png';
const ICON_EMOJI = 'https://img.heliar.top/file/1768546261329_IMG_3423.png';
const ICON_PLUSCHAT = 'https://img.heliar.top/file/1768546259205_IMG_3424.png';

/* ---------- åŸºç¡€ä¸å¼•ç”¨ ---------- */
function updateTime(){ const n=new Date(); time.innerText = String(n.getHours()).padStart(2,'0') + ':' + String(n.getMinutes()).padStart(2,'0'); }
updateTime(); setInterval(updateTime,1000);

const screen = document.getElementById('screen');
const home = document.getElementById('home');
const wechat = document.getElementById('wechat');
const chatWindow = document.getElementById('chatWindow');
const content = document.getElementById('wechatContent');
const wechatTabs = document.getElementById('wechatTabs');
const plusMask = document.getElementById('plusMask');
const toastEl = document.getElementById('toast');
const petBox = document.getElementById('petBox');
const wechatIconEl = document.getElementById('wechatIcon');
const worldBookIconEl = document.getElementById('worldBookIcon'); // æ–°å¢ï¼šä¸–ç•Œä¹¦å›¾æ ‡
const homeSettingsIconEl = document.getElementById('homeSettingsIcon');
const wallpaperLayer = document.getElementById('wallpaperLayer'); // æ–°å¢ï¼šå£çº¸å±‚

/* ä¸–ç•Œä¹¦ç›¸å…³DOM */
const worldBookPage = document.getElementById('worldBookPage');
const worldBookList = document.getElementById('worldBookList');
const worldBookMask = document.getElementById('worldBookMask');
const worldBookPopupTitle = document.getElementById('worldBookPopupTitle');
const worldBookTitleInput = document.getElementById('worldBookTitleInput');
const worldBookContentInput = document.getElementById('worldBookContentInput');

/* è§’è‰²ä¸“å±è®¾ç½®ç›¸å…³DOM - æ–°å¢è¾“å…¥é¡¹ */
const roleSettingPage = document.getElementById('roleSettingPage');
const roleSettingTitle = document.getElementById('roleSettingTitle');
const roleAvatarPreview = document.getElementById('roleAvatarPreview');
const roleAvatarImg = document.getElementById('roleAvatarImg');
const roleNameInput = document.getElementById('roleNameInput'); // å¥½å‹å§“å
const roleRemarkInput = document.getElementById('roleRemarkInput'); // å¤‡æ³¨
const roleDescInput = document.getElementById('roleDescInput'); // ä¿¡æ¯
const roleBubbleCssInput = document.getElementById('roleBubbleCssInput'); // è§’è‰²æ°”æ³¡
const userBubbleCssInput = document.getElementById('userBubbleCssInput'); // ç”¨æˆ·æ°”æ³¡
const roleBgInput = document.getElementById('roleBgInput'); // èŠå¤©å£çº¸

/* API æ§ä»¶ */
const apiProxyInput = document.getElementById('apiProxy');
const apiKeyInput = document.getElementById('apiKey');
const apiModelSelect = document.getElementById('apiModel');
const apiTempRange = document.getElementById('apiTemp');
const apiTempVal = document.getElementById('apiTempVal');

/* èŠå¤©ç›¸å…³ DOM */
const chatTitle = document.getElementById('chatTitle');
const chatBody = document.getElementById('chatBody');
const chatInput = document.getElementById('chatInput');
const micImg = document.getElementById('micImg');
const emojiImg = document.getElementById('emojiImg');
const plusChatImg = document.getElementById('plusChatImg');

/* æ–°å¢ï¼šåŒå‡»æ¶ˆæ¯å¼¹çª—ç›¸å…³DOM */
const msgActionMask = document.getElementById('msgActionMask');
const msgActionPopup = document.getElementById('msgActionPopup');
const editMessageMask = document.getElementById('editMessageMask');
const editMessageInput = document.getElementById('editMessageInput');
const multiSelectToolbar = document.getElementById('multiSelectToolbar');
const selectedCount = document.getElementById('selectedCount');
const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');

/* æœ¬åœ°å­˜å‚¨æ•°æ®ç»“æ„ - æ–°å¢ç”¨æˆ·æ°”æ³¡é…ç½® */
let nickname = localStorage.getItem('nickname') || DEFAULT_NICKNAME;
let wxId = localStorage.getItem('wxid') || 'Bubu120vO';
let avatar = localStorage.getItem('avatar') || '';
// è§’è‰²ä¸“å±é…ç½®ï¼ˆæŒ‰chatIdå­˜å‚¨ï¼‰- æ–°å¢userBubbleCsså­—æ®µ
let roleConfigs = JSON.parse(localStorage.getItem('roleConfigs') || '{}');

let contacts = JSON.parse(localStorage.getItem('contacts') || '[]'); // {id,name,avatar,note,info}
let chats = JSON.parse(localStorage.getItem('chats') || '[]'); // {id,contactId,nameDisplay,avatar,preview,timeLabel,ts}
let messages = JSON.parse(localStorage.getItem('messages') || '{}'); // { chatId: [{from,text,ts}] }

/* æ–°å¢ï¼šä¸–ç•Œä¹¦æ•°æ® */
let worldBooks = JSON.parse(localStorage.getItem('worldBooks') || '[]'); // [{id, title, content, createdAt, updatedAt}]

/* æ–°å¢ï¼šåŒå‡»æ¶ˆæ¯åŠŸèƒ½ç›¸å…³å˜é‡ */
let currentSelectedMessage = null; // å½“å‰é€‰ä¸­çš„æ¶ˆæ¯ç´¢å¼•å’ŒèŠå¤©ID
let isMultiSelectMode = false; // æ˜¯å¦å¤„äºå¤šé€‰æ¨¡å¼
let selectedMessages = new Set(); // å¤šé€‰æ¨¡å¼ä¸‹é€‰ä¸­çš„æ¶ˆæ¯ç´¢å¼•

/* æ–°å¢ï¼šä¸–ç•Œä¹¦ç¼–è¾‘çŠ¶æ€å˜é‡ */
let currentEditingWorldBookId = null; // å½“å‰æ­£åœ¨ç¼–è¾‘çš„ä¸–ç•Œä¹¦ID

/* åŒå‡»æ£€æµ‹ç›¸å…³å˜é‡ */
let lastClickTime = 0;
let clickCount = 0;
let clickTimer = null;
const DOUBLE_CLICK_INTERVAL = 300; // åŒå‡»é—´éš”300æ¯«ç§’

/* åˆå§‹åŒ–ç”»é¢èµ„æº */
// ä¿®æ”¹ï¼šå£çº¸ä»…è®¾ç½®åˆ°wallpaperLayerå±‚
if(localStorage.getItem('wallpaper')) {
  wallpaperLayer.style.backgroundImage = `url(${localStorage.getItem('wallpaper')})`;
} else {
  wallpaperLayer.style.backgroundImage = `url(${DEFAULT_WALLPAPER})`;
}

if(localStorage.getItem('wechatIcon')) wechatIconEl.innerHTML = `<img src="${localStorage.getItem('wechatIcon')}" alt="icon">`; else wechatIconEl.innerHTML = `<img src="${DEFAULT_WECHAT_ICON}" alt="icon">`;
if(localStorage.getItem('worldBookIcon')) worldBookIconEl.innerHTML = `<img src="${localStorage.getItem('worldBookIcon')}" alt="world-book">`;
if(localStorage.getItem('homeSettingsIcon')) homeSettingsIconEl.innerHTML = `<img src="${localStorage.getItem('homeSettingsIcon')}" alt="home-settings">`;
if(localStorage.getItem('petImage')) petBox.innerHTML = `<img src="${localStorage.getItem('petImage')}" alt="pet">`;

/* åº”ç”¨èŠå¤©å·¥å…·æ å›¾æ ‡ï¼ˆä½ çš„ä¸‰å¼ å›¾åºŠï¼‰ */
function applyChatIcons(){
  if(micImg) micImg.src = ICON_MIC;
  if(emojiImg) emojiImg.src = ICON_EMOJI;
  if(plusChatImg) plusChatImg.src = ICON_PLUSCHAT;
}
applyChatIcons();

/* ---------- é¡µé¢æ˜¾ç¤ºæ§åˆ¶ ---------- */
function hideAllPages(){ 
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  chatWindow.style.display='none'; 
  roleSettingPage.style.display='none'; 
}

// æ·»åŠ åˆå§‹åŒ–æ˜¾ç¤ºä¸»å±å¹•çš„å‡½æ•°
function initDisplay() {
  hideAllPages();
  home.style.display='flex';
}

function openWeChat(){ hideAllPages(); wechat.style.display='flex'; switchTab('chat', wechatTabs.querySelector('[data-tab="chat"]')); }
function backHome(){ hideAllPages(); home.style.display='flex'; }
function openHomeSettings(){ hideAllPages(); document.getElementById('homeSettings').style.display='flex'; loadApiSettingsToUI(); }
function openSetting(){ hideAllPages(); document.getElementById('setting').style.display='flex'; document.getElementById('nickInput').value = nickname; document.getElementById('wxidInput').value = wxId; }
function backMe(){ hideAllPages(); wechat.style.display='flex'; switchTab('me', wechatTabs.querySelector('[data-tab="me"]')); }

/* æ–°å¢ï¼šæ‰“å¼€ä¸–ç•Œä¹¦App */
function openWorldBook() {
  hideAllPages();
  worldBookPage.style.display = 'flex';
  renderWorldBookList();
}

/* æ–°å¢ï¼šæ‰“å¼€ä¸–ç•Œä¹¦å¼¹çª— */
function openWorldBookPopup(bookId = null) {
  currentEditingWorldBookId = bookId;
  
  if (bookId) {
    // ç¼–è¾‘æ¨¡å¼
    const book = worldBooks.find(b => b.id === bookId);
    if (book) {
      worldBookPopupTitle.textContent = 'ç¼–è¾‘ä¸–ç•Œä¹¦';
      worldBookTitleInput.value = book.title;
      worldBookContentInput.value = book.content;
    }
  } else {
    // æ–°å»ºæ¨¡å¼
    worldBookPopupTitle.textContent = 'æ–°å»ºä¸–ç•Œä¹¦';
    worldBookTitleInput.value = '';
    worldBookContentInput.value = '';
  }
  
  worldBookMask.classList.add('show');
}

/* æ–°å¢ï¼šå…³é—­ä¸–ç•Œä¹¦å¼¹çª— */
function closeWorldBookPopup() {
  worldBookMask.classList.remove('show');
  currentEditingWorldBookId = null;
  worldBookTitleInput.value = '';
  worldBookContentInput.value = '';
}

/* æ–°å¢ï¼šä¿å­˜ä¸–ç•Œä¹¦ */
function saveWorldBook() {
  const title = worldBookTitleInput.value.trim();
  const content = worldBookContentInput.value.trim();
  
  if (!title) {
    toast('è¯·è¾“å…¥ä¸–ç•Œä¹¦å', 1500);
    return;
  }
  
  if (!content) {
    toast('è¯·è¾“å…¥å†…å®¹', 1500);
    return;
  }
  
  const now = Date.now();
  
  if (currentEditingWorldBookId) {
    // æ›´æ–°ç°æœ‰ä¸–ç•Œä¹¦
    const index = worldBooks.findIndex(b => b.id === currentEditingWorldBookId);
    if (index !== -1) {
      worldBooks[index].title = title;
      worldBooks[index].content = content;
      worldBooks[index].updatedAt = now;
    }
  } else {
    // æ–°å»ºä¸–ç•Œä¹¦
    const newBook = {
      id: 'wb_' + now + '_' + Math.random().toString(36).substr(2, 9),
      title: title,
      content: content,
      createdAt: now,
      updatedAt: now
    };
    worldBooks.unshift(newBook); // æ·»åŠ åˆ°å¼€å¤´
  }
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  localStorage.setItem('worldBooks', JSON.stringify(worldBooks));
  
  // å…³é—­å¼¹çª—
  closeWorldBookPopup();
  
  // é‡æ–°æ¸²æŸ“åˆ—è¡¨
  renderWorldBookList();
  
  // æ˜¾ç¤ºæˆåŠŸæç¤º
  toast(currentEditingWorldBookId ? 'ä¸–ç•Œä¹¦å·²æ›´æ–°' : 'ä¸–ç•Œä¹¦å·²åˆ›å»º', 1500, true);
}

/* æ–°å¢ï¼šæ¸²æŸ“ä¸–ç•Œä¹¦åˆ—è¡¨ */
function renderWorldBookList() {
  if (!worldBooks || worldBooks.length === 0) {
    worldBookList.innerHTML = `
      <div class="world-book-empty">
        <div class="world-book-empty-icon">ğŸ“–</div>
        <div class="world-book-empty-text">æš‚æ— ä¸–ç•Œä¹¦è®°å½•</div>
        <div class="world-book-empty-text">ç‚¹å‡»å³ä¸Šè§’â•æŒ‰é’®åˆ›å»º</div>
      </div>
    `;
    return;
  }
  
  // æŒ‰æ›´æ–°æ—¶é—´å€’åºæ’åº
  const sortedBooks = [...worldBooks].sort((a, b) => b.updatedAt - a.updatedAt);
  
  const listHTML = sortedBooks.map(book => {
    const date = new Date(book.updatedAt);
    const timeStr = date.toLocaleDateString('zh-CN', { 
      year: 'numeric', 
      month: '2-digit', 
      day: '2-digit' 
    }) + ' ' + date.toLocaleTimeString('zh-CN', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    // å†…å®¹é¢„è§ˆï¼ˆå‰100ä¸ªå­—ç¬¦ï¼‰
    const preview = book.content.length > 100 
      ? book.content.substring(0, 100) + '...' 
      : book.content;
    
    return `
      <div class="world-book-item" onclick="editWorldBook('${book.id}')">
        <div class="world-book-item-title">${escapeHtml(book.title)}</div>
        <div class="world-book-item-preview">${escapeHtml(preview)}</div>
        <div class="world-book-item-time">${timeStr}</div>
      </div>
    `;
  }).join('');
  
  worldBookList.innerHTML = listHTML;
}

/* æ–°å¢ï¼šç¼–è¾‘ä¸–ç•Œä¹¦ */
function editWorldBook(bookId) {
  openWorldBookPopup(bookId);
}

/* è§’è‰²ä¸“å±è®¾ç½®é¡µé¢æ§åˆ¶ - ä¿®å¤é¡µé¢è·³è½¬é€»è¾‘ */
function openRoleSetting(){
  const currentChatId = chatWindow.dataset.openChatId;
  if(!currentChatId) return;
  
  // è·å–å½“å‰è§’è‰²é…ç½®å’Œè”ç³»äººä¿¡æ¯
  const config = roleConfigs[currentChatId] || {};
  const chat = chats.find(c=>c.id===currentChatId);
  const contact = contacts.find(con=>con.id === chat?.contactId);
  
  // å¡«å……è®¾ç½®é¡µé¢å†…å®¹
  roleSettingTitle.innerText = "è§’è‰²è®¾ç½®";
  roleNameInput.value = config.name || contact?.name || chat?.nameDisplay || '';
  roleRemarkInput.value = config.remark || contact?.note || '';
  roleDescInput.value = config.desc || contact?.info || '';
  roleBubbleCssInput.value = config.bubbleCss || '';
  userBubbleCssInput.value = config.userBubbleCss || '';
  
  // å¤´åƒé¢„è§ˆ
  if(config.avatar) {
    roleAvatarImg.src = config.avatar;
    roleAvatarPreview.style.display = 'block';
  } else if(chat?.avatar || contact?.avatar) {
    roleAvatarImg.src = chat?.avatar || contact?.avatar;
    roleAvatarPreview.style.display = 'block';
  } else {
    roleAvatarImg.src = '';
    roleAvatarPreview.style.display = 'none';
  }
  
  // æ˜¾ç¤ºè§’è‰²è®¾ç½®é¡µï¼ˆç¡®ä¿æ‰‹æœºå¤–å£³åœ¨èƒŒæ™¯ï¼‰
  hideAllPages();
  roleSettingPage.style.display = 'flex';
}

function backToChat(){
  const currentChatId = chatWindow.dataset.openChatId;
  if(!currentChatId) return;
  
  // å›åˆ°èŠå¤©çª—å£ï¼ˆç¡®ä¿æ‰‹æœºå¤–å£³æ˜¾ç¤ºï¼‰
  hideAllPages();
  chatWindow.style.display = 'flex';
  renderMessages(currentChatId);
}

/* plus popup */
function openPlus(){ plusMask.classList.add('show'); }
function closePlus(){ plusMask.classList.remove('show'); }

/* startGroup left as-is */
function startGroup(){ closePlus(); toast('å‘èµ·ç¾¤èŠï¼ˆç¤ºä¾‹ï¼‰'); }

/* æ·»åŠ å¥½å‹åŠŸèƒ½ï¼ˆä¿æŒå·²æœ‰å®ç°ï¼‰ */
function addFriend(){
  closePlus();

  const modal = document.createElement('div');
  modal.style.cssText = `
    position:fixed;inset:0;
    background:rgba(0,0,0,.25);
    display:flex;align-items:center;justify-content:center;
    z-index:999;
  `;

  modal.innerHTML = `
    <div style="width:300px;background:#fff;border-radius:16px;padding:16px;position:relative">
      <!-- å³ä¸Šè§’å…³é—­æŒ‰é’®ï¼ˆåœ†å½¢ï¼Œå†…ä¸ºé»‘è‰²å‰ï¼‰ -->
      <button id="afCloseBtn" title="å…³é—­" style="
        position:absolute; right:10px; top:10px;
        width:28px; height:28px; border-radius:14px;
        display:flex; align-items:center; justify-content:center;
        background:#fff; border:none; cursor:pointer;
        box-shadow:0 1px 3px rgba(0,0,0,0.12);
        color:#000; font-size:18px;
      ">&times;</button>

      <div style="text-align:center;font-size:16px;font-weight:600;margin-bottom:10px">
        æ·»åŠ å¥½å‹
      </div>

      <div style="text-align:center;margin-bottom:10px">
        <label style="
          display:inline-flex;
          width:80px;height:80px;
          border:2px dashed #f2b6c6;
          border-radius:12px;
          align-items:center;justify-content:center;
          cursor:pointer;
          font-size:22px;color:#f2b6c6;
        ">
          +
          <input type="file" hidden id="afAvatar">
        </label>
      </div>

      <input id="afName" placeholder="å¥½å‹å§“å"
        style="width:70%;display:block;margin:8px auto;
        padding:6px;border-radius:10px;border:1px solid #f2b6c6">

      <input id="afNote" placeholder="å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰"
        style="width:70%;display:block;margin:8px auto;
        padding:6px;border-radius:10px;border:1px solid #f2b6c6">

      <textarea id="afInfo" placeholder="ä¿¡æ¯"
        style="width:90%;display:block;margin:8px auto;
        padding:6px;border-radius:10px;border:1px solid #f2b6c6;height:60px"></textarea>

      <button id="afOk"
        style="margin:12px auto 0;display:block;
        padding:8px 24px;border-radius:10px;
        background:#f6c1d0;border:none;color:#000">
        OK
      </button>
    </div>
  `;

  document.body.appendChild(modal);

  // å…³é—­æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰äº‹ä»¶
  const closeBtn = modal.querySelector('#afCloseBtn');
  closeBtn.addEventListener('click', (ev)=>{
    ev.stopPropagation();
    modal.remove();
  });

  let avatarData = '';

  modal.querySelector('#afAvatar').onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = ev => avatarData = ev.target.result;
    r.readAsDataURL(file);
  };

  modal.querySelector('#afOk').onclick = ()=>{
    const name = modal.querySelector('#afName').value.trim();
    const note = modal.querySelector('#afNote').value.trim();
    const info = modal.querySelector('#afInfo').value.trim();

    if(!name){
      alert('è¯·è¾“å…¥å¥½å‹å§“å');
      return;
    }

    const contactId = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2);

    const contact = {
      id: contactId,
      name,
      note,
      info,
      avatar: avatarData
    };

    contacts.push(contact);
    localStorage.setItem('contacts', JSON.stringify(contacts));

    /* insert as chat and save messages */
    insertNewChat(contact);

    modal.remove();
  };
}

/* toast - æ·¡ç²‰è‰²ä¿å­˜æˆåŠŸå¼¹çª—ï¼ˆç«‹å³è§¦å‘ï¼‰ */
function toast(msg, ms=1400, isSuccess=false){
  toastEl.innerText = msg;
  if(isSuccess){
    toastEl.style.background = '#ffe6ef';
    toastEl.style.color = '#333';
    toastEl.style.boxShadow = '0 2px 8px rgba(242,182,198,0.3)';
    toastEl.style.borderRadius = '12px';
    toastEl.style.padding = '10px 20px';
  } else {
    toastEl.style.background = 'rgba(0,0,0,0.75)';
    toastEl.style.color = '#fff';
    toastEl.style.boxShadow = 'none';
  }
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), ms);
}

/* ---------- æ¸²æŸ“èŠå¤©åˆ—è¡¨ - ä»…æ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè§’è‰²ä¿¡æ¯ä¸æ˜¾ç¤ºåœ¨åˆ—è¡¨ ---------- */
function renderChatList(){
  // ensure chats sorted by ts desc
  chats.sort((a,b)=> (b.ts||0) - (a.ts||0));
  if(!chats || chats.length===0){
    content.innerHTML = `<div style="padding:18px;color:#888;text-align:center">ç›®å‰æ— èŠå¤©</div>`;
    return;
  }
  const wrapper = document.createElement('div');
  wrapper.className = 'list-card';
  chats.forEach(c=>{
    const el = document.createElement('div');
    el.className = 'chat-item';
    el.dataset.chatId = c.id;

    const avatarDiv = document.createElement('div'); avatarDiv.className = 'chat-avatar';
    // ä¼˜å…ˆä½¿ç”¨è§’è‰²é…ç½®çš„å¤´åƒ
    const config = roleConfigs[c.id] || {};
    const contact = contacts.find(con=>con.id === c.contactId);
    if(config.avatar) { 
      const img = document.createElement('img'); 
      img.src = config.avatar; 
      avatarDiv.appendChild(img); 
    } else if(c.avatar || contact?.avatar) {
      const img = document.createElement('img'); 
      img.src = c.avatar || contact?.avatar; 
      avatarDiv.appendChild(img); 
    } else {
      // æ˜¾ç¤ºä¼˜å…ˆçº§ï¼šå¤‡æ³¨>å§“å>é»˜è®¤
      const displayName = config.remark || config.name || c.nameDisplay || contact?.name || 'U';
      avatarDiv.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#666">${displayName.charAt(0)}</div>`;
    }

    const main = document.createElement('div'); main.className = 'chat-main';
    const nameDiv = document.createElement('div'); nameDiv.className = 'chat-name'; 
    // å¤‡æ³¨ä¼˜å…ˆæ˜¾ç¤ºé€»è¾‘
    nameDiv.innerText = config.remark || config.name || c.nameDisplay || contact?.name || 'æ— å';
    const previewDiv = document.createElement('div'); previewDiv.className = 'chat-preview'; 
    // ä»…æ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹ï¼ˆä¸å†æ˜¾ç¤ºè§’è‰²ä¿¡æ¯ï¼‰- ç¡®ä¿å•è¡Œæ˜¾ç¤º
    previewDiv.innerText = c.preview || 'æš‚æ— æ¶ˆæ¯';
    main.appendChild(nameDiv); main.appendChild(previewDiv);

    const timeDiv = document.createElement('div'); timeDiv.className = 'chat-time'; 
    // ç›´æ¥æ˜¾ç¤ºchatsä¸­å­˜å‚¨çš„timeLabelï¼ˆå·²å’Œæ¶ˆæ¯æ—¶é—´æ ¼å¼ä¸€è‡´ï¼‰
    timeDiv.innerText = c.timeLabel || '';

    el.appendChild(avatarDiv); el.appendChild(main); el.appendChild(timeDiv);

    // ç‚¹å‡»æ¡ç›®æ‰“å¼€èŠå¤©çª—å£ï¼ˆè¦æ±‚ï¼‰
    el.addEventListener('click', ()=> openChat(c.id) );

    wrapper.appendChild(el);
  });
  content.innerHTML = '';
  content.appendChild(wrapper);
}

/* ---------- æ‰“å¼€èŠå¤©çª—å£ - å¤‡æ³¨ä¼˜å…ˆæ˜¾ç¤ºæ ‡é¢˜ ---------- */
function openChat(chatId){
  const chat = chats.find(x=>x.id===chatId);
  if(!chat){ toast('èŠå¤©æœªæ‰¾åˆ°'); return; }
  hideAllPages();
  chatWindow.style.display = 'flex';
  chatWindow.dataset.openChatId = chatId;
  
  // è·å–å½“å‰è§’è‰²é…ç½®å’Œè”ç³»äººä¿¡æ¯
  const config = roleConfigs[chatId] || {};
  const contact = contacts.find(con=>con.id === chat.contactId);
  
  // å¤‡æ³¨ä¼˜å…ˆæ˜¾ç¤ºèŠå¤©æ ‡é¢˜
  const displayTitle = config.remark || config.name || chat.nameDisplay || contact?.name || 'å¯¹è¯';
  chatTitle.innerText = displayTitle;
  chatTitle.classList.remove('typing-indicator'); // ç¡®ä¿ç§»é™¤è¾“å…¥ä¸­æ ·å¼
  
  // åº”ç”¨è§’è‰²èŠå¤©èƒŒæ™¯
  if(config.chatBg) {
    chatBody.style.backgroundImage = `url(${config.chatBg})`;
    chatBody.style.backgroundSize = 'cover';
    chatBody.style.backgroundPosition = 'center';
  } else {
    chatBody.style.backgroundImage = 'none';
    chatBody.style.background = '#f5f5f5';
  }
  
  renderMessages(chatId);
  // scroll bottom
  setTimeout(()=> chatBody.scrollTop = chatBody.scrollHeight, 50);
}

/* å…³é—­èŠå¤©çª—å£ */
function closeChat(){
  chatWindow.style.display = 'none';
  hideAllPages();
  wechat.style.display = 'flex';
  switchTab('chat', wechatTabs.querySelector('[data-tab="chat"]'));
}

/* æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ - æ–°å¢å±…ä¸­æ—¶é—´æˆ³é€»è¾‘ */
function renderMessages(chatId) {
  chatBody.innerHTML = '';
  const list = messages[chatId] || [];
  const config = roleConfigs[chatId] || {};
  const chat = chats.find(c => c.id === chatId);
  const contact = contacts.find(con => con.id === chat?.contactId);
  const friendAvatar = config.avatar || chat?.avatar || contact?.avatar || '';

  // ç”¨äºåˆ¤æ–­ä¸¤æ¡æ¶ˆæ¯çš„æ—¶é—´é—´éš”
  let lastTime = 0;
  // æ ¼å¼åŒ–æ—¶é—´ï¼šåˆ†ä¸¤ç§æ ¼å¼ï¼ˆå½“å¤©æ˜¾ç¤º æ—¶:åˆ†ï¼Œéå½“å¤©æ˜¾ç¤º æœˆ-æ—¥ï¼‰
  const formatMsgTime = (ts) => {
    const now = new Date();
    const msgDate = new Date(ts);
    const isToday = now.toDateString() === msgDate.toDateString();
    return isToday 
      ? msgDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      : msgDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
  };

  list.forEach((m, index) => {
    const currTime = m.ts;
    // æ—¶é—´é—´éš”è¶…è¿‡5åˆ†é’Ÿï¼Œæ’å…¥å±…ä¸­æ—¶é—´æˆ³
    if (index === 0 || currTime - lastTime > 5 * 60 * 1000) {
      const timeEl = document.createElement('div');
      timeEl.className = 'msg-time';
      timeEl.innerHTML = `<span>${formatMsgTime(currTime)}</span>`;
      chatBody.appendChild(timeEl);
    }
    lastTime = currTime;

    // æ¸²æŸ“æ¶ˆæ¯æ°”æ³¡ï¼ˆåŸæœ‰é€»è¾‘ä¸å˜ï¼‰
    const row = document.createElement('div');
    row.className = 'msg-row ' + (m.from === 'me' ? 'msg-right' : 'msg-left');
    
    const avatarEl = document.createElement('div');
    avatarEl.className = 'msg-avatar';
    if (m.from === 'me') {
      avatarEl.innerHTML = avatar ? `<img src="${avatar}" alt="æˆ‘çš„å¤´åƒ">` : `<div style="width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#666">${nickname.charAt(0)}</div>`;
    } else {
      avatarEl.innerHTML = friendAvatar ? `<img src="${friendAvatar}" alt="å¥½å‹å¤´åƒ">` : `<div style="width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#666">${(config.remark || config.name || chat?.nameDisplay || contact?.name || 'U').charAt(0)}</div>`;
    }
    
    const bubble = document.createElement('div');
    bubble.className = 'msg-bubble';
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºè¾“å…¥ä¸­çŠ¶æ€ï¼ˆåŠ¨æ€åœ†ç‚¹åŠ¨ç”»ï¼‰
    if (m.text === 'TYPING_INDICATOR') {
      const typingDots = document.createElement('div');
      typingDots.className = 'typing-dots';
      typingDots.innerHTML = '<span></span><span></span><span></span>';
      bubble.appendChild(typingDots);
    } else {
      bubble.innerText = m.text;
    }
    
    bubble.style.cssText = m.from === 'me'
      ? (config.userBubbleCss || 'background:#cfe8ff;border-radius:12px;')
      : (config.bubbleCss || 'background:#fff;border:1px solid #eee;border-top-left-radius:6px;');
    
    // å¦‚æœæ¶ˆæ¯å·²æ’¤å›ï¼Œåº”ç”¨ç‰¹æ®Šæ ·å¼
    if (m.recalled) {
      bubble.classList.add('recalled');
      bubble.innerText = 'å·²æ’¤å›';
    }
    
    // ä¸ºæ°”æ³¡æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬
    bubble.dataset.msgIndex = index;
    setupMessageDoubleClick(bubble, chatId, index, m);
    
    if (m.from === 'me') {
      row.appendChild(bubble);
      row.appendChild(avatarEl);
    } else {
      row.appendChild(avatarEl);
      row.appendChild(bubble);
    }
    
    chatBody.appendChild(row);
  });
  
  // å¦‚æœå¤„äºå¤šé€‰æ¨¡å¼ï¼Œé‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
  if (isMultiSelectMode) {
    setupMultiSelectModeEvents(chatId);
  }
}

/* æ–°å¢ï¼šä¸ºæ¶ˆæ¯æ°”æ³¡è®¾ç½®åŒå‡»äº‹ä»¶ */
function setupMessageDoubleClick(bubble, chatId, msgIndex, msgData) {
  // æ¸…é™¤ä¹‹å‰çš„é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
  bubble.onmousedown = null;
  bubble.onmouseup = null;
  bubble.onmouseleave = null;
  bubble.ontouchstart = null;
  bubble.ontouchend = null;
  bubble.ontouchmove = null;
  
  // æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆæ¡Œé¢ç«¯ï¼‰
  bubble.addEventListener('dblclick', function(e) {
    // å¦‚æœå¤„äºå¤šé€‰æ¨¡å¼ï¼Œä¸è§¦å‘åŒå‡»
    if (isMultiSelectMode) return;
    
    e.stopPropagation();
    showMsgActionPopup(e, chatId, msgIndex, msgData);
    
    // æ·»åŠ åŒå‡»åé¦ˆåŠ¨ç”»
    bubble.classList.add('double-click-feedback');
    setTimeout(() => {
      bubble.classList.remove('double-click-feedback');
    }, 300);
  });
  
  // æ·»åŠ è§¦æ‘¸åŒå‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆç§»åŠ¨ç«¯ï¼‰
  bubble.addEventListener('touchstart', function(e) {
    // å¦‚æœå¤„äºå¤šé€‰æ¨¡å¼ï¼Œä¸è§¦å‘åŒå‡»
    if (isMultiSelectMode) return;
    
    const currentTime = new Date().getTime();
    const timeSinceLastClick = currentTime - lastClickTime;
    
    // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
    if (clickTimer) {
      clearTimeout(clickTimer);
    }
    
    // å¦‚æœä¸¤æ¬¡ç‚¹å‡»æ—¶é—´é—´éš”å¾ˆçŸ­ï¼Œè®¤ä¸ºæ˜¯åŒå‡»
    if (timeSinceLastClick > 0 && timeSinceLastClick < DOUBLE_CLICK_INTERVAL) {
      e.preventDefault();
      e.stopPropagation();
      showMsgActionPopup(e.touches[0], chatId, msgIndex, msgData);
      
      // æ·»åŠ åŒå‡»åé¦ˆåŠ¨ç”»
      bubble.classList.add('double-click-feedback');
      setTimeout(() => {
        bubble.classList.remove('double-click-feedback');
      }, 300);
      
      // é‡ç½®ç‚¹å‡»è®¡æ•°
      clickCount = 0;
      lastClickTime = 0;
    } else {
      // ç¬¬ä¸€æ¬¡ç‚¹å‡»ï¼Œè®¾ç½®è®¡æ—¶å™¨
      clickCount = 1;
      lastClickTime = currentTime;
      
      clickTimer = setTimeout(() => {
        // å¦‚æœè¶…æ—¶ï¼Œé‡ç½®è®¡æ•°
        clickCount = 0;
        lastClickTime = 0;
      }, DOUBLE_CLICK_INTERVAL);
    }
  });
  
  // é˜²æ­¢è§¦æ‘¸æ»šåŠ¨æ—¶è§¦å‘åŒå‡»
  bubble.addEventListener('touchmove', function() {
    // å¦‚æœæœ‰è®¡æ—¶å™¨ï¼Œæ¸…é™¤å®ƒ
    if (clickTimer) {
      clearTimeout(clickTimer);
      clickCount = 0;
      lastClickTime = 0;
    }
  });
}

/* æ–°å¢ï¼šæ˜¾ç¤ºæ¶ˆæ¯æ“ä½œå¼¹çª— */
function showMsgActionPopup(e, chatId, msgIndex, msgData) {
  // ä¿å­˜å½“å‰é€‰ä¸­çš„æ¶ˆæ¯ä¿¡æ¯
  currentSelectedMessage = {
    chatId: chatId,
    msgIndex: msgIndex,
    msgData: msgData
  };
  
  // è®¡ç®—å¼¹çª—ä½ç½®ï¼ˆå°½é‡æ˜¾ç¤ºåœ¨æ¶ˆæ¯æ°”æ³¡é™„è¿‘ï¼‰
  const bubbleRect = e.target.getBoundingClientRect();
  const popupWidth = 140;
  const popupHeight = 176; // 4ä¸ªé€‰é¡¹ * 44pxæ¯ä¸ª
  
  // è®¡ç®—å¼¹çª—ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•
  let left = bubbleRect.left + (bubbleRect.width / 2) - (popupWidth / 2);
  let top = bubbleRect.top - popupHeight - 10; // æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸Šæ–¹
  
  // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸å¤Ÿï¼Œæ˜¾ç¤ºåœ¨ä¸‹æ–¹
  if (top < 50) {
    top = bubbleRect.bottom + 10;
  }
  
  // é™åˆ¶å·¦å³ä¸è¶…å‡ºå±å¹•
  left = Math.max(10, Math.min(left, window.innerWidth - popupWidth - 10));
  
  // è®¾ç½®å¼¹çª—ä½ç½®å¹¶æ˜¾ç¤º
  msgActionPopup.style.left = left + 'px';
  msgActionPopup.style.top = top + 'px';
  msgActionMask.classList.add('show');
  
  // éšè—æ’¤å›é€‰é¡¹å¦‚æœæ¶ˆæ¯ä¸æ˜¯è‡ªå·±çš„æˆ–è€…è¶…è¿‡2åˆ†é’Ÿ
  const recallOption = msgActionPopup.querySelector('.msg-action-item:nth-child(3)');
  const isMyMessage = msgData.from === 'me';
  const isWithin2Minutes = Date.now() - msgData.ts <= 2 * 60 * 1000;
  
  if (!isMyMessage || !isWithin2Minutes) {
    recallOption.style.display = 'none';
  } else {
    recallOption.style.display = 'block';
  }
}

/* æ–°å¢ï¼šå…³é—­æ¶ˆæ¯æ“ä½œå¼¹çª— */
function closeMsgActionPopup() {
  msgActionMask.classList.remove('show');
}

/* æ–°å¢ï¼šåˆ é™¤æ¶ˆæ¯ - ä¿®æ”¹ï¼šåˆ é™¤åæ›´æ–°èŠå¤©é¢„è§ˆ */
function deleteMessage() {
  if (!currentSelectedMessage) return;
  
  const { chatId, msgIndex } = currentSelectedMessage;
  
  // ä»æ¶ˆæ¯æ•°ç»„ä¸­åˆ é™¤
  if (messages[chatId] && messages[chatId][msgIndex]) {
    messages[chatId].splice(msgIndex, 1);
    localStorage.setItem('messages', JSON.stringify(messages));
    
    // æ›´æ–°èŠå¤©é¢„è§ˆ
    updateChatPreview(chatId);
    
    // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
    renderMessages(chatId);
    toast('æ¶ˆæ¯å·²åˆ é™¤', 1500, true);
  }
  
  closeMsgActionPopup();
}

/* æ–°å¢ï¼šç¼–è¾‘æ¶ˆæ¯ */
function editMessage() {
  if (!currentSelectedMessage) return;
  
  const { msgData } = currentSelectedMessage;
  
  // å¡«å……ç¼–è¾‘æ¡†
  editMessageInput.value = msgData.text || '';
  
  // æ˜¾ç¤ºç¼–è¾‘å¼¹çª—
  editMessageMask.classList.add('show');
  closeMsgActionPopup();
}

/* æ–°å¢ï¼šå…³é—­ç¼–è¾‘æ¶ˆæ¯å¼¹çª— */
function closeEditMessagePopup() {
  editMessageMask.classList.remove('show');
  editMessageInput.value = '';
}

/* æ–°å¢ï¼šä¿å­˜ç¼–è¾‘åçš„æ¶ˆæ¯ */
function saveEditedMessage() {
  if (!currentSelectedMessage) return;
  
  const { chatId, msgIndex } = currentSelectedMessage;
  const newText = editMessageInput.value.trim();
  
  if (!newText) {
    toast('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 1500);
    return;
  }
  
  // æ›´æ–°æ¶ˆæ¯å†…å®¹
  if (messages[chatId] && messages[chatId][msgIndex]) {
    messages[chatId][msgIndex].text = newText;
    localStorage.setItem('messages', JSON.stringify(messages));
    
    // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
    renderMessages(chatId);
    toast('æ¶ˆæ¯å·²ä¿®æ”¹', 1500, true);
  }
  
  closeEditMessagePopup();
}

/* æ–°å¢ï¼šæ’¤å›æ¶ˆæ¯ */
function recallMessage() {
  if (!currentSelectedMessage) return;
  
  const { chatId, msgIndex, msgData } = currentSelectedMessage;
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯ä¸”åœ¨2åˆ†é’Ÿå†…
  const isMyMessage = msgData.from === 'me';
  const isWithin2Minutes = Date.now() - msgData.ts <= 2 * 60 * 1000;
  
  if (!isMyMessage) {
    toast('åªèƒ½æ’¤å›è‡ªå·±å‘é€çš„æ¶ˆæ¯', 1500);
    closeMsgActionPopup();
    return;
  }
  
  if (!isWithin2Minutes) {
    toast('åªèƒ½æ’¤å›2åˆ†é’Ÿå†…å‘é€çš„æ¶ˆæ¯', 1500);
    closeMsgActionPopup();
    return;
  }
  
  // æ ‡è®°æ¶ˆæ¯ä¸ºå·²æ’¤å›
  if (messages[chatId] && messages[chatId][msgIndex]) {
    messages[chatId][msgIndex].recalled = true;
    messages[chatId][msgIndex].text = 'å·²æ’¤å›';
    localStorage.setItem('messages', JSON.stringify(messages));
    
    // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
    renderMessages(chatId);
    toast('æ¶ˆæ¯å·²æ’¤å›', 1500, true);
  }
  
  closeMsgActionPopup();
}

/* æ–°å¢ï¼šè¿›å…¥å¤šé€‰æ¨¡å¼ */
function enterMultiSelectMode() {
  isMultiSelectMode = true;
  selectedMessages.clear();
  updateSelectedCount();
  
  // æ˜¾ç¤ºå¤šé€‰å·¥å…·æ 
  multiSelectToolbar.style.display = 'flex';
  
  // æ·»åŠ å¤šé€‰æ¨¡å¼ç±»å
  chatBody.classList.add('multi-select-mode');
  
  // ä¸ºæ‰€æœ‰æ¶ˆæ¯æ°”æ³¡æ·»åŠ ç‚¹å‡»äº‹ä»¶
  const chatId = currentSelectedMessage.chatId;
  setupMultiSelectModeEvents(chatId);
  
  closeMsgActionPopup();
}

/* æ–°å¢ï¼šè®¾ç½®å¤šé€‰æ¨¡å¼äº‹ä»¶ */
function setupMultiSelectModeEvents(chatId) {
  const bubbles = chatBody.querySelectorAll('.msg-bubble');
  
  bubbles.forEach((bubble, index) => {
    // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
    bubble.onclick = null;
    bubble.ondblclick = null;
    bubble.ontouchstart = null;
    
    bubble.onclick = function(e) {
      if (!isMultiSelectMode) return;
      
      e.stopPropagation();
      
      if (selectedMessages.has(index)) {
        selectedMessages.delete(index);
        bubble.classList.remove('selected');
      } else {
        selectedMessages.add(index);
        bubble.classList.add('selected');
      }
      
      updateSelectedCount();
    };
  });
}

/* æ–°å¢ï¼šæ›´æ–°å·²é€‰æ‹©æ¶ˆæ¯è®¡æ•° */
function updateSelectedCount() {
  const count = selectedMessages.size;
  selectedCount.textContent = `å·²é€‰æ‹©${count}æ¡`;
  
  // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
  deleteSelectedBtn.disabled = count === 0;
}

/* æ–°å¢ï¼šåˆ é™¤é€‰ä¸­çš„å¤šæ¡æ¶ˆæ¯ - ä¿®æ”¹ï¼šåˆ é™¤åæ›´æ–°èŠå¤©é¢„è§ˆ */
function deleteSelectedMessages() {
  if (selectedMessages.size === 0) return;
  
  const chatId = currentSelectedMessage.chatId;
  
  // å°†é€‰ä¸­çš„ç´¢å¼•è½¬ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆä»å¤§åˆ°å°åˆ é™¤ï¼Œé¿å…ç´¢å¼•é”™ä¹±ï¼‰
  const indicesToDelete = Array.from(selectedMessages).sort((a, b) => b - a);
  
  // åˆ é™¤é€‰ä¸­çš„æ¶ˆæ¯
  indicesToDelete.forEach(index => {
    if (messages[chatId] && messages[chatId][index]) {
      messages[chatId].splice(index, 1);
    }
  });
  
  // ä¿å­˜æ›´æ–°
  localStorage.setItem('messages', JSON.stringify(messages));
  
  // æ›´æ–°èŠå¤©é¢„è§ˆ
  updateChatPreview(chatId);
  
  // é€€å‡ºå¤šé€‰æ¨¡å¼
  exitMultiSelectMode();
  
  // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
  renderMessages(chatId);
  
  toast(`å·²åˆ é™¤${indicesToDelete.length}æ¡æ¶ˆæ¯`, 1500, true);
}

/* æ–°å¢ï¼šæ›´æ–°èŠå¤©é¢„è§ˆçš„å‡½æ•° - æ–°å¢å‡½æ•° */
function updateChatPreview(chatId) {
  const chatIdx = chats.findIndex(c => c.id === chatId);
  if (chatIdx === -1) return;
  
  const chatMessages = messages[chatId] || [];
  
  // è·å–æœ€æ–°ä¸€æ¡éè¾“å…¥ä¸­çš„æ¶ˆæ¯
  const lastMsg = chatMessages.filter(msg => msg.text !== 'TYPING_INDICATOR').pop();
  
  if (lastMsg) {
    // å¦‚æœæœ‰æ¶ˆæ¯ï¼Œæ›´æ–°é¢„è§ˆå’Œæ—¶é—´
    chats[chatIdx].preview = lastMsg.text;
    
    const msgDate = new Date(lastMsg.ts);
    const now = new Date();
    const isToday = now.toDateString() === msgDate.toDateString();
    chats[chatIdx].timeLabel = isToday
      ? msgDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      : msgDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
    
    chats[chatIdx].ts = lastMsg.ts;
  } else {
    // å¦‚æœæ²¡æœ‰æ¶ˆæ¯äº†ï¼Œæ˜¾ç¤º"æš‚æ— æ¶ˆæ¯"
    chats[chatIdx].preview = 'æš‚æ— æ¶ˆæ¯';
    chats[chatIdx].timeLabel = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    chats[chatIdx].ts = Date.now();
  }
  
  // ä¿å­˜æ›´æ–°
  localStorage.setItem('chats', JSON.stringify(chats));
  
  // é‡æ–°æ¸²æŸ“èŠå¤©åˆ—è¡¨
  renderChatList();
}

/* æ–°å¢ï¼šé€€å‡ºå¤šé€‰æ¨¡å¼ */
function exitMultiSelectMode() {
  isMultiSelectMode = false;
  selectedMessages.clear();
  
  // éšè—å¤šé€‰å·¥å…·æ 
  multiSelectToolbar.style.display = 'none';
  
  // ç§»é™¤å¤šé€‰æ¨¡å¼ç±»å
  chatBody.classList.remove('multi-select-mode');
  
  // ç§»é™¤æ‰€æœ‰æ¶ˆæ¯çš„é€‰ä¸­æ ·å¼
  const bubbles = chatBody.querySelectorAll('.msg-bubble');
  bubbles.forEach(bubble => {
    bubble.classList.remove('selected');
  });
  
  // é‡æ–°ç»‘å®šåŒå‡»äº‹ä»¶
  const chatId = chatWindow.dataset.openChatId;
  if (chatId) {
    renderMessages(chatId);
  }
}

/* å‘é€æ¶ˆæ¯å¹¶ä¿å­˜ï¼ˆæœ¬åœ°ï¼‰- æ–°å¢é¢„è§ˆåŒæ­¥+æ—¶é—´æ›´æ–°é€»è¾‘ */
function sendChatMessage(){
  const text = chatInput.value.trim();
  if(!text) return;
  const chatId = chatWindow.dataset.openChatId;
  if(!chatId) return;
  messages[chatId] = messages[chatId] || [];
  const msg = { from:'me', text, ts: Date.now() };
  messages[chatId].push(msg);
  localStorage.setItem('messages', JSON.stringify(messages));

  // æ›´æ–°èŠå¤© preview/time & move to top
  const idx = chats.findIndex(c=>c.id===chatId);
  if(idx !== -1){
    // 1. åŒæ­¥æ¶ˆæ¯åˆ°èŠå¤©é¢„è§ˆ
    chats[idx].preview = text;
    // 2. ç”Ÿæˆæœ€åä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´ï¼ˆå’Œæ—¶é—´æˆ³æ ¼å¼ä¸€è‡´ï¼‰
    const msgDate = new Date(msg.ts);
    const now = new Date();
    const isToday = now.toDateString() === msgDate.toDateString();
    chats[idx].timeLabel = isToday 
      ? msgDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
      : msgDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
    // 3. æ›´æ–°æ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºï¼‰
    chats[idx].ts = Date.now();
    // 4. ç§»åˆ°èŠå¤©åˆ—è¡¨é¡¶éƒ¨
    const chatObj = chats.splice(idx,1)[0];
    chats.unshift(chatObj);
    localStorage.setItem('chats', JSON.stringify(chats));
  }

  // æ¸²æŸ“æ–°æ¶ˆæ¯ - åº”ç”¨ç”¨æˆ·æ°”æ³¡æ ·å¼
  const config = roleConfigs[chatId] || {};
  const row = document.createElement('div'); 
  row.className = 'msg-row msg-right fade-in';
  
  // æˆ‘çš„æ°”æ³¡
  const bubble = document.createElement('div'); 
  bubble.className = 'msg-bubble'; 
  bubble.innerText = text;
  bubble.style.cssText = config.userBubbleCss 
    ? config.userBubbleCss 
    : 'background:#cfe8ff;border-radius:12px;';
  
  // ä¸ºæ°”æ³¡æ·»åŠ åŒå‡»äº‹ä»¶ç›‘å¬
  bubble.dataset.msgIndex = messages[chatId].length - 1;
  setupMessageDoubleClick(bubble, chatId, messages[chatId].length - 1, msg);
  
  // æˆ‘çš„å¤´åƒ
  const avatarEl = document.createElement('div');
  avatarEl.className = 'msg-avatar';
  avatarEl.innerHTML = avatar ? `<img src="${avatar}" alt="æˆ‘çš„å¤´åƒ">` : `<div style="width:100%;height:100%;background:#eee;display:flex;align-items:center;justify-content:center;color:#666">${nickname.charAt(0)}</div>`;
  
  row.appendChild(bubble);
  row.appendChild(avatarEl);
  chatBody.appendChild(row);
  
  chatBody.scrollTop = chatBody.scrollHeight;
  chatInput.value = '';

  // åˆ·æ–°èŠå¤©åˆ—è¡¨
  if(document.querySelector('.tab.active')?.getAttribute('data-tab') === 'chat') renderChatList();
}

/* ---------- AIå›å¤åŠŸèƒ½ï¼ˆè¯­éŸ³æŒ‰é’®è§¦å‘ï¼‰- å·²æ·»åŠ åŠ¨æ€æ•ˆæœ ---------- */
async function triggerAIReply() {
  const chatId = chatWindow.dataset.openChatId;
  if (!chatId) {
    toast('è¯·å…ˆæ‰“å¼€èŠå¤©çª—å£', 1500);
    return;
  }

  // 1. æ£€æŸ¥APIé…ç½®æ˜¯å¦å®Œæ•´
  const proxy = localStorage.getItem('api_proxy') || '';
  const key = localStorage.getItem('api_key') || '';
  const model = localStorage.getItem('api_model') || '';
  if (!proxy || !key || !model) {
    toast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIå‚æ•°', 2000);
    return;
  }

  // 2. è®¾ç½®é¡¶éƒ¨çŠ¶æ€æç¤ºä¸º"å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­..."
  const originalTitle = chatTitle.innerText;
  chatTitle.innerText = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥ä¸­...';
  chatTitle.classList.add('typing-indicator');

  // 3. æ’å…¥è¾“å…¥ä¸­çŠ¶æ€æ¶ˆæ¯ï¼ˆåŠ¨æ€åœ†ç‚¹åŠ¨ç”»ï¼‰
  const loadingMsg = { from: 'them', text: 'TYPING_INDICATOR', ts: Date.now() };
  messages[chatId].push(loadingMsg);
  renderMessages(chatId);
  chatBody.scrollTop = chatBody.scrollHeight;

  try {
    // 4. æ„å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯ï¼ˆæ’é™¤è¾“å…¥ä¸­çŠ¶æ€æ¶ˆæ¯å’Œå·²æ’¤å›æ¶ˆæ¯ï¼‰
    const contextMsgs = messages[chatId]
      .filter(msg => msg.text !== 'TYPING_INDICATOR' && !msg.recalled) // æ’é™¤è¾“å…¥ä¸­çŠ¶æ€å’Œå·²æ’¤å›æ¶ˆæ¯
      .map(msg => ({
        role: msg.from === 'me' ? 'user' : 'assistant',
        content: msg.text
      }));

    // 5. è°ƒç”¨AIæ¥å£
    const apiUrl = (proxy.endsWith('/') ? proxy.slice(0, -1) : proxy) + '/chat/completions';
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${key}`
      },
      body: JSON.stringify({
        model: model,
        messages: contextMsgs,
        temperature: Number(localStorage.getItem('api_temperature') || 0.8)
      })
    });

    if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    const data = await response.json();
    const aiReply = data.choices?.[0]?.message?.content?.trim() || 'æŠ±æ­‰ï¼Œæœªèƒ½è·å–å›å¤';

    // 6. ç§»é™¤è¾“å…¥ä¸­çŠ¶æ€æ¶ˆæ¯
    const typingIndex = messages[chatId].findIndex(msg => msg.text === 'TYPING_INDICATOR');
    if (typingIndex !== -1) {
      messages[chatId].splice(typingIndex, 1);
    }
    
    // 7. æ’å…¥å®é™…å›å¤æ¶ˆæ¯
    const finalMsg = { from: 'them', text: aiReply, ts: Date.now() };
    messages[chatId].push(finalMsg);
    localStorage.setItem('messages', JSON.stringify(messages));

    // 8. æ¢å¤é¡¶éƒ¨çŠ¶æ€æç¤ºä¸ºåŸåç§°
    chatTitle.innerText = originalTitle;
    chatTitle.classList.remove('typing-indicator');

    // 9. æ›´æ–°èŠå¤©åˆ—è¡¨é¢„è§ˆå’Œæ—¶é—´
    const chatIdx = chats.findIndex(c => c.id === chatId);
    if (chatIdx !== -1) {
      chats[chatIdx].preview = aiReply;
      const msgDate = new Date(finalMsg.ts);
      const now = new Date();
      const isToday = now.toDateString() === msgDate.toDateString();
      chats[chatIdx].timeLabel = isToday
        ? msgDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
        : msgDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
      chats[chatIdx].ts = Date.now();
      // ç§»åˆ°åˆ—è¡¨é¡¶éƒ¨
      const chatObj = chats.splice(chatIdx, 1)[0];
      chats.unshift(chatObj);
      localStorage.setItem('chats', JSON.stringify(chats));
    }

    // 10. é‡æ–°æ¸²æŸ“æ¶ˆæ¯å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
    renderMessages(chatId);
    chatBody.scrollTop = chatBody.scrollHeight;

    // 11. åˆ·æ–°èŠå¤©åˆ—è¡¨
    if (document.querySelector('.tab.active')?.getAttribute('data-tab') === 'chat') {
      renderChatList();
    }

  } catch (error) {
    // å¼‚å¸¸å¤„ç†ï¼šç§»é™¤è¾“å…¥ä¸­çŠ¶æ€æ¶ˆæ¯å¹¶æ¢å¤é¡¶éƒ¨æ ‡é¢˜
    const typingIndex = messages[chatId].findIndex(msg => msg.text === 'TYPING_INDICATOR');
    if (typingIndex !== -1) {
      messages[chatId].splice(typingIndex, 1);
    }
    
    // æ¢å¤é¡¶éƒ¨çŠ¶æ€æç¤ºä¸ºåŸåç§°
    chatTitle.innerText = originalTitle;
    chatTitle.classList.remove('typing-indicator');
    
    // é‡æ–°æ¸²æŸ“æ¶ˆæ¯
    renderMessages(chatId);
    
    toast(`å›å¤å¤±è´¥: ${error.message}`, 2000);
  }
}

/* ---------- è§’è‰²ä¸“å±è®¾ç½®åŠŸèƒ½ - ç‚¹å‡»OKåç«‹å³å¼¹çª—å¹¶å®Œæ•´ä¿å­˜ */
// é¢„è§ˆè§’è‰²å¤´åƒ
function previewRoleAvatar(){
  const input = document.getElementById('roleAvatarInput');
  const file = input.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = e => {
    roleAvatarImg.src = e.target.result;
    roleAvatarPreview.style.display = 'block';
  };
  reader.readAsDataURL(file);
}

// è®¾ç½®è§’è‰²èŠå¤©èƒŒæ™¯
function setRoleChatBg(){
  const input = document.getElementById('roleBgInput');
  const file = input.files[0];
  if(!file) return;
  
  const reader = new FileReader();
  reader.onload = e => {
    const currentChatId = chatWindow.dataset.openChatId;
    if(!currentChatId) return;
    
    // ä¸´æ—¶åº”ç”¨èƒŒæ™¯
    chatBody.style.backgroundImage = `url(${e.target.result})`;
    chatBody.style.backgroundSize = 'cover';
    chatBody.style.backgroundPosition = 'center';
    
    // å­˜å‚¨åˆ°ä¸´æ—¶é…ç½®
    if(!roleConfigs[currentChatId]) roleConfigs[currentChatId] = {};
    roleConfigs[currentChatId].chatBg = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ä¿å­˜è§’è‰²è®¾ç½® - ç‚¹å‡»OKåç«‹å³å¼¹çª—+å®Œæ•´ä¿å­˜+åŒæ­¥æ ‡é¢˜
function saveRoleSetting(){
  const currentChatId = chatWindow.dataset.openChatId;
  if(!currentChatId) {
    toast('èŠå¤©çª—å£æœªæ‰“å¼€ï¼Œæ— æ³•ä¿å­˜', 1500);
    return;
  }
  
  // 1. ç«‹å³å¼¹å‡ºä¿å­˜æˆåŠŸå¼¹çª—ï¼ˆå…ˆæ˜¾ç¤ºå¼¹çª—ï¼‰
  toast('ä¿å­˜æˆåŠŸï½', 1500, true);
  
  // 2. è·å–æ‰€æœ‰é…ç½®é¡¹å†…å®¹
  const name = roleNameInput.value.trim();
  const remark = roleRemarkInput.value.trim();
  const desc = roleDescInput.value.trim();
  const roleBubbleCss = roleBubbleCssInput.value.trim();
  const userBubbleCss = userBubbleCssInput.value.trim();
  const avatar = roleAvatarImg.src || '';
  const chatBg = roleConfigs[currentChatId]?.chatBg || '';
  
  // 3. å®Œæ•´æ›´æ–°è§’è‰²é…ç½®ï¼ˆåŒ…å«æ‰€æœ‰é¡¹ï¼‰
  if(!roleConfigs[currentChatId]) roleConfigs[currentChatId] = {};
  roleConfigs[currentChatId].name = name;
  roleConfigs[currentChatId].remark = remark;
  roleConfigs[currentChatId].desc = desc;
  roleConfigs[currentChatId].bubbleCss = roleBubbleCss;
  roleConfigs[currentChatId].userBubbleCss = userBubbleCss;
  roleConfigs[currentChatId].avatar = avatar;
  roleConfigs[currentChatId].chatBg = chatBg;
  
  // 4. åŒæ­¥æ›´æ–°contactsæ•°æ®
  const chat = chats.find(c=>c.id===currentChatId);
  if(chat?.contactId) {
    const contactIdx = contacts.findIndex(con=>con.id === chat.contactId);
    if(contactIdx !== -1) {
      if(name) contacts[contactIdx].name = name;
      if(remark) contacts[contactIdx].note = remark;
      if(desc) contacts[contactIdx].info = desc;
      if(avatar) contacts[contactIdx].avatar = avatar;
      localStorage.setItem('contacts', JSON.stringify(contacts));
    }
  }
  
  // 5. æŒä¹…åŒ–å­˜å‚¨æ‰€æœ‰é…ç½®
  localStorage.setItem('roleConfigs', JSON.stringify(roleConfigs));
  
  // 6. å¤‡æ³¨ä¼˜å…ˆåŒæ­¥èŠå¤©æ ‡é¢˜æ 
  const displayTitle = remark || name || chatTitle.innerText;
  chatTitle.innerText = displayTitle;
  chatTitle.classList.remove('typing-indicator'); // ç¡®ä¿ç§»é™¤è¾“å…¥ä¸­æ ·å¼
  
  // 7. é‡æ–°æ¸²æŸ“åº”ç”¨æ–°é…ç½®
  renderChatList();
  renderMessages(currentChatId);
  
  // 8. å¼¹çª—å…³é—­åè¿”å›èŠå¤©é¡µ
  setTimeout(()=>{
    backToChat();
  }, 1500);
}

/* ---------- æ’å…¥æ–°èŠå¤©æ—¶ï¼Œé¢„è§ˆé»˜è®¤æ˜¾ç¤º"æš‚æ— æ¶ˆæ¯" ---------- */
function insertNewChat(contact){
  // contact: {id,name,avatar,note,info}
  const displayName = contact.note || contact.name;
  const chatObj = {
    id: 'c'+Date.now().toString(),
    contactId: contact.id,
    nameDisplay: displayName,
    avatar: contact.avatar || null,
    preview: 'æš‚æ— æ¶ˆæ¯', // æ–°èŠå¤©é»˜è®¤æ˜¾ç¤º"æš‚æ— æ¶ˆæ¯"
    // åˆå§‹åŒ–æ—¶é—´ä¸ºå½“å‰æ—¶é—´
    timeLabel: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
    ts: Date.now()
  };
  chats.unshift(chatObj);
  localStorage.setItem('chats', JSON.stringify(chats));
  messages[chatObj.id] = messages[chatObj.id] || [];
  messages[chatObj.id].push({from:'them', text:'æ·»åŠ å¥½å‹æˆåŠŸ', ts: Date.now()});
  localStorage.setItem('messages', JSON.stringify(messages));
  // render and highlight first item
  renderChatList();
  const first = document.querySelector('.chat-item');
  if(first){
    first.classList.add('fade-in');
    setTimeout(()=> first.classList.remove('fade-in'), 350);
  }
}

/* ---------- tabs åˆ‡æ¢ï¼ˆä¿ç•™ä½ ç°æœ‰é€»è¾‘ï¼‰ ---------- */
function switchTab(name, el){
  wechatTabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');

  if(name === 'chat'){
    document.getElementById('wechatSearch').style.display = 'block';
    renderChatList();
  } else {
    document.getElementById('wechatSearch').style.display = 'none';
    if(name === 'contact'){
      // é€šè®¯å½•é¡µé¢ä¹Ÿåº”ç”¨å¤‡æ³¨ä¼˜å…ˆæ˜¾ç¤º
      const cList = contacts.length ? contacts.map(c=>{
        const chat = chats.find(ch=>ch.contactId === c.id);
        const config = chat ? roleConfigs[chat.id] || {} : {};
        // å¤‡æ³¨ä¼˜å…ˆæ˜¾ç¤º
        const displayName = config.remark || config.name || c.note || c.name;
        const displayInfo = config.desc || c.info || '';
        return `<div class="chat-item"><div class="chat-avatar">${c.avatar||config.avatar?`<img src="${config.avatar||c.avatar}">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#666">${displayName.charAt(0)}</div>`}</div><div class="chat-main"><div class="chat-name">${escapeHtml(displayName)}</div><div class="chat-preview">${escapeHtml(displayInfo)}</div></div></div>`;
      }).join('') : `<div style="padding:18px;color:#888;text-align:center">æš‚æ— è”ç³»äºº</div>`;
      content.innerHTML = `<div class="list-card">${cList}</div>`;
    } else if(name === 'find'){
      content.innerHTML = `<div class="list-card"><div class="item">å‘ç° - åŠŸèƒ½å…¥å£1<span>â€º</span></div><div class="item">å‘ç° - åŠŸèƒ½å…¥å£2<span>â€º</span></div></div>`;
    } else if(name === 'me'){
      renderMe();
    } else {
      content.innerHTML = `<div class="item">${name} é¡µé¢</div>`;
    }
  }
}

/* render "me" page â€” æŒ‰ä½ è¦æ±‚çš„æ ·å¼è°ƒæ•´ï¼ˆæœ‹å‹åœˆ/è¡¨æƒ…/è®¾ç½®ï¼‰ */
function renderMe(){
  content.innerHTML = `
    <div class="me-container">
      <div class="profile">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="avatar">`:''}</div>
        <div>
          <div class="name">${escapeHtml(nickname)}</div>
          <div class="wxid">å¾®ä¿¡å·ï¼š${escapeHtml(wxId)}</div>
        </div>
      </div>

      <div class="me-options" role="list">
        <div class="me-item" role="listitem" onclick="openFriends()">
          <div class="left"><div class="label">æœ‹å‹åœˆ</div></div>
          <div class="chev">â€º</div>
        </div>

        <div class="me-item" role="listitem" onclick="openEmoticons()">
          <div class="left"><div class="label">è¡¨æƒ…</div></div>
          <div class="chev">â€º</div>
        </div>

        <div class="me-item" role="listitem" onclick="openSetting()">
          <div class="left"><div class="label">è®¾ç½®</div></div>
          <div class="chev">â€º</div>
        </div>
      </div>
    </div>
  `;
}

/* æ–°å¢çš„"æœ‹å‹åœˆ/è¡¨æƒ…"å ä½å‡½æ•°ï¼ˆä¿æŒä¸æ”¹å…¶å®ƒåŠŸèƒ½ï¼‰ */
function openFriends(){
  toast('æœ‹å‹åœˆï¼ˆç¤ºä¾‹ï¼‰');
}
function openEmoticons(){
  toast('è¡¨æƒ…ï¼ˆç¤ºä¾‹ï¼‰');
}

/* ---------- è®¾ç½®ä¸å›¾ç‰‡ç›¸å…³ï¼Œä¿æŒä½ åŸé€»è¾‘ ---------- */
function setNickname(v){ nickname = v; localStorage.setItem('nickname', v); renderMe(); }
function setWxId(v){ wxId = v; localStorage.setItem('wxid', v); renderMe(); }
function setAvatar(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { avatar = e.target.result; localStorage.setItem('avatar', avatar); renderMe(); };
  r.readAsDataURL(input.files[0]);
}
// ä¿®æ”¹ï¼šå£çº¸ä»…è®¾ç½®åˆ°wallpaperLayerå±‚
function setWallpaper(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { 
    wallpaperLayer.style.backgroundImage = `url(${e.target.result})`; 
    localStorage.setItem('wallpaper', e.target.result); 
  };
  r.readAsDataURL(input.files[0]);
}
function setWeChatIcon(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { wechatIconEl.innerHTML = `<img src="${e.target.result}" alt="icon">`; localStorage.setItem('wechatIcon', e.target.result); };
  r.readAsDataURL(input.files[0]);
}
/* æ–°å¢ï¼šä¿®æ”¹ä¸–ç•Œä¹¦å›¾æ ‡ */
function setWorldBookIcon(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { 
    worldBookIconEl.innerHTML = `<img src="${e.target.result}" alt="world-book">`; 
    localStorage.setItem('worldBookIcon', e.target.result); 
  };
  r.readAsDataURL(input.files[0]);
}
function setHomeSettingsIcon(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { homeSettingsIconEl.innerHTML = `<img src="${e.target.result}" alt="home-settings">`; localStorage.setItem('homeSettingsIcon', e.target.result); };
  r.readAsDataURL(input.files[0]);
}
function setPetImage(input){
  if(!input.files || !input.files[0]) return;
  const r = new FileReader();
  r.onload = e => { petBox.innerHTML = `<img src="${e.target.result}" alt="pet">`; localStorage.setItem('petImage', e.target.result); };
  r.readAsDataURL(input.files[0]);
}

/* ---------- API è®¾ç½®ç›¸å…³ï¼ˆä¿æŒåŸé€»è¾‘ï¼‰ ---------- */
function loadApiSettingsToUI(){
  const proxy = localStorage.getItem('api_proxy') || '';
  const key = localStorage.getItem('api_key') || '';
  const model = localStorage.getItem('api_model') || '';
  const temp = localStorage.getItem('api_temperature') || '0.8';
  apiProxyInput.value = proxy;
  apiKeyInput.value = key;
  apiModelSelect.value = model;
  apiTempRange.value = temp;
  apiTempVal.innerText = parseFloat(temp).toFixed(2);
}
function saveApiSettings(){
  localStorage.setItem('api_proxy', apiProxyInput.value.trim());
  localStorage.setItem('api_key', apiKeyInput.value.trim());
  localStorage.setItem('api_model', apiModelSelect.value);
  localStorage.setItem('api_temperature', apiTempRange.value);
  toast('APIè®¾ç½®å·²ä¿å­˜', 1500, true);
}
async function pullModels(){
  const proxy = apiProxyInput.value.trim();
  const key = apiKeyInput.value.trim();
  if(!proxy || !key){
    toast('è¯·å…ˆå¡«å†™åä»£åœ°å€å’ŒAPI Key', 1500);
    return;
  }
  const apiUrl = (proxy.endsWith('/') ? proxy.slice(0, -1) : proxy) + '/models';
  try{
    const res = await fetch(apiUrl, {
      headers: { 'Authorization': `Bearer ${key}` }
    });
    const data = await res.json();
    const models = data.data || [];
    apiModelSelect.innerHTML = '<option value="">ï¼ˆç©ºï¼‰</option>';
    models.forEach(m=>{
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = m.id;
      apiModelSelect.appendChild(opt);
    });
    toast('æ¨¡å‹åˆ—è¡¨æ‹‰å–æˆåŠŸ', 1500, true);
  }catch(e){
    toast('æ‹‰å–å¤±è´¥: ' + e.message, 2000);
  }
}
apiTempRange.addEventListener('input', ()=>{
  apiTempVal.innerText = parseFloat(apiTempRange.value).toFixed(2);
});

/* ---------- å·¥å…·å‡½æ•° ---------- */
function escapeHtml(text){
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* ---------- åˆå§‹åŒ–æ˜¾ç¤ºä¸»å±å¹• ---------- */
// è°ƒç”¨åˆå§‹åŒ–å‡½æ•°ï¼Œç¡®ä¿é¡µé¢åŠ è½½åæ˜¾ç¤ºä¸»å±å¹•
initDisplay();
</script>
</body>
</html>