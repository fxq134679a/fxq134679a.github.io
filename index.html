<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iOS Home Screen</title>
    <style>
        /* --- 全局重置与基础样式 --- */
        :root {
             --theme-pink-bg-light: #FFF0F5;
             --theme-pink-bg-med: rgba(229, 138, 171, 0.15);
             --theme-pink-bg-soft: #FFF8FA;
            --theme-pink-text: #E58AAB;
            --theme-pink-title: #f5b3c9;
            --theme-pink-btn: #F5B3C9; 
            --wb-plus-btn: #FDCEDF;
             --chat-bg-color: #FFF8FA;
             --success-green: #4CAF50;
            --error-red: #F44336;
            --wallet-gradient: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%);
            --wallet-card-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
            --link-blue: #5865F2;
            --moments-nickname-color: #8687B4; /* 朋友圈昵称颜色 */
            --menu-pink: #fdcee0;
            --header-text-custom: #FDCEDF; /* 新增：顶栏自定义颜色 */
            --phone-case-color: #ffffff; /* 新增：手机壳颜色变量 */
            --cat-ear-color: #ffffff; /* 新增：猫耳朵颜色变量 */
            --status-bar-height: 44px; /* 新增：状态栏高度变量 */

            /* --- 外卖App主题变量 --- */
            --takeout-bg-color: #FFF0F5; /* 浅粉色背景 */
            --takeout-primary-color: #FFB6C1; /* 主题粉色 */
            --takeout-white-color: #FFFFFF;
            --takeout-text-color: #333333;
            --takeout-light-text-color: #888888;
            --takeout-red-color: #F44336;
            --takeout-border-radius-m: 12px;
            --takeout-border-radius-l: 20px;
            --takeout-shadow: 0 4px 12px rgba(255, 182, 193, 0.3);
        }
        * {
             box-sizing: border-box;
             margin: 0;
             padding: 0;
             user-select: none;
             -webkit-tap-highlight-color: transparent;
             font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
         }
        body {
             width: 100vw;
             height: 100vh;
             overflow: hidden;
             background: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib-rb-1.2.1&auto=format&fit=crop&w=1000&q=80') center/cover no-repeat;
             position: relative;
             transition: background-image 0.3s ease-in-out;
            z-index: -2;
        }
        #home-screen {
             width: 100%;
             height: 100%;
             display: flex;
             flex-direction: column;
             padding: 0 0 env(safe-area-inset-bottom, 20px) 0;
             transition: opacity 0.3s ease, transform 0.3s ease;
         }
        body.settings-active #home-screen,
        body.chat-active #home-screen,
        body.wallet-active #home-screen,
        body.worldbook-active #home-screen,
        body.forum-active #home-screen,
        body.recollection-active #home-screen,
        body.mall-active #home-screen,
        body.takeout-active #home-screen { /* <-- 新增外卖App */
             opacity: 0;
             transform: scale(0.95);
             pointer-events: none;
         }

        /* --- 时间区域 --- */
        #time-section {
             height: 25%;
             display: flex;
             justify-content: center;
             align-items: center;
             padding-top: 20px;
             flex-shrink: 0;
             transition: padding-top 0.3s ease;
         }
        #time-container {
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            background-size: cover;
            background-position: center;
            border-radius: 25px;
         }
        #time-container:active {
            transform: scale(0.98);
        }
        #clock-time {
             font-size: 5.2rem;
             font-weight: 300;
             color: white;
             text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.1;
        }
        #clock-date {
            font-size: 0.95rem;
             color: white;
            font-weight: 500;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- 网格区域 --- */
        #grid-area {
             flex: 1;
             display: grid;
             grid-template-columns: 1fr 1fr;
             grid-template-rows: 1fr 1fr;
             padding: 0 15px 10px 15px;
             gap: 15px;
             width: 100%;
             max-width: 600px;
             margin: 0 auto;
         }
        .grid-quadrant {
             width: 100%;
             height: 100%;
             display: flex;
             justify-content: center;
             align-items: center;
             position: relative;
         }
        
        /* --- 优化的聊天小组件样式 (Quadrant 1) --- */
        #chat-dual-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 15px; 
            padding: 5px;
        }
        .chat-row { display: flex; align-items: center; width: 100%; }
        .chat-row.left { justify-content: flex-start; }
        .chat-row.right { flex-direction: row-reverse; }

        .avatar-container {
            position: relative; flex-shrink: 0; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            margin: 0 8px; 
        }
        .avatar-container:active { transform: scale(0.9); }
        .avatar-ring {
            width: 48px; height: 48px; border-radius: 50%; padding: 2px;
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%, #a18cd1 100%);
            box-shadow: 0 4px 10px rgba(255, 154, 158, 0.3);
        }
        .avatar-img-circle {
            width: 100%; height: 100%; border-radius: 50%;
            background-color: #fff; background-size: cover; background-position: center;
            border: 2px solid #fff; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        
        .chat-bubble-input {
            height: 36px; border-radius: 18px; padding: 0 14px; font-size: 13px; outline: none;
            transition: all 0.3s ease; min-width: 60px; max-width: 140px; width: 80px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); color: #444;
        }
        .chat-bubble-input.left-bubble { border-bottom-left-radius: 4px; }
        .chat-bubble-input.right-bubble { border-bottom-right-radius: 4px; text-align: right; }
        .chat-bubble-input:focus { box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: rgba(255, 255, 255, 0.9); max-width: 150px; }

        /* --- 图片小组件 (Quadrant 4) --- */
        .photo-widget-container {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 26px; 
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            position: relative; overflow: hidden; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; justify-content: center; align-items: center;
        }
        .photo-widget-container:active { transform: scale(0.96); }
        .photo-widget-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-widget-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.1); pointer-events: none;
        }
        .photo-widget-icon { font-size: 36px; margin-bottom: 5px; opacity: 0.8; }
        .photo-widget-text { font-size: 13px; font-weight: 500; opacity: 0.9; }

        /* --- App Group Styles --- */
        .app-group-2x2 {
             display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
             gap: 12px; width: 100%; aspect-ratio: 1/1;
         }
        .app-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .app-icon {
             width: 60px; height: 60px; border-radius: 16px; margin-bottom: 5px;
             display: flex; justify-content: center; align-items: center; font-size: 28px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative;
             transition: transform 0.1s, filter 0.1s;
             background-size: cover; background-position: center; background-color: rgba(255, 255, 255, 0.2);
        }
                .app-name { font-size: 11px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.4); white-space: nowrap; }
        
        /* --- 新增的代码 --- */
        body.light-mode-icons-active .app-name {
            color: black;
            text-shadow: none;
        }
        /* --- 新增结束 --- */
                
        /* 底栏样式 */
        #dock-area {
             height: 95px; width: 100%; display: flex; justify-content: center; align-items: center;
             padding: 0 15px 10px 15px; flex-shrink: 0;
         }
        .dock-container {
             width: 100%; max-width: 350px; height: 100%;
             background: rgba(255, 255, 255, 0.2);
             backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
             border-radius: 30px; display: flex; justify-content: space-evenly; align-items: center;
             box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.15);
         }
        .dock-icon { width: 60px; height: 60px; font-size: 28px; margin: 0; }
        #dock-area .app-item .app-icon { margin-bottom: 0; }

        /* --- Chat App 首页样式 --- */
        #chat-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--chat-bg-color); z-index: 500;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.chat-active #chat-app-page { transform: translateY(0); }
        
        .chat-app-header {
            padding: 35px 20px 15px;
            background: #fff;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: none;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 4px 20px rgba(229, 138, 171, 0.15);
            flex-shrink: 0; z-index: 10; 
            transition: padding-top 0.3s ease, background-color 0.3s, box-shadow 0.3s;
            position: relative;
        }
        
        .chat-app-header.hidden { display: none; }
        .chat-header-title { 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--header-text-custom); 
            transition: color 0.3s ease;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .back-icon-img { width: 30px; height: 30px; object-fit: contain; cursor: pointer; opacity: 1; pointer-events: auto; }
        .back-icon-img.hidden { opacity: 0; pointer-events: none; }
        .header-right-icon { width: 26px; height: 26px; object-fit: contain; cursor: pointer; transition: opacity 0.3s ease; }
        
        .chat-app-content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 100px; scroll-behavior: smooth; background-color: var(--chat-bg-color); transition: background-color 0.3s ease; }
        .me-mode { padding-top: 0; background-color: var(--chat-bg-color); overflow-y: hidden; display: flex; flex-direction: column; justify-content: flex-end; height: 100vh; }
        .chat-tab-content { display: none; min-height: 100%; }
        .chat-tab-content.active { display: block; }

        /* --- 角色聊天页面 (Chat Conversation View) - 仿微信布局 --- */
        #chat-conversation-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F8F8F8; 
            z-index: 600;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
            background-size: cover; background-position: center;
        }
        #chat-conversation-view.active { transform: translateX(0); }

        /* 1. 顶部导航栏 (角色聊天) */
        .chat-conv-header {
            padding: 25px 15px 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
            border-radius: 0 0 35px 35px;
            box-shadow: 0 5px 25px rgba(229, 138, 171, 0.15);
            flex-shrink: 0; z-index: 20; height: 80px;
            transition: padding-top 0.3s ease, height 0.3s ease;
        }
        
        body.ios-mode-active .chat-conv-header { 
            padding-top: calc(env(safe-area-inset-top, 20px) + 25px);
            height: 120px; 
        }
        body.ios-mode-active .chat-conv-back-btn,
        body.ios-mode-active .chat-conv-right-icon {
            transform: translateY(-20px);
        }
        body.ios-mode-active .chat-conv-title-container { margin-top: -30px; }
        
        /* 1. 手机框模式下，聊天页备注上移 */
        body.phone-frame-active .chat-conv-title-container {
            margin-top: -10px;
        }


        .chat-conv-back-btn { width: 32px; height: 32px; object-fit: contain; cursor: pointer; }
        
        .chat-conv-title-container {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; padding: 0 10px; transition: margin-top 0.3s ease;
        }
        .chat-conv-title {
            font-size: 17px; font-weight: 600; color: var(--theme-pink-text); 
            text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        /* 对方正在输入中... 闪烁动画类 */
        @keyframes blinkColor {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        .typing-anim {
            color: #FDCEDF !important;
            animation: blinkColor 1.5s infinite ease-in-out;
        }

        .chat-conv-signature {
            font-size: 11px; color: var(--theme-pink-text); opacity: 0.8;
            margin-top: 2px; text-align: center; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .chat-conv-right-icon { 
            width: 28px; height: 28px; cursor: pointer; object-fit: contain; 
        }

               /* 聊天内容区 */
        .chat-conv-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }
        
        /* 新增：让第一条消息自动顶上去，实现底部对齐且不影响滚动 */
        .chat-conv-messages > :first-child {
            margin-top: auto;
        }
        
        /* Time Stamp Style */
        .chat-time-stamp {
            align-self: center;
            font-size: 12px;
            color: #b0b0b0;
            margin: 10px 0;
            font-weight: 400;
        }
        
        .msg-bubble-row { display: flex; align-items: flex-end; width: 100%; gap: 8px; transition: transform 0.3s; position: relative; }
        .msg-bubble-row.me { justify-content: flex-end; }
        
        /* Recalled Tip */
        .msg-recalled-tip {
            align-self: center;
            font-size: 12px;
            color: #b0b0b0;
            background: rgba(0,0,0,0.05);
            padding: 4px 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        .msg-bubble-avatar {
            width: 38px; height: 38px; border-radius: 8px; object-fit: cover;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        
        /* 文字排列样式 */
        .msg-bubble-content {
            max-width: 70%; padding: 12px 16px; font-size: 15px; line-height: 1.6;
            position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            word-wrap: break-word; word-break: break-all; user-select: text;
            white-space: pre-wrap; text-align: left; display: block;
        }
        .msg-bubble-row.them .msg-bubble-content {
            background: #FFFFFF; color: #333;
            border-radius: 18px 18px 18px 4px;
        }
        .msg-bubble-row.me .msg-bubble-content {
            background: var(--theme-pink-text); color: white;
            border-radius: 18px 18px 4px 18px;
        }

        /* --- [MODIFIED] Transfer Bubble Style in Chat --- */
        .transfer-message-card {
            width: 230px; 
            background-color: #fd9806; /* 默认橙色背景 */
            color: white;
            border-radius: 12px;
            padding: 0;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            cursor: default; /* No longer clickable by default */
            transition: background-color 0.3s ease;
        }

        .transfer-main {
            display: flex;
            align-items: center;
            padding: 15px;
        }
        .transfer-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .transfer-details {
            flex: 1;
            overflow: hidden;
        }
        .transfer-amount {
            font-size: 22px;
            font-weight: 500;
            white-space: nowrap;
        }
        .transfer-status {
            font-size: 13px;
            margin-top: 4px;
            opacity: 0.9;
        }
        .transfer-footer-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            background: transparent;
            padding: 6px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* --- 美化后的气泡菜单 (粉白圆滑风格) --- */
        .bubble-context-menu {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.95); /* 半透明白色背景 */
            backdrop-filter: blur(10px); /* 毛玻璃效果 */
            border-radius: 16px; /* 更圆润的边角 */
            padding: 6px;
            display: flex;
            gap: 6px;
            box-shadow: 0 8px 25px rgba(229, 138, 171, 0.25); /* 粉色系柔和阴影 */
            z-index: 10020;
            white-space: nowrap;
            transform: translate(-50%, -100%);
            margin-top: -12px;
            display: none;
            border: 1px solid rgba(255, 240, 245, 0.6); /* 极淡的粉色边框 */
            animation: popMenu 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popMenu { from { opacity: 0; transform: translate(-50%, -90%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -100%) scale(1); } }
        
        .bubble-context-menu.active { display: flex; }
        
        .bubble-menu-item {
            padding: 8px 16px;
            font-size: 14px;
            color: #555;
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px; /* 按钮也圆润 */
            transition: all 0.2s;
        }
        .bubble-menu-item:active, .bubble-menu-item:hover { 
            background-color: #FFF0F5; /* 薰衣草/浅粉背景 */
            color: #E58AAB; /* 粉色文字 */
        }
        
        /* 菜单下方的小箭头 */
        .bubble-context-menu::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -7px;
            border-width: 7px; border-style: solid;
            border-color: rgba(255, 255, 255, 0.95) transparent transparent transparent;
            filter: drop-shadow(0 2px 2px rgba(229, 138, 171, 0.1));
        }

        /* Multi-select Mode Styles */
        .chat-conv-messages.multi-select-active .msg-bubble-row {
            padding-left: 30px; /* Space for checkbox */
        }
        .chat-checkbox {
            position: absolute; left: -30px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd;
            display: none; justify-content: center; align-items: center;
            background: white; transition: all 0.2s;
        }
        .chat-conv-messages.multi-select-active .chat-checkbox { display: flex; left: 0; }
        .chat-checkbox.checked { background: var(--theme-pink-btn); border-color: var(--theme-pink-btn); }
        .chat-checkbox.checked::after { content: '✓'; color: white; font-size: 12px; font-weight: bold; }
        
        .chat-multiselect-footer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; border-top: 1px solid #eee; z-index: 25;
            display: none; justify-content: center; align-items: center;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .chat-multiselect-footer.active { display: flex; }
        .chat-multiselect-delete-btn {
            background: #ffebee; color: #F44336; padding: 10px 30px; border-radius: 20px;
            border: none; font-weight: 600; font-size: 14px; cursor: pointer;
        }


        /* 2. 底部输入栏 (角色聊天) */
        .chat-conv-footer {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px)) 12px;
            display: flex; align-items: center; gap: 10px;
            border-radius: 35px 35px 0 0;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.04);
            flex-shrink: 0; z-index: 20;
        }
        
        .chat-conv-btn {
            width: 42px; height: 42px; border-radius: 50%;
            background-color: var(--theme-pink-btn);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; border: none; outline: none;
            box-shadow: 0 3px 8px rgba(229, 138, 171, 0.3);
            transition: transform 0.1s; flex-shrink: 0;
        }
        .chat-conv-btn:active { transform: scale(0.92); }
        .chat-conv-btn img {
            filter: brightness(0) invert(1); 
            pointer-events: none;
        }
        /* AI触发按钮专属样式，可根据需要微调 */
        .chat-conv-btn.ai-trigger {
            background-color: var(--theme-pink-btn);
        }

        .chat-conv-input-wrapper { flex: 1; height: 42px; position: relative; }
        .chat-conv-input {
            width: 100%; height: 100%;
            border-radius: 25px;
            background-color: #F5F5F7; border: none; outline: none;
            padding: 0 20px; font-size: 16px; color: #333;
            transition: background-color 0.2s;
        }
        .chat-conv-input:focus { background-color: #F5F5F7; border: 1px solid rgba(229, 138, 171, 0.3); }

        /* Chat Extra Menu (功能集弹窗) */
        #chat-extra-menu {
            position: absolute;
            bottom: 75px;
            left: 10px;
            width: 300px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 15px;
            display: none;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.15);
            z-index: 50;
            transition: opacity 0.2s ease, transform 0.2s ease;
            opacity: 0;
            transform: translateY(10px);
        }
        #chat-extra-menu.active {
            display: grid;
            opacity: 1;
            transform: translateY(0);
        }
        .chat-menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
        }
        .chat-menu-item:active { opacity: 0.7; }
        .chat-menu-icon {
            width: 36px;
            height: 36px;
            object-fit: contain;
            border-radius: 10px;
        }
        .chat-menu-text {
            font-size: 11px;
            color: #666;
            font-weight: 500;
        }

        /* --- 角色设置页面 (Role Settings Page) --- */
        #role-settings-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--theme-pink-bg-light);
            z-index: 700;
            display: flex; flex-direction: column; align-items: center;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1), padding-top 0.3s ease;
            overflow-y: auto; padding: 40px 20px 40px;
        }
        #role-settings-page.active { transform: translateX(0); }
        
        .role-setting-close-area { width: 100%; display: flex; justify-content: flex-start; margin-bottom: 10px; flex-shrink: 0; }
        .role-setting-back-btn { width: 30px; height: 30px; cursor: pointer; object-fit: contain; }
        
        .settings-section-card {
            width: 100%; max-width: 500px;
            background: white; border-radius: 20px;
            padding: 20px; box-shadow: 0 4px 15px rgba(245, 179, 201, 0.2);
            margin-bottom: 20px; display: flex; flex-direction: column; align-items: center;
        }

        .settings-card-title {
            font-size: 15px; font-weight: 600; color: var(--theme-pink-text);
            width: 100%; text-align: left; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;
        }

        .role-avatar-edit-wrapper { 
            position: relative; width: 70px; height: 70px; margin-bottom: 10px;
            box-shadow: 0 5px 15px rgba(229, 138, 171, 0.2); border-radius: 50%;
        }
        .role-avatar-edit { 
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover; 
            border: 3px solid white; cursor: pointer;
        }
        .avatar-edit-hint {
            position: absolute; bottom: -2px; right: -2px; background: var(--theme-pink-btn); color: white;
            width: 22px; height: 22px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 12px; border: 2px solid white; pointer-events: none;
        }

        .role-alias-edit {
            font-size: 18px; font-weight: 600; color: #333; border: none; background: transparent;
            text-align: center; margin-bottom: 5px; border-bottom: 2px solid transparent;
            padding: 5px; outline: none; width: 80%; transition: border-color 0.2s;
        }
        .role-alias-edit:focus { border-bottom-color: var(--theme-pink-btn); }

        .role-signature-edit {
             font-size: 13px; color: var(--theme-pink-text); border: none; background: transparent;
             text-align: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0;
             padding: 4px; outline: none; width: 90%;
        }
        .role-signature-edit:focus { border-bottom-color: var(--theme-pink-btn); }
        
        .role-persona-input, .role-css-input {
            width: 100%; height: 80px;
            border: 1px solid #eee; border-radius: 12px;
            padding: 10px; font-size: 14px; line-height: 1.4; outline: none; resize: none;
            background-color: #FAFAFA; color: #444; font-family: inherit; margin-bottom: 10px;
        }
        .role-persona-input:focus, .role-css-input:focus { background-color: white; border-color: var(--theme-pink-btn); }
        
        .role-css-input { height: 120px; font-family: monospace; font-size: 12px; }

        .role-bg-upload-area {
            width: 100%; margin-top: 15px; display: flex; flex-direction: column; gap: 10px;
            padding: 10px; background: #f9f9f9; border-radius: 10px;
        }
        .role-bg-preview {
            width: 40px; height: 60px; border-radius: 6px; background-color: #eee;
            background-size: cover; background-position: center; border: 1px solid #ddd;
        }
        .role-bg-btn {
            font-size: 13px; padding: 6px 12px; border-radius: 15px; border: none;
            background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); cursor: pointer;
        }

        .user-avatar-row { display: flex; align-items: center; width: 100%; margin-bottom: 15px; gap: 15px; }
        .user-avatar-edit-wrapper { 
            position: relative; width: 60px; height: 60px; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 50%; cursor: pointer;
        }
        .user-name-input {
            flex: 1; border: 1px solid #eee; border-radius: 10px; padding: 10px;
            font-size: 15px; outline: none; background: #FAFAFA;
        }
        .user-name-input:focus { background: white; border-color: var(--theme-pink-btn); }

        .role-save-btn {
            width: 100%; max-width: 300px; padding: 15px;
            background-color: var(--theme-pink-btn);
            color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: 600;
            cursor: pointer; box-shadow: 0 5px 15px rgba(245, 179, 201, 0.4);
            transition: transform 0.1s; margin-top: 10px;
        }
        .role-save-btn:active { transform: scale(0.96); }

        .role-delete-btn {
            font-size: 14px; color: #F44336; margin-top: 20px; background: transparent; border: none;
            text-decoration: underline; cursor: pointer; padding: 10px; font-weight: 500;
        }

        .role-wb-binding-area {
            width: 100%; display: flex; align-items: center; justify-content: space-between;
            background: #f9f9f9; border-radius: 10px; padding: 10px 15px; margin-top: 10px;
        }
        #role-wb-display {
            flex: 1; font-size: 14px; color: #555; font-weight: 500;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #role-wb-display.unbound { color: #aaa; font-style: italic; }
        .role-wb-binding-area .actions { display: flex; gap: 8px; margin-left: 10px; }
        .role-wb-binding-area button {
            font-size: 13px; padding: 6px 12px; border-radius: 15px; border: none; cursor: pointer;
            background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text);
        }
        .role-wb-binding-area button#role-wb-clear-btn { background-color: #eee; color: #999; }
        
        /* --- Chat List & Contact List Styles --- */
        .chat-list-container { width: 100%; }
        .chat-list-item { display: flex; align-items: center; padding: 12px 20px; background-color: white; border-bottom: 1px solid rgba(0,0,0,0.03); cursor: pointer; transition: background-color 0.2s; }
        .chat-list-item:active { background-color: #f0f0f0; }
        .chat-list-avatar { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; margin-right: 15px; background-color: #eee; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chat-list-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .chat-list-name { font-size: 16px; color: #111; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-msg { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .contact-list-container { width: 100%; padding-bottom: 80px; padding-right: 25px; }
        .contact-section-title {
            padding: 8px 20px; font-size: 13px; font-weight: 600; color: #999;
            background-color: #f7f7f7; position: sticky; top: 0; z-index: 5; scroll-margin-top: 70px;
        }
        .contact-item {
            display: flex; align-items: center; padding: 10px 20px; background: white;
            border-bottom: 1px solid #f9f9f9; cursor: pointer; transition: background 0.2s;
        }
        .contact-item:active { background-color: #f0f0f0; }
        .contact-avatar { width: 42px; height: 42px; border-radius: 10px; margin-right: 15px; object-fit: cover; background: #eee; }
        .contact-name { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 0; }
        .contact-signature { font-size: 12px; color: #E58AAB; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; width: 100%; margin-top: 2px; }
        .contact-signature:empty { display: none; margin-top: 0; }
        .pinned-tag { display: none; margin-left: auto; font-size: 12px; color: orange; }
        .contact-item.pinned .pinned-tag { display: block; }
        
        .alpha-index-bar {
            position: fixed; right: 5px; top: 120px; bottom: 100px;
            width: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 20; color: #aaa; font-size: 10px; font-weight: 600;
        }
        .alpha-index-item { flex: 1; width: 100%; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; transition: color 0.2s; }
        .alpha-index-item:active { color: var(--theme-pink-text); background-color: rgba(0,0,0,0.03); }
        
        .chat-placeholder-text { color: #E58AAB; text-align: center; padding-top: 50%; font-size: 16px; font-weight: 500; width: 100%; }

        /* --- NEW/MODIFIED: 朋友圈 (Moments) Styles --- */
        #chat-tab-2 {
            background-color: #ffffff; /* 确保朋友圈 Tab 背景纯白 */
            min-height: 100vh;
        }
        #moments-page-wrapper {
            background-color: #ffffff; /* 强制白色背景 */
            padding-bottom: 100px; /* Space for nav bar */
            min-height: 100%;
        }
        .moments-header {
            position: relative;
            width: 100%;
            padding-bottom: 40px; /* Space for content below cover */
        }
        .moments-cover-img {
            width: 100%;
            height: 300px;
            background-color: #ddd;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .moments-user-info {
            position: absolute;
            top: 265px; /* Cover height (300) - half avatar (35) */
            right: 20px;
            display: flex;
            align-items: flex-start; /* Align top, so text sits above boundary */
            gap: 15px;
            z-index: 2;
        }
        
        .moments-user-nickname {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            margin-top: 15px; /* Adjust to align visually with the "upper part" of the avatar */
        }
        
        .moments-user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        #moments-list {
            display: flex;
            flex-direction: column;
            background-color: #ffffff; /* 强制白色背景 */
            padding-top: 30px; /* Space for the overlapping avatar */
        }
        .moment-item {
            display: flex;
            gap: 15px;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .moment-item-avatar {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }
        .moment-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .moment-item-nickname {
            font-size: 16px;
            font-weight: 600;
            color: var(--moments-nickname-color); /* 修改颜色为 #8687B4 */
        }
        .moment-item-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* Nine Grid Image Layout */
        .moments-img-grid {
            display: grid;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
            max-width: 300px;
        }
        .moments-img-grid.single-img {
            grid-template-columns: 1fr;
        }
        .moments-img-grid.grid-2, .moments-img-grid.grid-4 {
            grid-template-columns: repeat(2, 1fr);
            width: 200px; /* Limit width for 2x2 */
        }
        .moments-img-grid.grid-3, .moments-img-grid.grid-5, .moments-img-grid.grid-6, 
        .moments-img-grid.grid-7, .moments-img-grid.grid-8, .moments-img-grid.grid-9 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .moment-grid-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
        }
        .moments-img-grid.single-img .moment-grid-img {
            max-width: 200px;
            max-height: 200px;
            aspect-ratio: auto;
            width: auto;
            height: auto;
        }

        .moment-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #999;
        }
        .moment-item-meta-left {
            display: flex;
            align-items: center;
            gap: 8px; /* '两个字的距离' reduced for better spacing with new tag*/
            font-size: 13px;
        }
        .moment-delete-btn {
            width: 14px;
            height: 14px;
            object-fit: contain;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .moment-delete-btn:hover { opacity: 1; }

        .moment-actions-btn {
            background-color: #f0f0f0;
            border-radius: 4px;
            padding: 0px 6px;
            font-weight: bold;
            font-size: 18px; /* Slightly larger for ".." */
            color: #8687B4; /* 修改为指定颜色 */
            cursor: pointer;
            position: relative;
            line-height: 14px;
            height: 16px;
            display: flex;
            align-items: center;
            letter-spacing: -2px; /* Make dots closer */
        }
        .moment-actions-popup {
            position: absolute;
            right: 100%;
            bottom: -8px; /* Slight adjustment */
            margin-right: 10px;
            background-color: #4C4C4C;
            color: white;
            border-radius: 6px;
            display: flex;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transform: scale(0);
            transform-origin: right center;
            transition: transform 0.15s ease-out;
            white-space: nowrap;
            z-index: 10; /* Ensure it's above other elements */
        }
        .moment-actions-popup.active {
            transform: scale(1);
        }
        .moment-popup-btn {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        .moment-popup-btn img {
            width: 16px; height: 16px; object-fit: contain;
        }
        .moment-popup-btn:not(:last-child) {
            border-right: 1px solid #666;
        }
        .moment-popup-btn:active {
            background-color: #333;
        }
        .moment-feedback {
            margin-top: 10px;
            background-color: #F7F7F7;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
        }
        .moment-likes {
            color: var(--moments-nickname-color);
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .moment-likes:empty {
            display: none;
        }
        .moment-likes:last-child { /* if no comments, remove border */
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .moment-comments-list {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .moment-comment-item .user {
            color: var(--moments-nickname-color); /* 修改颜色为 #8687B4 */
            font-weight: 500;
        }
        .moment-comment-item .text {
            color: #333;
        }
        #add-moment-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f7f7f7;
            z-index: 650; display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        #add-moment-modal.active {
            transform: translateY(0);
        }
        .add-moment-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 35px 20px 15px; background: #f7f7f7; flex-shrink: 0;
        }
        .add-moment-header button {
            border: none; background: none; font-size: 16px; cursor: pointer; padding: 5px 10px;
        }
        .add-moment-cancel { color: #333; }
        
        /* Updated Post Button Style */
        .add-moment-post {
            background-color: #F8C8DC; /* Pale Pink */
            color: black; 
            border-radius: 4px; /* Rectangular-ish */
            padding: 6px 15px !important; 
            font-weight: 500;
        }
        
        .add-moment-content { padding: 0 20px; flex: 1; display: flex; flex-direction: column; }
        #add-moment-text {
            width: 100%;
            height: 150px;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            resize: none;
            padding: 10px 0;
        }
        
        /* Add Moment Image Grid */
        .add-moment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .add-moment-image-upload { 
            width: 100%; 
            aspect-ratio: 1/1; 
            background-color: #eaeaea; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 30px; color: #aaa; 
            border-radius: 8px; 
            position: relative; overflow: hidden; 
        }
        .add-moment-img-cell {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .add-moment-img-cell img {
            width: 100%; height: 100%; object-fit: cover;
        }
        .add-moment-remove-img {
            position: absolute; top: 2px; right: 2px;
            background: rgba(0,0,0,0.5); color: white;
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; cursor: pointer;
        }
        
        .moments-empty-placeholder {
            text-align: center;
            padding: 80px 20px;
            color: #bbb;
            background-color: #fff;
        }

        /* --- NEW: Moments Comment MODAL (Updated) --- */
        #moments-comment-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1900;
            display: none; 
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #moments-comment-overlay.active {
            display: block;
            opacity: 1;
        }
        #moments-comment-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #F7F7F7; /* Input area background - Light Gray */
            padding: 10px 15px calc(10px + env(safe-area-inset-bottom, 0px));
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #moments-comment-modal.active {
            transform: translateY(0);
        }
        #moments-comment-input {
            flex: 1;
            height: 40px;
            padding: 0 15px;
            border-radius: 20px; /* Rounded rectangle */
            border: 1px solid #EAEAEA; /* Faint border */
            background-color: #FCFCFC; /* Near white/Very light gray */
            font-size: 15px;
            outline: none;
            color: #333;
            margin-bottom: 0;
        }
        #moments-comment-input::placeholder {
            color: #999;
        }
        #moments-comment-input:focus {
            background-color: #FFFFFF;
        }
        .moments-emoji-btn {
            width: 30px;
            height: 30px;
            object-fit: contain;
            cursor: pointer;
            flex-shrink: 0;
        }
        #moments-comment-submit-btn {
            border: none;
            background: none;
            color: var(--theme-pink-text);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            padding: 5px;
            white-space: nowrap;
        }


        /* --- Me Page 重构样式 --- */
        .me-page-container { width: 100%; display: flex; flex-direction: column; height: auto; max-height: 100vh; }
        .me-cover-area { width: 100%; height: 20vh; min-height: 260px; background-color: #ddd; background-size: cover; background-position: center; position: relative; cursor: pointer; transition: background-image 0.3s ease; }
        .me-cover-area::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(0,0,0,0.15)); pointer-events: none; }
        .me-like-wrapper { position: absolute; bottom: 5px; right: 20px; display: flex; flex-direction: column; align-items: center; gap: 4px; z-index: 5; }
        .me-setting-wrapper { position: absolute; top: 33px; right: 20px; z-index: 5; transition: top 0.3s ease; }
        .me-setting-icon { width: 24px; height: 24px; object-fit: contain; cursor: pointer; transition: transform 0.2s; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
        .me-setting-icon:active { transform: scale(0.9); }
        .me-like-icon { width: 24px; height: 24px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); cursor: pointer; transition: transform 0.2s; }
        .me-like-icon:active { transform: scale(1.2) rotate(-10deg); }
        .me-like-count { color: white; font-size: 13px; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.6); cursor: pointer; text-align: center; }
        .me-content-area { flex: 1; background-color: var(--chat-bg-color); position: relative; padding-top: 60px; }
        .me-floating-header { position: absolute; top: 0; left: 25px; width: calc(100% - 50px); transform: translateY(-50%); display: flex; align-items: center; z-index: 10; }
        .me-avatar-box { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; overflow: hidden; flex-shrink: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.15); background: #fff; transition: all 0.3s ease; }
        .me-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .me-text-col { margin-left: 15px; display: flex; flex-direction: column; justify-content: center; }
        .me-nickname { font-size: 20px; font-weight: 700; color: #FFFFFF; margin-bottom: 6px; cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .me-qq-id { font-size: 13px; color: #555; cursor: pointer; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
        .me-info-list { margin: 10px 20px; background: white; border-radius: 16px; padding: 5px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; }
        .me-list-item { display: flex; align-items: center; padding: 15px 20px; background: white; cursor: pointer; transition: background-color 0.2s; }
        .me-list-item:active { background-color: #f9f9f9; }
        .me-list-item:not(:last-child) { border-bottom: 1px solid #f5f5f5; }
        .me-list-icon { width: 24px; height: 24px; object-fit: contain; margin-right: 15px; transition: all 0.3s ease; }
        .me-list-text { flex: 1; font-size: 15px; color: #333; font-weight: 500; display: flex; align-items: center; overflow: hidden; }
        
        /* MODIFIED: CSS for arrow image */
        .me-list-arrow {
            width: 16px;
            height: 16px;
            margin-left: 10px;
        }

        .me-member-icons-row { display: flex; align-items: center; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; }
        .me-member-icons-row::-webkit-scrollbar { display: none; }
        .me-member-icon-slot { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; flex-shrink: 0; }

        /* --- Me Page Settings Modal --- */
        #me-settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--theme-pink-bg-light); z-index: 700; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: transform 0.3s ease, opacity 0.3s ease; transform: translateY(100%); }
        #me-settings-modal.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .me-settings-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 35px 20px 15px; background: white; box-shadow: 0 1px 5px rgba(0,0,0,0.05); flex-shrink: 0; transition: padding-top 0.3s ease; }
        .me-settings-header-title { font-size: 18px; font-weight: 600; color: #333; }
        .me-settings-close-btn { font-size: 16px; color: #666; cursor: pointer; background: none; border: none; }
        .me-settings-save-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 6px 16px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .me-settings-scroll-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .me-settings-group { background-color: white; border-radius: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); }
        .me-settings-group h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .me-settings-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .me-settings-label { width: 80px; font-size: 13px; color: #555; font-weight: 500; flex-shrink: 0; }
        .me-settings-preview-wrapper { flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .me-settings-preview { background-color: #f9f9f9; border: 1px solid #eee; background-size: cover; background-position: center; object-fit: contain; }
        .me-settings-preview.avatar { width: 40px; height: 40px; border-radius: 12px; }
        .me-settings-preview.cover { width: 60px; height: 40px; border-radius: 6px; object-fit: cover; }
        .me-settings-preview.icon { width: 30px; height: 30px; border-radius: 6px; }
        .me-settings-input { flex: 1; padding: 10px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; font-size: 13px; outline: none; transition: border-color 0.2s; color: #555; min-width: 0; }
        .me-settings-input:focus { border-color: var(--theme-pink-text); background-color: #fff; }

        /* --- Wallet App Style --- */
        #wallet-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #FDF6F9; z-index: 550;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.wallet-active #wallet-app-page { transform: translateY(0); }
        
        .wallet-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background-color: transparent; flex-shrink: 0;
            transition: padding-top 0.3s ease;
        }
        .wallet-user-area { display: flex; align-items: center; }
        .wallet-avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            margin-right: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid white; cursor: pointer;
        }
        .wallet-nickname { font-size: 16px; font-weight: 600; color: #333; cursor: pointer; }
        .wallet-close-btn {
            font-size: 14px; font-weight: 600; color: #999;
            background: rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; backdrop-filter: blur(5px);
        }
        .wallet-content {
            flex: 1; padding: 10px 20px 30px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
        }
        .wallet-balance-card {
            background: var(--wallet-gradient); border-radius: 24px; padding: 30px 25px;
            color: white; box-shadow: var(--wallet-card-shadow); position: relative;
            overflow: hidden; flex-shrink: 0; display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 180px;
        }
        .wallet-balance-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%); pointer-events: none;
        }
        .wallet-balance-label { font-size: 14px; opacity: 0.9; margin-bottom: 10px; font-weight: 500; }
        .wallet-balance-amount { font-size: 42px; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .wallet-stats-row { display: flex; gap: 15px; }
        .wallet-stat-box {
            flex: 1; background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column;
        }
        .wallet-stat-label { font-size: 13px; color: #888; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .wallet-stat-label.in::before { content: '↓'; color: var(--success-green); font-weight: bold; }
        .wallet-stat-label.out::before { content: '↑'; color: var(--error-red); font-weight: bold; }
        .wallet-stat-val { font-size: 18px; font-weight: 600; color: #333; }
        .wallet-actions { display: flex; gap: 15px; }
        .wallet-btn {
            flex: 1; padding: 15px; border-radius: 18px; border: none;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.1s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .wallet-btn:active { transform: scale(0.98); }
        .wallet-btn.income { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .wallet-btn.expense { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        .wallet-list-container {
            flex: 1; background: white; border-radius: 24px; padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02); min-height: 200px; display: flex; flex-direction: column;
        }
        .wallet-list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0;
        }
        .wallet-list-title { font-size: 16px; font-weight: 600; color: #333; }
        .wallet-month-badge { background: #f0f0f0; padding: 4px 10px; border-radius: 12px; font-size: 12px; color: #666; }
        .wallet-items-scroll { flex: 1; overflow-y: auto; }
        .wallet-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }
        .wallet-item:last-child { border-bottom: none; }
        .wallet-item-icon {
            width: 40px; height: 40px; border-radius: 12px; background: #FDF6F9;
            display: flex; justify-content: center; align-items: center; font-size: 20px; margin-right: 12px;
        }
        .wallet-item-info { flex: 1; }
        .wallet-item-cat { font-size: 15px; color: #333; font-weight: 500; margin-bottom: 4px; }
        .wallet-item-date { font-size: 12px; color: #999; }
        .wallet-item-amount { font-size: 16px; font-weight: 600; }
        .wallet-item-amount.in { color: var(--success-green); }
        .wallet-item-amount.out { color: var(--error-red); }
        .wallet-empty { text-align: center; color: #ccc; margin-top: 40px; font-size: 14px; }

        /* 记账弹窗 */
        #wallet-add-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 600;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        #wallet-add-modal.active { opacity: 1; pointer-events: auto; }
        .wallet-add-card {
            background: white; width: 85%; max-width: 320px; border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #wallet-add-modal.active .wallet-add-card { transform: scale(1); }
        .wallet-modal-title { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 20px; color: #333; }
        .wallet-input-group { margin-bottom: 15px; }
        .wallet-input { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee; background: #f9f9f9; font-size: 16px; outline: none; }
        .wallet-input:focus { background: white; border-color: var(--theme-pink-text); }
        .wallet-type-select { display: flex; gap: 10px; margin-bottom: 20px; }
        .wallet-type-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #eee; background: #fff; color: #666; font-size: 14px; cursor: pointer; transition: all 0.2s;
        }
        .wallet-type-btn.active.in { background: rgba(76, 175, 80, 0.1); border-color: var(--success-green); color: var(--success-green); font-weight: 600; }
        .wallet-type-btn.active.out { background: rgba(244, 67, 54, 0.1); border-color: var(--error-red); color: var(--error-red); font-weight: 600; }
        .wallet-confirm-btn { width: 100%; padding: 14px; background: var(--theme-pink-text); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .wallet-cancel-btn { width: 100%; padding: 10px; background: transparent; color: #999; border: none; margin-top: 10px; cursor: pointer; font-size: 14px; }

        /* --- 添加好友弹窗样式 --- */
        #add-friend-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        #add-friend-modal.active { opacity: 1; pointer-events: auto; }
        .add-friend-card { width: 80%; max-width: 320px; background: white; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; align-items: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; }
        #add-friend-modal.active .add-friend-card { transform: scale(1); }
        .add-friend-close { position: absolute; top: 15px; left: 15px; font-size: 24px; color: #999; cursor: pointer; line-height: 1; }
        .add-friend-save { position: absolute; top: 15px; right: 15px; width: 24px; height: 24px; cursor: pointer; transition: transform 0.2s; }
        .add-friend-save:active { transform: scale(0.9); }
        .add-friend-avatar-upload { width: 100px; height: 100px; border-radius: 50%; background-color: #f0f0f0; margin-top: 15px; margin-bottom: 10px; cursor: pointer; overflow: hidden; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; color: #ccc; font-size: 40px; }
        .add-friend-avatar-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        .add-friend-url-input { width: 100%; padding: 8px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; margin-bottom: 15px; font-size: 12px; outline: none; color: #666; text-align: center; }
        .add-friend-url-input::placeholder { color: #aaa; }
        .add-friend-input { width: 100%; padding: 12px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 12px; margin-bottom: 12px; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .add-friend-input:focus { border-color: var(--theme-pink-text); background-color: white; }

        /* --- 删除确认弹窗 (通用) --- */
        .delete-confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 800; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .delete-confirm-modal.active { opacity: 1; pointer-events: auto; }
        .delete-card { background: white; width: 80%; max-width: 280px; border-radius: 20px; padding: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); transform: scale(0.9); transition: transform 0.2s; }
        .delete-confirm-modal.active .delete-card { transform: scale(1); }
        .delete-card-title { font-size: 16px; font-weight: 500; color: #333; margin-bottom: 25px; }
        .delete-card-actions { display: flex; justify-content: space-around; gap: 10px; }
        .delete-card-btn { flex: 1; padding: 10px 0; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .btn-cancel { background: #f0f0f0; color: #666; }
        .btn-confirm-delete { background: #ffebee; color: #F44336; }


        /* --- 纯平面长椭圆底栏 (Chat App) --- */
        .chat-bottom-bar-container { position: fixed; bottom: calc(env(safe-area-inset-bottom, 20px) + 15px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; height: 64px; background-color: #FFFFFF; border-radius: 32px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.03); display: flex; justify-content: space-evenly; align-items: center; 
        z-index: 501; }
        .chat-nav-item { flex: 1; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0.5; transition: opacity 0.2s ease; }
        .chat-nav-item.active { opacity: 1; }
        .chat-nav-icon { width: 28px; height: 28px; object-fit: contain; pointer-events: none; }

        /* --- 全屏设置页面 --- */
        #settings-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--theme-pink-bg-light); z-index: 100; display: flex; flex-direction: column; padding: 20px 15px env(safe-area-inset-bottom, 20px) 15px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), padding-top 0.3s ease; overflow-x: hidden; }
        body.settings-active #settings-page { transform: translateY(0); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .settings-header .back-btn-container { display: flex; align-items: center; }
        .settings-header .title { font-size: 18px; font-weight: 600; color: #333; }
        #save-settings-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 8px 20px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .settings-content { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .settings-module { background-color: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); width: 100%; }
        .settings-module h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .settings-row { display: flex; flex-direction: column; align-items: stretch; margin-bottom: 15px; }
        .settings-row label { width: 100%; font-size: 14px; color: #555; margin-bottom: 6px; font-weight: 500; }
        .settings-row input, .settings-row button, .settings-row select { width: 100%; border: 1px solid #ddd; background-color: #f9f9f9; border-radius: 8px; padding: 10px; font-size: 14px; color: #333; outline: none; -webkit-appearance: none; min-width: 0; }
        .input-with-preview { display: flex; align-items: center; gap: 10px; width: 100%; }
        .input-with-preview input { flex: 1; min-width: 0; }
        .url-preview { width: 45px; height: 45px; border-radius: 8px; flex-shrink: 0; background-size: cover; background-position: center; border: 1px solid #eee; background-color: #f0f0f0; }
        .api-control-wrapper { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .api-control-row { display: flex; align-items: center; justify-content: space-between; }
        .api-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; }
        .api-status.connected { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .api-status.disconnected { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        .api-control-buttons { display: flex; gap: 10px; }
        .api-control-buttons button { flex: 1; white-space: nowrap; }
        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after { content: '▾'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }
        .settings-row select { padding-right: 30px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .temp-slider-container { display: flex; align-items: center; width: 100%; gap: 10px; }
        #temp-slider { flex: 1; padding: 0; height: 20px; }
        #temp-value-display { font-size: 14px; color: #555; min-width: 30px; text-align: right; }
        .app-icon-item { display: flex; align-items: center; margin-bottom: 12px; padding: 10px; border-radius: 12px; background-color: #f9f9f9; }
        .app-icon-preview { width: 40px; height: 40px; border-radius: 10px; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; background-size: cover; background-position: center; background-color: rgba(229, 138, 171, 0.1); }
        .app-icon-info { flex: 1; min-width: 0; }
        .app-icon-name { font-weight: 500; margin-bottom: 6px; color: #333; font-size: 13px; }
        .app-icon-input { display: flex; gap: 8px; }
        .app-icon-input input { flex: 1; min-width: 0; padding: 6px 8px; font-size: 12px; }
        .app-icon-input button { padding: 6px 12px; width: auto; font-size: 12px; background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; }
        
        /* --- iOS Mode Switch Styles (Generic row with switch) --- */
        .settings-row-with-switch {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0; /* Adjusted padding */
            margin-bottom: 5px;
        }
        .settings-row-with-switch > label {
            margin-bottom: 0;
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
            flex-shrink: 0;
        }
        .ios-switch input { opacity: 0; width: 0; height: 0; }
        .ios-switch .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s;
        }
        .ios-switch .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px;
            left: 2px; bottom: 2px; background-color: white; transition: .4s;
        }
        .ios-switch input:checked + .slider { background-color: #FFC0CB; }
        .ios-switch input:focus + .slider { box-shadow: 0 0 1px #FFC0CB; }
        .ios-switch input:checked + .slider:before { transform: translateX(20px); }
        .ios-switch .slider.round { border-radius: 34px; }
        .ios-switch .slider.round:before { border-radius: 50%; }
        
        /* --- MODIFIED: iOS Mode Active Global Styles --- */
        body.ios-mode-active #time-section { padding-top: env(safe-area-inset-top, 20px); }
        body.ios-mode-active .chat-app-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); } 
        body.ios-mode-active #role-settings-page { padding-top: calc(env(safe-area-inset-top, 20px) + 20px); }
        body.ios-mode-active .me-settings-header-bar { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .me-setting-wrapper { top: calc(env(safe-area-inset-top, 20px) + 20px); } /* MODIFIED: Move down setting icon on Me page */
        body.ios-mode-active .wallet-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active #settings-page { padding-top: env(safe-area-inset-top, 20px); }
        body.ios-mode-active .wb-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .wb-detail-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .wb-color-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .add-moment-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .forum-header-home, 
        body.ios-mode-active #forum-detail-header,
        body.ios-mode-active .forum-post-top-bar { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active #mall-app-page .mall-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .recollection-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .recollection-detail-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); }
        body.ios-mode-active .takeout-header { padding-top: calc(env(safe-area-inset-top, 20px) + 15px); } /* <-- 新增外卖App */
        
                /* --- 修复：转账页返回按钮位置更靠上 --- */
        .transfer-back-btn {
            position: absolute;
            /* 原来是 calc(env(...) + 20px)，现在直接改为 10px，让它贴近边缘 */
            top: 13px; 
            left: 20px;
            width: 30px; height: 30px;
            object-fit: contain; cursor: pointer;
            z-index: 900; /* 提高层级，防止被遮挡 */
        }

        #toast-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background-color: rgba(255, 230, 240, 0.98); color: #E58AAB; padding: 15px 25px; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; text-align: center; max-width: 80%; }
        #toast-notification.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .file-input-hidden { display: none; }

        /* AI Chat UI */
        #ai-chat-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #ai-chat-modal.active { opacity: 1; pointer-events: all; }
        #ai-chat-container { width: 90%; max-width: 500px; height: 80%; background-color: white; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #ai-chat-modal.active #ai-chat-container { transform: translateY(0); }
        .chat-header { padding: 15px 20px; background-color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .chat-header .model-name { font-weight: 600; color: #333; font-size: 16px; }
        .chat-header .close-btn { background: #f0f0f0; border: none; width: 28px; height: 28px; border-radius: 14px; font-size: 18px; cursor: pointer; color: #999; display: flex; align-items: center; justify-content: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background-color: #fcfcfc; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 14px; word-wrap: break-word; }
        .message.user { background-color: var(--theme-pink-text); color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background-color: #f0f0f0; color: #333; margin-right: auto; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 12px 15px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); border-top: 1px solid #f0f0f0; display: flex; gap: 10px; background-color: white; }
        .chat-input-area input { flex: 1; padding: 10px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 20px; font-size: 14px; outline: none; }
        .chat-input-area button { padding: 0 18px; background-color: var(--theme-pink-text); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; }

        /* --- World Book App Styles --- */
        #worldbook-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--theme-pink-bg-soft);
            z-index: 550;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.worldbook-active #worldbook-app-page { transform: translateY(0); }
        
        .wb-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border-radius: 0 0 25px 25px; z-index: 10;
            transition: padding-top 0.3s ease;
        }
        .wb-back-btn-img {
            width: 30px; height: 30px; object-fit: contain; cursor: pointer;
        }
        .wb-title { font-size: 18px; font-weight: 600; color: var(--theme-pink-title); letter-spacing: 0.5px; }
        .wb-header-actions { display: flex; align-items: center; gap: 15px; }
        .wb-action-icon { width: 24px; height: 24px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
        .wb-action-icon:hover { opacity: 1; }
        .wb-add-btn { font-size: 28px; color: var(--wb-plus-btn); cursor: pointer; line-height: 1; font-weight: 300; }
        
        .wb-content {
            flex: 1; padding: 20px; overflow-y: auto;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px; align-content: start;
        }
        .wb-book-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: transform 0.2s;
        }
        .wb-book-item:active { transform: scale(0.95); }
        
        .wb-book-cover {
            width: 90px; height: 120px;
            background: linear-gradient(135deg, #f5f5f5 0%, #EAEAEA 100%);
            border-radius: 4px 8px 8px 4px;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.1), inset 4px 0 10px rgba(0,0,0,0.05);
            display: flex; justify-content: center; align-items: center; padding: 10px;
            position: relative; overflow: hidden; border: 1px solid rgba(0,0,0,0.08);
            transition: background 0.3s;
            background-size: cover;
            background-position: center;
        }
        .wb-book-cover::before {
            content: ''; position: absolute; left: 4px; top: 0; width: 2px; height: 100%;
            background: rgba(0,0,0,0.05); box-shadow: 2px 0 0 rgba(0,0,0,0.05);
        }
        .wb-book-name { font-size: 13px; font-weight: 600; color: #555; text-align: center; word-break: break-all; line-height: 1.4; text-shadow: 0 1px 2px rgba(255,255,255,0.8); }

        #worldbook-add-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 600; backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #worldbook-add-modal.active { opacity: 1; pointer-events: auto; }
        .wb-modal-card {
            background: var(--theme-pink-bg-soft);
            width: 90%; max-width: 380px;
            border-radius: 20px; padding: 25px;
            box-shadow: 0 8px 30px rgba(229, 138, 171, 0.25);
            max-height: 85vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #worldbook-add-modal.active .wb-modal-card { transform: scale(1); }
        .wb-modal-header { font-size: 17px; font-weight: 600; color: var(--theme-pink-text); text-align: center; margin-bottom: 20px; flex-shrink: 0; }
        
        .wb-modal-scroll-area { flex: 1; overflow-y: auto; margin: -10px -10px 15px; padding: 10px 10px 0; }
        
        .wb-input-label { font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 600; padding-left: 5px; }
        .wb-main-input { width: 100%; padding: 12px; border: 1px solid #FADBE6; background: #fff; border-radius: 12px; outline: none; font-size: 15px; margin-bottom: 15px; }
        .wb-main-input:focus { border-color: var(--theme-pink-btn); box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3); }

        .wb-entry-row {
            display: flex; flex-direction: column; gap: 8px; margin-top: 15px; padding: 15px;
            background-color: #ffffff; border-radius: 12px; border: 1px solid #FADBE6;
        }
        .wb-entry-input {
            width: 100%; border: none; background: #f9f9f9;
            border-radius: 8px; padding: 10px; font-size: 14px;
            outline: none; transition: all 0.2s;
        }
        .wb-entry-input.val { min-height: 120px; resize: vertical; line-height: 1.5; }
        .wb-entry-input:focus { background: white; border-color: var(--theme-pink-btn); box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3); }
        
        .wb-plus-row-btn {
            width: 100%; padding: 10px; margin-top: 15px; border: 2px dashed #FDCEDF; background: transparent;
            color: var(--theme-pink-btn); border-radius: 12px; cursor: pointer; font-size: 22px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        .wb-plus-row-btn:active { background: rgba(253, 206, 223, 0.3); }
        
        .wb-modal-actions { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; flex-shrink: 0; }
        .wb-action-btn { padding: 10px 25px; border-radius: 20px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; }
        .wb-btn-cancel { background: transparent; color: #aaa; }
        .wb-btn-ok { background: var(--theme-pink-btn); color: white; box-shadow: 0 4px 10px rgba(245, 179, 201, 0.4); }

        #worldbook-detail-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--theme-pink-bg-soft); z-index: 650;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #worldbook-detail-modal.active { transform: translateX(0); }
        .wb-detail-header {
             padding: 35px 20px 15px;
             display: flex; align-items: center; gap: 15px; background: white;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-shrink: 0;
             transition: padding-top 0.3s ease;
        }
        .wb-detail-back { font-size: 24px; color: #333; cursor: pointer; }
        .wb-detail-title { flex: 1; font-size: 18px; font-weight: 600; color: var(--theme-pink-text); }
        .wb-delete-book-btn {
            background-color: var(--theme-pink-btn); color: white;
            padding: 6px 16px; border-radius: 15px; border: none; font-size: 14px;
            font-weight: 500; cursor: pointer; transition: opacity 0.2s; white-space: nowrap;
        }
        .wb-delete-book-btn:active { opacity: 0.8; }
        
        .wb-detail-content { flex: 1; padding: 20px; overflow-y: auto; }
        .wb-detail-item {
            margin-bottom: 15px; background: white; border-radius: 12px;
            padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }
        .wb-detail-item-content { flex: 1; }
        .wb-detail-key { font-size: 13px; color: #999; font-weight: 500; margin-bottom: 6px; }
        .wb-detail-val { font-size: 16px; color: #333; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }

        .wb-detail-item-actions { display: flex; gap: 10px; align-self: flex-end; margin-top: 15px; }
        .wb-detail-item-actions button {
            background: #f0f0f0; border: none; border-radius: 8px; padding: 5px 12px;
            font-size: 12px; color: #666; cursor: pointer;
        }
        .wb-detail-item-actions button.save { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); }
        .wb-detail-item .edit-form textarea { min-height: 80px; }


        #worldbook-color-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--theme-pink-bg-light); z-index: 700;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #worldbook-color-page.active { transform: translateY(0); }
        .wb-color-header {
            padding: 35px 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: white; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: padding-top 0.3s ease;
        }
        .wb-color-title { font-size: 18px; font-weight: 600; color: var(--theme-pink-text); }
        .wb-color-save-btn {
            background-color: var(--theme-pink-btn); color: white; border: none; border-radius: 15px;
            padding: 8px 20px; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .wb-color-content { flex: 1; overflow-y: auto; padding: 20px; }
        .wb-color-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        .wb-color-item-name { font-size: 15px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .wb-color-input {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 40px; height: 40px; background: none; border: none;
            cursor: pointer; padding: 0; border-radius: 8px;
        }
        .wb-color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .wb-color-input::-webkit-color-swatch { border: 1px solid #ddd; border-radius: 8px; }
        .wb-color-input::-moz-color-swatch { border: 1px solid #ddd; border-radius: 8px; }
        .wb-cover-upload-btn {
            padding: 6px 12px; background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text);
            border-radius: 8px; font-size: 12px; border: none; cursor: pointer;
        }


        #worldbook-bind-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 900; /* MODIFIED: Increased z-index */ backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #worldbook-bind-modal.active { opacity: 1; pointer-events: auto; }
        .wb-bind-modal-card {
            background: white;
            width: 85%; max-width: 340px; border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            max-height: 70vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #worldbook-bind-modal.active .wb-bind-modal-card { transform: scale(1); }
        .wb-bind-modal-header {
            padding: 15px 20px;
            font-size: 16px; font-weight: 600; color: var(--theme-pink-text);
            text-align: center; border-bottom: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .wb-bind-modal-header .close-btn {
            font-size: 20px; color: #aaa; cursor: pointer;
        }
        .wb-bind-modal-list {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .wb-bind-list-item {
            padding: 15px;
            font-size: 15px; color: #333;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .wb-bind-list-item:last-child {
            border-bottom: none;
        }
        .wb-bind-list-item:hover {
            background-color: #f9f9f9;
        }
        .wb-bind-list-item:active {
            background-color: #f0f0f0;
        }
        .wb-bind-list-empty {
            text-align: center; color: #ccc;
            padding: 40px 20px; font-size: 14px;
        }
        .wb-bind-modal-actions {
            display: none; /* Hide by default */
            padding: 10px 20px;
            border-top: 1px solid #f0f0f0;
            justify-content: flex-end;
        }
        .wb-bind-modal-card.multi-select-mode .wb-bind-modal-actions {
            display: flex; /* Show in multi-select mode */
        }
        .wb-bind-list-item.multi {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .wb-bind-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #ddd;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            transition: all 0.2s ease;
        }
        .wb-bind-checkbox.checked {
            background: var(--theme-pink-btn);
            border-color: var(--theme-pink-btn);
        }
        .wb-bind-checkbox.checked::after {
            content: '✓';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        /* --- NEW: Moments Action Sheet (Popup) --- */
        #moments-action-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            backdrop-filter: blur(2px);
        }
        #moments-action-sheet-overlay.active { opacity: 1; pointer-events: auto; }
        
        #moments-action-sheet {
            background-color: var(--theme-pink-bg-soft);
            width: 95%; max-width: 400px;
            margin: 0 auto 15px; /* Bottom margin */
            border-radius: 20px;
            overflow: hidden;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        #moments-action-sheet-overlay.active #moments-action-sheet { transform: translateY(0); }
        
        .action-sheet-option {
            background: white;
            padding: 18px;
            text-align: center;
            font-size: 16px;
            color: #333;
            font-weight: 500;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .action-sheet-option:active { background-color: #f9f9f9; }
        .action-title { font-size: 16px; color: #333; }
        .action-subtitle { font-size: 12px; color: #999; margin-top: 2px; }
        
        .action-sheet-cancel {
            background: white;
            padding: 18px;
            text-align: center;
            font-size: 16px;
            color: #333;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px; /* Visual separation */
            border-radius: 20px;
        }
        .action-sheet-cancel:active { background-color: #f9f9f9; }

        /* --- NEW/MODIFIED: Forum App Styles --- */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        #forum-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #FFF5F7; /* 极浅粉背景 */
            z-index: 560;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.forum-active #forum-app-page {
            transform: translateY(0);
        }

        #forum-content-wrapper {
            flex: 1;
            overflow-y: hidden; /* Prevent scrolling on the main wrapper */
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .forum-page {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            overflow-y: auto; /* Allow individual pages to scroll */
            padding-bottom: 100px;
        }
        .forum-page.active {
            display: flex;
        }
        
        /* 论坛首页专属顶部栏 */
        .forum-header-home {
            padding: 15px 15px 10px 15px;
            background-color: #fff;
            border-radius: 0 0 24px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 15;
            box-shadow: 0 4px 15px rgba(200, 150, 160, 0.08);
            flex-shrink: 0;
        }
        
        .forum-header-back-btn,
        .forum-header-create-btn,
        .forum-header-refresh-btn {
            width: 30px; height: 30px;
            object-fit: contain; cursor: pointer; flex-shrink: 0;
        }

        .forum-header-title {
            font-size: 18px; font-weight: 600; color: #f5b3c9;
        }

        /* 论坛列表 (4xN Grid) */
        #forum-list-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px 15px;
            flex-shrink: 0;
        }
        
        .forum-list-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .forum-list-item:active {
            transform: scale(0.95);
        }
        .forum-list-avatar {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 18px;
            object-fit: cover;
            background-color: #f0f0f0;
            box-shadow: 0 4px 10px rgba(229, 138, 171, 0.2);
        }
        .forum-list-name {
            font-size: 13px;
            font-weight: 600;
            color: #555;
            width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 帖子区 */
        #forum-posts-area, #forum-detail-posts-area {
            padding: 0 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        /* MODIFIED: Added padding-top */
        #forum-detail-posts-area {
            padding-top: 15px;
        }
        .forum-post-card {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }
        .forum-post-header {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
        }
        .forum-post-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .forum-post-user-info { display: flex; flex-direction: column; }
        .forum-post-user { font-size: 14px; font-weight: 600; color: #333; }
        .forum-post-level {
            background-color: #F8C8DC; color: white;
            font-size: 10px; font-weight: bold;
            padding: 2px 6px; border-radius: 4px;
            margin-left: 6px;
            display: inline-block;
        }
        .forum-post-time { font-size: 12px; color: #999; margin-left: auto; }
        
        /* MODIFIED for preview content and tags */
        .forum-post-content {
            font-size: 15px; 
            line-height: 1.5; 
            color: #444; 
            white-space: pre-wrap; 
            word-break: break-word;
        }
        .forum-post-content.truncated {
            max-height: 100px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        .forum-post-content.truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: linear-gradient(to bottom, transparent, white);
            pointer-events: none;
        }
        .forum-post-tags {
            margin-top: 8px;
            font-size: 13px;
            color: var(--link-blue);
            word-break: break-all;
        }
        
        .forum-post-actions {
            display: flex;
            justify-content: space-around;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid #f5f5f5;
        }
        .forum-post-action-btn {
            display: flex; align-items: center; gap: 5px;
            color: #888; font-size: 13px; cursor: pointer;
        }
        .forum-post-action-btn img {
            width: 20px; height: 20px; object-fit: contain;
        }

        /* NEW: Styles for generated post feedback */
        .forum-post-feedback {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f5f5f5;
        }
        .forum-post-feedback.hidden {
            display: none;
        }
        .forum-post-comments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .forum-post-comment-item {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px; /* Square with rounded corners */
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }
        .comment-body {
            flex: 1;
            min-width: 0;
        }
        .comment-nickname {
            font-size: 13px;
            font-weight: 600;
            color: var(--moments-nickname-color);
            margin-bottom: 2px;
        }
        .comment-text {
            font-size: 14px;
            line-height: 1.4;
            color: #444;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .comment-reply-tag {
            color: var(--link-blue);
            font-weight: 500;
        }

        /* Forum Detail Page Styles */
        #forum-detail-header {
            padding: 15px; background-color: #fff;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 15;
            box-shadow: 0 4px 15px rgba(200, 150, 160, 0.08);
            border-radius: 0 0 24px 24px;
            flex-shrink: 0;
            gap: 10px; /* MODIFIED: Added gap for spacing */
        }
        /* Forum Square Avatar */
        .forum-detail-header-avatar {
             width: 32px; height: 32px;
             border-radius: 6px; 
             object-fit: cover; 
             margin-right: 10px; margin-left: 5px;
             background-color: #eee;
             flex-shrink: 0;
        }
        #forum-detail-header-name {
            font-size: 18px; 
            font-weight: 600; 
            color: #555;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            flex-shrink: 1; /* MODIFIED: Allow name to shrink */
        }
        #forum-detail-signin-btn {
            padding: 6px 12px; border: 1px solid var(--theme-pink-btn);
            color: var(--theme-pink-btn); background-color: transparent;
            border-radius: 15px; font-size: 13px; font-weight: 600;
            cursor: pointer; white-space: nowrap;
        }
        #forum-detail-signin-btn:disabled {
            border-color: #ccc; color: #ccc; cursor: not-allowed;
        }
        #forum-detail-header .actions { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-left: auto; /* MODIFIED: Pushes to the right */
        }
        
        /* NEW: Level and XP Bar Styles */
        #forum-detail-level-display { display: flex; align-items: center; gap: 8px; }
        .forum-exp-bar-wrapper { 
            position: relative; 
            width: 70px; 
            height: 8px; 
            background-color: #f0f0f0; 
            border-radius: 4px; 
            overflow: hidden; 
        }
        .forum-exp-bar-progress { 
            height: 100%; 
            background-color: var(--theme-pink-btn); 
            border-radius: 4px;
            width: 0%; /* JS will set this */
            transition: width 0.3s ease;
        }


        /* New Forum Post Interface Styles */
        #forum-page-post { background-color: #FFF5F7; }
        .forum-post-top-bar {
            padding: 15px 20px 10px;
            display: flex; justify-content: space-between; align-items: center;
            background-color: #FFF5F7; flex-shrink: 0; position: sticky; top: 0; z-index: 10;
        }
        .forum-post-cancel { border: none; background: none; font-size: 16px; color: #888; cursor: pointer; }
        .forum-post-title { font-size: 17px; font-weight: 600; color: #333; }
        .forum-post-submit { 
            background-color: #F8C8DC; color: #333; border: none; 
            padding: 6px 15px; border-radius: 20px; font-weight: 600; font-size: 14px; cursor: pointer;
        }
        .forum-post-editor {
            flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }
        .forum-selector-wrapper {
            background: white; padding: 10px 15px; border-radius: 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        .forum-selector-label { font-size: 14px; color: #666; font-weight: 500; }
        .forum-selector-select {
            border: none; background: transparent; font-size: 14px; color: #E58AAB; font-weight: 600; outline: none; text-align: right;
        }
        .forum-post-textarea {
            width: 100%; min-height: 150px; background: transparent; border: none; outline: none;
            font-size: 16px; line-height: 1.5; color: #333; resize: none;
        }
        .forum-post-image-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .forum-post-add-img {
            aspect-ratio: 1/1; background-color: rgba(253, 206, 223, 0.3); border-radius: 12px;
            display: flex; justify-content: center; align-items: center; color: #FDCEDF; font-size: 32px; cursor: pointer;
        }
        .forum-post-img-preview {
            aspect-ratio: 1/1; border-radius: 12px; overflow: hidden; position: relative;
        }
        .forum-post-img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .forum-post-img-remove {
            position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
            background: rgba(0,0,0,0.5); border-radius: 50%; color: white;
            display: flex; justify-content: center; align-items: center; font-size: 12px; cursor: pointer;
        }


        /* 悬浮胶囊底栏 */
        #forum-bottom-nav {
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 20px) + 15px);
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 360px;
            height: 65px;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 999px; /* Capsule shape */
            box-shadow: 0 8px 25px rgba(200, 150, 160, 0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 20;
        }
        .forum-nav-item {
            flex: 1;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .forum-nav-item:active {
            transform: scale(0.9);
        }
        .forum-nav-icon {
            width: 28px;
            height: 28px;
            object-fit: contain;
            opacity: 0.4;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        .forum-nav-item.active .forum-nav-icon {
            opacity: 1;
            transform: scale(1.1);
        }

        /* --- 创建论坛弹窗 --- */
        #create-forum-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 850;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        #create-forum-modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #create-forum-modal-card {
            background: #FFF8FA;
            width: 90%; max-width: 350px;
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex; flex-direction: column;
            gap: 15px;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #create-forum-modal-overlay.active #create-forum-modal-card {
            transform: scale(1);
        }
        .create-forum-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--theme-pink-text);
            text-align: center;
            margin-bottom: 5px;
        }
        .create-forum-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .create-forum-avatar-upload {
            width: 90px;
            height: 90px;
            border-radius: 16px; /* square with rounded corners */
            border: 2px dashed #FDCEDF;
            background-color: rgba(253, 206, 223, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            color: #FDCEDF;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        #new-forum-avatar-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            position: absolute;
            top: 0; left: 0;
        }
        .create-forum-input, .create-forum-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #FADBE6;
            background: #fff;
            border-radius: 12px;
            outline: none;
            font-size: 15px;
            color: #333;
        }
        .create-forum-input:focus, .create-forum-textarea:focus {
            border-color: var(--theme-pink-btn);
            box-shadow: 0 0 0 2px rgba(245, 179, 201, 0.3);
        }
        .create-forum-textarea {
            min-height: 100px;
            resize: vertical;
            line-height: 1.5;
        }
        .create-forum-wb-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background-color: var(--theme-pink-bg-med);
            color: var(--theme-pink-text);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        #new-forum-wb-selection-display, #new-forum-role-selection-display {
            width: 100%;
            padding: 10px;
            font-size: 13px;
            color: #999;
            background-color: #f9f9f9;
            border-radius: 8px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .create-forum-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .create-forum-btn {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .create-forum-btn.cancel {
            background: #eee;
            color: #888;
        }
        .create-forum-btn.confirm {
            background: var(--theme-pink-btn);
            color: white;
        }

        /* Forum Me Page New Styles */
        #forum-me-nickname {
            font-size: 22px;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            margin-bottom: 5px;
            /* Removed contenteditable styles */
        }
        .forum-me-menu-list {
            margin: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            overflow: hidden;
        }
        .forum-me-menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f9f9f9;
            cursor: pointer;
        }
        .forum-me-menu-item:last-child { border-bottom: none; }
        .forum-me-menu-item .menu-item-left {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 15px; color: #333; font-weight: 500;
        }

        /* MODIFIED: CSS for arrow image */
        .forum-me-menu-item .arrow {
            width: 16px;
            height: 16px;
        }

        .bound-chars-row {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .bound-chars-row img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* Styles for Forum Me Settings Modal */
        #forum-me-settings-modal {
            background-color: rgba(0,0,0,0.4);
            z-index: 950; /* High z-index */
        }
        #forum-bind-character-list .character-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        #forum-bind-character-list .character-item:hover { background-color: #f0f0f0; }
        #forum-bind-character-list .character-item input[type=checkbox] { 
            width: 18px; height: 18px; margin-right: 12px; accent-color: var(--theme-pink-text); 
        }
        #forum-bind-character-list .character-item img { 
            width: 32px; height: 32px; border-radius: 6px; margin-right: 10px; object-fit: cover; 
        }
        #forum-bind-character-list .character-item span {
            font-size: 14px;
            color: #333;
        }

        /* --- Mall App Styles (MODIFIED & NEW) --- */
        #mall-app-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #ffffff; /* 白色背景 */
            z-index: 555;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.mall-active #mall-app-page {
            transform: translateY(0);
        }

        .mall-header {
            padding: 35px 20px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff; /* 纯白色背景 */
            flex-shrink: 0;
            border-bottom: 1px solid var(--text-light-gray, #f0f0f0);
            transition: padding-top 0.3s ease;
            position: relative; /* For title centering */
            z-index: 10;
        }
        .mall-header .back-btn {
            width: 30px;
            height: 30px;
            object-fit: contain;
            cursor: pointer;
        }
        .mall-header-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--theme-pink-title); /* 浅粉色 #f5b3c9 */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .mall-header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .mall-header-actions .refresh-btn {
            width: 24px;
            height: 24px;
            object-fit: contain;
            cursor: pointer;
        }
        .mall-add-btn {
            width: 32px;
            height: 32px;
            background-color: var(--theme-pink-btn); /* 粉色背景 #F5B3C9 */
            border: none;
            border-radius: 50%;
            color: white; /* 白色图标 */
            font-size: 22px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            line-height: 1;
            padding-bottom: 2px; /* Visual centering for '+' */
        }

        .mall-category-nav {
            display: flex;
            overflow-x: auto;
            background-color: #fff;
            padding: 0 15px;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0; /* 浅灰色分割线 */
        }
        /* Hide scrollbar */
        .mall-category-nav::-webkit-scrollbar { display: none; }
        .mall-category-nav { scrollbar-width: none; }

        .mall-category-item {
            padding: 12px 10px;
            font-size: 15px;
            font-weight: 500;
            color: var(--theme-pink-text); /* 未选中：浅粉色文字 #E58AAB */
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            flex-shrink: 0;
            margin: 0 5px;
            user-select: text; /* Allow text selection for double click */
        }
        .mall-category-item.active {
            font-weight: 700;
            color: var(--theme-pink-text);
        }
        .mall-category-item.active::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background-color: var(--theme-pink-btn);
            border-radius: 1.5px;
        }
        
        .mall-content {
            flex: 1;
            overflow-y: auto;
            background-color: var(--theme-pink-bg-soft); /* 柔和粉色系背景 */
            padding: 20px;
            color: #333; /* 深灰色常规文字 */
            padding-bottom: 80px;
        }
        
        /* NEW: Mall Product Grid */
        .mall-product-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .mall-product-item {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .product-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px; /* For Emoji */
        }
        .product-details {
            padding: 10px;
        }
        .product-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            /* MODIFIED FOR TAOBAO STYLE */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 2.8em; /* 1.4em * 2 lines */
            line-height: 1.4em;
            white-space: normal;
        }
        .product-price-info {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
        }
        .product-price {
            color: #ff952f;
            font-size: 18px;
            font-weight: bold;
        }
        .product-price::before {
            content: '¥';
            font-size: 14px;
            margin-right: 2px;
        }
        .product-price-extra {
            display: flex;
            align-items: baseline;
            gap: 5px;
        }
        .product-coupon-tag {
            font-size: 11px;
            color: #ff952f;
        }
        .product-sales {
            font-size: 12px;
            color: #a19f9b;
        }

        /* NEW: Mall Modals */
        #mall-category-modal .wb-entry-input.val,
        #mall-category-desc-input {
            background-color: #ffffff;
            border: 1px solid #FADBE6;
        }

        #new-mall-category-roles-display,
        #edit-mall-category-roles-display {
            background: #fff;
            border: 1px solid #FADBE6;
        }
        #new-mall-category-roles-display.unbound,
        #edit-mall-category-roles-display.unbound {
            color: #aaa;
            font-style: italic;
        }
                /* --- NEW: Mall Detail Page Styles --- */
        #mall-detail-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f7f7f7;
            z-index: 556;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
        }
        #mall-detail-page.active {
            transform: translateX(0);
        }
        .mall-detail-header {
            padding: 35px 20px 15px;
            display: flex;
            align-items: center;
            background-color: #fff;
            flex-shrink: 0;
            border-bottom: 1px solid #f0f0f0;
            position: relative;
        }
        body.ios-mode-active #mall-detail-page .mall-detail-header {
             padding-top: calc(env(safe-area-inset-top, 20px) + 15px);
        }
         body.phone-frame-active #mall-detail-page .mall-detail-header {
            padding-top: calc(15px + var(--status-bar-height));
        }
        .mall-detail-header .back-btn {
            width: 30px; height: 30px; object-fit: contain; cursor: pointer;
        }
        .mall-detail-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 80px; /* 为底部按钮留出空间 */
        }
        .mall-detail-img-container {
            background-color: #fff;
            padding: 40px 20px;
            text-align: center;
            font-size: 120px;
        }
        .mall-detail-info-card {
            background-color: #fff;
            padding: 20px;
            margin-top: 10px;
        }
        .mall-detail-price {
            color: #ff5000;
            font-size: 28px;
            font-weight: bold;
        }
        .mall-detail-price::before {
            content: '¥';
            font-size: 16px;
            margin-right: 4px;
        }
        .mall-detail-name {
            font-size: 18px;
            font-weight: 500;
            color: #333;
            line-height: 1.4;
            margin-top: 10px;
        }
        .mall-detail-sales {
            font-size: 13px;
            color: #999;
            margin-top: 8px;
        }
        .mall-detail-reviews-card {
            background-color: #fff;
            padding: 20px;
            margin-top: 10px;
        }
        .mall-detail-reviews-card h3 {
            font-size: 16px;
            margin-bottom: 15px;
            border-left: 4px solid var(--theme-pink-btn);
            padding-left: 10px;
        }
        .review-item {
            padding: 15px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .review-item:last-child {
            border-bottom: none;
        }
        .review-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .review-nickname {
            font-size: 14px;
            font-weight: 500;
        }
        .review-stars {
            font-size: 14px;
            color: #ffd700; /* 星星颜色 */
        }
        .review-content {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }
        .mall-detail-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: calc(60px + env(safe-area-inset-bottom, 0));
            padding-bottom: env(safe-area-inset-bottom, 0);
            background-color: #fff;
            border-top: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            padding-top: 5px;
            z-index: 10;
        }
        .mall-detail-footer .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            width: 60px;
        }
                .mall-detail-footer .footer-btn.favorite img,
        .mall-detail-footer .footer-btn.cart img { /* <-- 新增这一行 */
            width: 24px;
            height: 24px;
            margin-top: 4px;
            object-fit: contain;
        }
        .mall-detail-footer .footer-btn span {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        .mall-detail-footer .footer-btn.buy {
            flex: 1;
            background-color: var(--theme-pink-btn);
            color: white;
            font-size: 16px;
            font-weight: 600;
            border-radius: 20px;
            margin: 8px;
            height: 44px;
        }
        .mall-detail-footer .footer-btn.buy span {
            color: white;
            font-size: 16px;
            margin: 0;
        }
        .mall-bottom-nav {
            background-color: #ffffff;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-around;
            padding: 5px 0 calc(5px + env(safe-area-inset-bottom, 0));
            flex-shrink: 0;
        }
        .mall-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex: 1;
            padding: 5px 0;
        }
        .mall-nav-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }
        .mall-nav-text {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        .mall-nav-item.active .mall-nav-text {
            color: var(--theme-pink-text);
        }
        
/* ========================= 新增：商品购买弹窗样式 ========================= */
#mall-purchase-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4);
    z-index: 557; /* 要比商品详情页的层级高 */
    display: flex;
    justify-content: center;
    align-items: flex-end;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

#mall-purchase-overlay.active {
    opacity: 1;
    pointer-events: auto;
}

#mall-purchase-panel {
    background-color: #f7f7f7; /* 浅灰色背景，更有层次感 */
    width: 100%;
    height: 55%; /* 占屏幕一半多一点，视觉效果更好 */
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex;
    flex-direction: column;
}

#mall-purchase-overlay.active #mall-purchase-panel {
    transform: translateY(0);
}

.mall-purchase-header {
    display: flex;
    align-items: flex-start;
    padding: 20px;
    border-bottom: 1px solid #eee;
    flex-shrink: 0;
    position: relative;
}

#mall-purchase-product-emoji {
    font-size: 80px;
    width: 100px;
    height: 100px;
    background-color: #fff;
    border-radius: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: -40px; /* 向上突出一部分，更有立体感 */
    border: 1px solid #eee;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.mall-purchase-product-info {
    margin-left: 15px;
    flex-grow: 1;
}

#mall-purchase-product-price {
    color: #ff5000;
    font-size: 24px;
    font-weight: bold;
}
#mall-purchase-product-price::before {
    content: '¥';
    font-size: 14px;
    margin-right: 2px;
}

#mall-purchase-quantity-selector {
    display: flex;
    align-items: center;
    margin-top: 15px;
}
#mall-purchase-quantity-selector .quantity-btn {
    width: 28px;
    height: 28px;
    border: 1px solid #ddd;
    background-color: #fff;
    border-radius: 4px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    color: #555;
    line-height: 26px;
}
#mall-purchase-quantity-selector #mall-purchase-quantity {
    min-width: 40px;
    text-align: center;
    font-size: 16px;
    font-weight: 500;
}

#mall-purchase-close-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 20px;
    color: #999;
    cursor: pointer;
}

.mall-purchase-body {
    flex: 1;
    overflow-y: auto;
    padding: 15px 20px;
}

.mall-purchase-styles-section .section-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 12px;
}

#mall-purchase-styles-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.style-option-btn {
    padding: 8px 15px;
    border: 1px solid #ddd;
    background-color: #fff;
    color: #333;
    border-radius: 15px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
}
.style-option-btn.active {
    border-color: var(--theme-pink-btn, #F5B3C9);
    background-color: var(--theme-pink-bg-med, rgba(229, 138, 171, 0.15));
    color: var(--theme-pink-text, #E58AAB);
    font-weight: 500;
}

.mall-purchase-footer {
    padding: 10px 20px calc(10px + env(safe-area-inset-bottom, 20px));
    border-top: 1px solid #eee;
    background-color: #fff;
    flex-shrink: 0;
}

#mall-purchase-confirm-btn {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 25px;
    background-color: var(--theme-pink-btn, #F5B3C9);
    color: white;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
/* ========================= 新增样式结束 ========================= */
        /* --- [REFACTORED] Transfer Page Styles --- */
        #transfer-page {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #ffabce; /* Top part's color is the new page background */
            z-index: 800;
            display: flex; flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
            padding: 0;
        }
        #transfer-page.active {
            transform: translateX(0);
        }
        .transfer-page-top {
            height: 15vh; /* [FIXED] Reduced height */
            min-height: 130px; /* [FIXED] Reduced min-height */
            background-color: #ffabce;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 0 20px 20px;
            position: relative;
            flex-shrink: 0;
        }
        .transfer-page-bottom {
            flex: 1;
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 30px 20px calc(20px + env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
        }
        .transfer-title-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #transfer-target-name-container {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }
        .transfer-target-avatar {
            width: 60px; height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
        .transfer-amount-title {
            font-size: 15px;
            color: #000;
            margin-bottom: 20px;
            margin-top: 15px;
        }
        .transfer-amount-input-area {
            display: flex;
            align-items: baseline;
            border-bottom: 1px solid #f0d8e2;
            padding-bottom: 15px;
        }
        .transfer-currency-symbol {
            font-size: 2.5rem;
            font-weight: bold;
            color: #000;
        }
        .transfer-amount-input {
            flex: 1;
            width: auto;
            border: none;
            background: transparent;
            outline: none;
            font-size: 3.5rem;
            font-weight: bold;
            color: #000;
            margin-left: 10px;
            padding: 0;
            -moz-appearance: textfield;
        }
        .transfer-amount-input::-webkit-outer-spin-button,
        .transfer-amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* --- [REFACTORED] Transfer Confirmation Popup Styles --- */
        #transfer-confirm-overlay {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 850;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #transfer-confirm-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #transfer-confirm-popup {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #transfer-confirm-overlay.active #transfer-confirm-popup {
            transform: translateY(0);
        }
        .confirm-popup-header {
            padding: 15px;
            text-align: center;
            position: relative;
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .confirm-popup-close {
            position: absolute;
            left: 15px; top: 50%;
            transform: translateY(-50%);
            width: 24px; height: 24px;
            cursor: pointer;
        }
        .confirm-popup-content {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        #confirm-transfer-target {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
        }
        #confirm-transfer-amount {
            font-size: 36px;
            font-weight: bold;
            color: #000;
            margin-bottom: 20px;
        }
        .confirm-payment-method {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            padding-top: 15px;
        }
        .confirm-payment-method > span {
            font-size: 15px; color: #888;
        }
        .payment-method-details {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #fffaf3; /* 浅米黄色 */
            padding: 8px 12px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        .payment-icon { width: 20px; height: 20px; }
        .payment-method-details > span { font-size: 15px; color: #333; }
        .payment-check { width: 16px; height: 16px; margin-left: 5px; }

        .password-input-section {
            padding: 20px;
            text-align: center;
            background: #ffffff;
        }
        .password-input-section p {
            font-size: 15px;
            color: #333;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .password-boxes {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .password-box {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 12px; 
            background: #f6f2f4; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        .password-box.filled::after {
            content: '●';
            color: #333;
        }
        .password-error-tip {
            color: var(--error-red);
            height: 1.2em;
            font-size: 13px !important;
            margin-bottom: 0 !important;
        }

        .numeric-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background-color: #f6f2f4;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .keypad-btn {
            padding: 15px 0;
            font-size: 24px;
            border: none;
            background-color: #fff;
            cursor: pointer;
            margin: 0.5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            color: #000;
        }
        .keypad-btn:active {
            background-color: #d1d5db;
        }
        .keypad-btn.blank, .keypad-btn.delete {
            background-color: transparent;
            box-shadow: none;
        }
        .keypad-btn.delete img {
            width: 28px; height: 28px;
            pointer-events: none;
        }

                /* --- 3. 手机框模式下：支付密码弹窗的强力修复 --- */
        
        /* 缩小整个弹窗的头部内边距 */
        body.phone-frame-active .confirm-popup-header {
            padding: 10px 10px 5px 10px;
            font-size: 15px;
        }

        /* 缩小内容区域（转账对象和金额）的间距 */
        body.phone-frame-active .confirm-popup-content {
            padding: 10px 15px;
        }
        
        /* 缩小显示的金额字体 */
        body.phone-frame-active #confirm-transfer-amount {
            font-size: 26px !important;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* 调整“付款方式”那一行的高度 */
        body.phone-frame-active .confirm-payment-method {
            padding-top: 5px;
            gap: 4px;
        }
        body.phone-frame-active .payment-method-details {
            padding: 5px 8px;
        }

        /* 压缩密码输入区域的上下间距 */
        body.phone-frame-active .password-input-section {
            padding: 10px 0 5px 0;
            margin-bottom: 0;
        }
        body.phone-frame-active .password-input-section p {
            margin-bottom: 8px;
            font-size: 13px;
        }

        /* 缩小 6 个密码框的尺寸 */
        body.phone-frame-active .password-box {
            width: 32px !important;
            height: 32px !important;
            font-size: 14px;
            border-radius: 6px;
            margin: 0 2px;
        }

        /* 强制去除键盘底部的安全距离（因为手机框里不需要） */
        body.phone-frame-active .numeric-keypad {
            padding-bottom: 0 !important;
            background-color: #f6f2f4;
        }

        /* 压扁数字键盘的按钮高度 */
        body.phone-frame-active .keypad-btn {
            padding: 8px 0 !important; /* 减少内边距 */
            height: 42px !important;   /* 强制固定高度 */
            font-size: 18px !important;
            line-height: 42px; /* 让文字垂直居中 */
        }

        /* 缩小删除按钮的图标 */
        body.phone-frame-active .keypad-btn.delete img {
            width: 20px; 
            height: 20px;
            vertical-align: middle;
        }
        
        /* 确保弹窗在手机框内绝对定位到底部 */
        body.phone-frame-active #transfer-confirm-popup {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            transform: translateY(100%); /* 默认隐藏 */
        }
        /* 激活状态 */
        body.phone-frame-active #transfer-confirm-overlay.active #transfer-confirm-popup {
            transform: translateY(0);
        }
        
       /* --- 手机外框 - 新增与修改 --- */
        #app-wrapper {
          width: 100%;
          height: 100%;
          position: relative;
          background-size: cover;
          background-position: center;
        }
        
        body.phone-frame-active #home-screen {
            padding-top: var(--status-bar-height);
        }
        body.phone-frame-active .chat-app-header,
        body.phone-frame-active .wallet-header,
        body.phone-frame-active .wb-header,
        body.phone-frame-active .mall-header,
        body.phone-frame-active .forum-header-home,
        body.phone-frame-active #forum-detail-header,
        body.phone-frame-active .forum-post-top-bar,
        body.phone-frame-active #settings-page > .settings-header,
        body.phone-frame-active #me-settings-modal > .me-settings-header-bar,
        body.phone-frame-active #worldbook-detail-modal > .wb-detail-header,
        body.phone-frame-active #worldbook-color-page > .wb-color-header,
        body.phone-frame-active #add-moment-modal > .add-moment-header,
        body.phone-frame-active #role-settings-page > .role-setting-close-area,
        body.phone-frame-active #recollection-app-page .recollection-header,
        body.phone-frame-active #recollection-detail-page .recollection-detail-header,
        body.phone-frame-active #chat-conversation-view > .chat-conv-header,
        body.phone-frame-active .takeout-header { /* <-- 新增外卖App */
            padding-top: calc(15px + var(--status-bar-height));
        }
        
        body.phone-frame-active #app-wrapper > div[id*="-page"],
        body.phone-frame-active #app-wrapper > div[id*="-modal"],
        body.phone-frame-active #app-wrapper > div[id*="-overlay"],
        body.phone-frame-active #app-wrapper > .delete-confirm-modal {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .phone-container {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: none;
          justify-content: center;
          align-items: center;
          background: #f0f0f0;
          z-index: 9999;
        }
        
        body.phone-frame-active .phone-container {
          display: flex;
        }
        
                .phone{
          width: 390px;
          height: 780px;
          background: #050505;
          background-clip: padding-box; 
          border-radius: 48px;
          padding: 6px;
          position: relative;
          /* 【关键修改】：将第一个 0 改为 0，第二个 0 改为 20px。让阴影只往下掉，不往上扩散 */
          box-shadow: 0 20px 40px rgba(0,0,0,0.5);
          border: 6px solid var(--phone-case-color);
          transition: border-color 0.3s;
        }
        
                /* 优化：更可爱立体的果冻猫耳朵 */
                /* 移除原本绑定在手机壳上的伪元素猫耳，防止重叠冲突 */
        body.cat-ears-active .phone::before,
        body.cat-ears-active .phone::after {
            display: none !important;
        }

                /* --- 绝对对称、纯净无阴影、加宽版猫耳 --- */
                /* --- 绝对对称、纯净无阴影、超宽版猫耳 --- */
        .cute-cat-ear {
            position: absolute;
            width: 58px;  
            height: 58px;
            background: var(--cat-ear-color);
            z-index: -1;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-origin: center;

            border-radius: 15px 0 0 0;
            box-shadow: none; 

            top: 20px;
            opacity: 0;
            
            /* 【关键修改】：scaleX 改为 0.85，底座更宽更稳 */
            transform: scaleX(0.85) rotate(45deg);
        }

        body.cat-ears-active .cute-cat-ear.left {
            opacity: 1;
            top: -24px; 
            left: 30px; /* 微调位置，适应更宽的底座 */
            transform: scaleX(0.85) rotate(45deg); 
        }

        body.cat-ears-active .cute-cat-ear.right {
            opacity: 1;
            top: -24px;
            right: 30px; /* 保持绝对对称 */
            transform: scaleX(0.85) rotate(45deg);
        }
        .screen{
          width: 100%;
          height: 100%;
          border-radius: 36px;
          overflow: hidden;
          position: relative;
          background: transparent;
          background-size: cover;
          background-position: center;
        }
        
        .notch{
          position: absolute;
          top: 10px;
          left: 50%;
          transform: translateX(-50%);
          width: 130px;
          height: 34px;
          background: #000;
          border-radius: 18px;
          z-index: 10010;
          pointer-events: none;
        }
        
        .status-bar{
          height: var(--status-bar-height);
          padding: 0 14px;
          display: flex;
          align-items: flex-start;
          font-size: 16px;
          font-weight: 600;
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          z-index: 10009;
          color: #fff;
          pointer-events: none;
        }
        
        .status-time{
          margin-left: 18px;
          color: #000;
          padding-top: 14px;
        }
        
        .status-right{
          position: absolute;
          top: 14px;
          right: 20px;
          display: flex;
          gap: 8px;
          align-items: center;
        }
        .status-right img{
          height: 14px;
        }
        
                         /* --- 新增：收款弹窗样式 (已应用新布局和颜色) --- */
        #receive-transfer-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: white; 
            z-index: 2000; 
            display: flex;
            flex-direction: column;
            /* 1. 修改：整体布局，内容上移，按钮下沉 */
            justify-content: space-between; 
            padding-top: 100px; /* 让顶部内容块从导航栏下方开始 */
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #receive-transfer-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .receive-back-btn {
            position: absolute;
            top: 13px; 
            left: 20px;
            width: 30px; height: 30px;
            object-fit: contain; cursor: pointer;
            z-index: 2001;
            transition: top 0.3s ease;
        }
        body.phone-frame-active .receive-back-btn {
            top: calc(15px + var(--status-bar-height));
        }
        body.ios-mode-active .receive-back-btn {
            top: calc(env(safe-area-inset-top, 20px) + 15px);
        }
        
        .receive-card {
            /* 1. 修改：移除 flex:1 和 justify-content, 让它自然地待在顶部 */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 0 30px;
            background: transparent;
            transform: none !important;
            box-shadow: none;
        }
        
        .receive-icon { width: 60px; height: 60px; margin-bottom: 10px; }
        .receive-status { font-size: 18px; color: #333; font-weight: 500; }
        /* 2. 修改：金额字体缩小 */
        .receive-amount { font-size: 48px; font-weight: bold; color: #000; margin: 10px 0 30px 0; }
        
        .receive-info-section {
            width: 100%;
            padding: 20px 0;
            border-top: 1px solid #ddd;
            /* 3. 修改：移除底部横线 */
            border-bottom: none; 
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            color: #666;
        }
        .receive-info-value { color: #333; }
        
        .receive-actions-footer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 30px);
        }
        
        .receive-confirm-btn {
            /* 4. 修改：收款按钮长度缩短一半 */
            width: 40%;
            max-width: 300px;
            padding: 14px;
            background: #06C755;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .receive-reject-btn {
            background: none;
            border: none;
            color: #667588;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
        }
                /* --- NEW: Styles for Urge Post Modal --- */
        .urge-post-char-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 5px;
            transition: all 0.2s;
        }
        .urge-post-char-item.selected {
            border-color: var(--theme-pink-btn);
            background-color: var(--theme-pink-bg-med);
        }
        .urge-post-char-item img {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            margin-bottom: 5px;
        }
        .urge-post-char-item span {
            font-size: 12px;
            color: #666;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* --- NEW: Recollection App Styles (MODIFIED) --- */
        #recollection-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #ffffff; /* MODIFIED: White background */
            z-index: 570;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.recollection-active #recollection-app-page { transform: translateY(0); }

        /* MODIFIED: Recollection Header Layout */
        .recollection-header {
            padding: 35px 20px 15px;
            background: #ffffff;
            display: flex;
            justify-content: space-between; /* MODIFIED */
            align-items: center;
            flex-shrink: 0; z-index: 10;
            position: relative;
            border-radius: 0 0 25px 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .recollection-header-title {
            font-size: 18px; font-weight: 600; color: #ffd6e7; /* MODIFIED: Pink title */
            text-shadow: none;
            /* MODIFIED: Absolute centering */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .recollection-back-btn {
            /* MODIFIED: No longer absolute */
            width: 30px; height: 30px; object-fit: contain; cursor: pointer;
        }

        .recollection-content {
            flex: 1; overflow-y: auto; padding: 30px 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px 20px;
            align-content: flex-start;
        }

        .crystal-ball-item {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s;
            position: relative;
        }
        .crystal-ball-item:active { transform: scale(0.95); }
        
        /* --- MODIFIED: Crystal Ball 🔮 Styles (Cute & 3D) --- */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.5; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

                .crystal-ball-container {
            width: 100%;
            aspect-ratio: 1 / 1.1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            filter: drop-shadow(0px 10px 15px rgba(255, 182, 193, 0.5)); /* 纯粉色外部阴影 */
            animation: float 6s ease-in-out infinite;
            transition: filter 0.3s ease;
            cursor: pointer; /* 确保鼠标放上去有小手提示 */
        }

        .crystal-ball-sphere {
            width: 85%;
            aspect-ratio: 1/1;
            /* 全浅粉色渐变，去掉了所有白色过渡 */
            background: radial-gradient(circle at 50% 50%, #ffe4e1 0%, #ffb6c1 100%); 
            border-radius: 50%;
            position: relative;
            /* 阴影全部改为粉色系，去掉所有白色高光内发光 */
            box-shadow: inset -10px -10px 20px rgba(255, 105, 180, 0.2), 
                        0 0 30px rgba(255, 182, 193, 0.4); 
            overflow: hidden;
            /* 边沿也改成纯浅粉色 */
            border: 2px solid #ffb6c1; 
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        /* 隐藏原本的白色高光图层 */
        .crystal-ball-highlight {
            display: none !important; 
        }
                /* 强制隐藏水晶球残留的灰色阴影、白色反光伪元素 */
        .crystal-ball-sphere::before,
        .crystal-ball-sphere::after,
        .crystal-ball-highlight {
            display: none !important;
            background: none !important;
        }
        .crystal-ball-sphere::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.3) 100%);
            opacity: 0.7;
        }
        .crystal-ball-sphere::after {
            content: '';
            position: absolute;
            bottom: -15%;
            left: 10%;
            width: 80%;
            height: 40%;
            background: radial-gradient(ellipse, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .crystal-ball-highlight {
            position: absolute;
            top: 5%;
            left: 15%;
            width: 60%;
            height: 30%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 60%);
            border-radius: 50%;
            transform: rotate(-30deg);
        }
        
        .crystal-ball-base {
            width: 60%;
            height: 25%;
            background: linear-gradient(180deg, #f0e2b6 0%, #c9a967 10%, #ab8a4a 50%, #95753c 100%);
            position: relative;
            border-radius: 2px 2px 50% 50% / 2px 2px 100% 100%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            margin-top: -12%;
            z-index: -1;
        }
        .crystal-ball-base::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 110%;
            height: 10px;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.4), transparent);
            border-radius: 50%;
        }

        .crystal-ball-stars {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }
        .star.s1 { width: 3px; height: 3px; top: 20%; left: 30%; animation-delay: 0s; }
        .star.s2 { width: 2px; height: 2px; top: 40%; left: 70%; animation-delay: 0.5s; }
        .star.s3 { width: 2px; height: 2px; top: 75%; left: 25%; animation-delay: 1s; }
        .star.s4 { width: 1px; height: 1px; top: 60%; left: 50%; animation-delay: 1.5s; }
        .star.main-star { 
            width: 15px; height: 15px; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(ellipse at center, white, rgba(255,255,255,0));
            animation-duration: 2s;
        }
        
        .crystal-ball-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
            z-index: 5;
            position: absolute;
            top: 40%; /* Adjust vertical position inside sphere */
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 5px;
            text-align: center;
            width: 100%;
        }
        
        /* --- NEW: Recollection Detail Page (MODIFIED) --- */
        #recollection-detail-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #ffffff; /* MODIFIED: White background */
            z-index: 571;
            display: none;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.5, 1);
        }
        #recollection-detail-page.active { 
            display: flex;
            transform: translateX(0);
        }
                /* MODIFIED: Detail Header Layout (变圆滑) */
        .recollection-detail-header {
            padding: 35px 20px 15px;
            background: #fff;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-shrink: 0;
            position: relative;
            /* 下面两行是让顶栏变圆滑、加一点阴影的代码 */
            border-radius: 0 0 25px 25px;
            box-shadow: 0 4px 15px rgba(229, 138, 171, 0.15);
        }

        /* 修复：回忆便签长按/双击操作菜单的样式 */
        #recollection-action-sheet-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4); z-index: 1000;
            display: flex; flex-direction: column; justify-content: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            backdrop-filter: blur(2px);
        }
        #recollection-action-sheet-overlay.active { opacity: 1; pointer-events: auto; }
        
        #recollection-action-sheet {
            background-color: var(--theme-pink-bg-soft);
            width: 95%; max-width: 400px; margin: 0 auto 15px; 
            border-radius: 20px; overflow: hidden;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        #recollection-action-sheet-overlay.active #recollection-action-sheet { transform: translateY(0); }
        .recollection-detail-title { /* MODIFIED */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 17px;
            font-weight: 600;
            color: #ffd6e7; /* MODIFIED: Title color changed */
        }
        .recollection-detail-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .recollection-detail-add-icon {
            font-size: 30px; font-weight: 300; line-height: 1; color: #888;
            cursor: pointer;
        }
        .recollection-detail-cheese-icon {
            width: 28px; height: 28px; object-fit: contain; cursor: pointer;
        }
        .recollection-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .recollection-item-wrapper {
            position: relative;
            border-radius: 12px;
        }

        .recollection-item {
            background-color: #fffaf0; /* Softer yellow */
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #fdf2d0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.04);
            position: relative;
            transform: translateX(0);
            transition: transform 0.3s ease;
            touch-action: pan-y; /* Allow vertical scroll */
            min-height: 100px; /* Ensure a minimum height for bg images */
            overflow: hidden; /* For bg image clipping */
        }
        .recollection-item::after {
            content: '📎';
            position: absolute;
            top: 2px;
            right: 10px;
            font-size: 24px;
            transform: rotate(10deg);
            opacity: 0.6;
            pointer-events: none;
        }
        .recollection-item.summary-item {
            background-color: #f0f8ff;
            border-color: #d1e2f0;
        }

        .recollection-item-text {
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
            cursor: pointer;
            position: relative;
            z-index: 1;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }
        .recollection-item-text.truncated {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .recollection-item-timestamp {
            font-size: 12px;
            color: #ffffff;
            text-align: right;
            margin-top: 10px;
            position: relative;
            z-index: 1;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        /* --- START: 外卖 App (情侣点菜) Styles --- */
        #takeout-app-page {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: var(--takeout-bg-color);
            z-index: 550;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overscroll-behavior-y: contain;
        }
        body.takeout-active #takeout-app-page {
            transform: translateY(0);
        }
        .takeout-header {
            padding: 35px 20px 15px;
            background: var(--takeout-white-color);
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 0 0 25px 25px;
            box-shadow: 0 4px 15px rgba(229, 138, 171, 0.15);
            flex-shrink: 0; z-index: 1001;
            transition: padding-top 0.3s ease;
            position: relative;
        }
        .takeout-header .takeout-back-btn { width: 30px; height: 30px; object-fit: contain; cursor: pointer; }
        .takeout-header .takeout-title { font-size: 18px; font-weight: 600; color: var(--takeout-primary-color); position: absolute; left: 50%; transform: translateX(-50%); }
        .takeout-header #takeout-toggle-edit-btn { font-size: 14px; color: var(--takeout-primary-color); background: none; border: 1px solid var(--takeout-primary-color); border-radius: 15px; padding: 5px 12px; cursor: pointer; display: none; }
        
        .takeout-content-wrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        #takeout-app-page .page { display: none; padding: 15px; animation: fadeIn 0.5s ease; min-height: 100%; }
        #takeout-app-page .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #takeout-app-page .bottom-nav { 
            flex-shrink: 0;
            height: calc(65px + env(safe-area-inset-bottom, 10px));
            padding-bottom: env(safe-area-inset-bottom, 10px);
            background-color: var(--takeout-white-color); 
            border-radius: 30px 30px 0 0;
            box-shadow: var(--takeout-shadow); 
            display: flex; 
            justify-content: space-around; 
            align-items: flex-start;
            padding-top: 10px;
            z-index: 1000;
        }
        #takeout-app-page .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; background: none; cursor: pointer; color: var(--takeout-light-text-color); transition: all 0.3s ease; font-size: 12px; flex-grow: 1; }
        #takeout-app-page .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; fill: currentColor; }
        #takeout-app-page .nav-item.active { color: var(--takeout-primary-color); transform: scale(1.1); }

        #takeout-app-page .card { background-color: var(--takeout-white-color); border-radius: var(--takeout-border-radius-l); padding: 20px; margin-bottom: 15px; box-shadow: var(--takeout-shadow); }
        #takeout-app-page .button { display: inline-block; padding: 12px 20px; border: none; border-radius: var(--takeout-border-radius-l); background-color: var(--takeout-primary-color); color: var(--takeout-white-color); font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; transition: all 0.3s ease; width: 100%; }
        #takeout-app-page .button:active { transform: scale(0.98); opacity: 0.8; }
        #takeout-app-page .button.secondary { background-color: var(--takeout-white-color); color: var(--takeout-primary-color); border: 1px solid var(--takeout-primary-color); }
        #takeout-app-page h2 { margin-bottom: 15px; font-size: 20px; color: var(--takeout-text-color); }
        #takeout-app-page .status-text { text-align: center; color: var(--takeout-light-text-color); margin-top: 15px; font-size: 14px; }
        
        #takeout-app-page #page-order .order-layout { display: flex; height: 100%; }
        #takeout-app-page .category-sidebar { width: 90px; flex-shrink: 0; overflow-y: auto; background-color: #fff9fb; border-radius: var(--takeout-border-radius-l); padding: 10px 5px; height: 100%; }
        #takeout-app-page .category-sidebar::-webkit-scrollbar { display: none; }
        #takeout-app-page .category-item { padding: 15px 5px; text-align: center; border-radius: var(--takeout-border-radius-m); margin-bottom: 10px; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
        #takeout-app-page .category-item.active { background-color: var(--takeout-white-color); color: var(--takeout-primary-color); font-weight: bold; box-shadow: 0 2px 8px rgba(255,182,193,0.4); }
        #takeout-app-page .dishes-main { flex-grow: 1; overflow-y: auto; padding-left: 10px; height: 100%; }
        #takeout-app-page .dishes-main::-webkit-scrollbar { display: none; }
        #takeout-app-page .dish-card { display: flex; align-items: center; background-color: var(--takeout-white-color); border-radius: var(--takeout-border-radius-l); padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: transform 0.2s ease; margin-left: 5px; width: calc(100% - 5px); }
        #takeout-app-page .dish-card:active { transform: scale(0.98); }
        #takeout-app-page .dish-image { width: 70px; height: 70px; border-radius: var(--takeout-border-radius-m); object-fit: cover; flex-shrink: 0; margin-right: 12px; background-color: #f0f0f0; }
        #takeout-app-page .dish-info h3 { font-size: 16px; }
        #takeout-app-page .dish-actions { position: absolute; bottom: 12px; right: 12px; display: flex; align-items: center; }
        #takeout-app-page .quantity-control { width: 24px; height: 24px; background-color: var(--takeout-primary-color); color: white; border-radius: 50%; border: none; font-size: 20px; line-height: 22px; cursor: pointer; }
        #takeout-app-page .quantity-control.minus { background-color: var(--takeout-white-color); border: 1px solid var(--takeout-primary-color); color: var(--takeout-primary-color); }
        #takeout-app-page .dish-quantity { margin: 0 8px; font-weight: bold; min-width: 20px; text-align: center; }
        #takeout-app-page .dish-delete-btn { position: absolute; top: -5px; left: -10px; width: 22px; height: 22px; background-color: var(--takeout-red-color); color: white; border-radius: 50%; border: 2px solid var(--takeout-white-color); font-size: 14px; line-height: 18px; text-align: center; cursor: pointer; z-index: 99; }
        #takeout-app-page .order-footer { position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 50px; background-color: var(--takeout-primary-color); border-radius: 25px; display: flex; align-items: center; justify-content: space-between; padding: 0 10px 0 20px; color: white; box-shadow: var(--takeout-shadow); transition: all 0.3s ease; }
        #takeout-app-page .order-footer.hidden { transform: translateX(-50%) scale(0); opacity: 0; }
        #takeout-app-page #place-order-btn { padding: 8px 18px; background-color: white; color: var(--takeout-primary-color); border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
        
        #takeout-app-page #menu-list .menu-item-card { background-color: var(--takeout-white-color); border-radius: var(--takeout-border-radius-l); margin-bottom: 15px; box-shadow: var(--takeout-shadow); overflow: hidden; }
        #takeout-app-page .menu-header { display: flex; align-items: center; padding: 15px; cursor: pointer; }
        #takeout-app-page .menu-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; background-color: #eee; flex-shrink: 0; }
        #takeout-app-page .menu-title-wrapper { flex-grow: 1; }
        #takeout-app-page .menu-title { font-size: 18px; font-weight: bold; }
        #takeout-app-page .menu-summary { font-size: 12px; color: var(--takeout-light-text-color); margin-top: 4px; }
        #takeout-app-page .menu-expand-icon { transition: transform 0.3s ease; }
        #takeout-app-page .menu-expand-icon.expanded { transform: rotate(180deg); }
        #takeout-app-page .menu-dishes-list { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; background-color: #fafafa; padding: 0 15px; }
        #takeout-app-page .menu-dishes-list.expanded { max-height: 500px; padding: 10px 15px; }
        #takeout-app-page .menu-dish-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; cursor: pointer; }
        #takeout-app-page .menu-dish-item:last-child { border-bottom: none; }
        #takeout-app-page .menu-dish-item img { width: 40px; height: 40px; border-radius: var(--takeout-border-radius-m); object-fit: cover; margin-right: 10px; }
        #takeout-app-page .menu-dish-item .name { flex-grow: 1; }
        #takeout-app-page .menu-dish-item .quantity { color: var(--takeout-light-text-color); font-size: 14px; }

        #takeout-app-page .my-profile { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        #takeout-app-page .my-avatar-wrapper { position: relative; cursor: pointer; }
        #takeout-app-page .my-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--takeout-white-color); box-shadow: var(--takeout-shadow); background-color: #eee; }
        #takeout-app-page .my-avatar-wrapper:hover::after { content: '更换'; position: absolute; bottom: 0; left: 0; width: 100%; background-color: rgba(0,0,0,0.4); color: white; font-size: 12px; text-align: center; padding: 4px 0; border-bottom-left-radius: 50px; border-bottom-right-radius: 50px; opacity: 1; transition: opacity 0.3s; }
        #takeout-app-page #my-id-display { font-size: 20px; font-weight: bold; text-align: center; color: var(--takeout-primary-color); letter-spacing: 2px; margin: 15px 0 10px; background: white; padding: 8px 15px; border-radius: 20px; }
        #takeout-app-page #get-my-id-btn { font-size: 14px; padding: 8px 15px; width: auto; }
        #takeout-app-page .input-group { display: flex; gap: 10px; margin-top: 10px; }
        #takeout-app-page .input-group input { flex-grow: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: var(--takeout-border-radius-l); font-size: 16px; }
        #takeout-app-page .input-group input:focus { outline: none; border-color: var(--takeout-primary-color); }
        #takeout-app-page .input-group button { width: auto; flex-shrink: 0; }
        
        #takeout-app-page .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        #takeout-app-page .modal.visible { opacity: 1; visibility: visible; }
        #takeout-app-page .modal-content { background-color: var(--takeout-white-color); padding: 25px; border-radius: var(--takeout-border-radius-l); width: 90%; max-width: 400px; transform: scale(0.9); transition: all 0.3s ease; position: relative; }
        #takeout-app-page .modal.visible .modal-content { transform: scale(1); }
        #takeout-app-page .modal-content h3 { margin-top: 0; margin-bottom: 20px; text-align: center; }
        #takeout-app-page .modal-content input, #takeout-app-page .modal-content textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: var(--takeout-border-radius-m); font-size: 16px; }
        #takeout-app-page .modal-content textarea { min-height: 100px; resize: vertical; }
        #takeout-app-page .modal-actions { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        #takeout-app-page .modal-actions .button { width: 100%; } /* 适配只有一个按钮的情况 */
        #takeout-app-page .close-modal-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; cursor: pointer; font-size: 28px; color: var(--takeout-light-text-color); line-height: 1; padding: 5px; }
        
        #takeout-app-page #dish-detail-modal .dish-detail-image { width: 100%; height: 180px; object-fit: cover; border-radius: var(--takeout-border-radius-m); margin-bottom: 15px; background-color: #eee; }
        #takeout-app-page #dish-detail-modal h3 { text-align: left; }
        #takeout-app-page #dish-detail-modal .steps-content { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border-radius: var(--takeout-border-radius-m); color: #555; max-height: 200px; overflow-y: auto;}
        
        #takeout-app-page .image-upload-container { display: flex; justify-content: center; margin-bottom: 20px;}
        #takeout-app-page .image-preview { width: 120px; height: 120px; object-fit: cover; border-radius: var(--takeout-border-radius-l); cursor: pointer; border: 2px dashed var(--takeout-primary-color); }
        #takeout-app-page .image-preview.round { border-radius: 50%; }
        /* --- END: 外卖 App Styles --- */

    </style>
</head>
<body>
<div id="app-wrapper">
<div id="home-screen">
    <div id="time-section">
        <div id="time-container" onclick="handleTimeBgClick(event)">
            <div id="clock-time">12:00</div>
            <div id="clock-date" onclick="handleDateEdit(event)">2026年02月27日 星期五</div>
        </div>
    </div>
    <div id="grid-area">
        <div class="grid-quadrant" id="avatar-quadrant-1">
            <div id="chat-dual-container">
                <div class="chat-row left">
                    <div class="avatar-container" onclick="editChatAvatarUrl('chat-avatar-1')">
                        <div class="avatar-ring">
                            <div class="avatar-img-circle" id="chat-avatar-1" style="background-image: url('https://img.heliar.top/file/1770068438490_添加人群_people-plus.png');"></div>
                        </div>
                    </div>
                    <input type="text" class="chat-bubble-input left-bubble" value="Say Hi~" oninput="adjustInputWidth(this)">
                </div>
                <div class="chat-row right">
                    <div class="avatar-container" onclick="editChatAvatarUrl('chat-avatar-2')">
                        <div class="avatar-ring">
                            <div class="avatar-img-circle" id="chat-avatar-2" style="background-image: url('https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png');"></div>
                        </div>
                    </div>
                    <input type="text" class="chat-bubble-input right-bubble" value="Hello!" oninput="adjustInputWidth(this)">
                </div>
            </div>
        </div>

        <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item" onclick="openChatApp()">
                    <div class="app-icon" id="icon-app1">☁️</div>
                    <span class="app-name" data-app-name="Chat">Chat</span>
                </div>
                <div class="app-item" onclick="openWorldBookApp()"><div class="app-icon" id="icon-app2">🎵</div><span class="app-name" data-app-name="世界书">世界书</span></div>
                <div class="app-item" onclick="openForumApp()"><div class="app-icon" id="icon-app3">💬</div><span class="app-name" data-app-name="论坛">论坛</span></div>
                <div class="app-item" onclick="openRecollectionApp()"><div class="app-icon" id="icon-app4">🔮</div><span class="app-name" data-app-name="备忘录">备忘录</span></div>
            </div>
        </div>
        <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item"><div class="app-icon" id="icon-app5">🧭</div><span class="app-name" data-app-name="HUshhh">HUshhh</span></div>
                <div class="app-item" onclick="openMallApp()"><div class="app-icon" id="icon-app6">🎮</div><span class="app-name" data-app-name="商城">商城</span></div>
                <div class="app-item" onclick="openTakeoutApp()"><div class="app-icon" id="icon-app7">🥡</div><span class="app-name" data-app-name="外卖">外卖</span></div>
                <div class="app-item" onclick="openWalletApp()"><div class="app-icon" id="icon-app8">💰</div><span class="app-name" data-app-name="Wallet">Wallet</span></div>
            </div>
        </div>

        <div class="grid-quadrant" id="photo-widget-quadrant">
            <div class="photo-widget-container" onclick="triggerPhotoWidgetUpload()">
                <div id="photo-widget-placeholder" class="photo-widget-placeholder">
                    <div class="photo-widget-icon">📷</div>
                    <div class="photo-widget-text">Add Photo</div>
                </div>
                <img id="photo-widget-img" class="photo-widget-img" src="">
            </div>
        </div>
    </div>
    <div id="dock-area">
        <div class="dock-container">
            <div class="app-item" onclick="showSettingsPage()"><div class="app-icon dock-icon" id="icon-dock-settings">⚙️</div></div>
            <div class="app-item" onclick="openAIChat()"><div class="app-icon dock-icon" id="icon-dock-ai">🤖</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-safari">🧭</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-messages">✉️</div></div>
        </div>
    </div>
</div>

<!-- Chat App 页面 -->
<div id="chat-app-page">
    <div class="chat-app-header" id="chat-app-header-el">
        <div id="chat-header-left-icons" style="display: flex; gap: 15px; z-index: 2;">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-icon-img" id="chat-back-btn" onclick="closeChatApp()">
            <img id="urge-post-icon" src="https://img.heliar.top/file/1770904788245_喜欢_like_5.png" class="back-icon-img" onclick="openUrgeToPostModal()" style="display: none;">
        </div>
        <div class="chat-header-title" id="chat-page-title">Chat</div>
        <div id="chat-header-right-icons" style="display: flex; gap: 15px; z-index: 2;">
            <img id="chat-header-add-friend-icon" src="https://img.heliar.top/file/1770068438490_添加人群_people-plus.png" class="header-right-icon" onclick="openAddFriendModal()">
            <img id="chat-header-add-moment-icon" src="https://img.heliar.top/file/1770345149331_相机_camera.png" class="header-right-icon" onclick="openMomentsActionSheet()" style="display: none;">
        </div>
    </div>
    
    <div class="chat-app-content" id="chat-content-area">
        <div id="chat-tab-0" class="chat-tab-content active">
            <div class="chat-list-container" id="chat-list-container"></div>
        </div>
        <div id="chat-tab-1" class="chat-tab-content">
            <div class="contact-list-container" id="contact-list-container"></div>
            <div class="alpha-index-bar" id="alpha-index-bar"></div>
        </div>
        <div id="chat-tab-2" class="chat-tab-content">
            <div id="moments-page-wrapper"></div>
        </div>
        <div id="chat-tab-3" class="chat-tab-content">
            <div class="me-page-container">
                <div class="me-cover-area" id="profile-cover">
                    <div class="me-like-wrapper">
                        <img src="https://img.heliar.top/file/1770079217317_赞_thumbs-up_2.png" class="me-like-icon" onclick="incrementLikeCount(event)">
                        <div class="me-like-count" id="profile-like-count" onclick="incrementLikeCount(event)">8888</div>
                    </div>
                    <div class="me-setting-wrapper">
                        <img src="https://img.heliar.top/file/1770083061419_设置_setting-two.png" class="me-setting-icon" onclick="openMeSettings()">
                    </div>
                </div>
                <div class="me-content-area">
                    <div class="me-floating-header">
                        <div class="me-avatar-box">
                            <img id="profile-avatar" class="me-avatar-img" src="" onerror="this.src='https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'">
                        </div>
                        <div class="me-text-col">
                            <div class="me-nickname" id="profile-nickname" onclick="editNickname(event)">User Name</div>
                            <div class="me-qq-id" id="profile-qq-id" onclick="editQQID(event)">QQ: 20261314520</div>
                        </div>
                    </div>
                    <div class="me-info-list">
                        <div class="me-list-item" onclick="editSignature()">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081937488_人员_people.png">
                            <div class="me-list-text" id="profile-signature-text">这个人很懒，什么都没留下~</div>
                            <img class="me-list-arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                        </div>
                        <div class="me-list-item">
                            <img id="me-member-icon-main" class="me-list-icon" src="https://img.heliar.top/file/1770081928967_vip_vip-one.png">
                            <div class="me-list-text">
                                <div id="me-member-icon-container" class="me-member-icons-row"></div>
                            </div>
                            <img class="me-list-arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                        </div>
                        <div class="me-list-item">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081938581_星星_star-one.png">
                            <div class="me-list-text">QQ空间</div>
                            <img class="me-list-arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="chat-bottom-bar-container">
        <div class="chat-nav-item active" onclick="switchChatTab(0, 'Chat')">
            <img src="https://img.heliar.top/file/1770068139630_信息_message_3.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(1, '通讯录')">
            <img src="https://img.heliar.top/file/1770068141129_通讯录_address-book_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(2, '朋友圈')">
            <img src="https://img.heliar.top/file/1770068142240_朋友圈_friends-circle_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(3, '我')">
            <img src="https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png" class="chat-nav-icon">
        </div>
    </div>

    <!-- 角色聊天专属页面 -->
    <div id="chat-conversation-view">
        <div id="chat-extra-menu">
            <div class="chat-menu-item">
                <img src="https://img.heliar.top/file/1770713133852_红包_red-envelopes.png" class="chat-menu-icon">
                <span class="chat-menu-text">红包</span>
            </div>
            <div class="chat-menu-item" onclick="openTransferPage()">
                <img src="https://img.heliar.top/file/1770713126016_支出_expenses-one.png" class="chat-menu-icon">
                <span class="chat-menu-text">转账</span>
            </div>
            <div class="chat-menu-item">
                <img src="https://img.heliar.top/file/1770713131222_淘宝_taobao_2.png" class="chat-menu-icon">
                <span class="chat-menu-text">淘宝</span>
            </div>
            <div class="chat-menu-item" onclick="openWalletApp()">
                <img src="https://img.heliar.top/file/1770721898565_支付宝_alipay.png" class="chat-menu-icon">
                <span class="chat-menu-text">钱包</span>
            </div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
            <div class="chat-menu-item"><div class="chat-menu-icon" style="background:#f0f0f0;"></div></div>
        </div>
        <div class="chat-conv-header">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="chat-conv-back-btn" onclick="closeChatConversation()">
            <div class="chat-conv-title-container">
                <div class="chat-conv-title" id="chat-conv-title">角色名称</div>
                <div class="chat-conv-signature" id="chat-conv-signature"></div>
            </div>
            <img class="chat-conv-right-icon" src="https://img.heliar.top/file/1770241189848_更多_more.png" onclick="openRoleSettings()">
        </div>
        <div class="chat-conv-messages" id="chat-conv-messages"></div>
        <div class="chat-conv-footer">
            <button class="chat-conv-btn" onclick="toggleChatExtraMenu()"><img src="https://img.heliar.top/file/1770239041392_开关_power.png" style="width: 24px; height: 24px; object-fit: contain;"></button>
            <div class="chat-conv-input-wrapper">
                <input type="text" class="chat-conv-input" id="chat-conv-input" placeholder="输入消息..." onkeydown="handleChatInputKey(event)">
            </div>
            <button class="chat-conv-btn" style="margin-right: 0;"><img src="https://img.heliar.top/file/1770239038945_喜欢_like.png" style="width: 24px; height: 24px; object-fit: contain;"></button>
            <button class="chat-conv-btn send ai-trigger" onclick="triggerAIAutoReply()"><img src="https://img.heliar.top/file/1770239044304_发送_send.png" style="width: 20px; height: 20px; object-fit: contain;"></button>
        </div>
        <!-- Multiselect Footer -->
        <div class="chat-multiselect-footer" id="chat-multiselect-footer">
             <button class="chat-multiselect-delete-btn" onclick="executeBatchDelete()">删除</button>
        </div>
    </div>
</div>

<!-- 角色设置页面 -->
<div id="role-settings-page">
    <div class="role-setting-close-area">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="role-setting-back-btn" onclick="closeRoleSettings()">
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">角色设置 (Role)</div>
        <div class="role-avatar-edit-wrapper" onclick="triggerRoleAvatarEdit()">
            <img id="role-setting-avatar" class="role-avatar-edit" src="">
            <div class="avatar-edit-hint">✎</div>
        </div>
        <input type="text" id="role-setting-alias" class="role-alias-edit" placeholder="备注名">
        <input type="text" id="role-setting-signature" class="role-signature-edit" placeholder="角色签名...">
        <textarea id="role-setting-persona" class="role-persona-input" placeholder="输入角色人设 (Persona)..."></textarea>
        
        <div class="settings-row-with-switch" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px;">
            <label for="role-time-perception-switch">时间感知</label>
            <label class="ios-switch">
                <input type="checkbox" id="role-time-perception-switch">
                <span class="slider round"></span>
            </label>
        </div>

        <div class="settings-row" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px; display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
            <label for="role-memory-depth" style="margin-bottom:0;">记忆条数 (Memory)</label>
            <input type="number" id="role-memory-depth" placeholder="10" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
        </div>

        <div class="role-bg-upload-area" style="display: flex; flex-direction: column; gap: 10px; padding: 15px; margin-top: 15px;">
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <span style="font-size:13px; color:#555;">聊天背景</span>
                <div id="role-bg-preview" class="role-bg-preview"></div>
            </div>
            <input type="text" id="role-bg-url-input" placeholder="输入背景图片URL" style="width: 100%; padding: 10px; border: 1px solid #FADBE6; border-radius: 8px; font-size: 14px;">
            <div style="display: flex; gap: 10px;">
                <button class="role-bg-btn" onclick="triggerRoleBgUpload()">上传图片</button>
                <button class="role-bg-btn" onclick="setRoleBgByUrl()">应用URL</button>
            </div>
        </div>
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">角色世界书</div>
        <div class="role-wb-binding-area">
            <div id="role-wb-display" class="unbound">未绑定</div>
            <div class="actions">
                <button id="role-wb-clear-btn" onclick="clearWorldBookBinding()" style="display: none;">清除</button>
                <button onclick="openRoleWorldBookBindModal()">选择</button>
            </div>
        </div>
    </div>
    <div class="settings-section-card">
        <div class="settings-card-title">用户设置 (User)</div>
        <div class="user-avatar-row">
            <div class="user-avatar-edit-wrapper" onclick="triggerRoleUserAvatarEdit()">
                <img id="role-user-avatar" class="role-avatar-edit" src="https://img.heliar.top/file/1770068438490_添加人群_people-plus.png">
                <div class="avatar-edit-hint">✎</div>
            </div>
            <input type="text" id="role-user-name" class="user-name-input" placeholder="您的名字">
        </div>
        <textarea id="role-user-persona" class="role-persona-input" placeholder="输入您的人设 (User Persona)..."></textarea>
    </div>

    <div class="settings-section-card">
        <div class="settings-card-title">主动发动态</div>
        <div class="settings-row-with-switch" style="width:100%; padding: 10px 5px;">
            <label for="role-auto-post-switch">开启自动发动态</label>
            <label class="ios-switch">
                <input type="checkbox" id="role-auto-post-switch">
                <span class="slider round"></span>
            </label>
        </div>
        <div class="settings-row" style="width:100%; padding: 10px 5px; border-top: 1px solid #f0f0f0; margin-top: 10px; display: flex; flex-direction: row; align-items: center; justify-content: space-between;">
            <label for="role-auto-post-interval" style="margin-bottom:0;">间隔时间 (分钟)</label>
            <input type="number" id="role-auto-post-interval" placeholder="10" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 8px; text-align: center;">
        </div>
    </div>
    
    <div class="settings-section-card">
         <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 15px;">
            <div class="settings-card-title" style="margin-bottom: 0; border-bottom: none;">自定义样式 (CSS)</div>
            <button class="role-bg-btn" onclick="openSaveCssPresetModal()">保存</button>
        </div>
        <textarea id="role-setting-css" class="role-css-input" placeholder="/* 在这里输入CSS代码修改气泡样式 */..."></textarea>
        
        <div style="width:100%; margin-top: 20px;">
            <div class="settings-card-title" style="margin-bottom: 10px;">预设样式列表</div>
             <div class="select-wrapper">
                <select id="css-preset-select" style="width:100%; padding: 10px; border:1px solid #eee; border-radius:8px;" onchange="handlePresetSelection(this)">
                </select>
            </div>
            <div id="css-preset-actions" style="display: none; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                 <button class="role-bg-btn" onclick="applySelectedCssPreset()">应用</button>
                 <button class="role-bg-btn" style="background-color: #eee; color: #999;" onclick="deleteSelectedCssPreset()">删除</button>
            </div>
        </div>
    </div>

    <button class="role-save-btn" onclick="saveRoleSettings()">保存设置</button>
    <button class="role-delete-btn" onclick="confirmDeleteFriend()">删除好友</button>
</div>

<!-- Add Moment Modal -->
<div id="add-moment-modal">
    <div class="add-moment-header">
        <button class="add-moment-cancel" onclick="closeAddMomentModal()">取消</button>
        <button class="add-moment-post" onclick="saveNewMoment()">发表</button>
    </div>
    <div class="add-moment-content">
        <textarea id="add-moment-text" placeholder="这一刻的想法..."></textarea>
        <div class="add-moment-grid" id="add-moment-grid">
            <div class="add-moment-image-upload" onclick="triggerMomentImageUpload()">
                 <span id="moment-upload-icon">+</span>
            </div>
        </div>
    </div>
</div>

<!-- Moments Comment MODAL -->
<div id="moments-comment-overlay" onclick="closeCommentInput()"></div>
<div id="moments-comment-modal">
    <input type="text" id="moments-comment-input" placeholder="发表评论:" onkeypress="handleCommentKey(event)">
    <img src="https://img.heliar.top/file/1770357295773_笑脸_smiling-face_2.png" class="moments-emoji-btn">
    <button id="moments-comment-submit-btn" onclick="submitComment()">发送</button>
</div>

<!-- Wallet App 页面 -->
<div id="wallet-app-page">
    <div class="wallet-header">
        <div class="wallet-close-btn" onclick="closeWalletApp()">✕</div>
        <div class="wallet-user-area">
            <img id="wallet-avatar" class="wallet-avatar" onclick="triggerProfileAvatarUpload(event)">
            <span id="wallet-nickname" class="wallet-nickname" onclick="editNickname(event)">User</span>
        </div>
    </div>
    <div class="wallet-content">
        <div class="wallet-balance-card">
            <div class="wallet-balance-label">总余额 (CNY)</div>
            <div class="wallet-balance-amount" id="wallet-total-balance">0.00</div>
        </div>
        <div class="wallet-stats-row">
            <div class="wallet-stat-box">
                <div class="wallet-stat-label in">本月收入</div>
                <div class="wallet-stat-val" id="wallet-month-income">0.00</div>
            </div>
            <div class="wallet-stat-box">
                <div class="wallet-stat-label out">本月支出</div>
                <div class="wallet-stat-val" id="wallet-month-expense">0.00</div>
            </div>
        </div>
        <div class="wallet-actions">
            <button class="wallet-btn income" onclick="openWalletModal('recharge')"><span>+</span> 充值</button>
        </div>
        <div class="wallet-list-container">
            <div class="wallet-list-header">
                <div class="wallet-list-title">本月明细</div>
                <div class="wallet-month-badge" id="wallet-current-month">2月</div>
            </div>
            <div class="wallet-items-scroll" id="wallet-transaction-list"></div>
        </div>
    </div>
</div>

<!-- World Book App Page -->
<div id="worldbook-app-page">
    <div class="wb-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="wb-back-btn-img" onclick="closeWorldBookApp()">
        <div class="wb-title">世界书>៸៸៸< </div>
        <div class="wb-header-actions">
             <img src="https://img.heliar.top/file/1770251413162_颜色滤镜_color-filter.png" class="wb-action-icon" onclick="openWorldBookColorSettings()">
            <div class="wb-add-btn" onclick="openWorldBookAddModal()">+</div>
        </div>
    </div>
    <div class="wb-content" id="worldbook-list"></div>
</div>

<!-- World Book Add Modal -->
<div id="worldbook-add-modal">
    <div class="wb-modal-card">
        <div class="wb-modal-header">添加世界书</div>
        <div class="wb-modal-scroll-area">
            <div class="wb-input-label">世界书名</div>
            <input type="text" id="wb-title-input" class="wb-main-input" placeholder="输入世界书名称...">
            <div id="wb-dynamic-entries">
                <div class="wb-entry-row wb-dynamic-row">
                    <input type="text" class="wb-entry-input key" placeholder="名称（可选）">
                    <textarea class="wb-entry-input val" placeholder="世界书内容"></textarea>
                </div>
            </div>
            <button class="wb-plus-row-btn" onclick="addWorldBookEntryRow()">+</button>
        </div>
        <div class="wb-modal-actions">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeWorldBookAddModal()">取消</button>
            <button class="wb-action-btn wb-btn-ok" onclick="saveWorldBook()">OK</button>
        </div>
    </div>
</div>

<!-- World Book Detail Modal -->
<div id="worldbook-detail-modal">
    <div class="wb-detail-header">
        <div class="wb-detail-back" onclick="closeWorldBookDetail()">＜</div>
        <div class="wb-detail-title" id="wb-detail-title-text">Title</div>
        <button class="wb-delete-book-btn" onclick="deleteCurrentWorldBook()">删除</button>
    </div>
    <div class="wb-detail-content" id="wb-detail-content-area"></div>
</div>

<!-- World Book Color Settings Page -->
<div id="worldbook-color-page">
    <div class="wb-color-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="wb-back-btn-img" onclick="closeWorldBookColorSettings()">
        <div class="wb-color-title">世界书设置</div>
        <button class="wb-color-save-btn" onclick="saveWorldBookColors()">OK</button>
    </div>
    <div class="wb-color-content" id="wb-color-list"></div>
</div>

<!-- *** START: Takeout App *** -->
<div id="takeout-app-page">
    <div class="takeout-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="takeout-back-btn" onclick="closeTakeoutApp()">
        <div class="takeout-title" id="takeout-top-bar-title">点菜</div>
        <button id="takeout-toggle-edit-btn">编辑</button>
    </div>

    <div class="takeout-content-wrapper">
        <div id="takeout-page-order" class="page active">
            <div class="order-layout">
                <div class="category-sidebar"><div id="takeout-category-list"></div></div>
                <div class="dishes-main"><div id="takeout-dish-list"></div></div>
            </div>
            <div id="takeout-order-footer" class="order-footer hidden">
                <div class="total-info">已选 <span id="takeout-total-quantity">0</span> 件</div>
                <button id="takeout-place-order-btn">下单</button>
            </div>
        </div>
        <div id="takeout-page-menu" class="page"><div id="takeout-menu-list"></div></div>
        <div id="takeout-page-my" class="page">
            <div class="my-profile">
                <div class="my-avatar-wrapper" onclick="document.getElementById('takeout-avatar-upload-input').click()">
                    <img id="takeout-my-avatar-img" src="https://img.zcool.cn/community/01f0835ab4170ea8012062e3c351cf.png@260w_195h_1c_1e_1o_100sh.png" alt="avatar" class="my-avatar">
                </div>
                <input type="file" id="takeout-avatar-upload-input" accept="image/*" style="display: none;">
                <div id="takeout-my-id-display">尚未生成ID</div>
                <button id="takeout-get-my-id-btn" class="button">获取我的ID</button>
            </div>
            <div class="card"><h2>绑定好友</h2><div id="takeout-bind-status" class="status-text" style="margin-top:0; margin-bottom:15px;">当前未绑定好友</div><div class="input-group"><input type="number" id="takeout-friend-id-input" placeholder="输入好友ID"><button id="takeout-bind-friend-btn" class="button">绑定</button></div></div>
            <div class="card"><h2>数据管理</h2><div class="modal-actions"><button id="takeout-import-data-btn" class="button secondary" onclick="document.getElementById('takeout-import-file-input').click()">导入数据</button><button id="takeout-export-data-btn" class="button secondary">导出数据</button></div><input type="file" id="takeout-import-file-input" accept=".json" style="display:none;"></div>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <button class="nav-item active" data-page="takeout-page-order"><svg viewBox="0 0 24 24"><path d="M16 6V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H2v13c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6h-6zm-6-2h4v2h-4V4zM4 8h16v11H4V8zm2 1v3h3V9H6zm5 0v3h3V9h-3zm5 0v3h3V9h-3z"></path></svg><span>点菜</span></button>
        <button class="nav-item" data-page="takeout-page-menu"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg><span>菜单</span></button>
        <button class="nav-item" data-page="takeout-page-my"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg><span>我的</span></button>
    </nav>
    
    <div id="takeout-dish-detail-modal" class="modal"><div class="modal-content"><button class="close-modal-btn">&times;</button><img id="takeout-dish-detail-image" src=""><h3 id="takeout-dish-detail-name"></h3><h4>制作步骤</h4><div id="takeout-dish-detail-steps" class="steps-content"></div></div></div>
    <div id="takeout-edit-dish-full-modal" class="modal"><div class="modal-content"><button class="close-modal-btn">&times;</button><h3 id="takeout-edit-dish-full-title">编辑菜品</h3><input type="hidden" id="takeout-edit-dish-full-id"><div class="image-upload-container"><img id="takeout-edit-dish-image-preview" class="image-preview" src="" alt="点击上传图片" onclick="document.getElementById('takeout-edit-dish-image-input').click();"></div><input type="file" id="takeout-edit-dish-image-input" accept="image/*" style="display:none;"><input type="text" id="takeout-edit-dish-full-name" placeholder="菜品名称"><textarea id="takeout-edit-dish-full-steps" placeholder="制作步骤..."></textarea><div class="modal-actions"><button id="takeout-save-dish-full-btn" class="button">确定</button></div></div></div>
    <div id="takeout-edit-menu-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal-btn">&times;</button>
            <h3>编辑菜单</h3>
            <input type="hidden" id="takeout-edit-menu-id">
            <div class="image-upload-container">
                 <img id="takeout-edit-menu-image-preview" class="image-preview round" src="" alt="点击上传图片" onclick="document.getElementById('takeout-edit-menu-image-input').click();">
            </div>
            <input type="file" id="takeout-edit-menu-image-input" accept="image/*" style="display:none;">
            <input type="text" id="takeout-edit-menu-name" placeholder="菜单合集名称">
            <div class="modal-actions">
                <button id="takeout-save-menu-btn" class="button">保存</button>
            </div>
        </div>
    </div>
</div>
<!-- *** END: Takeout App *** -->


<!-- Wallet Recharge Modal -->
<div id="wallet-add-modal">
    <div class="wallet-add-card">
        <div class="wallet-modal-title">充值</div>
        <div class="wallet-input-group">
            <input type="number" id="wallet-amount-input" class="wallet-input" placeholder="0.00" step="0.01">
        </div>
        <button class="wallet-confirm-btn" onclick="saveRecharge()">确认充值</button>
        <button class="wallet-cancel-btn" onclick="closeWalletModal()">取消</button>
    </div>
</div>


<!-- 添加好友弹窗 -->
<div id="add-friend-modal">
    <div class="add-friend-card">
        <div class="add-friend-close" onclick="closeAddFriendModal()">✕</div>
                <img src="https://img.heliar.top/file/1770069003752_保存_save.png" class="add-friend-save" onclick="saveNewFriend()">
        <div class="add-friend-avatar-upload" onclick="triggerAvatarUpload()">
            <span id="avatar-placeholder-icon">+</span>
            <img id="new-friend-avatar-preview" class="add-friend-avatar-preview">
        </div>
        <input type="text" class="add-friend-url-input" id="new-friend-avatar-url" placeholder="或粘贴图片链接" oninput="handleAvatarUrlInput(this)">
        <input type="text" class="add-friend-input" id="new-friend-name" placeholder="姓名">
        <input type="text" class="add-friend-input" id="new-friend-alias" placeholder="备注 (可选)">
    </div>
</div>

<!-- 删除好友确认弹窗 -->
<div id="delete-friend-confirm-modal" class="delete-confirm-modal">
    <div class="delete-card">
        <div class="delete-card-title">确定删除该好友吗π_π</div>
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeDeleteModal('delete-friend-confirm-modal')">取消</button>
            <button class="delete-card-btn btn-confirm-delete" onclick="executeDeleteFriend()">删除</button>
        </div>
    </div>
</div>

<!-- 删除朋友圈确认弹窗 -->
<div id="delete-moment-confirm-modal" class="delete-confirm-modal">
    <div class="delete-card">
        <div class="delete-card-title">删除该朋友圈？</div>
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeDeleteModal('delete-moment-confirm-modal')">取消</button>
            <button class="delete-card-btn btn-confirm-delete" onclick="executeDeleteMoment()">删除</button>
        </div>
    </div>
</div>

<!-- World Book Binding Modal -->
<div id="worldbook-bind-modal">
    <div class="wb-bind-modal-card">
        <div class="wb-bind-modal-header">
            <span id="wb-bind-modal-title">选择绑定的世界书</span>
            <span class="close-btn" onclick="closeWorldBookBindModal()">✕</span>
        </div>
        <div class="wb-bind-modal-list" id="worldbook-bind-list"></div>
        <div class="wb-bind-modal-actions">
            <button class="wb-action-btn wb-btn-ok" onclick="confirmWbBinding()">确定</button>
        </div>
    </div>
</div>

<!-- Urge to Post Modal -->
<div id="urge-post-overlay" class="delete-confirm-modal" style="display: none;">
    <div id="urge-post-card" class="wb-modal-card" style="max-height: 70vh; background: white; width: 90%; max-width: 380px;" onclick="event.stopPropagation()">
        <div class="wb-modal-header" style="color: #facee4; font-size: 18px;">催ta发动态</div>
        <div id="urge-post-char-list" class="wb-modal-scroll-area" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px;">
        </div>
        <div class="wb-modal-actions">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeUrgeToPostModal()">取消</button>
            <button class="wb-action-btn wb-btn-ok" onclick="confirmUrgeToPost()">确定</button>
        </div>
    </div>
</div>

<!-- Save CSS Preset Modal -->
<div id="save-preset-modal" class="delete-confirm-modal" style="display: none;">
    <div class="delete-card" onclick="event.stopPropagation()" style="text-align: left; padding: 20px;">
        <div class="delete-card-title" style="text-align: center; margin-bottom: 15px;">保存预设样式</div>
        <input type="text" id="preset-name-input" class="add-friend-input" placeholder="输入预设名称..." style="margin-bottom: 20px;">
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeSaveCssPresetModal()">取消</button>
            <button class="delete-card-btn wb-btn-ok" style="background:var(--theme-pink-btn); color:white;" onclick="saveCurrentCssPreset()">保存</button>
        </div>
    </div>
</div>


<!-- Moments Action Sheet (Popup) -->
<div id="moments-action-sheet-overlay" onclick="closeMomentsActionSheet()">
   <div id="moments-action-sheet" onclick="event.stopPropagation()">
       <div class="action-sheet-option" onclick="handleMomentAction('shoot')">
            <div class="action-title">拍摄</div>
            <div class="action-subtitle">照片或视频</div>
       </div>
       <div class="action-sheet-option" onclick="handleMomentAction('album')">从手机相册选择</div>
       <div class="action-sheet-cancel" onclick="closeMomentsActionSheet()">取消</div>
   </div>
</div>

<div id="settings-page">
    <div class="settings-header">
        <div class="back-btn-container" onclick="hideSettingsPage()">
            <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-icon-img">
        </div>
        <span class="title">设置</span>
                <button id="save-settings-btn">OK</button>
    </div>
                
    <div class="settings-content">
        <div class="settings-module">
            <h3>通用</h3>
            <div class="settings-row-with-switch">
                <label for="ios-mode-switch">iOS 模式 (刘海屏适配)</label>
                <label class="ios-switch">
                    <input type="checkbox" id="ios-mode-switch">
                                        <span class="slider round"></span>
                </label>
            </div>
            <div class="settings-row-with-switch" style="margin-top: 10px;">
                <label for="phone-frame-switch">手机框</label>
                <label class="ios-switch">
                    <input type="checkbox" id="phone-frame-switch">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        
        <div class="settings-module" id="phone-frame-settings-module" style="display: none;">
            <h3>手机框设置</h3>
            <div class="settings-row-with-switch">
                <label for="cat-ears-switch">手机壳猫耳朵</label>
                <label class="ios-switch">
                    <input type="checkbox" id="cat-ears-switch">
                    <span class="slider round"></span>
                </label>
            </div>
             <div class="settings-row-with-switch" style="margin-top:10px;">
                <label for="phone-case-color-input">手机壳颜色</label>
                <input type="color" id="phone-case-color-input" value="#ffffff" style="width: 50px; height: 30px; border: 1px solid #ddd; padding: 2px; border-radius: 6px; cursor: pointer; background-color: transparent;">
            </div>
            <div class="settings-row-with-switch" style="margin-top:10px;">
                <label for="cat-ear-color-input">猫耳朵颜色</label>
                <input type="color" id="cat-ear-color-input" value="#ffffff" style="width: 50px; height: 30px; border: 1px solid #ddd; padding: 2px; border-radius: 6px; cursor: pointer; background-color: transparent;">
            </div>
        </div>
        
        <div class="settings-module">
            <h3>AI API 设置</h3>
            <div class="settings-row">
                <label for="api-url-input">API 地址</label>
                <input type="text" id="api-url-input" placeholder="例如: https://api.openai.com/v1">
            </div>
            <div class="settings-row">
                <label for="api-key-input">API Key</label>
                <input type="password" id="api-key-input" placeholder="输入您的 API Key">
            </div>
            <div class="settings-row">
                <label>模型设置</label>
                <div class="api-control-wrapper">
                    <div class="api-control-row">
                        <span id="api-status" class="api-status disconnected">未连接</span>
                    </div>
                    <div class="api-control-buttons">
                        <button id="test-api-btn">测试连接</button>
                        <button id="fetch-models-btn">获取模型列表</button>
                    </div>
                    <div class="select-wrapper" id="model-select-wrapper" style="display: none; margin-top: 10px;">
                        <select id="model-select"></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="settings-module">
            <h3>AI 参数设置</h3>
            <div class="settings-row">
                <label>回答温度 (Temperature)</label>
                <div class="temp-slider-container">
                    <input type="range" id="temp-slider" min="0" max="2" step="0.1" value="0.8">
                    <span id="temp-value-display">0.8</span>
                </div>
            </div>
        </div>
                <div class="settings-module">
            <h3>界面美化</h3>
            <div class="settings-row">
                <label for="wallpaper-url">主屏幕壁纸 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="wallpaper-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="wallpaper-preview"></div>
                </div>
            </div>

            <!-- --- 新增的代码 --- -->
            <div class="settings-row-with-switch" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                <label for="icon-font-color-switch">开关灯💡</label>
                <label class="ios-switch">
                    <input type="checkbox" id="icon-font-color-switch">
                    <span class="slider round"></span>
                </label>
            </div>
            <!-- --- 新增结束 --- -->
            
        </div>
        <div class="settings-module">
            <h3>组件图片</h3>
            <div class="settings-row">
                <label for="widget-square-url">左下组件 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="widget-square-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="widget-square-preview"></div>
                </div>
            </div>
            <div class="settings-row">
                <label for="custom-image-url">右上组件 URL</label>
                <div class="input-with-preview">
                    <input type="text" id="custom-image-url" placeholder="输入图片 URL">
                    <div class="url-preview" id="custom-image-preview"></div>
                </div>
            </div>
        </div>
        <div class="settings-module">
            <h3>自定义主屏幕App图标</h3>
            <div class="settings-app-list" id="settings-app-list-container"></div>
        </div>
                    <div class="settings-module">
            <h3>备份与恢复</h3>
            <p style="font-size: 12px; color: #999; margin-bottom: 15px;">导出的备份文件包含您的所有角色、聊天记录、设置和美化数据。请妥善保管。</p>
            <div class="api-control-buttons">
                <button onclick="exportBackup()">导出备份</button>
                <button onclick="document.getElementById('import-backup-input').click()">导入备份</button>
            </div>
        </div>
    </div>
</div>

<div id="ai-chat-modal">
    <div id="ai-chat-container">
        <div class="chat-header">
            <span class="model-name" id="current-model-name">未选择模型</span>
            <button class="close-btn" onclick="closeAIChat()">×</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai">你好！我是 AI 助手。请点击底栏第一个图标进入设置配置 API，然后我们就可以聊天了。</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="说点什么..." onkeypress="handleChatKeyPress(event)">
            <button id="send-chat-btn" onclick="sendChatMessage()">发送</button>
        </div>
    </div>
</div>

<div id="toast-notification"></div>

<div id="me-settings-modal">
    <div class="me-settings-header-bar">
        <button class="me-settings-close-btn" onclick="closeMeSettings()">关闭</button>
        <span class="me-settings-header-title">个人主页设置</span>
        <button class="me-settings-save-btn" onclick="saveMeSettings()">保存</button>
    </div>
    <div class="me-settings-scroll-content">
        <div class="me-settings-group">
            <h3>个人资料</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">昵称</div>
                <input type="text" id="me-settings-nickname" class="me-settings-input" placeholder="输入昵称">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">QQ号</div>
                <input type="text" id="me-settings-qq-id" class="me-settings-input" placeholder="输入QQ号">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">点赞数</div>
                <input type="number" id="me-settings-likes" class="me-settings-input" placeholder="输入点赞数值">
            </div>
        </div>

        <div class="me-settings-group">
            <h3>界面信息</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">头像</div>
                <div class="me-settings-preview-wrapper" onclick="triggerProfileAvatarUpload()"><img id="me-settings-avatar-preview" class="me-settings-preview avatar" style="border-radius:50%; cursor:pointer;"></div>
                <input type="text" id="me-settings-avatar-url" class="me-settings-input" placeholder="头像 URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">背景</div>
                <div class="me-settings-preview-wrapper"><img id="me-settings-cover-preview" class="me-settings-preview cover"></div>
                <input type="text" id="me-settings-cover-url" class="me-settings-input" placeholder="背景图 URL">
            </div>
        </div>
        
        <div class="me-settings-group">
            <h3>朋友圈</h3>
             <div class="me-settings-row">
                <div class="me-settings-label">朋友圈头像</div>
                <div class="me-settings-preview-wrapper" onclick="triggerMomentsAvatarUpload()"><img id="me-settings-moments-avatar-preview" class="me-settings-preview avatar" style="cursor:pointer;"></div>
                <input type="text" id="me-settings-moments-avatar-url" class="me-settings-input" placeholder="朋友圈头像 URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">朋友圈背景</div>
                <div class="me-settings-preview-wrapper"><img id="me-settings-moments-cover-preview" class="me-settings-preview cover"></div>
                <input type="text" id="me-settings-moments-cover-url" class="me-settings-input" placeholder="朋友圈背景图 URL">
            </div>
        </div>

        <div class="me-settings-group">
            <h3>安全设置</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">支付密码</div>
                <input type="text" id="me-settings-payment-password" class="me-settings-input" placeholder="设置6位数字密码" maxlength="6" inputmode="numeric" pattern="[0-9]*">
            </div>
        </div>

        <div class="me-settings-group">
            <h3>会员图标列表 (8个)</h3>
            <div id="me-settings-member-icons-list"></div>
        </div>
    </div>
</div>

<!-- Forum App 页面 -->
<div id="forum-app-page">
    <div id="forum-content-wrapper">
        <div id="forum-page-home" class="forum-page active">
            <div class="forum-header-home">
                 <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="forum-header-back-btn" onclick="closeForumApp()">
                <h1 class="forum-header-title">论坛</h1>
                <img src="https://img.heliar.top/file/1770413434847_添加_add-one.png" class="forum-header-create-btn" onclick="openCreateForumModal()">
            </div>
            
            <div id="forum-list-container"></div>
            <div id="forum-posts-area"></div>
        </div>

        <div id="forum-page-detail" class="forum-page">
            <div id="forum-detail-header">
                <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="forum-header-back-btn" onclick="closeForumDetail()">
                <img id="forum-detail-header-avatar" class="forum-detail-header-avatar" src="">
                <span id="forum-detail-header-name"></span>
                <div class="actions">
                    <div id="forum-detail-level-display">
                        <span id="forum-detail-level" style="font-weight: bold; color: var(--theme-pink-text); font-size: 13px;"></span>
                        <div class="forum-exp-bar-wrapper">
                            <div id="forum-detail-exp-bar" class="forum-exp-bar-progress"></div>
                        </div>
                    </div>
                     <span id="forum-detail-exp-text" style="font-size: 11px; color: #aaa; white-space: nowrap;"></span>
                    <button id="forum-detail-signin-btn">签到</button>
                    <img src="https://img.heliar.top/file/1770580892666_刷新_refresh.png" class="forum-header-refresh-btn" id="forum-detail-refresh-btn">
                </div>
            </div>
            <div id="forum-detail-posts-area"></div>
        </div>
        
        <div id="forum-page-post" class="forum-page">
             <div class="forum-post-top-bar">
                 <button class="forum-post-cancel" onclick="switchForumTab(0)">取消</button>
                 <div class="forum-post-title">发帖</div>
                 <button class="forum-post-submit" onclick="submitForumPost()">发布</button>
             </div>
             <div class="forum-post-editor">
                 <div class="forum-selector-wrapper">
                     <span class="forum-selector-label">发布到</span>
                     <select id="forum-post-target-select" class="forum-selector-select">
                         <option value="">请选择吧群...</option>
                     </select>
                 </div>
                 <textarea id="forum-post-textarea" class="forum-post-textarea" placeholder="分享你的新鲜事..."></textarea>
                 <div class="forum-post-image-grid" id="forum-post-image-grid">
                     <div class="forum-post-add-img" onclick="triggerForumPostImageUpload()">+</div>
                 </div>
             </div>
        </div>
        
        <div id="forum-page-me" class="forum-page">
            <div id="forum-me-profile-container" style="position: relative; width: 100%; display: flex; flex-direction: column; flex: 1;">
                <div id="forum-me-bg" style="width: 100%; height: 260px; background-color: #e0e0e0; background-image: url('https://images.unsplash.com/photo-1501854140801-50d01698950b?auto=format&fit=crop&w=1000&q=80'); background-size: cover; background-position: center; cursor: pointer; flex-shrink: 0; position: relative;">
                    <div style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100px; background: linear-gradient(to top, rgba(0,0,0,0.4), transparent); pointer-events: none;"></div>
                </div>
                <div id="forum-me-header" style="padding: 0 20px; display: flex; flex-direction: column; margin-top: -60px; position: relative; z-index: 2; flex-shrink: 0;">
                    <div style="display: flex; align-items: flex-end; justify-content: space-between;">
                         <div style="display: flex; align-items: flex-end; gap: 15px;">
                            <img id="forum-me-avatar" src="https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                            <div style="padding-bottom: 5px;">
                                <div id="forum-me-nickname">User</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="forum-me-stats" style="display: flex; gap: 25px; margin-top: 15px; padding: 0 10px;">
                        <div style="text-align: center;"><span style="font-weight: 700; font-size: 16px; color: #333;">12</span><div style="font-size: 12px; color: #999;">帖子</div></div>
                        <div style="text-align: center;"><span style="font-weight: 700; font-size: 16px; color: #333;">482</span><div style="font-size: 12px; color: #999;">关注</div></div>
                        <div style="text-align: center;"><span style="font-weight: 700; font-size: 16px; color: #333;">9.8k</span><div style="font-size: 12px; color: #999;">粉丝</div></div>
                    </div>
                </div>

                <div class="forum-me-menu-list">
                     <div class="forum-me-menu-item">
                        <span class="menu-item-left">我的帖子</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                    <div class="forum-me-menu-item">
                        <span class="menu-item-left">收藏列表</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                    <div class="forum-me-menu-item">
                        <span class="menu-item-left">关注的人</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                     <div class="forum-me-menu-item" onclick="openForumMeSettings()">
                        <span class="menu-item-left">设置</span>
                        <img class="arrow" src="https://img.heliar.top/file/1770589908494_右_right.png">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 悬浮胶囊底栏 -->
    <div id="forum-bottom-nav">
        <div class="forum-nav-item active" onclick="switchForumTab(0)">
            <img src="https://img.heliar.top/file/1770411000514_首页_home.png" class="forum-nav-icon">
        </div>
        <div class="forum-nav-item" onclick="switchForumTab(1)">
            <img src="https://img.heliar.top/file/1770411008165_添加_add.png" class="forum-nav-icon">
        </div>
        <div class="forum-nav-item" onclick="switchForumTab(2)">
            <img src="https://img.heliar.top/file/1770411008745_用户_user.png" class="forum-nav-icon">
        </div>
    </div>
</div>

<!-- 创建论坛弹窗 -->
<div id="create-forum-modal-overlay">
    <div id="create-forum-modal-card">
        <h2 class="create-forum-title">创建新论坛</h2>
        <div class="create-forum-content">
                        <div class="create-forum-avatar-upload" onclick="triggerForumAvatarUpload()">
                <span id="forum-avatar-placeholder">+</span>
                <img id="new-forum-avatar-preview" src="">
            </div>
            <input type="text" id="new-forum-name-input" class="create-forum-input" placeholder="论坛名称">
            <textarea id="new-forum-worldview-input" class="create-forum-textarea" placeholder="论坛世界观... (可选)"></textarea>
            <div id="new-forum-wb-selection-display">未绑定世界书</div>
            <button class="create-forum-wb-btn" onclick="openForumWbBindModal()">绑定世界书 (可选)</button>
            <div id="new-forum-role-selection-display">未绑定角色</div>
                        <button class="create-forum-wb-btn" onclick="openForumCreateRoleBindModal()">绑定角色 (可选)</button>
        </div>
        <div class="create-forum-actions">
            <button class="create-forum-btn cancel" onclick="closeCreateForumModal()">取消</button>
            <button class="create-forum-btn confirm" onclick="saveNewForum()">确认创建</button>
        </div>
    </div>
</div>

<!-- Forum Me Settings Modal -->
<div id="forum-me-settings-modal" class="delete-confirm-modal" style="display: none;">
    <div class="wb-modal-card" onclick="event.stopPropagation()" style="background: var(--theme-pink-bg-soft);">
        <div class="wb-modal-header" style="background: transparent; border: none; padding-bottom: 0;">论坛个人设置</div>
        <div class="wb-modal-scroll-area">
            <h3 class="settings-module-title" style="font-size:15px;color:#555;margin-bottom:10px; padding-left: 5px;">个人资料</h3>
            <div class="me-settings-group" style="padding:15px;">
                <div class="me-settings-row">
                    <div class="me-settings-label">头像</div>
                    <div class="me-settings-preview-wrapper" onclick="triggerForumMeAvatarUpload()">
                        <img id="forum-me-settings-avatar-preview" class="me-settings-preview avatar" style="cursor:pointer;">
                    </div>
                    <input type="text" id="forum-me-settings-avatar-url" class="me-settings-input" placeholder="头像 URL">
                </div>
                 <div class="me-settings-row" style="margin-top: 15px;">
                    <div class="me-settings-label">背景</div>
                    <div class="me-settings-preview-wrapper" onclick="triggerForumMeBgUpload()">
                                                <img id="forum-me-settings-bg-preview" class="me-settings-preview cover" style="cursor:pointer;">
                    </div>
                    <input type="text" id="forum-me-settings-bg-url" class="me-settings-input" placeholder="背景 URL">
                </div>
                <div class="me-settings-row" style="margin-top: 15px;">
                    <div class="me-settings-label">昵称</div>
                    <input type="text" id="forum-me-settings-nickname" class="me-settings-input" placeholder="论坛专属昵称">
                </div>
            </div>
        </div>
        <div class="wb-modal-actions" style="border:none; padding-top: 0;">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeForumMeSettings()">取消</button>
                        <button class="wb-action-btn wb-btn-ok" onclick="saveForumMeSettings()">保存</button>
        </div>
    </div>
</div>

<!-- Mall App Page -->
<div id="mall-app-page">
    <div class="mall-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-btn" onclick="closeMallApp()">
        <div class="mall-header-title">商城</div>
        <div class="mall-header-actions">
            <img src="https://img.heliar.top/file/1770580892666_刷新_refresh.png" class="refresh-btn" id="mall-refresh-btn">
            <button class="mall-add-btn" id="mall-add-category-btn">+</button>
        </div>
    </div>
    <div class="mall-category-nav" id="mall-category-nav"></div>
    <div class="mall-content" id="mall-content">
        <div class="mall-product-grid" id="mall-product-grid"></div>
    </div>
    <div class="mall-bottom-nav">
        <div class="mall-nav-item active">
            <img src="https://img.heliar.top/file/1770921774009_首页_home_3.png" class="mall-nav-icon">
            <span class="mall-nav-text">首页</span>
        </div>
        <div class="mall-nav-item">
            <img src="https://img.heliar.top/file/1770921767590_购物车_shopping_2.png" class="mall-nav-icon">
            <span class="mall-nav-text">购物车</span>
        </div>
        <div class="mall-nav-item">
            <img src="https://img.heliar.top/file/1770921771134_无嘴脸_face-without-mouth.png" class="mall-nav-icon">
            <span class="mall-nav-text">我</span>
        </div>
    </div>
</div>
<!-- Mall Detail Page (NEW) -->
<div id="mall-detail-page">
    <div class="mall-detail-header">
        <img src="https://img.heliar.top/file/1770068142146_骨头_bone.png" class="back-btn" onclick="closeMallDetail()">
        <div class="mall-header-title">商品详情</div>
    </div>
    <div class="mall-detail-content" id="mall-detail-content">
        <!-- 商品详情将动态渲染到这里 -->
    </div>
            <div class="mall-detail-footer">
        <div class="footer-btn favorite" id="mall-detail-fav-btn">
            <img src="https://img.heliar.top/file/1772373425318_喜欢_like_5.png" alt="Favorite">
            <span>收藏</span>
        </div>
        <!-- 新增：加购物车按钮 -->
        <div class="footer-btn cart" id="mall-detail-add-cart-btn">
            <img src="https://img.heliar.top/file/1770921767590_购物车_shopping_2.png" alt="Cart">
            <span>加购物车</span>
        </div>
        <div class="footer-btn buy">
            <span>立即购买</span>
        </div>
    </div>
</div> <!--  <--【关键】补上这个缺失的结束标签，修复页面结构 -->
<!-- ========================= 新增：商品购买弹窗 ========================= -->
<div id="mall-purchase-overlay" onclick="closePurchasePanel()">
    <div id="mall-purchase-panel" onclick="event.stopPropagation()">
        <div class="mall-purchase-header">
            <span id="mall-purchase-product-emoji"></span>
            <div class="mall-purchase-product-info">
                <div id="mall-purchase-product-price"></div>
                <div id="mall-purchase-quantity-selector">
                    <button class="quantity-btn minus">-</button>
                    <span id="mall-purchase-quantity">1</span>
                    <button class="quantity-btn plus">+</button>
                </div>
            </div>
            <div id="mall-purchase-close-btn" onclick="closePurchasePanel()">✕</div>
        </div>
        <div class="mall-purchase-body">
            <div class="mall-purchase-styles-section">
                <h4 class="section-title">款式</h4>
                <div id="mall-purchase-styles-grid">
                    <!-- 款式会由JS动态生成到这里 -->
                </div>
            </div>
        </div>
        <div class="mall-purchase-footer">
            <button id="mall-purchase-confirm-btn">确定</button>
        </div>
    </div>
</div>
<!-- ========================= 新增结束 ========================= -->

<!-- Mall Add/Edit Category Modal -->
<div id="mall-category-modal" class="delete-confirm-modal">
    <div class="wb-modal-card" onclick="event.stopPropagation()">
        <div id="mall-category-modal-title" class="wb-modal-header">添加商品种类</div>
        <div class="wb-modal-scroll-area">
             <div class="wb-input-label">分类名称</div>
             <input type="text" id="mall-category-name-input" class="wb-main-input" placeholder="输入分类名称">
             <div class="wb-input-label">补充说明</div>
             <textarea id="mall-category-desc-input" class="wb-entry-input val" placeholder="补充说明(可选)" style="min-height: 80px; width:100%; margin-bottom: 15px;"></textarea>
             <button class="wb-action-btn wb-btn-ok" style="width: 100%; margin-top: 5px;" onclick="openMallCategoryRoleBindModal()">绑定角色</button>
        </div>
        <div id="mall-category-modal-actions" class="wb-modal-actions">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeMallCategoryModal()">取消</button>
            <button class="wb-action-btn wb-btn-ok" onclick="saveMallCategory()">OK</button>
        </div>
    </div>
</div>

<!-- Transfer Page -->
<div id="transfer-page">
    <img src="https://img.heliar.top/file/1770721895553_左_left.png" class="transfer-back-btn" onclick="closeTransferPage()">
    <div class="transfer-page-top">
        <div class="transfer-title-info">
             <img id="transfer-target-avatar" class="transfer-target-avatar" src="">
             <span id="transfer-target-name-container">转账给...</span>
        </div>
    </div>
    <div class="transfer-page-bottom">
        <p class="transfer-amount-title">转账金额</p>
        <div class="transfer-amount-input-area">
            <span class="transfer-currency-symbol">¥</span>
            <input type="number" id="transfer-amount-input" class="transfer-amount-input" placeholder="0.00" oninput="checkTransferAmount(this)" onkeydown="handleTransferInputKey(event)">
        </div>
    </div>
</div>


<!-- Transfer Confirmation & Password Popup -->
<div id="transfer-confirm-overlay">
    <div id="transfer-confirm-popup">
        <div class="confirm-popup-header">
            <img src="https://img.heliar.top/file/1770767041294_关闭_close-one_2.png" class="confirm-popup-close" onclick="closeTransferConfirmPopup()">
            <span id="confirm-popup-title">确认付款</span>
        </div>
                <!-- 删除了这里的 onclick 属性 -->
                <div id="payment-details-section">
            <div class="confirm-popup-content">
                <div id="confirm-transfer-target">向 ... 转账</div>
                <div id="confirm-transfer-amount">¥100.00</div>
                <div class="confirm-payment-method">
                    <span>付款方式</span>
                    <div class="payment-method-details">
                        <img src="https://img.heliar.top/file/1770715803688_金融_finance.png" class="payment-icon">
                        <span>零钱</span>
                        <img src="https://img.heliar.top/file/1770715921438_校验-小_check-small.png" class="payment-check">
                    </div>
                </div>
            </div>
        </div>
        <div class="password-input-section" id="password-input-section">
            <p>请输入支付密码</p>
            <div class="password-boxes" id="password-boxes">
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
                <div class="password-box"></div>
            </div>
            <p class="password-error-tip" id="password-error-tip"></p>
        </div>
        <div class="numeric-keypad" id="numeric-keypad"></div>
    </div>
</div>

<!-- 角色主动转账收款弹窗 -->
<div id="receive-transfer-overlay">
    <img src="https://img.heliar.top/file/1770913074122_左_left_2.png" class="receive-back-btn" onclick="closeReceiveTransferModal()">
    <div class="receive-card" onclick="event.stopPropagation()">
        <img src="https://img.heliar.top/file/1770903475517_时间_time.png" class="receive-icon">
        <span class="receive-status">待你收款</span>
        <span class="receive-amount" id="receive-transfer-amount">¥0.00</span>
        <div class="receive-info-section">
            <span class="receive-info-label">转账时间</span>
            <span class="receive-info-value" id="receive-transfer-time"></span>
        </div>
    </div>
    <div class="receive-actions-footer">
        <button class="receive-confirm-btn" onclick="confirmReceiveTransfer()">收款</button>
        <button class="receive-reject-btn" onclick="rejectReceiveTransfer()">退还</button>
    </div>
</div>

<!-- Recollection App Page -->
<div id="recollection-app-page">
    <div class="recollection-header">
        <img src="https://img.heliar.top/file/1771104670050_左_left_3.png" class="recollection-back-btn" onclick="closeRecollectionApp()">
        <h1 class="recollection-header-title">备忘录</h1>
    </div>
    <div class="recollection-content" id="recollection-grid"></div>
</div>
<div id="recollection-color-page" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--theme-pink-bg-light); z-index: 700; flex-direction: column; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);">
    <div class="wb-color-header">
        <img src="https://img.heliar.top/file/1771104670050_左_left_3.png" class="wb-back-btn-img" onclick="closeRecollectionColorSettings()">
        <div class="wb-color-title">水晶球颜色设置</div>
        <button class="wb-color-save-btn" onclick="saveRecollectionColorSettings()">保存</button>
    </div>
    <div class="wb-color-content" id="recollection-color-list"></div>
</div>
<div id="recollection-summary-modal" class="delete-confirm-modal">
    <div class="delete-card">
        <h3 class="delete-card-title">自动总结</h3>
        <p id="recollection-summary-info" style="margin-bottom: 25px; color: #666; font-size: 14px;">你还有 0 条聊天记录未总结。</p>
        <div class="delete-card-actions">
            <button class="delete-card-btn btn-cancel" onclick="closeRecollectionSummaryModal()">取消</button>
            <button id="recollection-summary-confirm-btn" class="delete-card-btn wb-btn-ok" style="background:var(--theme-pink-btn); color:white;" onclick="executeRecollectionSummary()">总结</button>
        </div>
    </div>
</div>
<!-- ================= 补回：回忆详情页 ================= -->
<div id="recollection-detail-page">
    <div class="recollection-detail-header">
        <img src="https://img.heliar.top/file/1771104670050_左_left_3.png" class="recollection-back-btn" onclick="closeRecollectionDetail()" style="width: 30px; height: 30px; object-fit: contain; cursor: pointer; z-index: 10;">
        <div class="recollection-detail-title" style="position:absolute; left:50%; transform:translateX(-50%); font-size:18px; font-weight:600; color:#ffd6e7;">回忆总结</div>
        <div class="recollection-detail-actions" style="display:flex; gap:15px; align-items:center; z-index: 10;">
            <div class="recollection-detail-add-icon" onclick="openAddRecollectionModal()" style="font-size:30px; font-weight:300; line-height:1; color:#888; cursor:pointer;">+</div>
            <img src="https://img.heliar.top/file/1772289026084_奶酪_cheese_2.png" class="recollection-detail-cheese-icon" onclick="openSummarizeRecollectionModal()" style="width:28px; height:28px; object-fit:contain; cursor:pointer;">
        </div>
    </div>
    <div class="recollection-detail-content" id="recollection-detail-content" style="flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px;"></div>
</div>

<!-- ================= 补回：新增/编辑回忆弹窗 ================= -->
<div id="recollection-edit-modal" class="delete-confirm-modal">
    <div class="wb-modal-card" onclick="event.stopPropagation()">
        <div class="wb-modal-header" id="recollection-modal-title">新增回忆</div>
        <div class="wb-modal-scroll-area">
            <textarea id="recollection-text-input" class="wb-entry-input val" placeholder="记录发生过的事情..." style="min-height: 120px; width: 100%; border: 1px solid #FADBE6;"></textarea>
        </div>
        <div class="wb-modal-actions" style="display:flex; justify-content:flex-end; gap:15px; margin-top:15px;">
            <button class="wb-action-btn wb-btn-cancel" onclick="closeRecollectionEditModal()">取消</button>
            <button class="wb-action-btn wb-btn-ok" style="background:var(--theme-pink-btn); color:white;" onclick="saveRecollection()">保存</button>
        </div>
    </div>
</div>

<!-- ================= 修复后：回忆便签操作菜单 ================= -->
<div id="recollection-action-sheet-overlay" onclick="closeRecollectionActionSheet()">
    <div id="recollection-action-sheet" onclick="event.stopPropagation()">
        <div class="action-sheet-option" id="btn-recollection-edit">编辑内容</div>
        <div class="action-sheet-option" id="btn-recollection-custom-color">修改背景颜色</div>
        <div class="action-sheet-option" id="btn-recollection-custom-bg">上传背景图片</div>
        <div class="action-sheet-option" id="btn-recollection-delete" style="color: #F44336;">删除</div>
        <div class="action-sheet-cancel" onclick="closeRecollectionActionSheet()">取消</div>
    </div>
</div>
<input type="file" id="input-forum-post-image" class="file-input-hidden" multiple accept="image/*" onchange="handleForumPostImageUpload(event)">
<input type="file" id="input-recollection-bg" class="file-input-hidden" accept="image/*" onchange="handleRecollectionItemBgUpload(event)">
<input type="color" id="input-recollection-color" class="file-input-hidden" onchange="handleRecollectionItemColorChange(event)">
<input type="color" id="input-crystal-color" class="file-input-hidden" oninput="handleCrystalBallColorChange(event)">

<input type="file" id="input-wallpaper" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
<input type="file" id="input-app-icon" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event)">
<input type="file" id="input-time-bg" class="file-input-hidden" accept="image/*" onchange="handleTimeBgUpload(event)">
<input type="file" id="input-friend-avatar" class="file-input-hidden" accept="image/*" onchange="handleFriendAvatarUpload(event)">
<input type="file" id="input-profile-avatar" class="file-input-hidden" accept="image/*" onchange="handleProfileAvatarUpload(event)">
<input type="file" id="input-photo-widget" class="file-input-hidden" accept="image/*" onchange="handlePhotoWidgetUpload(event)">
<input type="file" id="input-role-user-avatar" class="file-input-hidden" accept="image/*" onchange="handleRoleUserAvatarUpload(event)">
<input type="file" id="input-role-chat-bg" class="file-input-hidden" accept="image/*" onchange="handleRoleChatBgUpload(event)">
<input type="file" id="input-moment-image" class="file-input-hidden" multiple accept="image/*" onchange="handleMomentImageUpload(event)">
<input type="file" id="input-forum-avatar" class="file-input-hidden" accept="image/*" onchange="handleForumAvatarUpload(event)">
<input type="file" id="input-wb-cover" class="file-input-hidden" accept="image/*" onchange="handleWbCoverUpload(event)">
<input type="file" id="input-forum-me-avatar" class="file-input-hidden" accept="image/*" onchange="handleForumMeAvatarUpload(event)">
<input type="file" id="input-forum-me-bg" class="file-input-hidden" accept="image/*" onchange="handleForumMeBgUpload(event)">
<input type="file" id="input-moments-avatar" class="file-input-hidden" accept="image/*" onchange="handleMomentsAvatarUpload(event)">
<input type="file" id="input-moments-cover" class="file-input-hidden" accept="image/*" onchange="handleMomentsCoverUpload(event)">
</div> 
<input type="file" id="import-backup-input" class="file-input-hidden" accept=".json" onchange="importBackup(event)">

<!-- 手机外框结构 -->
<div class="phone-container" id="phone-container">
  <div class="phone" id="phone-frame">
    <!-- 插入独立的猫耳朵元素 -->
    <div class="cute-cat-ear left"></div>
    <div class="cute-cat-ear right"></div>
    
    <div class="screen" id="phone-screen-content"></div>
    <div class="notch"></div>
    <div class="status-bar">
      <div id="phone-status-time" class="status-time">00:00</div>
      <div class="status-right">
        <img src="https://img.heliar.top/file/1770883433951_IMG_4263.png" alt="new-icon">
        <img src="https://img.heliar.top/file/1768515766612_IMG_3349.png" alt="net">
        <img src="https://img.heliar.top/file/1768516105836_IMG_3350.png" alt="bat">
      </div>
    </div>
  </div>
</div>

<script>
    'use strict';
    const sleep = ms => new Promise(res => setTimeout(res, ms)); // <-- 添加这一行代码
    // --- DOM & Keys ---
    const body = document.body;
    const toast = document.getElementById('toast-notification');
    
    // --- LocalStorage Keys ---
    const ALL_SETTINGS_KEY = 'appSettings_v15';
    const CHAT_DATA_KEY = 'chatData_v5_final'; 
    const USER_PROFILE_KEY = 'userProfile_v4'; 
    const WALLET_DATA_KEY = 'walletData_v3'; 
    const WORLDBOOK_DATA_KEY = 'worldbookData_v3_covers';
    const IOS_MODE_KEY = 'iosModeEnabled_v1';
    const PHONE_FRAME_KEY = 'phoneFrameEnabled_v2'; 
    const PHONE_CASE_COLOR_KEY = 'phoneCaseColor_v1';
    const CAT_EARS_KEY = 'catEarsEnabled_v1';
    const CAT_EAR_COLOR_KEY = 'catEarColor_v1';
    const MOMENTS_DATA_KEY = 'momentsData_v4_private';
    const MOMENTS_PROFILE_KEY = 'momentsProfile_v2';
    const FORUMS_DATA_KEY = 'forumsData_v2';
    const FORUM_POSTS_DATA_KEY = 'forumPosts_v2';
    const FORUM_USER_DATA_KEY = 'forumUserData_v4';
    const CSS_PRESETS_KEY = 'cssPresets_v2_new';
    const RECOLLECTION_DATA_KEY_PREFIX = 'recollections_v3_style_fix'; 
    const MALL_CATEGORIES_KEY = 'mallCategories_v3_fix'; 
        const MALL_PRODUCTS_CACHE_KEY = 'mallProductsCache_v2'; 
    const TAKEOUT_APP_DATA_KEY = 'couple_order_data_v2'; 

    /* --- 新增的代码 --- */
    const ICON_FONT_LIGHT_MODE_KEY = 'iconFontLightMode_v1';
    /* --- 新增结束 --- */

    let customDateText = ""; 
    let tempAvatarUrl = ""; 
    let currentWalletType = 'recharge'; 
    let currentChatContactId = null; 
    let tempRoleBgUrl = ""; 
    let currentWorldBookId = null; 
    let tempSelectedWorldBookIds = []; 
    let tempMomentImages = []; 
    let currentCommentMomentId = null; 
    let currentDeleteMomentId = null; 
    let activeMsgIdForMenu = null;
    let isMultiSelectMode = false;
    let selectedMsgIds = new Set();
    
    let currentPasswordInput = '';
    let currentReceivingTransferId = null;
    
    let tempForumAvatarUrl = '';
    let tempForumWbIds = [];
    let tempForumBoundRoleIds = []; 
    let tempForumPostImages = [];
    let currentForumDetailId = null;
    let tempForumMeAvatarUrl = '';
    let tempForumMeBgUrl = ''; 

    let currentWbCoverUploadId = null;
    let wbBindCallback = null;
    let wbBindMultiSelect = false;

    let currentMallCategoryId = null; 
    let tempMallCategoryRoleIds = [];
    let isEditingMallCategory = false;


    let currentRecollectionContactId = null;
    let currentEditingRecollectionId = null;
    let currentRecollectionItemCustomizingId = null;
    let currentCrystalBallEditingId = null;
    let currentActionRecollectionId = null;

    let selectedUrgeCharIds = new Set();
    let isUrgeInProgress = false; 
    
    let autoPostTimers = {}; 

    // --- Utility Functions ---
    const showToast = (message, duration = 2000) => { toast.innerHTML = message; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), duration); };
    function escapeHtml(text) { if(typeof text !== 'string') return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    function compressImage(file, maxSize, callback) {
        if (!file) return; const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); let width = img.width; let height = img.height; if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } } canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height); callback(canvas.toDataURL('image/jpeg', 0.7)); }; img.src = e.target.result; }; reader.readAsDataURL(file);
    }
    
    // --- 手机框与猫耳朵功能 ---
    function applyPhoneFrame(enabled) {
      const appWrapper = document.getElementById('app-wrapper');
      const phoneScreen = document.getElementById('phone-screen-content');
      const bodyEl = document.body;
      const phoneContainer = document.getElementById('phone-container');
      const frameSettingsModule = document.getElementById('phone-frame-settings-module');
      
      const wasActive = bodyEl.classList.contains('phone-frame-active');
      
      if (enabled) {
        if (!wasActive) {
            bodyEl.classList.add('phone-frame-active');
            if (appWrapper && phoneScreen && !phoneScreen.contains(appWrapper)) {
                phoneScreen.appendChild(appWrapper);
            }
        }
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        const wp = settings.visual && settings.visual.wallpaper ? settings.visual.wallpaper : 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib-rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
        phoneScreen.style.backgroundImage = `url(${wp})`;
        bodyEl.style.backgroundImage = 'none';
        
        if (frameSettingsModule) frameSettingsModule.style.display = 'block';

      } else {
        if (wasActive) {
            bodyEl.classList.remove('phone-frame-active');
            if (appWrapper && bodyEl && phoneContainer && !bodyEl.contains(appWrapper)) {
                bodyEl.insertBefore(appWrapper, phoneContainer);
            }
        }
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        const wp = settings.visual && settings.visual.wallpaper ? settings.visual.wallpaper : 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib-rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
        bodyEl.style.backgroundImage = `url(${wp})`;
        phoneScreen.style.backgroundImage = 'none';
        
        if (frameSettingsModule) frameSettingsModule.style.display = 'none';
        applyCatEars(false); 
      }
      localStorage.setItem(PHONE_FRAME_KEY, enabled);
    }
    
    function applyCatEars(enabled) {
        const isPhoneFrameActive = document.body.classList.contains('phone-frame-active');
        if (enabled && isPhoneFrameActive) {
            document.body.classList.add('cat-ears-active');
        } else {
            document.body.classList.remove('cat-ears-active');
        }
        localStorage.setItem(CAT_EARS_KEY, enabled);
    }
    
    function setPhoneCaseColor(color) {
        document.documentElement.style.setProperty('--phone-case-color', color);
        localStorage.setItem(PHONE_CASE_COLOR_KEY, color);
    }
    
        function setCatEarColor(color) {
        document.documentElement.style.setProperty('--cat-ear-color', color);
        localStorage.setItem(CAT_EAR_COLOR_KEY, color);
    }
    
    /* --- 新增的代码 --- */
    function applyIconFontLightMode(enabled) {
      if (enabled) {
        document.body.classList.add('light-mode-icons-active');
      } else {
        document.body.classList.remove('light-mode-icons-active');
      }
      localStorage.setItem(ICON_FONT_LIGHT_MODE_KEY, enabled);
    }
    /* --- 新增结束 --- */
    
    function updatePhoneTime(){
      const now = new Date();
      const h = String(now.getHours()).padStart(2, '0');
      const m = String(now.getMinutes()).padStart(2, '0');
      const timeEl = document.getElementById('phone-status-time');
      if (timeEl) {
        timeEl.innerText = h + ':' + m;
      }
    }
    
    function applyIOSMode(enabled) {
      if (enabled) {
        document.body.classList.add('ios-mode-active');
      } else {
        document.body.classList.remove('ios-mode-active');
      }
      localStorage.setItem(IOS_MODE_KEY, enabled);
    }

    // --- *** START: Takeout App Logic *** ---
    function initializeTakeoutApp() {
        const takeoutAppContainer = document.getElementById('takeout-app-page');
        if (takeoutAppContainer.dataset.initialized) return;

        const defaultState = {
            myId: null, partnerId: null,
            myAvatar: 'https://img.zcool.cn/community/01f0835ab4170ea8012062e3c351cf.png@260w_195h_1c_1e_1o_100sh.png',
            activeCategoryId: 1, isEditMode: false,
            categories: [ { id: 1, name: '主食' }, { id: 2, name: '热菜' }, { id: 3, name: '靓汤' } ],
            dishes: [
                { id: 1, categoryId: 1, name: '爱心蛋包饭', image: 'https://img.zcool.cn/community/01d9315d65d49ea8012060be643663.jpg@1280w_1l_2o_100sh.jpg', steps: '1. 炒好米饭备用。\n2. 摊一个漂亮的蛋皮。\n3. 把饭包起来，用番茄酱画爱心。', quantity: 0 },
                { id: 2, categoryId: 2, name: '可乐鸡翅', image: 'https://img.zcool.cn/community/0107a55b8b939fa80120121f158f96.jpg@1280w_1l_2o_100sh.jpg', steps: '1. 鸡翅焯水。\n2. 煎至金黄。\n3. 倒入可乐和调料，大火收汁。', quantity: 0 },
                { id: 3, categoryId: 3, name: '玉米排骨汤', image: 'https://img.zcool.cn/community/01cc7a5a30a13ea80120ba38287814.jpg@1280w_1l_2o_100sh.jpg', steps: '1. 排骨焯水。\n2. 所有材料放入锅中。\n3. 加水炖1小时。', quantity: 0 },
            ],
            menus: [],
        };

        let appState;
        try {
            const savedData = localStorage.getItem(TAKEOUT_APP_DATA_KEY);
            appState = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(defaultState));
            appState.isEditMode = false;
        } catch(e) {
            appState = JSON.parse(JSON.stringify(defaultState));
        }

        function saveState() {
            localStorage.setItem(TAKEOUT_APP_DATA_KEY, JSON.stringify(appState));
        }

        const $ = (selector) => takeoutAppContainer.querySelector(selector);
        const $$ = (selector) => takeoutAppContainer.querySelectorAll(selector);

        function renderAll() {
            renderCategories();
            renderDishes();
            renderOrderFooter();
            renderMenuList();
            renderMyPage();
        }

        function renderCategories() {
            $('#takeout-category-list').innerHTML = '';
            appState.categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = `category-item ${cat.id === appState.activeCategoryId ? 'active' : ''}`;
                item.textContent = cat.name;
                item.dataset.categoryId = cat.id;
                item.addEventListener('click', () => {
                    if (appState.isEditMode) {
                        const newName = prompt("请输入新的分类名称：", cat.name);
                        if (newName && newName.trim()) { cat.name = newName.trim(); saveState(); renderCategories(); }
                    } else { appState.activeCategoryId = cat.id; saveState(); renderCategories(); renderDishes(); }
                });
                $('#takeout-category-list').appendChild(item);
            });
        }

        function renderDishes() {
            const dishList = $('#takeout-dish-list');
            dishList.innerHTML = '';
            const dishesToShow = appState.dishes.filter(d => d.categoryId === appState.activeCategoryId);
            if (dishesToShow.length === 0 && !appState.isEditMode) dishList.innerHTML = '<p class="status-text">这个分类下还没有菜哦~</p>';

            dishesToShow.forEach(dish => {
                const card = document.createElement('div');
                card.className = 'dish-card';
                card.dataset.dishId = dish.id;
                let cardContent = `<img src="${dish.image || 'https://via.placeholder.com/140x140.png?text=无图'}" alt="${dish.name}" class="dish-image"><div class="dish-info"><h3>${dish.name}</h3></div>`;
                
                if (appState.isEditMode) {
                    cardContent += `<div class="dish-delete-btn" data-dish-id="${dish.id}">&times;</div>`;
                    card.addEventListener('click', () => showEditDishModal(dish.id));
                } else {
                    cardContent += `<div class="dish-actions">${dish.quantity > 0 ? `<button class="quantity-control minus" data-dish-id="${dish.id}" data-change="-1">-</button><span class="dish-quantity">${dish.quantity}</span>` : ''}<button class="quantity-control" data-dish-id="${dish.id}" data-change="1">+</button></div>`;
                    card.addEventListener('click', (e) => { if (!e.target.closest('.dish-actions')) showDishDetailModal(dish.id); });
                }
                card.innerHTML = cardContent;
                dishList.appendChild(card);
            });
            
            dishList.querySelectorAll('.quantity-control, .dish-delete-btn').forEach(btn => btn.addEventListener('click', handleDishAction));
            
            const addDishContainer = document.createElement('div');
            addDishContainer.style.padding = '10px 0';
            addDishContainer.innerHTML = `<button class="button secondary" style="padding: 12px; margin-left:5px;">+ 添加新菜品</button>`;
            dishList.appendChild(addDishContainer).querySelector('button').addEventListener('click', () => showEditDishModal());
        }

        function handleDishAction(e) {
            e.stopPropagation();
            const btn = e.currentTarget;
            const dishId = parseInt(btn.dataset.dishId);
            if (btn.classList.contains('quantity-control')) {
                const change = parseInt(btn.dataset.change);
                const dish = appState.dishes.find(d => d.id === dishId);
                updateQuantity(dishId, dish.quantity + change);
            } else if (btn.classList.contains('dish-delete-btn')) {
                if(confirm("确定要删除这个菜品吗？")) { appState.dishes = appState.dishes.filter(d => d.id !== dishId); saveState(); renderDishes(); }
            }
        }
        
        function renderOrderFooter() {
            const totalQuantity = appState.dishes.reduce((sum, dish) => sum + dish.quantity, 0);
            $('#takeout-total-quantity').textContent = totalQuantity;
            $('#takeout-order-footer').classList.toggle('hidden', totalQuantity === 0 || appState.isEditMode);
        }
        
        function renderMenuList() {
            const menuListEl = $('#takeout-menu-list');
            if (appState.menus.length === 0) { menuListEl.innerHTML = '<p class="status-text">还没有下过单哦，快去点菜吧！</p>'; return; }
            menuListEl.innerHTML = '';
            [...appState.menus].reverse().forEach(menu => {
                const totalDishes = menu.dishes.reduce((sum, dish) => sum + dish.quantity, 0);
                const card = document.createElement('div');
                card.className = 'menu-item-card';
                card.dataset.menuId = menu.id;
                card.innerHTML = `
                    <div class="menu-header">
                        <img src="${menu.avatar}" class="menu-avatar">
                        <div class="menu-title-wrapper">
                            <h4 class="menu-title">${menu.name}</h4>
                            <p class="menu-summary">${new Date(menu.timestamp).toLocaleString()} · 共 ${totalDishes} 件菜品</p>
                        </div>
                        <div class="menu-expand-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="var(--takeout-light-text-color)"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"></path></svg></div>
                    </div>
                    <div class="menu-dishes-list">${menu.dishes.map(d => `<div class="menu-dish-item" data-name="${d.name}" data-image="${d.image}" data-steps="${d.steps || ''}"><img src="${d.image || 'https://via.placeholder.com/80x80.png?text=无图'}"><span class="name">${d.name}</span><span class="quantity">x ${d.quantity}</span></div>`).join('')}</div>`;
                
                card.querySelector('.menu-header').addEventListener('click', (e) => {
                    if(e.target.classList.contains('menu-avatar')) { showEditMenuModal(menu.id); } 
                    else { e.currentTarget.nextElementSibling.classList.toggle('expanded'); e.currentTarget.querySelector('.menu-expand-icon').classList.toggle('expanded'); }
                });

                card.querySelectorAll('.menu-dish-item').forEach(item => item.addEventListener('click', (e) => {
                    const { name, image, steps } = e.currentTarget.dataset;
                    showDishDetailModal(null, { name, image, steps });
                }));

                card.addEventListener('dblclick', () => {
                    if (confirm('确定要删除这个订单记录吗？')) {
                        const menuId = parseInt(card.dataset.menuId);
                        appState.menus = appState.menus.filter(m => m.id !== menuId);
                        saveState(); renderMenuList();
                    }
                });
                menuListEl.appendChild(card);
            });
        }

        function renderMyPage() {
            $('#takeout-my-avatar-img').src = appState.myAvatar;
            $('#takeout-my-id-display').textContent = appState.myId ? `我的ID: ${appState.myId}` : '尚未生成ID';
            $('#takeout-get-my-id-btn').style.display = appState.myId ? 'none' : 'inline-block';
            $('#takeout-bind-status').textContent = appState.partnerId ? `已绑定好友: ${appState.partnerId}` : '当前未绑定好友';
            $('#takeout-bind-friend-btn').textContent = appState.partnerId ? '解绑' : '绑定';
            $('#takeout-friend-id-input').style.display = appState.partnerId ? 'none' : 'block';
            if (!appState.partnerId) $('#takeout-friend-id-input').value = '';
        }

        function switchPage(pageId) {
            $$('.page').forEach(p => p.classList.remove('active'));
            $('#' + pageId).classList.add('active');
            $$('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            $('#takeout-top-bar-title').textContent = { 'takeout-page-order': '点菜', 'takeout-page-menu': '菜单', 'takeout-page-my': '我' }[pageId];
            $('#takeout-toggle-edit-btn').style.display = pageId === 'takeout-page-order' ? 'block' : 'none';
            if (appState.isEditMode && pageId !== 'takeout-page-order') toggleEditMode();
        }

        function updateQuantity(dishId, newQuantity) {
            const quantity = Math.max(0, newQuantity);
            const dish = appState.dishes.find(d => d.id === dishId);
            if (dish) { dish.quantity = quantity; saveState(); renderDishes(); renderOrderFooter(); }
        }
        
        function placeOrder() {
            const orderedDishes = appState.dishes.filter(d => d.quantity > 0);
            if (orderedDishes.length === 0) { showToast("您还没有选择任何菜品哦！"); return; };
            const newMenu = { id: Date.now(), name: `甜蜜的第${appState.menus.length + 1}餐`, avatar: appState.myAvatar, timestamp: Date.now(), dishes: JSON.parse(JSON.stringify(orderedDishes)) };
            appState.menus.push(newMenu);
            appState.dishes.forEach(d => d.quantity = 0);
            saveState();
            closeAllModals();
            renderAll();
            switchPage('takeout-page-menu');
        }
        
        function toggleEditMode() {
            appState.isEditMode = !appState.isEditMode;
            $('#takeout-toggle-edit-btn').textContent = appState.isEditMode ? '完成' : '编辑';
            renderDishes();
            renderOrderFooter();
        }

        function openModal(modalId) { $('#' + modalId).classList.add('visible'); }
        function closeModal(modalId) { $('#' + modalId).classList.remove('visible'); }
        function closeAllModals() { $$('.modal').forEach(m => m.classList.remove('visible')); }

        function showDishDetailModal(dishId, directData = null) {
            let dish;
            if(dishId) dish = appState.dishes.find(d => d.id === dishId);
            else if (directData) dish = directData;
            if (!dish) return;
            $('#takeout-dish-detail-image').src = dish.image || 'https://via.placeholder.com/300x180.png?text=无图';
            $('#takeout-dish-detail-name').textContent = dish.name;
            $('#takeout-dish-detail-steps').textContent = dish.steps || '还没有写步骤哦~';
            openModal('takeout-dish-detail-modal');
        }
        
        function showEditDishModal(dishId = null) {
            const title = $('#takeout-edit-dish-full-title'), idInput = $('#takeout-edit-dish-full-id'), nameInput = $('#takeout-edit-dish-full-name'), stepsInput = $('#takeout-edit-dish-full-steps'), preview = $('#takeout-edit-dish-image-preview');
            if (dishId) {
                const dish = appState.dishes.find(d => d.id === dishId);
                title.textContent = '编辑菜品'; idInput.value = dish.id; nameInput.value = dish.name; stepsInput.value = dish.steps;
                preview.src = dish.image || 'https://via.placeholder.com/300x300.png?text=点击上传';
            } else {
                title.textContent = '添加新菜品'; idInput.value = ''; nameInput.value = ''; stepsInput.value = '';
                preview.src = 'https://via.placeholder.com/300x300.png?text=点击上传';
            }
            openModal('takeout-edit-dish-full-modal');
        }

        function saveDish() {
            const id = $('#takeout-edit-dish-full-id').value, name = $('#takeout-edit-dish-full-name').value.trim(), steps = $('#takeout-edit-dish-full-steps').value.trim(), image = $('#takeout-edit-dish-image-preview').src;
            if (!name) { showToast('菜品名称不能为空！'); return; }
            if (id) { Object.assign(appState.dishes.find(d => d.id == id), { name, steps, image }); } 
            else { appState.dishes.push({ id: Date.now(), categoryId: appState.activeCategoryId, name, image, steps, quantity: 0 }); }
            saveState();
            closeModal('takeout-edit-dish-full-modal');
            renderDishes();
        }
        
        function showEditMenuModal(menuId) {
            const menu = appState.menus.find(m => m.id == menuId);
            if (!menu) return;
            $('#takeout-edit-menu-id').value = menu.id;
            $('#takeout-edit-menu-name').value = menu.name;
            $('#takeout-edit-menu-image-preview').src = menu.avatar;
            openModal('takeout-edit-menu-modal');
        }

        function saveMenu() {
            const id = $('#takeout-edit-menu-id').value, name = $('#takeout-edit-menu-name').value.trim(), avatar = $('#takeout-edit-menu-image-preview').src;
            if (!name) { showToast('菜单名称不能为空！'); return; }
            const menu = appState.menus.find(m => m.id == id);
            if (menu) { menu.name = name; menu.avatar = avatar; }
            saveState();
            closeModal('takeout-edit-menu-modal');
            renderMenuList();
        }
        
        function handleImageUpload(event, callback) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => callback(e.target.result);
                reader.readAsDataURL(file);
            }
            event.target.value = '';
        }
        
        function exportData() {
            const dataStr = JSON.stringify({ categories: appState.categories, dishes: appState.dishes, menus: appState.menus }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'our_menu_backup.json';
            a.click();
            URL.revokeObjectURL(a.href);
            showToast("数据已导出！");
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.categories && imported.dishes && confirm('这将覆盖您当前的数据，确定导入吗？')) {
                        Object.assign(appState, { categories: imported.categories, dishes: imported.dishes, menus: imported.menus || [] });
                        saveState();
                        renderAll();
                        showToast('数据导入成功！');
                    } else { showToast('文件格式不正确。'); }
                } catch { showToast('解析文件失败。'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        $$('.nav-item').forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));
        $$('.modal').forEach(modal => modal.addEventListener('click', e => { if (e.target === modal || e.target.classList.contains('close-modal-btn')) closeModal(modal.id); }));
        $('#takeout-toggle-edit-btn').addEventListener('click', toggleEditMode);
        $('#takeout-place-order-btn').addEventListener('click', placeOrder);
        $('#takeout-save-dish-full-btn').addEventListener('click', saveDish);
        
        $('#takeout-get-my-id-btn').addEventListener('click', () => { 
            if(!appState.myId) { appState.myId = Math.floor(100000 + Math.random() * 900000); saveState(); renderMyPage(); }
        });

        $('#takeout-bind-friend-btn').addEventListener('click', () => {
            if (appState.partnerId) { 
                if (confirm('确定要解绑吗？')) { appState.partnerId = null; saveState(); renderMyPage(); } 
            } else { 
                const id = $('#takeout-friend-id-input').value; 
                if (/^\d{6}$/.test(id)) { 
                    if(id == appState.myId) { showToast('不能绑定自己的ID哦！'); return; }
                    appState.partnerId = id; saveState(); showToast('绑定成功！'); renderMyPage(); 
                } else { showToast('请输入有效的6位ID！'); } 
            }
        });

        $('#takeout-export-data-btn').addEventListener('click', exportData);
        $('#takeout-import-file-input').addEventListener('change', importData);
        
        $('#takeout-avatar-upload-input').addEventListener('change', (e) => handleImageUpload(e, (base64) => { appState.myAvatar = base64; saveState(); renderMyPage(); }));
        $('#takeout-edit-dish-image-input').addEventListener('change', (e) => handleImageUpload(e, (base64) => { $('#takeout-edit-dish-image-preview').src = base64; }));
        $('#takeout-edit-menu-image-input').addEventListener('change', (e) => handleImageUpload(e, (base64) => { $('#takeout-edit-menu-image-preview').src = base64; }));
        $('#takeout-save-menu-btn').addEventListener('click', saveMenu);

        renderAll();
        takeoutAppContainer.dataset.initialized = 'true';
    }

    window.openTakeoutApp = () => {
        body.classList.add('takeout-active');
        initializeTakeoutApp();
    };

    window.closeTakeoutApp = () => {
        body.classList.remove('takeout-active');
    };
    // --- *** END: Takeout App Logic *** ---

    // --- Recollection App Logic (REWORKED & MODIFIED) ---
    function getRecollectionStorageKey(contactId) {
        return `${RECOLLECTION_DATA_KEY_PREFIX}${contactId}`;
    }

    function getRecollections(contactId) {
        try {
            const data = localStorage.getItem(getRecollectionStorageKey(contactId));
            return data ? JSON.parse(data) : { lastSummaryIndex: -1, items: [], crystalColor: null };
        } catch (e) {
            return { lastSummaryIndex: -1, items: [], crystalColor: null };
        }
    }

    function saveRecollections(contactId, data) {
        localStorage.setItem(getRecollectionStorageKey(contactId), JSON.stringify(data));
    }
    
    function hexToRgb(hex) {
        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

                    window.openRecollectionApp = () => {
        body.classList.add('recollection-active');
        const grid = document.getElementById('recollection-grid');
        grid.innerHTML = '';
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        
        if (contacts.length === 0) {
            grid.innerHTML = '<p style="color: #9f8a8a; grid-column: span 3; text-align:center;">还没有创建任何角色哦</p>';
            return;
        }

        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'crystal-ball-item';
            
            // 简单直接的点击跳转绑定
            item.innerHTML = `
                <div class="crystal-ball-container" onclick="openRecollectionDetail(${contact.id})">
                    <div class="crystal-ball-sphere">
                        <div class="crystal-ball-stars">
                            <div class="star s1"></div><div class="star s2"></div><div class="star s3"></div><div class="star s4"></div>
                        </div>
                         <div class="crystal-ball-name">${escapeHtml(contact.alias || contact.name)}</div>
                    </div>
                    <div class="crystal-ball-base"></div>
                </div>
            `;
            grid.appendChild(item);
        });
    };
    
                window.openRecollectionColorSettings = () => {
        const page = document.getElementById('recollection-color-page');
        const list = document.getElementById('recollection-color-list');
        list.innerHTML = '';
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        
        if (contacts.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#999; padding: 20px;">还没有创建任何角色哦</p>';
        } else {
            contacts.forEach(contact => {
                const recollectionData = getRecollections(contact.id);
                const color = recollectionData.crystalColor || '#7b42f5'; 
                
                const item = document.createElement('div');
                item.className = 'wb-color-item';
                // 改用输入框，并加一个小圆点预览颜色
                item.innerHTML = `
                    <span class="wb-color-item-name">${escapeHtml(contact.alias || contact.name)}</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="color-preview" style="width: 20px; height: 20px; border-radius: 50%; background-color: ${color}; border: 1px solid #ddd; flex-shrink: 0;"></div>
                        <input type="text" class="wb-color-input" data-contact-id="${contact.id}" value="${color}" placeholder="#HEX码" style="width: 80px; padding: 6px; border: 1px solid #eee; border-radius: 8px; font-size: 13px; outline: none; text-align: center;">
                    </div>
                `;
                
                // 实时预览输入的颜色
                const textInput = item.querySelector('.wb-color-input');
                const previewBox = item.querySelector('.color-preview');
                textInput.addEventListener('input', (e) => {
                    let val = e.target.value.trim();
                    if(!val.startsWith('#') && val.length > 0) val = '#' + val; // 自动补齐 #
                    const hexRegex = /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/i;
                    if(hexRegex.test(val)){
                        previewBox.style.backgroundColor = val;
                    }
                });

                list.appendChild(item);
            });
        }

        page.style.display = 'flex';
        setTimeout(() => page.classList.add('active'), 10);
    };

    window.closeRecollectionColorSettings = () => {
        const page = document.getElementById('recollection-color-page');
        page.classList.remove('active');
        setTimeout(() => page.style.display = 'none', 400); 
    };

    window.saveRecollectionColorSettings = () => {
        const colorInputs = document.querySelectorAll('#recollection-color-list .wb-color-input');
        let hasError = false;

        colorInputs.forEach(input => {
            const contactId = parseInt(input.dataset.contactId);
            let newColor = input.value.trim();
            
            if (newColor !== "") {
                if (!newColor.startsWith('#')) newColor = '#' + newColor; // 容错，自动补#
                
                // 验证是否是合法的HEX颜色码
                const hexRegex = /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/i;
                if (contactId && hexRegex.test(newColor)) {
                    const recollectionData = getRecollections(contactId);
                    recollectionData.crystalColor = newColor;
                    saveRecollections(contactId, recollectionData);
                } else {
                    hasError = true;
                }
            }
        });
        
        if (hasError) {
            showToast('部分颜色码格式错误未保存，请输入类似 #FF0000 的格式');
        } else {
            showToast('水晶球颜色已保存');
            closeRecollectionColorSettings();
            openRecollectionApp(); 
        }
    };


    window.closeRecollectionApp = () => {
        body.classList.remove('recollection-active');
    };

    window.openRecollectionDetail = (contactId) => {
        currentRecollectionContactId = contactId;
        document.getElementById('recollection-detail-page').classList.add('active');
        renderRecollectionItems(contactId);
    };

    window.closeRecollectionDetail = () => {
        document.getElementById('recollection-detail-page').classList.remove('active');
        currentRecollectionContactId = null;
    };
    
            window.openRecollectionActionSheet = (id) => {
        currentActionRecollectionId = id; // 保存当前操作的便签ID

        // 为“编辑内容”按钮绑定事件
        document.getElementById('btn-recollection-edit').onclick = () => { 
            closeRecollectionActionSheet(); 
            editRecollection(id); 
        };

        // 为“修改背景颜色”按钮绑定事件
        document.getElementById('btn-recollection-custom-color').onclick = () => { 
            closeRecollectionActionSheet(); 
            customizeRecollectionItem(id); 
        };

        // 为“上传背景图片”按钮绑定事件 (重要修复)
        document.getElementById('btn-recollection-custom-bg').onclick = () => { 
            closeRecollectionActionSheet(); 
            // 在点击文件上传按钮前，先把要修改的便签ID存起来
            currentRecollectionItemCustomizingId = id; 
            document.getElementById('input-recollection-bg').click(); 
        };

        // 为“删除”按钮绑定事件
        document.getElementById('btn-recollection-delete').onclick = () => { 
            closeRecollectionActionSheet(); 
            deleteRecollection(id); 
        };
        
        // 显示弹窗
        const overlay = document.getElementById('recollection-action-sheet-overlay');
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('active'), 10);
    };
    window.closeRecollectionActionSheet = () => {
        const overlay = document.getElementById('recollection-action-sheet-overlay');
        overlay.classList.remove('active');
        setTimeout(() => overlay.style.display = 'none', 300);
        currentActionRecollectionId = null;
    };

    function renderRecollectionItems(contactId) {
        const contentArea = document.getElementById('recollection-detail-content');
        contentArea.innerHTML = '';
        const recollectionData = getRecollections(contactId);
        const items = recollectionData.items || [];

        if (items.length === 0) {
            contentArea.innerHTML = `<div style="text-align:center; color:#ccc; padding:50px 20px;">空空如也，点击右上角 + 新增第一条回忆吧</div>`;
            return;
        }
        
        items.sort((a,b) => b.timestamp - a.timestamp).forEach(item => {
            const itemWrapper = document.createElement('div');
            itemWrapper.className = 'recollection-item-wrapper';

            const itemEl = document.createElement('div');
            itemEl.className = `recollection-item ${item.isSummary ? 'summary-item' : ''}`;
            itemEl.dataset.id = item.id;
            
                        if (item.bgColor) {
                itemEl.style.backgroundColor = item.bgColor;
                itemEl.style.borderColor = item.bgColor; // 让边框和背景颜色一并改变
            }
            if (item.bgImage) {itemEl.style.backgroundImage = `url(${item.bgImage})`;
                itemEl.style.backgroundSize = 'cover';
                itemEl.style.backgroundPosition = 'center';
            }
            
            const textEl = document.createElement('div');
            textEl.className = 'recollection-item-text truncated';
            textEl.textContent = item.text;
                        textEl.onclick = (e) => { textEl.classList.toggle('truncated'); };
            
            if (item.bgImage) {
                textEl.style.color = 'white';
                textEl.style.textShadow = '0 1px 3px rgba(0,0,0,0.5)';
            }

            const timestampEl = document.createElement('div');
            timestampEl.className = 'recollection-item-timestamp';
            timestampEl.textContent = formatTimestamp(item.timestamp);
                        if (item.bgImage) {
                timestampEl.style.color = 'white';
                timestampEl.style.textShadow = '0 1px 3px rgba(0,0,0,0.5)';
            }
            
            itemEl.appendChild(textEl);
            itemEl.appendChild(timestampEl);
            
            // 兼容电脑端双击
            itemEl.ondblclick = () => openRecollectionActionSheet(item.id);
            
            // --- 修复手机端新增便签双击不灵敏的问题 ---
            let lastTapTime = 0;
            itemEl.addEventListener('touchend', (e) => {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime;
                // 如果两次点击间隔小于 400 毫秒，判定为双击
                if (tapLength < 400 && tapLength > 0) {
                    openRecollectionActionSheet(item.id);
                    e.preventDefault(); // 阻止浏览器可能发生的双击放大页面行为
                }
                lastTapTime = currentTime;
            });
            // ----------------------------------------
            
            itemWrapper.appendChild(itemEl);
            contentArea.appendChild(itemWrapper);
        });
    }

    window.openAddRecollectionModal = () => {
        currentEditingRecollectionId = null;
        document.getElementById('recollection-modal-title').textContent = '新增回忆';
        document.getElementById('recollection-text-input').value = '';
        document.getElementById('recollection-edit-modal').classList.add('active');
    };

    window.closeRecollectionEditModal = () => {
        document.getElementById('recollection-edit-modal').classList.remove('active');
    };

    window.saveRecollection = () => {
        const text = document.getElementById('recollection-text-input').value.trim();
        if (!text) {
            showToast('内容不能为空');
            return;
        }

        const recollectionData = getRecollections(currentRecollectionContactId);
        
        if (currentEditingRecollectionId) { 
            const index = recollectionData.items.findIndex(item => item.id === currentEditingRecollectionId);
            if (index !== -1) {
                recollectionData.items[index].text = text;
            }
        } else { 
            const newRecollection = {
                id: Date.now(),
                text: text,
                timestamp: Date.now(),
                isSummary: false,
                bgColor: null,
                bgImage: null
            };
            recollectionData.items.push(newRecollection);
        }

        saveRecollections(currentRecollectionContactId, recollectionData);
        renderRecollectionItems(currentRecollectionContactId);
        closeRecollectionEditModal();
        showToast('已保存');
    };

    window.editRecollection = (id) => {
        const recollectionData = getRecollections(currentRecollectionContactId);
        const item = recollectionData.items.find(i => i.id === id);
        if (item) {
            currentEditingRecollectionId = id;
            document.getElementById('recollection-modal-title').textContent = '编辑回忆';
            document.getElementById('recollection-text-input').value = item.text;
            document.getElementById('recollection-edit-modal').classList.add('active');
        }
    };
    
    window.deleteRecollection = (id) => {
        if (confirm('确定要删除这条回忆吗？删除后将不再作为 AI 生成上下文。')) {
            const recollectionData = getRecollections(currentRecollectionContactId);
            recollectionData.items = recollectionData.items.filter(item => item.id !== id);
            saveRecollections(currentRecollectionContactId, recollectionData);
            renderRecollectionItems(currentRecollectionContactId);
            showToast('已删除');
        }
    };
    
            window.customizeRecollectionItem = (id) => {
        // 获取当前便签原有的颜色，方便展示在输入框里
        const recollectionData = getRecollections(currentRecollectionContactId);
        const item = recollectionData.items.find(i => i.id === id);
        const defaultColor = (item && item.bgColor) ? item.bgColor : "#";

        // 弹出一个系统输入框让用户输入
        const newColor = prompt("请输入十六进制颜色码\n(例如: #FFB6C1、#FFFFFF):", defaultColor);
        
        // 用户点击了确定并且输入了内容
        if (newColor !== null && newColor.trim() !== "") {
            let colorCode = newColor.trim();
            
            // 简单的容错：如果用户忘了打#，帮他加上
            if (!colorCode.startsWith('#')) {
                colorCode = '#' + colorCode;
            }
            
            // 校验格式是否正确
            const hexRegex = /^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6})$/i;
            if (hexRegex.test(colorCode)) {
                // 格式正确，应用颜色并清除可能存在的背景图片
                updateRecollectionItemStyle(id, { bgColor: colorCode, bgImage: null });
            } else {
                showToast("颜色格式不正确，请输入有效的十六进制HEX码");
            }
        }
    };

    window.handleRecollectionItemBgUpload = (event) => {
        if (!currentRecollectionItemCustomizingId) return;
        const file = event.target.files[0];
        if (!file) return;

        compressImage(file, 800, (base64) => {
            updateRecollectionItemStyle(currentRecollectionItemCustomizingId, { bgImage: base64, bgColor: null });
        });
        event.target.value = ''; 
    };

    function updateRecollectionItemStyle(itemId, styles) {
        const recollectionData = getRecollections(currentRecollectionContactId);
        const itemIndex = recollectionData.items.findIndex(i => i.id === itemId);
        if (itemIndex > -1) {
            recollectionData.items[itemIndex] = { ...recollectionData.items[itemIndex], ...styles };
            saveRecollections(currentRecollectionContactId, recollectionData);
            renderRecollectionItems(currentRecollectionContactId);
            showToast("便签样式已更新");
        }
    }


    window.openSummarizeRecollectionModal = () => {
        const chatKey = getMessagesKey(currentRecollectionContactId);
        const allMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
        const recollectionData = getRecollections(currentRecollectionContactId);
        const unsummarizedCount = allMessages.length - (recollectionData.lastSummaryIndex + 1);

        document.getElementById('recollection-summary-info').textContent = `你还有 ${unsummarizedCount} 条聊天记录未总结。`;
        const confirmBtn = document.getElementById('recollection-summary-confirm-btn');
        confirmBtn.disabled = unsummarizedCount <= 0;
        confirmBtn.style.opacity = unsummarizedCount <= 0 ? 0.5 : 1;
        
        document.getElementById('recollection-summary-modal').classList.add('active');
    };

    window.closeRecollectionSummaryModal = () => {
        document.getElementById('recollection-summary-modal').classList.remove('active');
    };

    async function executeRecollectionSummary() {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings?.api?.url || !settings?.api?.key) {
            showToast('请先在设置中配置 API');
            return;
        }

        const chatKey = getMessagesKey(currentRecollectionContactId);
        const allMessages = JSON.parse(localStorage.getItem(chatKey) || '[]');
        const recollectionData = getRecollections(currentRecollectionContactId);
        const unsummarizedMessages = allMessages.slice(recollectionData.lastSummaryIndex + 1);

        if (unsummarizedMessages.length === 0) {
            showToast('没有新的聊天记录需要总结');
            closeRecollectionSummaryModal();
            return;
        }

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentRecollectionContactId);
        const roleName = contact ? (contact.alias || contact.name) : '角色';
        const userName = contact ? (contact.userName || '你') : '你';
        
                const firstMessageDate = new Date(unsummarizedMessages[0].timestamp);
        const eventDateStr = `${firstMessageDate.getFullYear()}年${firstMessageDate.getMonth() + 1}月${firstMessageDate.getDate()}日`;

        const historyText = unsummarizedMessages.map(msg => {
             if (msg.isTransfer) return `[系统消息：一笔转账]`;
             if (msg.type === 'recalled') return `[系统消息：撤回了一条消息]`;
             return `${msg.type === 'sent' ? userName : roleName}: ${msg.text}`;
        }).join('\n');

         const prompt = `请以第三人称、客观、不带感情的口吻，总结以下聊天记录，记录一件已经发生过的事。

**总结要求**：
1.  在总结的开头或结尾，必须明确提及事件发生的具体日期是：“${eventDateStr}”。
2.  总结内容中，绝对不要出现“根据该聊天记录”、“事件的经过如下”或类似的引导性语句。直接开始陈述事件本身。

聊天记录如下:
---
${historyText}
---

请根据以上要求，开始总结事件:`;

        const confirmBtn = document.getElementById('recollection-summary-confirm-btn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = '总结中...';

        try {
            const res = await fetch(`${settings.api.url.endsWith('/v1') ? settings.api.url : settings.api.url + '/v1'}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.api.key}` },
                body: JSON.stringify({
                    model: settings.api.model || 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.2, 
                })
            });

            if (!res.ok) {
                 const errorData = await res.json();
                 throw new Error(`API: ${res.status} - ${errorData.error.message}`);
            }

            const data = await res.json();
                        let summaryText = data.choices[0].message.content.trim();
            // 增加一道保险，强制删除AI可能生成的多余引导语
            summaryText = summaryText.replace(/根据该聊天记录，事件的经过如下[：；]?\s*/, '');
            
            if (summaryText) {
                const newSummary = {
                    id: Date.now(),
                    text: summaryText,
                    timestamp: Date.now(),
                    isSummary: true
                };
                recollectionData.items.push(newSummary);
                recollectionData.lastSummaryIndex = allMessages.length - 1; 
                saveRecollections(currentRecollectionContactId, recollectionData);
                renderRecollectionItems(currentRecollectionContactId);
                showToast('总结完成！');
            } else {
                showToast('API未能生成有效总结');
            }

        } catch(e) {
            showToast('总结失败: ' + e.message, 4000);
            console.error(e);
        } finally {
            closeRecollectionSummaryModal();
            confirmBtn.disabled = false;
            confirmBtn.textContent = '总结';
        }
    }


    const originalCloseChatApp = window.closeChatApp || (() => {});
    window.closeChatApp = () => {
        body.classList.remove('recollection-active');
        closeRecollectionDetail();
        originalCloseChatApp(); 
    };
    
// --- Mall App Logic (NEW & MODIFIED) ---

// ========================= 购买弹窗相关JS =========================
// ========================= 购买弹窗相关JS =========================
let currentPurchaseInfo = {
    productId: null,
    quantity: 1,
    selectedStyle: null,
    basePrice: 0 // 新增：保存商品单价
};

window.openPurchasePanel = (productId) => {
    const cache = getMallProductsCache();
    const products = cache[currentMallCategoryId];
    if (!products) return;
    const product = products.find(p => p.id === productId);
    if (!product) {
        showToast("找不到该商品");
        return;
    }

    currentPurchaseInfo.productId = productId;
    currentPurchaseInfo.quantity = 1;
    currentPurchaseInfo.selectedStyle = null;
    currentPurchaseInfo.basePrice = parseFloat(product.price) || 0; // 记录单价

    document.getElementById('mall-purchase-product-emoji').textContent = product.emoji || '📦';
    document.getElementById('mall-purchase-product-price').textContent = `¥${currentPurchaseInfo.basePrice.toFixed(2)}`;
    document.getElementById('mall-purchase-quantity').textContent = currentPurchaseInfo.quantity;
    
    const stylesGrid = document.getElementById('mall-purchase-styles-grid');
    stylesGrid.innerHTML = '';
    if (product.styles && product.styles.length > 0) {
        product.styles.forEach(styleName => {
            const btn = document.createElement('button');
            btn.className = 'style-option-btn';
            btn.textContent = escapeHtml(styleName);
            btn.onclick = () => {
                stylesGrid.querySelectorAll('.style-option-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPurchaseInfo.selectedStyle = styleName;
            };
            stylesGrid.appendChild(btn);
        });
        if (stylesGrid.firstChild) {
            stylesGrid.firstChild.click();
        }
    } else {
        stylesGrid.innerHTML = '<p style="color:#999; font-size: 14px;">暂无可选款式</p>';
        currentPurchaseInfo.selectedStyle = '默认';
    }

    const quantityEl = document.getElementById('mall-purchase-quantity');
    const priceEl = document.getElementById('mall-purchase-product-price');

    // 新增：更新总价的内部函数
    const updateTotalPrice = () => {
        const total = currentPurchaseInfo.basePrice * currentPurchaseInfo.quantity;
        priceEl.textContent = `¥${total.toFixed(2)}`;
    };

    document.querySelector('#mall-purchase-quantity-selector .plus').onclick = () => {
        currentPurchaseInfo.quantity++;
        quantityEl.textContent = currentPurchaseInfo.quantity;
        updateTotalPrice(); // 点击+号更新总价
    };
    document.querySelector('#mall-purchase-quantity-selector .minus').onclick = () => {
        if (currentPurchaseInfo.quantity > 1) {
            currentPurchaseInfo.quantity--;
            quantityEl.textContent = currentPurchaseInfo.quantity;
            updateTotalPrice(); // 点击-号更新总价
        }
    };
    
    document.getElementById('mall-purchase-confirm-btn').onclick = () => {
        if (!currentPurchaseInfo.selectedStyle) {
            showToast('请选择一个款式');
            return;
        }
        showToast(`成功购买 ${currentPurchaseInfo.selectedStyle} x ${currentPurchaseInfo.quantity}`);
        closePurchasePanel();
    };

    document.getElementById('mall-purchase-overlay').classList.add('active');
};

window.closePurchasePanel = () => {
    document.getElementById('mall-purchase-overlay').classList.remove('active');
};

// ========================= 顺便在这里补全“加购物车”的点击事件 =========================
// 寻找下方的 window.openMallDetail = (productId) => { ... } 函数，在给 buyBtn 绑定点击事件的下方增加 cartBtn
document.addEventListener('DOMContentLoaded', () => {
    // 使用事件委托处理加购物车，防止每次打开详情页重复绑定
    document.body.addEventListener('click', (e) => {
        const cartBtn = e.target.closest('#mall-detail-add-cart-btn');
        if (cartBtn) {
            showToast("已加入购物车");
        }
    });
});

window.closePurchasePanel = () => {
    document.getElementById('mall-purchase-overlay').classList.remove('active');
};

// ========================= 商城基础功能JS =========================
function getMallProductsCache() {
    try {
        const data = localStorage.getItem(MALL_PRODUCTS_CACHE_KEY);
        return data ? JSON.parse(data) : {};
    } catch (e) {
        return {};
    }
}

function saveMallProductsCache(cache) {
    localStorage.setItem(MALL_PRODUCTS_CACHE_KEY, JSON.stringify(cache));
}

function getMallCategories() {
    try {
        let data = localStorage.getItem(MALL_CATEGORIES_KEY);
        let categories = data ? JSON.parse(data) : [];
        const defaultCategory = {
            id: 'default-recommend', name: '推荐', deletable: false,
            description: '这个种类里面包含服饰鞋包 美妆个护 数码家电 家居家装 母婴用品 食品保健 图书音像 珠宝配饰 宠物生活 虚拟/服务。'
        };
        if (!categories.some(cat => cat.id === defaultCategory.id)) {
            categories.unshift(defaultCategory);
        }
        categories.forEach(cat => {
            if (cat.id === 'default-recommend') {
                cat.deletable = false;
                if (!cat.description) cat.description = defaultCategory.description;
            } else {
                cat.deletable = true;
                if (!cat.hasOwnProperty('description')) cat.description = '';
                if (!cat.hasOwnProperty('boundRoleIds')) cat.boundRoleIds = [];
            }
        });
        saveMallCategories(categories);
        return categories;
    } catch (e) {
        console.error("Error getting mall categories:", e);
        const defaultCategory = {
            id: 'default-recommend', name: '推荐', deletable: false,
            description: '这个种类里面包含服饰鞋包 美妆个护 数码家电 家居家装 母婴用品 食品保健 图书音像 珠宝配饰 宠物生活 虚拟/服务。'
        };
        saveMallCategories([defaultCategory]);
        return [defaultCategory];
    }
}

function saveMallCategories(categories) {
    localStorage.setItem(MALL_CATEGORIES_KEY, JSON.stringify(categories));
}

function renderMallCategories() {
    const nav = document.getElementById('mall-category-nav');
    nav.innerHTML = '';
    const categories = getMallCategories();
    categories.forEach(cat => {
        const item = document.createElement('div');
        item.className = 'mall-category-item';
        item.textContent = cat.name;
        item.dataset.id = cat.id;
        item.onclick = () => switchMallCategory(item);
        item.ondblclick = () => { openMallCategoryModal(true, cat.id); };
        nav.appendChild(item);
    });
    const activeItem = nav.querySelector(`[data-id="${currentMallCategoryId}"]`) || nav.firstChild;
    if (activeItem) {
        switchMallCategory(activeItem);
    } else if (nav.firstChild) {
        switchMallCategory(nav.firstChild);
    }
}

window.openMallApp = () => {
    body.classList.add('mall-active');
    currentMallCategoryId = 'default-recommend';
    renderMallCategories();
    const contentArea = document.getElementById('mall-content');
    contentArea.innerHTML = `<div class="mall-product-grid" id="mall-product-grid"></div><p style="text-align:center; color:#ccc; padding-top: 50px;">点击右上角刷新按钮生成商品</p>`;
    document.getElementById('mall-add-category-btn').onclick = () => openMallCategoryModal(false);
    document.getElementById('mall-refresh-btn').onclick = () => generateMallProducts();
};

window.closeMallApp = () => {
    body.classList.remove('mall-active');
};

window.switchMallCategory = (element) => {
    if (!element) return;
    document.querySelectorAll('#mall-category-nav .mall-category-item').forEach(el => el.classList.remove('active'));
    element.classList.add('active');
    currentMallCategoryId = element.dataset.id;
    const cache = getMallProductsCache();
    const cachedProducts = cache[currentMallCategoryId];
    const contentArea = document.getElementById('mall-content');
    contentArea.innerHTML = `<div class="mall-product-grid" id="mall-product-grid"></div>`;
    if (cachedProducts && cachedProducts.length > 0) {
        renderMallProducts(cachedProducts);
    } else {
        contentArea.innerHTML += `<p style="text-align:center; color:#ccc; padding-top: 50px;">点击右上角刷新按钮为“${escapeHtml(element.textContent)}”分类生成商品</p>`;
    }
};

function openMallCategoryModal(isEditing = false, categoryId = null) {
    const modal = document.getElementById('mall-category-modal');
    const titleEl = document.getElementById('mall-category-modal-title');
    const nameInput = document.getElementById('mall-category-name-input');
    const descInput = document.getElementById('mall-category-desc-input');
    const actionsContainer = document.getElementById('mall-category-modal-actions');
    isEditingMallCategory = isEditing;
    currentMallCategoryId = categoryId;
    const categories = getMallCategories();
    const category = categories.find(c => c.id === categoryId);
    if (isEditing && category) {
        titleEl.textContent = '编辑商品种类';
        nameInput.value = category.name;
        descInput.value = category.description || '';
        tempMallCategoryRoleIds = [...(category.boundRoleIds || [])];
        if (category.deletable) {
            actionsContainer.innerHTML = `<button class="wb-action-btn btn-confirm-delete" onclick="deleteMallCategory()">删除</button><button class="wb-action-btn wb-btn-cancel" onclick="closeMallCategoryModal()">取消</button><button class="wb-action-btn wb-btn-ok" onclick="saveMallCategory()">OK</button>`;
        } else {
            actionsContainer.innerHTML = `<button class="wb-action-btn wb-btn-cancel" onclick="closeMallCategoryModal()">取消</button><button class="wb-action-btn wb-btn-ok" onclick="saveMallCategory()">OK</button>`;
        }
    } else {
        isEditingMallCategory = false;
        titleEl.textContent = '添加商品种类';
        nameInput.value = '';
        descInput.value = '';
        tempMallCategoryRoleIds = [];
        actionsContainer.innerHTML = `<button class="wb-action-btn wb-btn-cancel" onclick="closeMallCategoryModal()">取消</button><button class="wb-action-btn wb-btn-ok" onclick="saveMallCategory()">OK</button>`;
    }
    modal.classList.add('active');
}

function closeMallCategoryModal() {
    document.getElementById('mall-category-modal').classList.remove('active');
}

function openMallCategoryRoleBindModal() {
    wbBindMultiSelect = true;
    document.getElementById('wb-bind-modal-title').textContent = '绑定角色';
    wbBindCallback = (selectedIds) => {
        tempMallCategoryRoleIds = selectedIds;
    };
    openWorldBookBindModal('roles');
}

function saveMallCategory() {
    const name = document.getElementById('mall-category-name-input').value.trim();
    const description = document.getElementById('mall-category-desc-input').value.trim();
    if (!name) {
        showToast('分类名称不能为空');
        return;
    }
    let categories = getMallCategories();
    if (isEditingMallCategory) {
        const index = categories.findIndex(c => c.id === currentMallCategoryId);
        if (index !== -1) {
            categories[index].name = name;
            categories[index].description = description;
            categories[index].boundRoleIds = tempMallCategoryRoleIds;
        }
    } else {
        categories.push({ id: `custom-${Date.now()}`, name, description, boundRoleIds: tempMallCategoryRoleIds, deletable: true });
    }
    saveMallCategories(categories);
    renderMallCategories();
    closeMallCategoryModal();
    showToast('保存成功');
}

function deleteMallCategory() {
    if (!isEditingMallCategory || !currentMallCategoryId) return;
    let categories = getMallCategories();
    const categoryToDelete = categories.find(c => c.id === currentMallCategoryId);
    if (!categoryToDelete || !categoryToDelete.deletable) {
        showToast("默认分类不可删除");
        return;
    }
    categories = categories.filter(c => c.id !== currentMallCategoryId);
    saveMallCategories(categories);
    let cache = getMallProductsCache();
    delete cache[currentMallCategoryId];
    saveMallProductsCache(cache);
    currentMallCategoryId = 'default-recommend';
    renderMallCategories();
    closeMallCategoryModal();
    showToast('分类已删除');
}

async function generateMallProducts() {
    const contentArea = document.getElementById('mall-content');
    if (!contentArea) return;
    const grid = document.createElement('div');
    grid.className = 'mall-product-grid';
    grid.id = 'mall-product-grid';
    contentArea.innerHTML = '';
    contentArea.appendChild(grid);
    grid.innerHTML = '<p style="color:#ccc; text-align:center; grid-column: span 2;">正在生成商品...</p>';
    const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
    if (!settings?.api?.url || !settings?.api?.key || !settings?.api?.model) {
        grid.innerHTML = '<p style="color:#ccc; text-align:center; grid-column: span 2;">请先在设置中配置 API</p>';
        return;
    }
    const categories = getMallCategories();
    const currentCategory = categories.find(c => c.id === currentMallCategoryId);
    if (!currentCategory) {
        grid.innerHTML = '<p style="color:#ccc; text-align:center; grid-column: span 2;">无法找到当前分类</p>';
        return;
    }
    const categoryName = currentCategory.name;
    const categoryDesc = currentCategory.description || '无';
    let roleContext = "无特定角色信息。";
    if (currentCategory.boundRoleIds && currentCategory.boundRoleIds.length > 0) {
        const allContacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const roleDetails = currentCategory.boundRoleIds.map(roleId => {
            const contact = allContacts.find(c => c.id === roleId);
            if (!contact) return '';
            const recollectionData = getRecollections(contact.id);
            const recollectionText = recollectionData.items.map(item => item.text).join('\n');
            return `角色: ${contact.alias || contact.name}\n- 角色人设: ${contact.persona || '无'}\n- 回忆总结(发生过的事): ${recollectionText || '无'}`;
        }).filter(Boolean).join('\n---\n');
        if (roleDetails) roleContext = roleDetails;
    }
    const prompt = `你是一个专业的电商平台商品文案专家。请根据以下信息，生成一个包含10个商品的JSON数组，并封装在一个名为 "products" 的键中。

**商品分类**: ${categoryName}
**分类补充说明**: ${categoryDesc}
**参考的角色信息** (请深度参考他们的性格、喜好、和回忆中的经历，生成与他们高度相关的、独特的、有趣的商品):
---
${roleContext}
---
**生成要求**:
1.  **商品名称 (name)**: 必须模仿拼多多或淘宝的风格。使用吸引人的前缀、夸张的修饰词、利益点和情绪价值词汇。例如："【官方补贴】XX同款爆改！ins风绝美奶油XX" 或 "太好用了吧！无限回购的XX神器！"
2.  **Emoji (emoji)**: 一个最能代表该商品的emoji表情。
3.  **价格 (price)**: 一个在1到1000之间的数字。
4.  **销量 (sales)**: 一个在0到100000之间的随机整数。
5.  **商品评价 (reviews)**: 一个包含3到6条评价对象的数组。每条评价对象包含: 'nickname' (一个随机的买家昵称), 'content' (评价内容), 'rating' (一个1-5的数字，代表星级)。请确保评价内容和风格多样，有好评，有中性评价，也有抱怨的差评。
6.  **款式 (styles)**: 一个包含3到6个字符串的数组，每个字符串代表一个商品款式或规格。例如：["樱花粉", "天空蓝", "磨砂黑"]。

**输出格式**: 严格按照JSON对象格式输出，不要包含任何markdown标记或解释性文字。
**示例**:
{
  "products": [
    { "name": "【月销10w+】熬夜党狂喜！XX同款一秒隐匿黑眼圈遮瑕液", "emoji": "👁️", "price": 39.9, "sales": 128567, "styles": ["象牙白", "自然色"], "reviews": [{ "nickname": "小熊不吃糖", "content": "真的绝了，黑眼圈瞬间消失...", "rating": 5 }] }
  ]
}`;
    try {
        const res = await fetch(`${settings.api.url.endsWith('/v1') ? settings.api.url : settings.api.url + '/v1'}/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.api.key}` },
            body: JSON.stringify({ model: settings.api.model, messages: [{ role: 'user', content: prompt }], temperature: parseFloat(settings.api.temp || 0.8), response_format: { "type": "json_object" } })
        });
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`API Error: ${res.status} - ${errorData.error.message}`);
        }
        const data = await res.json();
        const content = data.choices[0].message.content;
        const responseObject = JSON.parse(content);
        const products = responseObject.products;
        if (!Array.isArray(products)) {
            console.error("Parsed response from AI is not the expected format. Response:", responseObject);
            throw new Error("AI did not return a valid object with a 'products' array.");
        }
        products.forEach((p, index) => { p.id = `prod-${currentMallCategoryId}-${Date.now()}-${index}`; });
        let cache = getMallProductsCache();
        cache[currentMallCategoryId] = products;
        saveMallProductsCache(cache);
        renderMallProducts(products);
    } catch (error) {
        console.error("Error generating mall products:", error);
        grid.innerHTML = `<p style="color:#cc0000; text-align:center; grid-column: span 2;">商品生成失败: ${error.message}</p>`;
    }
}

function formatSales(num) {
    if (num >= 10000) return (num / 10000).toFixed(1).replace(/\.0$/, '') + '万+';
    return num + '+';
}

function renderMallProducts(products) {
    const grid = document.getElementById('mall-product-grid');
    grid.innerHTML = '';
    if (!products || products.length === 0) {
        grid.innerHTML = '<p style="color:#ccc; text-align:center; grid-column: span 2;">这个分类下还没有商品哦~</p>';
        return;
    }
    products.forEach(p => {
        const item = document.createElement('div');
        item.className = 'mall-product-item';
        item.onclick = () => openMallDetail(p.id);
        const price = parseFloat(p.price) || 0;
        const sales = parseInt(p.sales) || 0;
        item.innerHTML = `
            <div class="product-image">${p.emoji || '📦'}</div>
            <div class="product-details">
                <div class="product-name">${escapeHtml(p.name)}</div>
                <div class="product-price-info">
                    <span class="product-price">${price.toFixed(2)}</span>
                    <div class="product-price-extra">
                        <span class="product-coupon-tag">券后价</span>
                        <span class="product-sales">已售 ${formatSales(sales)}</span>
                    </div>
                </div>
            </div>
        `;
        grid.appendChild(item);
    });
}

function renderReviewStars(rating) {
    const fullStar = '★'; const emptyStar = '☆'; let stars = '';
    for (let i = 1; i <= 5; i++) { stars += (i <= rating) ? fullStar : emptyStar; }
    return stars;
}

window.openMallDetail = (productId) => {
    const cache = getMallProductsCache();
    const products = cache[currentMallCategoryId];
    if (!products) return;
    const product = products.find(p => p.id === productId);
    if (!product) { showToast("找不到该商品"); return; }
    const contentEl = document.getElementById('mall-detail-content');
    const reviewsHtml = (product.reviews && product.reviews.length > 0)
        ? product.reviews.map(review => `<div class="review-item"><div class="review-header"><span class="review-nickname">${escapeHtml(review.nickname)}</span><span class="review-stars">${renderReviewStars(review.rating)}</span></div><p class="review-content">${escapeHtml(review.content)}</p></div>`).join('')
        : '<p style="color:#ccc; text-align:center; padding: 20px 0;">暂无评价</p>';
    contentEl.innerHTML = `
        <div class="mall-detail-img-container">${product.emoji || '📦'}</div>
        <div class="mall-detail-info-card">
            <div class="mall-detail-price">${(parseFloat(product.price) || 0).toFixed(2)}</div>
            <h2 class="mall-detail-name">${escapeHtml(product.name)}</h2>
            <p class="mall-detail-sales">已售 ${formatSales(parseInt(product.sales) || 0)}</p>
        </div>
        <div class="mall-detail-reviews-card">
            <h3>商品评价 (${product.reviews?.length || 0})</h3>
            ${reviewsHtml}
        </div>
    `;
    const favBtn = document.getElementById('mall-detail-fav-btn');
    const favIcon = favBtn.querySelector('img');
    if (product.isFavorited) {
        favIcon.src = "https://img.heliar.top/file/1770356886806_喜欢_like_3.png";
    } else {
        favIcon.src = "https://img.heliar.top/file/1772373425318_喜欢_like_5.png";
    }
    favBtn.onclick = () => toggleMallProductFavorite(productId);
    const buyBtn = document.querySelector('#mall-detail-page .footer-btn.buy');
    if (buyBtn) {
        buyBtn.onclick = () => openPurchasePanel(productId);
    }
    document.getElementById('mall-detail-page').classList.add('active');
};

window.closeMallDetail = () => {
    document.getElementById('mall-detail-page').classList.remove('active');
};

    window.toggleMallProductFavorite = (productId) => {
        const cache = getMallProductsCache();
        const products = cache[currentMallCategoryId];
        if (!products) return;
        const product = products.find(p => p.id === productId);
        if (!product) return;
        product.isFavorited = !product.isFavorited;
        saveMallProductsCache(cache);
        const favBtn = document.getElementById('mall-detail-fav-btn');
        const favIcon = favBtn.querySelector('img');
        if (product.isFavorited) {
            favIcon.src = "https://img.heliar.top/file/1770356886806_喜欢_like_3.png"; // 修改了链接
            showToast("已收藏");
        } else {
            favIcon.src = "https://img.heliar.top/file/1772373425318_喜欢_like_5.png"; // 修改了链接
            showToast("已取消收藏");
        }
    };


    // --- Forum App Logic ---
    window.openForumApp = () => {
        body.classList.add('forum-active');
        switchForumPage('home'); 
        renderForumList();
        renderAllForumPosts();
    };

    window.closeForumApp = () => {
        body.classList.remove('forum-active');
    };
    
    function switchForumPage(pageName) {
        document.querySelectorAll('#forum-content-wrapper > .forum-page').forEach(p => {
            p.classList.remove('active');
        });
        const pageToShow = document.getElementById(`forum-page-${pageName}`);
        if(pageToShow) {
            pageToShow.classList.add('active');
        }
    }
    
    window.switchForumTab = (index) => {
        const pageNames = ['home', 'post', 'me'];
        switchForumPage(pageNames[index]);
        
        document.querySelectorAll('.forum-nav-item').forEach((el, i) => {
            el.classList.toggle('active', i === index);
        });
        
        if (index === 0) { 
            renderAllForumPosts();
        } else if (index === 1) { 
            prepareForumPostPage();
        } else if (index === 2) { 
            renderForumMePage();
        }
    };
    
    function renderForumMePage() {
        const forumProfile = getForumUserData();
        const mainProfile = getUserProfile();

        const avatar = forumProfile.avatar || mainProfile.avatar || 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png';
        const nickname = forumProfile.nickname || mainProfile.nickname;
        const background = forumProfile.backgroundUrl || 'https://images.unsplash.com/photo-1501854140801-50d01698950b?auto=format&fit=crop&w=1000&q=80';

        document.getElementById('forum-me-avatar').src = avatar;
        document.getElementById('forum-me-nickname').textContent = nickname;
        document.getElementById('forum-me-bg').style.backgroundImage = `url('${background}')`;
        document.getElementById('forum-me-bg').onclick = triggerForumMeBgUpload;
    }


    window.openCreateForumModal = () => {
        tempForumAvatarUrl = '';
        tempForumWbIds = [];
        tempForumBoundRoleIds = []; 
        document.getElementById('new-forum-avatar-preview').src = '';
        document.getElementById('new-forum-avatar-preview').style.display = 'none';
        document.getElementById('forum-avatar-placeholder').style.display = 'flex';

        document.getElementById('new-forum-name-input').value = '';
        document.getElementById('new-forum-worldview-input').value = '';
        document.getElementById('new-forum-wb-selection-display').textContent = '未绑定世界书';
        document.getElementById('new-forum-role-selection-display').textContent = '未绑定角色'; 
       document.getElementById('create-forum-modal-overlay').classList.add('active');
    };

    window.closeCreateForumModal = () => {
                document.getElementById('create-forum-modal-overlay').classList.remove('active');
    };

    window.triggerForumAvatarUpload = () => {
        document.getElementById('input-forum-avatar').click();
    };

    window.handleForumAvatarUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        compressImage(file, 300, (base64) => {
            tempForumAvatarUrl = base64;
            const preview = document.getElementById('new-forum-avatar-preview');
            preview.src = base64;
            preview.style.display = 'block';
            document.getElementById('forum-avatar-placeholder').style.display = 'none';
        });
    };

    window.openForumWbBindModal = () => {
        wbBindMultiSelect = true;
        document.getElementById('wb-bind-modal-title').textContent = '选择绑定的世界书';
        wbBindCallback = (selectedIds) => {
            tempForumWbIds = selectedIds;
            const displayEl = document.getElementById('new-forum-wb-selection-display');
            if (selectedIds.length > 0) {
                const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
                const names = selectedIds.map(id => {
                    const book = worldbooks.find(b => b.id === id);
                    return book ? book.title : '未知';
                });
                displayEl.textContent = `已绑定: ${names.join(', ')}`;
            } else {
                displayEl.textContent = '未绑定世界书';
            }
        };
        openWorldBookBindModal('worldbook');
    };
    window.openForumCreateRoleBindModal = () => {
        wbBindMultiSelect = true;
        document.getElementById('wb-bind-modal-title').textContent = '选择绑定的角色';
        wbBindCallback = (selectedIds) => {
            tempForumBoundRoleIds = selectedIds;
            const displayEl = document.getElementById('new-forum-role-selection-display');
            if (selectedIds.length > 0) {
                const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
                const names = selectedIds.map(id => {
                    const contact = contacts.find(c => c.id === id);
                    return contact ? (contact.alias || contact.name) : '未知';
                }).join(', ');
                displayEl.textContent = `已绑定: ${names}`;
            } else {
                displayEl.textContent = '未绑定角色';
            }
        };
        openWorldBookBindModal('roles');
    };

    window.saveNewForum = () => {
        const name = document.getElementById('new-forum-name-input').value.trim();
        const worldview = document.getElementById('new-forum-worldview-input').value.trim();
        if (!name || !tempForumAvatarUrl) {
            showToast(!name ? "论坛名称不能为空" : "请上传论坛头像");
            return;
        }
        
        let forums = [];
        try { forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]'); } catch(e) {}
        forums.unshift({
            id: Date.now(),
            name: name,
            avatar: tempForumAvatarUrl,
            worldview: worldview,
            worldbookIds: tempForumWbIds,
            boundRoleIds: tempForumBoundRoleIds, 
        });
        localStorage.setItem(FORUMS_DATA_KEY, JSON.stringify(forums));
        showToast("论坛创建成功!");
        closeCreateForumModal();
        renderForumList();
    };

    window.renderForumList = () => {
        const container = document.getElementById('forum-list-container');
        container.innerHTML = '';
        let forums = [];
        try { forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]'); } catch(e) {}
        
        if (forums.length === 0) {
            container.innerHTML = `<p style="color: #999; width: 100%; text-align: center; font-size:13px; padding:10px; grid-column: span 4;">点击右上角 + 创建第一个论坛</p>`;
            return;
        }
        forums.forEach(forum => {
            const item = document.createElement('div');
            item.className = 'forum-list-item';
            item.onclick = () => openForumDetail(forum.id);
            item.innerHTML = `
                <img src="${forum.avatar}" class="forum-list-avatar">
                <span class="forum-list-name">${escapeHtml(forum.name)}</span>
            `;
            container.appendChild(item);
        });
    };
    
    // --- Forum Post & Detail Page Logic ---
    const XP_PER_LEVEL = 30; 

    function getForumUserData() {
        try { 
            const data = localStorage.getItem(FORUM_USER_DATA_KEY);
            return data ? JSON.parse(data) : { nickname: '', avatar: '', signIns: {}, backgroundUrl: '' };
        } catch(e) { 
            return { nickname: '', avatar: '', signIns: {}, backgroundUrl: '' }; 
        }
    }
    function saveForumUserData(data) {
        localStorage.setItem(FORUM_USER_DATA_KEY, JSON.stringify(data));
    }

    function calculateLevelInfo(xp) {
        const currentXP = xp || 0;
        const level = Math.floor(currentXP / XP_PER_LEVEL) + 1;
        const xpInCurrentLevel = currentXP % XP_PER_LEVEL;
        const progressPercent = (xpInCurrentLevel / XP_PER_LEVEL) * 100;
        return { level, xpInCurrentLevel, progressPercent };
    }
    
    function updateForumLevelDisplay(forumId) {
        const userData = getForumUserData();
        const userForumData = (userData.signIns && userData.signIns[forumId]) || { xp: 0 };
        const { level, xpInCurrentLevel, progressPercent } = calculateLevelInfo(userForumData.xp);

        document.getElementById('forum-detail-level').textContent = `Lv.${level}`;
        document.getElementById('forum-detail-exp-bar').style.width = `${progressPercent}%`;
        document.getElementById('forum-detail-exp-text').textContent = `${xpInCurrentLevel}/${XP_PER_LEVEL}`;
        
        document.querySelector('#forum-detail-level-display').style.display = 'flex';
    }


    window.openForumDetail = (forumId) => {
        currentForumDetailId = forumId;
        const forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]');
        const forum = forums.find(f => f.id === forumId);
        if (!forum) return;

        document.getElementById('forum-detail-header-name').textContent = forum.name;
        document.getElementById('forum-detail-header-avatar').src = forum.avatar || '';
        
        const signinBtn = document.getElementById('forum-detail-signin-btn');
        signinBtn.onclick = () => handleForumSignIn(forumId);
        
        document.getElementById('forum-detail-refresh-btn').onclick = () => handleForumRefresh(forumId);

        const userData = getForumUserData();
        const today = new Date().toDateString();
        const userForumData = (userData.signIns && userData.signIns[forumId]) || {};
        if (userForumData.lastSignIn === today) {
            signinBtn.textContent = '已签到';
            signinBtn.disabled = true;
        } else {
            signinBtn.textContent = '签到';
            signinBtn.disabled = false;
        }
        
        updateForumLevelDisplay(forumId);
        
        switchForumPage('detail');
        renderForumDetailPosts(forumId); 
    };

    window.closeForumDetail = () => {
        switchForumPage('home');
        currentForumDetailId = null;
    };
    
    window.handleForumSignIn = (forumId) => {
        const userData = getForumUserData();
        const today = new Date().toDateString();
        
        if (!userData.signIns) userData.signIns = {};
        if (!userData.signIns[forumId]) {
            userData.signIns[forumId] = { xp: 0, lastSignIn: '' };
        }
        
        if (userData.signIns[forumId].lastSignIn === today) {
            showToast("今天已经签过啦！");
            return;
        }
        
        userData.signIns[forumId].xp = (userData.signIns[forumId].xp || 0) + 10;
        userData.signIns[forumId].lastSignIn = today;
        saveForumUserData(userData);
        
        showToast(`签到成功！经验 +10`);
        const signinBtn = document.getElementById('forum-detail-signin-btn');
        signinBtn.textContent = '已签到';
        signinBtn.disabled = true;
        
        updateForumLevelDisplay(forumId);
    };

    window.prepareForumPostPage = () => {
        document.getElementById('forum-post-textarea').value = '';
        tempForumPostImages = [];
        renderForumPostImages();
        
        const select = document.getElementById('forum-post-target-select');
        select.innerHTML = '<option value="">请选择吧群...</option>';
        let forums = [];
        try { forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]'); } catch(e) {}
        
        forums.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.innerText = f.name;
            select.appendChild(opt);
        });
        if (currentForumDetailId) {
            select.value = currentForumDetailId;
        }
    };

    window.triggerForumPostImageUpload = () => {
        document.getElementById('input-forum-post-image').click();
    };

    window.handleForumPostImageUpload = (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        let processedCount = 0;
        files.forEach(file => {
            if (tempForumPostImages.length >= 9) return;
            compressImage(file, 600, (base64) => {
                tempForumPostImages.push(base64);
                processedCount++;
                if (processedCount === files.length || tempForumPostImages.length === 9) {
                     renderForumPostImages();
                }
            });
        });
        event.target.value = '';
    };

        function renderForumPostImages() {
        const grid = document.getElementById('forum-post-image-grid');
        const uploadBtn = document.createElement('div');
        uploadBtn.className = 'forum-post-add-img';
        uploadBtn.innerText = '+';
        uploadBtn.onclick = triggerForumPostImageUpload;

        grid.innerHTML = '';
        
        tempForumPostImages.forEach((src, index) => {
            const div = document.createElement('div');
            div.className = 'forum-post-img-preview';
                        div.innerHTML = `<img src="${src}"><div class="forum-post-img-remove" onclick="removeForumPostImage(${index})">✕</div>`;
            grid.appendChild(div);
        });
        
        if (tempForumPostImages.length < 9) {
            grid.appendChild(uploadBtn);
        }
    }

    window.removeForumPostImage = (index) => {
        tempForumPostImages.splice(index, 1);
        renderForumPostImages();
    };

    window.submitForumPost = () => {
        const content = document.getElementById('forum-post-textarea').value.trim();
        const forumId = document.getElementById('forum-post-target-select').value;
        
        if (!forumId || (!content && tempForumPostImages.length === 0)) {
            showToast(!forumId ? "请选择要发布的吧群" : "请输入内容或上传图片");
            return;
        }
        
        const forumProfile = getForumUserData();
        const mainProfile = getUserProfile();
        const forumSignIns = (forumProfile.signIns && forumProfile.signIns[forumId]) || {xp: 0};

        const newPost = {
            id: Date.now(),
            forumId: parseInt(forumId),
            content: content,
            images: [...tempForumPostImages],
            authorId: mainProfile.qqId, 
            authorName: forumProfile.nickname || mainProfile.nickname,
            authorAvatar: forumProfile.avatar || mainProfile.avatar,
            authorXP: forumSignIns.xp, 
            timestamp: Date.now(),
            likes: [], 
            tags: [], 
            comments: [] 
        };
        
        let posts = [];
        try { posts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]'); } catch(e) {}
        posts.unshift(newPost);
        localStorage.setItem(FORUM_POSTS_DATA_KEY, JSON.stringify(posts));
        
        showToast("发布成功！");
        openForumDetail(parseInt(forumId));
    };

    window.renderAllForumPosts = () => {
        document.getElementById('forum-posts-area').innerHTML = ''; 
    };

    const customAvatarList = [
        "https://img.heliar.top/file/1770618803521_IMG_4118.jpeg", 
        "https://img.heliar.top/file/1770618839439_IMG_4156.jpeg",
        "https://img.heliar.top/file/1770618963468_IMG_4157.jpeg",
        "https://img.heliar.top/file/1770619023973_IMG_4158.jpeg",
    ];

    const getRandomCustomAvatar = () => {
        if (customAvatarList.length === 0) return "https://img.heliar.top/file/1770068438490_添加人群_people-plus.png"; 
        return customAvatarList[Math.floor(Math.random() * customAvatarList.length)];
    };

    window.renderForumDetailPosts = (forumId) => {
        const container = document.getElementById('forum-detail-posts-area');
        container.innerHTML = '';
        
        const allPosts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]');
        const forumPosts = allPosts.filter(p => p.forumId === forumId).sort((a,b) => b.timestamp - a.timestamp);
        
        if (forumPosts.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#ccc; padding:50px 20px;">这里还空空如也，快来发布第一条帖子吧~</div>';
            return;
        }
        
        const mainProfile = getUserProfile();

        forumPosts.forEach(post => {
            let imgHtml = '';
            if (post.images && post.images.length > 0) {
                let gridClass = 'single-img';
                if (post.images.length === 2 || post.images.length === 4) gridClass = `grid-${post.images.length}`; 
                else if (post.images.length > 1) gridClass = `grid-${post.images.length > 9 ? 9 : post.images.length}`; 
                
                imgHtml = `<div class="moments-img-grid ${gridClass}" style="margin-bottom:10px;">` +
                    post.images.slice(0, 9).map(src => `<img src="${src}" class="moment-grid-img">`).join('') +
                    `</div>`;
            }
            
            const dateStr = formatTimestamp(post.timestamp);
            const { level } = calculateLevelInfo(post.authorXP);
            const userHasLiked = post.likes && post.likes.includes(mainProfile.qqId);
            const likeIcon = userHasLiked ? "https://img.heliar.top/file/1770582836150_赞_thumbs-up_4.png" : "https://img.heliar.top/file/1770582828275_赞_thumbs-up_3.png";

            const tagsHtml = (post.tags && post.tags.length > 0) 
                ? `<div class="forum-post-tags">${post.tags.map(tag => `<span>${escapeHtml(tag)}</span>`).join(' ')}</div>` 
                : '';

            const commentsHtml = (post.comments && post.comments.length > 0)
                ? post.comments.map(comment => {
                    const avatarSrc = comment.author_avatar || getRandomCustomAvatar();
                    
                    let commentText = escapeHtml(comment.text);
                    if (comment.reply_to_nickname) {
                        const replyTag = `<span class="comment-reply-tag">@${escapeHtml(comment.reply_to_nickname)}</span>`;
                        commentText = commentText.replace(`@${comment.reply_to_nickname}`, replyTag);
                    }
                    
                    return `
                        <div class="forum-post-comment-item">
                            <img src="${avatarSrc}" class="comment-avatar">
                            <div class="comment-body">
                                <div class="comment-nickname">${escapeHtml(comment.author_nickname)}</div>
                                <div class="comment-text">${commentText}</div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '';

            const card = document.createElement('div');
            card.className = 'forum-post-card';
            card.innerHTML = `
                <div class="forum-post-header">
                    <img src="${post.authorAvatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'}" class="forum-post-avatar">
                    <div class="forum-post-user-info">
                        <div class="forum-post-user">${escapeHtml(post.authorName)}</div>
                    </div>
                    <span class="forum-post-level">Lv.${level}</span>
                    <div class="forum-post-time">${dateStr}</div>
                </div>
                ${post.content ? `<div class="forum-post-content">${escapeHtml(post.content)}</div>` : ''}
                ${imgHtml}
                ${tagsHtml}
                <div class="forum-post-actions">
                    <div class="forum-post-action-btn" onclick="shareForumPost(${post.id})">
                        <img src="https://img.heliar.top/file/1770582835252_分享_share.png">
                        <span>分享</span>
                    </div>
                    <div class="forum-post-action-btn" onclick="commentOnForumPost(${post.id})">
                        <img src="https://img.heliar.top/file/1770582828238_未读消息_message-unread.png">
                        <span>${post.comments ? post.comments.length : 0}</span>
                    </div>
                    <div class="forum-post-action-btn" onclick="toggleForumPostLike(${post.id})">
                        <img src="${likeIcon}">
                        <span>${post.likes ? post.likes.length : 0}</span>
                    </div>
                </div>
                <div class="forum-post-feedback ${!commentsHtml ? 'hidden' : ''}">
                    <div class="forum-post-comments-list">
                        ${commentsHtml}
                    </div>
                </div>
            `;
                        container.appendChild(card);
        });
    };

    window.shareForumPost = (postId) => { showToast("分享功能待开发"); };
    window.commentOnForumPost = (postId) => { showToast("评论功能待开发"); };
    
    window.toggleForumPostLike = (postId) => {
        let posts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]');
        const postIndex = posts.findIndex(p => p.id === postId);
        if (postIndex === -1) return;

        const mainProfile = getUserProfile();
        const likeIndex = (posts[postIndex].likes || []).indexOf(mainProfile.qqId);

        if (!posts[postIndex].likes) posts[postIndex].likes = [];

        if (likeIndex > -1) {
            posts[postIndex].likes.splice(likeIndex, 1); 
        } else {
            posts[postIndex].likes.push(mainProfile.qqId); 
        }

        localStorage.setItem(FORUM_POSTS_DATA_KEY, JSON.stringify(posts));
        
        if(currentForumDetailId) {
            renderForumDetailPosts(currentForumDetailId);
        }
    };
    
    window.openForumMeSettings = () => {
        const modal = document.getElementById('forum-me-settings-modal');
        const profile = getForumUserData();
        const mainProfile = getUserProfile();

        tempForumMeAvatarUrl = profile.avatar || '';
        tempForumMeBgUrl = profile.backgroundUrl || '';

        document.getElementById('forum-me-settings-avatar-preview').src = profile.avatar || mainProfile.avatar || 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png';
        document.getElementById('forum-me-settings-avatar-url').value = profile.avatar || '';
        document.getElementById('forum-me-settings-bg-preview').src = profile.backgroundUrl || 'https://images.unsplash.com/photo-1501854140801-50d01698950b?auto=format&fit=crop&w=1000&q=80';
        document.getElementById('forum-me-settings-bg-url').value = profile.backgroundUrl || '';
        document.getElementById('forum-me-settings-nickname').value = profile.nickname || '';

        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    };

    window.closeForumMeSettings = () => {
        const modal = document.getElementById('forum-me-settings-modal');
        modal.classList.remove('active');
        setTimeout(() => modal.style.display = 'none', 200);
    };
    
    window.triggerForumMeAvatarUpload = () => {
        document.getElementById('input-forum-me-avatar').click();
    };

    window.handleForumMeAvatarUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        compressImage(file, 200, (base64) => {
            tempForumMeAvatarUrl = base64;
            document.getElementById('forum-me-settings-avatar-preview').src = base64;
            document.getElementById('forum-me-settings-avatar-url').value = '（已上传本地图片）';
        });
    };

    window.triggerForumMeBgUpload = () => {
        document.getElementById('input-forum-me-bg').click();
    };
    
    window.handleForumMeBgUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        compressImage(file, 1000, (base64) => {
            const isSettingsModalActive = document.getElementById('forum-me-settings-modal').classList.contains('active');
            if (isSettingsModalActive) {
                tempForumMeBgUrl = base64;
                document.getElementById('forum-me-settings-bg-preview').src = base64;
                document.getElementById('forum-me-settings-bg-url').value = '（已上传本地图片）';
            } else {
                const userData = getForumUserData();
                userData.backgroundUrl = base64;
                saveForumUserData(userData);
                renderForumMePage();
                showToast("个人主页背景已更新");
            }
        });
    };

    window.saveForumMeSettings = () => {
        const profile = getForumUserData();
        
        profile.nickname = document.getElementById('forum-me-settings-nickname').value.trim();
        
        const avatarUrlFromInput = document.getElementById('forum-me-settings-avatar-url').value.trim();
        if (tempForumMeAvatarUrl) {
            profile.avatar = tempForumMeAvatarUrl;
                } else if (avatarUrlFromInput !== '（已上传本地图片）') {
            profile.avatar = avatarUrlFromInput;
        }
        
        const bgUrlFromInput = document.getElementById('forum-me-settings-bg-url').value.trim();
        if (tempForumMeBgUrl) {
            profile.backgroundUrl = tempForumMeBgUrl;
        } else if (bgUrlFromInput !== '（已上传本地图片）') {
            profile.backgroundUrl = bgUrlFromInput;
        }

        saveForumUserData(profile);
        showToast('论坛设置已保存');
        closeForumMeSettings();
        renderForumMePage();
    };

    window.expandPostContent = (element) => {
        element.classList.remove('truncated');
    };

    async function callApiForJson(prompt) {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        let url = settings.api.url;
        const key = settings.api.key;
        let model = settings.api.model || 'gemini-pro'; 
        let body;
        let headers = { 'Content-Type': 'application/json' };
        
        if (url.includes('generativelanguage')) {
            url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
            body = JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    temperature: parseFloat(settings.api.temp || 0.9),
                },
            });
        } else {
            url = `${url.endsWith('/v1') ? url : url+'/v1'}/chat/completions`;
            headers['Authorization'] = `Bearer ${key}`;
            body = JSON.stringify({
                model: model,
                messages: [{ role: 'user', content: prompt }], 
                temperature: parseFloat(settings.api.temp || 0.9),
                response_format: { "type": "json_object" }
            });
        }
        
        const response = await fetch(url, { method: 'POST', headers: headers, body: body });

        if (!response.ok) {
            const errorData = await response.json();
            const errorMessage = errorData?.error?.message || JSON.stringify(errorData);
            throw new Error(`API Error: ${response.status} - ${errorMessage}`);
        }
        
        const data = await response.json();
        let content;

        if (url.includes('generativelanguage')) { 
            if (!data.candidates || !data.candidates[0].content.parts[0].text) throw new Error('Invalid Gemini response format.');
            content = data.candidates[0].content.parts[0].text;
        } else { 
            content = data.choices[0].message.content;
        }
        
        const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```|({[\s\S]*})/);
        if (!jsonMatch) {
            console.error("API did not return valid JSON. Raw response:", content);
            throw new Error("API did not return valid JSON.");
        }
        
        const jsonString = jsonMatch[1] ? jsonMatch[1] : jsonMatch[2];
        
        try {
            return JSON.parse(jsonString);
        } catch (parseError) {
            console.error("Failed to parse JSON string:", jsonString, "Original content:", content);
            throw new Error("Failed to parse JSON from API response.");
        }
    }


    async function handleForumRefresh(forumId) {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings?.api?.url || !settings?.api?.key || !settings?.api?.model) {
            showToast('请先在设置中配置完整的 API 信息');
            return;
        }

        const forums = JSON.parse(localStorage.getItem(FORUMS_DATA_KEY) || '[]');
        const currentForum = forums.find(f => f.id === forumId);
        if (!currentForum) return;

        const refreshBtn = document.getElementById('forum-detail-refresh-btn');
        refreshBtn.style.animation = 'spin 1s linear infinite';
        showToast('正在生成内容，请稍候...', 4000);

        try {
            const allWorldBooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const worldBookContext = (currentForum.worldbookIds || [])
                .map(id => {
                    const book = allWorldBooks.find(b => b.id === id);
                    return book ? `[世界书: ${book.title}]\n${book.entries.map(e => `${e.key}: ${e.content}`).join('\n')}` : '';
                }).filter(Boolean).join('\n\n') || '无';

            const allContacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
            const boundRoles = (currentForum.boundRoleIds || [])
                .map(id => allContacts.find(c => c.id === id)).filter(Boolean);

            const generalPostPrompt = `You are a content creator for a fictional forum.
Forum Name: "${currentForum.name}"
Worldview: "${currentForum.worldview || 'A standard fantasy world.'}"
World Book Facts (Highest Priority):
${worldBookContext}

Generate a JSON object with a key "posts" containing an array of 5-6 original posts.
For each post, provide:
- author_nickname: A plausible, unique, non-repeating nickname suitable for the forum's atmosphere.
- content: The post text. Must be original, engaging, natural-sounding, and strictly adhere to the worldview and world book facts.
- tags: An array of 1-3 relevant string tags in "#tag" format.
- comments: An array of 5-10 unique comment objects. Each comment must have:
    - author_nickname: A unique, non-repeating passerby nickname.
    - text: The comment content, which should be a realistic reaction to the post, a question, or a reply to another comment. To reply, use the format "@[nickname] [your_reply_text]".
    - reply_to_nickname: (Optional) The nickname of the user they are replying to. If it's a top-level comment, this should be null.

Strictly adhere to the JSON format. Example:
{ "posts": [ { "author_nickname": "User1", "content": "Text", "tags": ["#Tag"], "comments": [ { "author_nickname": "User2", "text": "Comment", "reply_to_nickname": null } ] } ] }`;

            let generatedData = await callApiForJson(generalPostPrompt);
            let newPosts = generatedData.posts || [];
            
            if (boundRoles.length > 0) {
                for (const role of boundRoles) {
                    if (Math.random() < 0.5) {
                        const rolePostPrompt = `Act as character "${role.alias || role.name}". Persona: "${role.persona}". Forum: "${currentForum.name}". Worldview: "${currentForum.worldview}". Facts: ${worldBookContext}. Generate JSON key "post" with fields: author_nickname (exact character name), content, tags, comments (empty array).`;
                        try {
                            const rolePostData = await callApiForJson(rolePostPrompt);
                            if (rolePostData.post) {
                                rolePostData.post.author_avatar = role.avatar;
                                newPosts.unshift(rolePostData.post);
                            }
                        } catch (e) { console.warn(`Role post failed`, e); }
                    }
                }
            }

            const processedPosts = newPosts.map((p, index) => ({
                id: Date.now() + index, 
                forumId: forumId,
                authorName: p.author_nickname,
                authorAvatar: p.author_avatar || '', 
                content: p.content,
                tags: p.tags || [],
                comments: p.comments || [],
                timestamp: Date.now(),
                likes: [],
                authorXP: Math.floor(Math.random() * 500) 
            }));

            let allStoredPosts = JSON.parse(localStorage.getItem(FORUM_POSTS_DATA_KEY) || '[]');
            allStoredPosts = [...processedPosts, ...allStoredPosts];
            
            localStorage.setItem(FORUM_POSTS_DATA_KEY, JSON.stringify(allStoredPosts));

            renderForumDetailPosts(forumId);
            showToast(`刷新成功！更新了 ${processedPosts.length} 条内容`);

        } catch (error) {
            console.error('Forum refresh failed:', error);
            showToast('内容生成失败: ' + error.message, 4000);
        } finally {
            refreshBtn.style.animation = '';
        }
    }

    // --- Chat App Logic ---
    window.openChatApp = () => { body.classList.add('chat-active'); switchChatTab(0, 'Chat'); renderChatList(); };
    window.closeChatApp = () => { body.classList.remove('chat-active'); closeChatConversation(); body.classList.remove('recollection-active'); };
    window.switchChatTab = (index, title) => {
        const titleEl = document.getElementById('chat-page-title');
        const addFriendIcon = document.getElementById('chat-header-add-friend-icon');
        const addMomentIcon = document.getElementById('chat-header-add-moment-icon');
        const urgePostIcon = document.getElementById('urge-post-icon');
        const headerEl = document.getElementById('chat-app-header-el');
        const backBtn = document.getElementById('chat-back-btn');
        const contentArea = document.getElementById('chat-content-area');
        const leftIconsContainer = document.getElementById('chat-header-left-icons');
        
        document.querySelectorAll('.chat-tab-content').forEach((el, i) => el.classList.toggle('active', i === index));
        document.querySelectorAll('.chat-nav-item').forEach((el, i) => el.classList.toggle('active', i === index));
        
        contentArea.style.backgroundColor = (index === 2) ? '#ffffff' : '';
        
        headerEl.classList.remove('hidden');
        headerEl.style.backgroundColor = ''; 
        headerEl.style.boxShadow = ''; 
        
        contentArea.classList.remove('me-mode');
        
        backBtn.style.display = 'block';
        addFriendIcon.style.display = 'none';
        addMomentIcon.style.display = 'none';
        urgePostIcon.style.display = 'none';
        titleEl.style.color = ""; 
        
        closeCommentInput();

        if (index === 0) { 
            titleEl.innerText = title;
            titleEl.style.color = "#FDCEDF";
            addFriendIcon.style.display = 'block';
        } else if (index === 1) { 
            titleEl.innerText = title;
            backBtn.style.display = 'none';
            renderContactList(); 
        } else if (index === 2) { 
            titleEl.innerText = title;
            titleEl.style.color = "#FDCEDF";
            addMomentIcon.style.display = 'block';
            backBtn.style.display = 'none';
            urgePostIcon.style.display = 'block';
            renderMomentsPage();
        } else if (index === 3) { 
            headerEl.classList.add('hidden'); 
            contentArea.classList.add('me-mode');
            loadUserProfile();
         }
    };
    
    // --- Moments (朋友圈) Functions ---
    function getMomentsProfile() {
        try {
            const p = localStorage.getItem(MOMENTS_PROFILE_KEY);
            const profile = p ? JSON.parse(p) : {};
            return {
                cover: profile.cover || 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1000&q=80',
                avatar: profile.avatar || 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png'
            };
        } catch (e) {
            return {
                cover: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1000&q=80',
                avatar: 'https://img.heliar.top/file/1770068137566_收藏好友_personal-collection_2.png'
            };
        }
    }

    function saveMomentsProfile(profileData) {
        try {
            localStorage.setItem(MOMENTS_PROFILE_KEY, JSON.stringify(profileData));
        } catch (e) {
            showToast("保存朋友圈信息失败 (LocalStorage可能已满)");
        }
    }
    
    function getMomentsData() {
        try { return JSON.parse(localStorage.getItem(MOMENTS_DATA_KEY) || '[]'); } catch (e) { return []; }
    }

    function saveMomentsData(data) {
        localStorage.setItem(MOMENTS_DATA_KEY, JSON.stringify(data));
    }
    
    function formatTimestamp(ts) {
        const now = new Date();
        const postDate = new Date(ts);
        const diff = now - postDate;
        const diffMinutes = Math.floor(diff / 60000);
        const diffHours = Math.floor(diff / 3600000);
        const diffDays = Math.floor(diff / 86400000);

                if (diffMinutes < 1) return '刚刚';
        if (diffMinutes < 60) return `${diffMinutes}分钟前`;
        if (diffHours < 24 && now.getDate() === postDate.getDate()) return `${diffHours}小时前`;
        if (diffDays === 1 || (diffHours < 48 && now.getDate() - 1 === postDate.getDate())) return '昨天';
        return `${postDate.getMonth() + 1}月${postDate.getDate()}日`;
    }

    function renderMomentsPage() {
        const wrapper = document.getElementById('moments-page-wrapper');
        const userProfile = getUserProfile();
        const momentsProfile = getMomentsProfile();
        let moments = getMomentsData();
        let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');

        let listHtml = '';
        if (moments.length > 0) {
            moments.sort((a,b) => b.timestamp - a.timestamp); 
            moments.forEach(moment => {
                const isUserMoment = !moment.authorId || moment.authorId === userProfile.qqId;
                const author = isUserMoment ? userProfile : contacts.find(c => c.id === moment.authorId);
                
                if (moment.isPrivate && !isUserMoment) {
                    return;
                }

                const authorNickname = author ? (isUserMoment ? userProfile.nickname : (author.alias || author.name)) : '未知用户';
                const authorAvatar = author ? (isUserMoment ? momentsProfile.avatar : author.avatar) : 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png';
                
                const userHasLiked = moment.likes.includes(userProfile.qqId);
                const likeBtnText = userHasLiked ? '取消' : '赞';
                const likeIconUrl = userHasLiked ? "https://img.heliar.top/file/1770356886806_喜欢_like_3.png" : "https://img.heliar.top/file/1770353311894_喜欢_like_2.png";
                
                const privateTag = moment.isPrivate ? `<span style="color: #999; font-weight: 400; margin-left: 8px;">仅你可见</span>` : '';


                let likesHtml = '';
                if (moment.likes && moment.likes.length > 0) {
                    const likerProfile = getUserProfile(); 
                    const likerName = likerProfile.nickname || "User";
                    likesHtml = `<div class="moment-likes"><img src="https://img.heliar.top/file/1770356881218_喜欢_like_4.png" style="width:14px;height:14px;object-fit:contain;"> ${escapeHtml(likerName)}</div>`;
                }

                let commentsHtml = '';
                if (moment.comments && moment.comments.length > 0) {
                    commentsHtml = `<div class="moment-comments-list">` +
                        moment.comments.map(c => 
                            `<div class="moment-comment-item"><span class="user">${escapeHtml(c.user)}:</span> <span class="text">${escapeHtml(c.text)}</span></div>`
                        ).join('') +
                    `</div>`;
                }
                
                let imageGridHtml = '';
                let images = moment.images || (moment.imageUrl ? [moment.imageUrl] : []);
                
                if (images.length > 0) {
                    let gridClass = 'single-img';
                    if (images.length === 1) gridClass = 'single-img';
                    else if (images.length === 2 || images.length === 4) gridClass = `grid-${images.length}`; 
                    else gridClass = `grid-${images.length}`; 
                    
                    imageGridHtml = `<div class="moments-img-grid ${gridClass}">` + 
                        images.map(url => `<img src="${url}" class="moment-grid-img" onclick="event.stopPropagation()">`).join('') +
                    `</div>`;
                }
                
                const showDeleteBtn = isUserMoment || (author && author.id);

                listHtml += `
                    <div class="moment-item" id="moment-${moment.id}">
                        ${showDeleteBtn ? `<img src="https://img.heliar.top/file/1770357709135_删除_delete.png" class="moment-delete-btn" onclick="confirmDeleteMoment(${moment.id})">` : ''}
                        <img src="${authorAvatar}" class="moment-item-avatar" alt="avatar">
                        <div class="moment-item-content">
                            <div class="moment-item-nickname">${escapeHtml(authorNickname)}</div>
                            ${moment.text ? `<div class="moment-item-text">${escapeHtml(moment.text)}</div>` : ''}
                            ${imageGridHtml}
                            <div class="moment-item-meta">
                                <div class="moment-item-meta-left">
                                    ${privateTag}
                                </div>
                                <div style="display:flex; align-items:center; gap: 8px;">
                                     <span class="moment-timestamp">${formatTimestamp(moment.timestamp)}</span>
                                    <div class="moment-actions-btn" onclick="toggleActionsPopup(${moment.id}, event)">
                                        ··
                                        <div class="moment-actions-popup">
                                            <div class="moment-popup-btn" onclick="toggleLike(${moment.id})"><img src="${likeIconUrl}"> ${likeBtnText}</div>
                                            <div class="moment-popup-btn" onclick="openCommentInput(${moment.id})"><img src="https://img.heliar.top/file/1770353307524_评论_comment.png"> 评论</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ${(likesHtml || commentsHtml) ? `<div class="moment-feedback">${likesHtml}${commentsHtml}</div>` : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            listHtml = '<div class="moments-empty-placeholder">还没有动态，点击右上角相机发布第一条吧！</div>';
        }
        
        wrapper.innerHTML = `
            <div class="moments-header">
                <div class="moments-cover-img" style="background-image: url('${momentsProfile.cover}')"></div>
                <div class="moments-user-info">
                    <span class="moments-user-nickname">${escapeHtml(userProfile.nickname)}</span>
                    <img src="${momentsProfile.avatar}" class="moments-user-avatar" alt="avatar">
                </div>
            </div>
            <div id="moments-list">
                ${listHtml}
            </div>
        `;
    }
    
    window.confirmDeleteMoment = (momentId) => {
        currentDeleteMomentId = momentId;
        document.getElementById('delete-moment-confirm-modal').classList.add('active');
    };
    
    window.executeDeleteMoment = () => {
        if (!currentDeleteMomentId) return;
        let moments = getMomentsData();
        const updatedMoments = moments.filter(m => m.id !== currentDeleteMomentId);
        saveMomentsData(updatedMoments);
        closeDeleteModal('delete-moment-confirm-modal');
        renderMomentsPage();
        showToast("动态已删除");
        currentDeleteMomentId = null;
    };


    window.toggleActionsPopup = (momentId, event) => {
        event.stopPropagation();
        document.querySelectorAll('.moment-actions-popup.active').forEach(p => {
             if (!p.closest(`#moment-${momentId}`)) {
                p.classList.remove('active');
            }
        });
        const popup = document.querySelector(`#moment-${momentId} .moment-actions-popup`);
        if (popup) {
            popup.classList.toggle('active');
        }
    };

    document.addEventListener('click', (e) => { 
        if (!e.target.closest('.moment-actions-btn')) {
            document.querySelectorAll('.moment-actions-popup').forEach(p => p.classList.remove('active'));
        }
        
        if (activeMsgIdForMenu && !e.target.closest('.bubble-context-menu')) {
            closeBubbleMenu();
        }
    });

    window.openMomentsActionSheet = () => {
        document.getElementById('moments-action-sheet-overlay').classList.add('active');
    };
    
    window.closeMomentsActionSheet = () => {
        document.getElementById('moments-action-sheet-overlay').classList.remove('active');
    };
    
    window.handleMomentAction = (action) => {
        closeMomentsActionSheet();
        if (action === 'shoot' || action === 'album') {
            setTimeout(() => {
                openAddMomentModal();
            }, 300);
        }
    };

    window.openAddMomentModal = () => {
        document.getElementById('add-moment-text').value = '';
        tempMomentImages = [];
        renderAddMomentGrid();
        document.getElementById('add-moment-modal').classList.add('active');
    };
    window.closeAddMomentModal = () => {
        document.getElementById('add-moment-modal').classList.remove('active');
    };

    window.triggerMomentImageUpload = () => {
        document.getElementById('input-moment-image').click();
    };

    window.handleMomentImageUpload = (event) => {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;
        
        let processedCount = 0;
        files.forEach(file => {
            if (tempMomentImages.length >= 9) return;
            compressImage(file, 600, (base64) => {
                tempMomentImages.push(base64);
                processedCount++;
                if (processedCount === files.length || tempMomentImages.length === 9) {
                     renderAddMomentGrid();
                }
            });
        });
        event.target.value = '';
    };
    
    function renderAddMomentGrid() {
        const grid = document.getElementById('add-moment-grid');
        const uploadBtn = document.createElement('div');
        uploadBtn.className = 'add-moment-image-upload';
        uploadBtn.innerHTML = '<span id="moment-upload-icon">+</span>';
        uploadBtn.onclick = triggerMomentImageUpload;

        grid.innerHTML = '';
        
        tempMomentImages.forEach((src, index) => {
            const cell = document.createElement('div');
            cell.className = 'add-moment-img-cell';
            cell.innerHTML = `
                <img src="${src}">
                <div class="add-moment-remove-img" onclick="removeMomentImage(${index})">✕</div>
            `;
            grid.appendChild(cell);
        });
        
        if (tempMomentImages.length < 9) {
            grid.appendChild(uploadBtn);
        }
    }
    
    window.removeMomentImage = (index) => {
        tempMomentImages.splice(index, 1);
        renderAddMomentGrid();
    };

    window.saveNewMoment = () => {
        const text = document.getElementById('add-moment-text').value.trim();
        const images = [...tempMomentImages]; 
        if (!text && images.length === 0) {
            showToast("内容不能为空");
            return;
        }
        const profile = getUserProfile();
        const newMoment = {
            id: Date.now(),
            authorId: profile.qqId, 
            timestamp: Date.now(),
            text: text,
            images: images,
            likes: [],
            comments: [],
            isPrivate: false 
        };
        let moments = getMomentsData();
        moments.unshift(newMoment);
        saveMomentsData(moments);
        showToast("发布成功");
        renderMomentsPage();
        closeAddMomentModal();
    };
    
    window.toggleLike = (momentId) => {
    let moments = getMomentsData();
    const momentIndex = moments.findIndex(m => m.id === momentId);
    if (momentIndex === -1) return;
    
    const profile = getUserProfile();
    const myId = profile.qqId;
    
    if (!moments[momentIndex].likes) {
        moments[momentIndex].likes = [];
    }
    
    const likeIndex = moments[momentIndex].likes.indexOf(myId);

    if (likeIndex > -1) {
        moments[momentIndex].likes.splice(likeIndex, 1);
    } else {
        moments[momentIndex].likes.push(myId);
    }
    
    saveMomentsData(moments);
    renderMomentsPage();
    
    const popup = document.querySelector(`#moment-${momentId} .moment-actions-popup`);
    if (popup) popup.classList.remove('active');
};

    window.openCommentInput = (momentId) => {
        currentCommentMomentId = momentId;
        const modal = document.getElementById('moments-comment-modal');
        const overlay = document.getElementById('moments-comment-overlay');
        const inputField = document.getElementById('moments-comment-input');
        
        const popup = document.querySelector(`#moment-${momentId} .moment-actions-popup`);
        if (popup) popup.classList.remove('active');
        
        inputField.value = '';
        modal.classList.add('active');
        overlay.classList.add('active');
        
        setTimeout(() => {
            inputField.focus();
        }, 100);
    };

    window.closeCommentInput = () => {
        document.getElementById('moments-comment-modal').classList.remove('active');
        document.getElementById('moments-comment-overlay').classList.remove('active');
        document.getElementById('moments-comment-input').blur();
        currentCommentMomentId = null;
    };

    window.handleCommentKey = (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            submitComment();
        }
    };

    window.submitComment = () => {
        if (!currentCommentMomentId) return;
        
        const inputField = document.getElementById('moments-comment-input');
        const commentText = inputField.value.trim();
        if (!commentText) return;

        let moments = getMomentsData();
        const momentIndex = moments.findIndex(m => m.id === currentCommentMomentId);
        if (momentIndex === -1) return;

        const profile = getUserProfile();
        const newComment = {
            user: profile.nickname,
            userId: profile.qqId,
            text: commentText
        };
        
        if (!moments[momentIndex].comments) {
            moments[momentIndex].comments = [];
        }
        moments[momentIndex].comments.push(newComment);
        saveMomentsData(moments);
        
        closeCommentInput();
        renderMomentsPage();
    };
    
    // --- NEW: Urge To Post Logic ---
    window.openUrgeToPostModal = () => {
        const overlay = document.getElementById('urge-post-overlay');
        const listContainer = document.getElementById('urge-post-char-list');
        listContainer.innerHTML = '';
        selectedUrgeCharIds.clear();

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        if (contacts.length === 0) {
            listContainer.innerHTML = '<p style="color: #ccc; grid-column: span 4; text-align:center;">还没有创建角色哦~</p>';
        } else {
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'urge-post-char-item';
                item.dataset.contactId = contact.id;
                item.innerHTML = `
                    <img src="${contact.avatar}" alt="${contact.alias || contact.name}">
                    <span>${escapeHtml(contact.alias || contact.name)}</span>
                `;
                item.onclick = () => {
                    item.classList.toggle('selected');
                    const id = parseInt(item.dataset.contactId);
                    if (selectedUrgeCharIds.has(id)) {
                        selectedUrgeCharIds.delete(id);
                    } else {
                        selectedUrgeCharIds.add(id);
                    }
                };
                listContainer.appendChild(item);
            });
        }
        
        overlay.style.display = 'flex';
        setTimeout(() => overlay.classList.add('active'), 10);
    };

    window.closeUrgeToPostModal = () => {
        const overlay = document.getElementById('urge-post-overlay');
        overlay.classList.remove('active');
        setTimeout(() => overlay.style.display = 'none', 300);
    };

    window.confirmUrgeToPost = () => {
        if (selectedUrgeCharIds.size === 0) {
            showToast('请至少选择一个角色');
            return;
        }
        closeUrgeToPostModal();
        showToast('已成功催促！');
    };
    
    // --- Auto Post Moment Logic ---
    function scheduleAutoPost(contactId, intervalMinutes) {
        if (autoPostTimers[contactId]) {
            clearInterval(autoPostTimers[contactId]);
        }
        if (intervalMinutes > 0) {
            const intervalMs = intervalMinutes * 60 * 1000;
            autoPostTimers[contactId] = setInterval(async () => {
                const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
                const contact = contacts.find(c => c.id === contactId);
                if (contact && contact.autoPostEnabled) {
                    console.log(`[AutoPost] Triggering post for ${contact.alias || contact.name}`);
                    const newMoment = await generateMomentForCharacter(contact);
                    if (newMoment) {
                        let moments = getMomentsData();
                        moments.unshift(newMoment);
                        saveMomentsData(moments);
                        if (document.getElementById('chat-tab-2').classList.contains('active')) {
                            renderMomentsPage();
                        }
                        console.log(`[AutoPost] Successfully posted for ${contact.alias || contact.name}`);
                    }
                } else {
                    clearInterval(autoPostTimers[contactId]);
                    delete autoPostTimers[contactId];
                }
            }, intervalMs);
        }
    }

    function stopAutoPost(contactId) {
        if (autoPostTimers[contactId]) {
            clearInterval(autoPostTimers[contactId]);
            delete autoPostTimers[contactId];
            console.log(`[AutoPost] Stopped timer for contact ID ${contactId}`);
        }
    }

    function initializeAllAutoPosts() {
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        contacts.forEach(contact => {
            if (contact.autoPostEnabled && contact.autoPostInterval > 0) {
                scheduleAutoPost(contact.id, contact.autoPostInterval);
            }
        });
    }

    // --- World Book App Logic ---
    window.openWorldBookApp = () => { body.classList.add('worldbook-active'); renderWorldBooks(); };
    window.closeWorldBookApp = () => { body.classList.remove('worldbook-active'); closeWorldBookDetail(); closeWorldBookColorSettings(); };
    window.openWorldBookAddModal = () => { document.getElementById('wb-title-input').value = ""; document.getElementById('wb-dynamic-entries').innerHTML = ''; addWorldBookEntryRow(); document.getElementById('worldbook-add-modal').classList.add('active'); };
    window.closeWorldBookAddModal = () => { document.getElementById('worldbook-add-modal').classList.remove('active'); };
    window.addWorldBookEntryRow = () => { const container = document.getElementById('wb-dynamic-entries'); const row = document.createElement('div'); row.className = 'wb-entry-row wb-dynamic-row'; row.innerHTML = `<input type="text" class="wb-entry-input key" placeholder="名称（可选）"><textarea class="wb-entry-input val" placeholder="世界书内容"></textarea>`; container.appendChild(row); };
    window.saveWorldBook = () => { const title = document.getElementById('wb-title-input').value.trim(); if(!title) { showToast("请输入世界书名"); return; } const rows = document.querySelectorAll('.wb-dynamic-row'); const entries = []; let hasContent = false; rows.forEach(row => { const key = row.querySelector('.key').value.trim(); const val = row.querySelector('.val').value.trim(); if(val) { entries.push({ key: key, content: val }); hasContent = true; } }); if (!hasContent) { showToast("请至少输入一条世界书内容"); return; } const newBook = { id: Date.now(), title: title, entries: entries, coverColor: '#EAEAEA', coverImage: '' }; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) {} books.push(newBook); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("世界书已保存"); closeWorldBookAddModal(); renderWorldBooks(); };
    
    window.renderWorldBooks = () => { 
        const container = document.getElementById('worldbook-list'); 
        container.innerHTML = ''; 
        let books = []; 
        try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) { books = []; } 
        books.sort((a,b) => b.id - a.id).forEach(book => { 
            const item = document.createElement('div'); 
            item.className = 'wb-book-item'; 
            item.onclick = () => viewWorldBook(book.id); 
            item.innerHTML = `<div class="wb-book-cover"><div class="wb-book-name">${escapeHtml(book.title)}</div></div>`; 
            const coverEl = item.querySelector('.wb-book-cover'); 
            
            if (book.coverImage) {
                coverEl.style.backgroundImage = `url(${book.coverImage})`;
                coverEl.style.backgroundColor = 'transparent';
                item.querySelector('.wb-book-name').style.color = "white";
                item.querySelector('.wb-book-name').style.textShadow = "0 1px 4px rgba(0,0,0,0.8)";
            } else if (book.coverColor) { 
                coverEl.style.background = book.coverColor; 
            } 
            container.appendChild(item); 
        }); 
    };
    window.viewWorldBook = (id) => { currentWorldBookId = id; renderWorldBookDetailView(); document.getElementById('worldbook-detail-modal').classList.add('active'); };
    function renderWorldBookDetailView() { if (!currentWorldBookId) return; let books = []; try { books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); } catch(e) {} const book = books.find(b => b.id === currentWorldBookId); if(!book) { closeWorldBookDetail(); return; } document.getElementById('wb-detail-title-text').innerText = book.title; const contentArea = document.getElementById('wb-detail-content-area'); contentArea.innerHTML = ''; book.entries.forEach((entry, index) => { const div = document.createElement('div'); div.className = 'wb-detail-item'; div.id = `wb-entry-item-${index}`; div.innerHTML = `<div class="wb-detail-item-content">${entry.key ? `<div class="wb-detail-key">${escapeHtml(entry.key)}</div>` : ''}<div class="wb-detail-val">${escapeHtml(entry.content)}</div></div><div class="wb-detail-item-actions"><button onclick="editWorldBookEntry(${index})">修改</button><button onclick="deleteWorldBookEntry(${index})">删除</button></div>`; contentArea.appendChild(div); }); }
    window.editWorldBookEntry = (index) => { const itemEl = document.getElementById(`wb-entry-item-${index}`); if (!itemEl) return; const books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const book = books.find(b => b.id === currentWorldBookId); if (!book || !book.entries[index]) return; const entry = book.entries[index]; itemEl.innerHTML = `<div class="edit-form"><input type="text" class="wb-entry-input key" placeholder="名称（可选）" value="${escapeHtml(entry.key)}"><textarea class="wb-entry-input val" placeholder="世界书内容">${escapeHtml(entry.content)}</textarea></div><div class="wb-detail-item-actions"><button class="save" onclick="saveWorldBookEntry(${index})">保存</button><button onclick="renderWorldBookDetailView()">取消</button></div>`; };
    window.saveWorldBookEntry = (index) => { const itemEl = document.getElementById(`wb-entry-item-${index}`); const newKey = itemEl.querySelector('.key').value.trim(); const newVal = itemEl.querySelector('.val').value.trim(); if (!newVal) { showToast("内容不能为空"); return; } let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const bookIndex = books.findIndex(b => b.id === currentWorldBookId); if (bookIndex !== -1 && books[bookIndex].entries[index]) { books[bookIndex].entries[index] = { key: newKey, content: newVal }; localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("已保存"); renderWorldBookDetailView(); } };
    window.deleteWorldBookEntry = (index) => { if (!confirm("确定要删除这个条目吗？")) return; let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); const bookIndex = books.findIndex(b => b.id === currentWorldBookId); if (bookIndex !== -1 && books[bookIndex].entries[index]) { books[bookIndex].entries.splice(index, 1); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); showToast("已删除"); renderWorldBookDetailView(); } };
    window.closeWorldBookDetail = () => { document.getElementById('worldbook-detail-modal').classList.remove('active'); currentWorldBookId = null; };
    window.deleteCurrentWorldBook = () => { if(!currentWorldBookId) return; if(confirm("确定要删除这本世界书吗？此操作不可撤销。")) { let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); books = books.filter(b => b.id !== currentWorldBookId); localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); closeWorldBookDetail(); renderWorldBooks(); showToast("世界书已删除"); } };
    
    window.openWorldBookColorSettings = () => { 
        const page = document.getElementById('worldbook-color-page'); 
        const container = document.getElementById('wb-color-list'); 
        container.innerHTML = ''; 
        let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); 
        if (books.length === 0) { 
            container.innerHTML = '<p style="text-align:center; color:#999;">还没有创建世界书哦</p>'; 
        } else { 
            books.forEach(book => { 
                const item = document.createElement('div'); 
                item.className = 'wb-color-item'; 
                item.innerHTML = `
                    <span class="wb-color-item-name">${escapeHtml(book.title)}</span>
                    <button class="wb-cover-upload-btn" onclick="triggerWbCoverUpload(${book.id})">封面图</button>
                    <input type="color" class="wb-color-input" data-book-id="${book.id}" value="${book.coverColor || '#EAEAEA'}">
                `; 
                container.appendChild(item); 
            }); 
        } 
        page.classList.add('active'); 
    };
    window.closeWorldBookColorSettings = () => { document.getElementById('worldbook-color-page').classList.remove('active'); };
    window.saveWorldBookColors = () => { 
        let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]'); 
        const colorInputs = document.querySelectorAll('.wb-color-input'); 
        colorInputs.forEach(input => { 
            const bookId = parseInt(input.dataset.bookId); 
            const newColor = input.value; 
            const bookIndex = books.findIndex(b => b.id === bookId); 
            if (bookIndex !== -1) { 
                books[bookIndex].coverColor = newColor; 
            } 
        }); 
        localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books)); 
        showToast("设置已保存"); 
        closeWorldBookColorSettings(); 
        renderWorldBooks(); 
    };
    
    window.triggerWbCoverUpload = (bookId) => {
        currentWbCoverUploadId = bookId;
        document.getElementById('input-wb-cover').click();
    };
    
    window.handleWbCoverUpload = (event) => {
        const file = event.target.files[0];
        if (!file || !currentWbCoverUploadId) return;
        
        compressImage(file, 400, (base64) => {
            let books = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const index = books.findIndex(b => b.id === currentWbCoverUploadId);
            if (index !== -1) {
                books[index].coverImage = base64;
                localStorage.setItem(WORLDBOOK_DATA_KEY, JSON.stringify(books));
                showToast("封面图已上传");
            }
        });
        event.target.value = ''; 
    };

    // --- Wallet App Logic ---
    window.openWalletApp = () => { body.classList.add('wallet-active'); loadWalletUI(); };
    window.closeWalletApp = () => { body.classList.remove('wallet-active'); };
    function getWalletData() { try { const data = localStorage.getItem(WALLET_DATA_KEY); return data ? JSON.parse(data) : { balance: 0.00, transactions: [] }; } catch (e) { return { balance: 0.00, transactions: [] }; } }
    function saveWalletData(data) { localStorage.setItem(WALLET_DATA_KEY, JSON.stringify(data)); }
    function loadWalletUI() { 
        const profile = getUserProfile(); 
        document.getElementById('wallet-avatar').src = profile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; 
        document.getElementById('wallet-nickname').innerText = profile.nickname || 'User'; 
        const data = getWalletData(); 
        document.getElementById('wallet-total-balance').innerText = parseFloat(data.balance).toFixed(2); 
        const now = new Date(); 
        const currentMonthStr = `${now.getFullYear()}-${now.getMonth() + 1}`; 
        document.getElementById('wallet-current-month').innerText = `${now.getMonth() + 1}月`; 
        let monthIncome = 0; 
        let monthExpense = 0; 
        let monthTransactions = []; 
        data.transactions.forEach(t => { 
            const tDate = new Date(t.timestamp); 
            const tMonthStr = `${tDate.getFullYear()}-${tDate.getMonth() + 1}`; 
            if (tMonthStr === currentMonthStr) { 
                monthTransactions.push(t); 
                if (t.type === 'recharge' || t.type === 'income' || t.type === 'transfer_received' || t.type === 'transfer_refund') {
                    monthIncome += parseFloat(t.amount);
                } else if (t.type === 'transfer_sent' || t.type === 'expense') {
                    monthExpense += parseFloat(t.amount); 
                }
            } 
        }); 
        document.getElementById('wallet-month-income').innerText = monthIncome.toFixed(2); 
        document.getElementById('wallet-month-expense').innerText = monthExpense.toFixed(2); 
        const listContainer = document.getElementById('wallet-transaction-list'); 
        listContainer.innerHTML = ''; 
        if (monthTransactions.length === 0) { 
            listContainer.innerHTML = '<div class="wallet-empty">本月暂无收支记录</div>'; 
        } else { 
            monthTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(t => { 
                const item = document.createElement('div'); 
                item.className = 'wallet-item'; 
                const dateObj = new Date(t.timestamp); 
                const dateStr = `${dateObj.getMonth()+1}-${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`; 
                
                let icon = '💰';
                let typeClass = '';
                let sign = '';
                
                switch(t.type) {
                    case 'recharge': icon = '💳'; typeClass = 'in'; sign = '+'; break;
                    case 'transfer_sent': icon = '💸'; typeClass = 'out'; sign = '-'; break;
                    case 'transfer_received': icon = '🧧'; typeClass = 'in'; sign = '+'; break;
                    case 'transfer_refund': icon = '↩️'; typeClass = 'in'; sign = '+'; break; 
                    case 'income': icon = '🧧'; typeClass = 'in'; sign = '+'; break;
                    case 'expense': icon = '🛍️'; typeClass = 'out'; sign = '-'; break;
                }

                item.innerHTML = `<div class="wallet-item-icon">${icon}</div><div class="wallet-item-info"><div class="wallet-item-cat">${escapeHtml(t.desc || t.type)}</div><div class="wallet-item-date">${dateStr}</div></div><div class="wallet-item-amount ${typeClass}">${sign}${parseFloat(t.amount).toFixed(2)}</div>`; 
                listContainer.appendChild(item); 
            }); 
        } 
    }

    window.openWalletModal = (type) => { 
        currentWalletType = type; 
        document.getElementById('wallet-amount-input').value = ''; 
        const modal = document.getElementById('wallet-add-modal');
        modal.querySelector('.wallet-modal-title').textContent = (type === 'recharge') ? '充值' : '记一笔';
        modal.querySelector('.wallet-confirm-btn').textContent = (type === 'recharge') ? '确认充值' : '确认';
        
        modal.classList.add('active'); 
    };
    
    window.closeWalletModal = () => { document.getElementById('wallet-add-modal').classList.remove('active'); };

    window.saveRecharge = () => { 
        const amountStr = document.getElementById('wallet-amount-input').value; 
        const amount = parseFloat(amountStr); 
        if (isNaN(amount) || amount <= 0) { 
            showToast('请输入有效金额'); return; 
        } 
        const data = getWalletData(); 
        const transaction = { 
            id: Date.now(), 
            type: 'recharge', 
            amount: amount, 
            desc: '充值', 
            timestamp: Date.now() 
        }; 
        data.transactions.push(transaction); 
        data.balance = parseFloat(data.balance) + amount; 
        saveWalletData(data); 
        closeWalletModal(); 
        loadWalletUI(); 
        showToast('充值成功'); 
    };

    // --- Friend Adding & Chat List Logic ---
    window.openAddFriendModal = () => { tempAvatarUrl = ""; document.getElementById('new-friend-name').value = ""; document.getElementById('new-friend-alias').value = ""; document.getElementById('new-friend-avatar-url').value = ""; const preview = document.getElementById('new-friend-avatar-preview'); preview.style.display = 'none'; preview.src = ""; document.getElementById('avatar-placeholder-icon').style.display = 'block'; document.getElementById('add-friend-modal').classList.add('active'); };
    window.closeAddFriendModal = () => { document.getElementById('add-friend-modal').classList.remove('active'); };
    window.triggerAvatarUpload = () => { document.getElementById('input-friend-avatar').click(); };
    window.handleAvatarUrlInput = (input) => { const url = input.value.trim(); const imgEl = document.getElementById('new-friend-avatar-preview'); if (url) { tempAvatarUrl = url; imgEl.src = url; imgEl.style.display = 'block'; document.getElementById('avatar-placeholder-icon').style.display = 'none'; } else { tempAvatarUrl = ""; imgEl.style.display = 'none'; document.getElementById('avatar-placeholder-icon').style.display = 'block'; } };
    window.handleFriendAvatarUpload = (event) => { compressImage(event.target.files[0], 200, (base64) => { tempAvatarUrl = base64; document.getElementById('new-friend-avatar-url').value = ""; const imgEl = document.getElementById('new-friend-avatar-preview'); imgEl.src = tempAvatarUrl; imgEl.style.display = 'block'; document.getElementById('avatar-placeholder-icon').style.display = 'none'; }); };
    window.saveNewFriend = () => { const name = document.getElementById('new-friend-name').value.trim(); const alias = document.getElementById('new-friend-alias').value.trim(); if (!name) { showToast("请输入姓名"); return; } if (!tempAvatarUrl) { showToast("请上传头像或输入URL"); return; } let contacts = []; try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } if (contacts.find(c => c.name === name || (alias && c.alias === alias))) { showToast("该好友已存在"); return; } const newContact = { id: Date.now(), name: name, alias: alias, avatar: tempAvatarUrl, lastMsg: "点击开始聊天", timestamp: Date.now(), signature: "", backgroundImage: "", isPinned: false, worldbookIds: [], timePerceptionEnabled: false, memoryDepth: 15, autoPostEnabled: false, autoPostInterval: 60 }; contacts.unshift(newContact); try { localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); showToast("添加成功！"); closeAddFriendModal(); renderChatList(); renderContactList(); } catch (e) { console.error("Error saving contact:", e); showToast("保存失败，图片可能过大"); } };

    window.renderChatList = () => { 
        const container = document.getElementById('chat-list-container'); 
        let contacts = []; 
        try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } 
        
        if (contacts.length === 0) { 
            container.innerHTML = '<div class="chat-placeholder-text">没有新信息</div>'; 
            return; 
        } 
        
        container.innerHTML = ''; 
        contacts.sort((a, b) => b.timestamp - a.timestamp).forEach(contact => { 
            const displayName = contact.alias || contact.name; 
            const item = document.createElement('div'); 
            item.className = 'chat-list-item'; 
            item.onclick = (e) => { e.stopPropagation(); openChatWindow(contact.id); }; 
            item.innerHTML = `<img src="${contact.avatar}" class="chat-list-avatar" alt="avatar" onerror="this.src='https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'"><div class="chat-list-info"><div class="chat-list-name">${escapeHtml(displayName)}</div><div class="chat-list-msg">${escapeHtml(contact.lastMsg || '点击开始聊天')}</div></div>`; 
            container.appendChild(item); 
        }); 
    };
    
    function getSortLetter(str) { if (!str) return '#'; const firstChar = str.charAt(0); if (/[a-zA-Z]/.test(firstChar)) return firstChar.toUpperCase(); const pinyin = "ABCDEFGHJKLMNOPQRSTWXYZ"; const zh = "阿芭擦搭蛾发噶哈击喀垃妈拿哦啪期然撒塌挖昔压匝"; if (firstChar.localeCompare('阿', 'zh-CN') < 0) return '#'; if (firstChar.localeCompare('匝', 'zh-CN') >= 0) return 'Z'; for (let i = 0; i < zh.length; i++) { if (firstChar.localeCompare(zh[i], 'zh-CN') >= 0 && firstChar.localeCompare(zh[i+1], 'zh-CN') < 0) return pinyin[i]; } return '#'; }
    
    window.renderContactList = () => { 
        const container = document.getElementById('contact-list-container'); 
        const indexBar = document.getElementById('alpha-index-bar'); 
        let contacts = []; 
        try { contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); } catch (e) { contacts = []; } 
        
        if (contacts.length === 0) { 
            container.innerHTML = '<div class="chat-placeholder-text">通讯录为空</div>'; 
            indexBar.innerHTML = ''; 
            return; 
        } 
        
        container.innerHTML = ''; 
        indexBar.innerHTML = ''; 
        const groups = { '🔝': [], ...'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('').reduce((acc, l) => ({...acc, [l]: []}), {}) }; 
        contacts.forEach(c => { if (c.isPinned) { groups['🔝'].push(c); } else { const letter = getSortLetter(c.alias || c.name); (groups[letter] || groups['#']).push(c); } }); 
        const activeLetters = []; 
        
        const renderGroup = (key, title) => { 
            const groupContacts = groups[key]; 
            if (groupContacts.length > 0) { 
                groupContacts.sort((a, b) => (a.alias||a.name).localeCompare(b.alias||b.name, 'zh-CN')); 
                const titleDiv = document.createElement('div'); 
                titleDiv.className = 'contact-section-title'; 
                titleDiv.id = `group-${key}`; 
                titleDiv.innerText = title; 
                container.appendChild(titleDiv); 
                activeLetters.push({ key: key, id: `group-${key}` }); 
                groupContacts.forEach(contact => container.appendChild(createContactItem(contact))); 
            } 
        }; 
        
        renderGroup('🔝', '🔝'); 
        'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('').forEach(key => renderGroup(key, key)); 
        'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => { 
                  const exists = activeLetters.find(x => x.key === letter); 
            const item = document.createElement('div'); 
            item.className = 'alpha-index-item'; 
            item.innerText = letter; 
            if (exists) { 
                item.onclick = (e) => { e.stopPropagation(); document.getElementById(exists.id).scrollIntoView({ behavior: 'smooth' }); }; 
                item.style.color = '#555'; 
            } else { 
                item.style.color = '#eee'; 
                item.onclick = (e) => e.stopPropagation(); 
            } 
            indexBar.appendChild(item); 
        }); 
    };

    function createContactItem(contact) { 
        const item = document.createElement('div'); 
        item.className = 'contact-item'; 
        if(contact.isPinned) item.classList.add('pinned'); 
        const displayName = contact.alias || contact.name; 
        const signature = contact.signature ? escapeHtml(contact.signature) : ''; 
        item.innerHTML = `<img src="${contact.avatar}" class="contact-avatar"><div class="chat-list-info"><div class="contact-name">${escapeHtml(displayName)}</div><div class="contact-signature">${signature}</div></div><div class="pinned-tag">★</div>`; 
        item.onclick = () => { currentChatContactId = contact.id; openRoleSettings(); }; 
        let pressTimer; 
        item.addEventListener('touchstart', (e) => { pressTimer = setTimeout(() => { toggleContactPin(contact.id); }, 600); }); 
        item.addEventListener('touchend', () => clearTimeout(pressTimer)); 
        item.addEventListener('touchmove', () => clearTimeout(pressTimer)); 
        return item; 
    }

    window.toggleContactPin = (id) => { let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const idx = contacts.findIndex(c => c.id === id); if (idx !== -1) { contacts[idx].isPinned = !contacts[idx].isPinned; localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); renderContactList(); showToast(contacts[idx].isPinned ? "已置顶" : "已取消置顶"); } };

    // --- Role Chat Conversation & Transfer Logic ---
    window.openChatWindow = (contactId) => { 
        currentChatContactId = contactId; 
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); 
        const contact = contacts.find(c => c.id === contactId); 
        if (!contact) return; 
        document.getElementById('chat-conv-title').innerText = contact.alias || contact.name; 
        document.getElementById('chat-conv-signature').innerText = contact.signature || ''; 
        const view = document.getElementById('chat-conversation-view'); 
        view.style.backgroundImage = contact.backgroundImage ? `url(${contact.backgroundImage})` : ''; 
        let styleTag = document.getElementById('custom-chat-style'); 
        if (!styleTag) { styleTag = document.createElement('style'); styleTag.id = 'custom-chat-style'; document.head.appendChild(styleTag); } 
        styleTag.innerHTML = contact.customCss || ''; 
        
        isMultiSelectMode = false;
        selectedMsgIds.clear();
        document.getElementById('chat-multiselect-footer').classList.remove('active');
        document.getElementById('chat-conv-messages').classList.remove('multi-select-active');
        
        view.classList.add('active'); 
        renderConversationMessages(); 
    };
    
    window.closeChatConversation = () => { document.getElementById('chat-conversation-view').classList.remove('active'); currentChatContactId = null; const styleTag = document.getElementById('custom-chat-style'); if (styleTag) styleTag.innerHTML = ''; renderChatList(); };
    function getMessagesKey(contactId) { return `chat_msgs_${contactId}`; }
    
    function formatChatTime(ts) {
        const now = new Date();
        const date = new Date(ts);
        const diff = now - date;
        const diffHours = diff / 3600000;
        
        const pad = n => n.toString().padStart(2, '0');
        const timeStr = `${pad(date.getHours())}:${pad(date.getMinutes())}`;
        const dateStr = `${date.getMonth() + 1}月${date.getDate()}`;
        
        if (now.toDateString() === date.toDateString()) {
            return timeStr;
        }
        
        if (diffHours >= 24 && diffHours < 48) {
             return `昨天 ${timeStr}`;
        }
        
        const oneMonth = 30 * 24 * 60 * 60 * 1000;
        if (diff >= oneMonth) {
            const weeks = ['日', '一', '二', '三', '四', '五', '六'];
            return `${dateStr} 星期${weeks[date.getDay()]}`;
        }
        
        return `${dateStr} ${timeStr}`;
    }

    window.renderConversationMessages = () => {
        if (!currentChatContactId) return;
        const container = document.getElementById('chat-conv-messages');
        const key = getMessagesKey(currentChatContactId);
        let messages = []; try { messages = JSON.parse(localStorage.getItem(key) || '[]'); } catch (e) { }
        container.innerHTML = '';

        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        const themAvatar = contact ? contact.avatar : '';
        const globalProfile = getUserProfile();
        const meAvatar = (contact && contact.userAvatar) ? contact.userAvatar : (globalProfile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png');

        let lastMsgTime = 0;

        const fragment = document.createDocumentFragment();

        messages.forEach(msg => {
            if (msg.timestamp - lastMsgTime > 5 * 60 * 1000) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'chat-time-stamp';
                timeDiv.innerText = formatChatTime(msg.timestamp);
                fragment.appendChild(timeDiv);
                lastMsgTime = msg.timestamp;
            }

            if (msg.type === 'recalled') {
                const tipDiv = document.createElement('div');
                tipDiv.className = 'msg-recalled-tip';
                tipDiv.innerText = msg.text;
                fragment.appendChild(tipDiv);
                return;
            }

            const row = document.createElement('div');
            row.className = `msg-bubble-row ${msg.type === 'sent' ? 'me' : 'them'}`;
            row.id = `msg-${msg.id}`; 

            const checkbox = document.createElement('div');
            checkbox.className = `chat-checkbox ${selectedMsgIds.has(msg.id) ? 'checked' : ''}`;
            checkbox.onclick = (e) => { e.stopPropagation(); toggleMsgSelection(msg.id); };
            
            const avatar = document.createElement('img');
            avatar.src = msg.type === 'sent' ? meAvatar : themAvatar;
            avatar.className = 'msg-bubble-avatar';

            let contentHtml;
            if (msg.isTransfer) {
                contentHtml = createTransferCard(msg);
            } else {
                contentHtml = `<div class="msg-bubble-content">${escapeHtml(msg.text)}</div>`;
            }
            
            const contentElement = document.createRange().createContextualFragment(contentHtml).firstElementChild;
            contentElement.ondblclick = (e) => { 
                e.stopPropagation(); 
                showBubbleMenu(e, msg.id, msg.text, msg.type, msg.isTransfer); 
            };
            
            if (isMultiSelectMode) {
                row.onclick = (e) => { e.stopPropagation(); toggleMsgSelection(msg.id); };
            }
            
            row.appendChild(checkbox);
            if (msg.type === 'sent') {
                row.appendChild(contentElement);
                row.appendChild(avatar);
            } else {
                row.appendChild(avatar);
                row.appendChild(contentElement);
            }
            
            fragment.appendChild(row);
        });

        container.appendChild(fragment);
        
        if (isMultiSelectMode) container.classList.add('multi-select-active');
        else container.classList.remove('multi-select-active');
        
        if (!isMultiSelectMode) {
            container.scrollTop = container.scrollHeight;
        }
    };


    function createTransferCard(msg) {
        const { amount, transferStatus, id } = msg.transferData;
        const formattedAmount = parseFloat(amount).toFixed(2);
        
        let bgColor, statusText, iconUrl, clickHandler = '', mainText = '';
        
        const receiverName = msg.transferData.receiverName || '对方';
        
        if (msg.type === 'sent') { 
            mainText = `转账给 ${escapeHtml(receiverName)}`;
            switch(transferStatus) {
                case 'pending':
                    bgColor = '#fd9806'; statusText = '待收款';
                    iconUrl = 'https://img.heliar.top/file/1770723126205_兑换4_exchange-four.png'; break;
                case 'accepted':
                    bgColor = '#fdddaf'; statusText = '对方已收钱';
                    iconUrl = 'https://img.heliar.top/file/1770726823712_校验_check-one.png'; break; 
                case 'rejected':
                    bgColor = '#fdddaf'; statusText = '对方已退还';
                    iconUrl = 'https://img.heliar.top/file/1770726817049_向下左角_corner-down-left.png'; break;
            }
                } else { 
            mainText = '转账给你';
            switch(transferStatus) {
                case 'pending': 
                    bgColor = '#fd9806'; statusText = '待收款';
                    iconUrl = 'https://img.heliar.top/file/1770723126205_兑换4_exchange-four.png';
                    clickHandler = `onclick="openReceiveTransferModal('${id}')" style="cursor: pointer;"`;
                    break;
                case 'accepted': 
                    bgColor = '#fdddaf'; statusText = '已收款';
                    iconUrl = 'https://img.heliar.top/file/1770726823712_校验_check-one.png'; break; 
                
                case 'rejected':
                    bgColor = '#fdddaf'; statusText = '已退还';
                    iconUrl = 'https://img.heliar.top/file/1770726817049_向下左角_corner-down-left.png'; break;
            }
        }

        return `
            <div class="transfer-message-card" style="background-color: ${bgColor};" ${clickHandler} data-transfer-id="${id}">
                <div class="transfer-main">
                    <img src="${iconUrl}" class="transfer-icon">
                    <div class="transfer-details">
                        <div class="transfer-status">${mainText}</div>
                        <div class="transfer-amount">¥${formattedAmount}</div>
                    </div>
                </div>
                <div class="transfer-footer-text">${statusText}</div>
            </div>
        `;
    }

    window.openReceiveTransferModal = (transferId) => {
        if (!currentChatContactId) return;

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const msgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(transferId));

        if (msgIndex === -1 || messages[msgIndex].transferData.transferStatus !== 'pending') {
            showToast("该转账已被处理");
            return;
        }

        const msg = messages[msgIndex];
        const amount = parseFloat(msg.transferData.amount);
        const timestamp = msg.timestamp;

        currentReceivingTransferId = transferId;

        const date = new Date(timestamp);
        const pad = n => String(n).padStart(2, '0');
        const formattedTime = `${date.getFullYear()}年${pad(date.getMonth() + 1)}月${pad(date.getDate())}日 ${pad(date.getHours())}:${pad(date.getMinutes())}`;

        document.getElementById('receive-transfer-amount').textContent = `¥${amount.toFixed(2)}`;
        document.getElementById('receive-transfer-time').textContent = formattedTime;

        const overlay = document.getElementById('receive-transfer-overlay');
        overlay.classList.add('active');
    };
    
    window.closeReceiveTransferModal = () => {
        const overlay = document.getElementById('receive-transfer-overlay');
        overlay.classList.remove('active');
        currentReceivingTransferId = null;
    };
    
    window.rejectReceiveTransfer = () => {
        if (!currentChatContactId || !currentReceivingTransferId) return;

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const msgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(currentReceivingTransferId));

        if (msgIndex === -1) return;

        const msg = messages[msgIndex];
        
        msg.transferData.transferStatus = 'rejected';
        localStorage.setItem(key, JSON.stringify(messages));
        
        showToast(`已退还转账`);
        closeReceiveTransferModal();
        renderConversationMessages();
    };

    window.confirmReceiveTransfer = () => {
        if (!currentChatContactId || !currentReceivingTransferId) return;

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const msgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(currentReceivingTransferId));

        if (msgIndex === -1) return;

        const msg = messages[msgIndex];
        const amount = parseFloat(msg.transferData.amount);

        msg.transferData.transferStatus = 'accepted';
        localStorage.setItem(key, JSON.stringify(messages));
        
        let walletData = getWalletData();
        walletData.balance += amount;
        walletData.transactions.push({
            id: Date.now(),
            type: 'transfer_received',
            amount: amount,
            desc: `收到来自 ${msg.transferData.senderName} 的转账`,
            timestamp: Date.now()
        });
        saveWalletData(walletData);

        showToast(`已收款 ¥${amount.toFixed(2)}`);
        closeReceiveTransferModal();
        renderConversationMessages();
    };
    
    function handleTransferResponse(transferId, isAccepted) {
        if (!currentChatContactId) return;
        
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        
        const sentMsgIndex = messages.findIndex(m => m.isTransfer && String(m.transferData.id) === String(transferId) && m.type === 'sent');

        if (sentMsgIndex === -1) return;

        const sentMsg = messages[sentMsgIndex];
        const amount = parseFloat(sentMsg.transferData.amount);
        const receiverName = sentMsg.transferData.receiverName;
        
        if (isAccepted) {
            sentMsg.transferData.transferStatus = 'accepted';

        } else {
            sentMsg.transferData.transferStatus = 'rejected';
            
            let walletData = getWalletData();
            walletData.balance += amount;
            walletData.transactions.push({
                id: Date.now(),
                type: 'transfer_refund',
                amount: amount,
                desc: `来自 ${receiverName} 的转账退款`,
                timestamp: Date.now()
            });
            saveWalletData(walletData);
            showToast(`¥${amount.toFixed(2)} 已退回至零钱`);
        }
        
        localStorage.setItem(key, JSON.stringify(messages));
        renderConversationMessages();
    }
    
    window.showBubbleMenu = (event, msgId, text, type, isTransfer) => {
        event.preventDefault();
        event.stopPropagation();
        closeBubbleMenu(); 
        
        activeMsgIdForMenu = msgId;
        
        const menu = document.createElement('div');
        menu.className = 'bubble-context-menu';
        
        const recallOption = (type === 'sent') ? `<div class="bubble-menu-item" onclick="event.stopPropagation(); handleRecallMsg('${msgId}')">撤回</div>` : '';
        const editOption = isTransfer 
                        ? `<div class="bubble-menu-item" style="color:#ccc; cursor:not-allowed;">编辑</div>`
            : `<div class="bubble-menu-item" onclick="event.stopPropagation(); handleEditMsg('${msgId}', '${escapeHtml(text).replace(/'/g, "\\'")}')">编辑</div>`;
            
        const multiSelectOption = `<div class="bubble-menu-item" onclick="event.stopPropagation(); toggleMultiSelectMode()">多选</div>`;
        const deleteOption = `<div class="bubble-menu-item" style="color:#F44336;" onclick="event.stopPropagation(); deleteMsg('${msgId}')">删除</div>`;

        menu.innerHTML = recallOption + editOption + multiSelectOption + deleteOption;
        
        document.body.appendChild(menu);
        
        const rect = event.target.getBoundingClientRect();
        let top = rect.top - menu.offsetHeight - 10;
        if (top < 0) top = rect.bottom + 10;
        let left = event.clientX - (menu.offsetWidth / 2);
        if (left < 10) left = 10;
        if (left + menu.offsetWidth > window.innerWidth - 10) left = window.innerWidth - menu.offsetWidth - 10;
        
        menu.style.top = top + 'px';
        menu.style.left = left + 'px';
        menu.classList.add('active');
    };

    window.closeBubbleMenu = () => {
        document.querySelectorAll('.bubble-context-menu').forEach(el => el.remove());
        activeMsgIdForMenu = null;
    };

    window.handleEditMsg = (msgId, oldText) => {
        closeBubbleMenu();
        const newText = prompt("编辑消息:", oldText);
        if (newText !== null && newText.trim() !== "") {
            const key = getMessagesKey(currentChatContactId);
            let messages = JSON.parse(localStorage.getItem(key) || '[]');
            const msgIndex = messages.findIndex(m => String(m.id) === String(msgId));
            if (msgIndex !== -1) {
                messages[msgIndex].text = newText.trim();
                localStorage.setItem(key, JSON.stringify(messages));
                renderConversationMessages();
            }
        }
    };

    window.handleRecallMsg = (msgId) => {
        closeBubbleMenu();
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        const msgIndex = messages.findIndex(m => String(m.id) === String(msgId));
        if (msgIndex !== -1 && messages[msgIndex].type === 'sent' && !messages[msgIndex].isTransfer) {
            messages[msgIndex].type = 'recalled';
            messages[msgIndex].text = "你撤回了一条消息";
            localStorage.setItem(key, JSON.stringify(messages));
            renderConversationMessages();
        } else {
            showToast("只能撤回普通发送的消息");
        }
    };

    window.deleteMsg = (msgId) => {
        closeBubbleMenu();
        if (confirm("确定要删除这条消息吗？")) {
            const key = getMessagesKey(currentChatContactId);
            let messages = JSON.parse(localStorage.getItem(key) || '[]');
            messages = messages.filter(m => String(m.id) !== String(msgId));
            localStorage.setItem(key, JSON.stringify(messages));
            renderConversationMessages();
        }
    };

    window.toggleMultiSelectMode = () => {
        closeBubbleMenu();
        isMultiSelectMode = true;
        selectedMsgIds.clear();
        if(activeMsgIdForMenu) selectedMsgIds.add(activeMsgIdForMenu);
        document.getElementById('chat-multiselect-footer').classList.add('active');
        renderConversationMessages();
    };

    window.toggleMsgSelection = (msgId) => {
        if (!isMultiSelectMode) return;
        if (selectedMsgIds.has(msgId)) {
            selectedMsgIds.delete(msgId);
        } else {
            selectedMsgIds.add(msgId);
        }
        renderConversationMessages();
    };

    window.executeBatchDelete = () => {
        if (selectedMsgIds.size === 0) {
            showToast("请先选择消息");
            return;
        }
        if (confirm(`确定要删除选中的 ${selectedMsgIds.size} 条消息吗？`)) {
            const key = getMessagesKey(currentChatContactId);
            let messages = JSON.parse(localStorage.getItem(key) || '[]');
            messages = messages.filter(m => !selectedMsgIds.has(m.id));
            localStorage.setItem(key, JSON.stringify(messages));
            
            isMultiSelectMode = false;
            selectedMsgIds.clear();
            document.getElementById('chat-multiselect-footer').classList.remove('active');
            renderConversationMessages();
            showToast("批量删除成功");
        }
    };

    window.toggleChatExtraMenu = () => {
        const menu = document.getElementById('chat-extra-menu');
        menu.classList.toggle('active');
    };

    window.handleChatInputKey = (e) => {
        if (e.key === 'Enter') {
            sendMsg();
        }
    };

    function sendMsg() {
        if (!currentChatContactId) return;
        const input = document.getElementById('chat-conv-input');
        const text = input.value.trim();
        if (!text) return;
        
        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        messages.push({
            id: Date.now(),
            type: 'sent',
            text: text,
            timestamp: Date.now()
        });
        localStorage.setItem(key, JSON.stringify(messages));
        
        let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const idx = contacts.findIndex(c => c.id === currentChatContactId);
        if (idx > -1) {
            contacts[idx].lastMsg = text;
            contacts[idx].timestamp = Date.now();
            localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts));
        }
        
        input.value = '';
        renderConversationMessages();
    }

    // --- Transfer Functions ---
    window.openTransferPage = () => {
        if (!currentChatContactId) return;
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        if (!contact) return;
        
        document.getElementById('transfer-target-avatar').src = contact.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png';
        document.getElementById('transfer-target-name-container').textContent = `转账给 ${escapeHtml(contact.alias || contact.name)}`;
        document.getElementById('transfer-amount-input').value = '';
        
        document.getElementById('transfer-page').classList.add('active');
        document.getElementById('chat-extra-menu').classList.remove('active');
    };

    window.closeTransferPage = () => {
        document.getElementById('transfer-page').classList.remove('active');
    };

    window.checkTransferAmount = (input) => {
        let val = input.value;
        if (val.indexOf('.') > -1) {
            const parts = val.split('.');
            if (parts[1].length > 2) input.value = parseFloat(val).toFixed(2);
        }
    };

    window.handleTransferInputKey = (e) => {
        if (e.key === 'Enter') {
            const amount = parseFloat(document.getElementById('transfer-amount-input').value);
            if (isNaN(amount) || amount <= 0) {
                showToast("请输入正确的金额");
                return;
            }
            const walletData = getWalletData();
            if (amount > walletData.balance) {
                showToast("余额不足");
                return;
            }
            openTransferConfirmPopup(amount);
        }
    };

            window.openTransferConfirmPopup = (amount) => {
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        document.getElementById('confirm-transfer-target').textContent = `向 ${escapeHtml(contact.alias || contact.name)} 转账`;
        document.getElementById('confirm-transfer-amount').textContent = `¥${amount.toFixed(2)}`;
        
        currentPasswordInput = '';
        updatePasswordDisplay();
        
        // 【修改】强制三个区域全部同时显示
        document.getElementById('payment-details-section').style.display = 'block';
        document.getElementById('password-input-section').style.display = 'block';
        document.getElementById('numeric-keypad').style.display = 'grid';
        
        const titleEl = document.getElementById('confirm-popup-title');
        titleEl.textContent = '确认付款';
        titleEl.style.color = '#333';
        
        // 【修改】在弹出的时候，直接就渲染键盘
        renderNumericKeypad();
        
        document.getElementById('transfer-confirm-overlay').classList.add('active');
    };

    window.closeTransferConfirmPopup = () => {
        document.getElementById('transfer-confirm-overlay').classList.remove('active');
    };

    // 此函数已被停用，留空避免其他地方报错
    function showPasswordInputForTransfer() {
        // 功能已经合并到 openTransferConfirmPopup 中，无需再隐藏顶部内容
    }

        function renderNumericKeypad() {
        const keypad = document.getElementById('numeric-keypad');
        keypad.innerHTML = '';
        const keys = ['1','2','3','4','5','6','7','8','9','','0','del'];
        keys.forEach(key => {
            const btn = document.createElement('div');
            btn.className = 'keypad-btn';
            if (key === '') {
                btn.classList.add('blank'); // 修复：匹配CSS中的 .blank
            } else if (key === 'del') {
                btn.classList.add('delete'); // 修复：匹配CSS中的 .delete
                btn.innerHTML = '⌫';
                btn.onclick = () => {
                    if (currentPasswordInput.length > 0) {
                        currentPasswordInput = currentPasswordInput.slice(0, -1);
                        updatePasswordDisplay();
                    }
                };
            } else {
                btn.textContent = key;
                btn.onclick = () => {
                    if (currentPasswordInput.length < 6) {
                        currentPasswordInput += key;
                        updatePasswordDisplay();
                        if (currentPasswordInput.length === 6) verifyTransferPassword();
                    }
                };
            }
            keypad.appendChild(btn);
        });
    }

    function updatePasswordDisplay() {
        const boxes = document.getElementById('password-boxes').children;
        for (let i=0; i<6; i++) {
            if (i < currentPasswordInput.length) boxes[i].classList.add('filled');
            else boxes[i].classList.remove('filled');
        }
        document.getElementById('password-error-tip').textContent = '';
    }

    function verifyTransferPassword() {
        const profile = getUserProfile();
        const correctPw = profile.paymentPassword || '123456';
        if (currentPasswordInput === correctPw) {
            executeTransfer();
        } else {
            document.getElementById('password-error-tip').textContent = '密码错误，请重试';
            currentPasswordInput = '';
            updatePasswordDisplay();
        }
    }

    function executeTransfer() {
        const amount = parseFloat(document.getElementById('transfer-amount-input').value);
        
        let walletData = getWalletData();
        walletData.balance -= amount;
        
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        const myProfile = getUserProfile();

        const transferId = Date.now().toString();

        walletData.transactions.push({
            id: transferId,
            type: 'transfer_sent',
            amount: amount,
            desc: `转账给 ${contact.alias || contact.name}`,
            timestamp: Date.now()
        });
        saveWalletData(walletData);

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        
        messages.push({
            id: Date.now(),
            type: 'sent',
            isTransfer: true,
            transferData: {
                id: transferId,
                amount: amount,
                transferStatus: 'pending',
                senderName: myProfile.nickname || '我',
                receiverName: contact.alias || contact.name
            },
            timestamp: Date.now()
        });
        localStorage.setItem(key, JSON.stringify(messages));
        
        const idx = contacts.findIndex(c => c.id === currentChatContactId);
        if (idx > -1) {
            contacts[idx].lastMsg = `[转账] ¥${amount.toFixed(2)}`;
            contacts[idx].timestamp = Date.now();
            localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts));
        }

        closeTransferConfirmPopup();
        closeTransferPage();
        renderConversationMessages();
        showToast("转账成功");
        
        triggerAIAutoReply(true, amount, transferId);
    }

    // --- Role Settings & Styling ---
    window.openRoleSettings = () => {
        if (!currentChatContactId) return;
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        if (!contact) return;
        
        document.getElementById('role-setting-alias').value = contact.alias || '';
        document.getElementById('role-setting-signature').value = contact.signature || '';
        document.getElementById('role-setting-persona').value = contact.persona || '';
        document.getElementById('role-setting-avatar').src = contact.avatar || '';
        document.getElementById('role-bg-url-input').value = contact.backgroundImage || '';
        document.getElementById('role-bg-preview').style.backgroundImage = contact.backgroundImage ? `url(${contact.backgroundImage})` : '';
        tempRoleBgUrl = contact.backgroundImage || '';
        
        document.getElementById('role-time-perception-switch').checked = contact.timePerceptionEnabled || false;
        document.getElementById('role-memory-depth').value = contact.memoryDepth || 15;
        
        document.getElementById('role-auto-post-switch').checked = contact.autoPostEnabled || false;
        document.getElementById('role-auto-post-interval').value = contact.autoPostInterval || 60;
        
        const globalProfile = getUserProfile();
        document.getElementById('role-user-avatar').src = contact.userAvatar || globalProfile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png';
        document.getElementById('role-user-name').value = contact.userName || globalProfile.nickname || '';
        document.getElementById('role-user-persona').value = contact.userPersona || '';
        
        document.getElementById('role-setting-css').value = contact.customCss || '';
        loadCssPresets();

        const wbDisplay = document.getElementById('role-wb-display');
        const clearBtn = document.getElementById('role-wb-clear-btn');
        if (contact.worldbookIds && contact.worldbookIds.length > 0) {
            const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const names = contact.worldbookIds.map(id => {
                const b = worldbooks.find(b => b.id === id);
                return b ? b.title : '未知';
            });
            wbDisplay.textContent = `已绑定: ${names.join(', ')}`;
            wbDisplay.className = 'bound';
            clearBtn.style.display = 'block';
        } else {
            wbDisplay.textContent = '未绑定';
            wbDisplay.className = 'unbound';
            clearBtn.style.display = 'none';
        }
        
        document.getElementById('role-settings-page').classList.add('active');
    };

    window.closeRoleSettings = () => { document.getElementById('role-settings-page').classList.remove('active'); };

    window.saveRoleSettings = () => {
        if (!currentChatContactId) return;
        const alias = document.getElementById('role-setting-alias').value.trim();
        const signature = document.getElementById('role-setting-signature').value.trim();
        const persona = document.getElementById('role-setting-persona').value.trim();
        const timeEnabled = document.getElementById('role-time-perception-switch').checked;
        const memoryDepth = parseInt(document.getElementById('role-memory-depth').value) || 15;
        
        const uAvatar = document.getElementById('role-user-avatar').src;
        const uName = document.getElementById('role-user-name').value.trim();
        const uPersona = document.getElementById('role-user-persona').value.trim();
        
        const cssContent = document.getElementById('role-setting-css').value.trim();
        const autoPostEnabled = document.getElementById('role-auto-post-switch').checked;
        const autoPostInterval = parseInt(document.getElementById('role-auto-post-interval').value) || 60;

        let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const idx = contacts.findIndex(c => c.id === currentChatContactId);
        if (idx > -1) {
            contacts[idx].alias = alias;
            contacts[idx].signature = signature;
            contacts[idx].persona = persona;
            contacts[idx].backgroundImage = tempRoleBgUrl;
            contacts[idx].timePerceptionEnabled = timeEnabled;
            contacts[idx].memoryDepth = memoryDepth;
            
            contacts[idx].userAvatar = uAvatar;
            contacts[idx].userName = uName;
            contacts[idx].userPersona = uPersona;
            
            contacts[idx].customCss = cssContent;
            contacts[idx].autoPostEnabled = autoPostEnabled;
            contacts[idx].autoPostInterval = autoPostInterval;
            
            localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts));
            showToast("角色设置已保存");
            
            if (autoPostEnabled) { scheduleAutoPost(contacts[idx].id, autoPostInterval); } 
            else { stopAutoPost(contacts[idx].id); }

            closeRoleSettings();
            openChatWindow(currentChatContactId); 
            renderContactList(); 
        }
    };
    
    // --- CSS Preset Management ---
    function loadCssPresets() {
        const select = document.getElementById('css-preset-select');
        const actions = document.getElementById('css-preset-actions');
        let presets = {};
        try { presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '{}'); } catch(e) {}
        
        select.innerHTML = '<option value="">-- 选择预设样式 --</option>';
        Object.keys(presets).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });
        
        actions.style.display = 'none';
        select.value = "";
    }

    window.handlePresetSelection = (selectEl) => {
        const actions = document.getElementById('css-preset-actions');
        actions.style.display = selectEl.value ? 'flex' : 'none';
    };

    window.applySelectedCssPreset = () => {
        const select = document.getElementById('css-preset-select');
        const presetName = select.value;
        if(!presetName) return;
        let presets = {};
        try { presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '{}'); } catch(e) {}
        if(presets[presetName]) {
            document.getElementById('role-setting-css').value = presets[presetName];
            showToast(`已应用预设: ${presetName}`);
        }
    };

    window.deleteSelectedCssPreset = () => {
        const select = document.getElementById('css-preset-select');
        const presetName = select.value;
        if(!presetName) return;
        if(confirm(`确定删除预设 "${presetName}" 吗？`)) {
            let presets = {};
            try { presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '{}'); } catch(e) {}
            delete presets[presetName];
            localStorage.setItem(CSS_PRESETS_KEY, JSON.stringify(presets));
            loadCssPresets();
            showToast("预设已删除");
        }
    };

    window.openSaveCssPresetModal = () => {
        const cssContent = document.getElementById('role-setting-css').value.trim();
        if(!cssContent) { showToast("CSS内容为空，无法保存"); return; }
        document.getElementById('preset-name-input').value = '';
        document.getElementById('save-preset-modal').style.display = 'flex';
    };

    window.closeSaveCssPresetModal = () => {
        document.getElementById('save-preset-modal').style.display = 'none';
    };

    window.saveCurrentCssPreset = () => {
        const name = document.getElementById('preset-name-input').value.trim();
        const cssContent = document.getElementById('role-setting-css').value.trim();
        if(!name) { showToast("请输入预设名称"); return; }
        
        let presets = {};
        try { presets = JSON.parse(localStorage.getItem(CSS_PRESETS_KEY) || '{}'); } catch(e) {}
        presets[name] = cssContent;
        localStorage.setItem(CSS_PRESETS_KEY, JSON.stringify(presets));
        
        closeSaveCssPresetModal();
        loadCssPresets();
        document.getElementById('css-preset-select').value = name;
        document.getElementById('css-preset-actions').style.display = 'flex';
        showToast("预设保存成功");
    };

    // --- Role Binding logic ---
    window.openRoleWorldBookBindModal = () => {
        wbBindMultiSelect = true;
        document.getElementById('wb-bind-modal-title').textContent = '选择绑定的世界书';
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contact = contacts.find(c => c.id === currentChatContactId);
        tempSelectedWorldBookIds = contact.worldbookIds ? [...contact.worldbookIds] : [];
        
        wbBindCallback = (selectedIds) => {
            const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
            const idx = contacts.findIndex(c => c.id === currentChatContactId);
            if (idx > -1) {
                contacts[idx].worldbookIds = selectedIds;
                localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts));
                const wbDisplay = document.getElementById('role-wb-display');
                const clearBtn = document.getElementById('role-wb-clear-btn');
                if (selectedIds.length > 0) {
                    const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
                    const names = selectedIds.map(id => { const b = worldbooks.find(b => b.id === id); return b ? b.title : '未知'; });
                    wbDisplay.textContent = `已绑定: ${names.join(', ')}`;
                    wbDisplay.className = 'bound';
                    clearBtn.style.display = 'block';
                } else {
                    wbDisplay.textContent = '未绑定';
                    wbDisplay.className = 'unbound';
                    clearBtn.style.display = 'none';
                }
            }
        };
        openWorldBookBindModal('worldbook');
    };

    window.openWorldBookBindModal = (type = 'worldbook') => {
        const listContainer = document.getElementById('worldbook-bind-list');
        listContainer.innerHTML = '';
        
        if (type === 'worldbook') {
            const worldbooks = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            if (worldbooks.length === 0) { listContainer.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">暂无世界书</div>'; }
            worldbooks.forEach(wb => {
                const item = document.createElement('div');
                item.className = 'wb-bind-item';
                const isSelected = wbBindMultiSelect ? (tempSelectedWorldBookIds && tempSelectedWorldBookIds.includes(wb.id)) : false;
                if (isSelected) item.classList.add('selected');
                item.innerText = wb.title;
                item.onclick = () => {
                    if (wbBindMultiSelect) {
                        if (item.classList.contains('selected')) {
                            item.classList.remove('selected');
                            tempSelectedWorldBookIds = tempSelectedWorldBookIds.filter(id => id !== wb.id);
                        } else {
                            item.classList.add('selected');
                            tempSelectedWorldBookIds.push(wb.id);
                        }
                    } else {
                        document.querySelectorAll('.wb-bind-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        currentWorldBookId = wb.id;
                    }
                };
                listContainer.appendChild(item);
            });
        } else if (type === 'roles') {
            const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
            if (contacts.length === 0) { listContainer.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">暂无角色</div>'; }
            let tempSelectedRoles = [];
            if(wbBindCallback && wbBindCallback.name === 'wbBindCallback') { 
                 if(document.getElementById('wb-bind-modal-title').textContent.includes('论坛')) tempSelectedRoles = tempForumBoundRoleIds;
                 else if (document.getElementById('wb-bind-modal-title').textContent.includes('种类')) tempSelectedRoles = tempMallCategoryRoleIds;
            }

            contacts.forEach(c => {
                const item = document.createElement('div');
                item.className = 'wb-bind-item';
                if (tempSelectedRoles.includes(c.id)) item.classList.add('selected');
                item.innerText = c.alias || c.name;
                item.onclick = () => {
                    if (item.classList.contains('selected')) {
                        item.classList.remove('selected');
                        tempSelectedRoles = tempSelectedRoles.filter(id => id !== c.id);
                    } else {
                        item.classList.add('selected');
                        tempSelectedRoles.push(c.id);
                    }
                };
                listContainer.appendChild(item);
            });
            tempSelectedWorldBookIds = tempSelectedRoles; 
        }

        document.getElementById('worldbook-bind-modal').classList.add('active');
    };

    window.closeWorldBookBindModal = () => { document.getElementById('worldbook-bind-modal').classList.remove('active'); };
    window.confirmWbBinding = () => {
        if (wbBindCallback) {
            wbBindCallback(wbBindMultiSelect ? tempSelectedWorldBookIds : currentWorldBookId);
        }
        closeWorldBookBindModal();
    };

    window.clearWorldBookBinding = () => {
        const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const idx = contacts.findIndex(c => c.id === currentChatContactId);
        if (idx > -1) {
            contacts[idx].worldbookIds = [];
            localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts));
            const wbDisplay = document.getElementById('role-wb-display');
            wbDisplay.textContent = '未绑定';
            wbDisplay.className = 'unbound';
            document.getElementById('role-wb-clear-btn').style.display = 'none';
            showToast('已清除世界书绑定');
        }
    };
    
    window.triggerRoleBgUpload = () => { document.getElementById('input-role-chat-bg').click(); };
    window.handleRoleChatBgUpload = (event) => { compressImage(event.target.files[0], 800, (base64) => { tempRoleBgUrl = base64; document.getElementById('role-bg-url-input').value = ""; document.getElementById('role-bg-preview').style.backgroundImage = `url(${base64})`; }); };
    window.setRoleBgByUrl = () => { const url = document.getElementById('role-bg-url-input').value.trim(); if(url){ tempRoleBgUrl = url; document.getElementById('role-bg-preview').style.backgroundImage = `url(${url})`; showToast('已应用URL背景'); } };
    window.triggerRoleAvatarEdit = () => { const contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); const contact = contacts.find(c => c.id === currentChatContactId); if (!contact) return; const currentUrl = contact.avatar; const newUrl = prompt('请输入新的头像URL (或取消以保持不变)', currentUrl); if (newUrl !== null && newUrl.trim() !== '') { contact.avatar = newUrl.trim(); localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); document.getElementById('role-setting-avatar').src = newUrl.trim(); showToast('头像已更新'); } };
    window.triggerRoleUserAvatarEdit = () => { document.getElementById('input-role-user-avatar').click(); };
    window.handleRoleUserAvatarUpload = (event) => { compressImage(event.target.files[0], 200, (base64) => { document.getElementById('role-user-avatar').src = base64; }); };

    window.confirmDeleteFriend = () => { document.getElementById('delete-friend-confirm-modal').classList.add('active'); };
    window.executeDeleteFriend = () => { if (!currentChatContactId) return; let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]'); contacts = contacts.filter(c => c.id !== currentChatContactId); localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts)); localStorage.removeItem(getMessagesKey(currentChatContactId)); localStorage.removeItem(getRecollectionStorageKey(currentChatContactId)); stopAutoPost(currentChatContactId); closeDeleteModal('delete-friend-confirm-modal'); closeRoleSettings(); closeChatConversation(); currentChatContactId = null; showToast("好友及聊天记录已删除"); };
    window.closeDeleteModal = (modalId) => { document.getElementById(modalId).classList.remove('active'); };

    // --- User Profile Functions ---
    function getUserProfile() { try { const data = localStorage.getItem(USER_PROFILE_KEY); return data ? JSON.parse(data) : {}; } catch (e) { return {}; } }
    function saveUserProfile(profile) { localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profile)); }
    function loadUserProfile() { 
        const profile = getUserProfile(); 
        document.getElementById('profile-avatar').src = profile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png'; 
        document.getElementById('profile-nickname').innerText = profile.nickname || 'User Name'; 
        document.getElementById('profile-qq-id').innerText = profile.qqId ? `QQ: ${profile.qqId}` : 'QQ: 20261314520'; 
        if (profile.cover) document.getElementById('profile-cover').style.backgroundImage = `url('${profile.cover}')`; 
        document.getElementById('profile-signature-text').innerText = profile.signature || '这个人很懒，什么都没留下~'; 
        document.getElementById('profile-like-count').innerText = profile.likes || '8888'; 
        
        const memberIconsList = profile.memberIcons || [];
        const containerRow = document.getElementById('me-member-icon-container');
        const mainIcon = document.getElementById('me-member-icon-main');
        
        containerRow.innerHTML = '';
        if (memberIconsList.length > 0 && memberIconsList[0]) {
            mainIcon.src = memberIconsList[0];
            mainIcon.style.display = 'block';
            memberIconsList.slice(1).forEach(iconUrl => {
                if(iconUrl) {
                    const img = document.createElement('img');
                    img.src = iconUrl;
                    img.className = 'me-member-icon-small';
                    containerRow.appendChild(img);
                }
            });
        } else {
            mainIcon.style.display = 'none';
        }
    }
    window.openMeSettings = () => { 
        const profile = getUserProfile();
        const momentsProfile = getMomentsProfile();
        document.getElementById('me-settings-nickname').value = profile.nickname || ''; 
        document.getElementById('me-settings-qq-id').value = profile.qqId || ''; 
        document.getElementById('me-settings-likes').value = profile.likes || ''; 
        document.getElementById('me-settings-avatar-url').value = profile.avatar || ''; 
        document.getElementById('me-settings-cover-url').value = profile.cover || ''; 
        document.getElementById('me-settings-payment-password').value = profile.paymentPassword || ''; 
        document.getElementById('me-settings-avatar-preview').src = profile.avatar || 'https://img.heliar.top/file/1770068438490_添加人群_people-plus.png';
        if (profile.cover) document.getElementById('me-settings-cover-preview').src = profile.cover;
        
        document.getElementById('me-settings-moments-avatar-url').value = momentsProfile.avatar;
        document.getElementById('me-settings-moments-cover-url').value = momentsProfile.cover;
        document.getElementById('me-settings-moments-avatar-preview').src = momentsProfile.avatar;
        document.getElementById('me-settings-moments-cover-preview').src = momentsProfile.cover;

        const iconsListContainer = document.getElementById('me-settings-member-icons-list');
        iconsListContainer.innerHTML = '';
        const memberIcons = profile.memberIcons || [];
        for(let i=0; i<8; i++) {
            const row = document.createElement('div');
            row.className = 'me-settings-row';
            row.style.marginTop = '5px';
            row.innerHTML = `<div class="me-settings-label">图标 ${i+1}</div><input type="text" class="me-settings-input member-icon-input" placeholder="输入图片 URL" value="${memberIcons[i] || ''}">`;
            iconsListContainer.appendChild(row);
        }

        document.getElementById('me-settings-modal').classList.add('active'); 
    };
    window.closeMeSettings = () => { document.getElementById('me-settings-modal').classList.remove('active'); };
    window.saveMeSettings = () => { 
        const profile = getUserProfile(); 
        const momentsProfile = getMomentsProfile();
        
        profile.nickname = document.getElementById('me-settings-nickname').value.trim(); 
        profile.qqId = document.getElementById('me-settings-qq-id').value.trim(); 
        profile.likes = document.getElementById('me-settings-likes').value.trim(); 
        
        const avatarUrl = document.getElementById('me-settings-avatar-url').value.trim();
        if (avatarUrl !== '（已上传本地图片）') profile.avatar = avatarUrl;
        
        profile.cover = document.getElementById('me-settings-cover-url').value.trim(); 
        const pw = document.getElementById('me-settings-payment-password').value.trim();
        if (pw && !/^\d{6}$/.test(pw)) { showToast("支付密码必须是6位数字"); return; }
        profile.paymentPassword = pw;
        
        const iconInputs = document.querySelectorAll('.member-icon-input');
        profile.memberIcons = Array.from(iconInputs).map(inp => inp.value.trim());

        saveUserProfile(profile); 
        
        const mAvatar = document.getElementById('me-settings-moments-avatar-url').value.trim();
        const mCover = document.getElementById('me-settings-moments-cover-url').value.trim();
        if (mAvatar !== '（已上传本地图片）') momentsProfile.avatar = mAvatar;
        if (mCover !== '（已上传本地图片）') momentsProfile.cover = mCover;
        saveMomentsProfile(momentsProfile);

        loadUserProfile(); 
        closeMeSettings(); 
        showToast('个人资料已保存'); 
    };
    window.incrementLikeCount = (e) => { e.stopPropagation(); const profile = getUserProfile(); let likes = parseInt(profile.likes) || 8888; profile.likes = likes + 1; saveUserProfile(profile); document.getElementById('profile-like-count').innerText = profile.likes; showToast('+1 赞', 1000); };
    window.editNickname = (e) => { e.stopPropagation(); const profile = getUserProfile(); const newName = prompt('修改昵称', profile.nickname || 'User Name'); if (newName !== null) { profile.nickname = newName.trim(); saveUserProfile(profile); loadUserProfile(); } };
    window.editQQID = (e) => { e.stopPropagation(); const profile = getUserProfile(); const newId = prompt('修改QQ号', profile.qqId || ''); if (newId !== null) { profile.qqId = newId.trim(); saveUserProfile(profile); loadUserProfile(); } };
    window.editSignature = () => { const profile = getUserProfile(); const newSig = prompt('修改个性签名', profile.signature || ''); if (newSig !== null) { profile.signature = newSig.trim(); saveUserProfile(profile); loadUserProfile(); } };
    window.triggerProfileAvatarUpload = () => { document.getElementById('input-profile-avatar').click(); };
    window.handleProfileAvatarUpload = (event) => { compressImage(event.target.files[0], 200, (base64) => { const settingsModalActive = document.getElementById('me-settings-modal').classList.contains('active'); if (settingsModalActive) { document.getElementById('me-settings-avatar-preview').src = base64; document.getElementById('me-settings-avatar-url').value = '（已上传本地图片）'; } else { const profile = getUserProfile(); profile.avatar = base64; saveUserProfile(profile); loadUserProfile(); showToast('头像已更新'); } }); };
    window.triggerMomentsAvatarUpload = () => { document.getElementById('input-moments-avatar').click(); };
    window.handleMomentsAvatarUpload = (event) => { compressImage(event.target.files[0], 200, (base64) => { document.getElementById('me-settings-moments-avatar-preview').src = base64; document.getElementById('me-settings-moments-avatar-url').value = '（已上传本地图片）'; }); };
    window.handleMomentsCoverUpload = (event) => { compressImage(event.target.files[0], 800, (base64) => { document.getElementById('me-settings-moments-cover-preview').src = base64; document.getElementById('me-settings-moments-cover-url').value = '（已上传本地图片）'; }); };


    // --- Global Settings & OS Features ---
        window.showSettingsPage = () => {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        document.getElementById('ios-mode-switch').checked = localStorage.getItem(IOS_MODE_KEY) === 'true';
        document.getElementById('phone-frame-switch').checked = localStorage.getItem(PHONE_FRAME_KEY) === 'true';
        document.getElementById('cat-ears-switch').checked = localStorage.getItem(CAT_EARS_KEY) === 'true';

        /* --- 新增的代码 --- */
        document.getElementById('icon-font-color-switch').checked = localStorage.getItem(ICON_FONT_LIGHT_MODE_KEY) === 'true';
        /* --- 新增结束 --- */
        
        document.getElementById('phone-case-color-input').value = localStorage.getItem(PHONE_CASE_COLOR_KEY) || '#ffffff';
        document.getElementById('cat-ear-color-input').value = localStorage.getItem(CAT_EAR_COLOR_KEY) || '#ffffff';
        
        if(settings.api) {
            document.getElementById('api-url-input').value = settings.api.url || '';
            document.getElementById('api-key-input').value = settings.api.key || '';
            document.getElementById('temp-slider').value = settings.api.temp || 0.8;
            document.getElementById('temp-value-display').innerText = settings.api.temp || 0.8;
            if(settings.api.model) {
                const sel = document.getElementById('model-select');
                sel.innerHTML = `<option value="${settings.api.model}">${settings.api.model}</option>`;
                sel.value = settings.api.model;
                document.getElementById('model-select-wrapper').style.display = 'block';
                document.getElementById('api-status').innerText = '已连接';
                document.getElementById('api-status').className = 'api-status connected';
            }
        }
        if(settings.visual) {
            document.getElementById('wallpaper-url').value = settings.visual.wallpaper || '';
            if(settings.visual.wallpaper) document.getElementById('wallpaper-preview').style.backgroundImage = `url(${settings.visual.wallpaper})`;
            document.getElementById('widget-square-url').value = settings.visual.widget1 || '';
            if(settings.visual.widget1) document.getElementById('widget-square-preview').style.backgroundImage = `url(${settings.visual.widget1})`;
            document.getElementById('custom-image-url').value = settings.visual.widget2 || '';
            if(settings.visual.widget2) document.getElementById('custom-image-preview').style.backgroundImage = `url(${settings.visual.widget2})`;
        }
                renderSettingsAppList(settings.apps || {});
        body.classList.add('settings-active'); // 修改了这里
        
        const frameSettingsModule = document.getElementById('phone-frame-settings-module');
        if (localStorage.getItem(PHONE_FRAME_KEY) === 'true') {
            frameSettingsModule.style.display = 'block';
        } else {
            frameSettingsModule.style.display = 'none';
        }
    };
    
    window.hideSettingsPage = () => { body.classList.remove('settings-active'); }; // 修改了这里

    
    window.triggerPhotoWidgetUpload = () => { document.getElementById('input-photo-widget').click(); };
    window.handlePhotoWidgetUpload = (event) => {
        compressImage(event.target.files[0], 500, (base64) => {
            const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
            if(!settings.visual) settings.visual = {};
            settings.visual.photoWidget = base64;
            localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings));
            document.getElementById('photo-widget-img').src = base64;
            document.getElementById('photo-widget-img').style.display = 'block';
            document.getElementById('photo-widget-placeholder').style.display = 'none';
        });
    };

    window.handleIconUpload = (event) => {
        const file = event.target.files[0];
        if(!file) return;
        const appId = currentEditAppId;
        compressImage(file, 120, (base64) => {
            const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
            if(!settings.apps) settings.apps = {};
            if(!settings.apps[appId]) settings.apps[appId] = {};
            settings.apps[appId].icon = base64;
            localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings));
            applyVisualSettings();
            showToast("图标已更新");
        });
        event.target.value = '';
    };

    document.getElementById('save-settings-btn').addEventListener('click', () => {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        settings.api = {
            url: document.getElementById('api-url-input').value.trim(),
            key: document.getElementById('api-key-input').value.trim(),
            model: document.getElementById('model-select').value,
            temp: parseFloat(document.getElementById('temp-slider').value)
        };
        settings.visual = settings.visual || {};
        settings.visual.wallpaper = document.getElementById('wallpaper-url').value.trim();
        settings.visual.widget1 = document.getElementById('widget-square-url').value.trim();
        settings.visual.widget2 = document.getElementById('custom-image-url').value.trim();
        
        localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings));
        
        const iosMode = document.getElementById('ios-mode-switch').checked;
        applyIOSMode(iosMode);
        
        const phoneFrame = document.getElementById('phone-frame-switch').checked;
        applyPhoneFrame(phoneFrame);
        
        const catEars = document.getElementById('cat-ears-switch').checked;
        applyCatEars(catEars);
        
        applyVisualSettings();
        hideSettingsPage();
        showToast('设置已保存');
    });

    document.getElementById('phone-frame-switch').addEventListener('change', (e) => {
        const frameSettingsModule = document.getElementById('phone-frame-settings-module');
        if (e.target.checked) {
            frameSettingsModule.style.display = 'block';
        } else {
            frameSettingsModule.style.display = 'none';
        }
    });

    document.getElementById('phone-case-color-input').addEventListener('input', (e) => setPhoneCaseColor(e.target.value));
    document.getElementById('cat-ear-color-input').addEventListener('input', (e) => setCatEarColor(e.target.value));
    document.getElementById('temp-slider').addEventListener('input', (e) => { document.getElementById('temp-value-display').innerText = e.target.value; });

    let currentEditAppId = null;
    function renderSettingsAppList(appSettings) {
        const container = document.getElementById('settings-app-list-container');
        container.innerHTML = '';
        const apps = document.querySelectorAll('.app-item .app-name');
        apps.forEach((appEl, index) => {
            const defaultName = appEl.dataset.appName;
            if(!defaultName) return;
            const appId = `app_${index}`;
            const currentName = appSettings[appId]?.name || defaultName;
            
            const row = document.createElement('div');
            row.className = 'settings-app-row';
            row.innerHTML = `
                <div class="app-icon-preview" style="background:#f0f0f0; border-radius:12px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="triggerIconUpload('${appId}')">
                    ${appSettings[appId]?.icon ? `<img src="${appSettings[appId].icon}" style="width:100%;height:100%;border-radius:12px;object-fit:cover;">` : '🖼️'}
                </div>
                <input type="text" class="app-name-input" value="${currentName}" placeholder="${defaultName}" onchange="saveAppName('${appId}', this.value)">
                <button class="settings-btn" onclick="resetAppSetting('${appId}')">重置</button>
            `;
            container.appendChild(row);
        });
    }

    window.triggerIconUpload = (appId) => { currentEditAppId = appId; document.getElementById('input-app-icon').click(); };
    window.saveAppName = (appId, newName) => {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        if(!settings.apps) settings.apps = {};
        if(!settings.apps[appId]) settings.apps[appId] = {};
        settings.apps[appId].name = newName;
        localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings));
        applyVisualSettings();
    };
    window.resetAppSetting = (appId) => {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        if(settings.apps && settings.apps[appId]) {
            delete settings.apps[appId];
            localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings));
            renderSettingsAppList(settings.apps);
            applyVisualSettings();
            showToast("已重置该App自定义");
        }
    };

    function applyVisualSettings() {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        const phoneScreen = document.getElementById('phone-screen-content');
        const wp = settings.visual?.wallpaper || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib-rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
        
        if (document.body.classList.contains('phone-frame-active')) {
            phoneScreen.style.backgroundImage = `url(${wp})`;
            document.body.style.backgroundImage = 'none';
        } else {
            document.body.style.backgroundImage = `url(${wp})`;
            phoneScreen.style.backgroundImage = 'none';
        }

        const widget1 = document.getElementById('avatar-quadrant-1');
        if(settings.visual?.widget1) { widget1.style.backgroundImage = `url(${settings.visual.widget1})`; widget1.innerHTML=''; widget1.style.backgroundSize='cover'; }
        
        const apps = document.querySelectorAll('.app-item');
        let appIndex = 0;
        apps.forEach(app => {
            const nameEl = app.querySelector('.app-name');
            const iconEl = app.querySelector('.app-icon');
            if(nameEl) {
                const appId = `app_${appIndex}`;
                if(settings.apps && settings.apps[appId]) {
                    if(settings.apps[appId].name) nameEl.innerText = settings.apps[appId].name;
                    if(settings.apps[appId].icon) {
                        iconEl.innerHTML = `<img src="${settings.apps[appId].icon}" style="width:100%;height:100%;object-fit:cover;">`;
                        iconEl.style.background = 'transparent';
                    }
                } else {
                    nameEl.innerText = nameEl.dataset.appName;
                }
                appIndex++;
            }
        });

        if (settings.visual?.photoWidget) {
            document.getElementById('photo-widget-img').src = settings.visual.photoWidget;
            document.getElementById('photo-widget-img').style.display = 'block';
            document.getElementById('photo-widget-placeholder').style.display = 'none';
        }
    }

    // --- API Logic ---
    document.getElementById('test-api-btn').addEventListener('click', async () => {
        const url = document.getElementById('api-url-input').value.trim();
        const key = document.getElementById('api-key-input').value.trim();
        const statusEl = document.getElementById('api-status');
        if(!url || !key) { showToast('请填写API地址和Key'); return; }
        statusEl.innerText = '测试中...'; statusEl.className = 'api-status';
        try {
            let testUrl = url.endsWith('/v1') ? url + '/models' : url + '/v1/models';
            if(url.includes('generativelanguage')) testUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
            const res = await fetch(testUrl, { headers: { 'Authorization': `Bearer ${key}` } });
            if(res.ok) { statusEl.innerText = '连接成功'; statusEl.className = 'api-status connected'; showToast('API 连接成功'); }
            else { throw new Error(res.status); }
        } catch (e) {
            statusEl.innerText = '连接失败'; statusEl.className = 'api-status disconnected'; showToast('连接失败: ' + e.message);
        }
    });

    document.getElementById('fetch-models-btn').addEventListener('click', async () => {
        const url = document.getElementById('api-url-input').value.trim();
        const key = document.getElementById('api-key-input').value.trim();
        if(!url || !key) { showToast('请填写API地址和Key'); return; }
        try {
            let fetchUrl = url.endsWith('/v1') ? url + '/models' : url + '/v1/models';
            let isGemini = url.includes('generativelanguage');
            if(isGemini) fetchUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
            const res = await fetch(fetchUrl, { headers: { 'Authorization': `Bearer ${key}` } });
            const data = await res.json();
            const select = document.getElementById('model-select');
            select.innerHTML = '';
            let models = isGemini ? (data.models || []).map(m=>m.name.replace('models/','')) : (data.data || []).map(m => m.id);
            if(models.length === 0) { showToast('未获取到模型列表'); return; }
            models.sort().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m;
                select.appendChild(opt);
            });
            document.getElementById('model-select-wrapper').style.display = 'block';
            showToast('模型获取成功');
        } catch (e) { showToast('获取模型失败'); }
    });

    // --- AI Auto Reply Logic ---
        // 【修改后】的 triggerAIAutoReply 函数
    window.triggerAIAutoReply = async (isTransferEvent = false, transferAmount = 0, transferId = null) => {
        if (!currentChatContactId) return;
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings?.api?.url || !settings?.api?.key) { showToast("请先配置API"); return; }
        
        let contacts = JSON.parse(localStorage.getItem(CHAT_DATA_KEY) || '[]');
        const contactIndex = contacts.findIndex(c => c.id === currentChatContactId);
        if (contactIndex === -1) return;
        const contact = contacts[contactIndex];

        const signatureEl = document.getElementById('chat-conv-signature');
        const originalSignature = contact.signature || '';

        const globalProfile = getUserProfile();
        const uName = contact.userName || globalProfile.nickname || "User";
        const uPersona = contact.userPersona || "一个普通用户";

        const key = getMessagesKey(currentChatContactId);
        let messages = JSON.parse(localStorage.getItem(key) || '[]');
        
        const depth = contact.memoryDepth || 15;
        let recentMsgs = messages.slice(-depth);

        const recollectionData = getRecollections(currentChatContactId);
        const recollectionContext = recollectionData.items.map(item => item.text).join('\n');

        let worldbookContext = "";
        if (contact.worldbookIds && contact.worldbookIds.length > 0) {
            const allWb = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const activeWbs = allWb.filter(b => contact.worldbookIds.includes(b.id));
            activeWbs.forEach(wb => {
                worldbookContext += `\n[世界书: ${wb.title}]\n`;
                wb.entries.forEach(e => { worldbookContext += `${e.key ? e.key+': ' : ''}${e.content}\n`; });
            });
        }

        let timeContext = "";
        if (contact.timePerceptionEnabled) {
            const now = new Date();
            timeContext = `当前现实时间是：${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 星期${['日','一','二','三','四','五','六'][now.getDay()]} ${now.getHours()}:${now.getMinutes()}。请在对话中自然地体现出对时间的感知（如果合适的话）。`;
        }

        let historyStr = recentMsgs.map(m => {
            let sender = m.type === 'sent' ? uName : (contact.alias || contact.name);
            if (m.isTransfer) {
                if (m.type === 'sent') return `[${sender}向${contact.alias || contact.name}转账了 ¥${m.transferData.amount}]`;
                else return `[${sender}向${uName}转账了 ¥${m.transferData.amount}]`;
            }
            if (m.type === 'recalled') return `[系统消息：撤回了一条消息]`;
            return `${sender}: ${m.text}`;
        }).join('\n');

        // ▼▼▼▼▼【 修改核心：更新给AI的指令 (Prompt) 】▼▼▼▼▼
        let sysPrompt = `你现在扮演角色：${contact.alias || contact.name}。
角色设定：${contact.persona}
${worldbookContext ? `\n背景设定(世界书)：\n${worldbookContext}\n` : ''}
${recollectionContext ? `\n回忆总结(曾发生过的事)：\n${recollectionContext}\n` : ''}

与你对话的用户是：${uName}
用户的设定：${uPersona}
${timeContext}

**重要规则**:
1.  你必须以符合角色设定的口吻和性格进行回复。
2.  **你的回复必须被分割成多个小的、自然的对话气泡。**
3.  **最终输出格式必须是一个JSON对象**，其中包含一个名为 "reply" 的键，其值是一个字符串数组。数组中的每个字符串都将成为一个独立的聊天气泡。
4.  根据对话的自然节奏，将你的完整回复拆分成2到8个句子或短语，放入数组中。

**输出格式示例**:
{
  "reply": [
    "你好啊！",
    "今天天气真不错。",
    "让我想起我们去年在湖边散步的日子。",
    "对了，你带那把旧伞了吗？"
  ]
}`;
        // ▲▲▲▲▲【 指令更新结束 】▲▲▲▲▲


        if (isTransferEvent) {
             sysPrompt += `\n\n【特殊事件】刚才 ${uName} 向你转账了 ¥${transferAmount}。根据你的性格，决定是否要收下这笔钱。如果接受转账，请在JSON的 "reply" 数组的第一个元素前加上特殊标记 <ACCEPT_TRANSFER>；如果拒绝退回，则加上 <REJECT_TRANSFER>。例如: { "reply": ["<ACCEPT_TRANSFER>谢谢你的钱！", "我正好需要呢。"] }`;
        }

        const payload = {
            model: settings.api.model || 'gpt-3.5-turbo',
            messages: [
                { role: "system", content: sysPrompt },
                { role: "user", content: `历史聊天记录:\n${historyStr}\n\n请严格按照JSON格式要求给出你的回复:` }
            ],
            temperature: parseFloat(settings.api.temp || 0.8),
            response_format: { "type": "json_object" } // 请求API强制返回JSON
        };
        
        signatureEl.textContent = '对方正在输入中...';
        signatureEl.classList.add('typing-anim');

        try {
            let fetchUrl = settings.api.url.endsWith('/v1') ? settings.api.url + '/chat/completions' : settings.api.url + '/v1/chat/completions';
            const isGemini = settings.api.url.includes('generativelanguage');
            let bodyData, headers = { 'Content-Type': 'application/json' };
            
            if (isGemini) {
                // Gemini 需要不同的 payload 格式
                fetchUrl = `https://generativelanguage.googleapis.com/v1beta/models/${settings.api.model}:generateContent?key=${settings.api.key}`;
                bodyData = JSON.stringify({ contents: [{ parts: [{ text: sysPrompt + "\n\n历史聊天记录:\n" + historyStr + "\n\n请严格按照JSON格式要求给出你的回复:" }] }], generationConfig: { temperature: payload.temperature, response_mime_type: "application/json" } });
            } else {
                headers['Authorization'] = `Bearer ${settings.api.key}`;
                bodyData = JSON.stringify(payload);
            }

            const res = await fetch(fetchUrl, { method: 'POST', headers: headers, body: bodyData });
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`API Error: ${res.status} - ${errText}`);
            }
            const data = await res.json();
            
            let replyContent = "";
            if(isGemini) {
                replyContent = data.candidates[0].content.parts[0].text;
            } else {
                replyContent = data.choices[0].message.content;
            }

            // ▼▼▼▼▼【 修改核心：解析AI返回的JSON并分句发送 】▼▼▼▼▼
            let sentences = [];
            try {
                const parsedReply = JSON.parse(replyContent);
                if (Array.isArray(parsedReply.reply)) {
                    sentences = parsedReply.reply;
                } else {
                    throw new Error("AI返回的JSON中没有找到reply数组。");
                }
            } catch (jsonError) {
                // 如果AI没有按要求返回JSON，就退回到原来的分割方式
                console.error("AI未返回标准JSON，回退至手动分割:", jsonError);
                sentences = replyContent.match(/[^，。,.?!]+[，。,.?!]?/g) || [replyContent];
            }
            
            if (sentences.length > 0) {
                 // 检查第一句是否包含转账指令
                if (isTransferEvent) {
                    let firstSentence = sentences[0];
                    let action = null;
                    if (firstSentence.includes("<ACCEPT_TRANSFER>")) {
                        action = 'accept';
                        sentences[0] = firstSentence.replace("<ACCEPT_TRANSFER>", "").trim();
                    } else if (firstSentence.includes("<REJECT_TRANSFER>")) {
                        action = 'reject';
                        sentences[0] = firstSentence.replace("<REJECT_TRANSFER>", "").trim();
                    } else {
                        action = 'accept'; 
                    }
                    handleTransferResponse(transferId, action === 'accept');
                }

                // 循环发送每一句话
                for (const sentence of sentences) {
                    const trimmedSentence = sentence.trim();
                    if (!trimmedSentence) continue;

                    messages = JSON.parse(localStorage.getItem(key) || '[]');
                    messages.push({
                        id: Date.now() + Math.random(),
                        type: 'received',
                        text: trimmedSentence,
                        timestamp: Date.now()
                    });
                    localStorage.setItem(key, JSON.stringify(messages));
                    
                    contacts[contactIndex].lastMsg = trimmedSentence;
                    contacts[contactIndex].timestamp = Date.now();
                    localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts));

                    renderConversationMessages();

                    await sleep(Math.random() * 600 + 800); // 随机延迟0.8到1.4秒
                }
            }
            // ▲▲▲▲▲【 新逻辑结束 】▲▲▲▲▲

        } catch (e) {
            showToast("AI 回复失败: " + e.message, 4000);
            console.error("AI Reply Error:", e);
        } finally {
            signatureEl.textContent = originalSignature;
            signatureEl.classList.remove('typing-anim');
        }
    };
    async function generateMomentForCharacter(contact) {
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!settings?.api?.url || !settings?.api?.key || !settings?.api?.model) {
            console.log(`[AutoPost] API not configured, skipping moment generation for ${contact.alias || contact.name}`);
            return null;
        }

        const recollectionData = getRecollections(contact.id);
        const recollectionContext = recollectionData.items.map(item => item.text).join('\n');
        
        let worldbookContext = "";
        if (contact.worldbookIds && contact.worldbookIds.length > 0) {
            const allWb = JSON.parse(localStorage.getItem(WORLDBOOK_DATA_KEY) || '[]');
            const activeWbs = allWb.filter(b => contact.worldbookIds.includes(b.id));
            activeWbs.forEach(wb => {
                worldbookContext += `\n[世界书: ${wb.title}]\n`;
                wb.entries.forEach(e => { worldbookContext += `${e.key ? e.key+': ' : ''}${e.content}\n`; });
            });
        }
        
        const sysPrompt = `你现在扮演角色：${contact.alias || contact.name}。
角色设定：${contact.persona}
${worldbookContext ? `\n背景设定(世界书)：\n${worldbookContext}\n` : ''}
${recollectionContext ? `\n近期经历(回忆)：\n${recollectionContext}\n` : ''}

请根据你的性格和近期经历，发表一条简短的社交媒体动态（朋友圈）。内容要符合你的人设，自然真实。
仅输出动态纯文本内容，不要加引号、前缀或其他格式。如果不想发任何文字，就输出[EMPTY]`;

        try {
            const payload = {
                model: settings.api.model,
                messages: [{ role: "user", content: sysPrompt }],
                temperature: parseFloat(settings.api.temp || 0.8)
            };
            
            let fetchUrl = settings.api.url.endsWith('/v1') ? settings.api.url + '/chat/completions' : settings.api.url + '/v1/chat/completions';
            const isGemini = settings.api.url.includes('generativelanguage');
            let bodyData, headers = { 'Content-Type': 'application/json' };
            
            if (isGemini) {
                fetchUrl = `https://generativelanguage.googleapis.com/v1beta/models/${settings.api.model}:generateContent?key=${settings.api.key}`;
                bodyData = JSON.stringify({ contents: [{ parts: [{ text: sysPrompt }] }], generationConfig: { temperature: payload.temperature } });
            } else {
                headers['Authorization'] = `Bearer ${settings.api.key}`;
                bodyData = JSON.stringify(payload);
            }

            const res = await fetch(fetchUrl, { method: 'POST', headers: headers, body: bodyData });
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            const data = await res.json();
            
            let reply = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            reply = reply.trim();

            if (reply === '[EMPTY]') return null;

            return {
                id: Date.now(),
                authorId: contact.id, 
                timestamp: Date.now(),
                text: reply,
                images: [], 
                likes: [],
                comments: [],
                isPrivate: false
            };

        } catch(e) {
            console.error("[AutoPost] API failure:", e);
            return null;
        }
    }

    // --- Basic AI Chat App (Dock) ---
    window.openAIChat = () => {
        document.getElementById('ai-chat-modal').style.display = 'flex';
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        document.getElementById('current-model-name').innerText = settings.api?.model || '未选择模型';
    };
    window.closeAIChat = () => { document.getElementById('ai-chat-modal').style.display = 'none'; };
    window.handleChatKeyPress = (e) => { if(e.key === 'Enter') sendChatMessage(); };
    window.sendChatMessage = async () => {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;
        appendChatMsg('user', text);
        input.value = '';
        
        const settings = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY) || '{}');
        if(!settings.api || !settings.api.url || !settings.api.key) {
            appendChatMsg('ai', '请先在设置中配置完整的 API 信息。'); return;
        }
        appendChatMsg('ai', '正在思考...', true);
        
        try {
            let fetchUrl = settings.api.url.endsWith('/v1') ? settings.api.url + '/chat/completions' : settings.api.url + '/v1/chat/completions';
            const isGemini = settings.api.url.includes('generativelanguage');
            let bodyData, headers = { 'Content-Type': 'application/json' };
            
            if (isGemini) {
                fetchUrl = `https://generativelanguage.googleapis.com/v1beta/models/${settings.api.model}:generateContent?key=${settings.api.key}`;
                bodyData = JSON.stringify({ contents: [{ parts: [{ text: text }] }] });
            } else {
                headers['Authorization'] = `Bearer ${settings.api.key}`;
                bodyData = JSON.stringify({
                    model: settings.api.model || 'gpt-3.5-turbo',
                    messages: [{ role: 'user', content: text }],
                    temperature: parseFloat(settings.api.temp || 0.8)
                });
            }
            const res = await fetch(fetchUrl, { method: 'POST', headers: headers, body: bodyData });
            if(!res.ok) throw new Error(res.status);
            const data = await res.json();
            document.getElementById('typing-indicator')?.remove();
            let reply = isGemini ? data.candidates[0].content.parts[0].text : data.choices[0].message.content;
            appendChatMsg('ai', reply);
        } catch (e) {
            document.getElementById('typing-indicator')?.remove();
            appendChatMsg('ai', '请求失败，请检查网络或API配置。');
        }
    };
    function appendChatMsg(role, text, isTyping=false) {
        const container = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;
        if(isTyping) msgDiv.id = 'typing-indicator';
        msgDiv.innerText = text;
        container.appendChild(msgDiv);
        container.scrollTop = container.scrollHeight;
    }

        // --- Backup & Restore (终极完全备份版) ---
    window.exportBackup = () => {
        const data = {};
        // 自动遍历并打包所有的本地数据，一行不漏
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            data[key] = localStorage.getItem(key);
        }
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `OS_Backup_Full_${new Date().getTime()}.json`;
        a.click(); URL.revokeObjectURL(url);
        showToast("全量数据导出成功！");
    };

    window.importBackup = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            try {
                const data = JSON.parse(ev.target.result);
                // 覆盖写入所有导入的数据
                Object.keys(data).forEach(k => {
                    if(data[k] !== null && data[k] !== undefined) {
                        localStorage.setItem(k, data[k]);
                    }
                });
                showToast("全量数据恢复成功，即将刷新页面", 2000);
                setTimeout(() => location.reload(), 2000);
            } catch(err) { 
                showToast("备份文件格式错误"); 
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    };

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        const userProfile = getUserProfile();
        if (!userProfile.qqId) { userProfile.qqId = "20261314520"; saveUserProfile(userProfile); }
        if (!userProfile.nickname) { userProfile.nickname = "User Name"; saveUserProfile(userProfile); }

        const isIosMode = localStorage.getItem(IOS_MODE_KEY) === 'true';
        applyIOSMode(isIosMode);
        
        const isPhoneFrame = localStorage.getItem(PHONE_FRAME_KEY) === 'true';
        applyPhoneFrame(isPhoneFrame);

        const caseColor = localStorage.getItem(PHONE_CASE_COLOR_KEY);
        if (caseColor) setPhoneCaseColor(caseColor);

        const hasCatEars = localStorage.getItem(CAT_EARS_KEY) === 'true';
        applyCatEars(hasCatEars);

                const earColor = localStorage.getItem(CAT_EAR_COLOR_KEY);
        if (earColor) setCatEarColor(earColor);

        /* --- 新增的代码 --- */
        // 1. 页面加载时应用“开关灯”设置
        const isIconFontLightMode = localStorage.getItem(ICON_FONT_LIGHT_MODE_KEY) === 'true';
        applyIconFontLightMode(isIconFontLightMode);

        applyVisualSettings();

        // 2. 监听“开关灯”按钮的点击，立即生效
        document.getElementById('icon-font-color-switch').addEventListener('change', (e) => {
            applyIconFontLightMode(e.target.checked);
        });
        /* --- 新增结束 --- */
        
        setInterval(updatePhoneTime, 1000);
        updatePhoneTime();

                setTimeout(() => {
             initializeAllAutoPosts();
        }, 2000);
    });

</script>
</body>
</html>