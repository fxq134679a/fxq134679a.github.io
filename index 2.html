<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>iOS Home Screen</title>
    <style>
        /* --- ÂÖ®Â±ÄÈáçÁΩÆ‰∏éÂü∫Á°ÄÊ†∑Âºè --- */
        :root { 
            --theme-pink-bg-light: #FFF0F5; 
            --theme-pink-bg-med: rgba(229, 138, 171, 0.15);
            --theme-pink-text: #E58AAB; 
            --chat-bg-color: #FFF8FA; 
            --success-green: #4CAF50;
            --error-red: #F44336;
            --wallet-gradient: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 99%);
            --wallet-card-shadow: 0 10px 20px rgba(255, 154, 158, 0.3);
        }
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; 
        }

        body { 
            width: 100vw; 
            height: 100vh; 
            overflow: hidden; 
            background: url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80') center/cover no-repeat; 
            position: relative; 
            transition: background-image 0.3s ease-in-out;
            z-index: -2;
        }

        #home-screen { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            padding: 0 0 env(safe-area-inset-bottom, 20px) 0; 
            transition: opacity 0.3s ease, transform 0.3s ease; 
        }
        body.settings-active #home-screen,
        body.chat-active #home-screen,
        body.wallet-active #home-screen { 
            opacity: 0; 
            transform: scale(0.95); 
            pointer-events: none; 
        }

        /* --- Êó∂Èó¥Âå∫Âüü --- */
        #time-section { 
            height: 25%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding-top: env(safe-area-inset-top, 20px); 
            flex-shrink: 0; 
        }
        #time-container {
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
            background-size: cover;
            background-position: center;
            border-radius: 25px; 
        }
        #time-container:active {
            transform: scale(0.98);
        }
        #clock-time { 
            font-size: 5.2rem; 
            font-weight: 300; 
            color: white; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.1;
        }
        #clock-date {
            font-size: 0.95rem; 
            color: white;
            font-weight: 500;
            margin-top: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- ÁΩëÊ†ºÂå∫Âüü --- */
        #grid-area { 
            flex: 1; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr; 
            padding: 0 15px 10px 15px; 
            gap: 15px; 
            width: 100%; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        .grid-quadrant { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            position: relative; 
        }

        .widget-base { 
            width: 100%; 
            aspect-ratio: 1/1; 
            border-radius: 22px; 
            overflow: hidden; 
            position: relative; 
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            transition: transform 0.1s ease-in-out; 
            cursor: pointer; 
            background-color: rgba(255,255,255,0.2); 
            backdrop-filter: blur(10px); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background-size: cover; 
            background-position: center;
        }
        .widget-base:active { 
            transform: scale(0.95); 
        }
        .add-hint { 
            color: rgba(255,255,255,0.8); 
            font-size: 30px; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            pointer-events: none; 
        }
        
        #custom-image-quadrant #custom-image-display { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            cursor: pointer; 
            display: none;
        }

        .app-group-2x2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr; 
            gap: 12px; 
            width: 100%; 
            aspect-ratio: 1/1; 
        }
        .app-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
        }
        .app-icon { 
            width: 60px; 
            height: 60px; 
            border-radius: 16px; 
            margin-bottom: 5px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 28px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            position: relative; 
            transition: transform 0.1s, filter 0.1s; 
            background-size: cover; 
            background-position: center; 
            background-color: rgba(255, 255, 255, 0.2);
        }
        .app-name { 
            font-size: 11px; 
            color: white; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.4); 
            white-space: nowrap; 
        }
        
        /* Â∫ïÊ†èÊ†∑Âºè */
        #dock-area { 
            height: 95px; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 0 15px 10px 15px; 
            flex-shrink: 0; 
        }
        .dock-container { 
            width: 100%;
            max-width: 350px;
            height: 100%; 
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px); 
            border-radius: 30px; 
            display: flex; 
            justify-content: space-evenly; 
            align-items: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
            border: 1px solid rgba(255,255,255,0.15); 
        }
        .dock-icon { 
            width: 60px; 
            height: 60px; 
            font-size: 28px; 
            margin: 0; 
        }
        #dock-area .app-item .app-icon { 
            margin-bottom: 0; 
        }

        /* --- Chat App È°µÈù¢Ê†∑Âºè --- */
        #chat-app-page {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: var(--chat-bg-color); 
            z-index: 500;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.chat-active #chat-app-page {
            transform: translateY(0);
        }

        .chat-app-header {
            padding: calc(env(safe-area-inset-top, 20px) + 10px) 20px 15px;
            background: #fff;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            height: 65px;
            z-index: 10;
            transition: all 0.2s;
        }
        .chat-app-header.hidden { display: none; }
        .chat-header-title { font-size: 18px; font-weight: 600; color: #333; transition: color 0.3s ease; }
        .back-icon-img { width: 30px; height: 30px; object-fit: contain; cursor: pointer; opacity: 1; pointer-events: auto; }
        .back-icon-img.hidden { opacity: 0; pointer-events: none; }
        .header-right-icon { width: 26px; height: 26px; object-fit: contain; cursor: pointer; transition: opacity 0.3s ease; }

        .chat-app-content { flex: 1; overflow-y: auto; position: relative; padding-bottom: 100px; }
        .me-mode { padding-top: 0; background-color: var(--chat-bg-color); overflow-y: hidden; display: flex; flex-direction: column; justify-content: flex-end; height: 100vh; }
        .chat-tab-content { display: none; min-height: 100%; }
        .chat-tab-content.active { display: block; }

        /* --- Me Page ÈáçÊûÑÊ†∑Âºè --- */
        .me-page-container { width: 100%; display: flex; flex-direction: column; height: auto; max-height: 100vh; }
        .me-cover-area { width: 100%; height: 20vh; min-height: 260px; background-color: #ddd; background-size: cover; background-position: center; position: relative; cursor: pointer; transition: background-image 0.3s ease; }
        .me-cover-area::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(0,0,0,0.15)); pointer-events: none; }
        .me-like-wrapper { position: absolute; bottom: 5px; right: 20px; display: flex; flex-direction: column; align-items: center; gap: 4px; z-index: 5; }
        .me-setting-wrapper { position: absolute; top: 33px; right: 20px; z-index: 5; }
        .me-setting-icon { width: 24px; height: 24px; object-fit: contain; cursor: pointer; transition: transform 0.2s; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
        .me-setting-icon:active { transform: scale(0.9); }
        .me-like-icon { width: 24px; height: 24px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); cursor: pointer; transition: transform 0.2s; }
        .me-like-icon:active { transform: scale(1.2) rotate(-10deg); }
        .me-like-count { color: white; font-size: 13px; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.6); cursor: pointer; text-align: center; }
        .me-content-area { flex: 1; background-color: var(--chat-bg-color); position: relative; padding-top: 60px; }
        .me-floating-header { position: absolute; top: 0; left: 25px; width: calc(100% - 50px); transform: translateY(-50%); display: flex; align-items: center; z-index: 10; }
        .me-avatar-box { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; overflow: hidden; flex-shrink: 0; box-shadow: 0 5px 15px rgba(0,0,0,0.15); background: #fff; transition: all 0.3s ease; }
        .me-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .me-text-col { margin-left: 15px; display: flex; flex-direction: column; justify-content: center; }
        .me-nickname { font-size: 20px; font-weight: 700; color: #FFFFFF; margin-bottom: 6px; cursor: pointer; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .me-qq-id { font-size: 13px; color: #555; cursor: pointer; text-shadow: 0 0 5px rgba(255,255,255,0.8); }
        .me-info-list { margin: 10px 20px; background: white; border-radius: 16px; padding: 5px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.03); overflow: hidden; }
        .me-list-item { display: flex; align-items: center; padding: 15px 20px; background: white; cursor: pointer; transition: background-color 0.2s; }
        .me-list-item:active { background-color: #f9f9f9; }
        .me-list-item:not(:last-child) { border-bottom: 1px solid #f5f5f5; }
        .me-list-icon { width: 24px; height: 24px; object-fit: contain; margin-right: 15px; transition: all 0.3s ease; }
        .me-list-text { flex: 1; font-size: 15px; color: #333; font-weight: 500; display: flex; align-items: center; overflow: hidden; }
        .me-list-arrow { color: #ccc; font-size: 14px; font-weight: bold; font-family: monospace; margin-left: 10px; }
        .me-member-icons-row { display: flex; align-items: center; gap: 8px; overflow-x: auto; scrollbar-width: none; flex: 1; }
        .me-member-icons-row::-webkit-scrollbar { display: none; }
        .me-member-icon-slot { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; flex-shrink: 0; }

        /* --- Me Page Settings Modal --- */
        #me-settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--theme-pink-bg-light); z-index: 700; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: transform 0.3s ease, opacity 0.3s ease; transform: translateY(100%); }
        #me-settings-modal.active { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .me-settings-header-bar { display: flex; justify-content: space-between; align-items: center; padding: calc(env(safe-area-inset-top, 20px) + 15px) 20px 15px; background: white; box-shadow: 0 1px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .me-settings-header-title { font-size: 18px; font-weight: 600; color: #333; }
        .me-settings-close-btn { font-size: 16px; color: #666; cursor: pointer; background: none; border: none; }
        .me-settings-save-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 6px 16px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .me-settings-scroll-content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .me-settings-group { background-color: white; border-radius: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); }
        .me-settings-group h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .me-settings-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .me-settings-label { width: 50px; font-size: 13px; color: #555; font-weight: 500; flex-shrink: 0; }
        .me-settings-preview-wrapper { flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .me-settings-preview { background-color: #f9f9f9; border: 1px solid #eee; background-size: cover; background-position: center; object-fit: contain; }
        .me-settings-preview.avatar { width: 40px; height: 40px; border-radius: 50%; }
        .me-settings-preview.cover { width: 60px; height: 40px; border-radius: 6px; object-fit: cover; }
        .me-settings-preview.icon { width: 30px; height: 30px; border-radius: 6px; }
        .me-settings-input { flex: 1; padding: 10px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; font-size: 13px; outline: none; transition: border-color 0.2s; color: #555; min-width: 0; }
        .me-settings-input:focus { border-color: var(--theme-pink-text); background-color: #fff; }

        /* --- Wallet App Style --- */
        #wallet-app-page {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: #FDF6F9;
            z-index: 550;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body.wallet-active #wallet-app-page { transform: translateY(0); }
        
        .wallet-header {
            padding: calc(env(safe-area-inset-top, 20px) + 15px) 20px 15px;
            display: flex; align-items: center; justify-content: space-between;
            background-color: transparent;
            flex-shrink: 0;
        }
        .wallet-user-area {
            display: flex; align-items: center;
        }
        .wallet-avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
            margin-right: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid white; cursor: pointer;
        }
        .wallet-nickname {
            font-size: 16px; font-weight: 600; color: #333; cursor: pointer;
        }
        .wallet-close-btn {
            font-size: 14px; font-weight: 600; color: #999;
            background: rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; backdrop-filter: blur(5px);
        }

        .wallet-content {
            flex: 1; padding: 10px 20px 30px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 20px;
        }
        
        /* Ê†∏ÂøÉ‰ΩôÈ¢ùÂç°Áâá */
        .wallet-balance-card {
            background: var(--wallet-gradient);
            border-radius: 24px;
            padding: 30px 25px;
            color: white;
            box-shadow: var(--wallet-card-shadow);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 180px;
        }
        .wallet-balance-card::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
            pointer-events: none;
        }
        .wallet-balance-label { font-size: 14px; opacity: 0.9; margin-bottom: 10px; font-weight: 500; }
        .wallet-balance-amount { font-size: 42px; font-weight: 700; letter-spacing: 0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Êî∂ÊîØÁªüËÆ°Ë°å */
        .wallet-stats-row {
            display: flex; gap: 15px;
        }
        .wallet-stat-box {
            flex: 1; background: white; border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            display: flex; flex-direction: column;
        }
        .wallet-stat-label { font-size: 13px; color: #888; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .wallet-stat-label.in::before { content: '‚Üì'; color: var(--success-green); font-weight: bold; }
        .wallet-stat-label.out::before { content: '‚Üë'; color: var(--error-red); font-weight: bold; }
        .wallet-stat-val { font-size: 18px; font-weight: 600; color: #333; }
        
        /* Êìç‰ΩúÊåâÈíÆ */
        .wallet-actions { display: flex; gap: 15px; }
        .wallet-btn {
            flex: 1; padding: 15px; border-radius: 18px; border: none;
            font-size: 15px; font-weight: 600; cursor: pointer;
            transition: transform 0.1s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .wallet-btn:active { transform: scale(0.98); }
        .wallet-btn.income { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .wallet-btn.expense { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        
        /* ÊòéÁªÜÂàóË°® */
        .wallet-list-container {
            flex: 1; background: white; border-radius: 24px;
            padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.02);
            min-height: 200px; display: flex; flex-direction: column;
        }
        .wallet-list-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #f9f9f9;
        }
        .wallet-list-title { font-size: 16px; font-weight: 600; color: #333; }
        .wallet-month-badge {
            background: #f0f0f0; padding: 4px 10px; border-radius: 12px;
            font-size: 12px; color: #666;
        }
        
        .wallet-items-scroll { flex: 1; overflow-y: auto; }
        .wallet-item {
            display: flex; align-items: center; padding: 12px 0;
            border-bottom: 1px solid #f9f9f9;
        }
        .wallet-item:last-child { border-bottom: none; }
        .wallet-item-icon {
            width: 40px; height: 40px; border-radius: 12px;
            background: #FDF6F9; display: flex; justify-content: center; align-items: center;
            font-size: 20px; margin-right: 12px;
        }
        .wallet-item-info { flex: 1; }
        .wallet-item-cat { font-size: 15px; color: #333; font-weight: 500; margin-bottom: 4px; }
        .wallet-item-date { font-size: 12px; color: #999; }
        .wallet-item-amount { font-size: 16px; font-weight: 600; }
        .wallet-item-amount.in { color: var(--success-green); }
        .wallet-item-amount.out { color: var(--error-red); }
        .wallet-empty { text-align: center; color: #ccc; margin-top: 40px; font-size: 14px; }

        /* ËÆ∞Ë¥¶ÂºπÁ™ó */
        #wallet-add-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 600;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(5px);
        }
        #wallet-add-modal.active { opacity: 1; pointer-events: auto; }
        .wallet-add-card {
            background: white; width: 85%; max-width: 320px;
            border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #wallet-add-modal.active .wallet-add-card { transform: scale(1); }
        .wallet-modal-title { font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 20px; color: #333; }
        .wallet-input-group { margin-bottom: 15px; }
        .wallet-input {
            width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee;
            background: #f9f9f9; font-size: 16px; outline: none;
        }
        .wallet-input:focus { background: white; border-color: var(--theme-pink-text); }
        .wallet-type-select {
            display: flex; gap: 10px; margin-bottom: 20px;
        }
        .wallet-type-btn {
            flex: 1; padding: 10px; border-radius: 10px; border: 1px solid #eee;
            background: #fff; color: #666; font-size: 14px; cursor: pointer;
            transition: all 0.2s;
        }
        .wallet-type-btn.active.in { background: rgba(76, 175, 80, 0.1); border-color: var(--success-green); color: var(--success-green); font-weight: 600; }
        .wallet-type-btn.active.out { background: rgba(244, 67, 54, 0.1); border-color: var(--error-red); color: var(--error-red); font-weight: 600; }
        .wallet-confirm-btn {
            width: 100%; padding: 14px; background: var(--theme-pink-text); color: white;
            border: none; border-radius: 15px; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .wallet-cancel-btn {
            width: 100%; padding: 10px; background: transparent; color: #999;
            border: none; margin-top: 10px; cursor: pointer; font-size: 14px;
        }

        /* ËÅäÂ§©ÂàóË°®Ê†∑Âºè (Â§çÁî®) */
        .chat-list-container { width: 100%; }
        .chat-list-item { display: flex; align-items: center; padding: 12px 20px; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); border-bottom: 1px solid rgba(0,0,0,0.03); cursor: pointer; transition: background-color 0.2s; margin-bottom: 1px; }
        .chat-list-item:active { background-color: #f0f0f0; }
        .chat-list-avatar { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; margin-right: 15px; background-color: #eee; flex-shrink: 0; }
        .chat-list-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .chat-list-name { font-size: 16px; color: #111; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-msg { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-placeholder-text { color: #E58AAB; text-align: center; padding-top: 50%; font-size: 16px; font-weight: 500; }

        /* --- Ê∑ªÂä†Â•ΩÂèãÂºπÁ™óÊ†∑Âºè --- */
        #add-friend-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 600; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        #add-friend-modal.active { opacity: 1; pointer-events: auto; }
        .add-friend-card { width: 80%; max-width: 320px; background: white; border-radius: 20px; padding: 25px; display: flex; flex-direction: column; align-items: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; }
        #add-friend-modal.active .add-friend-card { transform: scale(1); }
        .add-friend-close { position: absolute; top: 15px; left: 15px; font-size: 24px; color: #999; cursor: pointer; line-height: 1; }
        .add-friend-save { position: absolute; top: 15px; right: 15px; width: 24px; height: 24px; cursor: pointer; transition: transform 0.2s; }
        .add-friend-save:active { transform: scale(0.9); }
        .add-friend-avatar-upload { width: 100px; height: 100px; border-radius: 50%; background-color: #f0f0f0; margin-top: 15px; margin-bottom: 10px; cursor: pointer; overflow: hidden; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; color: #ccc; font-size: 40px; }
        .add-friend-avatar-preview { width: 100%; height: 100%; object-fit: cover; display: none; }
        .add-friend-url-input { width: 100%; padding: 8px 12px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 10px; margin-bottom: 15px; font-size: 12px; outline: none; color: #666; text-align: center; }
        .add-friend-url-input::placeholder { color: #aaa; }
        .add-friend-input { width: 100%; padding: 12px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 12px; margin-bottom: 12px; font-size: 15px; outline: none; transition: border-color 0.2s; }
        .add-friend-input:focus { border-color: var(--theme-pink-text); background-color: white; }

        /* --- Á∫ØÂπ≥Èù¢ÈïøÊ§≠ÂúÜÂ∫ïÊ†è (Chat App) --- */
        .chat-bottom-bar-container { position: fixed; bottom: calc(env(safe-area-inset-bottom, 20px) + 15px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 380px; height: 64px; background-color: #FFFFFF; border-radius: 32px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.03); display: flex; justify-content: space-evenly; align-items: center; z-index: 501; }
        .chat-nav-item { flex: 1; height: 100%; display: flex; justify-content: center; align-items: center; cursor: pointer; opacity: 0.5; transition: opacity 0.2s ease; }
        .chat-nav-item.active { opacity: 1; }
        .chat-nav-icon { width: 28px; height: 28px; object-fit: contain; pointer-events: none; }

        /* --- ÂÖ®Â±èËÆæÁΩÆÈ°µÈù¢ --- */
        #settings-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--theme-pink-bg-light); z-index: 100; display: flex; flex-direction: column; padding: env(safe-area-inset-top, 20px) 15px env(safe-area-inset-bottom, 20px) 15px; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); overflow-x: hidden; }
        body.settings-active #settings-page { transform: translateY(0); }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
        .settings-header .back-btn-container { display: flex; align-items: center; }
        .settings-header .title { font-size: 18px; font-weight: 600; color: #333; }
        #save-settings-btn { background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; border-radius: 15px; padding: 8px 20px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .settings-content { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .settings-module { background-color: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(229, 138, 171, 0.1); width: 100%; }
        .settings-module h3 { font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600; }
        .settings-row { display: flex; flex-direction: column; align-items: stretch; margin-bottom: 15px; }
        .settings-row label { width: 100%; font-size: 14px; color: #555; margin-bottom: 6px; font-weight: 500; }
        .settings-row input, .settings-row button, .settings-row select { width: 100%; border: 1px solid #ddd; background-color: #f9f9f9; border-radius: 8px; padding: 10px; font-size: 14px; color: #333; outline: none; -webkit-appearance: none; min-width: 0; }
        .input-with-preview { display: flex; align-items: center; gap: 10px; width: 100%; }
        .input-with-preview input { flex: 1; min-width: 0; }
        .url-preview { width: 45px; height: 45px; border-radius: 8px; flex-shrink: 0; background-size: cover; background-position: center; border: 1px solid #eee; background-color: #f0f0f0; }
        .api-control-wrapper { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .api-control-row { display: flex; align-items: center; justify-content: space-between; }
        .api-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; }
        .api-status.connected { background-color: rgba(76, 175, 80, 0.1); color: var(--success-green); }
        .api-status.disconnected { background-color: rgba(244, 67, 54, 0.1); color: var(--error-red); }
        .api-control-buttons { display: flex; gap: 10px; }
        .api-control-buttons button { flex: 1; white-space: nowrap; }
        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after { content: '‚ñæ'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #888; pointer-events: none; }
        .settings-row select { padding-right: 30px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .temp-slider-container { display: flex; align-items: center; width: 100%; gap: 10px; }
        #temp-slider { flex: 1; padding: 0; height: 20px; }
        #temp-value-display { font-size: 14px; color: #555; min-width: 30px; text-align: right; }
        .app-icon-item { display: flex; align-items: center; margin-bottom: 12px; padding: 10px; border-radius: 12px; background-color: #f9f9f9; }
        .app-icon-preview { width: 40px; height: 40px; border-radius: 10px; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; background-size: cover; background-position: center; background-color: rgba(229, 138, 171, 0.1); }
        .app-icon-info { flex: 1; min-width: 0; }
        .app-icon-name { font-weight: 500; margin-bottom: 6px; color: #333; font-size: 13px; }
        .app-icon-input { display: flex; gap: 8px; }
        .app-icon-input input { flex: 1; min-width: 0; padding: 6px 8px; font-size: 12px; }
        .app-icon-input button { padding: 6px 12px; width: auto; font-size: 12px; background-color: var(--theme-pink-bg-med); color: var(--theme-pink-text); border: none; }
        
        #toast-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background-color: rgba(255, 230, 240, 0.98); color: #E58AAB; padding: 15px 25px; border-radius: 20px; font-size: 14px; font-weight: 500; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease, transform 0.3s ease; text-align: center; max-width: 80%; }
        #toast-notification.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .file-input-hidden { display: none; }
        
        /* AI Chat UI */
        #ai-chat-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #ai-chat-modal.active { opacity: 1; pointer-events: all; }
        #ai-chat-container { width: 90%; max-width: 500px; height: 80%; background-color: white; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #ai-chat-modal.active #ai-chat-container { transform: translateY(0); }
        .chat-header { padding: 15px 20px; background-color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .chat-header .model-name { font-weight: 600; color: #333; font-size: 16px; }
        .chat-header .close-btn { background: #f0f0f0; border: none; width: 28px; height: 28px; border-radius: 14px; font-size: 18px; cursor: pointer; color: #999; display: flex; align-items: center; justify-content: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background-color: #fcfcfc; }
        .message { margin-bottom: 15px; max-width: 85%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; font-size: 14px; word-wrap: break-word; }
        .message.user { background-color: var(--theme-pink-text); color: white; margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background-color: #f0f0f0; color: #333; margin-right: auto; border-bottom-left-radius: 4px; }
        .chat-input-area { padding: 12px 15px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); border-top: 1px solid #f0f0f0; display: flex; gap: 10px; background-color: white; }
        .chat-input-area input { flex: 1; padding: 10px 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 20px; font-size: 14px; outline: none; }
        .chat-input-area button { padding: 0 18px; background-color: var(--theme-pink-text); color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; }
    </style>
</head>
<body>

<div id="home-screen">
    <div id="time-section">
        <div id="time-container" onclick="handleTimeBgClick(event)">
            <div id="clock-time">12:00</div>
            <div id="clock-date" onclick="handleDateEdit(event)">2026Âπ¥02Êúà03Êó• ÊòüÊúü‰∫å</div>
        </div>
    </div>
    <div id="grid-area">
        <div class="grid-quadrant" id="custom-image-quadrant">
            <div class="widget-base">
                <img id="custom-image-display" src="" alt="Custom Image">
                <div class="add-hint" id="custom-image-hint">+</div>
            </div>
        </div>
        <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item" onclick="openChatApp()">
                    <div class="app-icon" id="icon-app1">‚òÅÔ∏è</div>
                    <span class="app-name" data-app-name="Chat">Chat</span>
                </div>
                <div class="app-item"><div class="app-icon" id="icon-app2">üéµ</div><span class="app-name" data-app-name="‰∏ñÁïå‰π¶">‰∏ñÁïå‰π¶</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app3">üí¨</div><span class="app-name" data-app-name="ÊèêÈÜí">ÊèêÈÜí</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app4">üì∏</div><span class="app-name" data-app-name="Áõ∏ÂÜå">Áõ∏ÂÜå</span></div>
            </div>
        </div>
        <div class="grid-quadrant">
            <div class="app-group-2x2">
                <div class="app-item"><div class="app-icon" id="icon-app5">üß≠</div><span class="app-name" data-app-name="HUshhh">HUshhh</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app6">üéÆ</div><span class="app-name" data-app-name="pxx">pxx</span></div>
                <div class="app-item"><div class="app-icon" id="icon-app7">üìÖ</div><span class="app-name" data-app-name="Êó•ÂéÜ">Êó•ÂéÜ</span></div>
                <!-- Wallet App Icon with OnClick -->
                <div class="app-item" onclick="openWalletApp()"><div class="app-icon" id="icon-app8">üí∞</div><span class="app-name" data-app-name="Wallet">Wallet</span></div>
            </div>
        </div>
        <div class="grid-quadrant">
            <div class="widget-base" id="widget-square"></div>
        </div>
    </div>
    <div id="dock-area">
        <div class="dock-container">
            <div class="app-item" onclick="showSettingsPage()"><div class="app-icon dock-icon" id="icon-dock-settings">‚öôÔ∏è</div></div>
            <div class="app-item" onclick="openAIChat()"><div class="app-icon dock-icon" id="icon-dock-ai">ü§ñ</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-safari">üß≠</div></div>
            <div class="app-item"><div class="app-icon dock-icon" id="icon-dock-messages">‚úâÔ∏è</div></div>
        </div>
    </div>
</div>

<!-- Chat App È°µÈù¢ -->
<div id="chat-app-page">
    <div class="chat-app-header" id="chat-app-header-el">
        <img src="https://img.heliar.top/file/1770068142146_È™®Â§¥_bone.png" class="back-icon-img" id="chat-back-btn" onclick="closeChatApp()">
        <div class="chat-header-title" id="chat-page-title">Chat</div>
        <img id="chat-header-right-icon" src="https://img.heliar.top/file/1770068438490_Ê∑ªÂä†‰∫∫Áæ§_people-plus.png" class="header-right-icon" onclick="openAddFriendModal()">
    </div>
    
    <div class="chat-app-content" id="chat-content-area">
        <div id="chat-tab-0" class="chat-tab-content active">
            <div class="chat-list-container" id="chat-list-container">
                <div class="chat-placeholder-text">Ê≤°ÊúâÊñ∞‰ø°ÊÅØ</div>
            </div>
        </div>
        <div id="chat-tab-1" class="chat-tab-content">
            <div class="chat-placeholder-text">ÈÄöËÆØÂΩï‰∏∫Á©∫</div>
        </div>
        <div id="chat-tab-2" class="chat-tab-content">
            <div class="chat-placeholder-text">ÊúãÂèãÂúàÊöÇÊó†Âä®ÊÄÅ</div>
        </div>
        
        <!-- Me (‰∏™‰∫∫‰∏ªÈ°µ) Ê†áÁ≠æ -->
        <div id="chat-tab-3" class="chat-tab-content">
            <div class="me-page-container">
                <div class="me-cover-area" id="profile-cover">
                    <div class="me-like-wrapper">
                        <img src="https://img.heliar.top/file/1770079217317_Ëµû_thumbs-up_2.png" class="me-like-icon" onclick="incrementLikeCount(event)">
                        <div class="me-like-count" id="profile-like-count" onclick="editLikeCount(event)">8888</div>
                    </div>
                    <div class="me-setting-wrapper">
                        <img src="https://img.heliar.top/file/1770083061419_ËÆæÁΩÆ_setting-two.png" class="me-setting-icon" onclick="openMeSettings()">
                    </div>
                </div>

                <div class="me-content-area">
                    <div class="me-floating-header">
                        <div class="me-avatar-box">
                            <img id="profile-avatar" class="me-avatar-img" src="" onerror="this.src='https://img.heliar.top/file/1770068438490_Ê∑ªÂä†‰∫∫Áæ§_people-plus.png'">
                        </div>
                        <div class="me-text-col">
                            <div class="me-nickname" id="profile-nickname" onclick="editNickname(event)">User Name</div>
                            <div class="me-qq-id" id="profile-qq-id" onclick="editQQID(event)">QQ: 20261314520</div>
                        </div>
                    </div>

                    <div class="me-info-list">
                        <div class="me-list-item" onclick="editSignature()">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081937488_‰∫∫Âëò_people.png">
                            <div class="me-list-text" id="profile-signature-text">Ëøô‰∏™‰∫∫ÂæàÊáíÔºå‰ªÄ‰πàÈÉΩÊ≤°Áïô‰∏ã~</div>
                            <div class="me-list-arrow">Ôºû</div>
                        </div>
                        <div class="me-list-item">
                            <img id="me-member-icon-main" class="me-list-icon" src="https://img.heliar.top/file/1770081928967_vip_vip-one.png">
                            <div class="me-list-text">
                                <div id="me-member-icon-container" class="me-member-icons-row">
                                    <!-- Âä®ÊÄÅÁîüÊàêÁöÑ8‰∏™ÂõæÊ†áÂ∞ÜÊîæÂú®ËøôÈáå -->
                                </div>
                            </div>
                            <div class="me-list-arrow">Ôºû</div>
                        </div>
                        <div class="me-list-item">
                            <img class="me-list-icon" src="https://img.heliar.top/file/1770081938581_ÊòüÊòü_star-one.png">
                            <div class="me-list-text">QQÁ©∫Èó¥</div>
                            <div class="me-list-arrow">Ôºû</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-bottom-bar-container">
        <div class="chat-nav-item active" onclick="switchChatTab(0, 'Chat')">
            <img src="https://img.heliar.top/file/1770068139630_‰ø°ÊÅØ_message_3.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(1, 'ÈÄöËÆØÂΩï')">
            <img src="https://img.heliar.top/file/1770068141129_ÈÄöËÆØÂΩï_address-book_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(2, 'ÊúãÂèãÂúà')">
            <img src="https://img.heliar.top/file/1770068142240_ÊúãÂèãÂúà_friends-circle_2.png" class="chat-nav-icon">
        </div>
        <div class="chat-nav-item" onclick="switchChatTab(3, 'me')">
            <img src="https://img.heliar.top/file/1770068137566_Êî∂ËóèÂ•ΩÂèã_personal-collection_2.png" class="chat-nav-icon">
        </div>
    </div>
</div>

<!-- Wallet App È°µÈù¢ -->
<div id="wallet-app-page">
    <div class="wallet-header">
        <div class="wallet-close-btn" onclick="closeWalletApp()">‚úï</div>
        <div class="wallet-user-area">
            <img id="wallet-avatar" class="wallet-avatar" onclick="triggerProfileAvatarUpload(event)">
            <span id="wallet-nickname" class="wallet-nickname" onclick="editNickname(event)">User</span>
        </div>
    </div>
    
    <div class="wallet-content">
        <!-- Ê†∏ÂøÉ‰ΩôÈ¢ùÂç°Áâá -->
        <div class="wallet-balance-card">
            <div class="wallet-balance-label">ÊÄª‰ΩôÈ¢ù (CNY)</div>
            <div class="wallet-balance-amount" id="wallet-total-balance">0.00</div>
        </div>
        
        <!-- Êî∂ÂÖ•/ÊîØÂá∫ÁªüËÆ° -->
        <div class="wallet-stats-row">
            <div class="wallet-stat-box">
                <div class="wallet-stat-label in">Êú¨ÊúàÊî∂ÂÖ•</div>
                <div class="wallet-stat-val" id="wallet-month-income">0.00</div>
            </div>
            <div class="wallet-stat-box">
                <div class="wallet-stat-label out">Êú¨ÊúàÊîØÂá∫</div>
                <div class="wallet-stat-val" id="wallet-month-expense">0.00</div>
            </div>
        </div>

        <!-- ËÆ∞Ë¥¶ÊåâÈíÆ -->
        <div class="wallet-actions">
            <button class="wallet-btn income" onclick="openWalletModal('income')">
                <span>+</span> ËÆ∞Êî∂ÂÖ•
            </button>
            <button class="wallet-btn expense" onclick="openWalletModal('expense')">
                <span>-</span> ËÆ∞ÊîØÂá∫
            </button>
        </div>

        <!-- ÊòéÁªÜÂàóË°® -->
        <div class="wallet-list-container">
            <div class="wallet-list-header">
                <div class="wallet-list-title">Êú¨ÊúàÊòéÁªÜ</div>
                <div class="wallet-month-badge" id="wallet-current-month">2Êúà</div>
            </div>
            <div class="wallet-items-scroll" id="wallet-transaction-list">
                <!-- Âä®ÊÄÅÁîüÊàêÂàóË°®È°π -->
                <div class="wallet-empty">Êú¨ÊúàÊöÇÊó†Êî∂ÊîØËÆ∞ÂΩï</div>
            </div>
        </div>
    </div>
</div>

<!-- Wallet ËÆ∞Ë¥¶ÂºπÁ™ó -->
<div id="wallet-add-modal">
    <div class="wallet-add-card">
        <div class="wallet-modal-title">ËÆ∞‰∏ÄÁ¨î</div>
        
        <div class="wallet-type-select">
            <button class="wallet-type-btn active in" id="w-btn-in" onclick="setWalletType('income')">Êî∂ÂÖ•</button>
            <button class="wallet-type-btn" id="w-btn-out" onclick="setWalletType('expense')">ÊîØÂá∫</button>
        </div>

        <div class="wallet-input-group">
            <input type="number" id="wallet-amount-input" class="wallet-input" placeholder="0.00" step="0.01">
        </div>
        <div class="wallet-input-group">
            <input type="text" id="wallet-desc-input" class="wallet-input" placeholder="Â§áÊ≥® (Â¶Ç: È§êÈ•Æ, Â∑•ËµÑ)">
        </div>

        <button class="wallet-confirm-btn" onclick="saveTransaction()">Á°ÆËÆ§</button>
        <button class="wallet-cancel-btn" onclick="closeWalletModal()">ÂèñÊ∂à</button>
    </div>
</div>

<!-- Ê∑ªÂä†Â•ΩÂèãÂºπÁ™ó -->
<div id="add-friend-modal">
    <div class="add-friend-card">
        <div class="add-friend-close" onclick="closeAddFriendModal()">√ó</div>
        <img src="https://img.heliar.top/file/1770069003752_‰øùÂ≠ò_save.png" class="add-friend-save" onclick="saveNewFriend()">
        
        <div class="add-friend-avatar-upload" onclick="triggerAvatarUpload()">
            <span id="avatar-placeholder-icon">+</span>
            <img id="new-friend-avatar-preview" class="add-friend-avatar-preview">
        </div>
        <input type="text" class="add-friend-url-input" id="new-friend-avatar-url" placeholder="ÊàñÁ≤òË¥¥ÂõæÁâáÈìæÊé•" oninput="handleAvatarUrlInput(this)">
        <input type="text" class="add-friend-input" id="new-friend-name" placeholder="ÂßìÂêç">
        <input type="text" class="add-friend-input" id="new-friend-alias" placeholder="Â§áÊ≥® (ÂèØÈÄâ)">
    </div>
</div>

<div id="settings-page">
    <div class="settings-header">
        <div class="back-btn-container" onclick="hideSettingsPage()">
            <img src="https://img.heliar.top/file/1770068142146_È™®Â§¥_bone.png" class="back-icon-img">
        </div>
        <span class="title">ËÆæÁΩÆ</span>
        <button id="save-settings-btn">OK</button>
    </div>
    <div class="settings-content">
        <!-- AI ËÆæÁΩÆÊ®°Âùó -->
        <div class="settings-module">
            <h3>AI API ËÆæÁΩÆ</h3>
            <div class="settings-row">
                <label for="api-url-input">API Âú∞ÂùÄ</label>
                <input type="text" id="api-url-input" placeholder="‰æãÂ¶Ç: https://api.openai.com/v1">
            </div>
            <div class="settings-row">
                <label for="api-key-input">API Key</label>
                <input type="password" id="api-key-input" placeholder="ËæìÂÖ•ÊÇ®ÁöÑ API Key">
            </div>
            <div class="settings-row">
                <label>Ê®°ÂûãËÆæÁΩÆ</label>
                <div class="api-control-wrapper">
                    <div class="api-control-row">
                        <span id="api-status" class="api-status disconnected">Êú™ËøûÊé•</span>
                    </div>
                    <div class="api-control-buttons">
                        <button id="test-api-btn">ÊµãËØïËøûÊé•</button>
                        <button id="fetch-models-btn">Ëé∑ÂèñÊ®°ÂûãÂàóË°®</button>
                    </div>
                    <div class="select-wrapper" id="model-select-wrapper" style="display: none; margin-top: 10px;">
                        <select id="model-select"></select>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="settings-module">
            <h3>AI ÂèÇÊï∞ËÆæÁΩÆ</h3>
            <div class="settings-row">
                <label>ÂõûÁ≠îÊ∏©Â∫¶ (Temperature)</label>
                <div class="temp-slider-container">
                    <input type="range" id="temp-slider" min="0" max="2" step="0.1" value="0.8">
                    <span id="temp-value-display">0.8</span>
                </div>
            </div>
            <div class="settings-row">
                <label for="max-tokens-input">ÊúÄÂ§ßÁîüÊàê‰ª§Áâå (Tokens)</label>
                <input type="number" id="max-tokens-input" placeholder="‰æãÂ¶Ç: 1000" value="1000">
            </div>
        </div>

        <div class="settings-module">
            <h3>ÁïåÈù¢ÁæéÂåñ</h3>
            <div class="settings-row">
                <label for="wallpaper-url">Â£ÅÁ∫∏ URL</label>
                <div class="input-with-preview">
                    <input type="text" id="wallpaper-url" placeholder="ËæìÂÖ•ÂõæÁâá URL">
                    <div class="url-preview" id="wallpaper-preview"></div>
                </div>
            </div>
        </div>
        
        <div class="settings-module">
            <h3>ÁªÑ‰ª∂ÂõæÁâá</h3>
            <div class="settings-row">
                <label for="widget-square-url">Â∑¶‰∏ãÁªÑ‰ª∂ URL</label>
                <div class="input-with-preview">
                    <input type="text" id="widget-square-url" placeholder="ËæìÂÖ•ÂõæÁâá URL">
                    <div class="url-preview" id="widget-square-preview"></div>
                </div>
            </div>
            <div class="settings-row">
                <label for="custom-image-url">Âè≥‰∏äÁªÑ‰ª∂ URL</label>
                <div class="input-with-preview">
                    <input type="text" id="custom-image-url" placeholder="ËæìÂÖ•ÂõæÁâá URL">
                    <div class="url-preview" id="custom-image-preview"></div>
                </div>
            </div>
        </div>
        
        <div class="settings-module">
            <h3>ÂõæÊ†áËá™ÂÆö‰πâ</h3>
            <div class="settings-app-list" id="settings-app-list-container">
                <!-- Âä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>
</div>

<div id="ai-chat-modal">
    <div id="ai-chat-container">
        <div class="chat-header">
            <span class="model-name" id="current-model-name">Êú™ÈÄâÊã©Ê®°Âûã</span>
            <button class="close-btn" onclick="closeAIChat()">√ó</button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai">
                ‰Ω†Â•ΩÔºÅÊàëÊòØ AI Âä©Êâã„ÄÇËØ∑ÁÇπÂáªÂ∫ïÊ†èÁ¨¨‰∏Ä‰∏™ÂõæÊ†áËøõÂÖ•ËÆæÁΩÆÈÖçÁΩÆ APIÔºåÁÑ∂ÂêéÊàë‰ª¨Â∞±ÂèØ‰ª•ËÅäÂ§©‰∫Ü„ÄÇ
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="ËØ¥ÁÇπ‰ªÄ‰πà..." onkeypress="handleChatKeyPress(event)">
            <button id="send-chat-btn" onclick="sendChatMessage()">ÂèëÈÄÅ</button>
        </div>
    </div>
</div>

<div id="toast-notification"></div>

<!-- New: Full Screen Me Page Settings Modal -->
<div id="me-settings-modal">
    <div class="me-settings-header-bar">
        <button class="me-settings-close-btn" onclick="closeMeSettings()">ÂÖ≥Èó≠</button>
        <span class="me-settings-header-title">‰∏™‰∫∫‰∏ªÈ°µËÆæÁΩÆ</span>
        <button class="me-settings-save-btn" onclick="saveMeSettings()">‰øùÂ≠ò</button>
    </div>
    
    <div class="me-settings-scroll-content">
        <!-- Âü∫Á°Ä‰ø°ÊÅØ -->
        <div class="me-settings-group">
            <h3>Âü∫Á°Ä‰ø°ÊÅØ</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">Â§¥ÂÉè</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-settings-avatar-preview" class="me-settings-preview avatar">
                </div>
                <input type="text" id="me-settings-avatar-url" class="me-settings-input" placeholder="Â§¥ÂÉè URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">ËÉåÊôØ</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-settings-cover-preview" class="me-settings-preview cover">
                </div>
                <input type="text" id="me-settings-cover-url" class="me-settings-input" placeholder="ËÉåÊôØÂõæ URL">
            </div>
            <!-- VIPÂõæÊ†áËÆæÁΩÆÂ∑≤Âà†Èô§ -->
        </div>

        <!-- 8‰∏™‰ºöÂëòÂõæÊ†áËÆæÁΩÆ -->
        <div class="me-settings-group">
            <h3>‰ºöÂëòÂõæÊ†áÂàóË°® (8‰∏™)</h3>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò1</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m1" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m1" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò2</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m2" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m2" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò3</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m3" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m3" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò4</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m4" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m4" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò5</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m5" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m5" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò6</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m6" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m6" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò7</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m7" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m7" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
            <div class="me-settings-row">
                <div class="me-settings-label">‰ºöÂëò8</div>
                <div class="me-settings-preview-wrapper">
                    <img id="me-preview-m8" class="me-settings-preview icon">
                </div>
                <input type="text" id="me-input-m8" class="me-settings-input" placeholder="ÂõæÁâá URL">
            </div>
        </div>
    </div>
</div>


<!-- ÈöêËóèÁöÑÊñá‰ª∂ËæìÂÖ•Ê°Ü -->
<input type="file" id="input-wallpaper" class="file-input-hidden" accept="image/*" onchange="handleWallpaperUpload(event)">
<input type="file" id="input-app-icon" class="file-input-hidden" accept="image/*" onchange="handleIconUpload(event)">
<input type="file" id="input-time-bg" class="file-input-hidden" accept="image/*" onchange="handleTimeBgUpload(event)">
<input type="file" id="input-friend-avatar" class="file-input-hidden" accept="image/*" onchange="handleFriendAvatarUpload(event)">
<input type="file" id="input-profile-avatar" class="file-input-hidden" accept="image/*" onchange="handleProfileAvatarUpload(event)">

<script>
    'use strict';
    // --- DOM & Keys ---
    const clockTimeEl = document.getElementById('clock-time');
    const clockDateEl = document.getElementById('clock-date');
    const timeContainer = document.getElementById('time-container');
    const apiUrlInput = document.getElementById('api-url-input');
    const apiKeyInput = document.getElementById('api-key-input');
    const tempSlider = document.getElementById('temp-slider');
    const tempValueDisplay = document.getElementById('temp-value-display');
    const maxTokensInput = document.getElementById('max-tokens-input');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const toast = document.getElementById('toast-notification');
    const body = document.body;
    
    const wallpaperUrlInput = document.getElementById('wallpaper-url');
    const widgetSquareUrlInput = document.getElementById('widget-square-url');
    const customImageUrlInput = document.getElementById('custom-image-url');
    const wallpaperPreview = document.getElementById('wallpaper-preview');
    const widgetSquarePreview = document.getElementById('widget-square-preview');
    const customImagePreview = document.getElementById('custom-image-preview');

    // MeËÆæÁΩÆÂºπÁ™óÁöÑDOMÂÖÉÁ¥†
    const meSettingsModal = document.getElementById('me-settings-modal');
    const meSettingsAvatarUrl = document.getElementById('me-settings-avatar-url');
    const meSettingsCoverUrl = document.getElementById('me-settings-cover-url');
    const meSettingsAvatarPreview = document.getElementById('me-settings-avatar-preview');
    const meSettingsCoverPreview = document.getElementById('me-settings-cover-preview');
    
    const ALL_SETTINGS_KEY = 'appSettings_v12'; 
    const CHAT_DATA_KEY = 'chatData_v1_contacts';
    const USER_PROFILE_KEY = 'userProfile_v4'; 
    const WALLET_DATA_KEY = 'walletData_v1';

    let customDateText = ""; 
    let tempAvatarUrl = ""; 
    let currentWalletType = 'income';

    // --- Chat App Logic ---
    window.openChatApp = () => {
        body.classList.add('chat-active');
        switchChatTab(0, 'Chat');
        renderChatList(); 
    };

    window.closeChatApp = () => {
        body.classList.remove('chat-active');
    };

    window.switchChatTab = (index, title) => {
        const titleEl = document.getElementById('chat-page-title');
        const rightIcon = document.getElementById('chat-header-right-icon');
        const headerEl = document.getElementById('chat-app-header-el');
        const backBtn = document.getElementById('chat-back-btn');
        const contentArea = document.getElementById('chat-content-area');

        const contents = document.querySelectorAll('.chat-tab-content');
        contents.forEach((el, i) => {
            if (i === index) el.classList.add('active');
            else el.classList.remove('active');
        });

        const navItems = document.querySelectorAll('.chat-nav-item');
        navItems.forEach((el, i) => {
            if (i === index) el.classList.add('active');
            else el.classList.remove('active');
        });

        headerEl.classList.remove('hidden');
        backBtn.classList.remove('hidden');
        contentArea.classList.remove('me-mode');
        titleEl.innerText = title;

        if (index === 0) {
            titleEl.style.color = "#FFC0CB";
            rightIcon.style.opacity = "1";
            rightIcon.style.pointerEvents = "auto";
        } else if (index === 1 || index === 2) {
            titleEl.style.color = "#333";
            rightIcon.style.opacity = "0";
            rightIcon.style.pointerEvents = "none";
            backBtn.classList.add('hidden');
        } else if (index === 3) {
            headerEl.classList.add('hidden');
            contentArea.classList.add('me-mode');
            loadUserProfile(); 
        }
    };

    // --- Wallet App Logic ---
    window.openWalletApp = () => {
        body.classList.add('wallet-active');
        loadWalletUI();
    };

    window.closeWalletApp = () => {
        body.classList.remove('wallet-active');
    };

    function getWalletData() {
        try {
            const data = localStorage.getItem(WALLET_DATA_KEY);
            return data ? JSON.parse(data) : { balance: 0.00, transactions: [] };
        } catch (e) {
            return { balance: 0.00, transactions: [] };
        }
    }

    function saveWalletData(data) {
        localStorage.setItem(WALLET_DATA_KEY, JSON.stringify(data));
    }

    function loadWalletUI() {
        // ÂêåÊ≠•Áî®Êà∑‰ø°ÊÅØ
        const profile = getUserProfile();
        document.getElementById('wallet-avatar').src = profile.avatar || 'https://img.heliar.top/file/1770068438490_Ê∑ªÂä†‰∫∫Áæ§_people-plus.png';
        document.getElementById('wallet-nickname').innerText = profile.nickname || 'User';

        const data = getWalletData();
        
        // Êõ¥Êñ∞ÊÄª‰ΩôÈ¢ù
        document.getElementById('wallet-total-balance').innerText = parseFloat(data.balance).toFixed(2);

        // ËÆ°ÁÆóÊú¨ÊúàÊî∂ÊîØ
        const now = new Date();
        const currentMonthStr = `${now.getFullYear()}-${now.getMonth() + 1}`;
        document.getElementById('wallet-current-month').innerText = `${now.getMonth() + 1}Êúà`;

        let monthIncome = 0;
        let monthExpense = 0;
        let monthTransactions = [];

        data.transactions.forEach(t => {
            const tDate = new Date(t.timestamp);
            const tMonthStr = `${tDate.getFullYear()}-${tDate.getMonth() + 1}`;
            
            if (tMonthStr === currentMonthStr) {
                monthTransactions.push(t);
                if (t.type === 'income') monthIncome += parseFloat(t.amount);
                else monthExpense += parseFloat(t.amount);
            }
        });

        document.getElementById('wallet-month-income').innerText = monthIncome.toFixed(2);
        document.getElementById('wallet-month-expense').innerText = monthExpense.toFixed(2);

        // Ê∏≤ÊüìÂàóË°®
        const listContainer = document.getElementById('wallet-transaction-list');
        listContainer.innerHTML = '';

        if (monthTransactions.length === 0) {
            listContainer.innerHTML = '<div class="wallet-empty">Êú¨ÊúàÊöÇÊó†Êî∂ÊîØËÆ∞ÂΩï</div>';
        } else {
            // ÊåâÊó∂Èó¥ÂÄíÂ∫è
            monthTransactions.sort((a, b) => b.timestamp - a.timestamp);
            
            monthTransactions.forEach(t => {
                const item = document.createElement('div');
                item.className = 'wallet-item';
                const dateObj = new Date(t.timestamp);
                const dateStr = `${dateObj.getMonth()+1}-${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
                
                // ÁÆÄÂçïÂõæÊ†áÈÄªËæë
                let icon = 'üí∞';
                if (t.type === 'income') icon = 'üßß';
                else if (t.desc.includes('È§êÈ•Æ') || t.desc.includes('ÂêÉ')) icon = 'üçî';
                else if (t.desc.includes('‰∫§ÈÄö') || t.desc.includes('ËΩ¶')) icon = 'üöó';
                else if (t.desc.includes('Ë¥≠Áâ©') || t.desc.includes('‰π∞')) icon = 'üõçÔ∏è';

                item.innerHTML = `
                    <div class="wallet-item-icon">${icon}</div>
                    <div class="wallet-item-info">
                        <div class="wallet-item-cat">${escapeHtml(t.desc || (t.type === 'income' ? 'Êî∂ÂÖ•' : 'ÊîØÂá∫'))}</div>
                        <div class="wallet-item-date">${dateStr}</div>
                    </div>
                    <div class="wallet-item-amount ${t.type === 'income' ? 'in' : 'out'}">
                        ${t.type === 'income' ? '+' : '-'}${parseFloat(t.amount).toFixed(2)}
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }
    }

    // ËÆ∞Ë¥¶ÈÄªËæë
    window.openWalletModal = (type) => {
        currentWalletType = type;
        setWalletType(type);
        document.getElementById('wallet-amount-input').value = '';
        document.getElementById('wallet-desc-input').value = '';
        document.getElementById('wallet-add-modal').classList.add('active');
    };

    window.closeWalletModal = () => {
        document.getElementById('wallet-add-modal').classList.remove('active');
    };

    window.setWalletType = (type) => {
        currentWalletType = type;
        const btnIn = document.getElementById('w-btn-in');
        const btnOut = document.getElementById('w-btn-out');
        if (type === 'income') {
            btnIn.classList.add('active', 'in');
            btnOut.className = 'wallet-type-btn';
        } else {
            btnOut.classList.add('active', 'out');
            btnIn.className = 'wallet-type-btn';
        }
    };

    window.saveTransaction = () => {
        const amountStr = document.getElementById('wallet-amount-input').value;
        const desc = document.getElementById('wallet-desc-input').value.trim();
        const amount = parseFloat(amountStr);

        if (isNaN(amount) || amount <= 0) {
            showToast('ËØ∑ËæìÂÖ•ÊúâÊïàÈáëÈ¢ù');
            return;
        }

        const data = getWalletData();
        const transaction = {
            id: Date.now(),
            type: currentWalletType,
            amount: amount,
            desc: desc,
            timestamp: Date.now()
        };

        data.transactions.push(transaction);
        
        // Êõ¥Êñ∞ÊÄª‰ΩôÈ¢ù
        if (currentWalletType === 'income') {
            data.balance = parseFloat(data.balance) + amount;
        } else {
            data.balance = parseFloat(data.balance) - amount;
        }

        saveWalletData(data);
        closeWalletModal();
        loadWalletUI();
        showToast('ËÆ∞Ë¥¶ÊàêÂäü');
    };


    // --- Friend Adding & Chat List Logic ---
    window.openAddFriendModal = () => {
        tempAvatarUrl = "";
        document.getElementById('new-friend-name').value = "";
        document.getElementById('new-friend-alias').value = "";
        document.getElementById('new-friend-avatar-url').value = ""; 
        document.getElementById('new-friend-avatar-preview').style.display = 'none';
        document.getElementById('new-friend-avatar-preview').src = "";
        document.getElementById('avatar-placeholder-icon').style.display = 'block';
        
        document.getElementById('add-friend-modal').classList.add('active');
    };

    window.closeAddFriendModal = () => {
        document.getElementById('add-friend-modal').classList.remove('active');
    };

    window.triggerAvatarUpload = () => {
        document.getElementById('input-friend-avatar').click();
    };

    window.handleAvatarUrlInput = (input) => {
        const url = input.value.trim();
        if (url) {
            tempAvatarUrl = url;
            const imgEl = document.getElementById('new-friend-avatar-preview');
            imgEl.src = url;
            imgEl.style.display = 'block';
            document.getElementById('avatar-placeholder-icon').style.display = 'none';
        } else {
            tempAvatarUrl = "";
            document.getElementById('new-friend-avatar-preview').style.display = 'none';
            document.getElementById('avatar-placeholder-icon').style.display = 'block';
        }
    };

    function compressImage(file, maxSize, callback) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                let width = img.width;
                let height = img.height;
                
                if (width > height) {
                    if (width > maxSize) {
                        height *= maxSize / width;
                        width = maxSize;
                    }
                } else {
                    if (height > maxSize) {
                        width *= maxSize / height;
                        height = maxSize;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);
                
                callback(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    window.handleFriendAvatarUpload = (event) => {
        compressImage(event.target.files[0], 200, (base64) => {
            tempAvatarUrl = base64;
            document.getElementById('new-friend-avatar-url').value = "";
            
            const imgEl = document.getElementById('new-friend-avatar-preview');
            imgEl.src = tempAvatarUrl;
            imgEl.style.display = 'block';
            document.getElementById('avatar-placeholder-icon').style.display = 'none';
        });
    };

    window.saveNewFriend = () => {
        const name = document.getElementById('new-friend-name').value.trim();
        const alias = document.getElementById('new-friend-alias').value.trim();
        
        if (!name) { showToast("ËØ∑ËæìÂÖ•ÂßìÂêç"); return; }
        if (!tempAvatarUrl) { showToast("ËØ∑‰∏ä‰º†Â§¥ÂÉèÊàñËæìÂÖ•URL"); return; }

        let contacts = [];
        try {
            const storedContacts = localStorage.getItem(CHAT_DATA_KEY);
            contacts = storedContacts ? JSON.parse(storedContacts) : [];
        } catch (e) { contacts = []; }
        
        if (contacts.length >= 200) { showToast("Â•ΩÂèãÊï∞ÈáèÂ∑≤Ëææ‰∏äÈôê (200)"); return; }
        const existingContact = contacts.find(contact => contact.name === name || (alias && contact.alias === alias));
        if (existingContact) { showToast("ËØ•Â•ΩÂèãÂ∑≤Â≠òÂú®"); return; }

        const newContact = {
            id: Date.now(),
            name: name,
            alias: alias,
            avatar: tempAvatarUrl,
            lastMsg: "ÁÇπÂáªÂºÄÂßãËÅäÂ§©",
            timestamp: Date.now()
        };

        contacts.unshift(newContact);
        try {
            localStorage.setItem(CHAT_DATA_KEY, JSON.stringify(contacts));
            showToast("Ê∑ªÂä†ÊàêÂäüÔºÅ");
            closeAddFriendModal();
            renderChatList();
        } catch (e) { console.error("Error saving contact:", e); showToast("‰øùÂ≠òÂ§±Ë¥•ÔºåÂõæÁâáÂèØËÉΩËøáÂ§ß"); }
    };

    window.renderChatList = () => {
        const container = document.getElementById('chat-list-container');
        let contacts = [];
        try {
            const storedContacts = localStorage.getItem(CHAT_DATA_KEY);
            contacts = storedContacts ? JSON.parse(storedContacts) : [];
        } catch (e) { contacts = []; }

        if (contacts.length === 0) {
            container.innerHTML = '<div class="chat-placeholder-text">Ê≤°ÊúâÊñ∞‰ø°ÊÅØ</div>';
            return;
        }

        container.innerHTML = '';
        contacts.sort((a, b) => b.timestamp - a.timestamp);
        
        contacts.forEach(contact => {
            const displayName = contact.alias ? contact.alias : contact.name;
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.onclick = () => openChatWindow(contact.id); 
            
            item.innerHTML = `
                <img src="${contact.avatar}" class="chat-list-avatar" alt="avatar" onerror="this.src='https://img.heliar.top/file/1770068438490_Ê∑ªÂä†‰∫∫Áæ§_people-plus.png'">
                <div class="chat-list-info">
                    <div class="chat-list-name">${escapeHtml(displayName)}</div>
                    <div class="chat-list-msg">${escapeHtml(contact.lastMsg || 'ÁÇπÂáªÂºÄÂßãËÅäÂ§©')}</div>
                </div>
            `;
            container.appendChild(item);
        });
    };

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    window.openChatWindow = (contactId) => { showToast("ËøõÂÖ•ËÅäÂ§© (ÂäüËÉΩÂºÄÂèë‰∏≠...)"); };

    // --- Core Functions ---
    const showToast = (message, duration = 2000) => { 
        toast.innerHTML = message; 
        toast.classList.add('show'); 
        setTimeout(() => toast.classList.remove('show'), duration); 
    };
    
    const updateClock = () => { 
        const now = new Date(); 
        clockTimeEl.innerText = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; 
        
        if (!customDateText) {
            const days = ['ÊòüÊúüÊó•', 'ÊòüÊúü‰∏Ä', 'ÊòüÊúü‰∫å', 'ÊòüÊúü‰∏â', 'ÊòüÊúüÂõõ', 'ÊòüÊúü‰∫î', 'ÊòüÊúüÂÖ≠'];
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const day = days[now.getDay()];
            clockDateEl.innerText = `${year}Âπ¥${month}Êúà${date}Êó• ${day}`;
        } else {
            clockDateEl.innerText = customDateText;
        }
    };

    window.handleDateEdit = (event) => {
        event.stopPropagation();
        const newText = prompt("ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâÊó•ÊúüÊñáÂ≠óÔºàÁïôÁ©∫ÊÅ¢Â§çÂÆûÊó∂Êó•ÊúüÔºâÔºö", clockDateEl.innerText);
        if (newText !== null) {
            customDateText = newText.trim();
            updateClock();
            saveAllSettings();
        }
    };

    window.handleTimeBgClick = (event) => { document.getElementById('input-time-bg').click(); };
    window.handleTimeBgUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            timeContainer.style.backgroundImage = `url(${dataUrl})`;
            saveAllSettings();
            showToast('Êó∂Èó¥ËÉåÊôØÂ∑≤Êõ¥Êñ∞ ^œâ^');
        };
        reader.readAsDataURL(file);
    };

    const showSettingsPage = () => { populateSettingsList(); body.classList.add('settings-active'); };
    const hideSettingsPage = () => body.classList.remove('settings-active');

    function handleUrlInput(inputEl, previewEl, callback) {
        const url = inputEl.value.trim();
        if (url) {
            const img = new Image();
            img.onload = () => { previewEl.style.backgroundImage = `url(${url})`; if (callback) callback(url); };
            img.onerror = () => { previewEl.style.backgroundImage = ''; };
            img.src = url;
        } else { previewEl.style.backgroundImage = ''; }
    }
    
    function handleImgSrcInput(inputEl, imgEl) {
        const url = inputEl.value.trim();
        if (url) {
             imgEl.src = url;
             imgEl.onerror = () => { imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; }; 
        } else {
             imgEl.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
        }
    }

    wallpaperUrlInput.addEventListener('input', () => handleUrlInput(wallpaperUrlInput, wallpaperPreview));
    widgetSquareUrlInput.addEventListener('input', () => handleUrlInput(widgetSquareUrlInput, widgetSquarePreview));
    customImageUrlInput.addEventListener('input', () => handleUrlInput(customImageUrlInput, customImagePreview));

    const applyIconToUI = (appId, url) => { 
        const el = document.getElementById(appId); 
        if (!el) return;
        if (url && (url.startsWith('http') || url.startsWith('data:'))) {
            el.innerHTML = ''; el.style.backgroundImage = `url(${url})`;
        } else {
            el.style.backgroundImage = '';
            const defaults = {
                'icon-app1': '‚òÅÔ∏è', 'icon-app2': 'üéµ', 'icon-app3': 'üí¨', 'icon-app4': 'üì∏',
                'icon-app5': 'üß≠', 'icon-app6': 'üéÆ', 'icon-app7': 'üìÖ', 'icon-app8': 'üí∞',
                'icon-dock-settings': '‚öôÔ∏è', 'icon-dock-ai': 'ü§ñ', 'icon-dock-safari': 'üß≠', 'icon-dock-messages': '‚úâÔ∏è'
            };
            if (defaults[appId]) el.innerHTML = defaults[appId];
        }
    };

    const populateSettingsList = () => {
        const container = document.getElementById('settings-app-list-container');
        container.innerHTML = '';
        const appIcons = [
            { id: 'icon-app1', name: 'Chat', default: '‚òÅÔ∏è' }, { id: 'icon-app2', name: '‰∏ñÁïå‰π¶', default: 'üéµ' },
            { id: 'icon-app3', name: 'ÊèêÈÜí', default: 'üí¨' }, { id: 'icon-app4', name: 'Áõ∏ÂÜå', default: 'üì∏' },
            { id: 'icon-app5', name: 'HUshhh', default: 'üß≠' }, { id: 'icon-app6', name: 'pxx', default: 'üéÆ' },
            { id: 'icon-app7', name: 'Êó•ÂéÜ', default: 'üìÖ' }, { id: 'icon-app8', name: 'Wallet', default: 'üí∞' }
        ];
        appIcons.forEach(app => {
            const item = document.createElement('div');
            item.className = 'app-icon-item';
            const cur = document.getElementById(app.id);
            const bg = cur.style.backgroundImage;
            item.innerHTML = `
                <div class="app-icon-preview" id="preview-${app.id}" style="${bg ? `background-image:${bg}` : ''}">${!bg ? app.default : ''}</div>
                <div class="app-icon-info">
                    <div class="app-icon-name">${app.name}</div>
                    <div class="app-icon-input">
                        <input type="text" id="url-${app.id}" placeholder="ÂõæÁâá URL" value="${bg ? bg.slice(5, -2).replace(/['"]/g, '') : ''}">
                        <button onclick="triggerIconUpload('${app.id}')">‰∏ä‰º†</button>
                    </div>
                </div>`;
            container.appendChild(item);
            const inp = document.getElementById(`url-${app.id}`);
            inp.addEventListener('input', () => {
                if (inp.value.trim()) handleUrlInput(inp, document.getElementById(`preview-${app.id}`), (u) => applyIconToUI(app.id, u));
                else { applyIconToUI(app.id, ''); document.getElementById(`preview-${app.id}`).style.backgroundImage = ''; document.getElementById(`preview-${app.id}`).innerHTML = app.default; }
            });
        });
    };

    window.triggerIconUpload = (id) => { const i = document.getElementById('input-app-icon'); i.dataset.target = id; i.click(); };
    window.handleIconUpload = (e) => {
        const f = e.target.files[0]; const id = e.target.dataset.target;
        if (!f || !id) return;
        const r = new FileReader();
        r.onload = (ev) => {
            const d = ev.target.result; applyIconToUI(id, d);
            document.getElementById(`preview-${id}`).style.backgroundImage = `url(${d})`;
            document.getElementById(`preview-${id}`).innerHTML = '';
            document.getElementById(`url-${id}`).value = d;
        };
        r.readAsDataURL(f);
    };

    window.handleWallpaperUpload = (e) => {
        const f = e.target.files[0]; if (!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            const d = ev.target.result; body.style.backgroundImage = `url(${d})`;
            wallpaperUrlInput.value = d; wallpaperPreview.style.backgroundImage = `url(${d})`;
        };
        r.readAsDataURL(f);
    };

    // --- Profile (Me) Page Functions ---
    function getUserProfile() {
        try {
            const p = localStorage.getItem(USER_PROFILE_KEY);
            const profile = p ? JSON.parse(p) : {};
            return {
                cover: profile.cover || '',
                avatar: profile.avatar || '',
                nickname: profile.nickname || 'Antigravity',
                qqId: profile.qqId || '20261314520',
                likes: profile.likes === undefined ? 8888 : profile.likes,
                signature: profile.signature || 'Ëøô‰∏™‰∫∫ÂæàÊáíÔºå‰ªÄ‰πàÈÉΩÊ≤°Áïô‰∏ã~',
                memberIconUrl: profile.memberIconUrl || 'https://img.heliar.top/file/1770081928967_vip_vip-one.png',
                memberUrls: profile.memberUrls || new Array(8).fill('')
            };
        } catch(e) {
            return { 
                cover: '', avatar: '', nickname: 'Antigravity', qqId: '20261314520', 
                likes: 8888, signature: 'Ëøô‰∏™‰∫∫ÂæàÊáíÔºå‰ªÄ‰πàÈÉΩÊ≤°Áïô‰∏ã~', 
                memberIconUrl: 'https://img.heliar.top/file/1770081928967_vip_vip-one.png',
                memberUrls: new Array(8).fill('')
            };
        }
    }

    function saveUserProfile(profileData) {
        try {
            localStorage.setItem(USER_PROFILE_KEY, JSON.stringify(profileData));
            // ÂÆûÊó∂Êõ¥Êñ∞ Wallet ÁöÑÁî®Êà∑‰ø°ÊÅØÔºàÂ¶ÇÊûúÊâìÂºÄÁùÄÔºâ
            if (document.body.classList.contains('wallet-active')) {
                loadWalletUI();
            }
        } catch (e) {
            showToast("‰øùÂ≠òÂ§±Ë¥• (LocalStorageÊª°)");
        }
    }

    function loadUserProfile() {
        const p = getUserProfile();
        
        const coverEl = document.getElementById('profile-cover');
        const avatarEl = document.getElementById('profile-avatar');
        const nickEl = document.getElementById('profile-nickname');
        const qqEl = document.getElementById('profile-qq-id');
        const likeEl = document.getElementById('profile-like-count');
        const signatureEl = document.getElementById('profile-signature-text');
        const memberIconEl = document.getElementById('me-member-icon-main'); 
        const memberIconContainer = document.getElementById('me-member-icon-container');

        if (p.cover) {
             coverEl.style.backgroundImage = `url(${p.cover})`;
        } else {
             coverEl.style.backgroundImage = 'linear-gradient(to bottom, #7A88FF, #7AFFAF)';
        }

        if (p.avatar) {
            avatarEl.src = p.avatar;
        } else {
            avatarEl.src = 'https://img.heliar.top/file/1770068438490_Ê∑ªÂä†‰∫∫Áæ§_people-plus.png';
        }

        nickEl.innerText = p.nickname;
        qqEl.innerText = `QQ: ${p.qqId}`;
        likeEl.innerText = p.likes;
        signatureEl.innerText = p.signature || 'Ëøô‰∏™‰∫∫ÂæàÊáíÔºå‰ªÄ‰πàÈÉΩÊ≤°Áïô‰∏ã~';
        memberIconEl.src = p.memberIconUrl || 'https://img.heliar.top/file/1770081928967_vip_vip-one.png';

        memberIconContainer.innerHTML = '';
        p.memberUrls.forEach((url, index) => {
            if(url && url.trim() !== '') {
                const img = document.createElement('img');
                img.className = 'me-member-icon-slot';
                img.src = url;
                memberIconContainer.appendChild(img);
            }
        });
    }
    
    window.editSignature = () => {
        const p = getUserProfile();
        const newSignature = prompt("ËØ∑ËæìÂÖ•‰Ω†ÁöÑ‰∏™ÊÄßÁ≠æÂêçÔºö", p.signature);
        if (newSignature !== null) { 
            p.signature = newSignature.trim() || 'Ëøô‰∏™‰∫∫ÂæàÊáíÔºå‰ªÄ‰πàÈÉΩÊ≤°Áïô‰∏ã~'; 
            saveUserProfile(p);
            loadUserProfile(); 
        }
    };

    window.triggerProfileAvatarUpload = (e) => {
        if(e) e.stopPropagation(); 
        document.getElementById('input-profile-avatar').click();
    };

    window.handleProfileAvatarUpload = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        compressImage(file, 200, (base64) => {
            const p = getUserProfile();
            p.avatar = base64;
            saveUserProfile(p);
            loadUserProfile();
            showToast("Â§¥ÂÉèÂ∑≤Êõ¥Êñ∞");
        });
    };

    window.editNickname = (e) => {
        if(e) e.stopPropagation();
        const p = getUserProfile();
        const newName = prompt("ËØ∑ËæìÂÖ•Êñ∞ÊòµÁß∞:", p.nickname);
        if (newName && newName.trim()) {
            p.nickname = newName.trim();
            saveUserProfile(p);
            loadUserProfile();
        }
    };

    window.editQQID = (e) => {
        if(e) e.stopPropagation();
        const p = getUserProfile();
        const newID = prompt("ËØ∑ËæìÂÖ•QQÂè∑:", p.qqId);
        if (newID && newID.trim()) {
            p.qqId = newID.trim();
            saveUserProfile(p);
            loadUserProfile();
        }
    };

    window.editLikeCount = (e) => {
        if(e) e.stopPropagation();
        const p = getUserProfile();
        const newCount = prompt("ËØ∑ËæìÂÖ•ÁÇπËµûÊï∞:", p.likes);
        if (newCount && !isNaN(newCount)) {
            p.likes = Number(newCount);
            saveUserProfile(p);
            loadUserProfile();
        }
    };
    
    window.incrementLikeCount = (e) => {
        if(e) e.stopPropagation();
        const p = getUserProfile();
        p.likes = parseInt(p.likes) + 1;
        saveUserProfile(p);
        loadUserProfile();
        const icon = document.querySelector('.me-like-icon');
        icon.style.transform = "scale(1.2) rotate(-10deg)";
        setTimeout(() => icon.style.transform = "scale(1) rotate(0deg)", 150);
    };

    // --- MeÈ°µÈù¢ËÆæÁΩÆÂºπÁ™óÂäüËÉΩ ---
    window.openMeSettings = () => {
        const p = getUserProfile();
        meSettingsAvatarUrl.value = p.avatar || '';
        meSettingsCoverUrl.value = p.cover || '';
        meSettingsAvatarPreview.src = p.avatar || 'https://img.heliar.top/file/1770068438490_Ê∑ªÂä†‰∫∫Áæ§_people-plus.png';
        meSettingsCoverPreview.src = p.cover || '';

        // Â°´ÂÖÖ8‰∏™‰ºöÂëòÂõæÊ†áËæìÂÖ•Ê°Ü
        for (let i = 0; i < 8; i++) {
            const input = document.getElementById(`me-input-m${i+1}`);
            const preview = document.getElementById(`me-preview-m${i+1}`);
            const url = p.memberUrls[i] || '';
            input.value = url;
            preview.src = url || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
            
            input.oninput = () => { handleImgSrcInput(input, preview); };
        }
        meSettingsModal.classList.add('active');
    };

    window.closeMeSettings = () => { meSettingsModal.classList.remove('active'); };

    window.saveMeSettings = () => {
        const p = getUserProfile();
        p.avatar = meSettingsAvatarUrl.value.trim();
        p.cover = meSettingsCoverUrl.value.trim();
        
        for (let i = 0; i < 8; i++) {
            const val = document.getElementById(`me-input-m${i+1}`).value.trim();
            p.memberUrls[i] = val;
        }

        saveUserProfile(p);
        loadUserProfile(); 
        showToast('‰∏™‰∫∫‰∏ªÈ°µËÆæÁΩÆÂ∑≤‰øùÂ≠ò');
        closeMeSettings();
    };

    // --- API & Chat ---
    const testApiBtn = document.getElementById('test-api-btn');
    const fetchModelsBtn = document.getElementById('fetch-models-btn');
    const modelSelect = document.getElementById('model-select');
    const apiStatus = document.getElementById('api-status');

    testApiBtn.onclick = async () => {
        const url = apiUrlInput.value.trim(); const key = apiKeyInput.value.trim();
        if (!url || !key) { showToast('ËØ∑Â°´ÂÜô API Âú∞ÂùÄÂíå Key'); return; }
        testApiBtn.disabled = true; apiStatus.innerText = "ÊµãËØï‰∏≠...";
        try {
            const res = await fetch(`${url.endsWith('/v1') ? url : url+'/v1'}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
            if (res.ok) { apiStatus.innerText = "Â∑≤ËøûÊé•"; apiStatus.className = "api-status connected"; showToast("ËøûÊé•ÊàêÂäüÔºÅ"); }
            else throw new Error();
        } catch(e) { apiStatus.innerText = "ËøûÊé•Â§±Ë¥•"; apiStatus.className = "api-status disconnected"; showToast("ËøûÊé•Â§±Ë¥•"); }
        finally { testApiBtn.disabled = false; }
    };

    fetchModelsBtn.onclick = async () => {
        const url = apiUrlInput.value.trim(); const key = apiKeyInput.value.trim();
        if (!url || !key) return;
        fetchModelsBtn.disabled = true;
        try {
            const res = await fetch(`${url.endsWith('/v1') ? url : url+'/v1'}/models`, { headers: { 'Authorization': `Bearer ${key}` } });
            const data = await res.json();
            modelSelect.innerHTML = data.data.map(m => `<option value="${m.id}">${m.id}</option>`).join('');
            document.getElementById('model-select-wrapper').style.display = 'block';
        } catch(e) { showToast("Ëé∑ÂèñÊ®°ÂûãÂ§±Ë¥•"); }
        finally { fetchModelsBtn.disabled = false; }
    };

    window.openAIChat = () => {
        const s = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!s || !s.api || !s.api.model) { showToast('ËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ API'); return; }
        document.getElementById('current-model-name').innerText = s.api.model;
        document.getElementById('ai-chat-modal').classList.add('active');
    };
    window.closeAIChat = () => document.getElementById('ai-chat-modal').classList.remove('active');

    // --- Settings Storage ---
    function saveAllSettings() {
        const icons = {};
        document.querySelectorAll('.app-icon-input input').forEach(i => {
            const id = i.id.replace('url-', ''); if (i.value.trim()) icons[id] = i.value.trim();
        });
        const settings = {
            api: { url: apiUrlInput.value, key: apiKeyInput.value, model: modelSelect.value, temp: tempSlider.value, tokens: maxTokensInput.value },
            visual: {
                wallpaper: wallpaperUrlInput.value,
                widget: document.getElementById('widget-square-url').value,
                customImg: document.getElementById('custom-image-url').value,
                icons: icons,
                timeBg: timeContainer.style.backgroundImage,
                customDate: customDateText
            }
        };
        localStorage.setItem(ALL_SETTINGS_KEY, JSON.stringify(settings));
        if (event && event.type === 'click') showToast('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò ‚©å‚©ä‚©å');
        applyVisual(settings.visual);
    }

    function applyVisual(v) {
        if (v.wallpaper) body.style.backgroundImage = `url(${v.wallpaper})`;
        if (v.timeBg) timeContainer.style.backgroundImage = v.timeBg;
        customDateText = v.customDate || "";
        updateClock();
        const wq = document.getElementById('widget-square');
        if (v.widget) wq.style.backgroundImage = `url(${v.widget})`;
        const ci = document.getElementById('custom-image-display');
        const ch = document.getElementById('custom-image-hint');
        if (v.customImg) { ci.src = v.customImg; ci.style.display = 'block'; ch.style.display = 'none'; }
        if (v.icons) Object.keys(v.icons).forEach(id => applyIconToUI(id, v.icons[id]));
    }

    function loadSettings() {
        const s = JSON.parse(localStorage.getItem(ALL_SETTINGS_KEY));
        if (!s) return;
        apiUrlInput.value = s.api.url || '';
        apiKeyInput.value = s.api.key || '';
        tempSlider.value = s.api.temp || 0.8;
        maxTokensInput.value = s.api.tokens || 1000;
        if (s.api.model) {
            modelSelect.innerHTML = `<option value="${s.api.model}">${s.api.model}</option>`;
            document.getElementById('model-select-wrapper').style.display = 'block';
        }
        wallpaperUrlInput.value = s.visual.wallpaper || '';
        document.getElementById('widget-square-url').value = s.visual.widget || '';
        document.getElementById('custom-image-url').value = s.visual.customImg || '';
        applyVisual(s.visual);
    }

    document.addEventListener('DOMContentLoaded', () => {
        setInterval(updateClock, 1000);
        loadSettings();
        tempSlider.oninput = () => tempValueDisplay.innerText = tempSlider.value;
        saveSettingsBtn.onclick = saveAllSettings;
        
        if (!localStorage.getItem(CHAT_DATA_KEY)) { localStorage.setItem(CHAT_DATA_KEY, JSON.stringify([])); }
        if (!localStorage.getItem(USER_PROFILE_KEY)) { saveUserProfile(getUserProfile()); }
        
        meSettingsAvatarUrl.addEventListener('input', () => {
            meSettingsAvatarPreview.src = meSettingsAvatarUrl.value.trim() || 'https://img.heliar.top/file/1770068438490_Ê∑ªÂä†‰∫∫Áæ§_people-plus.png';
        });
        meSettingsCoverUrl.addEventListener('input', () => { meSettingsCoverPreview.src = meSettingsCoverUrl.value.trim(); });

        renderChatList(); 
    });
</script>

</body>
</html>